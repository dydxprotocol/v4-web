services:
  fuel-core:
    build:
      context: ./fuel-core
      dockerfile: Dockerfile
    image: starboard/fuel-core
    container_name: 'starboard_fuel_core'
    restart: unless-stopped
    env_file:
      - .env.docker
    environment:
      MIN_GAS_PRICE: ${MIN_GAS_PRICE:-1}
      # This is the private key of the consensus.PoA.signing_key in the chainConfig.json
      # this key is responsible for validating the transactions
      CONSENSUS_KEY_SECRET: ${WALLET_SECRET:-0xa449b1ffee0e2205fa924c6740cc48b3b473aa28587df6dab12abc245d1f5298}
    ports:
      - '${FUEL_CORE_PORT:-4000}:4000'
    volumes:
      - fuel-core-db:/mnt/db
    healthcheck:
      test: ['CMD-SHELL', 'curl --fail http://localhost:4000/v1/health || exit 1']
      interval: 10s
      start_period: 3s
      timeout: 10s
      retries: 10

  db:
    image: postgres:15
    container_name: 'starboard_indexer_db'
    restart: unless-stopped
    env_file:
      - .env.docker
    environment:
      POSTGRES_DB: ${DB_NAME:-postgres}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASS:-postgres}
    ports:
      - '${DB_PORT:-23751}:5432'
      # command: ["postgres", "-c", "log_statement=all"]
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}']
      interval: 10s
      start_period: 3s
      timeout: 10s
      retries: 10

  indexer:
    build:
      context: ..
      dockerfile: docker/starboard/Dockerfile
    image: starboard
    container_name: 'starboard_indexer_processor'
    restart: unless-stopped
    env_file:
      - .env.docker
    environment:
      FUEL_CORE_PORT: ${FUEL_CORE_PORT:-4000}
      DB_NAME: ${DB_NAME:-postgres}
      DB_PORT: 5432
      DB_USER: ${DB_USER:-postgres}
      DB_PASS: ${DB_PASS:-postgres}
      DB_HOST: starboard_indexer_db
      GATEWAY_URL: ${GATEWAY_URL:-}
      GRAPHQL_URL: http://starboard_fuel_core:4000/v1/graphql
      SALT: ${SALT:-0x8000000000000000000000000000000000000000000000000000000000000000}
      VAULT_PRICEFEED_ADDRESS: ${VAULT_PRICEFEED_ADDRESS:-0x422729Dc06fD5811ec48eDf38915a52aa6383B3a2e91a7f45F1eECaAba2aEf81}
      VAULT_ADDRESS: ${VAULT_ADDRESS:-0x01bbCEFbC64350a092310d59E29cFF269DB01539866aBb263f6dB78C275a84F2}
      FROM_BLOCK: ${FROM_BLOCK:-0}
      NVM_DIR: /root/.nvm
    command:
      [
        'bash',
        '-c',
        'source /root/.nvm/nvm.sh && cd /starboard/indexer && pnpm exec squid-typeorm-migration apply && node lib/main.js',
      ]
    depends_on:
      fuel-core:
        condition: service_healthy
      db:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', "pgrep -f 'node.*main.js' || exit 1"]
      interval: 30s
      start_period: 60s
      timeout: 10s
      retries: 3

  api:
    build:
      context: ..
      dockerfile: docker/starboard/Dockerfile
    image: starboard
    container_name: 'starboard_indexer_api'
    restart: unless-stopped
    env_file:
      - .env.docker
    environment:
      DB_NAME: ${DB_NAME:-postgres}
      DB_PORT: 5432
      DB_USER: ${DB_USER:-postgres}
      DB_PASS: ${DB_PASS:-postgres}
      DB_HOST: starboard_indexer_db
      NVM_DIR: /root/.nvm
      GRAPHQL_SERVER_PORT: 4350
    ports:
      - '${GQL_PORT:-4350}:4350'
    command: ['bash', '-c', 'source /root/.nvm/nvm.sh && cd /starboard/indexer && node lib/api.js']
    depends_on:
      db:
        condition: service_healthy
      indexer:
        condition: service_started
    healthcheck:
      test: ['CMD-SHELL', "pgrep -f 'node.*api.js' || exit 1"]
      interval: 30s
      start_period: 30s
      timeout: 10s
      retries: 3

volumes:
  fuel-core-db:
    name: 'starboard_fuel-core-db'
