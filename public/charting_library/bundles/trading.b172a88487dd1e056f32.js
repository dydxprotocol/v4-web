(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[5142],{101414:e=>{e.exports={button:"button-D4RPB3ZC",content:"content-D4RPB3ZC","icon-only":"icon-only-D4RPB3ZC",link:"link-D4RPB3ZC","color-brand":"color-brand-D4RPB3ZC","variant-primary":"variant-primary-D4RPB3ZC","variant-secondary":"variant-secondary-D4RPB3ZC","color-gray":"color-gray-D4RPB3ZC","color-green":"color-green-D4RPB3ZC","color-red":"color-red-D4RPB3ZC","color-black":"color-black-D4RPB3ZC","size-xsmall":"size-xsmall-D4RPB3ZC","start-icon-wrap":"start-icon-wrap-D4RPB3ZC","end-icon-wrap":"end-icon-wrap-D4RPB3ZC","with-start-icon":"with-start-icon-D4RPB3ZC","with-end-icon":"with-end-icon-D4RPB3ZC","size-small":"size-small-D4RPB3ZC","size-medium":"size-medium-D4RPB3ZC","size-large":"size-large-D4RPB3ZC","size-xlarge":"size-xlarge-D4RPB3ZC",animated:"animated-D4RPB3ZC",stretch:"stretch-D4RPB3ZC",grouped:"grouped-D4RPB3ZC","adjust-position":"adjust-position-D4RPB3ZC","first-row":"first-row-D4RPB3ZC","first-col":"first-col-D4RPB3ZC","no-corner-top-left":"no-corner-top-left-D4RPB3ZC","no-corner-top-right":"no-corner-top-right-D4RPB3ZC","no-corner-bottom-right":"no-corner-bottom-right-D4RPB3ZC","no-corner-bottom-left":"no-corner-bottom-left-D4RPB3ZC","text-wrap":"text-wrap-D4RPB3ZC","multiline-content":"multiline-content-D4RPB3ZC","secondary-text":"secondary-text-D4RPB3ZC","primary-text":"primary-text-D4RPB3ZC"}},470048:e=>{e.exports={wrapper:"wrapper-GZajBGIm",input:"input-GZajBGIm",box:"box-GZajBGIm",icon:"icon-GZajBGIm",noOutline:"noOutline-GZajBGIm","intent-danger":"intent-danger-GZajBGIm",check:"check-GZajBGIm",dot:"dot-GZajBGIm"}},869789:e=>{e.exports={checkbox:"checkbox-vyj6oJxw",reverse:"reverse-vyj6oJxw",label:"label-vyj6oJxw",baseline:"baseline-vyj6oJxw"}},744633:e=>{e.exports={separator:"separator-gVkHdN_4"}},2537:e=>{e.exports={icon:"icon-VykdSzLO",button:"button-VykdSzLO",wrapper:"wrapper-VykdSzLO",infoContainer:"infoContainer-VykdSzLO",title:"title-VykdSzLO",link:"link-VykdSzLO",text:"text-VykdSzLO"}},867838:e=>{e.exports={delayedDataTitleColor:"#F57C00",batsQuotesTitleColor:"#D81B60",header:"header-W5uTS8cc",wrapper:"wrapper-W5uTS8cc",statusLine:"statusLine-W5uTS8cc",informer:"informer-W5uTS8cc",text:"text-W5uTS8cc",button:"button-W5uTS8cc",settingsButton:"settingsButton-W5uTS8cc button-W5uTS8cc",settingsPopupMenu:"settingsPopupMenu-W5uTS8cc",delayedDataIcon:"delayedDataIcon-W5uTS8cc",batsQuotesIcon:"batsQuotesIcon-W5uTS8cc"}},483830:e=>{e.exports={"trading-panel-content":"trading-panel-content-LlInYWMC","trading-panel-spinner":"trading-panel-spinner-LlInYWMC","trading-panel-header":"trading-panel-header-LlInYWMC","trading-panel-tabs":"trading-panel-tabs-LlInYWMC","trading-panel-handle":"trading-panel-handle-LlInYWMC"}},488803:e=>{e.exports={"tablet-normal-breakpoint":"screen and (max-width: 768px)","small-height-breakpoint":"screen and (max-height: 360px)","tablet-small-breakpoint":"screen and (max-width: 430px)"}},755596:e=>{e.exports={dialog:"dialog-b8SxMnzX",wrapper:"wrapper-b8SxMnzX",separator:"separator-b8SxMnzX",
bounded:"bounded-b8SxMnzX"}},869827:e=>{e.exports={"small-height-breakpoint":"screen and (max-height: 360px)",container:"container-BZKENkhT",unsetAlign:"unsetAlign-BZKENkhT",title:"title-BZKENkhT",subtitle:"subtitle-BZKENkhT",textWrap:"textWrap-BZKENkhT",ellipsis:"ellipsis-BZKENkhT",close:"close-BZKENkhT",icon:"icon-BZKENkhT"}},345719:e=>{e.exports={separator:"separator-Pf4rIzEt"}},354583:e=>{e.exports={checkbox:"checkbox-aOSYFxuH"}},309210:e=>{e.exports={icon:"icon-vDz9Zwc6",toolboxLabel:"toolboxLabel-vDz9Zwc6"}},171529:(e,t,i)=>{"use strict";i.d(t,{SquareButton:()=>m});var r=i(50959),s=i(497754),o=i(331774),n=i(72571),a=i(101414),l=i.n(a);function c(e){const{color:t="brand",size:i="medium",variant:r="primary",stretch:n=!1,icon:a,startIcon:c,endIcon:d,iconOnly:u=!1,className:h,isGrouped:p,cellState:m,disablePositionAdjustment:_=!1,primaryText:g,secondaryText:b,isAnchor:v=!1}=e,y=function(e){let t="";return 0!==e&&(1&e&&(t=s(t,l()["no-corner-top-left"])),2&e&&(t=s(t,l()["no-corner-top-right"])),4&e&&(t=s(t,l()["no-corner-bottom-right"])),8&e&&(t=s(t,l()["no-corner-bottom-left"]))),t}((0,o.getGroupCellRemoveRoundBorders)(m));return s(h,l().button,l()[`size-${i}`],l()[`color-${t}`],l()[`variant-${r}`],n&&l().stretch,(a||c)&&l()["with-start-icon"],d&&l()["with-end-icon"],u&&l()["icon-only"],y,p&&l().grouped,p&&!_&&l()["adjust-position"],p&&m.isTop&&l()["first-row"],p&&m.isLeft&&l()["first-col"],g&&b&&l()["multiline-content"],v&&l().link)}function d(e){const{startIcon:t,icon:i,iconOnly:s,children:o,endIcon:a,primaryText:c,secondaryText:d}=e,u=null!=t?t:i,h=!(t||i||a||s)&&!o&&c&&d;return r.createElement(r.Fragment,null,u&&r.createElement(n.Icon,{icon:u,className:l()["start-icon-wrap"]}),o&&r.createElement("span",{className:l().content},o),a&&!s&&r.createElement(n.Icon,{icon:a,className:l()["end-icon-wrap"]}),h&&function(e){return e.primaryText&&e.secondaryText&&r.createElement("div",{className:l()["text-wrap"]},r.createElement("span",{className:l()["primary-text"]}," ",e.primaryText," "),"string"==typeof e.secondaryText?r.createElement("span",{className:l()["secondary-text"]}," ",e.secondaryText," "):r.createElement("span",{className:l()["secondary-text"]},r.createElement("span",null,e.secondaryText.firstLine),r.createElement("span",null,e.secondaryText.secondLine)))}(e))}var u=i(380327),h=i(800417);function p(e){const{className:t,color:i,variant:r,size:s,stretch:o,animated:n,icon:a,iconOnly:l,startIcon:c,endIcon:d,primaryText:u,secondaryText:p,...m}=e;return{...m,...(0,h.filterDataProps)(e),...(0,h.filterAriaProps)(e)}}function m(e){const{reference:t,...i}=e,{isGrouped:s,cellState:o,disablePositionAdjustment:n}=(0,r.useContext)(u.ControlGroupContext),a=c({...i,isGrouped:s,cellState:o,disablePositionAdjustment:n});return r.createElement("button",{...p(i),className:a,ref:t},r.createElement(d,{...i}))}},408323:(e,t,i)=>{"use strict";i.d(t,{CheckboxInput:()=>d});var r=i(50959),s=i(497754),o=i(800417),n=i(72571),a=i(465890),l=i(470048),c=i.n(l);function d(e){const t=s(c().box,c()[`intent-${e.intent}`],{
[c().check]:!Boolean(e.indeterminate),[c().dot]:Boolean(e.indeterminate),[c().noOutline]:-1===e.tabIndex}),i=s(c().wrapper,e.className);return r.createElement("span",{className:i,title:e.title,style:e.style},r.createElement("input",{id:e.id,tabIndex:e.tabIndex,className:c().input,type:"checkbox",name:e.name,checked:e.checked,disabled:e.disabled,value:e.value,autoFocus:e.autoFocus,role:e.role,onChange:function(){e.onChange&&e.onChange(e.value)},ref:e.reference,"aria-required":e["aria-required"],"aria-describedby":e["aria-describedby"],"aria-invalid":e["aria-invalid"],...(0,o.filterDataProps)(e)}),r.createElement("span",{className:t},r.createElement(n.Icon,{icon:a,className:c().icon})))}},302946:(e,t,i)=>{"use strict";i.d(t,{Checkbox:()=>c});var r=i(50959),s=i(497754),o=i(230789),n=i(408323),a=i(869789),l=i.n(a);class c extends r.PureComponent{render(){const{inputClassName:e,labelClassName:t,...i}=this.props,o=s(this.props.className,l().checkbox,{[l().reverse]:Boolean(this.props.labelPositionReverse),[l().baseline]:Boolean(this.props.labelAlignBaseline)}),a=s(l().label,t,{[l().disabled]:this.props.disabled});let c=null;return this.props.label&&(c=r.createElement("span",{className:a,title:this.props.title},this.props.label)),r.createElement("label",{className:o},r.createElement(n.CheckboxInput,{...i,className:e}),c)}}c.defaultProps={value:"on"};(0,o.makeSwitchGroupItem)(c)},380327:(e,t,i)=>{"use strict";i.d(t,{ControlGroupContext:()=>r});const r=i(50959).createContext({isGrouped:!1,cellState:{isTop:!0,isRight:!0,isBottom:!0,isLeft:!0}})},331774:(e,t,i)=>{"use strict";function r(e){let t=0;return e.isTop&&e.isLeft||(t+=1),e.isTop&&e.isRight||(t+=2),e.isBottom&&e.isLeft||(t+=8),e.isBottom&&e.isRight||(t+=4),t}i.d(t,{getGroupCellRemoveRoundBorders:()=>r})},72571:(e,t,i)=>{"use strict";i.d(t,{Icon:()=>s});var r=i(50959);const s=r.forwardRef(((e,t)=>{const{icon:i="",...s}=e;return r.createElement("span",{...s,ref:t,dangerouslySetInnerHTML:{__html:i}})}))},230789:(e,t,i)=>{"use strict";i.d(t,{SwitchGroup:()=>n,makeSwitchGroupItem:()=>a});var r=i(50959),s=i(174786);const o=(0,r.createContext)({getName:()=>"",getValues:()=>[],getOnChange:()=>s.default,subscribe:s.default,unsubscribe:s.default});class n extends r.PureComponent{constructor(e){super(e),this._subscriptions=new Set,this._getName=()=>this.props.name,this._getValues=()=>this.props.values,this._getOnChange=()=>this.props.onChange,this._subscribe=e=>{this._subscriptions.add(e)},this._unsubscribe=e=>{this._subscriptions.delete(e)},this.state={switchGroupContext:{getName:this._getName,getValues:this._getValues,getOnChange:this._getOnChange,subscribe:this._subscribe,unsubscribe:this._unsubscribe}}}render(){return r.createElement(o.Provider,{value:this.state.switchGroupContext},this.props.children)}componentDidUpdate(e){this._notify(this._getUpdates(this.props.values,e.values))}_notify(e){this._subscriptions.forEach((t=>t(e)))}_getUpdates(e,t){return[...t,...e].filter((i=>t.includes(i)?!e.includes(i):e.includes(i)))}}function a(e){var t
;return t=class extends r.PureComponent{constructor(){super(...arguments),this._onChange=e=>{this.context.getOnChange()(e)},this._onUpdate=e=>{e.includes(this.props.value)&&this.forceUpdate()}}componentDidMount(){this.context.subscribe(this._onUpdate)}render(){return r.createElement(e,{...this.props,name:this._getName(),onChange:this._onChange,checked:this._isChecked()})}componentWillUnmount(){this.context.unsubscribe(this._onUpdate)}_getName(){return this.context.getName()}_isChecked(){return this.context.getValues().includes(this.props.value)}},t.contextType=o,t}},111706:(e,t,i)=>{"use strict";function r(e){return 0===e.detail}i.d(t,{isKeyboardClick:()=>r})},273388:(e,t,i)=>{"use strict";function r(e){return t=>{e.forEach((e=>{"function"==typeof e?e(t):null!=e&&(e.current=t)}))}}function s(e){return r([e])}i.d(t,{isomorphicRef:()=>s,mergeRefs:()=>r})},363111:(e,t,i)=>{"use strict";i.d(t,{BracketDefaultPips:()=>n,BracketSubControlType:()=>a,CalculatorDecKeyCodes:()=>d,CalculatorIncKeyCodes:()=>u,Context:()=>m,OrderEditorDisplayMode:()=>o,OrderPanelStatus:()=>r,OrderPlacingStatus:()=>s,PriceSubControlType:()=>c,QuantitySubControlType:()=>l,orderTypes:()=>_});var r,s,o,n,a,l,c,d,u,h=i(50959),p=i(509806);!function(e){e[e.Wait=0]="Wait",e[e.Active=1]="Active",e[e.Editing=2]="Editing",e[e.Preview=3]="Preview"}(r||(r={})),function(e){e[e.Creating=0]="Creating",e[e.Placed=1]="Placed"}(s||(s={})),function(e){e.Popup="popup",e.Panel="panel"}(o||(o={})),function(e){e[e.TakeProfit=75]="TakeProfit",e[e.StopLoss=25]="StopLoss"}(n||(n={})),function(e){e.Price="Price",e.Pips="Pips",e.Money="Money",e.Percent="Percent"}(a||(a={})),function(e){e.Units="Units",e.RiskInCurrency="RiskInCurrency",e.RiskInPercent="RiskInPercent",e.BaseCurrency="BaseCurrency",e.QuoteCurrency="QuoteCurrency"}(l||(l={})),function(e){e.Absolute="Absolute",e.Relative="Relative"}(c||(c={})),function(e){e[e.Minus=189]="Minus",e[e.NumMinus=109]="NumMinus",e[e.FirefoxMinus=173]="FirefoxMinus"}(d||(d={})),function(e){e[e.Plus=187]="Plus",e[e.NumPlus=107]="NumPlus",e[e.FirefoxPlus=61]="FirefoxPlus"}(u||(u={}));const m=h.createContext({resizerWidth:null,mode:o.Panel,supportTrailingStop:!1}),_={1:p.t(null,void 0,i(398157)),2:p.t(null,void 0,i(359758)),3:p.t(null,void 0,i(905023)),4:p.t(null,void 0,i(802654))}},600297:(e,t,i)=>{"use strict";i.d(t,{Button:()=>n,ButtonType:()=>r});var r,s=i(50959),o=i(171529);function n(e){const{value:t,buttonType:i,className:n,icon:a,onClick:l}=e;let c;switch(i){case r.PlusValue:case r.IncDec:c=t;break;case r.Clear:c="clear";break;case r.Default:c="default"}return s.createElement(o.SquareButton,{className:n,"data-value":c,"data-name":`qtyButtonCalculator-${c}`,onClick:()=>{l(t,i)},size:"xsmall",variant:"secondary",color:"gray",onMouseDown:e=>e.preventDefault()},a||t)}!function(e){e[e.PlusValue=0]="PlusValue",e[e.IncDec=1]="IncDec",e[e.Clear=2]="Clear",e[e.Default=3]="Default"}(r||(r={}))},958057:(e,t,i)=>{"use strict";i.d(t,{batsToRealtimeHtml1:()=>y,batsToRealtimeHtml2WithExchange:()=>k,batsToRealtimeHtml2WithoutExchange:()=>f,
delayHtml:()=>d,delayNoRealtimeHtml:()=>p,delayToRealtimeHtml:()=>h,delayTooltip:()=>o,delayWithoutMarketAgreement:()=>v,eodHtml:()=>m,eodTooltip:()=>n,exchangeByOriginalExchangeTooltip:()=>c,notAccurate1PerSecondTooltip:()=>a,notAccurateCboeTooltip:()=>l,tFEXorMOEXorLSEorChixauHtml:()=>u,tickByTickHtml1:()=>g,tickByTickHtml1FullInfo:()=>_,tickByTickHtml2:()=>b});var r=i(509806),s=i(311757);const o=r.t(null,void 0,i(257310)),n=r.t(null,void 0,i(659315)),a=r.t(null,void 0,i(215815)),l=r.t(null,void 0,i(345e3)),c=r.t(null,void 0,i(107435)),d=(r.t(null,void 0,i(624680)),r.t(null,void 0,i(999214)),r.t(null,void 0,i(6044)),r.t(null,void 0,i(831461)),r.t(null,void 0,i(332960)),r.t(null,void 0,i(152449)),(0,s.htmlEscape)(r.t(null,void 0,i(11155)))),u=(0,s.htmlEscape)(r.t(null,void 0,i(301084))),h=(0,s.htmlEscape)(r.t(null,void 0,i(652984))),p=(0,s.htmlEscape)(r.t(null,void 0,i(689022))),m=(0,s.htmlEscape)(r.t(null,void 0,i(52916))),_=(0,s.htmlEscape)(r.t(null,void 0,i(449321))),g=(0,s.htmlEscape)(r.t(null,void 0,i(425978))),b=(0,s.htmlEscape)(r.t(null,void 0,i(28412))),v=(0,s.htmlEscape)(r.t(null,void 0,i(791459))),y=r.t(null,void 0,i(806667)),f=(r.t(null,{context:'Part of: "Real-time data for {symbolName} is provided by {exchange} exchange."'},i(712978)),r.t(null,{context:'Part of: "Real-time data for {symbolName} is provided by {exchange} exchange."'},i(864565)),r.t(null,void 0,i(102310))),k=r.t(null,void 0,i(729512));r.t(null,void 0,i(353205)),r.t(null,void 0,i(115993))},190787:(e,t,i)=>{"use strict";function r(e,t){null===e.firstChild?e.textContent=t:e.firstChild.nodeValue=t}i.d(t,{updateTextNode:()=>r})},996038:(e,t,i)=>{"use strict";i.d(t,{DialogBreakpoints:()=>s});var r=i(488803);const s={SmallHeight:r["small-height-breakpoint"],TabletSmall:r["tablet-small-breakpoint"],TabletNormal:r["tablet-normal-breakpoint"]}},533408:(e,t,i)=>{"use strict";i.d(t,{AdaptivePopupDialog:()=>E});var r=i(50959),s=i(650151),o=i(660538),n=i(497754),a=i.n(n),l=i(180185),c=i(710263),d=i(698043),u=i(40766),h=i(494707),p=i(996038),m=i(930052),_=i(910549);var g=i(206594),b=i(559410),v=i(72571),y=i(190410),f=i(507720),k=i(869827);function P(e){const{title:t,titleTextWrap:i=!1,subtitle:s,showCloseIcon:o=!0,onClose:n,onCloseButtonKeyDown:l,renderBefore:c,renderAfter:d,draggable:u,className:h,unsetAlign:p,closeAriaLabel:m,closeButtonReference:_}=e,[g,b]=(0,r.useState)(!1);return r.createElement(y.DialogHeaderContext.Provider,{value:{setHideClose:b}},r.createElement("div",{className:a()(k.container,h,(s||p)&&k.unsetAlign)},c,r.createElement("div",{"data-dragg-area":u,className:k.title},r.createElement("div",{className:a()(i?k.textWrap:k.ellipsis)},t),s&&r.createElement("div",{className:a()(k.ellipsis,k.subtitle)},s)),d,o&&!g&&r.createElement("button",{className:k.close,onClick:n,onKeyDown:l,"data-name":"close","aria-label":m,type:"button",ref:_},r.createElement(v.Icon,{className:k.icon,icon:f,"data-name":"close","data-role":"button"}))))}var S=i(273388),C=i(800417),w=i(755596);const B={vertical:20},T={vertical:0};class E extends r.PureComponent{
constructor(){super(...arguments),this._controller=null,this._reference=null,this._orientationMediaQuery=null,this._renderChildren=(e,t)=>(this._controller=e,this.props.render({requestResize:this._requestResize,centerAndFit:this._centerAndFit,isSmallWidth:t})),this._handleReference=e=>this._reference=e,this._handleCloseBtnClick=()=>{this.props.onKeyboardClose&&this.props.onKeyboardClose(),this._handleClose()},this._handleClose=()=>{this.props.onClose()},this._handleOpen=()=>{void 0!==this.props.onOpen&&this.props.isOpened&&this.props.onOpen(this.props.fullScreen||window.matchMedia(p.DialogBreakpoints.TabletSmall).matches)},this._handleKeyDown=e=>{if(!e.defaultPrevented){if(this.props.onKeyDown&&this.props.onKeyDown(e),27===(0,l.hashFromEvent)(e)){if(e.defaultPrevented)return;if(this.props.forceCloseOnEsc&&this.props.forceCloseOnEsc())return this.props.onKeyboardClose&&this.props.onKeyboardClose(),void this._handleClose();const{activeElement:i}=document,r=(0,s.ensureNotNull)(this._reference);if(null!==i){if(e.preventDefault(),"true"===(t=i).getAttribute("data-haspopup")&&"true"!==t.getAttribute("data-expanded"))return void this._handleClose();if((0,d.isTextEditingField)(i))return void r.focus();if(r.contains(i))return this.props.onKeyboardClose&&this.props.onKeyboardClose(),void this._handleClose()}}var t,i;(function(e){if("function"==typeof e)return e();return Boolean(e)})(this.props.disableTabNavigationContainment)||(i=e,[9,l.Modifiers.Shift+9].includes((0,l.hashFromEvent)(i))&&i.stopPropagation())}},this._requestResize=()=>{null!==this._controller&&this._controller.recalculateBounds()},this._centerAndFit=()=>{null!==this._controller&&this._controller.centerAndFit()},this._calculatePositionWithOffsets=(e,t)=>{const i=(0,s.ensureDefined)(this.props.fullScreenViewOffsets).value();return{top:i.top,left:(0,c.isRtl)()?-i.right:i.left,width:t.clientWidth-i.left-i.right,height:t.clientHeight-i.top-i.bottom}}}componentDidMount(){this.props.ignoreClosePopupsAndDialog||b.subscribe(g.CLOSE_POPUPS_AND_DIALOGS_COMMAND,this._handleClose,null),this._handleOpen(),void 0!==this.props.onOpen&&(this._orientationMediaQuery=window.matchMedia("(orientation: portrait)"),(0,o.mediaQueryAddEventListener)(this._orientationMediaQuery,this._handleOpen)),this.props.fullScreenViewOffsets&&this.props.fullScreen&&this.props.fullScreenViewOffsets.subscribe(this._requestResize)}componentWillUnmount(){this.props.ignoreClosePopupsAndDialog||b.unsubscribe(g.CLOSE_POPUPS_AND_DIALOGS_COMMAND,this._handleClose,null),null!==this._orientationMediaQuery&&(0,o.mediaQueryRemoveEventListener)(this._orientationMediaQuery,this._handleOpen),this.props.fullScreenViewOffsets&&this.props.fullScreen&&this.props.fullScreenViewOffsets.unsubscribe(this._requestResize)}focus(){(0,s.ensureNotNull)(this._reference).focus()}getElement(){return this._reference}contains(e){var t,i;return null!==(i=null===(t=this._reference)||void 0===t?void 0:t.contains(e))&&void 0!==i&&i}render(){
const{className:e,wrapperClassName:t,headerClassName:i,isOpened:s,title:o,titleTextWrap:n,dataName:l,onClickOutside:c,additionalElementPos:d,additionalHeaderElement:g,backdrop:b,shouldForceFocus:v=!0,shouldReturnFocus:y,onForceFocus:f,showSeparator:k,subtitle:E,draggable:O=!0,fullScreen:D=!1,showCloseIcon:I=!0,rounded:L=!0,isAnimationEnabled:x,growPoint:N,dialogTooltip:M,unsetHeaderAlign:A,onDragStart:V,dataDialogName:R,closeAriaLabel:F,containerAriaLabel:W,reference:q,containerTabIndex:U,closeButtonReference:$,onCloseButtonKeyDown:Q,shadowed:z,fullScreenViewOffsets:H}=this.props,j="after"!==d?g:void 0,G="after"===d?g:void 0,Z="string"==typeof o?o:R||"",K=(0,C.filterDataProps)(this.props),J=(0,S.mergeRefs)([this._handleReference,q]);return r.createElement(m.MatchMedia,{rule:p.DialogBreakpoints.SmallHeight},(d=>r.createElement(m.MatchMedia,{rule:p.DialogBreakpoints.TabletSmall},(p=>r.createElement(u.PopupDialog,{rounded:!(p||D)&&L,className:a()(w.dialog,D&&H&&w.bounded,e),isOpened:s,reference:J,onKeyDown:this._handleKeyDown,onClickOutside:c,onClickBackdrop:c,fullscreen:p||D,guard:d?T:B,boundByScreen:p||D,shouldForceFocus:v,onForceFocus:f,shouldReturnFocus:y,backdrop:b,draggable:O,isAnimationEnabled:x,growPoint:N,name:this.props.dataName,dialogTooltip:M,onDragStart:V,containerAriaLabel:W,containerTabIndex:U,calculateDialogPosition:D&&H?this._calculatePositionWithOffsets:void 0,shadowed:z,...K},r.createElement("div",{className:a()(w.wrapper,t),"data-name":l,"data-dialog-name":Z},void 0!==o&&r.createElement(P,{draggable:O&&!(p||D),onClose:this._handleCloseBtnClick,renderAfter:G,renderBefore:j,subtitle:E,title:o,titleTextWrap:n,showCloseIcon:I,className:i,unsetAlign:A,closeAriaLabel:F,closeButtonReference:$,onCloseButtonKeyDown:Q}),k&&r.createElement(h.Separator,{className:w.separator}),r.createElement(_.PopupContext.Consumer,null,(e=>this._renderChildren(e,p||D)))))))))}}},190410:(e,t,i)=>{"use strict";i.d(t,{DialogHeaderContext:()=>r});const r=i(50959).createContext({setHideClose:()=>{}})},921258:(e,t,i)=>{"use strict";i.d(t,{hoverMouseEventFilter:()=>o,useAccurateHover:()=>n,useHover:()=>s});var r=i(50959);function s(){const[e,t]=(0,r.useState)(!1);return[e,{onMouseOver:function(e){o(e)&&t(!0)},onMouseOut:function(e){o(e)&&t(!1)}}]}function o(e){return!e.currentTarget.contains(e.relatedTarget)}function n(e){const[t,i]=(0,r.useState)(!1);return(0,r.useEffect)((()=>{const t=t=>{if(null===e.current)return;const r=e.current.contains(t.target);i(r)};return document.addEventListener("mouseover",t),()=>document.removeEventListener("mouseover",t)}),[]),t}},661851:(e,t,i)=>{"use strict";i.d(t,{useObservable:()=>o,useObservableWithImmediatelyEmittedInitialValue:()=>n});var r=i(50959);function s(e,t){(0,r.useEffect)((()=>{const i=e.subscribe(t);return()=>i.unsubscribe()}),[e,t])}function o(e,t){const[i,o]=(0,r.useState)(t);return s(e,o),i}function n(e,t){const i=(0,r.useCallback)(void 0!==t?()=>t:()=>{let t;return e.subscribe((e=>{t=e})).unsubscribe(),t},[t,e]),[o,n]=(0,r.useState)(i);return s(e,(e=>n((()=>e)))),o}},
494707:(e,t,i)=>{"use strict";i.d(t,{Separator:()=>n});var r=i(50959),s=i(497754),o=i(345719);function n(e){return r.createElement("div",{className:s(o.separator,e.className)})}},379266:(e,t,i)=>{"use strict";i.d(t,{PopupMenuItemToggle:()=>l});var r=i(50959),s=i(497754),o=i(192063),n=i(302946),a=i(354583);function l(e){const{isDisabled:t,hint:i,label:l,isChecked:c,checkboxClassName:d,labelClassName:u,indeterminate:h,...p}=e;return r.createElement(o.PopupMenuItem,{...p,isDisabled:t,shortcut:i,dontClosePopup:!0,labelRowClassName:u,label:r.createElement(n.Checkbox,{disabled:t,label:l,checked:c,indeterminate:h,className:s(a.checkbox,d)})})}},730743:(e,t,i)=>{"use strict";i.d(t,{calcSubMenuPos:()=>s});var r=i(710263);function s(e,t,i={x:0,y:10}){if(t){const{left:i,right:s,top:o}=t.getBoundingClientRect(),n=document.documentElement.clientWidth,a={x:i-e,y:o},l={x:s,y:o};return(0,r.isRtl)()?i<=e?l:a:n-s>=e?l:a}return i}},665276:(e,t,i)=>{"use strict";i.d(t,{Spinner:()=>n});var r=i(50959),s=i(497754),o=i(843442);i(683135);function n(e){const t=s(e.className,"tv-spinner","tv-spinner--shown",`tv-spinner--size_${o.spinnerSizeMap[e.size||o.DEFAULT_SIZE]}`);return r.createElement("div",{className:t,style:e.style,role:"progressbar"})}},106056:(e,t,i)=>{"use strict";var r,s,o;i.d(t,{CloseTrigger:()=>r,ToastAnimationStage:()=>s,ToastPriority:()=>o}),function(e){e.Swipe="swipe",e.Click="click"}(r||(r={})),function(e){e[e.Add=0]="Add",e[e.Remove=1]="Remove",e[e.None=2]="None"}(s||(s={})),function(e){e[e.Low=0]="Low",e[e.Medium=1]="Medium",e[e.High=2]="High"}(o||(o={}))},502869:e=>{e.exports={button:"button-xNqEcuN2"}},673543:e=>{e.exports={loader:"loader-AR4z1Ifp","loader-animation":"loader-animation-AR4z1Ifp",loaderCircle:"loaderCircle-AR4z1Ifp"}},234362:e=>{e.exports={loader:"loader-_7n3rLPY",loaderItem:"loaderItem-_7n3rLPY","loader-animation":"loader-animation-_7n3rLPY",touchMode:"touchMode-_7n3rLPY"}},486141:e=>{e.exports={wrapper:"wrapper-k5swolgQ",text:"text-k5swolgQ"}},707488:e=>{e.exports={blockHidden:"blockHidden-e6PF69Df","pane-button":"pane-button-e6PF69Df"}},275583:e=>{e.exports={toggle:"toggle-NYDT3E70",label:"label-NYDT3E70"}},517327:e=>{e.exports={dropdownButton:"dropdownButton-NgHNzdZC",bigIcon:"bigIcon-NgHNzdZC"}},623549:e=>{e.exports={toggleContentWrapper:"toggleContentWrapper-i9xADy_f",checkBoxWrapper:"checkBoxWrapper-i9xADy_f"}},844012:e=>{e.exports={"css-value-padding":"4px"}},199056:e=>{e.exports={"css-value-padding":"4px",container:"container-hw_3o_pb",informerWrapper:"informerWrapper-hw_3o_pb",notAvailableOnMobile:"notAvailableOnMobile-hw_3o_pb",column:"column-hw_3o_pb",touchMode:"touchMode-hw_3o_pb",buttonsWrapper:"buttonsWrapper-hw_3o_pb",button:"button-hw_3o_pb",sellButton:"sellButton-hw_3o_pb",buyButton:"buyButton-hw_3o_pb",brokerButton:"brokerButton-hw_3o_pb",highButtons:"highButtons-hw_3o_pb",withoutBg:"withoutBg-hw_3o_pb",lastCharSup:"lastCharSup-hw_3o_pb",spreadQtyWrapper:"spreadQtyWrapper-hw_3o_pb",spread:"spread-hw_3o_pb",withoutQty:"withoutQty-hw_3o_pb",qty:"qty-hw_3o_pb",loader:"loader-hw_3o_pb",
circleLoader:"circleLoader-hw_3o_pb",loading:"loading-hw_3o_pb",buttonText:"buttonText-hw_3o_pb",brokerButtonIconWrap:"brokerButtonIconWrap-hw_3o_pb",brokerButtonDefault:"brokerButtonDefault-hw_3o_pb",buttons:"buttons-hw_3o_pb"}},312282:e=>{e.exports={mobile:"screen and (max-width: 567px)"}},640712:e=>{e.exports={popupWrapper:"popupWrapper-sxxSUmLh"}},517516:e=>{e.exports={"small-height-breakpoint":"screen and (max-height: 360px)",moreButton:"moreButton-LjodxXHh",header:"header-LjodxXHh"}},793361:(e,t,i)=>{"use strict";i.d(t,{splitThousands:()=>s});var r=i(150335);function s(e,t="&nbsp;"){let i=e+"";-1!==i.indexOf("e")&&(i=function(e){return(0,r.fixComputationError)(e).toFixed(10).replace(/\.?0+$/,"")}(Number(e)));const s=i.split(".");return s[0].replace(/\B(?=(\d{3})+(?!\d))/g,t)+(s[1]?"."+s[1]:"")}},395907:(e,t,i)=>{"use strict";i.d(t,{ToolWidgetIconButton:()=>a});var r=i(50959),s=i(497754),o=i(747633),n=i(502869);const a=r.forwardRef((function(e,t){const{className:i,id:a,...l}=e;return r.createElement(o.ToolWidgetButton,{"data-name":a,...l,ref:t,className:s(i,n.button)})}))},851237:(e,t,i)=>{"use strict";i.d(t,{LoaderBaseRenderer:()=>s});var r=i(707488);class s{constructor(e,t={}){this._loadingEl=document.createElement("span"),this._renderLoading(t),this.toggleVisibility(!1),e.appendChild(this._loadingEl)}toggleVisibility(e){this._loadingEl.classList.toggle(r.blockHidden,!e)}_renderLoading(e){const{className:t}=e;t&&this._loadingEl.classList.add(t)}}},462892:(e,t,i)=>{"use strict";i.d(t,{LoaderPointsRenderer:()=>o});var r=i(851237),s=i(234362);class o extends r.LoaderBaseRenderer{_renderLoading(e){super._renderLoading(e),this._loadingEl.innerHTML=`\n\t\t\t<span class="${s.loaderItem}"></span>\n\t\t\t<span class="${s.loaderItem}"></span>\n\t\t\t<span class="${s.loaderItem}"></span>\n\t\t`,this._loadingEl.classList.add(s.loader)}}},112235:(e,t,i)=>{"use strict";i.d(t,{OfflineScreen:()=>a,renderOfflineScreen:()=>l});var r=i(50959),s=i(500962),o=i(509806),n=i(486141);function a(){return r.createElement("div",{className:n.wrapper},r.createElement("p",{className:n.text},o.t(null,void 0,i(394021))))}function l(e){s.render(r.createElement(a,null),e)}},521744:(e,t,i)=>{"use strict";i.d(t,{trackingModeIsAvailable:()=>r});const r=i(601227).CheckMobile.any()},783806:(e,t,i)=>{"use strict";i.d(t,{TerminalDropdown:()=>M});var r=i(50959),s=i(509806),o=i(497754),n=i.n(o),a=i(601227),l=i(72571),c=i(518799),d=i(747633),u=i(192063),h=i(350299);const p=r.lazy((async()=>({default:(await Promise.all([i.e(580),i.e(4139),i.e(2108),i.e(5145),i.e(855),i.e(2191),i.e(6639),i.e(7194),i.e(4215),i.e(7653),i.e(766),i.e(2985)]).then(i.bind(i,432177))).ExportDataDialogImpl})));function m(e){return r.createElement(r.Suspense,{fallback:null},r.createElement(p,{...e}))}var _=i(661851),g=i(379266),b=i(624216),v=i(759339),y=i(189904),f=i(972535),k=i(823030),P=i(921258),S=i(730743);var C=i(930052),w=i(309210),B=i(379978);function T(e){return r.createElement(C.MatchMedia,{rule:"screen and (max-width: 430px)"},(t=>t||e.forceUseDrawer?r.createElement(O,{
...e}):r.createElement(D,{...e})))}function E(e){const{toolboxLabel:t}=e;return r.createElement(u.PopupMenuItem,{toolbox:r.createElement(r.Fragment,null,t&&r.createElement("span",{className:w.toolboxLabel},t),r.createElement(l.Icon,{className:w.icon,icon:B})),suppressToolboxClick:!1,dontClosePopup:!0,...e})}function O(e){const{children:t,className:i,drawerClassName:s,menuItemTheme:o,label:n,icon:a,labelClassName:l,toolboxLabel:c}=e,[d,u]=(0,r.useState)(!1);return r.createElement(r.Fragment,null,r.createElement(E,{theme:o,label:n,toolboxLabel:c,icon:a,labelClassName:l,className:i,onClick:function(){u(!d)}}),d&&r.createElement(v.Drawer,{className:s,position:"Bottom",onClose:function(){u(!1)}},t))}function D(e){const{children:t,className:i,menuClassName:s,menuItemTheme:o,label:n,icon:a,labelClassName:l,toolboxLabel:c}=e,d=(0,r.useRef)((0,y.randomHash)()),u=(0,r.useRef)(null),{isMenuOpened:h,onTriggerClick:p,onTriggerMouseOver:m,onMenuClose:_,getPosition:g,onMenuMouseOver:v}=function(e,t,i={}){const s=r.useContext(k.SubmenuContext);r.useEffect((()=>null==s?void 0:s.registerSubmenu(e,a)),[e]);const o=Boolean((null==s?void 0:s.current)===e);return{isMenuOpened:o,onTriggerClick:function(){(f.mobiletouch||i.forceOpenOnClick)&&(null==s||s.setCurrent(o?null:e))},onMenuClose:function(){null==s||s.setCurrent(null)},getPosition:function(e){return(0,S.calcSubMenuPos)(e,t.current)},onMenuMouseOver:n,onTriggerMouseOver:n};function n(t){!f.mobiletouch&&(0,P.hoverMouseEventFilter)(t)&&(null==s||s.setCurrent(e))}function a(e){var i;return Boolean(null===(i=t.current)||void 0===i?void 0:i.contains(e))}}(d.current,u);return r.createElement(r.Fragment,null,r.createElement(E,{theme:o,label:n,toolboxLabel:c,icon:a,labelClassName:l,className:i,onClick:p,onMouseOver:m,reference:u,isHovered:h}),r.createElement(b.PopupMenu,{className:s,position:g,onClose:_,isOpened:h,doNotCloseOn:u.current,onMouseOver:v},t))}var I=i(275583);function L(e){const{labelClassName:t,summaryFieldsVisibilityInfo$:o,summaryFieldToggler:n,initialSummaryFieldsVisibilityInfo:l}=e,c=(0,_.useObservable)(o,l);return 0===c.size?r.createElement(r.Fragment,null):r.createElement(T,{label:s.t(null,void 0,i(522382)),labelClassName:t,forceUseDrawer:a.CheckMobile.any()},[...c.values()].map((e=>r.createElement(g.PopupMenuItemToggle,{key:e.id,className:I.toggle,label:r.createElement("span",{className:I.label},e.id),isChecked:e.visible,onClick:()=>n(e.id)}))))}var x=i(517327),N=i(48008);function M(e){const{dataExportController:t,initialSummaryFieldsVisibilityInfo:o,summaryFieldToggler:p,summaryFieldsVisibilityInfo$:_,iconSize:g}=e,[b,v]=function(e){const{dataExportController:t,trackEvent:i}=e,[s,o]=(0,r.useState)(!1);return void 0===t?[()=>{},null]:[()=>o(!0),r.createElement(m,{isOpened:s,onClose:()=>o(!1),trackEvent:i,dataExportController:t})]}({dataExportController:t});return r.createElement(r.Fragment,null,r.createElement(c.ToolWidgetMenu,{arrow:!1,isDrawer:a.CheckMobile.any(),className:x.dropdownButton,content:r.createElement(d.ToolWidgetButton,{title:s.t(null,void 0,i(141610)),
icon:r.createElement(l.Icon,{className:n()("big"===g&&x.bigIcon),icon:N})}),"data-name":"terminal-dropdown"},r.createElement(L,{labelClassName:x.label,summaryFieldToggler:p,summaryFieldsVisibilityInfo$:_,initialSummaryFieldsVisibilityInfo:o}),null!==v&&r.createElement(u.PopupMenuItem,{labelClassName:x.label,label:(0,h.appendEllipsis)(s.t(null,void 0,i(125769))),onClick:b})),v)}},407999:(e,t,i)=>{"use strict";i.d(t,{makeAccountManagerHeaderDropdownsProps:()=>h});var r=i(650151),s=i(481330),o=i(480802),n=i(752275),a=i(6835),l=i(637401);const c=(0,a.getLogger)("Trading.DataExport");class d{constructor(e,t){this._prefix=t,this._getDataExporters=e}tabs(){return[...this._getDataExporters()].map((([e,t])=>({value:e,content:t.title})))}async exportData(e){const{exporters:t,title:i}=(0,r.ensureDefined)(this._getDataExporters().get(e),"data exporter");try{const e=await Promise.all(t.map((({exportData:e})=>e())));e.forEach(((r,s)=>{const a=t[s].name,l=void 0===a||""===a?`${(0,o.default)(i)}${e.length>1?`-${s+1}`:""}`:(0,o.default)(a);let c="";if(0!==r.length){const e=[u(Object.keys(r[0]))];for(const t of r)e.push(u(Object.values(t)));c=e.join("\n")}(0,n.saveTextFile)(`${(0,o.default)(this._prefix)}-${l}-${(new Date).toISOString()}.csv`,c,"text/csv")}))}catch(e){c.logError((0,l.getLoggerMessage)(e))}}}function u(e){return e.map(n.escapeCSVValue).join(",")}async function h(e,t,i){const o=e.brokersList().filter((e=>!e.configFlags.isSuspended)),n=Promise.resolve(void 0),a=(0,r.ensureNotNull)(e.activeBroker()),l=await n,c=await a.accountsMetainfo(),u=a.accountManagerInfo();if(0===c.length)return;const h=c.map((e=>{var t;return{id:e.id,name:e.name,callBack:async()=>{e.id!==a.currentAccount()&&a.setCurrentAccount(e.id)},currency:""===e.currency?void 0:null!==(t=e.currency)&&void 0!==t?t:void 0}})),p=h.find((e=>e.id===a.currentAccount())),m=a.metainfo(),_=void 0!==l?(0,s.brokersListFromPlans)(o,l):void 0,g=void 0!==_?{title:u.accountTitle,brokerName:m.title,brokerId:m.id,logo:m.logoMiniUrl,logoBlack:m.logoMiniBlackUrl,actions:a.buttonDropdownActions(),trading:e,brokers:_,isBeta:m.isBeta,realtimeDataPermissionsConfig:m.realtimeDataPermissionsToggleConfig}:void 0,b={dataExportController:void 0!==i?new d(i,m.title):void 0,initialSummaryFieldsVisibilityInfo:t.fieldsVisibilityInfo(),summaryFieldsVisibilityInfo$:t.fieldsVisibilityInfo$,summaryFieldToggler:t.toggleField};return{brokerDropdownProps:g,accountDropdownProps:{currentAccount:(0,r.ensureDefined)(p),accountsList:h,currentAccountUpdate:a.currentAccountUpdate,removeMargins:void 0===g},commonDropdownProps:b}}},241347:(e,t,i)=>{"use strict";i.r(t),i.d(t,{SummaryFieldsVisibilityManager:()=>s});var r=i(947488);class s{constructor(e,t){var i;this.toggleField=e=>{var t;const i=this._fieldsVisibilityInfo$.getValue(),r=new Map(i),s=r.get(e);void 0!==s&&(s.visible=!s.visible,this._fieldsVisibilityInfo$.next(r),null===(t=this._settingsGetter())||void 0===t||t.setSummaryFieldsVisibilityInfo(r))},this._settingsGetter=t
;const s=null===(i=this._settingsGetter())||void 0===i?void 0:i.summaryFieldsVisibilityInfo();this._fieldsVisibilityInfo$=new r.BehaviorSubject(new Map(e.map((({text:e,isDefault:t})=>{var i,r,o;return[e,{id:e,visible:null===(o=null!==(r=null===(i=null==s?void 0:s.get(e))||void 0===i?void 0:i.visible)&&void 0!==r?r:t)||void 0===o||o}]})))),this.fieldsVisibilityInfo$=this._fieldsVisibilityInfo$.asObservable()}fieldsVisibilityInfo(){return this._fieldsVisibilityInfo$.getValue()}}},943778:(e,t,i)=>{"use strict";i.d(t,{pipsToPrice:()=>a,pipsToRiskInCurrency:()=>l,pipsToRiskInPercent:()=>c,priceToPips:()=>s,riskInCurrencyToPips:()=>o,riskInPercentToPips:()=>n});var r=i(960521);function s(e,t,i,s){return(0,r.Big)(e).minus(t).div(s).div(i).toNumber()}function o(e,t,i,s,o){const n=(0,r.Big)(i).mul(t).mul(o||1);if(n.eq(0))return 0;const a=(0,r.Big)(e).div(n).mul(s).toNumber();return Math.floor(a)}function n(e,t,i,s,o,n){const a=(0,r.Big)(s).mul(t).mul(n||1).mul(100);if(a.eq(0))return 0;const l=(0,r.Big)(e).mul(i).div(a).mul(o).toNumber();return Math.floor(l)}function a(e,t,i,s){return(0,r.Big)(i).mul(e).mul(s).plus(t).toNumber()}function l(e,t,i,s,o){return(0,r.Big)(e).mul(i).mul(t).mul(o||1).div(s).toNumber()}function c(e,t,i,s,o,n){return i?(0,r.Big)(e).mul(s).mul(t).mul(n||1).mul(100).div(i).div(o).toNumber():0}},164530:(e,t,i)=>{"use strict";i.d(t,{BracketType:()=>r.BracketType,OrderOrPositionMessageType:()=>r.OrderOrPositionMessageType});i(282729);var r=i(656846)},656846:(e,t,i)=>{"use strict";var r,s,o,n,a,l,c,d,u,h,p,m,_,g,b;i.d(t,{BracketType:()=>d,DisconnectType:()=>_,OrderOrPositionMessageType:()=>p,PipValueType:()=>g,RestrictionType:()=>b,TradingEntityType:()=>l}),function(e){e[e.CONNECTED=1]="CONNECTED",e[e.CONNECTING=2]="CONNECTING",e[e.DISCONNECTED=3]="DISCONNECTED",e[e.ERROR=4]="ERROR"}(r||(r={})),function(e){e[e.LIMIT=1]="LIMIT",e[e.MARKET=2]="MARKET",e[e.STOP=3]="STOP",e[e.STOPLIMIT=4]="STOPLIMIT"}(s||(s={})),function(e){e[e.BUY=1]="BUY",e[e.SELL=-1]="SELL"}(o||(o={})),function(e){e[e.CANCELED=1]="CANCELED",e[e.FILLED=2]="FILLED",e[e.INACTIVE=3]="INACTIVE",e[e.PLACING=4]="PLACING",e[e.REJECTED=5]="REJECTED",e[e.WORKING=6]="WORKING"}(n||(n={})),function(e){e[e.ALL=0]="ALL",e[e.CANCELED=1]="CANCELED",e[e.FILLED=2]="FILLED",e[e.INACTIVE=3]="INACTIVE",e[e.REJECTED=5]="REJECTED",e[e.WORKING=6]="WORKING"}(a||(a={})),function(e){e[e.Order=1]="Order",e[e.Position=2]="Position"}(l||(l={})),function(e){e[e.ORDER=1]="ORDER",e[e.POSITION=2]="POSITION"}(c||(c={})),function(e){e[e.StopLoss=0]="StopLoss",e[e.TakeProfit=1]="TakeProfit",e[e.TrailingStop=2]="TrailingStop"}(d||(d={})),function(e){e[e.LIMITPRICE=1]="LIMITPRICE",e[e.STOPPRICE=2]="STOPPRICE",e[e.TAKEPROFIT=3]="TAKEPROFIT",e[e.STOPLOSS=4]="STOPLOSS"}(u||(u={})),function(e){e[e.ERROR=0]="ERROR",e[e.SUCCESS=1]="SUCCESS"}(h||(h={})),function(e){e.Information="information",e.Warning="warning",e.Error="error"}(p||(p={})),function(e){e.Demo="demo",e.Live="live"}(m||(m={})),function(e){e[e.LogOut=0]="LogOut",e[e.FailedRestoring=1]="FailedRestoring",
e[e.Offline=2]="Offline",e[e.APIError=3]="APIError",e[e.TwoFactorRequired=4]="TwoFactorRequired",e[e.CancelAuthorization=5]="CancelAuthorization",e[e.TimeOutForAuthorization=6]="TimeOutForAuthorization",e[e.OauthError=7]="OauthError",e[e.BrokenConnection=8]="BrokenConnection",e[e.FailedSignIn=9]="FailedSignIn"}(_||(_={})),function(e){e[e.None=0]="None",e[e.Pips=1]="Pips",e[e.Ticks=2]="Ticks"}(g||(g={})),function(e){e.Halted="HALTED",e.NotShortable="NOT-SHORTABLE",e.HardToBorrow="HARD-TO-BORROW"}(b||(b={}))},282729:(e,t,i)=>{"use strict";var r;i.d(t,{StopType:()=>r}),function(e){e[e.StopLoss=0]="StopLoss",e[e.TrailingStop=1]="TrailingStop"}(r||(r={}))},484095:(e,t,i)=>{"use strict";function r(e){return e instanceof s}i.d(t,{UserFriendlyError:()=>s,isUserFriendlyError:()=>r});class s extends Error{constructor({detailedErrorMessage:e,userFriendlyMessage:t,cause:i}){super(t),this.name="UserFriendlyError",this.detailedErrorMessage=e,this.cause=i}}},637401:(e,t,i)=>{"use strict";i.d(t,{getErrorCauses:()=>T,getErrorMessage:()=>w,getLoggerMessage:()=>B,isFinalOrderStatus:()=>P,makeNonTradableSymbolText:()=>C,orderStatusToText:()=>g,orderTypeToText:()=>y,positionSideToText:()=>S,roundDownToPowerOf10:()=>k,roundToStepByPriceTypeAndSide:()=>f,sideToText:()=>v});var r=i(509806),s=i(960521),o=i(656846),n=i(282729),a=(i(793361),i(372605),i(6835)),l=i(311757),c=i(484095);const d={2:{},1:{}},u={2:{},1:{}},h={},p={},m={};let _=!1;(0,a.getLogger)("Trading.Utils");function g(e){return b(),m[e]}function b(){_||(_=!0,d[2][2]=r.t(null,{context:"Market order"},i(610952)),d[2][1]=r.t(null,{context:"Limit order"},i(382377)),d[2][3]=r.t(null,{context:"order"},i(608921)),d[2][4]=r.t(null,{context:"Stop limit order"},i(779062)),d[1][2]=r.t(null,void 0,i(359758)),d[1][1]=r.t(null,void 0,i(398157)),d[1][3]=r.t(null,{context:"order"},i(7122)),d[1][4]=r.t(null,void 0,i(900853)),u[2][o.BracketType.TakeProfit]=r.t(null,{context:"Take profit order"},i(347947)),u[2][o.BracketType.StopLoss]=r.t(null,{context:"Stop loss order"},i(15307)),u[2][o.BracketType.TrailingStop]=r.t(null,{context:"Trailing stop order"},i(154462)),u[1][o.BracketType.TakeProfit]=r.t(null,void 0,i(129266)),u[1][o.BracketType.StopLoss]=r.t(null,void 0,i(241648)),u[1][o.BracketType.TrailingStop]=r.t(null,void 0,i(86430)),h[1]=r.t(null,{context:"trading"},i(63470)),h[-1]=r.t(null,{context:"trading"},i(742259)),p[1]=r.t(null,{context:"trading"},i(274771)),p[-1]=r.t(null,{context:"trading"},i(951219)),m[2]=r.t(null,void 0,i(885323)),m[1]=r.t(null,void 0,i(767207)),m[6]=r.t(null,void 0,i(328231)),m[3]=r.t(null,void 0,i(614841)),m[4]=r.t(null,void 0,i(373425)),m[5]=r.t(null,void 0,i(442060)))}function v(e,t){b();const i=h[e];return t?i.toUpperCase():i}function y(e){const{orderType:t,uppercase:i,shorten:r,parentId:s,stopType:a}=e;b();const l=r?2:1;let c=d,h=t;return void 0!==s&&(c=u,3===t&&(h=a===n.StopType.TrailingStop?o.BracketType.TrailingStop:o.BracketType.StopLoss),1===t&&(h=o.BracketType.TakeProfit)),i?c[l][h].toUpperCase():c[l][h]}function f(e,t,i,r){const o=(0,s.Big)(e).div(t)
;return 1===i&&1===r||2===i&&-1===r?o.round(0,0).mul(t).toNumber():1===i&&-1===r||2===i&&1===r?o.round(0,3).mul(t).toNumber():0}r.t(null,void 0,i(609372));function k(e){return(0,s.Big)(10).pow(Math.floor(Math.log10(e))).toNumber()}function P(e){return-1!==[2,1,5].indexOf(e)}function S(e){return b(),p[e]}function C(e,t){return r.t(null,void 0,i(221456)).replace("{symbol}",e).replace("{broker}",t)}function w(e){if(void 0===e)return r.t(null,void 0,i(328523));let t;return t=e instanceof Error?e.message:"object"==typeof e?JSON.stringify(e):e.toString(),(0,l.removeTags)(t)}function B(e){return e instanceof c.UserFriendlyError?(0,l.removeTags)(e.detailedErrorMessage):w(e)}o.BracketType.StopLoss,r.t(null,void 0,i(241648)),o.BracketType.TakeProfit,r.t(null,void 0,i(129266)),o.BracketType.TrailingStop,r.t(null,void 0,i(86430)),o.BracketType.StopLoss,o.BracketType.TakeProfit,o.BracketType.TrailingStop;new Set(["date","dateOrDateTime","default","fixed","variablePrecision","formatQuantity","formatPrice","formatPriceForexSup","integerSeparated","localDate","localDateOrDateTime","percentage","pips","profit","profitInInstrumentCurrency","side","positionSide","status","symbol","text","type","marginPercent","empty"]);function T(e){return(0,c.isUserFriendlyError)(e)&&void 0!==e.cause?[...T(e.cause),e.cause]:[e]}},481853:(e,t,i)=>{"use strict";i.d(t,{BrokerService:()=>s});var r=i(650151);class s{constructor(e){this._activeBroker=null,this._trading=e,this._trading.onConnectionStatusChange.subscribe(this,this._onStatusChange),this._onStatusChange(this._trading.connectStatus())}activeBroker(){return this._activeBroker}trading(){return this._trading}_stopService(){this.stopService(),(0,r.ensureNotNull)(this._activeBroker).currentAccountUpdate.unsubscribeAll(this)}_startService(){this.startService(),(0,r.ensureNotNull)(this._activeBroker).currentAccountUpdate.subscribe(this,this._onCurrentAccountUpdate)}_onStatusChange(e){const t=this._trading.activeBroker();this._activeBroker===t&&1===e||(null!==this._activeBroker&&(this._stopService(),this._activeBroker=null),null!==t&&1===e&&(this._activeBroker=t,this._startService(),this._lastAccountId=t.currentAccount()))}_onCurrentAccountUpdate(){const e=(0,r.ensureNotNull)(this._activeBroker);this._lastAccountId!==e.currentAccount()&&(this.stopService(),this.startService(),this._lastAccountId=e.currentAccount())}}},824777:(e,t,i)=>{"use strict";i.r(t),i.d(t,{addBroker:()=>Pe,addBrokerByLaunchCountries:()=>Se,brokersList:()=>Ce,createBrokerConnection:()=>Be,getBrokerMetainfo:()=>Te});var r=i(509806),s=i(116193),o=i(148442),n=i(156963),a=i(372605),l=i(466052),c=i(650151);class d{constructor(e){this._objects={},this._started=!1,this._isObjectsRequestActual=!1,this._ordersPromise=null,this._getter=e,this.updateDelegate=new l.Delegate,this.partialUpdateDelegate=new l.Delegate}start(){this._started||(this._started=!0,this._ordersPromise=this._requestObjects())}stop(){this._objects={},this._started=!1,this._ordersPromise=null,this._isObjectsRequestActual=!1}update(e,t){
this._started&&(this._isObjectsRequestActual?this._isObjectsRequestActual=!1:(this._objects[e.id]=e,this._onObjectUpdated(e,t)))}partialUpdate(e,t){if(!this._started)return;if(this._isObjectsRequestActual)return void(this._isObjectsRequestActual=!1);let i,r;(0,a.isObject)(e)?(i=e.id,r=e):(i=e,r=(0,c.ensure)(t));const s=this._objects[i];s&&(Object.assign(s,r),this.partialUpdateDelegate.fire(s,r))}fullUpdate(){this._started&&(this._isObjectsRequestActual?this._isObjectsRequestActual=!1:this._ordersPromise=this._requestObjects())}getObjects(){return this._ordersPromise||Promise.resolve(Object.values(this._objects))}_onObjectUpdated(e,t){this.updateDelegate.fire(e,t)}_onAllObjectsUpdated(){this._objectsCache().forEach((e=>this.updateDelegate.fire(e,!0)))}_objectsCache(){return Object.values(this._objects)}async _requestObjects(){let e=[];do{this._isObjectsRequestActual=!0,e=await this._getter()}while(!this._isObjectsRequestActual);var t;return this._objects=(t="id",e.reduce(((e,i)=>(e[i[t]]=i,e)),{})),this._ordersPromise=null,this._isObjectsRequestActual=!1,this._onAllObjectsUpdated(),e}}var u=i(6835),h=i(511990);class p extends d{constructor(e,t){super(e),this._brokerConfigGetter=t}_onObjectUpdated(e,t){this._patchTrades(this._objectsCache().filter((t=>t.symbol===e.symbol&&0!==t.qty)),e,t),super._onObjectUpdated(e,t)}_onAllObjectsUpdated(){this._patchTrades(this._objectsCache().filter((e=>0!==e.qty))),super._onAllObjectsUpdated()}_patchTrades(e,t,i){const r=this._brokerConfigGetter();let s;s=r.requiresFIFOCloseTrades?r.fifoOnlyForSameQty?g:_:m;const o=s(e);for(const e of o)t!==e&&super._onObjectUpdated(e,i)}}function m(e){const t=[];for(const i of e)i.canBeClosed||(i.canBeClosed=!0,t.push(i));return t}function _(e){const t={};for(const i of e){let e=t[i.symbol];void 0===e&&(e={oldest:null,all:[]},t[i.symbol]=e),(null===e.oldest||e.oldest.date>i.date)&&(e.oldest=i),e.all.push(i)}const i=[];for(const e of Object.keys(t)){const r=(0,c.ensureDefined)(t[e]);for(const e of r.all){const t=r.oldest===e,s=t!==e.canBeClosed;e.canBeClosed=t,s&&i.push(e)}}return i}function g(e){const t={};for(const i of e){let e=t[i.symbol];void 0===e&&(e={},t[i.symbol]=e);let r=e[i.qty];void 0===r&&(r={oldest:null,all:[]},e[i.qty]=r),(null===r.oldest||r.oldest.date>i.date)&&(r.oldest=i),r.all.push(i)}const i=[];for(const e of Object.keys(t)){const r=(0,c.ensureDefined)(t[e]);for(const e of Object.keys(r)){const t=(0,c.ensureDefined)(r[e]);for(const e of t.all){const r=t.oldest===e,s=r!==e.canBeClosed;e.canBeClosed=r,s&&i.push(e)}}}return i}const b=(0,u.getLogger)("Trading.Migrations");var v=i(637401),y=i(311757),f=i(508334),k=i(189904),P=i(481330);function S(e,t){return{symbol:t.symbol,type:2,side:1===t.side?-1:1,qty:Math.abs(e),seenPrice:null,isClose:!0}}var C=i(864348),w=i(656846);class B{constructor(){this._validators=new Map}add(e,t){this._validators.set(t,e)}validate(e){const t={};let i=!0;for(const[r,s]of this._validators.entries()){const o=s.validate(e);o.isValid||(i=!1,t[r]=o.errorMessage)}return i?{isValid:i}:{isValid:i,errorMessages:t}}}
class T{constructor(e,t=[]){this._status=C.PlaceOrEditContextStatus.Undefined,this._onStatusChange=new l.Delegate,this._errors={},this._isValidationEnabled=e,this._validator=new B;for(const{validator:e,validatorName:i}of t)this._validator.add(e,i)}onReady(){return this._onReady}data(){return this._orderData}status(){return this._status}errors(){return this._errors}onStatusChange(){return this._onStatusChange}async send(e){if(this._status!==C.PlaceOrEditContextStatus.Undefined)return!1;this._setStatus(C.PlaceOrEditContextStatus.Loading),await this._onReady;const t=await this._processSend(e),i=t?C.PlaceOrEditContextStatus.Undefined:C.PlaceOrEditContextStatus.Error;return this._setStatus(i),t}async _setData(e){this._orderData=await this._processOrderData(e),this._assertOrderIsValid()}_assertOrderIsValid(){const{isValid:e,errorMessages:t}=this._validate();let i=!1;if(e)i=this._status!==C.PlaceOrEditContextStatus.Undefined,this._errors={},this._status=C.PlaceOrEditContextStatus.Undefined;else{const[e]=(0,a.deepEquals)(this._errors,t);i=!e,this._errors=t,this._status=C.PlaceOrEditContextStatus.Error}i&&this._onStatusChange.fire()}_setStatus(e){this._status!==e&&(this._status=e,this._onStatusChange.fire())}_validate(){return this._isValidationEnabled?this._validator.validate(this._orderData):{isValid:!0}}}var E=i(957877),O=i(807107);class D{constructor(e){const{priceType:t,quotes:i,formatter:r,instrumentInfo:s,supportStopOrdersInBothDirections:o,supportStopLimitOrdersInBothDirections:n}=e;this._priceType=t,this._quotes=i,this._formatter=r,this._supportStopOrdersInBothDirections=Boolean(o),this._supportStopLimitOrdersInBothDirections=Boolean(n),this._symbolType=s.type||"",this._minTick=s.minTick,this._limitPriceStep=s.limitPriceStep,this._stopPriceStep=s.stopPriceStep,this._variableMinTickData=s.variableMinTick?(0,O.makeVariableMinTickData)(this._minTick,s.variableMinTick):void 0}validate(e){const{type:t,side:s,stopPrice:o,limitPrice:n}=e,a=2===this._priceType;if(2===t||a&&1===t||!a&&3===t)return{isValid:!0};const l=a?o:n;if(void 0===l)return{isValid:!1,errorMessage:r.t(null,void 0,i(347957))};const c=(0,P.getPriceStep)({price:l,priceType:this._priceType,minTick:this._minTick,variableMinTickData:this._variableMinTickData,limitPriceStep:this._limitPriceStep,stopPriceStep:this._stopPriceStep}),d=(0,P.roundToStepRequired)({priceType:this._priceType,minTick:this._minTick,limitPriceStep:this._limitPriceStep,stopPriceStep:this._stopPriceStep}),u=(0,E.validatePrice)({price:l,askOrBid:(0,P.getQuotePrice)(this._quotes,s),orderType:t,side:s,isStopPrice:a,isForex:"forex"===this._symbolType,formatter:this._formatter,supportStopOrdersInBothDirections:this._supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:this._supportStopLimitOrdersInBothDirections,step:c,roundedToStep:d});return u.res?{isValid:!1,errorMessage:u.msg}:{isValid:!0}}}var I=i(99708);class L{constructor(e){this._quantityMetainfo=e}validate(e){const t=(0,I.checkQtyError)(this._quantityMetainfo,e.qty,!0);return t.res?{isValid:!1,errorMessage:t.msg}:{
isValid:!0}}}var x=i(164530),N=i(346849),M=i(943778);class A{constructor(e){this._bracketPercentPriceRuleCheckers=[];const{bracketType:t,priceType:i,parentType:r,quotes:s,formatter:o,instrumentInfo:n,validationRules:a}=e;if(this._bracketType=t,this._priceType=i,this._parentType=r,this._quotes=s,this._formatter=o,this._pipSize=n.pipSize,this._priceStep=(0,P.getPriceStep)({priceType:i,minTick:n.minTick||n.pipSize,limitPriceStep:n.limitPriceStep,stopPriceStep:n.stopPriceStep}),this._roundToStepRequired=(0,P.roundToStepRequired)({priceType:i,minTick:n.minTick||n.pipSize,limitPriceStep:n.limitPriceStep,stopPriceStep:n.stopPriceStep}),void 0!==a)for(const e of a)this._bracketPercentPriceRuleCheckers.push((0,N.makeBracketPercentPriceRuleChecker)(e.options.min,e.options.max))}validate(e){const{side:t,takeProfit:s,stopLoss:o,trailingStopPips:n}=e;if(this._bracketType===x.BracketType.TakeProfit&&void 0===s||this._bracketType===x.BracketType.StopLoss&&void 0===o||this._bracketType===x.BracketType.TrailingStop&&void 0===n)return{isValid:!0};const a=function(e,t){switch(e.type){case 1:case 4:return e.limitPrice;case 3:return e.stopPrice;default:return(0,P.getQuotePrice)(t,e.side)}}(e,this._quotes);if(void 0===a)return{isValid:!1,errorMessage:r.t(null,void 0,i(762686))};const l=(this._bracketType!==x.BracketType.TakeProfit?-1:1)*t,c=this._getPrice(e,a,l),d=this._getPips(e,a,l),u=(0,N.checkBracketError)({quotes:this._quotes,side:t,price:c,pips:d,priceType:this._priceType,priceStep:this._priceStep,parentPrice:a,parentType:this._parentType,bracketType:this._bracketType,isStatusEditing:!1,isEnabled:!0,bracketPercentPriceRuleCheckers:this._bracketPercentPriceRuleCheckers,priceFormatter:this._formatter,isRoundToPriceStep:this._roundToStepRequired});return u.res?{isValid:!1,errorMessage:u.msg}:{isValid:!0}}_getPrice(e,t,i){var r,s;switch(this._bracketType){case x.BracketType.TakeProfit:return null!==(r=e.takeProfit)&&void 0!==r?r:null;case x.BracketType.StopLoss:return null!==(s=e.stopLoss)&&void 0!==s?s:null;case x.BracketType.TrailingStop:return void 0===e.trailingStopPips?null:(0,M.pipsToPrice)(e.trailingStopPips,t,i,this._pipSize);default:return null}}_getPips(e,t,i){var r;switch(this._bracketType){case x.BracketType.TakeProfit:return void 0===e.takeProfit?null:(0,M.priceToPips)(e.takeProfit,t,i,this._pipSize);case x.BracketType.StopLoss:return void 0===e.stopLoss?null:(0,M.priceToPips)(e.stopLoss,t,i,this._pipSize);case x.BracketType.TrailingStop:return null!==(r=e.trailingStopPips)&&void 0!==r?r:null;default:return null}}}class V{constructor(e){const{orderDialogOptions:t}=e;this._orderDialogOptions=t}validate(e){var t;const{customFields:s}=e;if(void 0===(null===(t=this._orderDialogOptions)||void 0===t?void 0:t.customFields)||0===this._orderDialogOptions.customFields.length)return{isValid:!0};const o=[];return this._orderDialogOptions.customFields.forEach((e=>{void 0===(null==s?void 0:s[e.id])&&o.push(e.title)})),0===o.length?{isValid:!0}:{isValid:!1,errorMessage:r.t(null,void 0,i(346881)).format({customFields:o.join(", ")})}}}
class R extends T{constructor(e){const{orderData:t,instrumentInfo:i,quotes:r,configFlags:s,formatter:o,tpValidationRules:n,slValidationRules:a,isValidationEnabled:l,orderDialogOptions:c,callbacks:d}=e;super(l,[{validator:new L(i.qty),validatorName:"qty"},{validator:new D({priceType:2,quotes:r,formatter:o,instrumentInfo:i,supportStopOrdersInBothDirections:s.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:s.supportStopLimitOrdersInBothDirections}),validatorName:"stopPrice"},{validator:new D({priceType:1,quotes:r,formatter:o,instrumentInfo:i,supportStopOrdersInBothDirections:s.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:s.supportStopLimitOrdersInBothDirections}),validatorName:"limitPrice"},{validator:new V({orderDialogOptions:c}),validatorName:"customFields"},{validator:new A({bracketType:w.BracketType.TakeProfit,priceType:1,parentType:1,quotes:r,formatter:o,instrumentInfo:i,validationRules:n}),validatorName:"takeProfit"},{validator:new A({bracketType:w.BracketType.StopLoss,priceType:2,parentType:1,quotes:r,formatter:o,instrumentInfo:i,validationRules:a}),validatorName:"stopLoss"},{validator:new A({bracketType:w.BracketType.TrailingStop,priceType:2,parentType:1,quotes:r,formatter:o,instrumentInfo:i,validationRules:a}),validatorName:"trailingStopPips"}]),this._createInitialPreOrder=d.createInitialPreOrder,this._placeOrder=d.placeOrder,this._previewOrder=d.previewOrder,this._onReady=this._setData(t)}async preview(){return this._status===C.PlaceOrEditContextStatus.Error?{sections:[]}:this._previewOrder(this._orderData)}externalContext(){return{type:C.PlaceOrEditContextType.PlaceOrder,data:()=>this.data(),send:()=>this.send(),status:()=>this.status(),errors:()=>this.errors()}}_processSend(e){return this._placeOrder(this._orderData,e)}_processOrderData(e){return this._createInitialPreOrder(e)}}var F=i(822914),W=i(282729);class q extends T{constructor(e){const{orderData:t,callbacks:i}=e;super(!1),this._modifyOrder=i.modifyOrder,this._metainfo=i.metainfo,this._symbolInfo=i.symbolInfo,this._orderById=i.orderById,this._onReady=this._setData(t)}externalContext(){return{type:C.PlaceOrEditContextType.EditOrder,data:()=>this.data(),send:()=>this.send(),status:()=>this.status(),errors:()=>this.errors()}}async _processOrderData(e){if(!this._metainfo().configFlags.supportModifyTrailingStop){const t=await this._orderById(e.id);e.hasTrailingStopBracket=void 0!==t&&void 0!==t.trailingStopPips}const{limitPriceStep:t,stopPriceStep:i}=await this._symbolInfo(e.symbol);if(e.limitPrice=void 0!==t&&void 0!==e.limitPrice?(0,v.roundToStepByPriceTypeAndSide)(e.limitPrice,t,1,e.side):e.limitPrice,e.stopPrice=void 0!==i&&void 0!==e.stopPrice?(0,v.roundToStepByPriceTypeAndSide)(e.stopPrice,i,2,e.side):e.stopPrice,void 0!==e.parentId&&!n.enabled("always_pass_called_order_to_modify")){let t;try{t=await this._orderById(e.parentId)}catch(e){(0,v.getLoggerMessage)(e)}if(void 0!==t&&(0,P.isOrderActive)(t.status)){const i=(0,F.default)(t);return void 0!==e.limitPrice&&(i.takeProfit=e.limitPrice),
void 0!==e.stopPrice&&(e.stopType===W.StopType.TrailingStop&&void 0!==e.trailingStopPips?(i.trailingStopPips=e.trailingStopPips,delete i.stopLoss):(i.stopLoss=e.stopPrice,delete i.trailingStopPips)),i}}return e}_processSend(e){return this._modifyOrder(this._orderData,e)}_configureValidator(){}}var U=i(232192);const $=(0,u.getLogger)("Trading.BrokerConnectionAdapter"),Q=r.t(null,void 0,i(473142)),z=r.t(null,void 0,i(945593));function H(e){(0,c.assert)("object"!=typeof e,"Expected not an object")}class j{constructor({brokerMetainfo:e,brokerConnection:t,host:s,brokerRealtimeAdapter:o,tradingStat:n,tradingSettingsStorageGetter:a,brokerPlan:c}){this.connectionStatusUpdate=new l.Delegate,this.executionUpdate=new l.Delegate,this.tradingOperationFinished=new l.Delegate,this.currentAccountUpdate=new l.Delegate,this._brokerPlan=null,this._subscriptions={},this._lastFireResult={},this._fakeDOMSubscriptions={},this._formattersCache={},this._spreadFormattersCache={},this._quantityFormattersCache={},this._tradesCache=null,this._fakePositionUpdateDelegate=null,this._realtimeSubscriptionState=[],this._loggedInManually=!1,this._pendingSubscriptions=[],this._sessionId=(0,k.guid)(),this.leverageInfo=e=>{if(this.config.supportLeverage&&this._brokerConnection.leverageInfo)return this._brokerConnection.leverageInfo(e);throw new Error("Method leverage is not implemented")},this.setLeverage=e=>{if(this.config.supportLeverage&&this._brokerConnection.setLeverage)return this._brokerConnection.setLeverage(e);throw new Error("Method setLeverage is not implemented")},this.previewLeverage=e=>{if(this.config.supportLeverage&&this._brokerConnection.previewLeverage)return this._brokerConnection.previewLeverage(e);throw new Error("Method previewLeverage is not implemented")},this.maintenanceStatus=async()=>{try{return void 0!==this._brokerConnection.maintenanceStatus?await this._brokerConnection.maintenanceStatus():{isMaintenance:!1}}catch(e){return this._brokerLogger.logError(`Failed to fetch maintenance status: ${(0,v.getLoggerMessage)(e)}`),{isMaintenance:!0,message:r.t(null,{replace:{brokerName:this._brokerMetainfo.title}},i(8793))}}},this.config=Object.assign({},e.configFlags),this._brokerMetainfo=this._patchMetainfo(e),this._brokerPlan=c||null,this._brokerConnection=t,this._host=s,this._tradingStat=n,this._getTradingSettingsStorage=a,this._brokerLogger=(0,u.getLogger)("Trading."+this._brokerMetainfo.id+".Connection"),s.setBrokerConnectionAdapter(this),this._initializeConnectProtection(),this._positionsCache=t.positions?new d((()=>t.positions?t.positions():Promise.resolve([]))):null,this._tradesCache=t.trades?new p((()=>t.trades?t.trades():Promise.resolve([])),(()=>this.config)):null,this._ordersCache=new d((()=>t.orders()));const h=e=>{1===e?(null!==this._positionsCache&&this._positionsCache.start(),this._ordersCache.start(),this._tradesCache&&this._tradesCache.start()):(null!==this._positionsCache&&this._positionsCache.stop(),this._ordersCache.stop(),this._tradesCache&&this._tradesCache.stop())};this.connectionStatusUpdate.subscribe(null,h),
h(this.connectionStatus()),this._originalDOMSubscriptionMethods={subscribeDOM:t.subscribeDOM,unsubscribeDOM:t.unsubscribeDOM},this._patchBrokerSubscribeUnsubscribeDOMMethods(),this.connectionStatusUpdate.subscribe(null,(e=>{1===e&&this._patchBrokerSubscribeUnsubscribeDOMMethods()})),e.configFlags.supportPositions||(this._fakePositionUpdateDelegate=new l.Delegate),this._brokerRealtimeAdapter=o}tryRestoreSession(){if(this._brokerConnection.tryRestoreSession)return this._brokerConnection.tryRestoreSession()}get orderUpdate(){return this._ordersCache.updateDelegate}get positionUpdate(){return null===this._fakePositionUpdateDelegate?(0,c.ensure)(this._positionsCache).updateDelegate:this._fakePositionUpdateDelegate}get tradeUpdate(){return(0,c.ensure)(this._tradesCache).updateDelegate}get orderPartialUpdate(){return this._ordersCache.partialUpdateDelegate}get positionPartialUpdate(){return null===this._fakePositionUpdateDelegate?(0,c.ensure)(this._positionsCache).partialUpdateDelegate:this._fakePositionUpdateDelegate}get tradePartialUpdate(){return(0,c.ensure)(this._tradesCache).partialUpdateDelegate}onOrderUpdate(e){this._ordersCache.update(e)}onOrderPartialUpdate(e,t){this._ordersCache.partialUpdate(e,t)}onPositionUpdate(e,t){if((0,c.assert)(!!this.config.supportPositions,"Broker doesn`t support positions"),0===e.qty){const t=this._lastFireResult[e.id];t&&delete t.PL}(0,c.ensure)(this._positionsCache).update(e,t)}onPositionPartialUpdate(e,t){(0,c.assert)(!!this.config.supportPositions,"Broker doesn`t support positions"),(0,c.ensure)(this._positionsCache).partialUpdate(e,t)}onTradeUpdate(e,t){if((0,c.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),0===e.qty){const t=this._lastFireResult[e.symbol];t&&delete t.TradePL}(0,c.ensure)(this._tradesCache).update(e,t)}onTradePartialUpdate(e,t){(0,c.ensure)(this._tradesCache).partialUpdate(e,t)}onCurrentAccountChanged(){null!==this._positionsCache&&this._positionsCache.fullUpdate(),this._ordersCache.fullUpdate(),this._tradesCache&&this._tradesCache.fullUpdate();const e=this.currentAccount();this.currentAccountUpdate.fire(e)}patchConfig(e){var t;!(t=e).hasOwnProperty("supportBrackets")||t.hasOwnProperty("supportOrderBrackets")||t.hasOwnProperty("supportPositionBrackets")||(b.logWarn("supportBrackets is deprecated. Use supportOrderBrackets and supportPositionBrackets instead."),t.supportOrderBrackets=t.supportBrackets,t.supportPositionBrackets=t.supportBrackets),t.hasOwnProperty("supportModifyOrder")&&(b.logWarn("supportModifyOrder is deprecated. Use supportModifyOrderPrice, supportEditAmount and supportModifyBrackets instead."),t.supportModifyOrderPrice=t.supportModifyOrder,t.supportEditAmount=t.supportModifyOrder,t.supportModifyBrackets=t.supportModifyOrder),Object.assign(this.config,e),Object.assign(this._brokerMetainfo.configFlags,e),this._brokerMetainfo=this._patchMetainfo(this._brokerMetainfo),this._updateConfigDependentProperties()}async getOrderDialogOptions(e){if(void 0!==this._brokerConnection.getOrderDialogOptions)try{
return await this._brokerConnection.getOrderDialogOptions(e)}catch(e){return void this._brokerLogger.logError(`Failed to fetch options for the order dialog: ${(0,v.getLoggerMessage)(e)}`)}}getPositionDialogOptions(){return void 0!==this._brokerConnection.getPositionDialogOptions?this._brokerConnection.getPositionDialogOptions():void 0}getValidationRules(e){return void 0!==this._brokerConnection.getValidationRules?this._brokerConnection.getValidationRules(e):void 0}chartContextMenuActions(e,t){return this._brokerConnection.chartContextMenuActions(e,t)}buttonDropdownActions(){return this._host.buttonDropdownActions()}connectionStatus(){return this._brokerConnection.connectionStatus()}isConnected(){return 1===this._brokerConnection.connectionStatus()}signIn(e,t,i,r){return this._brokerLogger.logNormal(`Try to login with username: ${e}`),this._loggedInManually=!0,this._brokerConnection.signIn(e,t,i,r)}loggedInManually(){return this._loggedInManually}disconnect(e=!1){try{return this._brokerConnection.disconnect(e)}catch(e){$.logWarn("Failed to disconnect")}}currentAccount(){return this._brokerConnection.currentAccount?this._brokerConnection.currentAccount():""}currentAccountType(){return this._brokerConnection.currentAccountType?this._brokerConnection.currentAccountType():void 0}checkUserHasLiveAccount(){return this._brokerConnection.checkUserHasLiveAccount()}metainfo(){return this._brokerMetainfo}brokerPlan(){return this._brokerPlan}bro(){return this._brokerConnection}fireSubscription(e,t,i,r){if(void 0===this._lastFireResult[t]&&(this._lastFireResult[t]={Realtime:null,PL:null,Equity:null,DOM:null,TradePL:null,PipValue:null,MarginAvailable:null,CryptoBalance:null}),(0,c.ensure)(this._lastFireResult[t])[e]={data:i,time:Date.now()},void 0===this._subscriptions[t])return;const s=(0,c.ensure)(this._subscriptions[t]);(0,c.ensure)(s[e]).forEach((e=>e(t,i,r)))}positions(e){return this.config.supportPositions?(this._makeSureBrokerIsConnected(),this._positions().then((t=>t.filter((t=>void 0===e||t.symbol===e))))):Promise.resolve([])}disconnectWarningMessage(){return this._brokerConnection.disconnectWarningMessage?this._brokerConnection.disconnectWarningMessage():null}connectWarningMessage(){return this._brokerConnection.connectWarningMessage?this._brokerConnection.connectWarningMessage():null}trades(e){return this._makeSureBrokerIsConnected(),(0,c.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),this._trades().then((t=>t.filter((t=>void 0===e||t.symbol===e))))}positionById(e){return this._brokerConnection.positionById?this._brokerConnection.positionById(e):this.positions().then((t=>t.find((t=>t.id===e))))}tradeById(e){return(0,c.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),this.trades().then((t=>t.find((t=>t.id===e))))}orders(e){return this._makeSureBrokerIsConnected(),this._orders().then((t=>t.filter((t=>void 0===e||t.symbol===e))))}ordersHistory(){return this._makeSureBrokerIsConnected(),
this.config.supportOrdersHistory&&this._brokerConnection.ordersHistory?this._brokerConnection.ordersHistory():Promise.resolve([])}async executions(e){return this.config.supportExecutions?(this._makeSureBrokerIsConnected(),this._brokerConnection.executions(e)):[]}async allExecutions(){return void 0===this._brokerConnection.allExecutions?[]:this._brokerConnection.allExecutions()}orderById(e){return this._makeSureBrokerIsConnected(),this._brokerConnection.orders().then((t=>t.find((t=>t.id===e))))}accountManagerInfo(){return this._brokerConnection.accountManagerInfo()}isTradable(e){return this._makeSureBrokerIsConnected(),this._brokerConnection.isTradable(e).then((t=>("object"!=typeof t&&(t={tradable:t}),t.tradable||void 0!==t.reason||(t.reason=(0,v.makeNonTradableSymbolText)((0,y.htmlEscape)(e),this._brokerMetainfo.title)),t)))}formatter(e,t=!0){return this._makeSureBrokerIsConnected(),this._formattersCache[e]||(this._formattersCache[e]=this._brokerConnection.formatter&&this._brokerConnection.formatter(e,t)||this._host.defaultFormatter(e,t)),(0,h.makeTimeLimited)(this._formattersCache[e],1e4,"formatter not received")}spreadFormatter(e){return this._makeSureBrokerIsConnected(),this._spreadFormattersCache[e]||(this._spreadFormattersCache[e]=this._brokerConnection.spreadFormatter&&this._brokerConnection.spreadFormatter(e)||this._host.defaultFormatter(e,!1)),(0,h.makeTimeLimited)(this._spreadFormattersCache[e],1e4,"spreadFormatter not received")}quantityFormatter(e){return this._makeSureBrokerIsConnected(),this._quantityFormattersCache[e]||(this._quantityFormattersCache[e]=this._brokerConnection.quantityFormatter&&this._brokerConnection.quantityFormatter(e)||this._host.quantityFormatter()),(0,h.makeTimeLimited)(this._quantityFormattersCache[e],1e4,"quantityFormatter not received")}async createInitialPreOrder(e){return this._createInitialPreOrder(e)}async createPlaceOrderContext(e,t=!0){const[i,r,s,o]=await Promise.all([this.symbolInfo(e.symbol),this.formatter(e.symbol),this.quotesSnapshot(e.symbol),this.getOrderDialogOptions(e.symbol)]),{configFlags:n}=this.metainfo(),a=(0,U.extractTakeProfitValidationRules)(this,e.symbol),l=(0,U.extractStopLossValidationRules)(this,e.symbol),c=new R({orderData:e,instrumentInfo:i,quotes:s,configFlags:n,formatter:r,isValidationEnabled:t,orderDialogOptions:o,tpValidationRules:a,slValidationRules:l,callbacks:{createInitialPreOrder:e=>this._createInitialPreOrder(e),placeOrder:(e,t)=>this._placeOrder(e,t),previewOrder:e=>this._previewOrder(e)}});return await c.onReady(),c}async createEditOrderContext(e){const t=new q({orderData:e,callbacks:{modifyOrder:this._modifyOrder.bind(this),metainfo:this.metainfo.bind(this),symbolInfo:this.symbolInfo.bind(this),orderById:this.orderById.bind(this)}});return await t.onReady(),t}placeOrder(e,t){return this._placeOrder(e,t)}previewOrder(e){return this._previewOrder(e)}modifyOrder(e,t){return this._modifyOrder(e,t)}cancelOrder(e){return H(e),this._makeSureBrokerIsConnected(),
this.processErrors(this._brokerConnection.cancelOrder(e),!0,r.t(null,void 0,i(915926)))}cancelOrders(e,t,s){return this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.cancelOrders(e,t,s),!0,r.t(null,void 0,i(305140)))}async closePosition(e,t){let i;H(e),this._makeSureBrokerIsConnected(),(0,c.assert)(void 0===t||!!this.config.supportPartialClosePosition,"Broker doesn`t support partial position closing");const r=new Promise((async(r,s)=>{try{const s=await this._positionCopyById(e);i=e=>{void 0!==s&&e.id===s.id&&e.symbol===s.symbol&&e.qty!==s.qty&&(this.positionUpdate.unsubscribe(this,i),r(!0))},this.positionUpdate.subscribe(this,i),await this._closePosition(e,t)}catch(e){s(e)}}));return(0,h.makeTimeLimited)(r,3e4,"Position closing timeout").catch((e=>(this._brokerLogger.logError(`${Q}: ${(0,v.getLoggerMessage)(e)}`),this.positionUpdate.unsubscribe(this,i),!1)))}async closeTrade(e,t){var s;H(e),this._makeSureBrokerIsConnected(),(0,c.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),(0,c.assert)(void 0===t||null!==(s=this.config.supportPartialCloseTrade)&&void 0!==s&&s,"Broker doesn`t support partial position closing");const o=(0,c.ensureDefined)(await this.tradeById(e));if(0===o.qty)return this._host.showNotification(r.t(null,void 0,i(791401)),r.t(null,void 0,i(715842)),0),!1;if(void 0===t||t<=Math.abs(o.qty)){if(this._brokerConnection.closeTrade){const i=S(null!=t?t:Math.abs(o.qty),o);return this.processErrors(this._brokerConnection.closeTrade(e,t),!0,Q,(()=>(0,c.ensureNotNull)(this._tradingStat).trackOrderPlaced(i)))}throw new Error("Method closeTrade is not implemented")}return this._host.showNotification(r.t(null,void 0,i(791401)),r.t(null,void 0,i(365389)),0),!1}reversePosition(e){if(H(e),this._makeSureBrokerIsConnected(),this.config.supportMultiposition&&!this.config.supportNativeReversePosition)throw new Error("Cannot reverse position on multiposition account");let t;const i=new Promise((async(i,r)=>{try{const r=await this._positionCopyById(e);t=e=>{void 0!==r&&e.symbol===r.symbol&&e.side!==r.side&&(this.positionUpdate.unsubscribe(this,t),i(!0))},this.positionUpdate.subscribe(this,t),await this._reversePosition(e)}catch(e){r(e)}}));return(0,h.makeTimeLimited)(i,3e4,"Position reversing timeout").catch((e=>(this._brokerLogger.logError(`${z}: ${(0,v.getLoggerMessage)(e)}`),this.positionUpdate.unsubscribe(this,t),!1)))}editPositionBrackets(e,t,s){if(this._makeSureBrokerIsConnected(),this._brokerConnection.editPositionBrackets)return this.processErrors(this._brokerConnection.editPositionBrackets(e,t,s),!0,r.t(null,void 0,i(140766)));throw new Error("Method editPositionBrackets is not implemented")}editTradeBrackets(e,t){if(this._makeSureBrokerIsConnected(),(0,c.assert)(!!this.config.supportTradeBrackets,"Broker doesn`t support brackets on trades"),this._brokerConnection.editTradeBrackets)return this.processErrors(this._brokerConnection.editTradeBrackets(e,t),!0,r.t(null,void 0,i(140766)));throw new Error("Method editTradeBrackets is not implemented")}
async subscribeRealtime(e,t){this._makeSureBrokerIsConnected();const i={symbol:e,listener:t,provider:0};this._realtimeSubscriptionState.push(i);const r=await this.symbolInfo(e),s=this._realtimeSubscriptionState.findIndex((i=>i.symbol===e&&i.listener===t));if(-1!==s)return void 0!==r.hasQuotes&&!1===r.hasQuotes?(this._realtimeSubscriptionState[s].provider=1,(0,c.ensure)(this._brokerRealtimeAdapter).subscribeRealtime(e,t)):(this._realtimeSubscriptionState[s].provider=2,this._addSubscription("Realtime",e,t))}async quotesSnapshot(e){let t,i;const r=(e,s)=>{i=s,(s.ask||s.bid)&&(this.unsubscribeRealtime(e,r),null==t||t(s))},s=new Promise((i=>{t=i,this.subscribeRealtime(e,r)}));try{return await(0,h.makeTimeLimited)(s,1e4,"quotesSnapshot not received")}catch(t){if(this.unsubscribeRealtime(e,r),void 0!==i)return i;throw t}}subscribeDOM(e,t){return this._makeSureBrokerIsConnected(),this._addSubscription("DOM",e,t)}subscribePipValue(e,t){return this._makeSureBrokerIsConnected(),this._addSubscription("PipValue",e,t)}subscribePL(e,t){this._makeSureBrokerIsConnected(),this._addSubscription("PL",e,t)}subscribeTradePL(e,t){return this._makeSureBrokerIsConnected(),this._addSubscription("TradePL",e,t)}subscribeCryptoBalance(e,t){return this._makeSureBrokerIsConnected(),this._addSubscription("CryptoBalance",e,t)}subscribeEquity(e){return this._makeSureBrokerIsConnected(),this._addSubscription("Equity","Equity",e)}subscribeMarginAvailable(e){return this._makeSureBrokerIsConnected(),this._addSubscription("MarginAvailable","MarginAvailable",e)}unsubscribeRealtime(e,t){const i=this._realtimeSubscriptionState.findIndex((i=>i.symbol===e&&i.listener===t));-1!==i&&(1===this._realtimeSubscriptionState[i].provider?(0,c.ensure)(this._brokerRealtimeAdapter).unsubscribeRealtime(e,t):this._removeSubscription("Realtime",e,t),this._realtimeSubscriptionState.splice(i,1))}unsubscribeDOM(e,t){this._removeSubscription("DOM",e,t)}unsubscribePipValue(e,t){this._removeSubscription("PipValue",e,t)}unsubscribePL(e,t){this._removeSubscription("PL",e,t)}unsubscribeTradePL(e,t){this._removeSubscription("TradePL",e,t)}unsubscribeCryptoBalance(e,t){this._removeSubscription("CryptoBalance",e,t)}unsubscribeEquity(e){this._removeSubscription("Equity","Equity",e)}unsubscribeMarginAvailable(e){this._removeSubscription("MarginAvailable","MarginAvailable",e)}async accountMetainfo(){const e=await this.accountsMetainfo(),t=this.currentAccount(),i=e.find((e=>e.id===t));if(void 0===i)throw new Error("accountMetainfo not received");return i}accountsMetainfo(){return(0,h.makeTimeLimited)(this._brokerConnection.accountsMetainfo(),1e4,"accountsMetainfo not received")}setCurrentAccount(e){if(void 0===this._brokerConnection.setCurrentAccount)throw new Error(`${this._brokerMetainfo.title} doesn't support sub-accounts`);this._brokerConnection.setCurrentAccount(e)}symbolInfo(e){return(0,h.makeTimeLimited)(this._brokerConnection.symbolInfo(e),1e4,"symbolInfo not received")}async getPositionCurrency(e){try{const t=await this._brokerConnection.symbolInfo(e)
;if(this._brokerMetainfo.configFlags.positionPLInInstrumentCurrency&&void 0!==t.currency)return t.currency;const i=await this.accountMetainfo();return(0,P.getCurrency)(i,!0)}catch(e){return void $.logError(e)}}sessionId(){return this._sessionId}bugReportInfo(){function e(e){return JSON.parse(JSON.stringify(e))}function t(e){if("object"!=typeof e)return e;if((0,a.isArray)(e))return e.map(t);const i={};for(const t in e)"object"!=typeof e[t]&&(i[t]=e[t]);return i}return Promise.all([this.orders(),this.positions(),this.config.supportTrades?this.trades():Promise.resolve([])]).then((i=>({activeBroker:this.metainfo().title,orders:t(e(i[0])),positions:t(e(i[1])),trades:t(e(i[2])),silentOrdersPlacement:this._host.silentOrdersPlacement().value(),floatingPanel:(0,c.ensureNotNull)(this._host.sellBuyButtonsVisibility()).value(),account:this.currentAccount(),accountType:this.currentAccountType(),lastUpdates:this._lastFireResult,time:Date.now(),brokerSpecific:this._brokerConnection.bugReportInfo?this._brokerConnection.bugReportInfo():null,sessionId:this._sessionId})))}processErrors(e,t,s,l){if(!(0,a.isPromise)(e))throw new Error("Broker incorrectly implements API, should return Promise");return e.then((e=>l&&l(e))).then((e=>"boolean"!=typeof e||e)).catch((e=>{if((0,o.isAbortError)((0,v.getErrorCauses)(e)[0]))return Promise.resolve(!1);let a="";return"string"==typeof e?a=e:"object"==typeof e&&"string"==typeof e.message&&(a=(0,y.removeTags)(e.message)),t&&n.enabled("trading_notifications")?(0!==a.length&&("."!==a.slice(-1)&&(a+="."),a+=" "),a+=r.t(null,void 0,i(352303)),this._host.showNotification(s||"",a,0)):$.logWarn(e),Promise.resolve(!1)})).then((e=>(this.tradingOperationFinished.fire(e),e)))}setDurations(e){this._brokerMetainfo.durations=e.slice()}setSymbolSearchId(e){this._brokerMetainfo.backendBrokerName=e}getRealtimeDataCheckParams(){return this._brokerConnection.getRealtimeDataCheckParams?this._brokerConnection.getRealtimeDataCheckParams():{}}getVerifyLiveAccountParams(){if(void 0===this._brokerConnection.getVerifyLiveAccountParams)throw new Error(`Method getVerifyLiveAccountParams for broker ${this._brokerMetainfo.id} is not implemented`);return this._brokerConnection.getVerifyLiveAccountParams()}unhideSymbolSearchGroups(){return this._brokerConnection.unhideSymbolSearchGroups?this._brokerConnection.unhideSymbolSearchGroups():[]}destroy(){void 0!==this._brokerConnection.destroy&&this._brokerConnection.destroy()}currentBroker(){return this._brokerMetainfo.id}async _createInitialPreOrder(e){var t,i,r;if(void 0===e.duration){const{allowedDurations:s}=await this.symbolInfo(e.symbol),{durations:o}=this.metainfo(),n=(0,P.getOrderDuration)({orderDuration:void 0,orderType:e.type,savedDuration:null!==(r=null===(i=null===(t=this._getTradingSettingsStorage)||void 0===t?void 0:t.call(this))||void 0===i?void 0:i.duration(e.symbol,e.type))&&void 0!==r?r:null,orderDurations:o,symbolDurations:s});null!==n&&(e.duration=n)}if(void 0===e.customFields){const t=await this._getSavedCustomFields(e.symbol,e.type);void 0!==t&&(e.customFields=t)}
return e}async _getSavedCustomFields(e,t){var i,r;const s=await this.getOrderDialogOptions(e),o=null!==(r=null===(i=this._getTradingSettingsStorage)||void 0===i?void 0:i.call(this))&&void 0!==r?r:void 0;if(void 0===o||void 0===(null==s?void 0:s.customFields)||0===s.customFields.length)return;const n=s.customFields.map((e=>e.id)),a=o.customFields(e,t,n),l=(0,P.adjustSavedCustomFieldsValues)(a,s);return 0!==Object.keys(l).length?l:void 0}_placeOrder(e,t){return this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.placeOrder(e,t),!0,r.t(null,void 0,i(842180)),(t=>{(0,c.ensureNotNull)(this._tradingStat).trackOrderPlaced({...e,id:t.orderId}),this._host.trackEvent("","SilentMode",this._host.silentOrdersPlacement().value()?"On":"Off")}))}async _modifyOrder(e,t){this._makeSureBrokerIsConnected();const s=new Set((await this._orders()).map((({id:e})=>e)));s.delete(e.id);return await this.processErrors(this._brokerConnection.modifyOrder(e,t),!0,r.t(null,void 0,i(54746)),(()=>(0,c.ensureNotNull)(this._tradingStat).trackOrderModified(e)))&&this._waitForOrderModification(e,s)}_previewOrder(e){if(!this._brokerConnection.previewOrder)throw new Error("Order preview is not supported");return this._brokerConnection.previewOrder(e)}_initializeConnectProtection(){let e=null;this.connectionStatusUpdate.subscribe(null,(t=>{if(e&&(clearTimeout(e),e=null),2===t){const t=(0,P.isOAuthAuthType)(this.config.authorizationType)?3e5:6e4;e=setTimeout((()=>{this._host.selectBroker(),this._host.showNotification(r.t(null,void 0,i(170891)),r.t(null,void 0,i(247956)))}),t)}}))}_fakeSubscribeDOM(e){this._fakeDOMSubscriptions[e]=(e,t)=>{const i=t.ask||t.trade,r=t.bid||t.trade,s={snapshot:!0,asks:i?[{price:i,volume:t.ask_size||1/0}]:[],bids:r?[{price:r,volume:t.bid_size||1/0}]:[]};this._host.domUpdate(e,s)},this.subscribeRealtime(e,this._fakeDOMSubscriptions[e])}_fakeUnsubscribeDOM(e){this.unsubscribeRealtime(e,this._fakeDOMSubscriptions[e])}_isMaintenance(){return isFeatureEnabled((0,P.makeMaintananceFeatureToggleName)(this._brokerMetainfo.id))}_isBrokerSideMaintenance(){return isFeatureEnabled((0,P.makeBrokerSideMaintananceFeatureToggleName)(this._brokerMetainfo.id))}async _positionCopyById(e){const t=await this.positionById(e);return void 0!==t?(0,s.default)(t):void 0}_patchBrokerSubscribeUnsubscribeDOMMethods(){const e=!this._brokerMetainfo.configFlags.supportLevel2Data;this._brokerConnection.subscribeDOM=e?e=>{this._fakeSubscribeDOM(e)}:this._originalDOMSubscriptionMethods.subscribeDOM,this._brokerConnection.unsubscribeDOM=e?e=>{this._fakeUnsubscribeDOM(e)}:this._originalDOMSubscriptionMethods.unsubscribeDOM}_patchMetainfo(e){const t=(0,f.deepCopy)(e);return t.configFlags.supportNativeReversePosition=!this.config.supportMultiposition||this.config.supportNativeReversePosition,t.configFlags.supportClosePosition=!0,t.configFlags.supportPLUpdate=!0,t}_addSubscription(e,t,i){this._pendingSubscriptions.push({brokerMethodName:e,symbol:t,listener:i});const r=this._lastFireResult[t]
;if(void 0!==r&&void 0!==r[e]&&null!==r[e]&&i(t,r[e].data),!this._removePendingSubscription({brokerMethodName:e,symbol:t,listener:i}))return;void 0===this._subscriptions[t]&&(this._subscriptions[t]={Realtime:[],PL:[],Equity:[],DOM:[],TradePL:[],PipValue:[],MarginAvailable:[],CryptoBalance:[]});const s=(0,c.ensure)(this._subscriptions[t]),o=s[e].length>0;if(s[e].push(i),!o&&(s[e].length>0||"CryptoBalance"===e)){const i="subscribe"+e;this._brokerConnection[i]&&this._brokerConnection[i](t)}}_removePendingSubscription(e){const t=this._pendingSubscriptions.findIndex((t=>t.symbol===e.symbol&&t.brokerMethodName===e.brokerMethodName&&t.listener===e.listener));return-1!==t&&(this._pendingSubscriptions.splice(t,1),!0)}_removeSubscription(e,t,i){if(this._removePendingSubscription({brokerMethodName:e,symbol:t,listener:i}))return;if(void 0===this._subscriptions[t])return;const r=(0,c.ensure)(this._subscriptions[t]),s=r[e].indexOf(i);if(s>-1&&r[e].splice(s,1),0===r[e].length){const i="unsubscribe"+e;this._brokerConnection[i]&&this._brokerConnection[i](t)}}_positions(){return this._positionsCache?this._positionsCache.getObjects():Promise.resolve([])}_trades(){return this._tradesCache?this._tradesCache.getObjects():Promise.resolve([])}_orders(){return this._ordersCache.getObjects()}_makeSureBrokerIsConnected(){(0,c.assert)(1===this.connectionStatus(),"Broker is not connected")}_placeReversePositionOrder(e){const t=S(2*e.qty,e);return this._placeOrder(t)}async _closePosition(e,t){const s=(0,c.ensureDefined)(await this.positionById(e));if(!(0,P.checkIsExistingPosition)(s)){const e=r.t(null,void 0,i(715842));throw this._host.showNotification(Q,e,0),new Error(e)}if(!(void 0===t||t<=Math.abs(s.qty))){const e=r.t(null,void 0,i(365389));throw this._host.showNotification(Q,e,0),new Error(e)}{const i=S(null!=t?t:Math.abs(s.qty),s);if(this.config.supportClosePosition&&this._brokerConnection.closePosition){if(!await this.processErrors(this._brokerConnection.closePosition(e,t),!0,Q,(()=>(0,c.ensureNotNull)(this._tradingStat).trackOrderPlaced(i))))throw new Error(Q)}else{if(!await this.processErrors(this._brokerConnection.placeOrder(i),!0,Q,(()=>(0,c.ensureNotNull)(this._tradingStat).trackOrderPlaced(i))))throw new Error(Q)}}}async _reversePosition(e){const t=(0,c.ensureDefined)(await this.positionById(e));if(0===t.qty){const e=r.t(null,void 0,i(726500));throw this._host.showNotification(z,e,0),new Error(e)}this.config.supportNativeReversePosition&&this._brokerConnection.reversePosition?await this.processErrors(this._brokerConnection.reversePosition(e),!0,z):await this.processErrors(this._placeReversePositionOrder(t),!0,z,(()=>(0,c.ensureNotNull)(this._tradingStat).trackOrderPlaced()))}async _waitForOrderModification(e,t){return new Promise((async i=>{const r=()=>{i(!0),o(),clearTimeout(n)},s=t=>{this._areOrdersEqual(t,e)&&r()},o=()=>this.orderUpdate.unsubscribe(this,s),n=setTimeout((()=>{i(!1),this._brokerLogger.logError("Failed to modify order: timeout waiting for new order"),o()}),3e4);this.orderUpdate.subscribe(this,s)
;for(const i of await this._orders())if(!t.has(i.id)&&this._areOrdersEqual(e,i))return void r()}))}_areOrdersEqual(e,t){const{checkBracketsAfterOrderModification:i}=this._brokerMetainfo.configFlags;return function(e,t){return e.type===t.type&&e.qty===t.qty&&e.limitPrice===t.limitPrice&&e.stopPrice===t.stopPrice}(e,t)&&(!i||function(e,t){return e.stopLoss===t.stopLoss&&e.takeProfit===t.takeProfit&&e.trailingStopPips===t.trailingStopPips}(e,t))}_updateConfigDependentProperties(){var e,t;const{supportPositions:i}=this._brokerMetainfo.configFlags;i?(null===(e=this._fakePositionUpdateDelegate)||void 0===e||e.destroy(),this._fakePositionUpdateDelegate=null):null!==(t=this._fakePositionUpdateDelegate)&&void 0!==t||(this._fakePositionUpdateDelegate=new l.Delegate)}}var G=i(960521),Z=i(870122),K=i.n(Z),J=i(650802),Y=i(673317),X=i(424030),ee=i(803966),te=i(382563),ie=i(815628),re=i(153055),se=i(156115),oe=i(252546),ne=i(120283),ae=i(314996),le=i(66786);class ce{constructor(e,t,i,r){this._lastPL=0,this._isActive=!1,this._realtimeUpdate=(e,t)=>{this._realtimeData=t,this._updatePL()},this._symbol=e.symbol,this._adapter=i,this._onPlUpdate=t,this._side=e.side,this._qty=e.qty,this._avgPrice=e.avgPrice||e.price,this._instrumentInfo=r,this.positionUpdate(e)}positionUpdate(e){this._avgPrice=e.avgPrice||e.price,this._qty=e.qty,this._side=e.side,this._updatePL()}lastPL(){return this._lastPL}start(){this._isActive||(this._adapter.subscribeRealtime(this._symbol,this._realtimeUpdate),this._isActive=!0)}stop(){this._isActive&&(this._adapter.unsubscribeRealtime(this._symbol,this._realtimeUpdate),this._isActive=!1)}_updatePL(){var e;if(!this._realtimeData||void 0===this._realtimeData.bid||void 0===this._realtimeData.ask)return;const t=Number(new G.Big(1===this._side?this._realtimeData.bid:this._realtimeData.ask).minus(Math.abs(this._avgPrice)).mul(1===this._side?1:-1).mul(this._qty).mul(null!==(e=this._instrumentInfo.lotSize)&&void 0!==e?e:1).div(this._instrumentInfo.pipSize).mul(this._instrumentInfo.pipValue));this._lastPL=t,this._onPlUpdate(t)}}new Set(["type","typespecs","pricescale","minmov","fractional"]);function de(e,t){return(0,te.getQuoteSessionInstance)("full").snapshot(e)}function ue(e){return"error"===e.status}class he{constructor(e,t,i,r){var s;this._setDefaultDropdownActionsBound=this._setDefaultDropdownActions.bind(this),this._qtyChangedSubscriptions=new Map,this.serverLogger=()=>this._serverLogger,this.orderPartialUpdate=(e,t)=>{this._adapter.onOrderPartialUpdate(e,t)},this.positionPartialUpdate=(e,t)=>{this._adapter.onPositionPartialUpdate(e,t)},this.tradePartialUpdate=(e,t)=>{this._adapter.onTradePartialUpdate(e,t)},this.createMapperAsync=(e,t)=>({tvToBroker:async e=>e,brokerToTv:async e=>e}),this.createMapperSync=(e,t)=>{let i=null;{const e=Promise.resolve();i={ready:()=>e,tvToBroker:e=>e,brokerToTv:e=>e}}return i},this._trading=e,this._metainfo=t,this._serverLogger=null!==i?this._makeServerLoggerWithFilledInfo(i):null,this._setDefaultDropdownActionsBound=this._setDefaultDropdownActions.bind(this),
this._defaultDropdownActions=!0,this._credentialsStorage=r,this._setDefaultDropdownActions(),null!==this._trading&&(null===(s=this.sellBuyButtonsVisibility())||void 0===s||s.subscribe(this._setDefaultDropdownActionsBound),(0,c.ensureNotNull)(this.orderPanelVisibility()).subscribe(this._setDefaultDropdownActionsBound),(0,c.ensureNotNull)(this.domPanelVisibility()).subscribe(this._setDefaultDropdownActionsBound))}createPLEmitter(e,t,i){return new ce(e,t,this._adapter,i)}getLogger(){return(0,u.getLogger)("Trading."+this._metainfo.id)}translate(e){return e}setBrokerConnectionAdapter(e){this._adapter=e}patchConfig(e){this._adapter.patchConfig(e)}showOrderDialog(e,t){return(0,c.ensureNotNull)(this._trading).orderViewController().showOrderView({order:e,focus:t})}showPositionBracketsDialog(e,t,i){return(0,c.ensureNotNull)(this._trading).orderViewController().showPositionView(e,t,i)}showCancelOrderDialog(e,t){return ne.ConfirmOrderCancelDialog.get().open(e).then((e=>{e&&this._adapter.processErrors(t(),!0,r.t(null,void 0,i(915926)))}))}showCancelMultipleOrdersDialog(e,t,s,o){return ne.ConfirmOrderCancelDialog.get().multiple(e,t,s).then((e=>{e&&this._adapter.processErrors(o(),!0,r.t(null,void 0,i(305140)))}))}showCancelBracketsDialog(e,t){return ae.ConfirmBracketsCancelDialog.get().open(e).then((e=>{e&&this._adapter.processErrors(t(),!0,r.t(null,void 0,i(951099)))}))}showCancelMultipleBracketsDialog(e,t){return ae.ConfirmBracketsCancelDialog.get().multiple(e).then((e=>{e&&this._adapter.processErrors(t(),!0,r.t(null,void 0,i(951099)))}))}showReversePositionDialog(e,t){return(0,le.reversePositionDialog)(e,(0,c.ensureNotNull)(this._trading).showErrorNotification,t)}showMessageDialog(e,t,i=!1){i?(0,re.showWarning)({title:e,html:t}):(0,re.showWarning)({title:e,text:t})}showConfirmDialog(e,t,i,r,s){return(0,se.showConfirmDialog)({title:e,content:t,mainButtonText:i,cancelButtonText:r,showDisableConfirmationsCheckbox:s})}showSimpleConfirmDialog(e,t,i,r,s){return(0,oe.showSimpleConfirmDialog)({title:e,text:Array.isArray(t)?t.join(" "):t,mainButtonText:i,mainButtonIntent:"primary",cancelButtonText:r,showDisableConfirmationsCheckbox:s})}showSimpleConfirmDialogAndRespectAbort(e,t,i,r,s,o){return(0,oe.showSimpleConfirmDialog)({title:e,text:Array.isArray(t)?t.join(" "):t,abortSignal:i,mainButtonText:r,mainButtonIntent:"primary",cancelButtonText:s,showDisableConfirmationsCheckbox:o})}setDurations(e){this._adapter.setDurations(e)}setSymbolSearchId(e){this._adapter.setSymbolSearchId(e)}activateBottomWidget(){return null!==this._trading?this._trading.toggleTradingWidget():Promise.reject("Activate bottom widget failed: trading is not defined")}bottomWidgetMode(){if(null===this._trading)throw new Error("Unable to provide bottom widget mode: trading is not defined");return this._trading.bottomWidgetBarMode()}trackEvent(e,t,i){null!==this._trading&&this._trading.trackEvent(e,t,i)}defaultFormatter(e,t){return(0,te.getQuoteSessionInstance)("simple").formatter(e,t)}numericFormatter(e){return Promise.resolve(new X.NumericFormatter(e))}
quantityFormatter(e){return Promise.resolve(new ee.QuantityFormatter(e))}selectBroker(){null!==this._trading&&this._trading.selectBroker(null)}showTradingProperties(){null!==this._trading&&this._trading.showTradingProperties()}async getSymbolTypespecs(e){var t;const i=await de(e);return"values"in i?ue(i)||void 0===i.values.typespecs?[]:i.values.typespecs:null!==(t=i.typespecs)&&void 0!==t?t:[]}async getSymbolType(e){var t;const i=await de(e);return"values"in i?ue(i)?"undefined":i.values.type:null!==(t=i.type)&&void 0!==t?t:"undefined"}async getSymbolMinTick(e){const t=await de(e);return"values"in t?ue(t)||void 0===t.values.minmov||void 0===t.values.pricescale?1:(0,G.Big)(t.values.minmov).div(t.values.pricescale).toNumber():(0,G.Big)(t.minmov).div(t.pricescale).toNumber()}silentOrdersPlacement(){return(0,c.ensureNotNull)(this._trading).noConfirmEnabled}sellBuyButtonsVisibility(){return null!==this._trading&&n.enabled("buy_sell_buttons")?this._trading.showSellBuyButtons:null}domPanelVisibility(){return null!==this._trading?this._trading.domPanelVisibility():null}orderPanelVisibility(){return null!==this._trading?this._trading.orderPanelVisibility():null}showPricesWithZeroVolume(){return(0,c.ensureNotNull)(this._trading).showPricesWith().zeroVolume}showNotification(e,t,i=0){null!==this._trading&&(0===i?this._trading.showErrorNotification(e,t):this._trading.showSuccessNotification(e,t))}connectionStatusUpdate(e,t){this._adapter.connectionStatusUpdate.fire(e,t),1===e&&this._setDefaultDropdownActions()}orderUpdate(e){this._adapter.onOrderUpdate(e)}positionUpdate(e,t){this._adapter.onPositionUpdate(e,t)}tradeUpdate(e,t){this._adapter.onTradeUpdate(e,t)}executionUpdate(e){this._adapter.executionUpdate.fire(e)}currentAccountUpdate(){this._adapter.onCurrentAccountChanged()}realtimeUpdate(e,t){this._adapter.fireSubscription("Realtime",e,t)}domUpdate(e,t){this._adapter.fireSubscription("DOM",e,t)}pipValueUpdate(e,t){this._adapter.fireSubscription("PipValue",e,t)}setQty(e,t){(0,c.ensureNotNull)(this._trading).getQtySuggester().setQty(e,t)}getQty(e){return(0,c.ensureNotNull)(this._trading).getQtySuggester().getQty(e)}subscribeSuggestedQtyChange(e,t){var i;const r=null!==(i=this._qtyChangedSubscriptions.get(e))&&void 0!==i?i:new Map;if(r.has(t))return;this._qtyChangedSubscriptions.has(e)||this._qtyChangedSubscriptions.set(e,r);const s=(0,c.ensureNotNull)(this._trading).getQtySuggester().suggestedQtyChanged(e);r.set(t,s.subscribe(t))}unsubscribeSuggestedQtyChange(e,t){const i=this._qtyChangedSubscriptions.get(e);if(void 0===i)return;const r=i.get(t);void 0!==r&&(r.unsubscribe(),i.delete(t),0===i.size&&this._qtyChangedSubscriptions.delete(e))}plUpdate(e,t){this._adapter.fireSubscription("PL",e,t)}tradePLUpdate(e,t){this._adapter.fireSubscription("TradePL",e,t)}equityUpdate(e){this._adapter.fireSubscription("Equity","Equity",e)}marginAvailableUpdate(e){this._adapter.fireSubscription("MarginAvailable","MarginAvailable",e)}cryptoBalanceUpdate(e,t){this._adapter.fireSubscription("CryptoBalance",e,t)}setButtonDropdownActions(e){var t
;null!==this._trading&&this._defaultDropdownActions&&(this._defaultDropdownActions=!1,null===(t=this.sellBuyButtonsVisibility())||void 0===t||t.unsubscribe(this._setDefaultDropdownActionsBound),(0,c.ensureNotNull)(this.orderPanelVisibility()).unsubscribe(this._setDefaultDropdownActionsBound),(0,c.ensureNotNull)(this.domPanelVisibility()).unsubscribe(this._setDefaultDropdownActionsBound)),this._buttonDropdownActions=e}buttonDropdownActions(){return this._buttonDropdownActions}defaultContextMenuActions(...e){return null!==this._trading?this._trading.defaultContextMenuActions(...e):Promise.resolve([])}defaultDropdownMenuActions(e){return null!==this._trading?this._trading.defaultDropdownMenuActions(e):[]}get factory(){return{createDelegate:()=>new l.Delegate,createWatchedValue:e=>new J.WatchedValue(e),createPriceFormatter:(e,t,i,r,s)=>new ie.PriceFormatter(e,t,i,r,s)}}get settings(){return{save:(e,t)=>K().setJSON(`${this._metainfo.id}.${e}`,t),load:(e,t)=>K().getJSON(`${this._metainfo.id}.${e}`,t),clear:(e,t)=>K().remove(`${this._metainfo.id}.${e}`,t)}}get credentialsStorage(){return this._credentialsStorage}convertTimezone(e,t,i){const r=Y.get_timezone(t),s=Y.get_timezone(i),o=Y.cal_to_utc(r,e);return Y.utc_to_cal(s,o)}language(){return window.language}getUserSpecificHash(){return window.user.private_channel||""}activateFXCMCFD(){K().setValue("fxcm_cfd",!0)}async isFractional(e){var t;const i=await de(e);return"values"in i?!ue(i)&&void 0!==i.values.fractional&&i.values.fractional:null!==(t=i.fractional)&&void 0!==t&&t}_makeServerLoggerWithFilledInfo(e){return{log:t=>e.log({...this._makeServerLoggerEventAdditionalInfo(),...t}),debounceLog:(t,i,r)=>e.debounceLog({...this._makeServerLoggerEventAdditionalInfo(),...t},i,r)}}_makeServerLoggerEventAdditionalInfo(){return{accountType:this._adapter.currentAccountType(),brokerId:this._adapter.metainfo().id,sessionId:this._adapter.sessionId(),tvUsername:window.user.username,ref:location.href,online:navigator.onLine,platform:(0,P.getPlatform)()}}_setDefaultDropdownActions(){null!==this._trading&&this._defaultDropdownActions&&(this._buttonDropdownActions=this.defaultDropdownMenuActions())}}var pe=i(340794);const me=(0,u.getLogger)("Trading.EncryptedWebStorage");class _e{constructor({prefix:e,storageName:t,storage:i,cryptographer:r}){this._transientStorage={},this._handleStorageStateChange=e=>{const{key:t,storageArea:i}=e;i===this._persistentStorage&&this._storageName===t&&this._decryptStorage()},this._storageName=t,this._prefix=null==e?void 0:e.toLowerCase(),this._persistentStorage=i,this._cryptographer=r,this._decryptStorage=(0,pe.sequentialize)(this._decryptStorage),window.addEventListener("storage",this._handleStorageStateChange)}async setItem(e,t){const i=this._addPrefix(e);this._transientStorage[i]=JSON.stringify(t);try{await this._encryptStorageAndSave()}catch(e){me.logError(`Unable to save value using key ${i}: ${(0,v.getLoggerMessage)(e)}`)}}getItem(e,t=null){const i=this._transientStorage[this._addPrefix(e)];if(void 0===i)return t;if("string"!=typeof i)return i;try{
return JSON.parse(i)}catch(e){return i}}async removeItem(e){delete this._transientStorage[this._addPrefix(e)],await this._encryptStorageAndSave()}destroy(){window.removeEventListener("storage",this._handleStorageStateChange)}static async create(e,t,i,r){const s=new _e({prefix:e,storageName:t,storage:i,cryptographer:r});return await s._decryptStorage(),s}_addPrefix(e){return void 0!==this._prefix?`${this._prefix}.${e}`:e}async _decryptStorage(){const e=this._persistentStorage.getItem(this._storageName);if(null===e)return void(this._transientStorage={});const t=await this._cryptographer.decrypt(e);if(null===t)return this._persistentStorage.removeItem(this._storageName),void(this._transientStorage={});try{this._transientStorage=JSON.parse(t)}catch(e){this._transientStorage={}}}async _encryptStorageAndSave(){const e=await this._cryptographer.encrypt(JSON.stringify(this._transientStorage));this._persistentStorage.setItem(this._storageName,e)}}const ge="credentials-storage";class be{constructor(e,t,i){this._rememberCredentials=e,this._encryptedLocalStorage=t,this._encryptedSessionStorage=i}async save(e,t){this._currentEncryptedStorage().setItem(e,t)}load(e,t){return this._currentEncryptedStorage().getItem(e,t)}async clear(e){this._currentEncryptedStorage().removeItem(e)}destroy(){this._encryptedLocalStorage.destroy(),this._encryptedSessionStorage.destroy()}static async create(e,t,i){const r=await _e.create(e,ge,localStorage,i),s=await _e.create(e,ge,sessionStorage,i);return new be(t,r,s)}_currentEncryptedStorage(){return this._rememberCredentials.value()?this._encryptedLocalStorage:this._encryptedSessionStorage}}var ve=i(34694);const ye={isSuspended:!1,supportDemoLiveSwitcher:!0,supportModifyOrderPrice:!0,supportEditAmount:!0,supportModifyBrackets:!0,supportMarketBrackets:!0,supportMarketOrders:!0,supportStopOrders:!0,supportLimitOrders:!0,supportLeverageButton:!0,supportStopLimitOrders:!1,supportPositions:!0,supportDOM:!0,supportModifyTrailingStop:!0,supportAddBracketsToExistingOrder:!0,supportVerifyLiveAccount:!0,supportReversePosition:!0,showNotificationsLog:!0,supportPLUpdate:!0,supportTwoFactorAuthorization:!1,supportDisplayBrokerNameInSymbolSearch:!0,supportCurrencyInOrderPreview:!0,supportRiskControls:!0,checkBracketsAfterOrderModification:!0};class fe{constructor(e){this._settingsKey=`trading.${e}.rememberCredentials`}value(){return K().getBool(this._settingsKey,!0)}setValue(e){K().setValue(this._settingsKey,e)}}const ke=[];function Pe(e,t){var i;e.configFlags=(i=e.configFlags,Object.assign({},ye,i)),ke.push({metainfo:e,createBrokerFunction:t})}function Se(e){const{launchCountriesByFeatureToggle:t,metainfo:i,createBrokerFunction:r}=e;(function(e){var t;return!1;for(const i of Object.keys(e))if(isFeatureEnabled(i)&&(null===(t=e[i])||void 0===t?void 0:t.includes(window.countryCode)))return!0;return!1})(t)&&Pe(i,r)}function Ce(){return ke.map((e=>e.metainfo))}let we;async function Be(e,t,i,r,s){const o=ke.filter((e=>e.metainfo.id===t))[0];let n;if(null===r){const i=await be.create(t,new fe(t),we),r=s=>{
(null==s?void 0:s.metainfo().id)!==t&&(null==e||e.onBrokerChange.unsubscribe(null,r),i.destroy())};null==e||e.onBrokerChange.subscribe(null,r),n=i}else n=r;const a=new he(e,o.metainfo,i,n);try{const t=await o.createBrokerFunction(a,null==e?void 0:e.brokerTelemetry),i=new ve.BrokerRealtimeAdapter(o.metainfo.id);return new j({brokerMetainfo:o.metainfo,brokerConnection:t,host:a,brokerRealtimeAdapter:i,tradingStat:e&&e.tradingStat(),tradingSettingsStorageGetter:e&&e.getBrokerTradingSettingsStorage,brokerPlan:s})}catch(e){return Promise.reject(`${t} broker creation error: ${(0,v.getLoggerMessage)(e)}`)}}function Te(e){return Ce().filter((t=>t.id===e))[0]}we={encrypt:async e=>e,decrypt:async e=>e}},768819:(e,t,i)=>{"use strict";i.d(t,{DialogVisibility:()=>o});var r=i(947488),s=i(218286);class o{constructor(){this._value$=new r.BehaviorSubject({isVisible:!1}),this.value$=this._value$.asObservable().pipe((0,s.distinctUntilChanged)(((e,t)=>e.isVisible===t.isVisible&&e.isFullScreen===t.isFullScreen)))}getValue(){return this._value$.getValue()}setValue(e){this._value$.next(e)}}},948776:(e,t,i)=>{"use strict";i.d(t,{DisabledConfirmations:()=>u});var r=i(870122),s=i.n(r),o=i(855385),n=i.n(o),a=i(322625);const l=/[0-9]+([\.,][0-9]+)*([\.,][0-9]+)?|\.[0-9]+/gm,c=/[A-Z]+/gm,d=a.settingsKeys.DISABLED_CONFIRMATIONS;class u{add(e){const t=this._getAll(),i=this._makeMessageHash(e);t.add(i),s().setJSON(d,Array.from(t))}has(e){const t=this._getAll(),i=this._makeMessageHash(e);return t.has(i)}clear(){s().remove(d)}_getAll(){return new Set(s().getJSON(d))}_makeMessageHash(e){const t=e.replace(l,"").replace(c,"");return i=n()(t),btoa(String.fromCharCode.apply(null,new Uint8Array(i)));var i}}},998018:(e,t,i)=>{"use strict";function r(e){return"string"==typeof e?e:Array.isArray(e)?e.join(""):void 0}i.d(t,{makeConfirmation:()=>r})},156115:(e,t,i)=>{"use strict";i.d(t,{showConfirmDialog:()=>n});var r=i(509806),s=i(998018),o=i(948776);async function n(e){const{title:t,content:n,mainButtonText:a,cancelButtonText:l,showDisableConfirmationsCheckbox:c,onOpen:d,onClose:u}=e,h=new o.DisabledConfirmations,p=(0,s.makeConfirmation)(n);if(c&&void 0!==p&&h.has(p))return!0;const{ConfirmDialogRenderer:m}=await Promise.all([i.e(580),i.e(8194),i.e(6639),i.e(4215),i.e(3610),i.e(3717),i.e(1956),i.e(1309),i.e(3566)]).then(i.bind(i,537954)),_=new m(h),g={title:t,message:n,closeButton:null!=l?l:r.t(null,void 0,i(606255)),confirmButton:null!=a?a:r.t(null,void 0,i(879831)),showDisableConfirmationsCheckbox:c,onOpen:d,onClose:u};return(await _.open(g)).status}},252546:(e,t,i)=>{"use strict";i.d(t,{showSimpleConfirmDialog:()=>o});var r=i(148442),s=i(948776);async function o(e){const{showDisableConfirmationsCheckbox:t,text:o,onConfirm:n,onClose:a,onCancel:l,abortSignal:c}=e,d=new s.DisabledConfirmations;if(t&&d.has(o))return Promise.resolve(!0);if(null==c?void 0:c.aborted)return Promise.resolve(!1)
;const[{showSimpleDialog:u},{SimpleConfirmDialog:h}]=await Promise.all([Promise.all([i.e(580),i.e(8194),i.e(6639),i.e(4215),i.e(3610),i.e(3717),i.e(1956),i.e(1309),i.e(3566)]).then(i.bind(i,480994)),Promise.all([i.e(580),i.e(8194),i.e(6639),i.e(4215),i.e(3610),i.e(3717),i.e(1956),i.e(1309),i.e(3566)]).then(i.bind(i,210795))]);return new Promise(((t,i)=>{if(null==c?void 0:c.aborted)return void i((0,r.createAbortError)());const s=u({...e,disabledConfirmations:d,onConfirm:e=>{t(!0),void 0!==n&&n(),e.dialogClose()},onClose:()=>{t(!1),void 0!==a&&a()},onCancel:e=>{t(!1),void 0!==l&&l(e),e.dialogClose()}},h);null==c||c.addEventListener("abort",(()=>{s(),i((0,r.createAbortError)())}),{once:!0})}))}},314996:(e,t,i)=>{"use strict";i.d(t,{ConfirmBracketsCancelDialog:()=>o});var r=i(509806),s=i(252546);const o={get(){return this},open:e=>(0,s.showSimpleConfirmDialog)({title:r.t(null,void 0,i(232668)),text:r.t(null,void 0,i(289302)).replace("{orderId}",""!==e?e+" ":""),mainButtonIntent:"primary"}),multiple:e=>(0,s.showSimpleConfirmDialog)({title:r.t(null,void 0,i(232668)),text:r.t(null,void 0,i(915610)).replace("{orderId}",""!==e?e+" ":""),mainButtonIntent:"primary"})}},120283:(e,t,i)=>{"use strict";i.d(t,{ConfirmOrderCancelDialog:()=>o});i(336379);var r=i(509806),s=i(252546);const o={get(){return this},open:e=>(0,s.showSimpleConfirmDialog)({title:r.t(null,void 0,i(709498)),text:r.t(null,void 0,i(438540)).replace("{orderId}",e),mainButtonIntent:"primary"}),multiple(e,t,o){let n=e;if(void 0!==t){n=`${n} ${1===t?r.t(null,void 0,i(864351)):r.t(null,void 0,i(807889))}`}return(0,s.showSimpleConfirmDialog)({title:r.t(null,void 0,i(709498)),text:r.t(null,void 0,i(109886)).replace("{qty}",String(o)).replace("{side}",n),mainButtonIntent:"primary"})}}},66786:(e,t,i)=>{"use strict";i.d(t,{reversePositionDialog:()=>o});var r=i(509806),s=i(252546);async function o(e,t,o,n){if(!await(0,s.showSimpleConfirmDialog)({title:r.t(null,void 0,i(172361)).replace("{positionId}",e),text:r.t(null,void 0,i(492698)).replace("{positionId}",e)+(n?" "+r.t(null,void 0,i(893827)):""),mainButtonText:r.t(null,void 0,i(920848)),mainButtonIntent:"primary",cancelButtonText:r.t(null,void 0,i(620036)),showBackdrop:!0}))return!1;try{return await o()}catch(e){return t(r.t(null,void 0,i(945593)),function(e){let t="";null!==e&&"object"==typeof e&&e.message?t=e.message:"string"==typeof e&&(t=e);return t}(e)),!1}}},795820:(e,t,i)=>{"use strict";i.d(t,{HeaderContainer:()=>A,mountHeader:()=>V,unmountHeader:()=>R});var r=i(50959),s=i(500962),o=i(32133),n=i(72571),a=i(661851),l=i(509806),c=i(930052),d=i(518799),u=i(395907),h=i(996038),p=i(311757);var m=i(958057),_=i(363111),g=i(497754),b=i.n(g),v=i(75577),y=i(476853),f=i(2537);function k(e){const{icon:t,iconClassName:i,title:s,titleColor:o,text:a,solutionId:l}=e;return r.createElement(d.ToolWidgetMenu,{arrow:!1,content:r.createElement(n.Icon,{icon:t}),className:b()(f.icon,f.button,i),drawerBreakpoint:v.TradingLayoutBreakpoint.Mobile,title:s,horizontalAttachEdge:y.HorizontalAttachEdge.Right,
horizontalDropDirection:y.HorizontalDropDirection.FromRightToLeft},r.createElement("div",{className:f.wrapper},r.createElement(n.Icon,{icon:t,className:b()(f.icon,i)}),r.createElement("div",{className:f.infoContainer},r.createElement("span",{className:f.title,style:{color:o}},s),r.createElement("span",{className:f.text},a),false)))}var P=i(643959),S=i(966883),C=i(513729),w=i(29834),B=i(512646),T=i(552828),E=i(867838);const O=l.t(null,void 0,i(348836));function D(e){const{settingsItems:t,title:s,description:o,symbol:a,hasDelayedWarning:g,hasBatsQuotes:b,informerMessage:v,back:y,close:f,cancel:D}=e;let I;if(g&&(I={icon:B,iconClassName:E.delayedDataIcon,title:l.t(null,void 0,i(675649)),titleColor:E.delayedDataTitleColor,text:O}),b){const[e,t]=a.split(":"),i=`${m.batsToRealtimeHtml1.replace("{symbolName}",t).replace("{exchange}",m.notAccurateCboeTooltip)} ${m.batsToRealtimeHtml2WithExchange.replace("{exchange}",e)}`;I={icon:T,iconClassName:E.batsQuotesIcon,title:(0,p.htmlEscape)(m.exchangeByOriginalExchangeTooltip).format({exchange:e,originalExchange:m.notAccurateCboeTooltip}),titleColor:E.batsQuotesTitleColor,text:i,solutionId:43000473924}}const L=r.useContext(_.Context).mode===_.OrderEditorDisplayMode.Popup?{"data-dragg-area":!0}:{};return r.createElement("div",{className:E.header},void 0!==y&&r.createElement(u.ToolWidgetIconButton,{title:l.t(null,void 0,i(762592)),onClick:y,className:E.button,"data-name":"button-back",icon:P}),r.createElement("div",{className:E.wrapper,...L},r.createElement("span",{className:E.text},s,o&&`, ${o}`),(void 0!==v||void 0!==I)&&r.createElement("div",{className:E.statusLine},void 0!==v&&r.createElement(TradingInformer,{informerMessage:v}),void 0!==I&&r.createElement(k,{...I}))),void 0!==D&&r.createElement(u.ToolWidgetIconButton,{title:l.t(null,void 0,i(620036)),onClick:D,className:E.button,"data-name":"button-cancel",icon:S}),0!==r.Children.count(t)&&r.createElement(c.MatchMedia,{rule:h.DialogBreakpoints.TabletSmall},(e=>r.createElement(d.ToolWidgetMenu,{className:E.settingsButton,content:r.createElement(n.Icon,{icon:w}),menuClassName:E.settingsPopupMenu,children:t,isDrawer:e,title:l.t(null,void 0,i(389517)),arrow:!1,closeOnClickOutside:!0,"data-name":"order-ticket-settings"}))),void 0!==f&&r.createElement(u.ToolWidgetIconButton,{title:l.t(null,{context:"input"},i(309633)),onClick:f,className:E.button,"data-name":"button-close",icon:C}))}var I=i(379266),L=i(192063),x=i(623549);function N(e){const{label:t,value$:i,onClick:s}=e,o=(0,a.useObservableWithImmediatelyEmittedInitialValue)(i);return r.createElement(I.PopupMenuItemToggle,{labelClassName:x.checkBoxWrapper,label:t,isChecked:!!o,onClick:s})}function M(e){const{onIcon:t,offIcon:i,onLabel:s,offLabel:o,value$:l,onClick:c}=e,d=(0,a.useObservableWithImmediatelyEmittedInitialValue)(l);return r.createElement(L.PopupMenuItem,{onClick:c,label:r.createElement("div",{className:x.toggleContentWrapper},r.createElement(n.Icon,{icon:d?t:i}),r.createElement("span",null,d?s:o))})}function A(e){
const{title$:t,description$:i,backFunction$:s,closeFunction$:n,cancelFunction$:l,informerMessage$:c,symbol$:d,hasBatsQuotes$:u,hasDelayedQuotes$:h,isTradable$:p,settings$:m}=e,_=(0,a.useObservableWithImmediatelyEmittedInitialValue)(t),g=(0,a.useObservableWithImmediatelyEmittedInitialValue)(i),b=(0,a.useObservableWithImmediatelyEmittedInitialValue)(s),v=(0,a.useObservableWithImmediatelyEmittedInitialValue)(n),y=(0,a.useObservableWithImmediatelyEmittedInitialValue)(l),f=(0,a.useObservableWithImmediatelyEmittedInitialValue)(d),k=(0,a.useObservableWithImmediatelyEmittedInitialValue)(u),P=(0,a.useObservableWithImmediatelyEmittedInitialValue)(h),S=(0,a.useObservableWithImmediatelyEmittedInitialValue)(p),C=((0,a.useObservableWithImmediatelyEmittedInitialValue)(c),(0,a.useObservableWithImmediatelyEmittedInitialValue)(m)),w=(0,r.useMemo)((()=>void 0!==C&&S?C.map((e=>0===e.settingType?r.createElement(N,{key:e.label,...e}):r.createElement(M,{key:e.onLabel,...e}))):null),[C,S]),B=(0,r.useMemo)((()=>void 0!==v?()=>{(0,o.trackEvent)("GUI","Close Order Panel from panel"),v()}:void 0),[v]),T=(0,r.useMemo)((()=>void 0!==y?()=>{(0,o.trackEvent)("GUI","Reset Order Panel"),y()}:void 0),[y]);return r.createElement(D,{title:_||"",description:g,symbol:null!=f?f:"",settingsItems:w,hasDelayedWarning:P,hasBatsQuotes:k,isTradable:S,informerMessage:void 0,back:b,close:B,cancel:T})}function V(e,t){s.render(r.createElement(A,{...t}),e)}function R(e){s.unmountComponentAtNode(e)}},529719:(e,t,i)=>{"use strict";i.d(t,{alignQuotesToMinTick:()=>B,calculatePipValue:()=>v,calculateTradeValue:()=>y,calculateTradeValueByBigPointValue:()=>f,calculateUsedMargin:()=>k,calculatedMarginRatio:()=>P,checkPriceByOrderType:()=>T,comparator:()=>_,convertToBaseMonetaryUnit:()=>I,createCustomFieldModels:()=>O,displayedLeverage:()=>b,formatInfoValue:()=>S,formatRiskReward:()=>w,formatValue:()=>L,makeSubjectFromWatchedValue:()=>m,prepareCalculatorEventText:()=>E,prepareTradableSolution:()=>D,shouldShowTotal:()=>g});var r=i(509806),s=i(688401),o=i(947488),n=i(960521),a=i(466052),l=i(650802),c=i(372605),d=i(793361),u=i(357407),h=i(600297),p=i(807107);function m(e){const t=new o.BehaviorSubject(e.value()),i=e=>{t.next(e)};return e.subscribe(i),{subject:t,unsubscribe:()=>e.unsubscribe(i)}}function _(e,t){return(0,c.deepEquals)(e,t)[0]}function g(e){return void 0!==e&&Boolean(e.showTotal)}function b(e,t){if(void 0!==e)return e;if(void 0!==t){const e=Math.round(1/t);return String(e)+":1"}return null}function v(e,t,i){return null!==e?(void 0!==i?e*i:e)*t:0}function y(e,t,i,r,s){return f(e,t,i/r,s)}function f(e,t,i,r){return e*t*i*(r||1)}function k(e,t){return void 0!==t?e*t:0}function P(e,t){const i=0!==t?100*e/t:0;return i>100?100:i}function S(e){if("number"==typeof e){const t=(0,d.splitThousands)((e||0).toFixed(2)," ");return Number.isInteger(e)||e>=1?t:function(e){if(Number.isInteger(e))return e+"";return e<1?function(e){const t=(e+"").split(".")[1]||"";let i=t.length;for(let e=0;e<t.length;e++)if("0"!==t[e]){i=e+1;break}return e.toFixed(i)}(e):e.toFixed(2)}(e)}return(0,
d.splitThousands)(e," ")}const C=new u.VolumeFormatter(2);function w(e,t){return null!==e&&null!==t&&e/t>0?C.format(e/t):""}function B(e,t,i){const r=Object.assign({},e);return["trade","ask","bid"].forEach((e=>{const s=r[e];if(void 0!==s){const o=(0,p.getMinTick)({minTick:t,price:s,variableMinTickData:i});r[e]=function(e,t){return t>1?e:(0,n.Big)(e).div(t).round(0,1).mul(t).toNumber()}(s,o)}})),r}function T(e,t,i){return 4===e?null===t||null===i:3===e?null===i:null===t}function E(e,t){switch(t){case h.ButtonType.IncDec:return e<0?"-":"+";case h.ButtonType.PlusValue:return String(e);case h.ButtonType.Clear:return"Clear";default:return"Default"}}function O(e,t,i,r,s){const o=[];return void 0!==r&&Array.isArray(r.customFields)&&r.customFields.forEach((r=>{if("TextWithCheckBox"===r.inputType){const e=new l.WatchedValue(r.value.text),i=new l.WatchedValue(!0),s=new l.WatchedValue,n=r.validator,c=e=>{const t=void 0===n?{valid:!0}:n(e);i.setValue(t.valid),s.setValue(t.valid?void 0:t.errorMessage)};void 0!==n&&e.subscribe(c),o.push({id:r.id,type:r.inputType,inputType:r.customInfo.asterix?"password":"text",placeholder:r.placeHolder||"",title:r.title||"",checkboxTitle:r.customInfo.checkboxTitle,text:e,checked:new l.WatchedValue(r.value.checked),status:t,onControlFocused:new a.Delegate,isValid:i,errorMessage:s,destroy:()=>{e.unsubscribe(c)}})}if("Checkbox"===r.inputType){let i;const n=null==s?void 0:s[r.id];try{i=JSON.parse(n)}catch(e){i=n}o.push({id:r.id,type:r.inputType,title:r.title,help:r.help,checked:new l.WatchedValue(null!=i?i:r.value),status:t,onControlFocused:new a.Delegate,disabled:e&&!r.supportModify,saveToSettings:r.saveToSettings,isValid:new l.WatchedValue(!0),errorMessage:new l.WatchedValue,destroy:()=>{}})}if("ComboBox"===r.inputType&&Array.isArray(r.items)){let t=r.items[0];if(s&&r.id in s){const e=s[r.id],i=r.items.find((t=>t.value===e));void 0!==i&&(t=i)}else r.forceUserEnterInitialValue&&!e&&(t=void 0);o.push({id:r.id,type:r.inputType,title:r.title,items:r.preventModify&&e&&t?[t]:r.items,selectedItem:new l.WatchedValue(null==t?void 0:t.value),onControlFocused:new a.Delegate,saveToSettings:r.saveToSettings,isRequired:Boolean(r.forceUserEnterInitialValue),alwaysShowAttachedErrors:i,isValid:new l.WatchedValue(!0),errorMessage:new l.WatchedValue,destroy:()=>{}})}})),o}async function D(e,t){if(void 0===e.solutions)return;if("changeSymbol"in e.solutions){const t=e.solutions.changeSymbol;return{title:r.t(null,void 0,i(562030)),apply:()=>s.linking.symbol.setValue(t)}}if("changeAccount"in e.solutions){const s=e.solutions.changeAccount,o=(await t.accountsMetainfo()).filter((e=>e.id===s))[0].name;return{title:r.t(null,void 0,i(134542)).replace("{accountName}",o),apply:()=>t.setCurrentAccount(s)}}const o=e.solutions.openUrl.url;return{title:e.solutions.openUrl.text,apply:()=>window.open(o,"_blank")}}function I(e,t){return void 0===t?e:(0,n.Big)(e).div(t).toNumber()}function L(e,t){if(null===e)return null;const i=t.format(e);if(t.parse){const e=t.parse(i);if(e.res)return e.value}return parseFloat(i)}},864348:(e,t,i)=>{
"use strict";var r,s;function o(e){return(null==e?void 0:e.type)===s.PlaceOrder}i.d(t,{PlaceOrEditContextStatus:()=>r,PlaceOrEditContextType:()=>s,isContextPlaceOrderContext:()=>o}),function(e){e[e.Undefined=0]="Undefined",e[e.Loading=1]="Loading",e[e.Error=2]="Error"}(r||(r={})),function(e){e[e.PlaceOrder=0]="PlaceOrder",e[e.EditOrder=1]="EditOrder",e[e.EditPosition=2]="EditPosition",e[e.EditTrade=3]="EditTrade"}(s||(s={}))},690839:(e,t,i)=>{"use strict";i.d(t,{OrdersService:()=>m,cropOrderData:()=>p,isBracketOrderRawData:()=>u});var r=i(650151),s=i(466052),o=i(372605),n=i(6835),a=i(481853),l=i(481330),c=i(397728);const d=(0,n.getLogger)("Trading.OrderService");function u(e){return"parentId"in e&&void 0!==e.parentId&&"parentType"in e&&void 0!==e.parentType}function h(e){return 1===e.type?(0,r.ensureDefined)(e.limitPrice):(0,r.ensureDefined)(e.stopPrice)}function p(e){return{id:e.id,parentId:e.parentId,parentType:e.parentType,symbol:e.symbol,type:e.type,side:e.side,avgPrice:e.avgPrice,limitPrice:e.limitPrice,stopPrice:e.stopPrice,price:e.price,stopLoss:e.stopLoss,trailingStopPips:e.trailingStopPips,stopType:e.stopType,takeProfit:e.takeProfit,status:e.status,qty:e.qty}}class m extends a.BrokerService{constructor(){super(...arguments),this._existingOrdersIds=new Set,this._activeOrders=new Map,this._activeOrderUpdate=new s.Delegate,this._activeOrdersRemoved=new s.Delegate,this._ordersRejected=new s.Delegate}destroy(){this.stopService()}async getCurrency(){const e=(0,r.ensureNotNull)(this.activeBroker()),t=await e.accountMetainfo();return(0,l.getCurrency)(t,!0)||"USD"}orders(){return(0,r.ensureNotNull)(this.activeBroker()).orders()}find(e){return this._activeOrders.get(e)||null}activeOrders(){return Array.from(this._activeOrders.values())}activeOrdersUpdated(){return this._activeOrderUpdate}activeOrdersRemoved(){return this._activeOrdersRemoved}orderRejected(){return this._ordersRejected}stopService(){this._clearOrders();(0,r.ensureNotNull)(this.activeBroker()).orderUpdate.unsubscribeAll(this)}startService(){this._clearOrders(),this._requestOrders()}_clearOrders(){const e=Array.from(this._activeOrders.keys());this._activeOrders.clear(),this._existingOrdersIds.clear(),e.length>0&&d.logNormal(`All orders removed, id's: ${e}`),this._activeOrdersRemoved.fire(e)}async _requestOrders(){const e=this.activeBroker();if(!e)return;const t=await e.orders();for(const e of t)this._addActiveOrder(e);e.orderUpdate.unsubscribeAll(this),e.orderUpdate.subscribe(this,this._addActiveOrder)}_addActiveOrder(e){this._logOrderUpdate(e);const t=e.id,i=this._activeOrders.has(t),r=5===e.status,s=6!==e.status&&3!==e.status,o=2===e.type;if(i){if(s||o)return this._activeOrders.delete(t),void this._activeOrdersRemoved.fire([t])}else{if(o||s&&!r)return;if(r)return void this._ordersRejected.fire(h(e))}const n=this._getOrderData(e);this._activeOrders.set(t,n),this._activeOrderUpdate.fire(n)}_logOrderUpdate(e){const t=e.id;let i="update";this._existingOrdersIds.has(t)||(i="add",this._existingOrdersIds.add(t)),function(e,t){t(JSON.stringify(p(e)))}(e,(e=>{
d.logNormal(`Order ${i}: ${e}`)}))}_getOrderData(e){const t=h(e);(0,o.isNumber)(t)||d.logError("order price is not defined");const i=(0,r.ensureNotNull)(this.activeBroker()).metainfo().configFlags,s=Boolean(i.supportOrderBrackets&&i.supportModifyBrackets&&i.supportAddBracketsToExistingOrder);return(0,o.merge)((0,o.clone)(e),{price:t,considerFilledQty:!0,supportModify:(0,l.isModifyOrderSupported)(e,i),supportMove:(0,l.isMoveOrderSupported)(e,i),supportCancel:!0,supportBrackets:s,supportModifyOrderPrice:Boolean(i.supportModifyOrderPrice),supportTrailingStop:s&&(0,c.checkTrailingStopAvailability)(i)})}}},583705:(e,t,i)=>{"use strict";i.d(t,{PositionsService:()=>h,PositionsUpdateType:()=>d,cropPositionData:()=>u});var r=i(650151),s=i(466052),o=i(372605),n=i(6835),a=i(481853),l=i(397728);const c=(0,n.getLogger)("Trading.PositionService");var d;function u(e){const t=e;return{id:t.id,symbol:t.symbol,side:t.side,avgPrice:t.avgPrice,pl:t.pl,price:t.price,qtyBySide:t.qtyBySide,stopType:t.stopType,takeProfit:t.takeProfit,stopLoss:t.stopLoss,trailingStopPips:t.trailingStopPips}}!function(e){e[e.Full=0]="Full",e[e.Partial=1]="Partial"}(d||(d={}));class h extends a.BrokerService{constructor(){super(...arguments),this._existingPositionIds=new Set,this._positions=new Map,this._positionUpdate=new s.Delegate,this._positionsRemoved=new s.Delegate,this._displayMode=1,this._updatePositionPLHandler=this._updatePositionPL.bind(this)}destroy(){this.stopService()}positions(){return Array.from(this._positions.values())}find(e){return this._positions.get(e)||null}async realIdFromBroker(e){const t=(0,r.ensureNotNull)(this.activeBroker());if(1===this._displayMode){const i=await t.positionById(e);if(void 0!==i)return i.id}else{const i=await t.tradeById(e);if(void 0!==i)return i.id}return null}positionUpdate(){return this._positionUpdate}positionsRemoved(){return this._positionsRemoved}isDisplayModeTrades(){return 0===this._displayMode}async getCurrency(e){return await(0,r.ensureNotNull)(this.activeBroker()).getPositionCurrency(e)||""}stopService(){this._clearPositions();const e=(0,r.ensureNotNull)(this.activeBroker());this.isDisplayModeTrades()?e.tradeUpdate.unsubscribeAll(this):e.positionUpdate.unsubscribeAll(this)}startService(){this._clearPositions(),this._displayMode=function(e){if(null===e)return 1;const t=e.metainfo().configFlags;return t.supportTrades?t.supportPositionBrackets?1:t.supportCloseTrade?0:1:1}(this.activeBroker()),this._requestPositions()}_clearPositions(){const e=(0,r.ensureNotNull)(this.activeBroker()),t=Array.from(this._positions.keys());for(const i of t)this.isDisplayModeTrades()?e.unsubscribeTradePL(i,this._updatePositionPLHandler):e.unsubscribePL(i,this._updatePositionPLHandler);this._positions.clear(),this._existingPositionIds.clear(),t.length>0&&c.logNormal(`All positions removed, id's: ${t}`),this._positionsRemoved.fire(t)}async _requestPositions(){const e=this.activeBroker();if(!e)return;const t=this.isDisplayModeTrades(),i=await(t?e.trades():e.positions());for(const e of i)this._addPosition(e)
;t?e.tradeUpdate.subscribe(this,this._addPosition):e.positionUpdate.subscribe(this,this._addPosition)}_addPosition(e){const t=e.id,i=this._positions.has(t),s=(0,r.ensureNotNull)(this.activeBroker()),o=this.isDisplayModeTrades();if(!e.qty)return i&&(o?s.unsubscribeTradePL(t,this._updatePositionPLHandler):s.unsubscribePL(t,this._updatePositionPLHandler),this._positions.delete(t),this._positionsRemoved.fire([t])),void this._logPositionUpdate(e,!0);const n=this._getPositionData(e),a=this._updateType(n);this._logPositionUpdate(n,a===d.Full),this._positions.set(t,n),this._firePositionUpdate(n,a),i||(o?s.subscribeTradePL(t,this._updatePositionPLHandler):s.subscribePL(t,this._updatePositionPLHandler))}_updatePositionPL(e,t){const i=(0,r.ensureDefined)(this._positions.get(e));i.pl=(0,o.isNumber)(t)?t:null,i.profitState=(0,l.profitStateByPL)(t),this._firePositionUpdate(i,d.Partial)}_getPositionData(e){var t,i;const s=(0,r.ensureNotNull)(this.activeBroker()).metainfo().configFlags,o=this._positions.get(e.id),n=this.isDisplayModeTrades(),a=Boolean(n?s.supportTradeBrackets:s.supportPositionBrackets);let c,d="neutral",u=!1,h=null;if(n){const t=e;c=t.price,u=Boolean(t.canBeClosed)}else{const r=e;c=r.avgPrice,h=null!==(i=null!==(t=r.pl)&&void 0!==t?t:null==o?void 0:o.pl)&&void 0!==i?i:null,null!==h&&(d=(0,l.profitStateByPL)(h))}return{...e,pl:h,plBasedOnLast:s.calculatePLUsingLast||!1,price:Math.abs((0,r.ensureDefined)(c)),qtyBySide:Math.abs(e.qty)*(1===e.side?1:-1),profitState:d,supportClose:Boolean(n?s.supportCloseTrade&&u:s.supportClosePosition),supportReverse:Boolean(!n&&s.supportReversePosition),supportBrackets:a,supportOnlyPairBrackets:Boolean(s.supportOnlyPairPositionBrackets),supportTrailingStop:a&&(0,l.checkTrailingStopAvailability)(s)}}_firePositionUpdate(e,t){this._positionUpdate.fire({data:e,type:t})}_updateType(e){const t=this._positions.get(e.id);if(void 0===t)return d.Full;for(const i of Object.keys(t)){const r=i;if("pl"!==r&&"unrealizedPl"!==r&&t[r]!==e[r])return d.Full}return d.Partial}_logPositionUpdate(e,t){if(!t)return;const i=e.id;let r="update";this._existingPositionIds.has(i)||(r="add",this._existingPositionIds.add(i)),function(e,t){t(JSON.stringify(u(e)))}(e,(e=>{c.logNormal(`Position  ${r}: ${e}`)}))}}},397728:(e,t,i)=>{"use strict";i.d(t,{checkTrailingStopAvailability:()=>r,profitStateByPL:()=>s});function r(e){return Boolean(e.supportTrailingStop&&e.supportAddBracketsToExistingOrder&&e.supportModifyTrailingStop&&false)}function s(e){const t=null===e?0:Math.round(100*e)/100;return t>0?"positive":t<0?"negative":"neutral"}},75577:(e,t,i)=>{"use strict";i.d(t,{TradingLayoutBreakpoint:()=>s});var r=i(312282);const s={Mobile:r.mobile}},290341:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Trading:()=>wi,showSellBuyButtonsDefault:()=>Si});var r=i(650151),s=i(509806),o=i(870122),n=i(376202),a=i(180185),l=i(69111),c=i(6835),d=i(650802);const u=i.p+"alarm_clock.ba219c712b5dce956b08.mp3",h=(0,c.getLogger)("Lib.Sound",{color:"#dea433"}),p="notification/notification",m=[{title:s.t(null,void 0,i(792586)),path:"alert/alarm_clock",
soundForAlerts:!0,filePath:u}];const _={};function g(){return m.filter((e=>!!e.soundForAlerts))}function b(e){if((0,l.isOnMobileAppPage)("any"))return;if(!e)return;if(!/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi/i.test(window.navigator.userAgent))return;if(Array.isArray(e)||(e=[e]),0===(e=e.filter((e=>{const t=v(e);return!(!t||!t.el.load||t._mobilePreloadActive)&&(t._mobilePreloadActive=!0,!0)}))).length)return void h.logNormal("enableForMobile no sounds passed");const t=()=>{const r=[];Array.isArray(e)&&e.forEach((e=>{const t=v(e);t.el.load();const i=t.play().catch((e=>{if("AbortError"!==e.name)throw h.logError(`enableForMobile for "${t.el.src}" preload error: - ${e.message}`),e}));t.el.pause(),r.push(i)})),Promise.all(r).then((()=>{h.logNormal("enableForMobile sounds initialized")})),i.forEach((e=>{document.removeEventListener(e,t,!0)}))},i=["click","touchend","keydown"];i.forEach((e=>{document.addEventListener(e,t,!0)}))}const v=e=>{if(e in _)return _[e];h.logNormal(`requested sound  ${e} not cached, building a new audio element`);const t=m.find((t=>t.path===e));if(void 0===t)throw new Error(`Cannot find sound "${e}"`);const i=new Audio(t.filePath),r={el:i,playing:new d.WatchedValue(!1),play:(t=0)=>r.playing.value()?(h.logNormal("sound already playing"),Promise.reject("already playing")):(r.playing.setValue(!0),new Promise(((i,s)=>{let o=t>0;const n=()=>{const t=function(e){try{h.logNormal(`"${e.el.src}" triggering html5 play method, readyState - ${e.el.readyState}; muted - ${e.el.muted}; volume - ${e.el.volume}; currentTime - ${e.el.currentTime}`);let t=e.el.play();return t||(t=Promise.resolve()),t}catch(t){return h.logError(`play method for "${e.el.src}" catch error - ${t.message}`),Promise.reject(t)}}(r);t.catch((t=>{h.logNormal(`stop counting sound "${e}"; as playing due to an error: ${t.message}`),r.stop(),s(t)}))};r._onEnded=()=>{o?n():(r.stop(),i())},r.el.addEventListener("ended",r._onEnded),o&&setTimeout((()=>{h.logNormal(`"${e}" repeat timeout - ${t}s off`),o=!1}),1e3*t),n()}))),stop:(e=!1)=>{r.el.pause(),e&&(r.el.currentTime=0),r.playing.setValue(!1),r._onEnded&&r.el.removeEventListener("ended",r._onEnded)}};_[e]=r;return["canplaythrough","error"].forEach((t=>{i.addEventListener(t,(()=>{h.logNormal(`for sound "${e}", event - ${t} is fired`)}),!1)})),h.logNormal(`canPlayType - ${i.canPlayType("audio/mp3")}`),_[e]};b(m.filter((e=>!!e.common)).map((e=>e.path)));var y=i(150335),f=i(947488),k=i(323002),P=i(997345),S=i(586639),C=i(275734),w=i(757604),B=i(958261),T=i(114501),E=i(839874),O=i(196573),D=i(423869),I=i(656846),L=i(481330),x=i(391664),N=i(807107),M=i(637401),A=i(350299),V=i(340794),R=i(156963),F=i(330012),W=i(144273),q=i(466052),U=i(642469);var $=i(148442),Q=i(768819),z=i(758094),H=i(824777),j=i(322625),G=i(34694),Z=i(511990);const K=(0,c.getLogger)("Trading.RealtimeProvider");class J{constructor(e){this._results={},this._getter=e}get(e){return this._results[e]||(this._results[e]=this._getter(e)),this._results[e]}}class Y{constructor(e){this._stopped=!1,this._subscribed=!1,
this._provider=null,this._formatters=null;const{symbol:t,callback:i,providersCache:r,formattersCache:s,subscriptionType:o,actualSymbolGetter:n}=e;this._symbol=t,this._subscriptionType=o,this._callback=i,this._providersCache=r,this._formattersCache=s,this._getActualSymbol=n,"Realtime"===this._subscriptionType?this._handler=(e,t)=>{this._stopped||i(e,t,this._formatters)}:this._handler=(e,t)=>{this._stopped||i(e,t)},this._start().catch((e=>{}))}symbol(){return this._symbol}type(){return this._subscriptionType}callback(){return this._callback}destroy(){this._ensureNotStopped(),this._subscribed&&void 0!==this._actualSymbol&&("Realtime"===this._subscriptionType?(0,r.ensureNotNull)(this._provider).unsubscribeRealtime(this._actualSymbol,this._handler):(0,r.ensureNotNull)(this._provider).unsubscribeDOM(this._actualSymbol,this._handler)),this._stopped=!0}async _start(){const{symbol:e}=await this._getActualSymbol(this._symbol);this._ensureNotStopped(),this._provider=await this._providersCache.get(e),this._ensureNotStopped(),this._formatters=await this._formattersCache.get(e),(0,r.ensure)(this._formatters),this._ensureNotStopped(),this._actualSymbol=e,this._subscribed=!0,"Realtime"===this._subscriptionType?this._provider.subscribeRealtime(e,this._handler):this._provider.subscribeDOM(e,this._handler)}_ensureNotStopped(){(0,r.assert)(!this._stopped,"Should not be stopped")}}class X{constructor(e,t,i,r){this.onStatusChanged=new q.Delegate,this._subscriptions=[],this._currentBroker=null,this._activeBrokerGetter=e,this._actualSymbolGetter=r,t.subscribe(this,this._connectionStatusChanged),i.subscribe(this,this._connectionStatusChanged),this._tvProvider=new G.BrokerRealtimeAdapter("RealtimeProvider"),this._connectionStatusChanged()}isTradable(e){return this._tradableCache.get(e)}subscribeRealtime(e,t){this._subscriptions.some((i=>i.symbol()===e&&i.callback()===t&&"Realtime"===i.type()))||this._subscriptions.push(new Y({symbol:e,callback:t,providersCache:this._providersCache,formattersCache:this._formattersCache,subscriptionType:"Realtime",actualSymbolGetter:this._actualSymbolGetter}))}unsubscribeRealtime(e,t){const i=this._subscriptions.findIndex((i=>i.symbol()===e&&i.callback()===t&&"Realtime"===i.type()));if(-1===i)return;this._subscriptions[i].destroy(),this._subscriptions.splice(i,1)}subscribeDOM(e,t){this._subscriptions.some((i=>i.symbol()===e&&i.callback()===t&&"DOM"===i.type()))||this._subscriptions.push(new Y({symbol:e,callback:t,providersCache:this._providersCache,formattersCache:this._formattersCache,subscriptionType:"DOM",actualSymbolGetter:this._actualSymbolGetter}))}unsubscribeDOM(e,t){const i=this._subscriptions.findIndex((i=>i.symbol()===e&&i.callback()===t&&"DOM"===i.type()));if(-1===i)return void K.logWarn("Subscription not found");this._subscriptions[i].destroy(),this._subscriptions.splice(i,1)}formatter(e){return this._formattersCache.get(e).then((e=>e.formatter))}spreadFormatter(e){return this._formattersCache.get(e).then((e=>e.spreadFormatter))}quantityFormatter(e){
return this._formattersCache.get(e).then((e=>e.quantityFormatter))}symbolInfo(e){if(!e){const e={minTick:NaN,qty:{min:NaN,max:NaN,step:NaN},pipValue:NaN,pipSize:NaN,description:"no symbol"};return Promise.resolve(e)}return this._providersCache.get(e).then((t=>t!==this._tvProvider?t.symbolInfo(e).then((t=>t||this._tvProvider.symbolInfo(e))).catch((t=>this._tvProvider.symbolInfo(e))):this._tvProvider.symbolInfo(e)))}quotesSnapshot(e){return this._providersCache.get(e).then((t=>t.quotesSnapshot(e)))}activeBroker(){return null!==this._currentBroker&&this._currentBroker!==this._tvProvider?this._currentBroker:null}_isTradable(e){if(null===this._currentBroker||this._currentBroker===this._tvProvider)return Promise.resolve({tradable:!1});try{return(0,Z.makeTimeLimited)(this._currentBroker.isTradable(e),6e4,"isTradable Promise Timeout").catch((()=>Promise.resolve({tradable:!1})))}catch(e){return Promise.resolve({tradable:!1})}}_haveRealtime(e){return this._tradableCache.get(e)||Promise.resolve(null===this._currentBroker)}_connectionStatusChanged(){const e=this._activeBrokerGetter(),t=this._currentBroker,i=e&&1===e.connectionStatus()?e:null;if(this._createCaches(),t!==i){const e=this._subscriptions.map((e=>({symbol:e.symbol(),callback:e.callback(),type:e.type()})));this._unsubscribeAll(),this._currentBroker=i,this._subscribeAll(e),this.onStatusChanged.fire()}}_createCaches(){this._providersCache=new J((e=>this._provider(e))),this._tradableCache=new J((e=>this._isTradable(e))),this._formattersCache=new J((e=>this._providersCache.get(e).then((t=>Promise.all([t.formatter(e,!1),t.spreadFormatter(e),t.quantityFormatter(e)]))).then((([e,t,i])=>({formatter:e,spreadFormatter:t,quantityFormatter:i})))))}_provider(e){return R.enabled("enable_dom_data_for_untradable_symbols")?Promise.resolve(this._currentBroker||this._tvProvider):this._haveRealtime(e).then((e=>e.tradable&&this._currentBroker&&1===this._currentBroker.connectionStatus()?this._currentBroker:this._tvProvider))}_unsubscribeAll(){this._subscriptions.forEach((e=>{e.destroy()})),this._subscriptions=[]}_subscribeAll(e){e.forEach((e=>{this._subscriptions.push(new Y({symbol:e.symbol,callback:e.callback,providersCache:this._providersCache,formattersCache:this._formattersCache,subscriptionType:e.type,actualSymbolGetter:this._actualSymbolGetter}))}))}}var ee=i(481853);class te extends ee.BrokerService{constructor(e){super(e),this._userId=(window.user.id||"").toString(),window.loginStateChange&&window.loginStateChange.subscribe(this,this._onLoginStateChange)}trackOrderPlaced(e){this._trackOrderEvent("Placed",e)}trackOrderModified(e){this._trackOrderEvent("Modified",e)}startService(){(0,r.ensure)(this.activeBroker()).orderUpdate.subscribe(this,this._orderUpdate),this._trackTradingBrokerConnnected()}stopService(){(0,r.ensure)(this.activeBroker()).orderUpdate.unsubscribe(this,this._orderUpdate)}_orderUpdate(e,t){t||(5===e.status?this._trackOrderEvent("Rejected",e):2===e.status?this._trackOrderEvent("Executed",e):1===e.status&&this._trackOrderEvent("Canceled",e))}
async _trackOrderEvent(e,t){var i;const r=this.trading().linking().value(),s=this.activeBroker();if(void 0===t||null===s)return;const o=await s.symbolInfo(t.symbol),n=t.qty*(o.lotSize||1),a="Placed"===e&&void 0!==r.continuous&&r.symbol===t.symbol?"continuous":o.type,l={amount:n,orderId:t.id,instrumentType:a,eventName:"Order "+e,userId:this._userId,symbol:t.symbol,currency:null!==(i=o.currency)&&void 0!==i?i:null};this._trackTradingOrder(l)}_trackTradingOrder(e){const t=this.activeBroker();if(!t)throw new Error("no active broker")}_trackTradingBrokerConnnected(){const e=this.activeBroker();null!==e&&e.metainfo().id;if(!e)throw new Error("no active broker")}_onLoginStateChange(){this._userId=(window.user.id||"").toString()}}var ie=i(863697),re=i(106056),se=i(32133);function oe(e="default"){switch(e){case"danger":return ie.ToastIntent.Danger;case"attention":return ie.ToastIntent.Warning;case"success":return ie.ToastIntent.Success;default:return ie.ToastIntent.Default}}class ne{constructor(e){this._chartWidgetCollection=e}showTradingProperties(){this._chartWidgetCollection.activeChartWidget.value().showGeneralChartProperties(U.TabNames.trading)}async closeAllNotifications(){const e=await this._chartWidgetCollection.getToasts();null!==e&&e.reset()}async showNotification(e,t,i,r){const s=await this._chartWidgetCollection.getToasts();if(null===s)return;let o="";"string"==typeof t&&(o=t),s.showSimpleToast({text:o,time:r,title:e,intent:oe(i),priority:re.ToastPriority.Low})}showMaintenance(e){0}showBrokerSideMaintenance(e){0}trackEvent(e,t,i){!async function(e,t,i){(0,se.trackEvent)(e,t,i)}(e,t,i)}showReplayConfirmationDialog(){return Promise.resolve()}reconnectChartApi(e){0}setBroker(e){const t=(null==e?void 0:e.metainfo().backendBrokerName)||(null==e?void 0:e.metainfo().id.toLowerCase())||"";this._chartWidgetCollection.setBroker(t)}}var ae=i(282729),le=(i(336379),i(156115));async function ce(e){const{showErrorNotification:t,handler:r,message:o,onOpen:n,onClose:a}=e;if(!await(0,le.showConfirmDialog)({title:s.t(null,void 0,i(424356)),content:o,mainButtonText:s.t(null,void 0,i(424356)),cancelButtonText:s.t(null,void 0,i(620036)),onOpen:n,onClose:a}))return!1;try{return await r()}catch(e){return t(s.t(null,void 0,i(791401)),function(e){let t="";null!==e&&"object"==typeof e&&e.message?t=e.message:"string"==typeof e&&(t=e);return t}(e)),!1}}var de=i(66786),ue=i(120283),he=i(314996);i(651049),i(702054),i(529719),i(627687),i(816105);async function pe(e,t,r){const o=await async function(e){const{PartiallyClosingDialogRenderer:t}=await i.e(3168).then(i.bind(i,531570)),r=new t;return new Promise((t=>{r.open({...e,dialogActionHandler:t})}))}(e);if(!o.status)return!1;try{return await t(o.qty)}catch(e){return r(s.t(null,void 0,i(791401)),function(e){let t="";null!==e&&"object"==typeof e&&e.message?t=e.message:"string"==typeof e&&(t=e);return t}(e)),!1}}var me=i(252546);const _e={async show(e){const t=s.t(null,{replace:{symbol:e}},i(97929)),r=s.t(null,{replace:{symbol:e}},i(469497));return(0,me.showSimpleConfirmDialog)({title:r,text:t})}
},ge={async show(e){const t=s.t(null,{replace:{symbol:e}},i(965603)),r=s.t(null,{replace:{symbol:e}},i(447600));return(0,me.showSimpleConfirmDialog)({title:r,text:t})}};var be=i(50959),ve=i(793361);function ye(e){const{symbol:t,side:r,qty:o,price:n,id:a,closePositionCancelsOrders:l}=e,c=(0,ve.splitThousands)(o," "),d=(0,ve.splitThousands)(n," ");return be.createElement(be.Fragment,null,be.createElement("div",null,void 0!==a?s.t(null,void 0,i(170392)).replace("{id}",a):s.t(null,void 0,i(381617))),be.createElement("div",null,be.createElement("b",null,t)),be.createElement("div",null,be.createElement("b",null,`${r} ${c} @ ${d}`)),be.createElement("div",null,l&&` ${s.t(null,void 0,i(218329))}`))}var fe=i(484095);const ke=(0,c.getLogger)("Trading.BrokerCommandsUI"),Pe={symbol:1,qty:1,side:1,type:1,seenPrice:1};class Se{constructor({activeBroker:e,guiAccessor:t,noConfirmEnabled:i,orderViewController:r,showErrorNotification:s,trackEvent:o,tradingLinking:n}){this._closePositionDialogVisibility=new Q.DialogVisibility,this._isClosePositionDialogLoading=!1,this._isCloseTradeDialogLoading=!1,this._onClosePositionDialogOpen=e=>{this._closePositionDialogVisibility.setValue({isVisible:!0,isFullScreen:e})},this._onClosePositionDialogClose=()=>{this._closePositionDialogVisibility.setValue({isVisible:!1})},this._tradingLinking=n,this._activeBroker=e,this._guiAccessor=t,this._orderViewController=r,this._showErrorNotification=s,this._noConfirmEnabled=i,this._trackEvent=o,this.closePositionDialogVisibility=this._closePositionDialogVisibility.value$}async placeOrder(e,t,i){const r=t&&this._noConfirmEnabled.value(),s=this._guiAccessor&&r?this._guiAccessor.showReplayConfirmationDialog():Promise.resolve(!1);try{await s}catch(e){Promise.resolve(!1)}const o=await this._activeBroker.isTradable(e.symbol);if(r&&o.tradable&&function(e){for(const t in Pe)if(!(t in e))return!1;return!0}(e)){false;const t=await this._activeBroker.createInitialPreOrder(e);return this._activeBroker.placeOrder(t)}{const t=this._activeBroker.metainfo();if(t.customUI&&void 0!==t.customUI.showOrderDialog)return t.customUI.showOrderDialog(e)}return this._orderViewController().then((t=>this._activeBroker?t.showOrderView({order:e,focus:void 0,forceOrderDialog:i}):Promise.reject("Broker connection adapter is null")))}async modifyOrder(e,t,i,r){return t&&this._noConfirmEnabled.value()&&e.parentType,this._modifyOrder(e,t,i,r)}async closePosition(e){var t,i;if(this._makeSureBrokerIsConnected(),this._isClosePositionDialogLoading)return!1;let r,s;this._isClosePositionDialogLoading=!0;try{if(r=await this._activeBroker.positionById(e),void 0===r)return!1;const{tradable:t}=await this._activeBroker.isTradable(r.symbol);if(await this._assertPositionExistsAndNotClosed(r.id),!t)return this._closePositionForNonTradableSymbol(r);if(this._noConfirmEnabled.value())return this._activeBroker.closePosition(e);s=await this._obtainPositionClosingData(r)}finally{this._isClosePositionDialogLoading=!1}if(void 0===s)return!1;const{supportPartialClosePosition:o,...n}=s,a=this._activeBroker.metainfo()
;if(void 0!==(null===(t=a.customUI)||void 0===t?void 0:t.showClosePositionDialog))return null===(i=a.customUI)||void 0===i?void 0:i.showClosePositionDialog(r);if(o){const t=t=>(t!==(null==r?void 0:r.qty)?this._trackEvent("","Close Position Dialog","partial"):this._trackEvent("","Close Position Dialog","full"),this._activeBroker.closePosition(e,t));return pe({...n,positionOrTrade:r,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose},t,this._showErrorNotification)}{const t=()=>this._activeBroker.closePosition(e);return ce({showErrorNotification:this._showErrorNotification,handler:t,message:s.message,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose})}}async closeTrade(e){if(this._makeSureBrokerIsConnected(),(0,r.assert)(!!this._activeBroker.config.supportTrades,"Broker doesn`t support trades"),this._noConfirmEnabled.value())return this._activeBroker.closeTrade(e);{if(this._isCloseTradeDialogLoading)return!1;const t=await this._obtainTradeClosingData(e);if(void 0===t)return!1;const{supportPartialCloseTrade:i,trade:r,...s}=t;if(i){const t=async t=>(t!==r.qty?this._trackEvent("","Close Trade Dialog","partial"):this._trackEvent("","Close Trade Dialog","full"),this._activeBroker.closeTrade(e,t));return pe({...s,positionOrTrade:r,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose},t,this._showErrorNotification)}return ce({showErrorNotification:this._showErrorNotification,handler:()=>this._activeBroker.closeTrade(e),message:t.message,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose})}}editPositionBrackets(e,t,i,s){return this._makeSureBrokerIsConnected(),(0,r.assert)(!!this._activeBroker.config.supportPositionBrackets,"Broker doesn`t support brackets on positions"),s&&this._noConfirmEnabled.value()?this._activeBroker.editPositionBrackets(e,null!=t?t:{}):this._activeBroker.positionById(e).then((e=>this._activeBroker?this._showPositionDialog((0,r.ensureDefined)(e),t,i):Promise.reject("Broker connection adapter is null")))}editTradeBrackets(e,t,i,s){return s&&this._noConfirmEnabled.value()?this._activeBroker.editTradeBrackets(e,null!=t?t:{}):this._activeBroker.tradeById(e).then((e=>this._activeBroker?this._showTradeDialog((0,r.ensureDefined)(e),t,i):Promise.reject("Broker connection adapter is null")))}reversePosition(e){return this._makeSureBrokerIsConnected(),this._activeBroker.metainfo().configFlags.supportMultiposition&&!this._activeBroker.config.supportNativeReversePosition?Promise.reject("Cannot reverse position on multiposition acount"):this._noConfirmEnabled.value()?this._activeBroker.reversePosition(e):this._activeBroker.positionById(e).then((t=>{if(!this._activeBroker)return Promise.reject("Broker connection adapter is null");const i=this._activeBroker.reversePosition.bind(this._activeBroker,e);return(0,de.reversePositionDialog)(e,this._showErrorNotification,i,this._activeBroker.config.closePositionCancelsOrders)}))}async cancelOrder(e){var t,i;this._makeSureBrokerIsConnected()
;const r=await this._activeBroker.orderById(e);if(void 0===r)return Promise.reject("Failed to find order");const{tradable:s}=await this._activeBroker.isTradable(r.symbol);if(await this._assertOrderExistsAndNotCanceled(r.id),!s)return this._cancelOrderForNonTradableSymbol(r.symbol,r.id);if(this._noConfirmEnabled.value())return this._activeBroker.cancelOrder(e);{const s=this._activeBroker.cancelOrder.bind(this._activeBroker,e),o=this._activeBroker.metainfo();if(void 0!==(null===(t=o.customUI)||void 0===t?void 0:t.showCancelOrderDialog))return null===(i=o.customUI)||void 0===i?void 0:i.showCancelOrderDialog(r);if(r.parentId){const e=(await this._activeBroker.orders()).filter((e=>e.refNumber===r.refNumber));return o.configFlags.supportCancellingBothBracketsOnly&&e.length>1?this._showCancelMultipleBracketsDialog(r.parentId,s):this._showCancelBracketsDialog(r.id,s)}return this._showCancelOrderDialog(r.id,s)}}cancelOrders(e,t){return this._makeSureBrokerIsConnected(),this._activeBroker.orders().then((i=>{if(!this._activeBroker)return Promise.reject("Broker connection adapter is null");const r=i.filter((i=>i.symbol===e&&(!t||i.side===t)&&function(e){return 4===e.status||3===e.status||6===e.status}(i)));if(!r.length)return Promise.resolve(!1);if(1===r.length)return this.cancelOrder(r[0].id);const s=r.map((e=>e.id));if(this._noConfirmEnabled.value())return this._activeBroker.cancelOrders(e,t,s);{const i=this._activeBroker.cancelOrders.bind(this._activeBroker);return this._showCancelMultipleOrdersDialog(e,t,s,i)}}))}async _modifyOrder(e,t,r,o){const n=this._activeBroker.metainfo();if(!n.configFlags.supportModifyTrailingStop){const t=(await this._activeBroker.orders()).find((t=>t.id===e.id));void 0!==t&&void 0!==t.trailingStopPips?e.hasTrailingStopBracket=!0:e.hasTrailingStopBracket=!1}if(this._makeSureBrokerIsConnected(),e.flags&&e.flags.trailingStop)return ke.logError("Attempt to modify trailing stop loss order"+e.id),this._showErrorNotification(s.t(null,void 0,i(292559)),s.t(null,void 0,i(507214))),Promise.resolve(!1);await this._setSymbol(e.symbol);const a=await this._activeBroker.symbolInfo(e.symbol);e.limitPrice=void 0!==a.limitPriceStep&&void 0!==e.limitPrice?(0,M.roundToStepByPriceTypeAndSide)(e.limitPrice,a.limitPriceStep,1,e.side):e.limitPrice,e.stopPrice=void 0!==a.stopPriceStep&&void 0!==e.stopPrice?(0,M.roundToStepByPriceTypeAndSide)(e.stopPrice,a.stopPriceStep,2,e.side):e.stopPrice;const l=e.limitPrice,c=e.stopPrice,d=e.stopType,u=t&&this._noConfirmEnabled.value();let h=r||(1===e.type?1:2);if(e.parentId&&!R.enabled("always_pass_called_order_to_modify")){let t,i=this._activeBroker.orderById.bind(this._activeBroker);2===e.parentType&&(i=this._activeBroker.positionById.bind(this._activeBroker)),3===e.parentType&&(i=this._activeBroker.tradeById.bind(this._activeBroker));try{t=await i(e.parentId)}catch(e){t=void 0}if(t){h=r||(1===e.type?3:4);const i={takeProfit:l};if(d===ae.StopType.TrailingStop?i.trailingStopPips=e.trailingStopPips:i.stopLoss=c,u&&(i.takeProfit=i.takeProfit||t.takeProfit,
i.stopLoss=i.stopLoss||t.stopLoss,i.trailingStopPips=i.trailingStopPips||t.trailingStopPips),3===e.parentType)return u?this._activeBroker.editTradeBrackets(t.id,i):this._showTradeDialog(t,i,h);if(2===e.parentType&&e.qty===Math.abs(t.qty))return u?this._activeBroker.editPositionBrackets(t.id,i):this._showPositionDialog(t,i,h);const s=t;(0,L.isOrderActive)(s.status)&&(e=Object.assign({},s),l&&(e.takeProfit=l),c&&(d===ae.StopType.TrailingStop?e.trailingStopPips=i.trailingStopPips||e.trailingStopPips:e.stopLoss=c))}}return u?this._activeBroker.modifyOrder(e):n.customUI&&void 0!==n.customUI.showOrderDialog?n.customUI.showOrderDialog(e,h):this._orderViewController().then((t=>this._activeBroker?t.showOrderView({order:e,focus:h,forceOrderDialog:o}):Promise.reject("Broker connection adapter is null")))}async _setSymbol(e){this._tradingLinking.value().symbol!==e&&await this._tradingLinking.setSymbol(e)}_makeSureBrokerIsConnected(){(0,r.assert)(1===this._activeBroker.connectionStatus(),"Broker is not connected")}async _showPositionDialog(e,t={},r){await this._setSymbol(e.symbol);const o=await this._activeBroker.isTradable(e.symbol);if(!o.tradable){const t=void 0!==o.reason?o.reason:(0,M.makeNonTradableSymbolText)(e.symbol,this._activeBroker.metainfo().title);return this._showErrorNotification(s.t(null,void 0,i(326704)),t),Promise.resolve(!1)}{const i=this._activeBroker.metainfo();if(i.customUI&&void 0!==i.customUI.showPositionDialog)return i.customUI.showPositionDialog(e,{stopLoss:t.stopLoss||e.stopLoss,takeProfit:t.takeProfit||e.takeProfit},r)}return this._orderViewController().then((i=>this._activeBroker?i.showPositionView(e,{stopLoss:t.stopLoss,takeProfit:t.takeProfit,trailingStopPips:t.trailingStopPips},r||e.limitPrice&&3||e.stopPrice&&4):Promise.reject("Broker connection adapter is null")))}async _showTradeDialog(e,t={},i){await this._setSymbol(e.symbol);{const r=this._activeBroker.metainfo();if(r.customUI&&void 0!==r.customUI.showPositionDialog)return r.customUI.showPositionDialog(e,{stopLoss:t.stopLoss||e.stopLoss,takeProfit:t.takeProfit||e.takeProfit},i)}return this._orderViewController().then((r=>this._activeBroker?r.showTradeView(e,{stopLoss:t.stopLoss,takeProfit:t.takeProfit,trailingStopPips:t.trailingStopPips},i||e.limitPrice&&3||e.stopPrice&&4):Promise.reject("Broker connection adapter is null")))}_isMaintenance(){return isFeatureEnabled((0,L.makeMaintananceFeatureToggleName)(this._activeBroker.metainfo().id))}_isBrokerSideMaintenance(){return isFeatureEnabled((0,L.makeBrokerSideMaintananceFeatureToggleName)(this._activeBroker.metainfo().id))}_showCancelOrderDialog(e,t){return ue.ConfirmOrderCancelDialog.get().open(e).then((i=>i?t(e):Promise.resolve(!1)))}_showCancelMultipleOrdersDialog(e,t,i,r){const s=i.length;return ue.ConfirmOrderCancelDialog.get().multiple(e,t,s).then((s=>s?r(e,t,i):Promise.resolve(!1)))}async _showCancelBracketsDialog(e,t){return he.ConfirmBracketsCancelDialog.get().open(e).then((i=>i?t(e):Promise.resolve(!1)))}_showCancelMultipleBracketsDialog(e,t){
return he.ConfirmBracketsCancelDialog.get().multiple(e).then((i=>i?t(e):Promise.resolve(!1)))}async _obtainPositionClosingData(e){try{const{supportLots:t,qtyStep:r,uiQtyStep:o,minQty:n,qtyFormatter:a,priceFormatter:l}=await this._obtainPositionOrTradeClosingCommonData(e),c=this._activeBroker.metainfo().configFlags.supportPartialClosePosition,d=ye({symbol:e.symbol,side:1===e.side?s.t(null,void 0,i(273064)):s.t(null,void 0,i(777851)),qty:a.format(e.qty),price:l.format(e.avgPrice),closePositionCancelsOrders:this._activeBroker.config.closePositionCancelsOrders});return{position:e,supportLots:t,qtyStep:r,uiQtyStep:o,minQty:n,supportPartialClosePosition:c,qtyFormatter:a,message:d}}catch(e){return}}async _obtainTradeClosingData(e){try{this._isCloseTradeDialogLoading=!0;const t=(0,r.ensureDefined)(await this._activeBroker.tradeById(e)),{supportLots:o,qtyStep:n,uiQtyStep:a,minQty:l,qtyFormatter:c,priceFormatter:d}=await this._obtainPositionOrTradeClosingCommonData(t),u=this._activeBroker.metainfo().configFlags.supportPartialCloseTrade,h=ye({symbol:t.symbol,side:1===t.side?s.t(null,void 0,i(273064)):s.t(null,void 0,i(777851)),qty:c.format(t.qty),price:d.format(t.price),id:e,closePositionCancelsOrders:this._activeBroker.config.closePositionCancelsOrders});return this._isCloseTradeDialogLoading=!1,{trade:t,supportLots:o,qtyStep:n,uiQtyStep:a,minQty:l,supportPartialCloseTrade:u,qtyFormatter:c,message:h}}catch(e){return void(this._isCloseTradeDialogLoading=!1)}}async _obtainPositionOrTradeClosingCommonData(e){const t=await this._activeBroker.symbolInfo(e.symbol);return{supportLots:void 0!==t.lotSize,qtyStep:t.qty.step,uiQtyStep:t.qty.uiStep,minQty:t.qty.min,qtyFormatter:await this._activeBroker.quantityFormatter(e.symbol),priceFormatter:await this._activeBroker.formatter(e.symbol,!1)}}async _closePositionForNonTradableSymbol(e){const{supportClosePositionForNonTradableSymbol:t,supportClosePosition:r}=this._activeBroker.metainfo().configFlags;if(!t||!r){const t=s.t(null,{replace:{symbol:e.symbol}},i(946305));return this._showErrorNotification(t,s.t(null,void 0,i(348434))),!1}return!!await _e.show(e.symbol)&&this._activeBroker.closePosition(e.id)}async _cancelOrderForNonTradableSymbol(e,t){if(!this._activeBroker.metainfo().configFlags.supportCancelOrderForNonTradableSymbol){const t=s.t(null,{replace:{symbol:e}},i(993545));return this._showErrorNotification(t,s.t(null,void 0,i(30665))),!1}return!!await ge.show(e)&&this._activeBroker.cancelOrder(t)}async _assertPositionExistsAndNotClosed(e){const t=await this._activeBroker.positionById(e);if(!(0,L.checkIsExistingPosition)(t))throw new fe.UserFriendlyError({userFriendlyMessage:s.t(null,{replace:{positionId:e}},i(969233)),detailedErrorMessage:`Position ${e} doesn't exist or has already been closed`})}async _assertOrderExistsAndNotCanceled(e){const t=await this._activeBroker.orderById(e);if(void 0===t||1===t.status)throw new fe.UserFriendlyError({userFriendlyMessage:s.t(null,{replace:{orderId:e}},i(579287)),detailedErrorMessage:`Order ${e} doesn't exist or has already been canceled`})}}
class Ce{constructor(e,t,i,r,s,o){this._domPanel=null,this._resizerBridge=e,this._trading=i,this._qtySuggester=r,this._tradingLinking=s,this._headerState=o,this._getDOMPanel=(0,V.sequentialize)(this._getDOMPanel),this._close=()=>{this.unmount(),t()}}mount(){return this._getDOMPanel().then((e=>{e.setVisibility(!0)}))}unmount(){this._getDOMPanel().then((e=>{e.setVisibility(!1)}))}headerStateValue(){return this._headerState}async _getDOMPanel(){if(null!==this._domPanel)return this._domPanel;const{DOMPanel:e}=await Promise.all([i.e(1701),i.e(580),i.e(8194),i.e(2639),i.e(7845),i.e(4474),i.e(7194),i.e(5295),i.e(8115),i.e(9934),i.e(6577),i.e(7125),i.e(8307),i.e(7802),i.e(4627)]).then(i.bind(i,533140)),t=this._domPanel=new e(this._trading,this._resizerBridge,this._qtySuggester,this._tradingLinking,this._headerState);return t.setCloseHandler(this._close),t}}class we{constructor(e){this._headerState=e}mount(){return Promise.resolve()}unmount(){}headerStateValue(){return this._headerState}}var Be=i(795820),Te=i(483830);const Ee=R.enabled("show_order_panel_on_start");class Oe{constructor(e,t){this.isOpened=new d.WatchedValue(!1),this.isOpeningAvailable=new d.WatchedValue(!1),this.activePage=new d.WatchedValue(Ee?z.TradingPage.OrderPanel:z.TradingPage.DOMPanel),this.isLoading=new d.WatchedValue(!1),this._pageTabs=null,this._pages={},this._panelWidth=z.minPanelWidth,this.setPage=e=>{this.isOpened.value()&&this.activePage.value()!==e&&this._pages[this.activePage.value()]&&this._pages[this.activePage.value()].unmount(),this.activePage.setValue(e),o.setValue(j.settingsKeys.TRADING_PANEL_ACTIVE_PAGE,e)},this.openPage=e=>{this.setPage(e),this.open()},this.open=()=>{const e=this._pages[this.activePage.value()];if(this.isOpeningAvailable.value()&&e){this._togglePanel(!0),this.isOpened.setValue(!0);const t=e.headerStateValue();(0,Be.mountHeader)(this._header,t),null!==this._tabsConfig&&null!==this._pageTabs&&mountTradingPanelPageTabs(this._pageTabs,{items:this._tabsConfig.items,activeTabId:this.activePage.value(),isVisible$:t.backFunction$.pipe((0,P.map)((e=>void 0===e))),onSelect:this._tabsConfig.onSelect}),e.mount()}},this.close=()=>{this.isOpened.setValue(!1),this._pages[this.activePage.value()]&&this._pages[this.activePage.value()].unmount(),(0,Be.unmountHeader)(this._header),this._togglePanel(!1)},this._onLayoutResizeHandleMousedown=e=>{if(e.defaultPrevented||!e.cancelable)return;e.preventDefault();const t=Math.max(this._resizerBridge.width.value(),0);let i;i="touches"in e?e.touches[0].clientX:e.clientX;const r=e=>{let r;e.preventDefault(),r="touches"in e?e.touches[0].clientX:e.clientX;let s=t-(r-i);s<z.minPanelWidth?s=z.minPanelWidth:s>z.maxPanelWidth&&(s=z.maxPanelWidth),this._requestWidth(s)},s=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("touchmove",r),document.removeEventListener("mouseup",s),document.removeEventListener("touchend",s),o.setValue(j.settingsKeys.PANEL_WIDTH,this._panelWidth)};document.addEventListener("mousemove",r),document.addEventListener("touchmove",r,{passive:!1}),
document.addEventListener("mouseup",s),document.addEventListener("touchend",s,{passive:!1})},this._tabsConfig=t,this._resizerBridge=e,this._rootContainer=this._resizerBridge.container.value(),this.container=document.createElement("div"),this.container.classList.add(Te["trading-panel-content"],"trading-panel-content"),this._header=document.createElement("div"),this._header.classList.add(Te["trading-panel-header"]),this._rootContainer.appendChild(this._header),null!==this._tabsConfig&&(this._pageTabs=document.createElement("div"),this._pageTabs.classList.add(Te["trading-panel-tabs"]),this._rootContainer.appendChild(this._pageTabs)),this._rootContainer.appendChild(this.container),this._addSpinner(),this._addResizeHandler(),this._subscribeVisibility(),this.isLoading.subscribe(this._setLoading.bind(this)),this._rootContainer.style.overflow=this.isOpened.value()?"":"hidden"}addPage(e,t){this._pages[e]=t}isPageOpened(e){return this.isOpened.value()&&this.activePage.value()===e}_setLoading(e){e?(this._header.style.display="none",null!==this._pageTabs&&(this._pageTabs.style.display="none"),this.container.style.visibility="hidden",this._rootContainer.appendChild(this._spinnerContainer)):(this._header.style.removeProperty("display"),null!==this._pageTabs&&this._pageTabs.style.removeProperty("display"),this.container.style.removeProperty("visibility"),this._rootContainer.contains(this._spinnerContainer)&&this._rootContainer.removeChild(this._spinnerContainer))}_addSpinner(){this._spinnerContainer=document.createElement("div"),this._spinnerContainer.classList.add(Te["trading-panel-spinner"]),i.e(7102).then(i.bind(i,974063)).then((e=>{e.render(this._spinnerContainer)}))}_addResizeHandler(){this._handle=document.createElement("div"),this._handle.classList.add(Te["trading-panel-handle"]),this._rootContainer.appendChild(this._handle),this._handle.addEventListener("mousedown",this._onLayoutResizeHandleMousedown,{passive:!1}),this._handle.addEventListener("touchstart",this._onLayoutResizeHandleMousedown,{passive:!1}),this._panelWidth=o.getInt(j.settingsKeys.PANEL_WIDTH)||z.minPanelWidth}_togglePanel(e){this._resizerBridge.negotiateWidth(e?this._panelWidth:0),this._resizerBridge.negotiateHeight(e?z.panelHeight:0),this._rootContainer.style.overflow=e?"":"hidden",o.setValue(j.settingsKeys.TRADING_PANEL_OPENED,e)}_updateOpeningAvailability(){const e="visible"!==document.visibilityState||this._resizerBridge.visible.value();this.isOpeningAvailable.setValue(Boolean(e&&this._resizerBridge.availHeight.value()>=z.panelHeight&&this._resizerBridge.availWidth.value()>=this._panelWidth))}_subscribeVisibility(){this._updateOpeningAvailability(),this._resizerBridge.visible.subscribe((()=>{this._updateOpeningAvailability()})),this._resizerBridge.availHeight.subscribe((()=>{this._updateOpeningAvailability()})),this._resizerBridge.availWidth.subscribe((()=>{this._updateOpeningAvailability()}))}_requestWidth(e){this._canResizeWidth(e)&&this._resizerBridge.width.value()!==e&&(this._resizerBridge.negotiateWidth([{min:z.minPanelWidth,max:e}]),
this._panelWidth=e)}_canResizeWidth(e){return e+45<=this._resizerBridge.availWidth.value()}}var De=i(12481),Ie=i(508334);const Le=["qty","stopPrice","limitPrice","status","filledQty","stopType"];function xe(e,t,i){if(void 0===e||void 0===t)return!1;const r=i.indexOf(".");if(-1!==r){const s=i.substring(0,r);return xe(e[s],t[s],i.substring(r+1))}return e[i]===t[i]}function Ne(e,t){return e.enabled.value()&&(t.soundPath=e.path.value()),t}function Me(e){return 6===e||3===e}class Ae extends ee.BrokerService{constructor(e){super(e),this._orders=[],this._playSound=(0,De.default)(this._playSoundImpl,50),b(g().map((e=>e.path)))}startService(){const e=(0,r.ensure)(this.activeBroker());e.orders().then((e=>this._orders=(0,Ie.deepCopy)(e))),e.orderUpdate.subscribe(this,this._orderUpdate)}stopService(){(0,r.ensure)(this.activeBroker()).orderUpdate.unsubscribe(this,this._orderUpdate)}_showNotification(e,t,i){R.enabled("trading_notifications")&&("error"===i?this.trading().showErrorNotification(e,t):this.trading().showSuccessNotification(e,t))}_formatter(e){return(0,r.ensureNotNull)(this.activeBroker()).formatter(e,!0)}_checkOrderModified(e,t){const i=this.activeBroker(),r=i&&i.metainfo().customNotificationFields||[],s=Le.concat(r);let o=!1;return s.forEach((i=>{o||xe(e,t,i)||(o=!0)})),o}_generateNotificationsInfo(e,t){const r=[],o=e.statusMessage?": "+e.statusMessage:"",n=(1===e.side?s.t(null,void 0,i(32241)):s.t(null,void 0,i(185631))).toUpperCase();const a=this.trading().orderExecutedSoundParams;return t?(this._checkOrderModified(e,t)&&(1===e.status?r.push({text:s.t(null,void 0,i(767207)),notificationType:1}):5===e.status?r.push({text:s.t(null,void 0,i(442060))+o,type:"error",notificationType:2}):2===e.status?r.push(Ne(a,{side:n,text:s.t(null,void 0,i(499577)),notificationType:6})):t.filledQty!==e.filledQty?r.push(Ne(a,{side:n,text:s.t(null,void 0,i(23750)),notificationType:4})):Me(e.status)&&r.push({text:s.t(null,void 0,i(164105)),notificationType:5})),Object.assign(t,e)):Me(e.status)?(this._orders.push(e),r.push({text:s.t(null,void 0,i(595536)),notificationType:0}),this.trading().trackEvent("","Order placed symbol",e.symbol)):1===e.status?r.push({text:s.t(null,void 0,i(767207)),notificationType:1}):5===e.status?(this._orders.push(e),r.push({text:s.t(null,void 0,i(442060))+o,type:"error",notificationType:2})):2===e.status&&(this._orders.push(e),r.push({text:s.t(null,void 0,i(595536)),notificationType:0},Ne(a,{side:n,text:s.t(null,void 0,i(499577)),emptyOrderType:!0,notificationType:6})),this.trading().trackEvent("","Order placed symbol",e.symbol)),r}_orderUpdate(e,t){const r=(0,Ie.deepCopy)(e),o=this._orders.find((e=>e.id===r.id));if(t)return void(void 0===o&&this._orders.push(r));if(o&&(0,M.isFinalOrderStatus)(o.status))return;const n=this._generateNotificationsInfo(r,o);0!==n.length&&this._formatter(r.symbol).then((e=>{const t=(0,M.sideToText)(r.side,!0),o=r.qty,a=void 0!==r.filledQty&&r.filledQty>0?r.filledQty:void 0;let l="",c="";switch(r.type){case 2:l=r.avgPrice?" ("+(0,M.orderTypeToText)({orderType:r.type})+")":"",
c=r.avgPrice?e.format(r.avgPrice):(0,M.orderTypeToText)({orderType:r.type});break;case 4:l=" "+s.t(null,void 0,i(916322)).format({price:e.format(r.stopPrice)}),c=e.format(r.avgPrice||r.limitPrice);break;default:l=" ("+(0,M.orderTypeToText)({orderType:r.type})+")",c=e.format(r.avgPrice||r.limitPrice||r.stopPrice)}const d=void 0!==r.message?`${r.message.text.charAt(0).toUpperCase()}${r.message.text.substring(1)}`:"";n.forEach((({text:e,type:n,side:u,emptyOrderType:h,soundPath:p,notificationType:m})=>{const _=4===m&&void 0!==a?a:o,g=(0,ve.splitThousands)(Math.abs(_)," ")+" "+(r.brokerSymbol||r.symbol)+" "+s.t(null,void 0,i(492903))+" "+c,b=`${s.t(null,void 0,i(922541))} ${r.id} ${e}`,v=`${u||t} ${g} ${h?"":l}\n${d}`;void 0!==p&&this._playSound(p),this._showNotification(b,v,n)}))}))}_playSoundImpl(e){if(this._playingSound){if(this._playingSound===e)return;!function(e,t=!1){if((0,l.isOnMobileAppPage)("any"))return;let i=[];e?i.push(v(e)):i=Object.values(_),i.forEach((e=>{e.stop(t)}))}(this._playingSound)}this._playingSound=e,function(e=p,t){(0,l.isOnMobileAppPage)("any")?Promise.resolve():(h.logNormal(`Sound play attempt for "${e}" duration-${t||0}s;`),v(e).play(t))}(e),function(e,t){(0,l.isOnMobileAppPage)("any")||v(e).playing.subscribe((e=>{e||t()}),{once:!0})}(e,(()=>{delete this._playingSound}))}}var Ve=i(739343);const Re=(0,c.getLogger)("Chart.PointsetManager");let Fe=0;class We{constructor(e,t,i,r,s){this._currentPointsetId=null,this._onUpdate=new q.Delegate,this._requestPoints=[],this._gateway=e,this._pointsetSuffix=t,this._isGatewayConnected=this._gateway.isConnected().spawn(),this._isGatewayConnected.subscribe(this._updateByGatewayConnection.bind(this)),this._addPoints(i,r,s)}onUpdate(){return this._onUpdate}destroy(){this._isGatewayConnected.value()&&null!==this._currentPointsetId&&this._gateway.removePointset(this._currentPointsetId),this._requestPoints=[],this._currentPointsetId=null,this._isGatewayConnected.destroy()}_updateByGatewayConnection(e){e||(this._currentPointsetId=null,this._requestPoints=[])}_addPoints(e,t,i){var s,o;this._isGatewayConnected.value()&&((0,r.assert)(e.length>0,"Can't possible create point set for empty array of time points"),this._requestPoints=e.map((e=>[e.time_t,e.offset])),this._currentPointsetId=(s=this._pointsetSuffix,o=++Fe,`pointset_${s}_${o}`),this._gateway.createPointset(this._currentPointsetId,"turnaround",t,(0,Ve.getServerInterval)(i),this._requestPoints,this._onMessage.bind(this)))}_onMessage(e){switch(e.method){case"pointset_error":Re.logNormal(`Pointset error with id ${e.params[0]} turnaround ${e.params[1]}`);break;case"data_update":{const t=[];for(const i of e.params.plots)t.push({time_t:this._requestPoints[i.index][0],index:i.value[0],barTime:i.value[1]});this._onUpdate.fire(t);break}}}}var qe=i(648067);function Ue(e){const t=e.mainSeries().data().first();return null===t?null:t.value[0]}async function $e(e,t,r){
const[s,o,n]=await Promise.all([Promise.all([i.e(1033),i.e(1969),i.e(2650)]).then(i.bind(i,289705)),Promise.all([i.e(1033),i.e(1969),i.e(2650)]).then(i.bind(i,564209)),Promise.all([i.e(1033),i.e(1969),i.e(2650)]).then(i.bind(i,856628))]);e.addCustomSource("executions",((e,i)=>{const a=i.mainSeries(),l=a.dataEvents(),c=(0,qe.createPrimitivePropertyFromGetterAndSubscription)(i.isInReplay.bind(i),i.onInReplayStateChanged()),d=(0,qe.createPrimitivePropertyFromGetterAndSubscription)((()=>a.isConvertedToOtherCurrency()||a.isConvertedToOtherUnit()),a.symbolResolved()),u={arrowVisibility:(0,qe.combineProperty)(((e,t,i)=>i&&!t),c.ownership(),d.ownership(),i.properties().childs().tradingProperties.childs().showExecutions.weakReference()),labelVisibility:i.properties().childs().tradingProperties.childs().showExecutionsLabels},h=function(e,t,i){return r=>{const s=i.seriesSource().symbolInstanceId(),o=i.interval();return null===s?null:new We(e,t,r,s,o)}}(i.chartApi(),"executions",a),p=(0,qe.createWVFromGetterAndSubscription)(Ue.bind(null,i),l.barReceived()),m=new s.ExecutionsService(t,l,function(e){return()=>{const t=e.symbolInfo();return null!==t?t.pro_name||t.full_name:e.proSymbol()}}(a)),_=new o.ExecutionsPointsManager(m,h,p);return new n.ExecutionsSource(e,i,u,r,_)}))}var Qe=i(583705),ze=i(690839),He=i(409432),je=i(815628),Ge=i(372605);const Ze=s.t(null,void 0,i(505010)),Ke=s.t(null,void 0,i(703396)),Je=s.t(null,void 0,i(538386)),Ye=s.t(null,void 0,i(893966)),Xe=s.t(null,void 0,i(799559)),et=s.t(null,void 0,i(435312)),tt=s.t(null,void 0,i(422540)),it=s.t(null,void 0,i(400241)),rt=s.t(null,void 0,i(766596)),st=R.enabled("broker_button");class ot{constructor({dataEvents:e,getSymbolName:t,isNonTradableInstrument:i,qtySuggester:r,tradingCommands:s,settings:o,isInReplay:n}){this.ask=new d.WatchedValue(null),this.askTooltip=new d.WatchedValue(Xe),this.bid=new d.WatchedValue(null),this.bidTooltip=new d.WatchedValue(et),this.spread=new d.WatchedValue(null),this.spreadTooltip=new d.WatchedValue(tt),this.qty=new d.WatchedValue(null),this.qtyTooltip=new d.WatchedValue(""),this.brokerIconVisible=new d.WatchedValue(!1),this.brokerIconLoading=new d.WatchedValue(!1),this.brokerIconUrl=new d.WatchedValue(null),this.isQtyVisible=new d.WatchedValue(!1),this.hasAskBidAdditionalPrecision=new d.WatchedValue(!1),this.canTrade=new d.WatchedValue(!0),this._globalVisibility=null,this._isSymbolTradableResult=new He.WatchedObject(null),this._formatter=null,this._spreadFormatter=null,this._symbol=null,this._abortController=new AbortController,this.setQty=e=>{this.qty.setValue(String(e))},this._createTradedSymbol=()=>{var e;const t=this._getSymbolName();null===(e=this._symbolChangeSubscription)||void 0===e||e.unsubscribe(),this._clearTradedSymbol(),t.length>0&&this._initTradedSymbol(t)},this._onSuggestedQtyChange=e=>{this._lastSuggestedQty=e,this.setQty(e)},this._updateIsSymbolTradable=async e=>{if(null===this._symbol)return void this._isSymbolTradableResult.setValue(null);const t=await this._realtimeProvider.isTradable(this._symbol)
;(null==e?void 0:e.aborted)||this._isSymbolTradableResult.setValue((0,Ge.clone)(t))},this._updateIsSymbolTradable=(0,$.respectLatest)(this._updateIsSymbolTradable),this._isInstantMode=o.noConfirmEnabled.spawn(),this._dataEvents=e,this._getSymbolName=t,this._qtySuggester=r,this._realtimeProvider=s.realtimeProvider,this._onNeedSelectBroker=s.onNeedSelectBroker,this._toggleTradingWidget=s.toggleTradingWidget,this._toggleTradingPanelPopup=s.toggleTradingPanelPopup,this._brokerCommandsUI=s.brokerCommandsUI,this._makeActualTradingSymbolObservable=s.makeActualSymbolObservable,this._updateRealtimeDataHandler=this._updateRealtimeData.bind(this),this._isBrokerConnected=(0,qe.createWVFromGetterAndSubscription)((()=>null!==this._realtimeProvider.activeBroker()),this._realtimeProvider.onStatusChanged),this._isBrokerConnected.subscribe(this._updateQtyTooltip.bind(this),{callWithLast:!0}),this._isBrokerConnected.subscribe(this._updateBrokerIcon.bind(this)),this._isBrokerConnected.subscribe(this._createTradedSymbol),this._isBrokerConnecting=(0,qe.createWVFromGetterAndSubscription)((()=>2===s.brokerConnectionStatus()),s.onBrokerConnectionStatusChange),this._isBrokerConnecting.subscribe(this._updateBrokerIcon.bind(this)),this.visible=new d.WatchedValue(!1),this.visible.subscribe(this._toggleState.bind(this),{callWithLast:!0}),this._showSellBuyButtons=o.showSellBuyButtons.spawn(),this._isInReplay=n.spawn(),this._isNonTradableInstrument=i.spawn(),this._showSellBuyButtons.subscribe(this._updateVisibility.bind(this)),this._isInReplay.subscribe(this._updateVisibility.bind(this)),this._isNonTradableInstrument.subscribe(this._updateVisibility.bind(this)),this._updateVisibility(),this._themeName=o.themeName.spawn(),this._themeName.subscribe(this._updateBrokerIcon.bind(this),{callWithLast:!0}),this._tradePossibilityComputedWV=(0,W.combine)((()=>({})),this._isBrokerConnected.weakReference(),this._isSymbolTradableResult.weakReference(),this.ask.weakReference(),this.bid.weakReference()),this._tradePossibilityComputedWV.subscribe(this._updateTradePossibilityAndTooltip.bind(this),{callWithLast:!0}),this._isQtyVisibleComputedWV=(0,W.combine)((()=>({})),this.canTrade.weakReference(),this._isInstantMode.weakReference()),this._isQtyVisibleComputedWV.subscribe(this._updateIsQtyVisible.bind(this),{callWithLast:!0})}destroy(){var e;this._abortController.abort(),this._stop(),this._isBrokerConnected.destroy(),this._showSellBuyButtons.destroy(),this._isInReplay.destroy(),this._isNonTradableInstrument.destroy(),null===(e=this._globalVisibility)||void 0===e||e.release(),this._isInstantMode.destroy(),this._tradePossibilityComputedWV.destroy(),this._isQtyVisibleComputedWV.destroy(),this._themeName.destroy(),this._isBrokerConnecting.destroy()}setGlobalVisibility(e){(0,r.assert)(null===this._globalVisibility,"GlobalVisibility can be set only once"),this._globalVisibility=e,this._globalVisibility.subscribe(this._updateVisibility.bind(this),{callWithLast:!0})}async tryToPlaceSellOrder(){await this._tryToPlaceOrder(parseFloat((0,
r.ensureNotNull)(this.bid.value())),-1)}async tryToPlaceBuyOrder(){await this._tryToPlaceOrder(parseFloat((0,r.ensureNotNull)(this.ask.value())),1)}async getQtyInfo(){return null!==this._symbol&&this.canTrade.value()?(await this._realtimeProvider.symbolInfo(this._symbol)).qty:null}applyQty(){if(null===this._symbol||!this.canTrade.value())return;const e=this.qty.value(),t=null!==e?Number(e):null;null!==t&&this._qtySuggester.setQty(this._symbol,t),void 0!==this._lastSuggestedQty&&t!==this._lastSuggestedQty&&this.qty.setValue(String(this._lastSuggestedQty))}canShowMobileTrading(){var e;return!(null===(e=window.TradingView.bottomWidgetBar)||void 0===e?void 0:e.isVisible().value())}_updateVisibility(){const e=(null===this._globalVisibility||this._globalVisibility.value())&&this._showSellBuyButtons.value()&&!this._isInReplay.value()&&!this._isNonTradableInstrument.value();this.visible.setValue(e)}async _tryToPlaceOrder(e,t){var i,s;if(null===this._realtimeProvider.activeBroker())return this.canShowMobileTrading()?this._toggleTradingPanelPopup():await this._toggleTradingWidget(),void this._onNeedSelectBroker.fire();const o=Number(this.qty.value())||1,n=this._isMarketOrderSupported()?2:1,a=1===t?null===(i=this._currentQuotes)||void 0===i?void 0:i.ask:null===(s=this._currentQuotes)||void 0===s?void 0:s.bid,l={symbol:(0,r.ensureNotNull)(this._symbol),qty:o,side:t,type:n,seenPrice:null!=a?a:null,currentQuotes:this._currentQuotes};1===n&&(l.limitPrice=e),await(0,r.ensureNotNull)(this._brokerCommandsUI()).placeOrder(l,!0)}_toggleState(e){e?this._start():this._stop()}_start(){this._dataEvents.symbolResolved().subscribe(this,this._createTradedSymbol),this._dataEvents.symbolError().subscribe(this,this._createTradedSymbol),this._createTradedSymbol()}_stop(){var e;null===(e=this._symbolChangeSubscription)||void 0===e||e.unsubscribe(),this._clearTradedSymbol(),this._symbol=null,this._dataEvents.symbolResolved().unsubscribeAll(this),this._dataEvents.symbolError().unsubscribeAll(this)}_initTradedSymbol(e){this._symbol=e,this._updateIsSymbolTradable(this._abortController.signal),this._realtimeProvider.subscribeRealtime(this._symbol,this._updateRealtimeDataHandler),this._resubscribeQtySuggester()}_clearTradedSymbol(){var e;this._currentQuotes=void 0,this.ask.setValue(null),this.bid.setValue(null),this.spread.setValue(null),this.qty.setValue(null),null!==this._symbol&&(this._realtimeProvider.unsubscribeRealtime(this._symbol,this._updateRealtimeDataHandler),null===(e=this._qtySuggesterSubscription)||void 0===e||e.unsubscribe(),this._symbol=null,this._updateIsSymbolTradable(this._abortController.signal))}async _resubscribeQtySuggester(){var e;const t=this._symbol;if(null===t)return;null===(e=this._qtySuggesterSubscription)||void 0===e||e.unsubscribe();const i=this._suggestedQtyPromise=this._qtySuggester.getQty(t),r=await i;i===this._suggestedQtyPromise&&t===this._symbol&&(this._lastSuggestedQty=r,this.setQty(r),this._qtySuggesterSubscription=this._qtySuggester.suggestedQtyChanged(t).subscribe(this._onSuggestedQtyChange))}
_isMarketOrderSupported(){const e=this._realtimeProvider.activeBroker();return null===e||Boolean(e.metainfo().configFlags.supportMarketOrders)}_updateTradePossibilityAndTooltip(){this._updateCanTrade(),this._updateSellBuyTooltip()}_updateCanTrade(){const e=this._isSymbolTradableResult.value(),t=this._isBrokerConnected.value()&&null!==e&&e.tradable;this.canTrade.setValue(t)}_updateSellBuyTooltip(){var e,t;const i=this._getNonTradedTooltip();this.askTooltip.setValue(null!==(e=null!=i?i:this._getAskTooltip())&&void 0!==e?e:Xe),this.bidTooltip.setValue(null!==(t=null!=i?i:this._getBidTooltip())&&void 0!==t?t:et)}_getNonTradedTooltip(){const e=this._isSymbolTradableResult.value();if(null!==e&&!e.tradable)return void 0!==e.solutions?"":void 0!==e.shortReason&&""!==e.shortReason?e.shortReason:this._isBrokerConnected.value()?Ke:Ze}_getAskTooltip(){return null===this.ask.value()?Ye:void 0}_getBidTooltip(){return null===this.bid.value()?Je:void 0}_updateRealtimeData(e,t,i){this._formatter=i.formatter,this._spreadFormatter=i.spreadFormatter;const r=t.ask,s=t.bid,o=(0,y.isNumber)(r),n=(0,y.isNumber)(s),a=o?this._formatter.format(r):null,l=n?this._formatter.format(s):null;this.ask.setValue(a),this.bid.setValue(l),o&&n&&(this._currentQuotes={ask:r,bid:s});const c=t.spread||(0,y.isNumber)(r)&&(0,y.isNumber)(s)&&r-s||0,d=(0,y.isNumber)(t.spread)?this._spreadFormatter:this._formatter;this.spread.setValue(d.format(c));let u=!1;(0,je.isFormatterHasForexAdditionalPrecision)(this._formatter)&&(u=this._formatter.hasForexAdditionalPrecision()),this.hasAskBidAdditionalPrecision.setValue(u)}_updateIsQtyVisible(){const e=this._isInstantMode.value()&&this.canTrade.value();this.isQtyVisible.setValue(e)}_updateQtyTooltip(){this.qtyTooltip.setValue(this._getQtyTooltip())}_getQtyTooltip(){const e=this._realtimeProvider.activeBroker();return null!==e&&e.metainfo().configFlags.showQuantityInsteadOfAmount?rt:it}_updateBrokerIcon(){if(!st)return;let e;const t=this._realtimeProvider.activeBroker();if(null!==t){const i=t.metainfo();e="dark"===this._themeName.value()&&i.logoMiniBlackUrl?i.logoMiniBlackUrl:i.logoMiniUrl}this.brokerIconVisible.setValue(this._isBrokerConnected.value()),this.brokerIconLoading.setValue(this._isBrokerConnecting.value()),this.brokerIconUrl.setValue(e||null)}}var nt=i(973602),at=i(159255),lt=i(343370),ct=i(72304),dt=i(476853),ut=i(462892),ht=i(851237),pt=i(673543);class mt extends ht.LoaderBaseRenderer{_renderLoading(e){super._renderLoading(e),this._loadingEl.innerHTML=`\n\t\t\t<span class="${pt.loaderCircle}"></span>\n\t\t`,this._loadingEl.classList.add(pt.loader)}}var _t=i(521744),gt=i(382280);var bt=i(190787),vt=i(199056),yt=i(707488),ft=i(844012),kt=i(829883);const Pt=parseInt(ft["css-value-padding"]);function St(e,t,i,s){let o=e.querySelector(`.${s}`);if(!i)return null!==o&&o.remove(),void(0,bt.updateTextNode)(e,t);null===o&&(o=document.createElement("span"),o.classList.add(s),e.appendChild(o)),(0,bt.updateTextNode)((0,r.ensureNotNull)(o),t.slice(-1)),(0,bt.updateTextNode)(e,t.slice(0,-1))}class Ct{
constructor({model:e,highButtonsMode:t,trackEvent:i,toggleMinimizeBottomWidgetBar:r}){this.element=document.createElement("div"),this._buttonsWrapperEl=document.createElement("div"),this._informerWrapperEl=null,this._sellButtonEl=document.createElement("div"),this._sellButtonTextEl=document.createElement("span"),this._buyButtonEl=document.createElement("div"),this._buyButtonTextEl=document.createElement("span"),this._spreadQtyWrapper=document.createElement("div"),this._spreadEl=document.createElement("div"),this._qtyEl=document.createElement("div"),this._qtyTextEl=document.createElement("span"),this._brokerButtonEl=document.createElement("div"),this._brokerIconWrapEl=document.createElement("div"),this._isCalcOpened=!1,this._calcContainer=document.createElement("div"),this._sellLoader=new ut.LoaderPointsRenderer(this._sellButtonEl,{className:vt.loader}),this._buyLoader=new ut.LoaderPointsRenderer(this._buyButtonEl,{className:vt.loader}),this._brokerLoader=new mt(this._brokerButtonEl,{className:vt.circleLoader}),this._windowResizeHandlerThrottle=(0,lt.default)(this._windowResizeHandler.bind(this),100),this._isHiddenByViewport=!1,this._mode=2,this._height=new d.WatchedValue(0),this._resizeObserver=null,this._cachedBreakPoints={},this._parentWidth=0,this._getCurrentQty=()=>{const e=this._qty.value();return null!==e?Number(e):null},this._model=e,this._toggleMinimizeBottomWidgetBar=r,this._ask=this._model.ask.spawn(),this._ask.subscribe(this._updateBuyButton.bind(this)),this._bid=this._model.bid.spawn(),this._bid.subscribe(this._updateSellButton.bind(this)),this._spread=this._model.spread.spawn(),this._spread.subscribe(this._updateSpread.bind(this)),this._qty=this._model.qty.spawn(),this._qty.subscribe(this._updateQty.bind(this)),this._brokerIconVisible=this._model.brokerIconVisible.spawn(),this._brokerIconVisible.subscribe(this._updateBrokerIconImage.bind(this)),this._brokerIconLoading=this._model.brokerIconLoading.spawn(),this._brokerIconLoading.subscribe(this._updateBrokerIconImage.bind(this)),this._brokerIconUrl=this._model.brokerIconUrl.spawn(),this._brokerIconUrl.subscribe(this._updateBrokerIconImage.bind(this),{callWithLast:!0}),this._trackEvent=i,this._render(),this._askTooltip=this._model.askTooltip.spawn(),this._askTooltip.subscribe(this._updateButtonTooltip.bind(this,this._buyButtonEl),{callWithLast:!0}),this._bidTooltip=this._model.bidTooltip.spawn(),this._bidTooltip.subscribe(this._updateButtonTooltip.bind(this,this._sellButtonEl),{callWithLast:!0}),this._spreadTooltip=this._model.spreadTooltip.spawn(),this._spreadTooltip.subscribe(this._updateButtonTooltip.bind(this,this._spreadEl),{callWithLast:!0}),this._qtyTooltip=this._model.qtyTooltip.spawn(),this._qtyTooltip.subscribe(this._updateButtonTooltip.bind(this,this._qtyEl),{callWithLast:!0}),this._canTrade=this._model.canTrade.spawn(),this._canTrade.subscribe(this._updateBgButtonsMode.bind(this),{callWithLast:!0}),this._isVisible=this._model.visible.spawn(),this._isVisible.subscribe(this._updateVisibility.bind(this),{callWithLast:!0}),
this._isQtyVisible=this._model.isQtyVisible.spawn(),this._isQtyVisible.subscribe(this._updateQtyVisibility.bind(this),{callWithLast:!0}),this._isLastDigitSup=this._model.hasAskBidAdditionalPrecision.spawn(),this._isLastDigitSup.subscribe(this._updateLastDigitSup.bind(this)),this._highButtonsMode=t.spawn(),this._highButtonsMode.subscribe(this._updateHighButtonsMode.bind(this),{callWithLast:!0}),this._sellButtonHandler=this._onSellButton.bind(this),this._buyButtonHandler=this._onBuyButton.bind(this),this._qtyHandler=this._toggleCalcVisibility.bind(this),this._brokerButtonHandler=this._onBrokerButton.bind(this),this._sellButtonEl.addEventListener("click",this._sellButtonHandler),this._buyButtonEl.addEventListener("click",this._buyButtonHandler),this._qtyEl.addEventListener("click",this._qtyHandler),this._brokerButtonEl.addEventListener("click",this._brokerButtonHandler),window.addEventListener("resize",this._windowResizeHandlerThrottle),this._windowResizeHandler()}destroy(){var e;this._ask.destroy(),this._askTooltip.destroy(),this._bid.destroy(),this._bidTooltip.destroy(),this._spread.destroy(),this._spreadTooltip.destroy(),this._qty.destroy(),this._qtyTooltip.destroy(),this._isVisible.destroy(),this._isQtyVisible.destroy(),this._isLastDigitSup.destroy(),this._highButtonsMode.destroy(),this._canTrade.destroy(),this._brokerIconUrl.destroy(),this._sellButtonEl.removeEventListener("click",this._sellButtonHandler),this._buyButtonEl.removeEventListener("click",this._buyButtonHandler),this._qtyEl.removeEventListener("click",this._qtyHandler),this._brokerButtonEl.removeEventListener("click",this._brokerButtonHandler),null===(e=this._resizeObserver)||void 0===e||e.disconnect(),this._resizeObserver=null,this.element.remove(),delete this.element,window.removeEventListener("resize",this._windowResizeHandlerThrottle)}updateModeByWidth(e){var t;const i=this._cachedBreakPoints[0],r=this._cachedBreakPoints[1];this._mode=void 0!==i&&e<i?0:void 0!==r&&e<r?1:2,this._parentWidth=e;const s=1===this._mode;this._buttonsWrapperEl.classList.toggle(vt.column,s),null===(t=this._informerWrapperEl)||void 0===t||t.classList.toggle(vt.column,s),this._updateVisibility()}height(){return this._height}renderTo(e,t){void 0!==t?e.insertBefore(this.element,t):e.appendChild(this.element),null===this._resizeObserver&&(this._resizeObserver=new at.default(this._updateBreakPointsAndSize.bind(this))),this._resizeObserver.unobserve(this.element),this._resizeObserver.observe(this.element)}isHiddenByViewport(){return this._isHiddenByViewport}_render(){const e=this._bid.value()||"...";this._sellButtonTextEl.appendChild(document.createTextNode(e)),this._sellButtonTextEl.classList.add(vt.buttonText),this._sellButtonEl.append(this._sellButtonTextEl),this._sellButtonEl.classList.add("apply-common-tooltip",vt.button,vt.sellButton);const t=this._spread.value()||"";this._spreadEl.appendChild(document.createTextNode(String(t))),this._spreadEl.classList.add("apply-common-tooltip",vt.spread);const i=this._qty.value()||""
;this._qtyTextEl.appendChild(document.createTextNode(i)),this._qtyEl.append(this._qtyTextEl),this._qtyEl.setAttribute("data-name","qtyEl"),this._qtyEl.classList.add("apply-common-tooltip",vt.button,vt.qty),this._spreadQtyWrapper.classList.add(vt.spreadQtyWrapper),this._spreadQtyWrapper.appendChild(this._spreadEl),this._spreadQtyWrapper.appendChild(this._qtyEl);const r=this._ask.value()||"...";this._buyButtonTextEl.appendChild(document.createTextNode(String(r))),this._buyButtonTextEl.classList.add(vt.buttonText),this._buyButtonEl.append(this._buyButtonTextEl),this._buyButtonEl.classList.add("apply-common-tooltip",vt.button,vt.buyButton),this._brokerButtonEl.appendChild(this._brokerIconWrapEl),this._brokerIconWrapEl.classList.add(vt.brokerButtonIconWrap),this._brokerButtonEl.classList.add(vt.brokerButton),this._buttonsWrapperEl.appendChild(this._sellButtonEl),this._buttonsWrapperEl.appendChild(this._spreadQtyWrapper),this._buttonsWrapperEl.appendChild(this._buyButtonEl),this._buttonsWrapperEl.appendChild(this._brokerButtonEl),this._buttonsWrapperEl.classList.add(vt.buttonsWrapper),this._buttonsWrapperEl.classList.toggle(vt.touchMode,_t.trackingModeIsAvailable),this._buttonsWrapperEl.classList.toggle(vt.notAvailableOnMobile,false),this.element.appendChild(this._buttonsWrapperEl),this._initTradingInformer(),this.element.classList.add(vt.container)}_initTradingInformer(){0}_updateBreakPointsAndSize(e){const t=e[0],i=2*Pt;2===this._mode&&(this._cachedBreakPoints[1]=Math.round(t.contentRect.width)+i),1===this._mode&&(this._cachedBreakPoints[0]=Math.round(t.contentRect.width)+i),this.updateModeByWidth(this._parentWidth);const r=t.contentRect.height>0?Math.round(t.contentRect.height)+i:0;this._height.setValue(r)}_updateBrokerIconImage(){const e=this._brokerIconLoading.value(),t=!this._brokerIconVisible.value()&&!e;if(this._brokerButtonEl.classList.toggle(yt.blockHidden,t),t)return;if(this._toggleLoaderVisibility(this._brokerButtonEl,this._brokerLoader,e),e)return void(this._brokerIconWrapEl.innerHTML="");const i=this._brokerIconUrl.value(),r=null===i;this._brokerIconWrapEl.innerHTML=r?kt:`<image src="${i}" alt="Account Manager" />`,this._brokerButtonEl.classList.toggle(vt.brokerButtonDefault,r)}async _onSellButton(){if(null===this._bid.value())return;const e=this._highButtonsMode.value();this._trackEvent("Sell/Buy Buttons","Sell",e?"Instant":"Not Instant"),e&&this._canTrade.value()&&this._toggleLoaderVisibility(this._sellButtonEl,this._sellLoader,!0),await this._model.tryToPlaceSellOrder(),e&&this._canTrade.value()&&setTimeout((()=>this._toggleLoaderVisibility(this._sellButtonEl,this._sellLoader,!1)),300)}async _onBuyButton(){if(null===this._ask.value())return;const e=this._highButtonsMode.value();this._trackEvent("Sell/Buy Buttons","Buy",e?"Instant":"Not Instant"),e&&this._canTrade.value()&&this._toggleLoaderVisibility(this._buyButtonEl,this._buyLoader,!0),await this._model.tryToPlaceBuyOrder(),e&&this._canTrade.value()&&setTimeout((()=>this._toggleLoaderVisibility(this._buyButtonEl,this._buyLoader,!1)),300)}
_onBrokerButton(){this._model.canShowMobileTrading()?async function(){(await(0,gt.waitTradingService)()).tradingPanelPopup.show()}():this._toggleMinimizeBottomWidgetBar()}_toggleLoaderVisibility(e,t,i){e.classList.toggle(vt.loading,i),t.toggleVisibility(i)}_updateBuyButton(e){const t=null!==e&&this._isLastDigitSup.value();St(this._buyButtonTextEl,`${e||"..."}`,t,vt.lastCharSup)}_updateSellButton(e){const t=null!==e&&this._isLastDigitSup.value();St(this._sellButtonTextEl,`${e||"..."}`,t,vt.lastCharSup)}_updateSpread(e){const t=`${e||""}`;(0,bt.updateTextNode)(this._spreadEl,t),this._updateVisibilityForSpreadQtyWrapper()}_updateQty(e){let t=`${e||""}`;!this._isCalcOpened&&t.length>0&&(t=(0,F.abbreviatedNumber)(Number(t))),(0,bt.updateTextNode)(this._qtyTextEl,t)}_updateHighButtonsMode(e){this._buttonsWrapperEl.classList.toggle(vt.highButtons,e)}_updateBgButtonsMode(e){var t;this._buttonsWrapperEl.classList.toggle(vt.withoutBg,!e),null===(t=this._informerWrapperEl)||void 0===t||t.classList.toggle(yt.blockHidden,!e)}_updateVisibilityForSpreadQtyWrapper(){const e=!this._isQtyVisible.value()&&null===this._spread.value();this._spreadQtyWrapper.classList.toggle(yt.blockHidden,e)}_updateQtyVisibility(e){this._qtyEl.classList.toggle(yt.blockHidden,!e),this._spreadQtyWrapper.classList.toggle(vt.withoutQty,!e),this._updateVisibilityForSpreadQtyWrapper()}_updateVisibility(){var e;const t=this._isVisible.value()&&0!==this._mode&&!this._isHiddenByViewport;this._buttonsWrapperEl.classList.toggle(yt.blockHidden,!t),null===(e=this._informerWrapperEl)||void 0===e||e.classList.toggle(yt.blockHidden,!t||!this._canTrade.value())}_updateLastDigitSup(){this._updateBuyButton(this._ask.value()),this._updateSellButton(this._bid.value())}_updateButtonTooltip(e,t){if(""===t)return(0,ct.setTooltipData)(e,"text",t),void e.removeAttribute("title");e.setAttribute("title",t)}_toggleCalcVisibility(){this._isCalcOpened=!this._isCalcOpened,this._renderCalc()}_closeCalc(){this._isCalcOpened=!1,this._updateQty(this._qty.value()),this._model.applyQty(),this._renderCalc()}_renderCalc(){Promise.all([i.e(580),i.e(8194),i.e(7845),i.e(4474),i.e(17),i.e(7125),i.e(3809)]).then(i.bind(i,713191)).then((async e=>{const t=await this._model.getQtyInfo();null!==t&&e.render(this._isCalcOpened,this._calcContainer,{...t,withInput:!0,valueGetter:this._getCurrentQty,position:this._getCalcPosition(),targetEl:this._qtyEl,onClose:this._closeCalc.bind(this),onValueChange:this._model.setQty,trackEventTarget:"Sell/Buy Buttons",trackEvent:this._trackEvent})}))}_getCalcPosition(){return(0,dt.getPopupPositioner)(this._qtyEl,{horizontalAttachEdge:dt.HorizontalAttachEdge.Left,horizontalDropDirection:dt.HorizontalDropDirection.FromLeftToRight})}_windowResizeHandler(){false!==this._isHiddenByViewport&&(this._isHiddenByViewport=false,this._updateVisibility())}}const wt=s.t(null,void 0,i(73953));class Bt{constructor(e,t,i,r,s,o,n){this._showSellBuyButtons=o.showSellBuyButtons,this._isEconomySymbol=i,this._isInReplay=n,this._trackEvent=s.trackEvent,this._model=new ot({dataEvents:e,
getSymbolName:t,isNonTradableInstrument:i,qtySuggester:r,tradingCommands:s,settings:o,isInReplay:n}),this._renderer=new Ct({model:this._model,highButtonsMode:o.noConfirmEnabled,trackEvent:s.trackEvent,toggleMinimizeBottomWidgetBar:s.toggleMinimizeBottomWidgetBar})}destroy(){this._model.destroy(),this._renderer.destroy(),this._isEconomySymbol.destroy(),this._isInReplay.destroy()}renderTo(e,t){this._renderer.renderTo(e,t)}setGlobalVisibility(e){this._model.setGlobalVisibility(e)}visibility(){return this._model.visible}updateWidgetModeBySize(e){this._renderer.updateModeByWidth(e.width)}contextMenuActions(){if(this._renderer.isHiddenByViewport())return[];return[new nt.Action({actionId:"Trading.SellBuyButtonsToggleVisibility",checkable:!0,checked:this._showSellBuyButtons.value(),label:wt,disabled:this._isInReplay.value()||this._isEconomySymbol.value(),onExecute:()=>{const e=!this._showSellBuyButtons.value();this._showSellBuyButtons.setValue(e),this._trackEvent("SellBuyButtonsWidget context menu","Show Sell/Buy Button",e?"Check":"Uncheck")}})]}height(){return this._renderer.height()}}var Tt=i(500962),Et=i(19406),Ot=i(533408),Dt=i(640712);const It=be.forwardRef(((e,t)=>be.createElement("div",{ref:t,className:Dt.popupWrapper},e.children)));var Lt=i(630795);const xt=(()=>{let e,t,r,s=null,o=null;return async(n,a,l,c)=>{const u=null==n?void 0:n.currentAccount();if(null===s||o!==n||e!==u||r!==c){null==t||t.remove();const{AccountManager:h}=await Promise.all([i.e(2666),i.e(4015),i.e(3842),i.e(6),i.e(5993),i.e(5649),i.e(8056),i.e(3502),i.e(2639),i.e(9842),i.e(7080),i.e(6747),i.e(6884),i.e(3889),i.e(8992),i.e(5896),i.e(936),i.e(8232),i.e(9255),i.e(8210),i.e(6216),i.e(8951),i.e(9937),i.e(8413),i.e(9781),i.e(8354)]).then(i.bind(i,863489)),p={container:a,visible:new d.WatchedValue(!0)};s=a,o=n,e=u,r=c,t=await h.create({broker:n,bridge:p,mode:0,overlapManager:l,summaryFieldsVisibilityManager:c})}else a.appendChild(s)}})(),Nt=new d.WatchedValue(null);function Mt(e){const{broker:t,summaryFieldsVisibilityManager:i}=e,r=(0,be.useRef)(null),s=(0,be.useContext)(Lt.SlotContext);return(0,be.useEffect)((()=>{Nt.setValue(s)}),[s]),(0,be.useEffect)((()=>{null!==r.current&&xt(t,r.current,Nt.readonly(),i)}),[]),be.createElement(It,{ref:r})}var At=i(665276),Vt=i(407999),Rt=i(241347),Ft=i(744633);function Wt(e){return be.createElement("span",{className:Ft.separator})}var qt=i(783806),Ut=i(112235),$t=i(517516);const Qt=s.t(null,void 0,i(890801));class zt extends Et.DialogRenderer{constructor(e){super(),this._title=Qt,this._isSubscribed=!1,this._showSeparator=!0,this._handleClose=()=>{Tt.unmountComponentAtNode(this._container),this._setVisibility(!1)},this._trading=e}visible(){return this._visibility.spawn().readonly()}show(){this._isSubscribed||(this._isSubscribed=!0,this._onStatusChange(this._trading.connectStatus()),this._trading.onConnectionStatusChange.subscribe(this,this._onStatusChange)),this._setVisibility(!0),this._renderComponent()}hide(){this._handleClose()}_onStatusChange(e,t){var i,r
;null===(i=this._trading.activeBroker())||void 0===i||i.currentAccountUpdate.unsubscribe(this,this._renderAccountManager),this._connectStatus!==e&&(this._connectStatus=e,this._additionalHeaderElement=void 0,window.navigator.onLine?2!==e&&(null==t?void 0:t.disconnectType)!==I.DisconnectType.Offline&&3!==e&&4!==e?1===e&&(null===(r=this._trading.activeBroker())||void 0===r||r.currentAccountUpdate.subscribe(this,this._renderAccountManager),this._renderAccountManager()):this._renderSpinner():this._renderOfflineScreen())}_renderComponent(){Tt.render(be.createElement(Ot.AdaptivePopupDialog,{dataName:"trading-dialog",isOpened:this.visible().value(),onClose:this._handleClose,showSeparator:this._showSeparator,fullScreen:!0,draggable:!1,title:this._title,render:()=>this._content,additionalHeaderElement:this._additionalHeaderElement,additionalElementPos:"after",headerClassName:$t.header}),this._container)}_renderSpinner(){this._showSeparator=!0,this._title=Qt,this._changeDialogContent(be.createElement(At.Spinner,null))}_renderOfflineScreen(){this._title=Qt,this._changeDialogContent(be.createElement(Ut.OfflineScreen,null))}async _renderBrokerSelectScreen(){0}async _renderAccountManager(){const e=(0,r.ensureNotNull)(this._trading.activeBroker()).accountManagerInfo().summary,t=new Rt.SummaryFieldsVisibilityManager(e,this._trading.getBrokerTradingSettingsStorage),s=await(0,Vt.makeAccountManagerHeaderDropdownsProps)(this._trading,t);if(this._showSeparator=!1,this._title=Qt,void 0!==s){const{AccountManagerHeaderDropdowns:e}=await Promise.all([i.e(2666),i.e(4015),i.e(3842),i.e(6),i.e(5993),i.e(5649),i.e(8056),i.e(3502),i.e(2639),i.e(9842),i.e(7080),i.e(6747),i.e(6884),i.e(3889),i.e(8992),i.e(5896),i.e(936),i.e(8232),i.e(9255),i.e(8210),i.e(6216),i.e(8951),i.e(9937),i.e(8413),i.e(9781),i.e(8354)]).then(i.bind(i,605899));s.accountDropdownProps.mode=0,void 0!==s.brokerDropdownProps&&(s.brokerDropdownProps.mode=0),this._title=be.createElement(e,{...s});{const e={...s.commonDropdownProps,iconSize:"big"};this._additionalHeaderElement=be.createElement("span",{className:$t.moreButton},be.createElement(qt.TerminalDropdown,{...e}),be.createElement(Wt,null))}}this._content=be.createElement(Mt,{broker:this._trading.activeBroker(),summaryFieldsVisibilityManager:t}),this._renderComponent()}_changeDialogContent(e){this._content=be.createElement(It,null,e),this._renderComponent()}}var Ht,jt=i(948776),Gt=i(601227);async function Zt(e,t){localStorage.setItem(e,t)}!function(e){e.get=async function(){return Gt.CheckMobile.any()||await async function(){const e=o.getValue(j.settingsKeys.ACTIVE_BROKER);if(o.remove(j.settingsKeys.ACTIVE_BROKER,{forceFlush:!0}),void 0===e)return;await Zt(j.settingsKeys.ACTIVE_BROKER,e)}(),async function(e){return localStorage.getItem(e);const t=localStorage.getItem(e);if(null===t)return null;const i=await userSpecificDecrypt(t);null===i&&localStorage.removeItem(e);return i}(j.settingsKeys.ACTIVE_BROKER)},e.set=async function(e){await Zt(j.settingsKeys.ACTIVE_BROKER,e)},e.clear=function(){o.remove(j.settingsKeys.ACTIVE_BROKER,{
forceFlush:!0}),localStorage.removeItem(j.settingsKeys.ACTIVE_BROKER)}}(Ht||(Ht={}));var Kt=i(960521),Jt=i.n(Kt),Yt=i(173587),Xt=i(233064),ei=i(218286),ti=i(169977),ii=i(312694),ri=i(749401),si=i(265728),oi=i(482165),ni=i(44681),ai=i(99708);class li{constructor(e){this._rawAndFilteredQtyMap=new Map,this._qtyInfo=new Map;const{symbolInfoGetter:t,onResetNeeded:i,qtySettingsStorageGetter:r}=e;this._getQtySettingsStorage=r,this._getSymbolInfo=t,i.subscribe(this,this._reset)}async getQty(e){return(0,ri.firstValueFrom)(this._getRawAndFilteredQty(e).filteredQty$)}setQty(e,t){this._getRawAndFilteredQty(e).rawQty$.next(t)}suggestedQtyChanged(e){return this._getRawAndFilteredQty(e).filteredQty$.pipe((0,Yt.skip)(1))}_getRawAndFilteredQty(e){var t;return null!==(t=this._rawAndFilteredQtyMap.get(e))&&void 0!==t?t:this._makeRawAndFilteredQty(e)}_makeRawAndFilteredQty(e){const t=new si.ReplaySubject(1),i=this._getInitialQty(e).pipe((0,Xt.switchMap)((e=>t.pipe((0,w.startWith)(e)))),(0,ei.distinctUntilChanged)(),(0,ti.filter)((t=>this._isQtyCorrect(e,t))),(0,oi.tap)((t=>{var i;return null===(i=this._getQtySettingsStorage())||void 0===i?void 0:i.setSymbolQty(e,t)})),(0,ii.share)({connector:()=>new si.ReplaySubject(1),resetOnRefCountZero:!1})),r={rawQty$:t,filteredQty$:i};return this._rawAndFilteredQtyMap.set(e,r),r}_isQtyCorrect(e,t){const i=(0,r.ensureDefined)(this._qtyInfo.get(e));return!(0,ai.checkQtyError)(i,t,!0).res}_getInitialQty(e){return(0,E.from)(this._getSymbolInfo(e)).pipe((0,P.map)((({qty:t})=>{var i;this._qtyInfo.set(e,t);const r=null===(i=this._getQtySettingsStorage())||void 0===i?void 0:i.symbolQty(e),s=t.default||t.min;return void 0!==r&&r>0?(o=(0,ni.clamp)(r,t.min,t.max),n=t.min,a=t.step,Jt()(o).minus(n).div(a).round(0,1).mul(a).plus(n).toNumber()):s;var o,n,a})))}_reset(){this._rawAndFilteredQtyMap.forEach((({rawQty$:e})=>e.complete())),this._rawAndFilteredQtyMap.clear(),this._qtyInfo.clear()}}var ci=i(316230);class di{constructor(){this._context=null,this._onContextChanged=new q.Delegate,this._contextChange=()=>{this._onContextChanged.fire(this.context())}}context(){var e,t;return null!==(t=null===(e=this._context)||void 0===e?void 0:e.externalContext())&&void 0!==t?t:null}setContext(e){var t;this._isEqualContexts(e)||(this._clearSubscription(),this._context=e,null===(t=this._context)||void 0===t||t.onStatusChange().subscribe(this,this._contextChange),this._contextChange())}onContextChanged(){return this._onContextChanged}clear(){this.setContext(null)}_clearSubscription(){var e;null===(e=this._context)||void 0===e||e.onStatusChange().unsubscribeAll(this)}_isEqualContexts(e){var t;return null===this._context||null===e?this._context===e:(null===(t=this.context())||void 0===t?void 0:t.type)===(null==e?void 0:e.externalContext().type)&&(this._context.status()===e.status()&&(0,ci.default)(this._context.errors(),e.errors())&&(0,ci.default)(this._context.data(),e.data()))}}var ui=i(688401);class hi{constructor(e){this._onSymbolChange=e=>{this._processSymbol(null,null!=e?e:ui.linking.symbol.value())},
this._processSymbol=async(e,t)=>{if(void 0===this._continuousFrontContractExtractor)return void this._value.next({symbol:t});const i=this._continuousFrontContractExtractor.makeValueObservable(t).subscribe((e=>this._value.next(e)));null==e||e.addEventListener("abort",(()=>i.unsubscribe()),{once:!0})},this._getContinuousFrontContractExtractor=e;const t=ui.linking.proSymbol.value();this._value=new f.BehaviorSubject({symbol:t});void 0!==(this._continuousFrontContractExtractor=e())&&this._onSymbolChange(t),this._processSymbol=(0,$.respectLatest)(this._processSymbol),ui.linking.proSymbol.subscribe(this._onSymbolChange)}reset(){this._continuousFrontContractExtractor=this._getContinuousFrontContractExtractor(),this._onSymbolChange(ui.linking.proSymbol.value())}value(){return this._value.getValue()}async setSymbol(e){const t=(0,ri.firstValueFrom)(this._value.pipe((0,ti.filter)((t=>t.continuous===e||void 0===t.continuous&&t.symbol===e))));ui.linking.symbol.setValue(e),await t}valueObservable(){return this._value.asObservable()}}class pi{constructor(){this._title$=new f.BehaviorSubject(""),this._description$=new f.BehaviorSubject(void 0),this._symbol$=new f.BehaviorSubject(""),this._hasBatsQuotes$=new f.BehaviorSubject(!1),this._hasDelayedQuotes$=new f.BehaviorSubject(!1),this._isTradable$=new f.BehaviorSubject(!1),this._backFunction$=new f.BehaviorSubject(void 0),this._closeFunction$=new f.BehaviorSubject(void 0),this._cancelFunction$=new f.BehaviorSubject(void 0),this._informerMessage$=new f.BehaviorSubject(void 0),this._settings$=new f.BehaviorSubject(void 0),this.title$=this._title$.asObservable(),this.description$=this._description$.asObservable(),this.symbol$=this._symbol$.asObservable(),this.hasBatsQuotes$=this._hasBatsQuotes$.asObservable(),this.hasDelayedQuotes$=this._hasDelayedQuotes$.asObservable(),this.isTradable$=this._isTradable$.asObservable(),this.backFunction$=this._backFunction$.asObservable(),this.closeFunction$=this._closeFunction$.asObservable(),this.cancelFunction$=this._cancelFunction$.asObservable(),this.informerMessage$=this._informerMessage$.asObservable(),this.settings$=this._settings$.asObservable()}setTitle(e){this._title$.next(e)}setDescription(e){this._description$.next(e)}setSymbol(e){this._symbol$.next(e)}setHasBatsQuotes(e){this._hasBatsQuotes$.next(e)}setHasDelayedQuotes(e){this._hasDelayedQuotes$.next(e)}setIsTradable(e){this._isTradable$.next(e)}setBackFunction(e){this._backFunction$.next(e)}setCloseFunction(e){this._closeFunction$.next(e)}setCancelFunction(e){this._cancelFunction$.next(e)}setInformerMessage(e){this._informerMessage$.next(e)}setSettings(e){this._settings$.next(e)}}class mi{constructor(e){this._transientStorage={},this._persistentStorageKey=`trading.${e}`;const t=o.getJSON(this._persistentStorageKey,{});delete t.orderTicketQuantity,this._transientStorage=t}setTakeProfitPips(e,t,i){this._setPips("takeProfit",e,t,i)}takeProfitPips(e){return this._getSectionValue("takeProfit",e)}setStopLossPips(e,t,i){this._setPips("stopLoss",e,t,i)}stopLossPips(e){
return this._getSectionValue("stopLoss",e)}setDuration(e,t,i){const r=this.duration(e,t);null!==i&&void 0!==r&&r.type===i.type&&r.datetime===i.datetime||null===i&&void 0===r||(this._setDuration(e,t,i),this._syncStorage())}duration(e,t){var i;return this._migrateDuration(e,t),null===(i=this._getSectionValue("duration",e))||void 0===i?void 0:i[t]}setSymbolQty(e,t){this._getOrCreateSection("qty")[e]=t,this._syncStorage()}symbolQty(e){return this._getSectionValue("qty",e)}setCustomFields(e,t,i){var r,s,o;const n=this._getOrCreateSection("customFields");null!==(r=n[e])&&void 0!==r||(n[e]={}),null!==(s=(o=n[e])[t])&&void 0!==s||(o[t]={});const a=n[e][t];for(const[e,t]of Object.entries(i))"string"==typeof t&&""!==t||"boolean"==typeof t?a[e]=t:delete a[e];0===Object.keys(a).length&&delete n[e][t],0===Object.keys(n[e]).length&&delete n[e],this._syncStorage()}customFields(e,t,i){this._migrateCustomFields(e,t,i);const r={},s=this._transientStorage.customFields;if(void 0===s||void 0===s[e])return r;const o=s[e][t];return void 0===o||i.forEach((e=>{const t=o[e];""!==t&&void 0!==t&&(r[e]=t)})),r}orderType(e){return this._getSectionValue("orderType",e)}setOrderType(e,t){this._getOrCreateSection("orderType")[e]=t,this._syncStorage()}setTableColumnsOrder(e,t){this._getOrCreateSection("tableColumnsOrder")[e]=t,this._syncStorage()}tableColumnsOrder(e){return this._getSectionValue("tableColumnsOrder",e)}summaryFieldsVisibilityInfo(){const e=new Map,t=this._transientStorage.summaryFields;if(void 0===t)return e;for(const[i,r]of Object.entries(t))e.set(i,{id:i,visible:r});return e}setSummaryFieldsVisibilityInfo(e){e.forEach((({id:e,visible:t})=>{this._getOrCreateSection("summaryFields")[e]=t})),this._syncStorage()}_getOrCreateSection(e){return e in this._transientStorage||(this._transientStorage[e]={}),this._transientStorage[e]}_getSectionValue(e,t){const i=this._transientStorage[e];return void 0!==i?i[t]:void 0}_removeValue(e,t){const i=this._transientStorage[e];void 0!==i&&(delete i[t],0===Object.keys(i).length&&delete this._transientStorage[e])}_setPips(e,t,i,r){const s=this._getSectionValue(e,t);if(!(void 0!==s&&s===i||void 0===s&&i===r)){if(void 0!==s&&i===r)this._removeValue(e,t);else{this._getOrCreateSection(e)[t]=i}this._syncStorage()}}_setDuration(e,t,i){var r;const s=this._getOrCreateSection("duration");if(null===i){if(void 0===s[e])return;return delete s[e][t],void(0===Object.keys(s[e]).length&&delete s[e])}null!==(r=s[e])&&void 0!==r||(s[e]={}),s[e][t]=i}_migrateCustomFields(e,t,i){const r={},s=this._transientStorage.customFields;void 0===s||"object"==typeof s&&void 0!==s[e]||(i.forEach((t=>{const i=s[`${e}.${t}`];""!==i&&void 0!==i&&(r[t]=i,this._removeValue("customFields",`${e}.${t}`))})),this.setCustomFields(e,t,r))}_migrateDuration(e,t){const i=this._getSectionValue("duration",e);if("string"!=typeof i)return;const r={type:i},s=this._getSectionValue("durationDatetime",e);"number"==typeof s&&(r.datetime=s,this._removeValue("durationDatetime",e)),this._removeValue("duration",e),this._setDuration(e,t,r),this._syncStorage()}
_syncStorage(){o.setJSON(this._persistentStorageKey,this._transientStorage)}}var _i=i(951983),gi=i(472382),bi=i(198083);const vi=(0,c.getLogger)("Trading.Core"),yi={1:"Connected",2:"Connecting",3:"Disconnected",4:"Error"},fi="alert/alarm_clock";function ki(e){return g().some((t=>e===t.path))}const Pi=R.enabled("buy_sell_buttons"),Si=!0,Ci=(window.TRADING_SERVER_LOGGER_URL,"Shortcut");class wi{constructor(e,t){this.accountType=new d.WatchedValue,this.onBrokerChange=new q.Delegate,this.onBrokerLoading=new q.Delegate,this.onConnectionStatusChange=new q.Delegate,this.onNewNotification=new q.Delegate,this.onNeedSelectBroker=new q.Delegate,this.onNotificationsChanged=new q.Delegate,this.showTradedSources=new d.WatchedValue(!0),this.showSellBuyButtons=new d.WatchedValue,this.noConfirmEnabled=new d.WatchedValue,this.showOnlyRejectionNotifications=new d.WatchedValue,this.showPricesWithZeroVolume=new d.WatchedValue,this.showSpread=new d.WatchedValue,this.orderExecutedSoundParams=function(){const e=ki(fi)?fi:g()[0].path;return{enabled:new d.WatchedValue(!1),path:new d.WatchedValue(e)}}(),this._activeBroker=null,this._orderViewController=null,this._orderControllerPromise=null,this._brokerCommandsUI=null,this._showPricesWithZeroVolume=new d.WatchedValue,this._showSpread=new d.WatchedValue,this._closePositionDialogVisibility=new Q.DialogVisibility,this._orderDialogVisibility=new Q.DialogVisibility,this._loginDialogVisibility=new Q.DialogVisibility,this._tradingPanelPopupVisibility=new Q.DialogVisibility,this._tradingSettingsStorage=null,this._offlineListener=this._offlineHandler.bind(this),this._onlineListener=this._onlineHandler.bind(this),this._notifications=[],this._account=null,this._domPanelVisibility=new d.WatchedValue(!1),this._orderPanelVisibility=new d.WatchedValue(!1),this._pipValueType$=new f.BehaviorSubject(I.PipValueType.None),this._switchingBroker=!1,this._isReconnectNeeded=!1,this._accountVerificationPromise=null,this._chartWidgetCollection=null,this._tradedItemsChartCollectionFacadePromise=null,this._tradeNowBrokerId=null,this.getBrokerTradingSettingsStorage=()=>this._tradingSettingsStorage,this.trackEvent=(e,t,i)=>{const r=e?`[${e}] ${t}`:t;if(this._gui()){const e=this._activeBroker?this._activeBroker.metainfo().id+" Trading":"Trading No Broker",t=this._activeBroker?this._activeBroker.currentAccountType():void 0;this._gui().trackEvent(e,r,i||t)}},this.setDOMPanelVisibility=e=>{e?this.tradingPanel.openPage(z.TradingPage.DOMPanel):this.tradingPanel.close()},this.setOrderPanelVisibility=async e=>{const{openPanel:t,closePanel:i}=await this._getOrderViewController();e?await t():await i()},this.getTradeNowBrokerId=()=>this._tradeNowBrokerId,this.clearTradeNowBrokerId=()=>{this._tradeNowBrokerId=null},this.toggleTradingPanelVisibility=async()=>{const e=this._orderDialogVisibility.getValue().isVisible,t=this.tradingPanel.isOpened.value();e?this.setDOMPanelVisibility(!t):this._updateTradingPanelVisibility({isOpened:!t})},this._handleVisibilityChange=()=>{
null!==this._activeBroker&&this._activeBroker.metainfo().configFlags.usesWSConnection&&"visible"!==document.visibilityState&&(this._isReconnectNeeded=!0,this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!1,disconnectInfo:{disconnectType:I.DisconnectType.BrokenConnection}}).then((()=>{if(this._isReconnectNeeded)return this._tryReconnectLastBroker()})))},this._tryReconnectLastBroker=async()=>{if(this._isReconnectNeeded){if("hidden"===document.visibilityState)return window.addEventListener("visibilitychange",this._tryReconnectLastBroker,{once:!0});this._isReconnectNeeded=!1,await this._selectLastBroker()}},this._onCurrentAccountUpdate=()=>{const e=(0,r.ensureNotNull)(this._activeBroker).currentAccount();this._account!==e&&(this._tradedContextLinking.clear(),this._account=e,this.onNotificationsChanged.fire(this.getNotifications()))},this._onFullScreenDialogOpen=()=>{this._guiAccessor.closeAllNotifications()},this._setPipValueType=async()=>{const{symbol:e}=this._linking.value(),{type:t}=await this._realtimeProvider.symbolInfo(e),i="forex"===t?I.PipValueType.Pips:I.PipValueType.Ticks;this._pipValueType$.next(i)},this._trackNonTradableSymbol=async()=>{var e;if(1===(null===(e=this._activeBroker)||void 0===e?void 0:e.connectionStatus())){const{symbol:e}=this._linking.value();if(void 0===e)return;const t=await this._activeBroker.isTradable(e);t&&!t.tradable&&this.trackEvent("Symbol is not tradable",e)}},this._onBrokerChanged=e=>{if(null===e)return void(this._tradingSettingsStorage=null);const t=e.metainfo();this._tradingSettingsStorage=new mi(t.id)},this._tradeNow=async()=>{if(void 0!==window.TradingView.bottomWidgetBar&&null!==this._tradeNowBrokerId)try{await window.TradingView.bottomWidgetBar.toggleWidget("paper_trading",!0)}catch(e){this._tradingWizard.drawAttention()}},this._updateTradingPanelVisibility=e=>{const{isOpeningAvailable:t=this.tradingPanel.isOpeningAvailable.value(),isOpened:i=this.tradingPanel.isOpened.value(),activePage:r=this.tradingPanel.activePage.value()}=e,s=t&&i;r===z.TradingPage.OrderPanel?this.setOrderPanelVisibility(s):this.setDOMPanelVisibility(s)},this._toggleTradingPanelPage=e=>{},this._linking=new hi((()=>this._continuousFrontContractExtractor)),this._setPipValueType=(0,V.sequentialize)(this._setPipValueType),this._selectBrokerInternal=(0,V.sequentialize)(this._selectBroker),void 0!==navigator.locks&&(this._selectBrokerInternal=e=>navigator.locks.request(`select-broker-${e.brokerId}`,{ifAvailable:!0},(t=>this._selectBroker({...e,hasConcurrentSession:null===t})))),this._showSellBuyButtonsKey=this._makeShowSellBuyButtonsKey(),this._resizerBridge=e,this._realtimeProvider=new X((()=>this.activeBroker()),this.onBrokerChange,this.onConnectionStatusChange,(e=>this.getActualSymbol(e))),this._positionService=new Qe.PositionsService(this),this._ordersService=new ze.OrdersService(this),this._tradingStat=new te(this),this._serverLogger=null,this._tradedContextLinking=new di,this.onBrokerChange.subscribe(this,this._onBrokerChanged),this.tradingPanelPopup=new zt(this),
this.tradingPanelPopup.visible().subscribe((e=>{e?(this._tradingPanelPopupVisibility.setValue({isVisible:e,isFullScreen:!0}),this._onFullScreenDialogOpen()):this._tradingPanelPopupVisibility.setValue({isVisible:e})}));this.tradingPanel=new Oe(e,null);this._qtySuggester=new li({onResetNeeded:this.onConnectionStatusChange,symbolInfoGetter:e=>this._realtimeProvider.symbolInfo(e),qtySettingsStorageGetter:()=>this._tradingSettingsStorage});const i=new Ce(e,(()=>this.tradingPanel.close()),this,this._qtySuggester,this._linking,new pi);this.tradingPanel.addPage(z.TradingPage.DOMPanel,i),this._orderPanelHeaderState=new pi;const s=new we(this._orderPanelHeaderState);this.tradingPanel.addPage(z.TradingPage.OrderPanel,s);{const e=o.getValue(j.settingsKeys.TRADING_PANEL_ACTIVE_PAGE),t=o.getBool(j.settingsKeys.TRADING_PANEL_OPENED,R.enabled("show_order_panel_on_start"));this._updateTradingPanelVisibility({isOpened:t,activePage:e}),this.tradingPanel.isOpeningAvailable.subscribe((async e=>{this._updateTradingPanelVisibility({isOpeningAvailable:e})}))}(0,W.combine)((()=>({})),this.tradingPanel.activePage.weakReference(),this.tradingPanel.isOpened.weakReference()).subscribe((()=>{this._domPanelVisibility.setValue(this.tradingPanel.isPageOpened(z.TradingPage.DOMPanel)),this._orderPanelVisibility.setValue(this.tradingPanel.isPageOpened(z.TradingPage.OrderPanel))})),this.closePositionDialogVisibility=this._closePositionDialogVisibility.value$,this.orderDialogVisibility=this._orderDialogVisibility.value$,this.loginDialogVisibility=this._loginDialogVisibility.value$,this.possibleFullScreenDialogsVisibility=(0,k.merge)(this.closePositionDialogVisibility.pipe((0,P.map)((e=>({...e,name:"close-position-dialog"})))),this.orderDialogVisibility.pipe((0,P.map)((e=>({...e,name:"order-dialog"})))),this.loginDialogVisibility.pipe((0,P.map)((e=>({...e,name:"login-dialog"})))),this._tradingPanelPopupVisibility.value$.pipe((0,P.map)((e=>({...e,name:"trading-panel-popup"})))))}setChartWidgetCollection(e){(0,r.assert)(null===this._chartWidgetCollection,"ChartWidgetCollection can be set only once"),this._chartWidgetCollection=e,this._guiAccessor=new ne(e),new Ae(this),this._loadState(),o.onSync.subscribe(this,this._loadState);const t=()=>{this._save()};this.showSellBuyButtons.subscribe(t),this.noConfirmEnabled.subscribe(t),this.showOnlyRejectionNotifications.subscribe(t),this._showPricesWithZeroVolume.subscribe(t),this._showSpread.subscribe(t),this.orderExecutedSoundParams.enabled.subscribe(t),this.orderExecutedSoundParams.path.subscribe(t),window.addEventListener("offline",this._offlineListener),window.addEventListener("online",this._onlineListener),this.bindShortcuts(),this._tradedItemsChartCollectionFacadePromise=this._createTradedItemsChartCollectionFacade(e),this._registerCustomSources(e),this._registerCustomWidgets(e)}showPricesWith(){return{zeroVolume:this._showPricesWithZeroVolume,spread:this._showSpread}}domPanelVisibility(){return this._domPanelVisibility}orderPanelVisibility(){return this._orderPanelVisibility}realtimeProvider(){
return this._realtimeProvider}toggleTradingPanelPopup(){this.tradingPanelPopup.visible().value()?this.tradingPanelPopup.hide():this.tradingPanelPopup.show()}toggleTradingWidget(){return window.TradingView.bottomWidgetBar?window.TradingView.bottomWidgetBar.activateTradingTab():Promise.resolve()}toggleMinimizeBottomWidgetBar(){if(window.TradingView.bottomWidgetBar)return window.TradingView.bottomWidgetBar.toggleMinimize()}bottomWidgetBarMode(){if(!window.TradingView.bottomWidgetBar)throw new Error("Unable to provide bottom widget mode: bottomWidgetBar undefined");return window.TradingView.bottomWidgetBar.mode()}tradingWizard(){return this._tradingWizard}showTradingProperties(){this._gui()&&this._gui().showTradingProperties()}linking(){return this._linking}brokersList(){return H.brokersList()}brokersPlans(){return this._getBrokerPlans()}activeBroker(){return this._activeBroker}brokerCommandsUI(){return this._brokerCommandsUI}async selectBroker(e,t){await this._selectBrokerInternal({brokerId:e,isUserAction:!0,keepSessionAlive:t})}async pickDefaultBroker(){if(this._activeBroker)return;let e=null;const t=this.brokersList().filter((e=>!e.configFlags.isSuspended));if(1===t.length)e=t[0].id;else{const i=await Ht.get();i&&t.some((e=>e.id===i))&&(e=i)}e&&this._selectBrokerInternal({brokerId:e,isUserAction:!1})}async makeNewOrderContextMenuAction(e,t,r){const o=await this._qtySuggester.getQty(e);return{name:"trade-new-order",action:()=>{const{symbol:i}=this._linking.value();i!==e&&this._linking.setSymbol(e),this.trackEvent(t,"New Order"),this._checkAndOpenOrderDialog({symbol:e,qty:o,limitPrice:r,stopPrice:r})},text:(0,A.appendEllipsis)(s.t(null,void 0,i(967498))),statName:"NewOrder",shortcutHint:(0,a.humanReadableHash)(n.Modifiers.Shift+84)}}async defaultContextMenuActions(e,{onlyMainActions:t=!1,gaOrigin:r="Chart Context Menu",hideNotExecutableAction:o=!1}={}){const{symbol:n}=await this.getActualSymbol(e.symbol),a=(await Promise.all([this._makeSubActions(n,e,r,o),this.makeNewOrderContextMenuAction(n,r,e.value||void 0)])).flat();return!t&&R.enabled("property_pages")&&(a.push({separator:!0}),a.push({name:"trade-properties",action:()=>{this.trackEvent(r,"Trading Properties"),this.showTradingProperties()},text:(0,A.appendEllipsis)(s.t(null,void 0,i(873503))),icon:_i,statName:"Properties"})),a}defaultDropdownMenuActions(e){const t="Bottom Panel Dropdown",r=[],o=this.activeBroker(),n=e||{tradingProperties:!0,restoreConfirmations:o&&o.metainfo().configFlags.supportConfirmations};return R.enabled("property_pages")||(n.tradingProperties=!1),n.tradingProperties&&r.push({action:()=>{this.showTradingProperties(),this.trackEvent(t,"Trading Properties")},text:(0,A.appendEllipsis)(s.t(null,void 0,i(873503))),icon:_i}),n.restoreConfirmations&&r.push({action:()=>{this._showRestoreConfirmations(),this.trackEvent(t,"Restore confirmations")},text:(0,A.appendEllipsis)(s.t(null,void 0,i(102653)))}),r}chartContextMenuActions(e,t){
return(this._activeBroker&&1===this._activeBroker.connectionStatus()?this._activeBroker.chartContextMenuActions(e,t):this.defaultContextMenuActions(e,t)).then((e=>(0,L.convertActionDescriptionsToActions)(e)))}connectStatus(){return this._activeBroker?this._activeBroker.connectionStatus():3}bindShortcuts(){if(this._hotkeys)return;this._hotkeys=n.createGroup({desc:"Trading"});const e=async e=>{const{symbol:t}=this._linking.value(),i={qty:await this._qtySuggester.getQty(t),side:e,symbol:t,type:2,seenPrice:null};this.trackEvent(Ci,-1===e?"Sell":"Buy",this._getInstantTradingEventLabel()),this._checkAndPlaceOrder(i)};this._hotkeys.add({desc:"Buy",hotkey:n.Modifiers.Shift+66,handler:()=>e(1)}),this._hotkeys.add({desc:"Sell",hotkey:n.Modifiers.Shift+83,handler:()=>e(-1)});const t=R.enabled("order_panel"),i=R.enabled("dom_widget");t&&this._hotkeys.add({desc:"Open/close Order Panel",hotkey:n.Modifiers.Shift+84,handler:()=>{if(!this.tradingPanel.isOpeningAvailable.value())return;const e=this.tradingPanel.isOpened.value()&&this.tradingPanel.activePage.value()===z.TradingPage.OrderPanel;this.trackEvent(Ci,e?"Close OT":"Open OT",this._getInstantTradingEventLabel()),this.setOrderPanelVisibility(!e)}}),i&&this._hotkeys.add({desc:"Open/close DOM",hotkey:n.Modifiers.Shift+68,handler:()=>{if(!this.tradingPanel.isOpeningAvailable.value())return;const e=this.tradingPanel.isOpened.value()&&this.tradingPanel.activePage.value()===z.TradingPage.DOMPanel;this.trackEvent(Ci,e?"Close DOM":"Open DOM",this._getInstantTradingEventLabel()),this.setDOMPanelVisibility(!e)}})}formatter(e){return this.realtimeProvider().formatter(e)}showSuccessNotification(e,t,i=1e4){this.showOnlyRejectionNotifications.value()||this._showNotification(e,t,"success",i),R.enabled("show_trading_notifications_history")&&this._addNotificationRow(e,t,"success",i),this._log(e,t)}showErrorNotification(e,t,i=25e3){this._showNotification(e,t,"danger",i),R.enabled("show_trading_notifications_history")&&this._addNotificationRow(e,t,"danger",i),this._log(e,t)}getNotifications(){return this._notifications.filter((e=>e.account===this._account&&e.broker===(this._activeBroker?this._activeBroker.metainfo().id:null)))}orderViewController(){return(0,r.ensureNotNull)(this._orderViewController)}tradingStat(){return this._tradingStat}async verifyBrokerLiveAccount(){return this._verifyLiveAccount(),null!==this._accountVerificationPromise?this._accountVerificationPromise:Promise.reject("Account verification is not needed")}pipValueType(){return this._pipValueType$.asObservable()}tradedItemsChartCollectionFacade(){return(0,r.ensureNotNull)(this._tradedItemsChartCollectionFacadePromise)}async checkRealtimeDataPermissions(){const e=(0,r.ensureNotNull)(this._activeBroker);await checkRealtimeDataSubscription(e.metainfo().id,e.getRealtimeDataCheckParams())&&this._guiAccessor.reconnectChartApi(!0)}async removeRealtimeDataPermissions(){await removeRealtimeDataSubscription((0,r.ensureNotNull)(this._activeBroker).metainfo().id)&&this._guiAccessor.reconnectChartApi(!0)}makeActualSymbolObservable(e){
var t,i;return null!==(i=null===(t=this._continuousFrontContractExtractor)||void 0===t?void 0:t.makeValueObservable(e))&&void 0!==i?i:(0,S.of)({symbol:e})}async getActualSymbol(e){return void 0===this._continuousFrontContractExtractor?{symbol:e}:this._continuousFrontContractExtractor.makeValue(e)}getQtySuggester(){return this._qtySuggester}_getInstantTradingEventLabel(){return this.noConfirmEnabled.value()?"Instant":"Not Instant"}async _getOrderViewController(){return null!==this._orderViewController?this._orderViewController:(await this._createOrderController(),this._getOrderViewController())}async _selectBroker(e){var t,r;const{brokerId:o,isUserAction:n,keepSessionAlive:a=!1,disconnectInfo:l,hasConcurrentSession:c}=e;if(this._switchingBroker)return void vi.logWarn(`Broker is already selected, but a new broker id: ${o} was received.`);if(o!==(this._activeBroker?this._activeBroker.metainfo().id:null)){if(null===(t=this._linkingSubscription)||void 0===t||t.unsubscribe(),this._destroyContinuousFrontContractTrading(),this._activeBroker){const e=this._activeBroker&&this._activeBroker.disconnectWarningMessage(),t=()=>this._showReviewDialogIfNeeded(3,{disconnectType:I.DisconnectType.LogOut});if(null!==e&&window.is_authenticated){if(!await(0,me.showSimpleConfirmDialog)({title:s.t(null,void 0,i(349391)),text:e,mainButtonText:s.t(null,void 0,i(162058)),mainButtonIntent:"danger",cancelButtonText:s.t(null,void 0,i(620036)),onConfirm:()=>{t(),this._logOut(n,a,l)},onCancel:()=>{t()}}))return}else t(),this._logOut(n,a,l)}if(null!=o){let e;this._tradeNowBrokerId=null,this._switchingBroker=!0;try{const t=await H.createBrokerConnection(this,o,this._serverLogger,null,e),{isMaintenance:i,message:r}=await t.maintenanceStatus();if(i){if(!await this._showBrokerSideMaintenanceWarning(t.metainfo().id,r))return this._switchingBroker=!1,void t.disconnect(!0)}0,await this._initBroker(t,a)}catch(e){this._switchingBroker=!1,vi.logError((0,M.getLoggerMessage)(e))}}else n&&setTimeout((()=>{Ht.clear()})),this.onBrokerChange.fire(null),null===(r=this._closePositionDialogVisibilitySubscription)||void 0===r||r.unsubscribe(),this._brokerCommandsUI=null}else vi.logWarn(`${o} is already selected.`)}_destroyContinuousFrontContractTrading(){}async _initContinuousFrontContractTrading(){}_makeBrokerDependantWarningMessageObservable(e){let t,i=async(t,i)=>{const{tradable:r}=await(0,$.respectAbort)(t,e.isTradable(i));return r};i=(0,$.respectLatest)(i);try{t=e.currentAccount()}catch(e){}const r=(0,C.fromEventPattern)((t=>e.currentAccountUpdate.subscribe(null,t)),(t=>e.currentAccountUpdate.unsubscribe(null,t))).pipe((0,w.startWith)(t)),s=(0,C.fromEventPattern)((t=>e.connectionStatusUpdate.subscribe(null,t)),(t=>e.connectionStatusUpdate.unsubscribe(null,t))).pipe((0,w.startWith)(e.connectionStatus()));return(0,B.combineLatest)({value:this._linking.valueObservable(),currentAccountUpdate:r,connectionStatusUpdate:s}).pipe((0,T.mergeMap)((({value:e})=>(0,B.combineLatest)({isTradable:(0,E.from)(i(null,e.symbol)).pipe((0,w.startWith)(!1),(0,
O.catchError)((()=>D.EMPTY))),value:(0,S.of)(e)}))),(0,P.map)((e=>e.isTradable?e.value.warning:void 0)))}async _initBroker(e,t){this._activeBroker=e,this._activeBroker.connectionStatusUpdate.subscribe(this,this._connectionListener),this._activeBroker.currentAccountUpdate.subscribe(this,this._onCurrentAccountUpdate),this._realtimeProvider.onStatusChanged.subscribe(null,this._setPipValueType),this._realtimeProvider.onStatusChanged.subscribe(null,this._trackNonTradableSymbol),await this._initContinuousFrontContractTrading(),this._linkingSubscription=this._linking.valueObservable().subscribe((()=>{this._setPipValueType(),this._trackNonTradableSymbol()})),this._brokerCommandsUI=new Se({activeBroker:this._activeBroker,guiAccessor:this._guiAccessor,noConfirmEnabled:this.noConfirmEnabled,orderViewController:this._getOrderViewController.bind(this),showErrorNotification:this.showErrorNotification.bind(this),trackEvent:this.trackEvent,tradingLinking:this._linking}),this._closePositionDialogVisibilitySubscription=this._brokerCommandsUI.closePositionDialogVisibility.subscribe(this._makeDialogVisibilityHandler(this._closePositionDialogVisibility)),this._activeBroker.tryRestoreSession(),await Ht.set(this._activeBroker.metainfo().id),this.onBrokerChange.fire(this._activeBroker),this._getOrderViewController(),this._updateConnectionStatus(this.connectStatus()),this._switchingBroker=!1}async _showBrokerSideMaintenanceWarning(e,t){return(0,me.showSimpleConfirmDialog)({title:s.t(null,{replace:{brokerId:e}},i(103718)),text:null!=t?t:s.t(null,void 0,i(536263)),cancelButtonText:s.t(null,void 0,i(620036)),mainButtonIntent:"primary",mainButtonText:s.t(null,void 0,i(891268)),showBackdrop:!0})}_makeDialogVisibilityHandler(e){return t=>{e.setValue(t),t.isFullScreen&&this._onFullScreenDialogOpen()}}_gui(){return this._guiAccessor}_addNotificationRow(e,t,i,r){const s={id:this._notifications.length,account:this._account,broker:this._activeBroker?this._activeBroker.metainfo().id:null,time:new Date,title:e,text:t,type:i};this._notifications.push(s),this.onNewNotification.fire(s)}_offlineHandler(){this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!1,disconnectInfo:{disconnectType:I.DisconnectType.Offline}}),vi.logNormal("The connection to the Internet was interrupted")}async _onlineHandler(){await this._selectLastBroker()&&vi.logNormal("The connection to the Internet was restored")}_showNotification(e,t,i,r){this._gui()&&this._gui().showNotification(e,t,i,r)}_showReviewDialogIfNeeded(e,t){if(null===this._activeBroker)return;this._activeBroker}_connectionListener(e,t){const i=this.connectStatus();this._showReviewDialogIfNeeded(e,t);const r=this._isReconnectNeeded=(null==t?void 0:t.disconnectType)===I.DisconnectType.BrokenConnection;3!==e||(null==t?void 0:t.disconnectType)!==I.DisconnectType.LogOut&&!this._isReconnectNeeded||this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!1,disconnectInfo:t}).then((()=>{if(this._isReconnectNeeded)return this._tryReconnectLastBroker()})),
(null==t?void 0:t.disconnectType)===I.DisconnectType.CancelAuthorization&&this.trackEvent("Signin","OAuth popup closed","By user"),(null==t?void 0:t.disconnectType)===I.DisconnectType.TimeOutForAuthorization&&this.trackEvent("Signin","OAuth popup closed","By timeout"),this._updateConnectionStatus(i,!r,t)}async _selectLastBroker(){const e=await Ht.get();return null!==e&&(await this._selectBrokerInternal({brokerId:e,isUserAction:!1}),!0)}_updateOrderPanelSpinnerState(){const e=this._orderViewController,t=2===this.connectStatus(),i=null!==e&&e.stateChanging.value();this.tradingPanel.isLoading.setValue(t||i)}async _updateConnectionStatus(e,t=!0,i){var r;this._updateOrderPanelSpinnerState(),this.onConnectionStatusChange.fire(e,i),this._log("Connection status",yi[e]);this._activeBroker;if(t){const e=null===(r=this._activeBroker)||void 0===r?void 0:r.metainfo().id;void 0!==e?await Ht.set(e):Ht.clear()}null!==this._activeBroker?1===e?(this._account=this._activeBroker.currentAccount(),this._guiAccessor.setBroker(this._activeBroker)):this._tradedContextLinking.clear():(this._accountVerificationPromise=null,this._guiAccessor.setBroker(null),this._tradedContextLinking.clear())}async _checkOrRemoveRealtimeDataIfNeeded(e){if(!e.configFlags.supportRealtimeDataCheck)return;const{realtimeDataPermissionsToggleConfig:t}=e;if(void 0===t)return void this.checkRealtimeDataPermissions();const r=`${j.settingsKeys.REALTIME_DATA_ACCEPTED}.${e.id}`;switch(o.getValue(r)){case"true":return void this.checkRealtimeDataPermissions();case"false":return void this.removeRealtimeDataPermissions();default:const e=await showSimpleConfirmDialogWithSolutionLink({title:t.enableRealtimeDataPermissionsTitleText,text:t.enableRealtimeDataPermissionsToggleText,mainButtonText:s.t(null,void 0,i(83453)),cancelButtonText:s.t(null,void 0,i(546472)),showCloseButton:!1,closeOnOutsideClick:!1,mainButtonIntent:"primary",closeOnEscapePress:!1,solutionId:t.solutionId,showBackdrop:!0,closeOnBackDropClick:!1});e?await this.checkRealtimeDataPermissions():await this.removeRealtimeDataPermissions(),o.setValue(r,e)}}_verifyLiveAccount(){(0,r.ensureNotNull)(this._activeBroker)}_save(){const e=o.getJSON(j.settingsKeys.PROPERTIES,{});o.setJSON(j.settingsKeys.PROPERTIES,{...e,[this._showSellBuyButtonsKey]:+!!this.showSellBuyButtons.value(),noConfirmEnabled:+!!this.noConfirmEnabled.value(),qweqrq:+!!this.showOnlyRejectionNotifications.value(),showPricesWithZeroVolume:+!!this._showPricesWithZeroVolume.value(),showSpread:+!!this._showSpread.value(),orderExecutedSoundParams:JSON.stringify({enabled:+!!this.orderExecutedSoundParams.enabled.value(),name:this.orderExecutedSoundParams.path.value()})})}_loadState(){const e=o.getJSON(j.settingsKeys.PROPERTIES,{}),t=e[this._showSellBuyButtonsKey];if(this.showSellBuyButtons.setValue(void 0!==t?!!t:Si),this.noConfirmEnabled.setValue(!!e.noConfirmEnabled),this.showOnlyRejectionNotifications.setValue(!!e.qweqrq),this._showPricesWithZeroVolume.setValue(!e.hasOwnProperty("showPricesWithZeroVolume")||Boolean(e.showPricesWithZeroVolume)),
this._showSpread.setValue(!e.hasOwnProperty("showSpread")||Boolean(e.showSpread)),e.hasOwnProperty("orderExecutedSoundParams")){const t=JSON.parse(e.orderExecutedSoundParams);this.orderExecutedSoundParams.enabled.setValue(!!t.enabled),this.orderExecutedSoundParams.path.setValue(ki(t.name)?t.name:this.orderExecutedSoundParams.path.value())}}_makeShowSellBuyButtonsKey(){return"showSellBuyButtons"}_log(e,t){vi.logNormal(`${this._activeBroker?this._activeBroker.metainfo().id+" Trading: ":""}${e} - ${t}`)}_makeSureCanTrade(){const e=this.activeBroker(),t=this.brokerCommandsUI();return e&&t?1===e.connectionStatus()||(this.toggleTradingWidget(),!1):(this.toggleTradingWidget().then((()=>this.onNeedSelectBroker.fire())),!1)}_checkAndPlaceOrder(e,t=!0){this._makeSureCanTrade()&&(0,r.ensureNotNull)(this.brokerCommandsUI()).placeOrder(e,t)}_checkAndOpenOrderDialog(e){this._makeSureCanTrade()&&(0,r.ensureNotNull)(this.brokerCommandsUI()).placeOrder(e)}_makeSubAction({symbol:e,side:t,orderType:r,orderPrices:o,currentQuotes:n,qty:a,gaOrigin:l}){const c=1===t?bi:gi,d=1===t?"Buy":"Sell",u=1===r?"Limit":3===r?"Stop":"StopLimit",h=function(e){return"altPrice"in e&&"formattedAltPrice"in e}(o),p=e.split(":")[1],m=d+u,_={BuyLimit:s.t(null,void 0,i(302122)).format({symbol:p,qty:(0,F.abbreviatedNumber)(a),value:o.formattedPrice}),SellStop:s.t(null,void 0,i(627392)).format({symbol:p,qty:(0,F.abbreviatedNumber)(a),value:o.formattedPrice}),SellLimit:s.t(null,void 0,i(476678)).format({symbol:p,qty:(0,F.abbreviatedNumber)(a),value:o.formattedPrice}),BuyStop:s.t(null,void 0,i(255481)).format({symbol:p,qty:(0,F.abbreviatedNumber)(a),value:o.formattedPrice})};return h&&(_.SellStopLimit=s.t(null,void 0,i(194240)).format({symbol:p,qty:(0,F.abbreviatedNumber)(a),value:o.formattedPrice,altValue:o.formattedAltPrice}),_.BuyStopLimit=s.t(null,void 0,i(353343)).format({symbol:p,qty:(0,F.abbreviatedNumber)(a),value:o.formattedPrice,altValue:o.formattedAltPrice})),{name:`trade-${d}-${u}`.toLowerCase(),action:()=>{this.trackEvent(l,`${d} ${u}`);const i=1===r?"limitPrice":"stopPrice",s=1===t?null==n?void 0:n.ask:null==n?void 0:n.bid,c={qty:a,side:t,symbol:e,type:r,seenPrice:null!=s?s:null,currentQuotes:n};null!==o.price&&(c[i]=o.price),4===r&&h&&(c.limitPrice=o.altPrice),this._checkAndPlaceOrder(c)},icon:c,text:_[m],statName:m}}_createOrderController(){return null===this._orderControllerPromise&&(this._orderControllerPromise=Promise.all([i.e(5765),i.e(660)]).then(i.bind(i,362042)).then((({OrderViewController:e})=>new e({resizerBridge:this._resizerBridge,onNeedSelectBroker:this.onNeedSelectBroker,realtimeProvider:this.realtimeProvider(),pipValueType$:this.pipValueType(),trackEvent:this.trackEvent,toggleTradingWidget:this.toggleTradingWidget.bind(this),toggleTradingPanelPopup:this.toggleTradingPanelPopup.bind(this),showErrorNotification:this.showErrorNotification.bind(this),getTradingSettingsStorage:()=>this._tradingSettingsStorage},{container:this.tradingPanel.container,isOpened:this.tradingPanel.isOpened,isOpeningAvailable:this.tradingPanel.isOpeningAvailable,
activePage:this.tradingPanel.activePage,close:this.tradingPanel.close.bind(this.tradingPanel),openPage:this.tradingPanel.openPage.bind(this.tradingPanel)},this._qtySuggester,this._linking,this._orderPanelHeaderState))).then((e=>{this._orderControllerPromise=null,this._orderViewController=e,this._orderViewController.stateChanging.subscribe((()=>this._updateOrderPanelSpinnerState())),this._orderViewController.dialogVisibility.subscribe(this._makeDialogVisibilityHandler(this._orderDialogVisibility))}))),this._orderControllerPromise}async _registerCustomSources(e){!async function(e,t){const r=await Promise.all([i.e(1033),i.e(1969),i.e(2650)]).then(i.bind(i,13042));e.addCustomSource("bidask",((i,s)=>new r.BidAsk(i,s,t.realtimeProvider(),(()=>{e.activeChartWidget.value().showGeneralChartProperties(U.TabNames.symbol)}))))}(e,this),$e(e,this,this.showTradedSources);new((await Promise.all([i.e(1033),i.e(1969),i.e(1652)]).then(i.bind(i,16951))).TradedSourcesManager)(this._ordersService,this._positionService,e,{activeTradedLinking:this._tradedContextLinking,showTradedSources:this.showTradedSources,realtimeProvider:this._realtimeProvider,qtySuggester:this._qtySuggester,brokerCommandsUI:this.brokerCommandsUI.bind(this),trackEvent:this.trackEvent,pipValueType$:this.pipValueType(),makeActualSymbolObservable:this.makeActualSymbolObservable.bind(this)})}_registerCustomWidgets(e){Pi&&function(e,t,i){e.addCustomWidgetToLegend(((e,r)=>{const s=e.mainSeries(),o=(0,qe.createWVFromGetterAndSubscription)(e.isInReplay.bind(e),e.onInReplayStateChanged()),n=(0,qe.createWVFromGetterAndSubscriptions)((()=>{var e;return"economic"===(null===(e=s.symbolInfo())||void 0===e?void 0:e.type)}),[s.dataEvents().symbolResolved(),s.dataEvents().symbolError()]);return new Bt(s.dataEvents(),function(e){return()=>{const t=e.symbolInfo();return null!==t?t.pro_name||t.full_name||t.name||"":e.proSymbol()}}(s),n,i,{onNeedSelectBroker:t.onNeedSelectBroker,realtimeProvider:t.realtimeProvider(),onBrokerConnectionStatusChange:t.onConnectionStatusChange,brokerConnectionStatus:t.connectStatus.bind(t),trackEvent:t.trackEvent,toggleTradingWidget:t.toggleTradingWidget.bind(t),toggleTradingPanelPopup:t.toggleTradingPanelPopup.bind(t),brokerCommandsUI:t.brokerCommandsUI.bind(t),toggleMinimizeBottomWidgetBar:()=>t.toggleMinimizeBottomWidgetBar(),makeActualSymbolObservable:t.makeActualSymbolObservable.bind(t)},{showSellBuyButtons:t.showSellBuyButtons,noConfirmEnabled:t.noConfirmEnabled,themeName:r},o)}),{block:0,position:0})}(e,this,this._qtySuggester)}async _makeSubActions(e,t,i,r=!1){if(null===t.value||(0,y.isNaN)(t.value))return[];const s=this.activeBroker();let o,n,a,l,c,d,u,h,p,m,_,g,b,v=null===s,f=null===s,k=!r&&null===s,P=!r&&null!==s,S=!r&&null===s;null!==s&&1===s.connectionStatus()&&(b=await s.isTradable(e));const[C,w,B,{ask:T,bid:E}]=await Promise.all([this._qtySuggester.getQty(e),this._realtimeProvider.symbolInfo(e),this._realtimeProvider.formatter(e),this._realtimeProvider.quotesSnapshot(e)]);if(void 0===T||void 0===E||t.value<T&&t.value>E)return[]
;const O=w.variableMinTick?(0,N.makeVariableMinTickData)(w.minTick,w.variableMinTick):void 0,D=e=>(0,N.getMinTick)({minTick:w.minTick,price:e,variableMinTickData:O});if(null!==s&&b&&b.tradable){const e=s.metainfo().configFlags,i=(0,x.alignToStep)(t.value,D(t.value));o=i,a=i,l=i,n=i,c=l+D(l),d=n-D(n),v=Boolean(e.supportLimitOrders),f=Boolean(e.supportStopOrders),k=Boolean(e.supportStopOrdersInBothDirectionsInUI),P=Boolean(e.supportStopLimitOrdersInBothDirections),S=Boolean(e.supportStopLimitOrders),void 0!==w.limitPriceStep&&(o=(0,M.roundToStepByPriceTypeAndSide)(t.value,w.limitPriceStep,1,1),a=(0,M.roundToStepByPriceTypeAndSide)(t.value,w.limitPriceStep,1,-1),c=(0,M.roundToStepByPriceTypeAndSide)(t.value+D(t.value),w.limitPriceStep,1,1),d=(0,M.roundToStepByPriceTypeAndSide)(t.value-D(t.value),w.limitPriceStep,1,-1)),void 0!==w.stopPriceStep&&(l=(0,M.roundToStepByPriceTypeAndSide)(t.value,w.stopPriceStep,2,1),n=(0,M.roundToStepByPriceTypeAndSide)(t.value,w.stopPriceStep,2,-1)),u=B.format(o),h=B.format(n),p=B.format(a),m=B.format(l),_=B.format(c),g=B.format(d)}else o=a=l=n=t.value,u=h=p=m=t.formattedValue,c=l+D(l),d=n-D(n),_=B.format(c),g=B.format(d);const I={ask:T,bid:E},L=(E+T)/2,A=[];if(t.value<=L){if(v){const t={price:o,formattedPrice:u};A.push(this._makeSubAction({symbol:e,side:1,orderType:1,orderPrices:t,qty:C,gaOrigin:i,currentQuotes:I}))}if(k){const t={price:l,formattedPrice:m};A.push(this._makeSubAction({symbol:e,side:1,orderType:3,orderPrices:t,qty:C,gaOrigin:i,currentQuotes:I}))}if(f||k){const t={price:n,formattedPrice:h};A.push(this._makeSubAction({symbol:e,side:-1,orderType:3,orderPrices:t,qty:C,gaOrigin:i,currentQuotes:I}))}if(S){const t={symbol:e,side:-1,orderType:4,orderPrices:{price:n,formattedPrice:h,altPrice:d,formattedAltPrice:g},qty:C,gaOrigin:i,currentQuotes:I};A.push(this._makeSubAction(t)),P&&A.push(this._makeSubAction({...t,side:1}))}}else{if(v){const t={price:a,formattedPrice:p};A.push(this._makeSubAction({symbol:e,side:-1,orderType:1,orderPrices:t,qty:C,gaOrigin:i,currentQuotes:I}))}if(k){const t={price:n,formattedPrice:h};A.push(this._makeSubAction({symbol:e,side:-1,orderType:3,orderPrices:t,qty:C,gaOrigin:i,currentQuotes:I}))}if(f||k){const t={price:l,formattedPrice:m};A.push(this._makeSubAction({symbol:e,side:1,orderType:3,orderPrices:t,qty:C,gaOrigin:i,currentQuotes:I}))}if(S){const t={symbol:e,side:1,orderType:4,orderPrices:{price:l,formattedPrice:m,altPrice:c,formattedAltPrice:_},qty:C,gaOrigin:i,currentQuotes:I};A.push(this._makeSubAction(t)),P&&A.push(this._makeSubAction({...t,side:-1}))}}return A}_initPaidBrokersByUserRegion(){this._brokersListPromise=fetch("/api/v1/brokers/trading_panel",{method:"GET"}).then((e=>e.json())).catch((e=>{vi.logWarn("Failed to fetch brokers info: "+e)}))}async _getBrokerPlans(){let e=[];try{if(e=await this._brokersListPromise,!Array.isArray(e))throw new Error("Request result is not valid")}catch(e){vi.logError(`Failed to fetch broker list by user region: ${e.message}`)}return e}async _checkCQGCredentials(e){}async _showRestoreConfirmations(){
const e=await(0,me.showSimpleConfirmDialog)({title:s.t(null,void 0,i(102653)),text:s.t(null,void 0,i(526227)),mainButtonIntent:"primary"});null!==this._activeBroker&&e&&(new jt.DisabledConfirmations).clear()}_logOut(e,t,i){const s=(0,r.ensureNotNull)(this._activeBroker);s.connectionStatusUpdate.unsubscribe(this,this._connectionListener),s.currentAccountUpdate.unsubscribe(this,this._onCurrentAccountUpdate),this._realtimeProvider.onStatusChanged.unsubscribe(null,this._setPipValueType),this._realtimeProvider.onStatusChanged.unsubscribe(null,this._trackNonTradableSymbol),s.disconnect(t||!e),s.destroy(),this._activeBroker=null,this._updateConnectionStatus(3,e,i)}async _createTradedItemsChartCollectionFacade(e){return new((await Promise.all([i.e(1033),i.e(1969),i.e(2650)]).then(i.bind(i,132193))).TradedItemsChartCollectionFacade)(e)}_tradeNowInit(){const e=new URL(decodeURIComponent(window.location.href)),t=e.searchParams.get("trade-now");e.searchParams.delete("trade-now"),window.history.replaceState(null,document.title,e.toString()),null===t||isMobileTradingAvailable()||(this._tradeNowBrokerId=t,Ht.clear())}}},481330:(e,t,i)=>{"use strict";i.d(t,{adjustSavedCustomFieldsValues:()=>A,bottomTradingTabClassName:()=>p,brokersListFromPlans:()=>m,checkIsExistingPosition:()=>H,convertActionDescriptionsToActions:()=>b,executionText:()=>g,filterDurationsByOrderType:()=>N,filterDurationsBySymbolDurations:()=>x,findDurationMetaInfo:()=>O,getAsk:()=>F,getBid:()=>W,getCurrency:()=>k,getDefaultOrderType:()=>V,getLast:()=>q,getOrderDuration:()=>D,getPlatform:()=>j,getPriceStep:()=>Q,getQuotePrice:()=>$,getTimestamp:()=>M,isBatsQuotes:()=>B,isBrokerSupportOrderModification:()=>S,isDefined:()=>T,isMintickMultiple:()=>R,isModifyOrderSupported:()=>C,isMoveOrderSupported:()=>w,isNoQuotes:()=>U,isOAuthAuthType:()=>_,isOrderActive:()=>v,makeBrokerSideMaintananceFeatureToggleName:()=>y,makeDatePlus24UTCHours:()=>E,makeInitialOrderDuration:()=>I,makeMaintananceFeatureToggleName:()=>f,makeOrderDuration:()=>L,orderStatusToText:()=>u.orderStatusToText,roundToStepRequired:()=>z});var r=i(960521),s=i(650151),o=i(372605),n=i(601227),a=i(69111),l=i(282729),c=i(973602),d=i(807107),u=i(637401);const h="Paper",p="js-bottom-trading-tab";function m(e,t){const i=new Map(e.map((e=>[e.id,e]))),r=new Map(t.map((e=>[e.slug_name,e]))),o=[{metainfo:(0,s.ensureDefined)(i.get(h))}];return t.forEach((e=>{i.has(e.slug_name)&&o.push({metainfo:(0,s.ensureDefined)(i.get(e.slug_name)),brokerPlan:e})})),e.forEach((e=>{r.has(e.id)||e.id===h||o.push({metainfo:e})})),o}function _(e){return void 0!==e&&["oauth","oauth2-implicit-flow","oauth2-code-flow"].includes(e)}function g(e,t){const i=(0,u.sideToText)(e.side)+" "+e.qty+" @ "+t.format(e.price);return i.substring(0,1).toUpperCase()+i.substring(1).toLowerCase()}function b(e){return e?e.map((e=>"-"===e.text||e.separator?new c.Separator:new c.Action({actionId:"Trading.CustomActionId",name:e.name,checkable:e.checkable,checked:e.checked,disabled:void 0!==e.enabled&&!e.enabled,label:e.text,statName:e.statName,icon:e.icon,
shortcutHint:e.shortcutHint,onExecute:t=>{const i=t.getState();e.action({checkable:i.checkable,checked:i.checked,enabled:!i.disabled,text:i.label})}}))):[]}function v(e){return 6===e||3===e}function y(e){return`${e}-brokers-side-maintenance`.toLowerCase()}function f(e){return`${e}-maintenance`.toLowerCase()}function k(e,t){return!t&&e.currencySign||e.currency||""}function P(e,t){return Boolean(void 0!==e.parentId&&t.supportModifyBrackets&&(t.supportTrailingStop&&t.supportModifyTrailingStop||e.stopType!==l.StopType.TrailingStop))}function S(e){return e.supportModifyOrderPrice||e.supportEditAmount||e.supportModifyBrackets||!1}function C(e,t){const i=2!==e.type&&void 0===e.parentId&&S(t),r=P(e,t);return i||r}function w(e,t){const i=void 0===e.parentId&&t.supportModifyOrderPrice,r=P(e,t);return Boolean(i||r)}function B(e){var t;return"BATS"===(null===(t=e.originalName)||void 0===t?void 0:t.split(":")[0])}function T(e){return null!=e}function E(){const e=new Date;return e.setUTCHours(e.getUTCHours()+24),e}function O(e,t){return e.find((e=>e.value===t))}function D(e){const{orderDuration:t,orderType:i,savedDuration:r,orderDurations:s,symbolDurations:o}=e;if(void 0!==t)return t;const n=function(e){const{duration:t,orderDurations:i,orderType:r,symbolDurations:s}=e;if(null===t||void 0===i)return null;const o=x(i,s),n=O(N(o,null!=r?r:null),t.type);if(void 0===n)return null;if(void 0!==t.datetime&&(n.hasDatePicker||n.hasTimePicker)){const e=864e5,i=n.hasTimePicker?t.datetime<Date.now():Math.floor((t.datetime-Date.now())/e)<0;t.datetime=i?E().getTime():t.datetime}return t}({duration:r,orderType:i,orderDurations:s,symbolDurations:o});return null!==n?{...n}:I(i,s,o)}function I(e,t,i){var r;if(void 0===t)return null;const s=N(x(t,i),e);if(0===s.length)return null;return L(null!==(r=s.find((e=>e.default)))&&void 0!==r?r:s[0])}function L(e){const t={type:e.value};return Boolean(e.hasTimePicker||e.hasDatePicker)&&(t.datetime=M(E())),t}function x(e,t){return 0===e.length||void 0===t||0===t.length?e:e.filter((({value:e})=>t.includes(e)))}function N(e,t){const i=[1,3,4];return e.filter((e=>{var r;const s=null!==(r=e.supportedOrderTypes)&&void 0!==r?r:i;return null===t||s.includes(t)}))}function M(e){return e.valueOf()}function A(e,t){if(void 0===t.customFields)return{};const i={};return t.customFields.forEach((t=>{var r;const s="ComboBox"===t.inputType;if(s&&t.forceUserEnterInitialValue)return;const o=s?t.items[0].value:t.value,n=null!==(r=e[t.id])&&void 0!==r?r:o;void 0!==n&&(i[t.id]=n)})),i}function V(e){return e.supportLimitOrders?1:e.supportMarketOrders?2:e.supportStopLimitOrders?4:e.supportStopOrders?3:void 0}function R(e,t){if(0===t)return!1;const i=Math.round(1e12*t)/1e12,s=new r.Big(e),o=new r.Big(i);return s.mod(o).eq(0)}function F(e){return(0,o.isNumber)(e.ask)?e.ask:(0,o.isNumber)(e.trade)?e.trade:0}function W(e){return(0,o.isNumber)(e.bid)?e.bid:(0,o.isNumber)(e.trade)?e.trade:0}function q(e){return(0,o.isNumber)(e.trade)?e.trade:0}function U(e){return null===e||void 0===e.ask||void 0===e.bid}function $(e,t){
return 1===t?F(e):W(e)}function Q(e){const{priceType:t,minTick:i,price:r,variableMinTickData:s,limitPriceStep:o,stopPriceStep:n}=e;return 1===t&&void 0!==o?o:2===t&&void 0!==n?n:void 0!==s&&void 0!==r?(0,d.getMinTick)({minTick:i,price:r,variableMinTickData:s}):i}function z(e){const{priceType:t,minTick:i,limitPriceStep:r,stopPriceStep:s}=e;return 1===t&&void 0!==r?r!==i:2===t&&void 0!==s&&s!==i}function H(e){return void 0!==e&&(0!==e.qty||0!==e.longQty||0!==e.shortQty)}function j(){if((0,n.isDesktopApp)())return"Desktop App";const e=(0,a.isOnMobileAppPage)("old");return n.CheckMobile.isIPad()?e?"iPad App":"iPad Web":n.CheckMobile.any()?n.CheckMobile.Android()?(0,a.isOnMobileAppPage)("new")?"Android App":"Android Web":n.CheckMobile.iOS()?e?"iPhone App":"iPhone Web":"Unknown Mobile Web":"Desktop Web"}},99708:(e,t,i)=>{"use strict";i.d(t,{checkQtyError:()=>l,qtyErrors:()=>n});var r=i(509806),s=i(960521),o=i.n(s);const n={min:r.t(null,void 0,i(430999)),max:r.t(null,void 0,i(734266)),step:r.t(null,void 0,i(136443)),balance:r.t(null,void 0,i(409232))},a=(r.t(null,void 0,i(611835)),r.t(null,void 0,i(706035)));function l(e,t,i=!1){if(null===t)return{res:!0,msg:a};const r=e.step,s=e.min,l=e.max;if(t<s)return{res:!0,msg:n.min.format({min:s.toString()})};if(t>l)return{res:!0,msg:n.max.format({max:l.toString()})};const c=new(o())(t).minus(s).mod(r);return i&&!c.eq(0)?{res:!0,msg:n.step.format({step:r.toString()})}:{res:!1}}},346849:(e,t,i)=>{"use strict";i.d(t,{checkBracketError:()=>h,makeBracketPercentPriceRuleChecker:()=>d});var r=i(509806),s=i(960521),o=i.n(s),n=i(656846),a=i(481330),l=i(637401);const c={orderStopLoss:{long:r.t(null,void 0,i(995717)),short:r.t(null,void 0,i(685017))},orderTakeProfit:{long:r.t(null,void 0,i(429871)),short:r.t(null,void 0,i(37475))},positionStopLoss:{long:e=>r.t(null,{replace:{value:e}},i(216502)),short:e=>r.t(null,{replace:{value:e}},i(874337))},positionTakeProfit:{long:e=>r.t(null,{replace:{value:e}},i(829997)),short:e=>r.t(null,{replace:{value:e}},i(751300))}};function d(e,t){let s,a,c;const d=(e,t,i,r)=>{const s=new(o())(t),n=s.mul(e).div(100);return s.minus(n.mul(i).mul(r)).toNumber()};return(o,u,h,p,m,_,g,b)=>{const v=-1===h?-1:1,y=p===n.BracketType.TakeProfit?-1:1,f=d(e,u,v,y),k=d(t,u,v,y),P=(0,l.roundToStepByPriceTypeAndSide)(f,_,m,h),S=(0,l.roundToStepByPriceTypeAndSide)(k,_,m,h);let C=Math.min(P,S),w=Math.max(P,S);g&&(void 0!==s&&void 0!==a&&c?(C=s,w=a):void 0===s&&void 0===a&&(C=Math.min(C,o),w=Math.max(w,o),s=C,a=w,c=b));if(!(o>=C&&o<=w))return{res:!0,msg:r.t(null,void 0,i(783100)).replace("{min}",C.toString()).replace("{max}",w.toString())};return(v*y==-1?P>=u&&S>=u:P<=u&&S<=u)?{res:!1}:{res:!0,msg:r.t(null,void 0,i(298353))}}}function u(e){const{side:t,price:i,priceType:r,priceStep:s,parentPrice:o,bracketType:n,isStatusEditing:a,isEnabled:l,bracketPercentPriceRuleCheckers:c}=e;for(const e of c){const c=e(i,o,t,n,r,s,a,l);if(c.res)return c}return{res:!1}}function h(e){
const{quotes:t,side:s,price:o,pips:l,priceType:d,priceStep:h,parentPrice:p,parentType:m,bracketType:_,isStatusEditing:g,isEnabled:b,bracketPercentPriceRuleCheckers:v,priceFormatter:y,isRoundToPriceStep:f}=e;if(null===o||null===l)return{res:!0,msg:r.t(null,void 0,i(900205))};let k={res:!1};return k=2===m?function(e){const{quotes:t,side:s,price:o,priceType:l,priceStep:d,parentPrice:h,bracketType:p,isStatusEditing:m,isEnabled:_,bracketPercentPriceRuleCheckers:g}=e;let b={res:!1};g.length>0&&(b=u({side:s,price:o,priceType:l,priceStep:d,parentPrice:h,bracketType:p,isStatusEditing:m,isEnabled:_,bracketPercentPriceRuleCheckers:g}));const v=(p===n.BracketType.TakeProfit?-1:1)*s,y=-1===s?(0,a.getAsk)(t):(0,a.getBid)(t);if(y&&Math.sign(o-y)===v){const e=p===n.BracketType.TakeProfit?c.positionTakeProfit:c.positionStopLoss,t=-1===s?r.t(null,void 0,i(26338)):r.t(null,void 0,i(5595));b={res:!0,msg:-1===s?e.short(t):e.long(t)}}return b}({quotes:t,side:s,price:o,priceType:d,priceStep:h,parentPrice:p,bracketType:_,isStatusEditing:g,isEnabled:b,bracketPercentPriceRuleCheckers:v}):function(e){const{side:t,pips:i,price:r,priceType:s,priceStep:o,parentPrice:a,bracketType:l,isStatusEditing:d,isEnabled:h,bracketPercentPriceRuleCheckers:p}=e;let m={res:!1};if(p.length>0&&(m=u({side:t,price:r,priceType:s,priceStep:o,parentPrice:a,bracketType:l,isStatusEditing:d,isEnabled:h,bracketPercentPriceRuleCheckers:p})),i<=0||r<=0){const e=l===n.BracketType.TakeProfit?c.orderTakeProfit:c.orderStopLoss;m={res:!0,msg:1===t?e.long:e.short}}return m}({side:s,pips:l,price:o,priceType:d,priceStep:h,parentPrice:p,bracketType:_,isStatusEditing:g,isEnabled:b,bracketPercentPriceRuleCheckers:v}),!k.res&&f&&(k=function(e,t,s){return(0,a.isMintickMultiple)(e,t)?{res:!1}:{res:!0,msg:r.t(null,void 0,i(753596)).format({minTick:s.format(t)})}}(o,h,y)),k}},957877:(e,t,i)=>{"use strict";i.d(t,{validatePrice:()=>c});var r=i(509806),s=i(960521),o=i.n(s),n=i(481330);const a=r.t(null,void 0,i(134986));function l(e,t){return o()(e).minus(t).abs().gt(o()(e).div(2))}function c(e){const{price:t,askOrBid:s,orderType:c,side:d,isStopPrice:u,isForex:h,formatter:p,supportStopOrdersInBothDirections:m,supportStopLimitOrdersInBothDirections:_,step:g,roundedToStep:b}=e;if((!h||b)&&!1===(0,n.isMintickMultiple)(t,g))return{res:!0,severity:"error",msg:r.t(null,void 0,i(130927)).format({minTick:p.format(g)})};const v=t<0||o()(s).mul(100).lt(t)||function(e){const{price:t,askOrBid:i,orderType:r,side:s,isStopPrice:o,supportStopOrdersInBothDirections:n,supportStopLimitOrdersInBothDirections:a}=e;return 1===r?1===s?t>i&&l(i,t):t<i&&l(i,t):!!(3===r&&!n||4===r&&o&&!a)&&(1===s?t<i:t>i)}({price:t,askOrBid:s,orderType:c,side:d,isStopPrice:u,supportStopOrdersInBothDirections:m,supportStopLimitOrdersInBothDirections:_});return v?{res:!0,severity:"error",msg:a}:{res:!1}}},232192:(e,t,i)=>{"use strict";i.d(t,{extractLimitValidationRules:()=>m,extractStopLossValidationRules:()=>h,extractStopValidationRules:()=>p,extractTakeProfitValidationRules:()=>u,isLimitPercentValidationRule:()=>l,
isStopLimitPercentValidationRule:()=>a,isStopPercentValidationRule:()=>c});const r=["tpPercent"],s=["slPercent"],o=["stopPercent"],n=["limitPercent"];function a(e){return l(e)||c(e)}function l(e){return n.includes(e.id)}function c(e){return o.includes(e.id)}function d(e,t,i){var r;return null===(r=e.getValidationRules(t))||void 0===r?void 0:r.filter((e=>i.includes(e.id)))}function u(e,t){return d(e,t,r)}function h(e,t){return d(e,t,s)}function p(e,t){return d(e,t,o)}function m(e,t){return d(e,t,n)}},330012:(e,t,i)=>{"use strict";i.d(t,{abbreviatedNumber:()=>o});var r=i(424030);const s=["","K","M","G","T","Y"];function o(e){if(e<1)return r.NumericFormatter.formatNoE(e);let t=0,i=+e;if(isFinite(i))for(;i>=1e3&&i%100==0;)t++,i/=1e3;return i+(t<s.length?s[t]:"e"+3*t)}},660538:(e,t,i)=>{"use strict";i.d(t,{mediaQueryAddEventListener:()=>r,mediaQueryRemoveEventListener:()=>s});const r=(e,t)=>{(null==e?void 0:e.addEventListener)?e.addEventListener("change",t):e.addListener(t)},s=(e,t)=>{(null==e?void 0:e.removeEventListener)?e.removeEventListener("change",t):e.removeListener(t)}},340794:(e,t,i)=>{"use strict";function r(e){let t=Promise.resolve();return function(...i){const r=t.then((()=>e.apply(this,i)));return t=r.catch((()=>{})),r}}i.d(t,{sequentialize:()=>r})},48008:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" fill-rule="evenodd" d="M3 10a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 1a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm6-1a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0 1a2 2 0 1 0 0-4 2 2 0 0 0 0 4zm7-2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm1 0a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/></svg>'},465890:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 11 9" width="11" height="9" fill="none"><path stroke-width="2" d="M0.999878 4L3.99988 7L9.99988 1"/></svg>'},512646:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M7.84 13.7H5.78V4.4l2.48-.06c1.35 0 2.42.4 3.22 1.2.8.78 1.19 1.83 1.19 3.15 0 3.34-1.61 5.01-4.83 5.01zm-.41-7.85v6.35c.26.02.55.03.86.03.83 0 1.48-.3 1.95-.9.48-.6.72-1.46.72-2.54 0-2-.93-2.99-2.78-2.99-.18 0-.43.02-.75.05z"/></svg>'},552828:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18"><path fill="currentColor" d="M13.4 5.9c-.41 1.62-1.16 2.43-2.25 2.43-.52 0-1.25-.15-2.2-.45-.93-.3-1.58-.45-1.96-.45-.55 0-.98.3-1.27.9H4.66c.1-.67.36-1.24.76-1.71.4-.48.86-.72 1.4-.72.56 0 1.31.16 2.27.46.95.3 1.62.45 2.01.45.64 0 1.06-.3 1.27-.9h1.03zm0 3.87c-.41 1.62-1.16 2.43-2.25 2.43-.52 0-1.25-.15-2.2-.45-.93-.3-1.58-.46-1.96-.46-.55 0-.98.3-1.27.9H4.66c.1-.67.36-1.24.76-1.7.4-.48.86-.72 1.4-.72.56 0 1.31.15 2.27.46.95.3 1.62.44 2.01.44.64 0 1.06-.3 1.27-.9h1.03z"/></svg>'},379978:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18" fill="none"><path stroke="currentColor" d="M8 5l3.5 3.5L8 12"/></svg>'},643959:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path stroke="currentcolor" stroke-width="1.2" d="M17 21l-7.5-7.5L17 6"/></svg>'},966883:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20" fill="none" stroke="currentcolor"><path d="M3.5 10A6.5 6.5 0 1 0 10 3.5H5.233M7.5 6.5l-3-3 3-3"/></svg>'},513729:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path stroke="currentColor" stroke-width="1.2" d="M7 6l15 15m0-15L7 21"/></svg>'},198083:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M19.9792 16.6205C19.7396 16.8955 19.3241 16.9285 19.044 16.6948L14.3924 12.8117L14.072 12.5442L13.7516 12.8117L9.10009 16.6947C8.82008 16.9285 8.40456 16.8955 8.16495 16.6205C7.92467 16.3447 7.94981 15.9272 8.22144 15.6822L14.0721 10.4057L19.9227 15.6822C20.1943 15.9272 20.2195 16.3447 19.9792 16.6205ZM18.4032 17.4624C19.1009 18.0448 20.1362 17.9626 20.7332 17.2774C21.3318 16.5902 21.2692 15.55 20.5924 14.9396L14.407 9.36109L14.0721 9.05908L13.7373 9.36109L7.55171 14.9396C6.87492 15.55 6.81229 16.5902 7.41096 17.2774C8.00796 17.9626 9.04326 18.0448 9.74094 17.4624L14.072 13.8468L18.4032 17.4624Z"/></svg>'},472382:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M19.9792 12.2892C19.7396 12.0142 19.3241 11.9812 19.044 12.2149L14.3924 16.098L14.072 16.3655L13.7516 16.098L9.10009 12.2149C8.82008 11.9812 8.40456 12.0142 8.16495 12.2892C7.92467 12.565 7.94981 12.9825 8.22144 13.2275L14.0721 18.504L19.9227 13.2275C20.1943 12.9825 20.2195 12.565 19.9792 12.2892ZM18.4032 11.4472C19.1009 10.8648 20.1362 10.9471 20.7332 11.6323C21.3318 12.3195 21.2692 13.3597 20.5924 13.9701L14.407 19.5486L14.0721 19.8506L13.7373 19.5486L7.55171 13.9701C6.87492 13.3597 6.81229 12.3195 7.41096 11.6323C8.00796 10.9471 9.04326 10.8648 9.74094 11.4473L14.072 15.0628L18.4032 11.4472Z"/></svg>'},507720:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 17" width="17" height="17" fill="currentColor"><path d="m.58 1.42.82-.82 15 15-.82.82z"/><path d="m.58 15.58 15-15 .82.82-15 15z"/></svg>'},29834:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28"><path fill="currentColor" d="M7.5 13a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM5 14.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0zm9.5-1.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM12 14.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0zm9.5-1.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM19 14.5a2.5 2.5 0 1 1 5 0 2.5 2.5 0 0 1-5 0z"/></svg>'},816105:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" width="72" height="72" fill="none"><g clip-path="url(#clip0)"><path fill="#363A45" fill-rule="evenodd" clip-rule="evenodd" d="M62.1259 28.2153C61.4066 28.8157 61.0001 29.7273 61.0858 30.6604C61.6716 37.0347 59.7763 44.3291 55.3181 50.8221C46.9016 63.0797 32.5383 67.839 23.2366 61.4522C13.935 55.0654 13.2174 39.9512 21.6339 27.6935C26.4984 20.6088 33.3496 16.029 40.0619 14.6585C40.9752 14.472 41.731 13.8291 42.1024 12.9741C42.485 12.0934 42.9606 11.2346 43.5313 10.4123C47.906 4.1093 56.2129 2.33004 62.0853 6.4382C67.9578 10.5464 69.172 18.9863 64.7974 25.2892C64.0194 26.4103 63.1169 27.3882 62.1259 28.2153Z"/><rect width="47.2" height="34" fill="#1E222D" stroke="#B2B5BE" stroke-width="2" rx="3.8" x="12.4004" y="16"/><path stroke="#B2B5BE" stroke-linecap="round" stroke-width="2" d="M3.59961 54H67.1996"/><path fill="#B2B5BE" fill-rule="evenodd" clip-rule="evenodd" d="M29.1178 31.1324L30.8107 32.8253L32.225 31.4111L30.5321 29.7182L32.225 28.0253L30.8107 26.6111L29.1178 28.304L27.425 26.6111L26.0107 28.0253L27.7036 29.7182L26.0107 31.4111L27.425 32.8253L29.1178 31.1324Z"/><path fill="#B2B5BE" fill-rule="evenodd" clip-rule="evenodd" d="M43.5182 31.1324L45.2111 32.8253L46.6253 31.4111L44.9325 29.7182L46.6253 28.0253L45.2111 26.6111L43.5182 28.304L41.8253 26.6111L40.4111 28.0253L42.104 29.7182L40.4111 31.4111L41.8253 32.8253L43.5182 31.1324Z"/><path stroke="#B2B5BE" stroke-width="2" d="M30.5996 38.7H40.7996"/></g></svg>'},627687:e=>{e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" width="72" height="72" fill="none"><g clip-path="url(#clip0)"><path fill="#F0F3FA" fill-rule="evenodd" clip-rule="evenodd" d="M62.1259 28.2153C61.4066 28.8157 61.0001 29.7273 61.0858 30.6604C61.6716 37.0347 59.7763 44.3291 55.3181 50.8221C46.9016 63.0797 32.5383 67.839 23.2366 61.4522C13.935 55.0654 13.2174 39.9512 21.6339 27.6935C26.4984 20.6088 33.3496 16.029 40.0619 14.6585C40.9752 14.472 41.731 13.8291 42.1024 12.9741C42.485 12.0934 42.9606 11.2346 43.5313 10.4123C47.906 4.1093 56.2129 2.33004 62.0853 6.4382C67.9578 10.5464 69.172 18.9863 64.7974 25.2892C64.0194 26.4103 63.1169 27.3882 62.1259 28.2153Z"/><rect width="47.2" height="34" fill="#fff" stroke="#1E222D" stroke-width="2" rx="3.8" x="12.4004" y="16"/><path stroke="#1E222D" stroke-linecap="round" stroke-width="2" d="M3.59961 54H67.1996"/><path fill="#000" fill-rule="evenodd" clip-rule="evenodd" d="M29.1178 31.1324L30.8107 32.8253L32.225 31.4111L30.5321 29.7182L32.225 28.0253L30.8107 26.6111L29.1178 28.304L27.425 26.6111L26.0107 28.0253L27.7036 29.7182L26.0107 31.4111L27.425 32.8253L29.1178 31.1324Z"/><path fill="#000" fill-rule="evenodd" clip-rule="evenodd" d="M43.5182 31.1324L45.2111 32.8253L46.6253 31.4111L44.9325 29.7182L46.6253 28.0253L45.2111 26.6111L43.5182 28.304L41.8253 26.6111L40.4111 28.0253L42.104 29.7182L40.4111 31.4111L41.8253 32.8253L43.5182 31.1324Z"/><path stroke="#000" stroke-width="2" d="M30.5996 38.7H40.7996"/></g></svg>'},829883:e=>{
e.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 16" width="20" height="16"><path fill="currentColor" fill-rule="evenodd" d="M7.5 2.5C7.5 1.67 8.17 1 9 1h2c.83 0 1.5.67 1.5 1.5v.15h-5V2.5zm6 0v.15H17a2.5 2.5 0 0 1 2.5 2.5v8.35A2.5 2.5 0 0 1 17 16H3a2.5 2.5 0 0 1-2.5-2.5V5.15A2.5 2.5 0 0 1 3 2.65h3.5V2.5A2.5 2.5 0 0 1 9 0h2a2.5 2.5 0 0 1 2.5 2.5zm-12 2.65c0-.83.67-1.5 1.5-1.5h14c.83 0 1.5.67 1.5 1.5v8.35c0 .83-.67 1.5-1.5 1.5H3a1.5 1.5 0 0 1-1.5-1.5V5.15zM9.25 6.5a1.75 1.75 0 1 0 0 3.5h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75h-1c0 .97.78 1.75 1.75 1.75h.25v1h1v-1h.25a1.75 1.75 0 1 0 0-3.5h-1.5a.75.75 0 0 1 0-1.5h1.5c.41 0 .75.34.75.75h1c0-.97-.78-1.75-1.75-1.75h-.25v-1h-1v1h-.25z"/></svg>'}}]);