"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[3541],{604406:(t,e,s)=>{s.d(e,{splitThousands:()=>r});var i=s(150335);function r(t,e="&nbsp;"){let s=t+"";-1!==s.indexOf("e")&&(s=function(t){return(0,i.fixComputationError)(t).toFixed(10).replace(/\.?0+$/,"")}(Number(t)));const r=s.split(".");return r[0].replace(/\B(?=(\d{3})+(?!\d))/g,e)+(r[1]?"."+r[1]:"")}},311460:(t,e,s)=>{s.d(e,{StopType:()=>i.StopType,OrderOrPositionMessageType:()=>r.OrderOrPositionMessageType,AccountType:()=>r.AccountType,DisconnectType:()=>r.DisconnectType});var i=s(971204),r=s(122621)},971204:(t,e,s)=>{var i;s.d(e,{StopType:()=>i}),function(t){t[t.StopLoss=0]="StopLoss",t[t.TrailingStop=1]="TrailingStop"}(i||(i={}))},257596:(t,e,s)=>{s.d(e,{DisconnectError:()=>n,extractDisconnectionInfoAndConnectionStatus:()=>a});var i=s(122621),r=s(696546),o=s(52346);class n extends o.UserFriendlyError{constructor({disconnectInfo:t,...e}){super(e),this.name="DisconnectError",this.disconnectInfo=t}}function a(t){const e=function(t){const e={message:(0,r.getErrorMessage)(t)};t instanceof n&&(e.disconnectType=t.disconnectInfo.disconnectType);return e}(t);let s=4;return void 0!==e.disconnectType&&[i.DisconnectType.CancelAuthorization,i.DisconnectType.TimeOutForAuthorization].includes(e.disconnectType)&&(s=3),{disconnectionInfo:e,connectionStatus:s}}},426670:(t,e,s)=>{s.r(e),s.d(e,{Broker:()=>nt});var i=s(509806),r=s(650151),o=s(960521),n=s.n(o),a=s(311460),u=s(159537);class l extends Worker{constructor(t,e){super(function(t){const e=new URL(t),i=new Blob(["self.WEBPACK_PUBLIC_PATH=",JSON.stringify(new URL(s.p,location.href).href),";\n","self.locale=",JSON.stringify(s.g.locale),";\n",window.language?`self.language=${JSON.stringify(window.language)};\n`:"","importScripts(",JSON.stringify(e.href),");"],{type:"application/javascript"});return URL.createObjectURL(i)}(t),e)}}const c=new class{constructor(){this._timerWorker=null,this._timerIdCounter=1,this._timersMap=new Map,this._rejectsToCall=new Set,this._processMessage=t=>{const e=this._timersMap.get(t.data.turnaround);switch(t.data.type){case"timerCreated":e&&(e.scheduledForRemoving?("interval"===e.type?this._getTimerWorker().postMessage({type:"clearInterval",id:t.data.id}):this._getTimerWorker().postMessage({type:"clearTimeout",id:t.data.id}),this._deleteTimerFromMap(t.data.turnaround)):e.workerTimerId=t.data.id);break;case"timerFired":e&&(e.callback(),"timeout"===e.type&&this._deleteTimerFromMap(t.data.turnaround))}}}destroy(){var t;this._rejectsToCall.forEach((t=>t((0,u.createAbortError)()))),null===(t=this._timerWorker)||void 0===t||t.terminate(),this._timerWorker=null,this._timersMap.clear()}setTimeout(t,e){return this._setTimeoutImpl(t,e,"timeout")}clearTimeout(t){const e=this._timersMap.get(t);e&&(e.workerTimerId?(this._getTimerWorker().postMessage({type:"clearTimeout",id:e.workerTimerId}),this._deleteTimerFromMap(t)):e.scheduledForRemoving=!0)}setInterval(t,e){const s=this._nextTimerId();return this._timersMap.set(s,{callback:t,type:"interval"}),
this._getTimerWorker().postMessage({type:"setInterval",delay:e,turnaround:s}),s}clearInterval(t){const e=this._timersMap.get(t);e&&(e.workerTimerId?(this._getTimerWorker().postMessage({type:"clearInterval",id:e.workerTimerId}),this._deleteTimerFromMap(t)):e.scheduledForRemoving=!0)}async createTimeout(t,e){let s;return new Promise(((i,r)=>{var o;s=r,this._rejectsToCall.add(s);const n=this.setTimeout(i,t);null===(o=null==e?void 0:e.signal)||void 0===o||o.addEventListener("abort",(()=>{this.clearTimeout(n),r((0,u.createAbortError)())}))})).finally((()=>{this._rejectsToCall.delete(s)}))}async*createInterval(t,e){let s=()=>{},i=t=>{};const r=this.setInterval((()=>{s()}),t);e.signal.addEventListener("abort",(()=>{this.clearInterval(r),i((0,u.createAbortError)())}));try{for(;;)await new Promise(((t,e)=>{s=t,this._rejectsToCall.delete(i),i=e,this._rejectsToCall.add(i)})),yield}catch(t){if(!(0,u.isAbortError)(t))throw t}}_getTimerWorker(){return null===this._timerWorker&&(this._timerWorker=new l(new URL(s.p+s.u(7050),s.b),{name:"Timer worker"}),this._timerWorker.onmessage=this._processMessage),this._timerWorker}_setTimeoutImpl(t,e,s){const i=this._nextTimerId();return this._timersMap.set(i,{callback:t,type:s}),this._getTimerWorker().postMessage({type:"setTimeout",delay:e,turnaround:i}),i}_deleteTimerFromMap(t){if(this._timersMap.delete(t),0===this._timersMap.size){const t=this._setTimeoutImpl((()=>{var e;1===this._timersMap.size&&this._timersMap.has(t)&&(this._timersMap.delete(t),null===(e=this._timerWorker)||void 0===e||e.terminate(),this._timerWorker=null)}),6e4,"terminal_timer")}}_nextTimerId(){return this._timerIdCounter++}};var d=s(810251),h=s(717861),p=s(220863);const _=[{label:i.t(null,void 0,s(589053)),formatter:"symbol",showLabelOnMobile:!1,id:"brokerSymbol",dataFields:["brokerSymbol","symbol"],notHideable:!0},{label:i.t(null,void 0,s(750441)),id:"side",dataFields:["side"],formatter:"side"},{label:i.t(null,void 0,s(158416)),id:"type",dataFields:["type","parentId","stopType"],formatter:"type"},{label:i.t(null,void 0,s(425e3)),alignment:"right",id:"qty",dataFields:["qty"],formatter:"formatQuantity",help:i.t(null,void 0,s(647761))},{label:i.t(null,void 0,s(856251)),alignment:"right",id:"filledQty",dataFields:["filledQty"],formatter:"formatQuantity",help:i.t(null,void 0,s(205994))},{label:i.t(null,void 0,s(317330)),alignment:"right",id:"limitPrice",dataFields:["limitPrice"],formatter:"formatPrice"},{label:i.t(null,void 0,s(949689)),alignment:"right",id:"stopPrice",dataFields:["stopPrice"],formatter:"formatPrice"},{label:i.t(null,void 0,s(129266)),alignment:"right",id:"takeProfit",dataFields:["takeProfit"],formatter:"formatPrice"},{label:i.t(null,void 0,s(241648)),alignment:"right",id:"stopLoss",dataFields:["stopLoss"],formatter:"formatPrice"},{label:i.t(null,void 0,s(86430)),alignment:"right",id:"trailingStopPrice",dataFields:["trailingStopPrice"],formatter:"formatPrice"},{label:i.t(null,void 0,s(181550)),alignment:"right",id:"avgPrice",dataFields:["avgPrice"],formatter:"formatPrice",supportedStatusFilters:[0,6,2]},{
label:i.t(null,void 0,s(631272)),id:"status",dataFields:["status"],formatter:"status",supportedStatusFilters:[0]},{label:i.t(null,void 0,s(418587)),id:"updateTime",dataFields:["updateTime"],formatter:"localDate"},{label:i.t(null,void 0,s(28197)),id:"id",dataFields:["id"],isCapitalize:!1},{label:i.t(null,void 0,s(506334)),id:"expiry",dataFields:["expiry"]},{label:i.t(null,void 0,s(233959)),alignment:"right",id:"expiryTime",dataFields:["expiryTime"],formatter:"localDateOrDateTime"}],m=[{label:i.t(null,void 0,s(589053)),formatter:"symbol",showLabelOnMobile:!1,id:"brokerSymbol",dataFields:["brokerSymbol","symbol"],notHideable:!0},{label:i.t(null,void 0,s(750441)),id:"side",dataFields:["side"],formatter:"side"},{label:i.t(null,void 0,s(158416)),id:"type",dataFields:["type","parentId","stopType"],formatter:"type"},{label:i.t(null,void 0,s(425e3)),alignment:"right",id:"qty",dataFields:["qty"],formatter:"formatQuantity",help:i.t(null,void 0,s(647761))},{label:i.t(null,void 0,s(856251)),alignment:"right",id:"filledQty",dataFields:["filledQty"],formatter:"formatQuantity",help:i.t(null,void 0,s(205994))},{label:i.t(null,void 0,s(317330)),alignment:"right",id:"limitPrice",dataFields:["limitPrice"],formatter:"formatPrice"},{label:i.t(null,void 0,s(949689)),alignment:"right",id:"stopPrice",dataFields:["stopPrice"],formatter:"formatPrice"},{label:i.t(null,void 0,s(181550)),alignment:"right",id:"avgPrice",dataFields:["avgPrice"],formatter:"formatPrice"},{label:i.t(null,void 0,s(631272)),id:"status",dataFields:["status"],formatter:"status"},{label:i.t(null,void 0,s(418587)),id:"updateTime",dataFields:["updateTime"],formatter:"localDate"},{label:i.t(null,void 0,s(28197)),id:"id",dataFields:["id"],isCapitalize:!1}],g=(i.t(null,void 0,s(374444)),i.t(null,{context:"trading"},s(115497)),i.t(null,void 0,s(433656)),[{label:i.t(null,void 0,s(589053)),formatter:"symbol",showLabelOnMobile:!1,id:"brokerSymbol",dataFields:["brokerSymbol","symbol"],notHideable:!0},{label:i.t(null,void 0,s(750441)),id:"side",dataFields:["side"],formatter:"positionSide"},{label:i.t(null,void 0,s(425e3)),alignment:"right",id:"qty",dataFields:["qty"],formatter:"formatQuantity",help:i.t(null,void 0,s(647761))},{label:i.t(null,void 0,s(181550)),alignment:"right",id:"avgPrice",dataFields:["avgPrice","symbol"],formatter:"avgPriceFormatter"},{label:i.t(null,void 0,s(129266)),alignment:"right",id:"takeProfit",dataFields:["takeProfit"],formatter:"formatPriceForexSup"},{label:i.t(null,void 0,s(241648)),alignment:"right",id:"stopLoss",dataFields:["stopLoss"],formatter:"formatPriceForexSup"},{label:i.t(null,void 0,s(86430)),alignment:"right",id:"trailingStopPrice",dataFields:["trailingStopPrice"],formatter:"formatPriceForexSup"},{label:i.t(null,void 0,s(486323)),alignment:"right",id:"unrealizedPl",dataFields:["unrealizedPl","currency"],formatter:"profitInInstrumentCurrency",isCapitalize:!1},{label:i.t(null,void 0,s(771506)),id:"id",dataFields:["id"],isCapitalize:!1}]),f=[{label:i.t(null,void 0,s(589053)),id:"symbol",dataFields:["symbol"]},{label:i.t(null,void 0,s(719626)),
id:"longName",dataFields:["longName"],notSortable:!0},{label:i.t(null,void 0,s(613937)),alignment:"right",id:"total",dataFields:["total"],formatter:"variablePrecision"},{label:i.t(null,void 0,s(288439)),alignment:"right",id:"available",dataFields:["available"],formatter:"variablePrecision"},{label:i.t(null,void 0,s(487320)),alignment:"right",id:"reserved",dataFields:["reserved"],formatter:"variablePrecision"},{label:i.t(null,void 0,s(693344)),alignment:"right",id:"btcValue",dataFields:["btcValue"],formatter:"variablePrecision"},{label:i.t(null,void 0,s(660187)),id:"value",dataFields:["value","valueCurrency"],alignment:"right",formatter:"cryptoValueInCurrencyFormatter"}];var y=s(696546);function v(t){return(e,s)=>{if(void 0!==t)return t(e,s);const i="string"!=typeof e?e.url.href:e;return fetch(i,s)}}const b=i.t(null,void 0,s(929332));var T;function P(t){const e={Accept:"application/json","Content-Type":"application/x-www-form-urlencoded",Referer:"https://www.tradingview.com/chart/OlHDdzUm/"};return t&&(e.Authorization="Bearer "+t),e}async function k({requestMetainfo:t,accessToken:e,method:s=T.Get,body:i,logger:r,includeCredentials:o},n){const a=i?function(t){const e=[];for(const s in t)t.hasOwnProperty(s)&&null!=t[s]&&e.push({key:s,pair:encodeURIComponent(s)+"="+encodeURIComponent(t[s])});return e.sort(((t,e)=>t.key>e.key?1:t.key<e.key?-1:0)).map((t=>t.pair)).join("&")}(i):i,u={method:T[s],headers:P(e)};a&&s!==T.Get&&(u.body=a),o&&(u.credentials="include");try{const e=await v(n)(t,u);if(!e.ok)throw new Error(e.statusText);return e}catch(t){throw t.message=(0,y.getErrorMessage)(t),r&&r.logError(t.message),t}}function F(t){return async e=>async function(t,e){const s=await k({...t},e),i=await s.json();if(!function(t){return!(!t||t.hasOwnProperty("s")&&"error"===t.s)}(i)){const e=i.errmsg?i.errmsg:b;throw t.logger&&t.logger.logError(e),new Error(e)}return"d"in i?i.d:i}(e,t)}!function(t){t[t.Get=1]="Get",t[t.Post=2]="Post",t[t.Put=3]="Put",t[t.Delete=4]="Delete"}(T||(T={}));var S=s(922157),C=s.n(S),w=s(817808),q=s(52346);function M(t){return{valid:!0,data:t}}const A=(0,w.getLogger)("Trading.Requester");class E{constructor({requestMetainfo:t,method:e,headers:s,body:i,requestInterval:r,dataCallback:o,extractResponseData:n,extractErrorMessage:a,includeCredentials:u,customFetch:l}){this.statusChanged=new(C()),this._currentPulseIndex=0,this._body=null,this._requestInterval=null,this._requestTimeOut=null,this._errorsCount=0,this._status=0,this._snapshot=!0,this._requestMetainfo=t,this._includeCredentials=u,this._headers=s,this._method=e||T.Get,this._body=i||null,this._requestInterval=r,this._dataCallback=o,this.statusChanged=new(C()),this._extractResponseData=n,this._extractErrorMessage=a,this._customFetch=l}start(){return this._status=1,this._errorsCount=0,this._currentPulseIndex++,this._request()}stop(){this._status=0,this._clearResetRequestTimeout()}pause(){this.stop()}unpause(){this.start()}status(){return this._status}changeRequestMetainfo(t){(0,r.assert)(1!==this._status,"Cannot change URL input: requester is running"),
this._requestMetainfo=t}changeHeaders(t){(0,r.assert)(1!==this._status,"Cannot change headers: requester is running"),this._headers=t}async _request(){const t=this._currentPulseIndex;(0,r.assert)(1===this._status,"Unable to request: requester is inactive");try{const e=this._requestMetainfo,s=await async function({input:t,method:e,headers:s,includeCredentials:i,body:r,extractResponseData:o=M,extractErrorMessage:n,customFetch:a}){const u={method:T[e],headers:s};i&&(u.credentials="include");try{null!==r&&(u.body=JSON.stringify(r));const e=await v(a)(t,u);if(!e.ok){if(void 0!==n){const{logMessage:t,userFriendlyMessage:s}=await n(e);throw new q.UserFriendlyError({detailedErrorMessage:t,userFriendlyMessage:s})}throw new Error(e.statusText)}const s=o(await e.json());if(!1===s.valid)throw new Error(s.errormsg);return s.data}catch(t){throw new q.UserFriendlyError({detailedErrorMessage:t.message,userFriendlyMessage:t.userFriendlyMessage})}}({input:this._requestMetainfo,method:this._method,headers:this._headers,body:this._body,includeCredentials:this._includeCredentials,extractResponseData:this._extractResponseData,extractErrorMessage:this._extractErrorMessage,customFetch:this._customFetch});this._errorsCount=0,e===this._requestMetainfo&&1===this._status&&t===this._currentPulseIndex&&(await this._dataCallback(s,this._snapshot),this._snapshot=!1)}catch(e){A.logError(`${(0,y.getLoggerMessage)(e)}: ${this._requestMetainfo.url.href}`),this._errorsCount++,t===this._currentPulseIndex&&this._failOnErrorsCount((0,y.getErrorMessage)(e))}finally{null!==this._requestInterval&&1===this._status&&t===this._currentPulseIndex&&await this._makeNextRequest()}}_clearResetRequestTimeout(){null!==this._requestTimeOut&&(clearTimeout(this._requestTimeOut),this._requestTimeOut=null)}_failOnErrorsCount(t){this._errorsCount>20&&(this._clearResetRequestTimeout(),this._status=2,this.statusChanged.fire({requesterStatus:this._status,errorMessage:t}))}async _makeNextRequest(){const t=this._currentPulseIndex;this._requestTimeOut=null,this._requestTimeOut=setTimeout((async()=>{t===this._currentPulseIndex&&await this._request()}),this._requestInterval)}}class O{constructor(t){this.statusChanged=new(C()),this._data=[],this._status=0,this._onNewData=async(t,e)=>{if(1!==this._status)return;const s=(0,y.findArraysDifferences)(this._data,t,this._idField,this._keys,this._useDeepEquals);(s.added.length>0||s.modified.length>0||s.removed.length>0)&&(this._data=t,await this._dataCallback(s,e))};const{idField:e,keys:s,useDeepEquals:i,dataCallback:r,...o}=t;this._dataCallback=r,this._requester=new E({dataCallback:this._onNewData,...o}),this._idField=e,this._keys=s,this._useDeepEquals=i}start(){return this._status=1,this._requester.statusChanged.subscribe(this,this._onStatusChanged),this._requester.start()}stop(){this._status=0,this._requester.statusChanged.unsubscribe(this,this._onStatusChanged),this._requester.stop(),delete this._requester}pause(){this._status=0,this._requester.stop()}unpause(){this._status=1,this._requester.start()}changeHeaders(t){
this._requester.changeHeaders(t)}_onStatusChanged(t){this._status=t.requesterStatus,this.statusChanged.fire({requesterStatus:t.requesterStatus,errorMessage:t.errorMessage})}}var x=s(257596);const I={limit:1,market:2,stop:3,stoplimit:4},D={1:"limit",2:"market",3:"stop",4:"stoplimit"},R={placing:4,inactive:3,working:6,rejected:5,filled:2,cancelled:1},B=["qty","status","filledQty","avgPrice","limitPrice","stopPrice","parentId","duration","customFields","trailingStopPips","message"],L=["instrument","qty","side","avgPrice","unrealizedPl","realizedPl","stopLoss","trailingStopPips","takeProfit","message"],U=["available","total","btcValue"],z={checked:!1,text:""},V={positions:1e3,quotes:500,orders:500,accountManager:500,balances:1e3},H=i.t(null,void 0,s(513884)),Q=i.t(null,void 0,s(908746)),W=i.t(null,void 0,s(1078)),j=i.t(null,void 0,s(882956));function N(t){return t.s&&"ok"!==t.s?{valid:!1,errormsg:t.errmsg}:{valid:!0,data:t.d}}function $(t){return I[t=t||"market"]}function G(t){return D[t=t||2]}function K(t){return"sell"===t?-1:1}function J(t){return-1===t?"sell":"buy"}function X(t){return void 0!==t.accountManager&&Array.isArray(t.accountManager)&&t.accountManager.length>0}function Y(t){return t.amData&&Array.isArray(t.amData)&&t.amData.length>0?t.amData:function(t){const e=(0,y.formatNumber)(t.balance),s=(0,y.formatNumber)(t.unrealizedPl);return[[[e,void 0!==t.equity?(0,y.formatNumber)(t.equity):(0,y.formatNumber)(t.balance+t.unrealizedPl),s]]]}(t)}function Z(t){return t.map((t=>({price:t[0],volume:t[1]})))}function tt(t){return Object.assign({id:t.symbol},t)}function et(t){return void 0===t?[]:t.map((t=>{const{checked:e,mutable:s,...i}=t;return{...i,inputType:"Checkbox",value:Boolean(e),supportModify:s}}))}function st(t){return void 0===t?[]:t.map((t=>{const{mutable:e,...s}=t;return{...s,inputType:"ComboBox",preventModify:!e}}))}function it(t,e){return e.filter((e=>!(e in t)))}function rt(t){return![2,1].includes(t.status)}function ot(t,e){return{login:t,password:e,locale:window.locale}}class nt{constructor(t){var e;this._accounts=[],this._accountManagerTablesData=[],this._accountManagerTablesDelegates=[],this._fetchedBrokerSymbols=new Set,this._cryptoBalances=[],this._oAuth2AuthorizationProvider=null,this._requesters={},this._depthSubscriptions={},this._permittedSymbolSearchGroups=[],this._accessTokenExpirationTimeout=null,this._loginTasks=null,this._orderColumns=_,this._orderHistoryColumns=m,this._positionColumns=g,this._makeInstrumentOrderDialogCustomFieldsMemoized=(0,d.memoize)(this._makeInstrumentOrderDialogCustomFields,(t=>t.concat(this.currentAccount()))),this._makeAccountOrderDialogCustomFieldsMemoized=(0,d.memoize)(this._makeAccountOrderDialogCustomFields,(()=>this.currentAccount())),this._profitlossEmitters=new Map,this._reconnectOnFailCount=1,this._onQuotesUpdate=t=>{for(const e of t)if("ok"===e.s){const t=e.n,s=this._mapToTV(t);if(null!==s){const i=e.v;i.lp=i.lp||0,i.ch=i.ch||0,i.chp=i.chp||0;const o=this._instruments.get(t);if(void 0===o)throw new Error(`Instrument ${t} not found`)
;if(("forex"===o.type||"cfd"===o.type)&&void 0!==o.pipSize){const t=(0,r.ensureDefined)(o.minPriceStep);i.spread=n()(i.ask).minus(i.bid).div(t).toNumber()}i.buyPipValue&&i.sellPipValue&&this._pipValueSubscriptions.has(t)&&(this._host.pipValueUpdate(s,{buyPipValue:i.buyPipValue,sellPipValue:i.sellPipValue}),o.pipValue=i.buyPipValue),this._currentQuotes.set(s,{ask:i.ask,bid:i.bid});const a={...i,isHalted:i.halted,isHardToBorrow:i.hardToBorrow,isNotShortable:i.notShortable};this._host.realtimeUpdate(s,a)}else this._logger.logError("Cannot map symbol")}},this._onAccountStateUpdate=t=>{this._setAccountSummaryRowData(t);const e=Y(t);this._setAccountManagerTableData(e)},this._onCryptoBalancesUpdate=t=>{const e=(0,y.findArraysDifferences)(this._cryptoBalances,t,"symbol",U);[...e.added,...e.modified].forEach((t=>{const e=this._cryptoBalanceIndexBySymbol(t.symbol);-1!==e?this._cryptoBalances[e]=t:this._cryptoBalances.push(t);const s=tt(t);this._cryptoBalanceTableChangeDelegate.fire(s),this._host.cryptoBalanceUpdate(t.symbol,t)})),e.removed.forEach((t=>{const e=this._cryptoBalanceIndexBySymbol(t.symbol);if(-1!==e){const s=0,i=0,r=0,o=Object.assign({},t,{total:s,available:i,btcValue:r});this._cryptoBalances[e]=o;const n=tt(o);this._cryptoBalanceTableChangeDelegate.fire(n)}}))},this._onOrdersUpdate=t=>{const e=this._createTvOrders(t.added),s=this._createTvOrders(t.modified),i=[];this._restOrders.push(...t.added);for(const e of t.modified)this._restOrders[this._restOrderIndexById(e.id)]=e;this._tvOrders.push(...e),i.push(...e);for(const t of s)this._tvOrders[this._tvOrderIndexById(t.id)]=t,i.push(t);for(const t of i){if(1===t.parentType){const e=this._tvOrderById(t.parentId);i.includes(e)||(this._updateParentBrackets(e,t),this._host.orderUpdate(e))}else if(2===t.parentType){const e=this._tvPositionById(t.parentId);e&&e.qty>0&&(this._updateParentBrackets(e,t),this._host.positionPartialUpdate(e.id,{stopLoss:e.stopLoss,trailingStopPips:e.trailingStopPips,takeProfit:e.takeProfit}))}else if(!t.parentType){const e=this._getOrderBrackets(t.id);void 0!==e.stopLoss&&(t.stopLoss=e.stopLoss),void 0!==e.trailingStopPips&&(t.trailingStopPips=e.trailingStopPips,t.trailingStopPrice=e.trailingStopPrice),void 0!==e.takeProfit&&(t.takeProfit=e.takeProfit)}this._host.orderUpdate(t)}},this._onPositionsUpdate=async t=>{const e=[],s=this._createTVPositions(t.added),i=this._createTVPositions(t.modified);for(const e of t.added)this._addOrModifyPosition(e,this._restPositions);for(const e of t.modified)this._restPositions[this._restPositionIndexById(e.id)]=e;for(const t of s)this._updatePriceFormatterCacheForSymbol(t.symbol),this._updatePositionBrackets(t),this._host.positionUpdate(t),this._updatePositionPL(t),e.push((0,r.ensureDefined)(t.brokerSymbol,"Add position: Broker symbol")),this._addOrModifyPosition(t,this._tvPositions);for(const t of i){const s=this._tvPositionById(t.id);if(void 0===s)return;this._updatePositionBrackets(t),this._updatePositionPL(t),this._host.positionUpdate(t),s.side===t.side&&s.qty===t.qty||e.push((0,
r.ensureDefined)(t.brokerSymbol,"Update position: Broker symbol")),this._addOrModifyPosition(t,this._tvPositions)}t.removed.forEach((t=>{const s=this._tvPositionById(t.id);if(void 0===s)return;const i=this._restPositionById(t.id);s.qty=0,i.qty=0,e.push((0,r.ensureDefined)(s.brokerSymbol,"Remove position: Broker symbol"));const o=this._makePLEmitterKey(s),n=this._profitlossEmitters.get(o);void 0!==n&&(n.stop(),this._profitlossEmitters.delete(o)),this._host.positionUpdate(s)})),this._ensuredConfigFlags().supportExecutions&&await this._requestExecutionsBySymbols(e)};const{host:s,metainfo:i,accessToken:o=null,isFastRenewTokenEnabled:u,requestsEnvironment:l,customFetch:c}=t;if(this._host=s,this._isFastRenewTokenEnabled=u,this._requestsEnvironment=l,this._customFetch=c,this._restFetch=F(c),this._metainfo=i,this._realtimeSubscriptions=new Set,this._pipValueSubscriptions=new Set,this._quotesSubscriptions=new Map,this._currentQuotes=new Map,this._priceFormatterCache=new Map,this._instruments=new Map,this._initData(),this._tokenStorageKey=String("rest-token"),this._permittedSymbolSearchGroups=[(0,r.ensureDefined)(i.id)],this._lastAccountIdKey=String("rest-last-account-id-"+i.id),this._logger=s.getLogger(),this._status=this._host.factory.createWatchedValue(3),this._account=s.factory.createWatchedValue({id:"",name:"",currencySign:"",config:{},instruments:[],type:a.AccountType.Demo}),(null===(e=this._metainfo.configFlags)||void 0===e?void 0:e.supportUnhideSymbolSearchGroups)||this._createMapper(),o){const t=Date.now()+432e6;this._saveAccessToken({access_token:o,expiration:t}).then((()=>this._setAccessTokenExpirationTimeout(t)))}this._setAccountBinded=this._setAccount.bind(this),this._createButtonDropdownOptions(),this._customFormatters=[{name:"avgPriceFormatter",formatText:({values:[t,e]})=>{const s=this._priceFormatterCache.get(e);return s?s.format(t):String(t)}},{name:"cryptoValueInCurrencyFormatter",formatText:({values:[t,e]})=>`${t} ${e}`}],this._cryptoBalanceTableChangeDelegate=this._host.factory.createDelegate()}tryRestoreSession(){this._tryRestorePreviousSession()}chartContextMenuActions(t,e){return this._host.defaultContextMenuActions(t,e)}async accountsMetainfo(){return this._accounts}setCurrentAccount(t){const e=this._accounts.find((e=>e.id===t));void 0!==e&&this._account.setValue(e)}accountManagerInfo(){const t=this._accountSummaryRowData.titles.map(((t,e)=>({text:t,wValue:this._accountSummaryRowData.values[e].readonly(),formatter:this._accountSummaryRowData.formatters[e],isDefault:!0}))),e=[],o=this._ensuredConfigFlags().supportOrderBrackets||this._ensuredConfigFlags().supportPositionBrackets,n=this._ensuredConfigFlags().supportBalances;if(X(this._brokerConfig))if(n){const t=0!==this._cryptoBalances.length?Object.keys(this._cryptoBalances[0]):f.map((t=>t.id)),s=f.filter((e=>t.includes(e.id))),i=Object.assign({},{id:"cryptoBalances",name:"Balances",getData:()=>Promise.resolve(this._cryptoBalances.map((t=>tt(t)))),changeDelegate:this._cryptoBalanceTableChangeDelegate,columns:s});e.push(i)}else{const t=(0,
r.ensure)(this._brokerConfig.accountManager,"Account manager info: Account manager").map(((t,e)=>({id:t.id,title:void 0!==t.title&&t.title.length>0?t.title:i.t(null,void 0,s(805932)),getData:()=>Promise.resolve(this._accountManagerTablesData[e]),changeDelegate:this._accountManagerTablesDelegates[e],columns:t.columns.map((t=>({label:t.title,help:t.tooltip,id:t.id,dataFields:[t.id],formatter:t.formatter,notSortable:!t.sortable,tooltip:t.tooltip,isCapitalize:t.isCapitalize})))})));e.push(...t)}const a=(0,r.ensureDefined)(this._metainfo),u=this._brokerConfig.durations&&this._brokerConfig.durations.some((t=>Boolean(t.hasDatePicker||t.hasTimePicker))),l=t=>o||"stopLoss"!==t.id&&"takeProfit"!==t.id,c=t=>this._ensuredConfigFlags().supportTrailingStop||"trailingStopPrice"!==t.id,d=void 0!==a.customPositionColumnTitles&&a.customPositionColumnTitles.length>0?this._positionColumns.map((t=>{const e=(0,r.ensureDefined)(a.customPositionColumnTitles,"Account manager info: Custom position column titles").find((e=>e.hasOwnProperty(t.id)));return t.label=void 0!==e?e[(0,r.ensureDefined)(t.id,"Account manager info: Custom position column title property")]:t.label,t})):this._positionColumns,h={accountTitle:(0,r.ensure)(this._metainfo.title),orderColumns:this._orderColumns.filter(l).filter((t=>this._brokerConfig.durations||"expiry"!==t.id)).filter((t=>u||"expiryTime"!==t.id)).filter((t=>this._ensuredConfigFlags().supportPartialOrderExecution||"filledQty"!==t.id)).filter(c),pages:[{id:"summary",title:i.t(null,void 0,s(736846)),tables:e}],positionColumns:d.filter(l).filter((t=>this._ensuredConfigFlags().supportMultiposition||"id"!==t.id)).filter(c),summary:t,customFormatters:this._customFormatters};return this._ensuredConfigFlags().supportOrdersHistory&&(h.historyColumns=this._orderHistoryColumns.filter(l)),h}currentAccount(){return this._account.value().id}currentAccountType(){return 0!==this._accounts.length?this._accounts.some((t=>t.type===a.AccountType.Live))?a.AccountType.Live:a.AccountType.Demo:void 0}async executions(t){const e=this._mapFromTV(t);return null!==e&&!1===this._fetchedBrokerSymbols.has(e)&&await this._requestExecutions(e),this._tvExecutions.filter((e=>e.symbol===t))}orders(){return Promise.resolve(this._tvOrders)}async ordersHistory(){const t=await this._getOrdersHistoryByAccountId(this._account.value().id);return this._createTvOrders(t)}positions(){return Promise.resolve(this._tvPositions)}async cancelOrder(t){return this._restFetch({requestMetainfo:this._requestsEnvironment.orderIdRequestMetainfo(this._getAccountIdForUrl(),t),accessToken:this._getAccessToken(),method:T.Delete,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async modifyOrder(t,e){if(2===t.parentType)return this._modifyPositionBracketsByOrder(t);if(1===t.parentType){const s=this._tvOrderById((0,r.ensure)(t.parentId,"Modify order: Parent id"));return this._updateParentBrackets(s,t),2!==s.status?this.modifyOrder(s,e):this._modifySingleOrder(t,e)}return this._modifySingleOrder(t,e)}async placeOrder(t,e){var s
;const i=this._ensuredConfigFlags().supportDigitalSignature;let r=null;if(void 0===t.customFields){const e=this._makeOrderDialogCustomFields(t.symbol).find((t=>"forceUserEnterInitialValue"in t&&t.forceUserEnterInitialValue));if(void 0!==e)throw new Error("To place order you need to select a {fieldTitle} in the order ticket.".replace("{fieldTitle}",e.title))}if(i){const e=(null===(s=t.customFields)||void 0===s?void 0:s.digitalSignature)||this._getDigitalSignatureState();if(r=e.text,""===r)throw new Error("Digital signature is not specified. Please input the digital signature. In order to use instant order placement the field should be saved");await this._setDigitalSignatureState(e)}const o=Object.assign({},t.customFields);return delete o.digitalSignature,this._placeOrder(t,r,o,e)}async cancelOrders(t,e,s){return(()=>Promise.all(s.map((t=>this.cancelOrder(t)))).then((()=>{})))()}editPositionBrackets(t,e){const r=this._tvPositionById(t);if(void 0===r)throw new q.UserFriendlyError({detailedErrorMessage:`Failed to edit position bracket: Position ${t} not found`,userFriendlyMessage:i.t(null,void 0,s(89187))});const o={...e},n=this._currentQuotes.get(r.symbol);return void 0!==n&&(o.currentAsk=n.ask,o.currentBid=n.bid),this._restFetch({requestMetainfo:this._requestsEnvironment.positionIdRequestMetainfo(this._getAccountIdForUrl(),t),accessToken:this._getAccessToken(),method:T.Put,body:o,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}reversePosition(t,e){const s=this._tvPositionById(t);if(void 0===s)throw new Error(`Failed to reverse position: Position ${t} not found`);const i=1===s.side?"sell":"buy",r=Object.assign({side:i},e);return this._restFetch({requestMetainfo:this._requestsEnvironment.positionIdRequestMetainfo(this._getAccountIdForUrl(),t),accessToken:this._getAccessToken(),method:T.Put,body:r,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}closePosition(t,e){return this._restFetch({requestMetainfo:this._requestsEnvironment.positionIdRequestMetainfo(this._getAccountIdForUrl(),t),accessToken:this._getAccessToken(),method:T.Delete,body:{amount:e},includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async isTradable(t){var e;const s=this._mapFromTV(t);if(null!==s){const t=this._instruments.has(s),e={tradable:t};if(!t){const t=this._getAccountWithTradableSymbol(s);null!==t&&(e.solutions={changeAccount:t.id},e.shortReason=H,e.reason=H)}return e}if(void 0!==this._metainfo.symbolPrefix){const s=t.split(":")[1],i=`${null!==(e=this._account.value().prefix)&&void 0!==e?e:this._metainfo.symbolPrefix}:${s}`,r=this._mapFromTV(i);if(null!==r){if(void 0!==this._instruments.get(r))return{tradable:!1,reason:Q,shortReason:Q,solutions:{changeSymbol:i}}}}return{tradable:!1}}subscribeRealtime(t){const e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.add(e),this._subscribeQuotes(e)):this._logger.logError("Symbol not found")}unsubscribeRealtime(t){const e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.delete(e),
this._unsubscribeQuotes(e)):this._logger.logError("Symbol not found")}subscribePipValue(t){const e=this._mapFromTV(t);if(null!==e){if(!this._instrumentInfo(e).hasQuotes)return;this._pipValueSubscriptions.add(e),this._subscribeQuotes(e)}else this._logger.logError("Symbol not found")}unsubscribePipValue(t){const e=this._mapFromTV(t);null!==e?this._pipValueSubscriptions.has(e)&&(this._pipValueSubscriptions.delete(e),this._unsubscribeQuotes(e)):this._logger.logError("Symbol not found")}subscribeDOME(t){const e=this._mapFromTV(t);if(null!==e){const s=this._onDepthUpdate.bind(this,t),i=new E({requestMetainfo:this._requestsEnvironment.depthRequestMetainfo(this._getAccountIdForUrl(),e),headers:this._getHeaders(),dataCallback:s,requestInterval:this._getPullingInterval("quotes"),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader,extractResponseData:N,customFetch:this._customFetch});i.start(),this._depthSubscriptions[t]={callback:s,requester:i}}else this._logger.logError("Symbol not found")}unsubscribeDOME(t){try{this._depthSubscriptions[t].requester.stop(),delete this._depthSubscriptions[t]}catch(t){this._logger.logError((0,y.getLoggerMessage)(t))}}async signIn(t,e,o,n){this._setStatus(2),await this._host.credentialsStorage.clear(this._tokenStorageKey);try{let o;this._oAuth2ProviderType();if(this._isSimplePasswordAuthorizationType()&&(o=async()=>{const s=await this._authorize(t,e);await this._saveAccessToken(s),await this._setAccessTokenExpirationTimeout(s.expiration)}),this._isTwoFactorAuthorizationType()){if(void 0===(null==n?void 0:n.verificationCode)){const r=await this._authorizeRequestTwoFactorCode(t,e);if(!("twoFactorMessage"in r))throw new Error(i.t(null,void 0,s(212367)));return void this._setStatus(4,{message:r.twoFactorMessage,disconnectType:a.DisconnectType.TwoFactorRequired})}o=async()=>{const s=await this._authorizeWithTwoFactorCode(t,e,(0,r.ensureDefined)(n.verificationCode,"Signin: Verification code"));await this._saveAccessToken(s),await this._setAccessTokenExpirationTimeout(s.expiration)}}await this._setAndStartLoginTasks(o),this._createButtonDropdownOptions(),this._reconnectOnFailCount=1,this._setStatus(1),this._updatePLEmitters()}catch(t){this._logger.logError("Failed to connect to broker: "+(0,y.getLoggerMessage)(t));const{disconnectionInfo:e,connectionStatus:s}=(0,x.extractDisconnectionInfoAndConnectionStatus)(t);this._setStatus(s,e),await this._disconnect()}}async symbolInfo(t){const e=this._mapFromTV(t);if(null!==e)return this._instrumentInfo(e);throw new Error("Symbol not found")}connectionStatus(){return this._status.value()}async disconnect(t=!1){await this._disconnect(t),null!==this._loginTasks&&await this._loginTasks.terminate(),this._setStatus(3,{message:void 0,disconnectType:a.DisconnectType.LogOut})}supportFloatingPanel(){return!0}getRealtimeDataCheckParams(){return{token:this._getAccessToken()}}getVerifyLiveAccountParams(){return{token:this._getAccessToken()}}unhideSymbolSearchGroups(){return this._permittedSymbolSearchGroups}async formatter(t){
return this._getPriceFormatterForSymbol(t)}async spreadFormatter(t){const e=this._mapFromTV(t);if(null!==e){const s=this._instruments.get(e);return void 0===s||"forex"!==s.type&&"cfd"!==s.type?this._host.defaultFormatter(t,!1):this._host.numericFormatter(1)}throw new Error("Symbol not found")}quantityFormatter(t){const e=this._mapFromTV(t);if(null!==e){const t=this._instruments.get(e);if(void 0!==t&&"crypto"===t.type)return this._host.quantityFormatter()}return this._host.quantityFormatter()}async previewOrder(t){const e=this._orderFromTV(t);return function(t){return"id"in t}(t)&&(e.id=t.id),void 0!==t.customFields&&Object.assign(e,t.customFields),this._restFetch({requestMetainfo:this._requestsEnvironment.orderPreviewRequestMetainfo(this._getAccountIdForUrl()),accessToken:this._getAccessToken(),method:T.Post,body:e,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async getOrderDialogOptions(t){return{customFields:this._makeOrderDialogCustomFields(t)}}getValidationRules(t){var e,s,i;const r=this._mapFromTV(t);if(null!==r)return null===(i=null===(s=null===(e=this._instruments.get(r))||void 0===e?void 0:e.ui)||void 0===s?void 0:s.validationRules)||void 0===i?void 0:i.map((t=>({...t,severity:"error"})))}async leverageInfo(t){return this._makeLeverageRequest(t,T.Post,this._requestsEnvironment.getLeverageRequestMetainfo(this._getAccountIdForUrl()))}async setLeverage(t){return this._makeLeverageRequest(t,T.Post,this._requestsEnvironment.setLeverageRequestMetainfo(this._getAccountIdForUrl()))}async previewLeverage(t){return this._makeLeverageRequest(t,T.Post,this._requestsEnvironment.previewLeverageRequestMetainfo(this._getAccountIdForUrl()))}async _updateMapper(t,e){return this._mapper=this._host.createMapperSync(t,e),this._mapper.ready()}async _updateAccount(t){void 0!==t.prefix&&t.prefix!==this._currentAccountPrefix&&(this._currentAccountPrefix=t.prefix,await this._updateMapper(this._metainfo.id,this._makeSymbolMapperOptions(t.prefix))),this._saveAccountId(t),this._account.setValue(t);const e=t.durations?t.durations:this._originalBrokerConfig.durations;this._brokerConfig=Object.assign({},this._originalBrokerConfig,t.ui,{durations:e}),this._metainfo.configFlags=Object.assign(this._metainfo.configFlags,t.config),this._ensuredConfigFlags().supportStopOrdersInBothDirections&&(this._ensuredConfigFlags().supportStopOrdersInBothDirectionsInUI=!0),this._host.patchConfig(this._ensuredConfigFlags()),this._makeAccountSummaryRowData(),this._setCustomFields(t);for(const e of t.instruments)"forex"!==e.type&&"cfd"!==e.type||void 0===e.pipSize||(e.minPriceStep=n()(10).pow(-(0,h.numOfDecimalPlaces)(e.pipSize)).toNumber()),this._instruments.set(e.name,e);await this._initRequesters();const s=await this._getAccountState();for(let t=0;t<(0,r.ensure)(this._brokerConfig.accountManager,"Update account: Account manager").length;t++){const t=this._host.factory.createDelegate();this._accountManagerTablesDelegates.push(t),this._accountManagerTablesData.push([{}])}this._setAccountManagerTableData(Y(s)),
this._setAccountSummaryRowData(s),this._brokerConfig.durations&&this._host.setDurations(function(t){const e=[];for(const s of t){const t={name:s.title,value:s.id,hasDatePicker:s.hasDatePicker,hasTimePicker:s.hasTimePicker};void 0!==s.supportedOrderTypes&&(t.supportedOrderTypes=s.supportedOrderTypes.map((t=>$(t)))),"default"in s&&(t.default=s.default),e.push(t)}return e}(this._brokerConfig.durations)),this._changeQuotesRequesterUrl()}async _getAccounts(){const t=await this._restFetch({requestMetainfo:this._requestsEnvironment.accountsRequestMetainfo(),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader}),e=this._metainfo.defaultAccountType||a.AccountType.Demo;if(!Array.isArray(t))throw new q.UserFriendlyError({detailedErrorMessage:W+": Response is not an array",userFriendlyMessage:W});if(0===t.length)throw new q.UserFriendlyError({detailedErrorMessage:W+": Response is empty",userFriendlyMessage:W});for(const s of t){const t=it(s,["id","name","type","config"]);if(0!==t.length)throw new q.UserFriendlyError({detailedErrorMessage:W+`: Required fields are missing: ${t.join(", ")}`,userFriendlyMessage:W});s.currency=s.currency||"",s.currencySign=s.currencySign||"",s.type=s.type||e}return t}async _setAccount(t){const e=1===this.connectionStatus();this._cleanup(),e&&this._setStatus(2),await this._updateAccount(t),e&&(this._setStatus(1),this._updatePLEmitters())}_updatePLEmitters(){var t;(null===(t=this._metainfo.configFlags)||void 0===t?void 0:t.supportPLUpdate)?this._stopPLEmitters():this._startPLEmitters()}_setAndStartLoginTasks(t){const e=[];return void 0!==t&&e.push(t),e.push((()=>this._getBrokerConfig().then((t=>{this._originalBrokerConfig=t}))),...this._initializeAccountTasks()),this._loginTasks=new y.TasksWithTermination(e),this._loginTasks.execute()}_startPLEmitters(){this._profitlossEmitters.forEach((t=>{t.start()}))}_createOAuth2AuthorizationProvider(t,e){var s;const{passLocalesLangInOAuth:i,supportCredentialsHeader:o}=this._ensuredConfigFlags(),n={isFastRenewTokenEnabled:this._isFastRenewTokenEnabled,brokerId:null!==(s=this._metainfo.altBrokerId)&&void 0!==s?s:(0,r.ensureDefined)(this._metainfo.id),environmentType:t,logger:this._logger,passLocalesLangInOAuth:i};return 0===e?new OAuth2ImplicitFlowWithRenewTokenAuthorizationProvider(n):(n.passRedirectUrl=!0,new OAuth2CodeFlowAuthorizationProvider({providerConfig:n,credentialsStorage:this._host.credentialsStorage,includeCredentials:o}))}_instrumentInfo(t){const e=this._instruments.get(t);if(!e)throw new Error(`Symbol ${t} not found in instruments`);const s={qty:{min:e.minQty||1,max:e.maxQty||1e9,step:e.qtyStep||1},units:e.units,pipValue:e.pipValue||1,pipSize:e.pipSize||.01,minTick:e.minTick||.01,description:e.description,brokerSymbol:t,hasQuotes:!e.hasOwnProperty("hasQuotes")||Boolean(e.hasQuotes)};return e.hasOwnProperty("lotSize")&&(s.lotSize=e.lotSize),e.hasOwnProperty("stopPriceStep")&&(s.stopPriceStep=e.stopPriceStep),e.hasOwnProperty("limitPriceStep")&&(s.limitPriceStep=e.limitPriceStep),
"type"in e&&(s.type=e.type),"marginRate"in e&&(s.marginRate=e.marginRate),"baseCurrency"in e&&(s.baseCurrency=e.baseCurrency),"quoteCurrency"in e&&(s.quoteCurrency=e.quoteCurrency),"variableMinTick"in e&&void 0===e.stopPriceStep&&void 0===e.limitPriceStep&&(s.variableMinTick=e.variableMinTick),s}_subscribeQuotes(t){const e=this._quotesSubscriptions.get(t),s=void 0===e?1:e+1;this._quotesSubscriptions.set(t,s),1===s&&this._changeQuotesRequesterUrl()}_unsubscribeQuotes(t){const e=this._quotesSubscriptions.get(t);if(void 0!==e)return 1===e?(this._quotesSubscriptions.delete(t),void this._changeQuotesRequesterUrl()):void this._quotesSubscriptions.set(t,e-1)}async _disconnect(t=!1){this._isOAuth2AuthorizationType()&&this._cleanAndDestroyOAuth2AuthorizationProvider(),this._cleanup(),this._cleanAccessTokenExpirationTimeout(),!1===t&&(await this._host.credentialsStorage.clear(this._tokenStorageKey),this._ensuredConfigFlags().supportLogout&&await this._logout()),this._account.unsubscribe(this._setAccountBinded)}_getAccessToken(){return this._accessToken}_initializeAccountTasks(){const t=[];return t.push((()=>this._getAccounts().then((t=>{this._accounts=t})))),t.push((()=>Promise.all(this._accounts.map((t=>this._getInstrumentsByAccountId(t.id).then((e=>{t.instruments=e}))))))),this._ensuredConfigFlags().supportUnhideSymbolSearchGroups?t.push((async()=>{this._permittedSymbolSearchGroups=await this._getPermittedSymbolSearchGroups();const t=this._getLastOrDefaultAccount();this._currentAccountPrefix=t.prefix,await this._updateMapper(this._metainfo.id,this._makeSymbolMapperOptions(t.prefix))})):t.push((()=>this._mapper.ready())),t.push((()=>{const t=this._getLastOrDefaultAccount();return this._setCustomFields(t),this._setAccountBinded(t).then((()=>this._account.subscribe(this._setAccountBinded)))})),t}_makeSymbolMapperOptions(t){return{unhideSymbolSearchGroups:this.unhideSymbolSearchGroups(),exchange:t}}_setCustomFields(t){var e,s,i,r,o,n;const a=null!==(s=null===(e=t.ui)||void 0===e?void 0:e.orderCustomFields)&&void 0!==s?s:this._originalBrokerConfig.orderCustomFields;t.config.supportOrderCustomFields&&void 0!==a&&(this._orderColumns=this._mergeCustomFieldColumns(_,a));const u=null!==(r=null===(i=t.ui)||void 0===i?void 0:i.orderHistoryCustomFields)&&void 0!==r?r:this._originalBrokerConfig.orderHistoryCustomFields;t.config.supportOrderHistoryCustomFields&&void 0!==u&&(this._orderHistoryColumns=this._mergeCustomFieldColumns(m,u));const l=null!==(n=null===(o=t.ui)||void 0===o?void 0:o.positionCustomFields)&&void 0!==n?n:this._originalBrokerConfig.positionCustomFields;t.config.supportPositionCustomFields&&void 0!==l&&(this._positionColumns=this._mergeCustomFieldColumns(g,l))}_changeQuotesRequesterUrl(){const t=this._getQuotesRequestMetainfo();void 0!==this._requesters.quotes&&this._requesters.quotes.stop(),null!==t&&(void 0===this._requesters.quotes?(this._requesters.quotes=new E({requestMetainfo:t,headers:this._getHeaders(),dataCallback:this._onQuotesUpdate,requestInterval:this._getPullingInterval("quotes"),
includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader,extractResponseData:N,customFetch:this._customFetch}),this._requesters.quotes.statusChanged.subscribe(this,this._onRequesterStatusUpdate)):this._requesters.quotes.changeRequestMetainfo(t),this._requesters.quotes.start())}_stopRequester(t){void 0!==t&&t.stop()}async _requestExecutions(t){this._fetchedBrokerSymbols.add(t);const e=await this._restFetch({requestMetainfo:this._requestsEnvironment.executionsRequestMetainfo(this._getAccountIdForUrl(),t),method:T.Get,accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader}),s=(0,y.findArraysDifferences)(this._restExecutions,e,"id",["id"]);for(const t of s.added){this._restExecutions.push(t);const e=this._executionToTv(t);this._tvExecutions.push(e),this._host.executionUpdate(e)}}_createMapper(){this._mapper=this._host.createMapperSync(this._metainfo.id,{unhideSymbolSearchGroups:this.unhideSymbolSearchGroups()})}async _requestExecutionsBySymbols(t){await Promise.all(t.map((t=>this._requestExecutions(t))))}_setAccountSummaryRowData(t){var e;const s=t.hasOwnProperty("equity")&&void 0!==t.equity?t.equity:t.balance+t.unrealizedPl;if(this._ensuredConfigFlags().supportCustomAccountSummaryRow){const e=(0,r.ensureDefined)(t.accountSummaryRowData,"Set Account Summary Row Data: Account summary row data");for(let t=0;t<e.length;t++)this._accountSummaryRowData.values[t].setValue(e[t])}else this._accountSummaryRowData.values[0].setValue(t.balance),this._accountSummaryRowData.values[1].setValue(s),(null===(e=this._metainfo.configFlags)||void 0===e?void 0:e.supportPLUpdate)?this._accountSummaryRowData.values[2].setValue(t.unrealizedPl):this._updateAccountPL();isFinite(s)&&this._host.equityUpdate(s)}_setAccountManagerTableData(t){if(0!==this._accountManagerTablesData.length)for(let e=0;e<t.length;e++){const s=t[e],i=this._accountManagerTablesData[e],o=(0,r.ensure)(this._brokerConfig.accountManager,"Set Account Manager Table Data: Account manager tables")[e].columns;i.length=s.length;for(let t=0;t<s.length;t++){const n=s[t],a={id:t};for(let t=0;t<n.length;t++){a[(0,r.ensure)(o[t].id)]=n[t]}i[t]=a,this._accountManagerTablesDelegates[e].fire(a)}}}async _createRequesters(){const t=this._ensuredConfigFlags(),e=t.supportCredentialsHeader;if(this._requesters={orders:new O({requestMetainfo:this._requestsEnvironment.ordersRequestMetainfo(this._getAccountIdForUrl()),headers:this._getHeaders(),dataCallback:this._onOrdersUpdate,includeCredentials:e,requestInterval:this._getPullingInterval("orders"),idField:"id",keys:B,extractResponseData:N,useDeepEquals:!0,customFetch:this._customFetch}),accountState:new E({requestMetainfo:this._requestsEnvironment.accountStateRequestMetainfo(this._getAccountIdForUrl()),method:T.Get,headers:this._getHeaders(),dataCallback:this._onAccountStateUpdate,includeCredentials:e,requestInterval:this._getPullingInterval("accountManager"),extractResponseData:N,customFetch:this._customFetch})},t.supportPositions){const t=new O({
requestMetainfo:this._requestsEnvironment.positionsRequestMetainfo(this._getAccountIdForUrl()),method:T.Get,headers:this._getHeaders(),dataCallback:this._onPositionsUpdate,requestInterval:this._getPullingInterval("positions"),idField:"id",keys:L,includeCredentials:e,extractResponseData:N,customFetch:this._customFetch});t.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.positions=t}if(t.supportBalances){const t=new E({requestMetainfo:this._requestsEnvironment.balancesRequestMetainfo(this._getAccountIdForUrl()),headers:this._getHeaders(),dataCallback:this._onCryptoBalancesUpdate,includeCredentials:e,requestInterval:this._getPullingInterval("balances"),extractResponseData:N,customFetch:this._customFetch});t.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.balances=t}(0,r.ensure)(this._requesters.orders).statusChanged.subscribe(this,this._onRequesterStatusUpdate)}async _startRequesters(){const t=[];Object.keys(this._requesters).forEach((e=>t.push((0,r.ensure)(this._requesters[e]).start()))),await Promise.all(t),this._logger.logInfo("Requesters started")}_stopAndDeleteRequesters(){Object.keys(this._requesters).forEach((t=>{const e=this._requesters[t];void 0!==e&&this._stopRequester(e)})),this._requesters={}}_changeRequestersHeaders(){Object.keys(this._requesters).forEach((t=>{const e=(0,r.ensure)(this._requesters[t]);e.pause(),e.changeHeaders(this._getHeaders()),e.unpause()}))}_cleanup(){this._stopAndDeleteRequesters(),this._cleanAndStopPLEmitters(),this._initData()}_cleanAndStopPLEmitters(){this._stopPLEmitters(),this._profitlossEmitters.clear()}_stopPLEmitters(){this._profitlossEmitters.forEach((t=>{t.stop()}))}_setStatus(t,e){this._status.value()!==t&&(this._status.setValue(t),this._host.connectionStatusUpdate(t,e))}async _onRequesterStatusUpdate(t){2===t.requesterStatus&&(this._reconnectOnFailCount<=3?(this._logger.logError(`Requester error: ${t.errorMessage}. Reconnecting count: ${this._reconnectOnFailCount++} of 3.`),this._setStatus(4,{message:t.errorMessage}),await this._disconnect(!0),this._tryReconnect()):(this._logger.logError(`Requester error: ${t.errorMessage}. Maximum reconnect count reached. Disconnecting.`),this._setStatus(3,{message:t.errorMessage,disconnectType:a.DisconnectType.FailedRestoring}),await this._disconnect(!1)))}_cryptoBalanceIndexBySymbol(t){return this._cryptoBalances.findIndex((e=>e.symbol===t))}_extractExpirationTime(t){return null===t.expiration?1/0:this._isOAuth2AuthorizationType()?t.expiration:1e3*t.expiration}async _tryConnect(){let t=this._getStoredAuthResult();if(null===t)return;this._setStatus(2);this._oAuth2ProviderType();if(Date.now()>=this._extractExpirationTime(t)-12e4)return function(){throw new Error("Token expired")}();this._accessToken=t.access_token,await this._setAndStartLoginTasks(),this._setAccessTokenExpirationTimeout(t.expiration),this._createButtonDropdownOptions(),this._setStatus(1),this._updatePLEmitters()}async _tryReconnect(){try{await this._tryConnect()}catch(t){this._logger.logError((0,
y.getLoggerMessage)(t)),this._setStatus(3,{message:(0,y.getErrorMessage)(t),disconnectType:a.DisconnectType.FailedRestoring}),await this._disconnect()}}async _tryRestorePreviousSession(){try{await this._tryConnect()}catch(t){const e=(0,y.getErrorMessage)(t);this._logger.logNormal(`Cannot restore session: ${e}`),this._setStatus(3,{message:void 0,disconnectType:a.DisconnectType.FailedRestoring}),await this._disconnect()}}_mergeCustomFieldColumns(t,e){const s=t.slice(),i=t.map((t=>t.id));for(const t of e){if(t.id in i){this._logger.logWarn(`Failed to add custom column. Column with id ${t.id} already exists.`);continue}const{id:e,title:o,tooltip:n,alignment:a}=t,u={label:o,id:e,dataFields:[e],help:n,notSortable:!0};void 0!==a&&((0,r.assert)(["left","right"].includes(a),"Cell alignment must be left or right"),u.alignment=a),s.splice(-1,0,u)}return s}_authorizeRequestTwoFactorCode(t,e){return this._restFetch({requestMetainfo:this._requestsEnvironment.authorizeRequestMetainfo(),method:T.Post,body:{...ot(t,e),twoFactorRequired:!0},includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}_authorizeWithTwoFactorCode(t,e,s){return this._restFetch({requestMetainfo:this._requestsEnvironment.authorizeRequestMetainfo(),method:T.Post,body:{...ot(t,e),twoFactorCode:s},includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _authorize(t,e){return this._restFetch({requestMetainfo:this._requestsEnvironment.authorizeRequestMetainfo(),method:T.Post,body:{...ot(t,e)},includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _getInstrumentsByAccountId(t){return this._restFetch({requestMetainfo:this._requestsEnvironment.instrumentsRequestMetainfo(t),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _getOrdersHistoryByAccountId(t){return this._restFetch({requestMetainfo:this._requestsEnvironment.ordersHistoryRequestMetainfo(t),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _getPermittedSymbolSearchGroups(){const t=await this._restFetch({requestMetainfo:this._requestsEnvironment.permissionsRequestMetainfo(),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader});return t.hasOwnProperty("groups")?t.groups:[(0,r.ensureDefined)(this._metainfo.id)]}async _getBrokerConfig(){const t=await this._restFetch({requestMetainfo:this._requestsEnvironment.brokerConfigRequestMetainfo(),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader});if(null===t)throw new q.UserFriendlyError({detailedErrorMessage:j+": Response is null",userFriendlyMessage:j});return X(t)||(t.accountManager=[{id:"accountSummary",title:"",columns:[{id:"balance",title:i.t(null,void 0,s(374444)),tooltip:"",sortable:!1},{id:"equity",title:i.t(null,void 0,s(959005)),tooltip:"",sortable:!1},{id:"profit",title:i.t(null,void 0,s(486323)),tooltip:"",sortable:!1}]}]),t}async _getAccountState(){
return this._restFetch({requestMetainfo:this._requestsEnvironment.accountStateRequestMetainfo(this._getAccountIdForUrl()),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _placeOrder(t,e,s,i){const r=this._orderFromTV(t);r.confirmId=i,null!==e&&(r.digitalSignature=e);const o=Object.assign(s,r);return this._restFetch({requestMetainfo:this._requestsEnvironment.ordersRequestMetainfo(this._getAccountIdForUrl(),(0,p.randomHashN)(10)),accessToken:this._getAccessToken(),method:T.Post,body:o,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _modifyOrder(t,e,s,i){const r={id:t.id,qty:t.qty};void 0===t.parentId&&(t.stopLoss&&(r.stopLoss=t.stopLoss),t.trailingStopPips&&(r.trailingStopPips=t.trailingStopPips),t.takeProfit&&(r.takeProfit=t.takeProfit)),void 0!==t.duration&&(r.durationType=t.duration.type,void 0!==t.duration.datetime&&(r.durationDateTime=Math.trunc(t.duration.datetime/1e3)));const o=this._currentQuotes.get(t.symbol);void 0!==o&&(r.currentAsk=o.ask,r.currentBid=o.bid),r.limitPrice=(t.type,t.limitPrice),r.stopPrice=(t.type,t.stopPrice),null!==e&&(r.digitalSignature=e);const n=Object.assign(s,r);n.confirmId=i,await this._restFetch({requestMetainfo:this._requestsEnvironment.orderIdRequestMetainfo(this._getAccountIdForUrl(),t.id),accessToken:this._getAccessToken(),method:T.Put,body:n,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _modifySingleOrder(t,e){const s=this._ensuredConfigFlags().supportDigitalSignature,i=t.customFields&&t.customFields.digitalSignature?t.customFields.digitalSignature:this._getDigitalSignatureState(),r=s?i.text:null;null!==r&&await this._setDigitalSignatureState(i);const o=Object.assign({},t.customFields);return delete o.digitalSignature,this._modifyOrder(t,r,o,e)}async _modifyPositionBracketsByOrder(t){if(void 0===this._tvPositionById(t.parentId))return;const e={...this._getPositionBrackets(t.parentId)};return 3===t.type&&(delete e.trailingStopPrice,t.stopType===a.StopType.TrailingStop?(delete e.stopLoss,e.trailingStopPips=t.trailingStopPips):(delete e.trailingStopPips,e.stopLoss=t.stopPrice)),1===t.type&&(e.takeProfit=t.limitPrice),this.editPositionBrackets((0,r.ensure)(t.brokerSymbol,"Edit position brackets: Broker symbol"),e)}_createTvOrders(t){return t.map((t=>this._orderToTV(t)))}_createTVPositions(t){return t.map((t=>this._positionToTV(t)))}_updatePositionPL(t){var e;if(null===(e=this._metainfo.configFlags)||void 0===e?void 0:e.supportPLUpdate){const e=this._tvPositionById(t.id);(null==e?void 0:e.unrealizedPl)!==t.unrealizedPl&&(this._host.plUpdate(t.id,t.unrealizedPl),this._host.positionPartialUpdate(t.id,{unrealizedPl:t.unrealizedPl}))}else{const e=this._makePLEmitterKey(t),s=this._profitlossEmitters.get(e);if(void 0!==s)s.positionUpdate(t),t.unrealizedPl=null==s?void 0:s.lastPL();else{const s=e=>{this._host.plUpdate(t.id,e),this._host.positionPartialUpdate(t.id,{unrealizedPl:e})},i=t.symbol,r=this._mapper.tvToBroker(i);try{
if(null===r)throw new Error(`Symbol ${i} not found in mapping`);const o=this._instrumentInfo(r),n=this._host.createPLEmitter(t,s,o);this._profitlossEmitters.set(e,n),1===this.connectionStatus()&&n.start()}catch(t){this._logger.logError((0,y.getLoggerMessage)(t))}}}}_updateAccountPL(){let t=0;this._profitlossEmitters.forEach((e=>{t+=e.lastPL()})),this._accountSummaryRowData.values[2].setValue(t)}_updatePositionBrackets(t){this._findPositionBracketOrders(t.id).forEach((e=>this._updateParentBrackets(t,e)))}_addOrModifyPosition(t,e){const s=e.findIndex((e=>e.id===t.id));-1!==s?e[s]=t:e.push(t)}_makePLEmitterKey(t){return this._ensuredConfigFlags().supportMultiposition?t.id:t.symbol}_restPositionIndexById(t){return this._restPositions.findIndex((e=>e.id===t))}_restPositionById(t){const e=this._restPositions.find((e=>e.id===t));if(!e)throw new Error("Cannot find REST position: "+t);return e}_restOrderIndexById(t){return this._restOrders.findIndex((e=>e.id===t))}_tvPositionById(t){return this._tvPositions.find((e=>e.id===t))}_tvOrderIndexById(t){return this._tvOrders.findIndex((e=>e.id===t))}_tvOrderById(t){const e=this._tvOrders.find((e=>e.id===t));if(!e)throw new Error("Cannot find TV order");return e}_getAccountIdForUrl(){const t=this.currentAccount();return(0,r.assert)(!!t,"Unable to get base url - account is not properly initialized"),t}_getPullingInterval(t){let e=V[t];if(this._brokerConfig.hasOwnProperty("pullingInterval")&&void 0!==this._brokerConfig.pullingInterval){const s=this._brokerConfig.pullingInterval[t];void 0!==s&&(e=s)}return e}_getQuotesRequestMetainfo(){const t=Array.from(this._quotesSubscriptions.keys()).filter((t=>this._instruments.has(t)));return 0===t.length?null:this._requestsEnvironment.quotesRequestMetainfo(this._getAccountIdForUrl(),t)}async _logout(){try{await this._restFetch({requestMetainfo:this._requestsEnvironment.logoutRequestMetainfo(),accessToken:this._getAccessToken(),method:T.Post,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}catch(t){this._logger.logError(`Failed to logout request: ${(0,y.getLoggerMessage)(t)}`)}}_getHeaders(){return P(this._getAccessToken())}_orderToTV(t){const e=this._mapToTV(t.instrument);null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument);const s={id:t.id,type:$(t.type),side:K(t.side),symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),filledQty:t.filledQty,status:(i=t.status,R[i]),avgPrice:t.avgPrice,limitPrice:t.limitPrice,stopPrice:t.stopPrice};var i;if(t.parentId&&(s.parentId=t.parentId,s.parentType=this._getOrderParentType(t.parentType),t.isTrailingStop&&(s.stopType=a.StopType.TrailingStop,s.trailingStopPips=t.trailingStopPips)),t.duration){s.duration={type:t.duration.type};const e=this._getOrderDuration(t.duration);if((0,r.assert)(void 0!==e,"Order duration is not in durations list. Please check the broker or account duration configuration"),s.expiry=void 0!==e?e.title:t.duration.type,t.duration.hasOwnProperty("datetime")&&void 0!==t.duration.datetime){const i=1e3*t.duration.datetime
;s.duration.datetime=i,s.expiryTime={dateOrDateTime:i,hasTime:(0,r.ensureDefined)(e).hasTimePicker}}}return void 0!==t.message&&((0,y.isOrderOrPositionMessageType)(t.message.type)?s.message=t.message:this._logger.logError(`Order message type '${t.message.type}' is not supported`)),void 0!==t.lastModified&&(s.updateTime=1e3*t.lastModified),void 0!==t.customFields&&(s.customFields=this._customFieldsToTv(t.customFields)),this._mergeCustomFields(t,s),s}_getOrderParentType(t){return"position"===t?2:1}_customFieldsToTv(t){const e={};for(const s of t)e[s.id]=s.value;return e}_mergeCustomFields(t,e){if(void 0!==t.customFields)for(const s of t.customFields)e[s.id]=s.value}_getOrderDuration(t){return(0,r.ensureDefined)(this._brokerConfig.durations,"Broker config: Durations").find((e=>e.id===(0,r.ensureDefined)(t).type))}_orderFromTV(t){var e;const s=this._mapFromTV(t.symbol);if(null!==s){const i={instrument:s,qty:t.qty,side:J(t.side),type:G(t.type),limitPrice:t.limitPrice,stopPrice:t.stopPrice};t.stopLoss&&(i.stopLoss=t.stopLoss),t.trailingStopPips&&(i.trailingStopPips=t.trailingStopPips),t.takeProfit&&(i.takeProfit=t.takeProfit),t.duration&&(i.durationType=t.duration.type,t.duration.datetime&&(i.durationDateTime=Math.trunc(t.duration.datetime/1e3)));const r=null!==(e=this._currentQuotes.get(t.symbol))&&void 0!==e?e:t.currentQuotes;return void 0!==r&&(i.currentAsk=r.ask,i.currentBid=r.bid),i}throw new Error("Cannot map symbol: "+t.symbol)}_leverageParamsFromTV(t){const e=this._mapFromTV(t.symbol);if(null===e)throw new Error(`Cannot map symbol: ${t.symbol}`);const s={instrument:e,side:J(t.side),orderType:G(t.orderType)};return"leverage"in t&&(s.leverage=t.leverage),void 0!==t.customFields&&Object.assign(s,t.customFields),s}_getBrackets(t){const e={};for(const s of t)3===s.type&&(s.stopType===a.StopType.TrailingStop?(e.trailingStopPips=s.trailingStopPips,e.trailingStopPrice=s.stopPrice):e.stopLoss=s.stopPrice),1===s.type&&(e.takeProfit=s.limitPrice);return e}_getOrderBrackets(t){const e=this._tvOrders.filter((e=>1===e.parentType&&e.parentId===t&&1!==e.status&&2!==e.status));return this._getBrackets(e)}_findPositionBracketOrders(t){return this._tvOrders.filter((e=>2===e.parentType&&e.parentId===t&&6===e.status))}_getPositionBrackets(t){const e=this._findPositionBracketOrders(t);return this._getBrackets(e)}_executionToTv(t){const e=this._mapToTV(t.instrument);return null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument),{id:t.id,symbol:e||"",brokerSymbol:t.instrument,price:t.price,qty:t.qty,side:K(t.side),time:1e3*t.time,orderId:t.orderId,isClose:t.isClose,positionId:t.positionId,commission:t.commission}}_positionToTV(t){const e=this._mapToTV(t.instrument);null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument);const s={id:t.id,symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),side:"buy"===t.side?1:-1,avgPrice:t.avgPrice,realizedPl:t.realizedPl,currency:this._account.value().currency};return void 0!==t.message&&((0,
y.isOrderOrPositionMessageType)(t.message.type)?s.message=t.message:this._logger.logError(`Position message type '${t.message.type}' is not supported`)),this._ensuredConfigFlags().supportPLUpdate&&(s.unrealizedPl=t.unrealizedPl),this._tvOrders.filter((t=>2===t.parentType&&t.parentId===s.id)).forEach((t=>this._updateParentBrackets(s,t))),this._mergeCustomFields(t,s),s}_mapToTV(t){return this._mapper.brokerToTv(t)}_mapFromTV(t){return this._mapper.tvToBroker(t)}_initData(){this._accountManagerTablesDelegates=[],this._accountManagerTablesData=[],this._restExecutions=[],this._tvExecutions=[],this._restOrders=[],this._tvOrders=[],this._restPositions=[],this._tvPositions=[],this._instruments.clear(),this._priceFormatterCache.clear(),this._currentQuotes.clear(),this._cryptoBalances=[],this._accountSummaryRowData={titles:[],values:[],formatters:[]}}_createButtonDropdownOptions(){const t=this._host.defaultDropdownMenuActions({tradingProperties:!0});this._host.setButtonDropdownActions(t)}async _initRequesters(){this._accounts.length>0&&(await this._createRequesters(),await this._startRequesters())}_getStoredAuthResult(){return this._host.credentialsStorage.load(this._tokenStorageKey)}async _setAccessTokenExpirationTimeout(t){if(null===t)return;let e,s=this._checkAccessTokenExpiration.bind(this);e=1e3*(0,r.ensureDefined)(t,"Access token expiration")-Date.now().valueOf(),e<0?await this._checkAccessTokenExpiration():(s=this._checkAccessTokenExpiration.bind(this),e+=1e4,this._accessTokenExpirationTimeout=c.setTimeout(s,e))}async _saveAccessToken(t){await this._host.credentialsStorage.save(this._tokenStorageKey,t),this._accessToken=t.access_token}async _checkAccessTokenExpiration(){const t=this._getStoredAuthResult();if(t&&1e3*(0,r.ensureNotNull)(t.expiration,"Stored authorization result expiration")<=Date.now().valueOf()){const t=i.t(null,void 0,s(643064));this._logger.logError(t),this._setStatus(4,{message:t,disconnectType:a.DisconnectType.LogOut}),await this._disconnect()}}_onDepthUpdate(t,e){const s={snapshot:!0,asks:Z(e.asks),bids:Z(e.bids)};this._host.domeUpdate(t,s)}_getAccountWithTradableSymbol(t){let e=null;for(const s of this._accounts)if(-1!==s.instruments.findIndex((e=>t===e.name))){e=s;break}return e}async _createPriceFormatter(t){try{if(await this._host.isFractional(t))return await this._host.defaultFormatter(t,!0);const e=this._mapFromTV(t);if(null===e)throw new Error("Symbol not found");const s=this._instrumentInfo(e),i=Math.pow(10,(0,h.numOfDecimalPlaces)(s.minTick)),r=n()(s.minTick).mul(i).toNumber();return this._host.factory.createPriceFormatter(i,r,!1,void 0,s.variableMinTick)}catch(e){return this._logger.logWarn(`Failed to create price formatter for symbol ${t}.`),this._host.factory.createPriceFormatter()}}async _getPriceFormatterForSymbol(t){let e=this._priceFormatterCache.get(t);return e||(e=await this._createPriceFormatter(t),this._priceFormatterCache.set(t,e)),e}async _updatePriceFormatterCacheForSymbol(t){if(!this._priceFormatterCache.has(t)){this._priceFormatterCache.set(t,null)
;const e=await this._createPriceFormatter(t);this._priceFormatterCache.set(t,e),this._tvPositions.filter((e=>e.symbol===t&&e.qty>0)).forEach((t=>this._host.positionUpdate(t)))}}_getAccountById(t){return this._accounts.find((e=>e.id===t))}_saveAccountId(t){this._host.settings.save(this._lastAccountIdKey,JSON.stringify(t.id))}_getLastOrDefaultAccount(){var t;const e=this._host.settings.load(this._lastAccountIdKey,void 0);return void 0===e?this._accounts[0]:null!==(t=this._getAccountById(JSON.parse(e)))&&void 0!==t?t:this._accounts[0]}_isTwoFactorAuthorizationType(){return"password"===this._ensuredConfigFlags().authorizationType&&Boolean(this._ensuredConfigFlags().supportTwoFactorAuthorization)}_isSimplePasswordAuthorizationType(){return"password"===this._ensuredConfigFlags().authorizationType&&!this._ensuredConfigFlags().supportTwoFactorAuthorization}_isOAuth2AuthorizationType(){return 2!==this._oAuth2ProviderType()}_oAuth2ProviderType(){const{authorizationType:t}=this._ensuredConfigFlags();return"oauth2-implicit-flow"===t?0:"oauth2-code-flow"===t?1:2}_makeDigitalSignatureCustomField(){return{inputType:"TextWithCheckBox",id:"digitalSignature",title:i.t(null,void 0,s(595699)),placeHolder:i.t(null,void 0,s(494548)),value:this._getDigitalSignatureState(),customInfo:{checkboxTitle:i.t(null,void 0,s(910553)),asterix:!0}}}async _setDigitalSignatureState(t){const e=t.checked?t:z;await this._host.credentialsStorage.save("digital-signature-state",e)}_getDigitalSignatureState(){const t=this._host.credentialsStorage.load("digital-signature-state");return null!==t?t:z}_makeAccountSummaryRowData(){let t=[],e=[];const r=[];if(this._ensuredConfigFlags().supportCustomAccountSummaryRow&&void 0!==this._brokerConfig.accountSummaryRow)for(const s of this._brokerConfig.accountSummaryRow)t.push(s.title),e.push(this._host.factory.createWatchedValue()),r.push("default");else t=[i.t(null,void 0,s(78231)),i.t(null,{context:"trading"},s(115497)),i.t(null,void 0,s(486323))],e=[this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue()],r.fill("fixed",0,2);this._accountSummaryRowData.titles=t,this._accountSummaryRowData.values=e,this._accountSummaryRowData.formatters=r}_cleanAccessTokenExpirationTimeout(){null!==this._accessTokenExpirationTimeout&&(c.clearTimeout(this._accessTokenExpirationTimeout),this._accessTokenExpirationTimeout=null)}_cleanAndDestroyOAuth2AuthorizationProvider(){null!==this._oAuth2AuthorizationProvider&&(this._oAuth2AuthorizationProvider.renewTokenDelegate().unsubscribe(this,this._onRenewAccessTokenHandler),this._oAuth2AuthorizationProvider.destroy(),this._oAuth2AuthorizationProvider=null)}async _onRenewAccessTokenHandler(t){if(null===t)return this._setStatus(3),void await this._disconnect();await this._saveAccessToken(t),this._changeRequestersHeaders()}_ensuredConfigFlags(){return(0,r.ensureDefined)(this._metainfo.configFlags,"Config flags")}_makeAccountOrderDialogCustomFields(t){var e;const s=null===(e=t.ui)||void 0===e?void 0:e.orderDialogCustomFields
;return void 0===s?[]:[...st(s.comboBox),...et(s.checkbox)]}_makeInstrumentOrderDialogCustomFields(t){var e,s;const i=this._mapFromTV(t);if(null===i)return[];const r=null===(s=null===(e=this._instruments.get(i))||void 0===e?void 0:e.ui)||void 0===s?void 0:s.orderDialogCustomFields;return void 0===r?[]:[...st(r.comboBox),...et(r.checkbox)]}_makeOrderDialogCustomFields(t){const e=this._makeInstrumentOrderDialogCustomFieldsMemoized(t),s=this._makeAccountOrderDialogCustomFieldsMemoized(this._account.value()),i=[...e.length>0?e:s];return this._ensuredConfigFlags().supportDigitalSignature&&i.push(this._makeDigitalSignatureCustomField()),i}_makeLeverageRequest(t,e,s){return this._restFetch({requestMetainfo:s,accessToken:this._getAccessToken(),method:e,body:this._leverageParamsFromTV(t),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}_updateParentBrackets(t,e){const s=rt(e);if(!s){if(void 0!==this._tvOrders.find((s=>s.parentId===t.id&&s.id!==e.id&&s.type===e.type&&rt(s))))return}const i=s?e.limitPrice:void 0,r=s?e.trailingStopPips:void 0,o=s?e.stopPrice:void 0;3===e.type&&(e.stopType===a.StopType.TrailingStop?(delete t.stopLoss,t.trailingStopPips=r,t.trailingStopPrice=o):(delete t.trailingStopPips,delete t.trailingStopPrice,t.stopLoss=o)),1===e.type&&(t.takeProfit=i)}}},52346:(t,e,s)=>{function i(t){return t instanceof r}s.d(e,{isUserFriendlyError:()=>i,UserFriendlyError:()=>r});class r extends Error{constructor({detailedErrorMessage:t,userFriendlyMessage:e,cause:s}){super(e),this.name="UserFriendlyError",this.detailedErrorMessage=t,this.cause=s}}},696546:(t,e,s)=>{s.d(e,{orderStatusToText:()=>b,sideToText:()=>P,orderTypeToText:()=>k,findArraysDifferences:()=>F,formatNumber:()=>S,isOrderOrPositionMessageType:()=>C,roundToStepByPriceTypeAndSide:()=>w,TasksWithTermination:()=>M,roundDownToPowerOf10:()=>E,isFinalOrderStatus:()=>O,positionSideToText:()=>x,makeNonTradableSymbolText:()=>I,getErrorMessage:()=>D,getLoggerMessage:()=>R,getErrorCauses:()=>B});var i=s(509806),r=s(960521),o=s(122621),n=s(971204),a=s(604406),u=s(486028),l=s(817808),c=s(652945),d=s(52346),h=s(257596);const p={2:{},1:{}},_={2:{},1:{}},m={},g={},f={};let y=!1;const v=(0,l.getLogger)("Trading.Utils");function b(t){return T(),f[t]}function T(){y||(y=!0,p[2][2]=i.t(null,{context:"Market order"},s(610952)),p[2][1]=i.t(null,{context:"Limit order"},s(382377)),p[2][3]=i.t(null,{context:"order"},s(608921)),p[2][4]=i.t(null,{context:"Stop limit order"},s(779062)),p[1][2]=i.t(null,void 0,s(359758)),p[1][1]=i.t(null,void 0,s(398157)),p[1][3]=i.t(null,{context:"order"},s(7122)),p[1][4]=i.t(null,void 0,s(900853)),_[2][o.BracketType.TakeProfit]=i.t(null,{context:"Take profit order"},s(347947)),_[2][o.BracketType.StopLoss]=i.t(null,{context:"Stop loss order"},s(15307)),_[2][o.BracketType.TrailingStop]=i.t(null,{context:"Trailing stop order"},s(154462)),_[1][o.BracketType.TakeProfit]=i.t(null,void 0,s(129266)),_[1][o.BracketType.StopLoss]=i.t(null,void 0,s(241648)),_[1][o.BracketType.TrailingStop]=i.t(null,void 0,s(86430)),m[1]=i.t(null,{
context:"trading"},s(63470)),m[-1]=i.t(null,{context:"trading"},s(742259)),g[1]=i.t(null,{context:"trading"},s(274771)),g[-1]=i.t(null,{context:"trading"},s(951219)),f[2]=i.t(null,void 0,s(885323)),f[1]=i.t(null,void 0,s(767207)),f[6]=i.t(null,void 0,s(328231)),f[3]=i.t(null,void 0,s(614841)),f[4]=i.t(null,void 0,s(373425)),f[5]=i.t(null,void 0,s(442060)))}function P(t,e){T();const s=m[t];return e?s.toUpperCase():s}function k(t){const{orderType:e,uppercase:s,shorten:i,parentId:r,stopType:a}=t;T();const u=i?2:1;let l=p,c=e;return void 0!==r&&(l=_,3===e&&(c=a===n.StopType.TrailingStop?o.BracketType.TrailingStop:o.BracketType.StopLoss),1===e&&(c=o.BracketType.TakeProfit)),s?l[u][c].toUpperCase():l[u][c]}function F(t,e,s,i,r){const o={added:[],modified:[],removed:[]},n=t.slice(0);return e.forEach((e=>{const a=t.findIndex((t=>t[s]===e[s]));if(-1===a)return void o.added.push(e);n[a]=null;const l=t[a];for(const t of i){let s=!0;if(null===l[t]||"object"!=typeof l[t]?s=l[t]===e[t]:r&&(s=(0,u.deepEquals)(l[t],e[t])[0]),!s)return void o.modified.push(e)}})),n.forEach((t=>{t&&o.removed.push(t)})),o}function S(t){return Math.abs(t||0)<.001?"0.00":(0,a.splitThousands)((t||0).toFixed(2))}function C(t){return-1!==Object.keys(o.OrderOrPositionMessageType).map((t=>o.OrderOrPositionMessageType[t])).indexOf(t)}function w(t,e,s,i){const o=(0,r.Big)(t).div(e);return 1===s&&1===i||2===s&&-1===i?o.round(0,0).mul(e).toNumber():1===s&&-1===i||2===s&&1===i?o.round(0,3).mul(e).toNumber():0}const q=i.t(null,void 0,s(609372));class M{constructor(t){this._isFinished=!1,this._isTerminated=!1,this._tasks=t}execute(){return this._isTerminated=!1,this._isExecuted()&&!this._isFinished?this.terminate().then((()=>this._execution=this._execute())):this._execution=this._execute()}async terminate(){if(this._isExecuted()&&!this._isFinished){this._isTerminated=!0;try{await this._execution}catch(t){return void v.logWarn(t)}}}_isExecuted(){return!!this._execution}async _execute(){for(const t of this._tasks){if(this._isTerminated)throw new Error("Login tasks are terminated");try{await t()}catch(t){this._isFinished=!0;const e={detailedErrorMessage:`${q}${A(R(t))}`,userFriendlyMessage:`${q}${A(D(t))}`};throw t instanceof h.DisconnectError?new h.DisconnectError({...e,disconnectInfo:t.disconnectInfo}):new d.UserFriendlyError(e)}}this._isFinished=!0}}function A(t){return void 0===t||""===t?"":`: ${t}`}function E(t){return(0,r.Big)(10).pow(Math.floor(Math.log10(t))).toNumber()}function O(t){return-1!==[2,1,5].indexOf(t)}function x(t){return T(),g[t]}function I(t,e){return i.t(null,void 0,s(221456)).replace("{symbol}",t).replace("{broker}",e)}function D(t){if(void 0===t)return i.t(null,void 0,s(328523));let e;return e=t instanceof Error?t.message:"object"==typeof t?JSON.stringify(t):t.toString(),(0,c.removeTags)(e)}function R(t){return t instanceof d.UserFriendlyError?(0,c.removeTags)(t.detailedErrorMessage):D(t)}o.BracketType.StopLoss,i.t(null,void 0,s(241648)),o.BracketType.TakeProfit,i.t(null,void 0,s(129266)),o.BracketType.TrailingStop,i.t(null,void 0,s(86430)),
o.BracketType.StopLoss,o.BracketType.TakeProfit,o.BracketType.TrailingStop;new Set(["date","dateOrDateTime","default","fixed","variablePrecision","formatQuantity","formatPrice","formatPriceForexSup","integerSeparated","localDate","localDateOrDateTime","percentage","pips","profit","profitInInstrumentCurrency","side","positionSide","status","symbol","text","type","marginPercent","empty"]);function B(t){return(0,d.isUserFriendlyError)(t)&&void 0!==t.cause?[...B(t.cause),t.cause]:[t]}},458283:(t,e,s)=>{s.r(e),s.d(e,{defaultConfigFlags:()=>i,applyDefaultsToConfigFlags:()=>r});const i={isSuspended:!1,supportDemoLiveSwitcher:!0,supportModifyOrderPrice:!0,supportEditAmount:!0,supportModifyBrackets:!0,supportMarketBrackets:!0,supportMarketOrders:!0,supportStopOrders:!0,supportLimitOrders:!0,supportLeverageButton:!0,supportStopLimitOrders:!1,supportPositions:!0,supportDOM:!0,supportModifyTrailingStop:!0,supportAddBracketsToExistingOrder:!0,supportVerifyLiveAccount:!0,supportReversePosition:!0,showNotificationsLog:!0,supportPLUpdate:!0,supportTwoFactorAuthorization:!1,supportDisplayBrokerNameInSymbolSearch:!0,supportCurrencyInOrderPreview:!0,supportRiskControls:!0};function r(t){return Object.assign({},i,t)}}}]);