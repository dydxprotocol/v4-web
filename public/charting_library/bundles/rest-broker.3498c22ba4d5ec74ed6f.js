"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[3541],{83844:(t,e,s)=>{s.r(e),s.d(e,{Broker:()=>ot});var i=s(74245),r=s(16282),o=s(93302),n=s.n(o);function a(t){const e=new URLSearchParams;for(const[s,i]of Object.entries(t))void 0!==i&&e.set(s,String(i));return e.toString()}var u,c=s(33375),l=s(37560);!function(t){t.GetLeverage="getLeverage",t.SetLeverage="setLeverage",t.PreviewLeverage="previewLeverage"}(u||(u={}));const h=[{label:(0,i.t)("Symbol"),formatter:"symbol",showLabelOnMobile:!1,property:"brokerSymbol",notHideable:!0},{label:(0,i.t)("Side"),property:"side",formatter:"side"},{label:(0,i.t)("Type"),property:"type",formatter:"type"},{label:(0,i.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:(0,i.t)("Size in lots")},{label:(0,i.t)("Filled Qty"),alignment:"right",property:"filledQty",formatter:"formatQuantity",help:(0,i.t)("Filled Size in lots")},{label:(0,i.t)("Limit Price"),alignment:"right",property:"limitPrice",formatter:"formatPrice"},{label:(0,i.t)("Stop Price"),alignment:"right",property:"stopPrice",formatter:"formatPrice"},{label:(0,i.t)("Take Profit"),alignment:"right",property:"takeProfit",formatter:"formatPrice"},{label:(0,i.t)("Stop Loss"),alignment:"right",property:"stopLoss",formatter:"formatPrice"},{label:(0,i.t)("Trailing Stop"),alignment:"right",property:"trailingStopPrice",formatter:"formatPrice"},{label:(0,i.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"formatPrice",supportedStatusFilters:[0,6,2]},{label:(0,i.t)("Status"),property:"status",formatter:"status",supportedStatusFilters:[0]},{label:(0,i.t)("Update Time"),property:"updateTime",formatter:"localDate"},{label:(0,i.t)("Order id"),property:"id"},{label:(0,i.t)("Expiry"),property:"expiry"},{label:(0,i.t)("Expiry Time"),alignment:"right",property:"expiryTime",formatter:"localDateOrDateTime"}],d=[{label:(0,i.t)("Symbol"),formatter:"symbol",showLabelOnMobile:!1,property:"brokerSymbol",notHideable:!0},{label:(0,i.t)("Side"),property:"side",formatter:"side"},{label:(0,i.t)("Type"),property:"type",formatter:"type"},{label:(0,i.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:(0,i.t)("Size in lots")},{label:(0,i.t)("Filled Qty"),alignment:"right",property:"filledQty",formatter:"formatQuantity",help:(0,i.t)("Filled Size in lots")},{label:(0,i.t)("Limit Price"),alignment:"right",property:"limitPrice",formatter:"formatPrice"},{label:(0,i.t)("Stop Price"),alignment:"right",property:"stopPrice",formatter:"formatPrice"},{label:(0,i.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"formatPrice"},{label:(0,i.t)("Status"),property:"status",formatter:"status"},{label:(0,i.t)("Update Time"),property:"updateTime",formatter:"localDate"},{label:(0,i.t)("Order id"),property:"id"}],p=((0,i.t)("Balance"),(0,i.t)("Equity",{context:"trading"}),(0,i.t)("Total Profit"),[{label:(0,i.t)("Symbol"),formatter:"symbol",showLabelOnMobile:!1,property:"brokerSymbol",notHideable:!0},{label:(0,i.t)("Side"),property:"side",formatter:"positionSide"
},{label:(0,i.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:(0,i.t)("Size in lots")},{label:(0,i.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"avgPriceFormatter"},{label:(0,i.t)("Take Profit"),alignment:"right",property:"takeProfit",formatter:"formatPriceForexSup"},{label:(0,i.t)("Stop Loss"),alignment:"right",property:"stopLoss",formatter:"formatPriceForexSup"},{label:(0,i.t)("Trailing Stop"),alignment:"right",property:"trailingStopPrice",formatter:"formatPriceForexSup"},{label:(0,i.t)("Profit"),alignment:"right",property:"unrealizedPl",formatter:"profitInInstrumentCurrency",isCapitalize:!1},{label:(0,i.t)("Position id"),property:"id"}]),_=[{label:(0,i.t)("Symbol"),property:"symbol"},{label:(0,i.t)("Currency name"),property:"longName",notSortable:!0},{label:(0,i.t)("Total"),alignment:"right",property:"total",formatter:"variablePrecision"},{label:(0,i.t)("Available"),alignment:"right",property:"available",formatter:"variablePrecision"},{label:(0,i.t)("Reserved"),alignment:"right",property:"reserved",formatter:"variablePrecision"},{label:(0,i.t)("BTC value"),alignment:"right",property:"btcValue",formatter:"variablePrecision"},{label:(0,i.t)("Value"),property:"value",alignment:"right",formatter:"cryptoValueInCurrencyFormatter"}];var g=s(40160),m=s(18898);const y=(0,i.t)("Failed to fetch");var f;function b(t){const e={Accept:"application/json","Content-Type":"application/x-www-form-urlencoded",Referer:"https://www.tradingview.com/chart/OlHDdzUm/"};return t&&(e.Authorization="Bearer "+t),e}async function P(t,e,s=f.Get,i,r){const o=i?function(t){const e=[];for(const s in t)t.hasOwnProperty(s)&&null!=t[s]&&e.push({key:s,pair:encodeURIComponent(s)+"="+encodeURIComponent(t[s])});return e.sort((t,e)=>t.key>e.key?1:t.key<e.key?-1:0).map(t=>t.pair).join("&")}(i):i,n={method:f[s],headers:b(e)};o&&s!==f.Get&&(n.body=o);try{const e=await fetch(t,n);if(!e.ok)throw new Error(e.statusText);return e}catch(t){throw t.message=(0,g.getErrorMessage)(t),r&&r.logError(t.message),t}}async function v(t,e,s=f.Get,i,r){const o=await async function(t,e,s=f.Get,i,r){const o=await P(t,e,s,i,r),n=await o.json();if(!function(t){return!(!t||t.hasOwnProperty("s")&&"error"===t.s)}(n)){const t=n.errmsg?n.errmsg:y;throw r&&r.logError(t),new Error(t)}return n}(t,e,s,i,r);return"d"in o?o.d:o}function S(t,e){return{login:t,password:e,locale:window.locale}}function T(t){return{valid:!0,data:t}}async function k(t,e,s,i,r=T,o){const n={method:f[e],headers:s};try{null!==i&&(n.body=JSON.stringify(i));const e=await fetch(t,n);if(!e.ok){if(void 0!==o){const{logMessage:t,userFriendlyMessage:s}=await o(e);throw new m.UserFriendlyError({detailedErrorMessage:t,userFriendlyMessage:s})}throw new Error(e.statusText)}const s=r(await e.json());if(!1===s.valid)throw new Error(s.errormsg);return s.data}catch(t){throw new m.UserFriendlyError({detailedErrorMessage:t.message,userFriendlyMessage:t.userFriendlyMessage})}}!function(t){t[t.Get=1]="Get",t[t.Post=2]="Post",t[t.Put=3]="Put",t[t.Delete=4]="Delete"}(f||(f={}))
;var w=s(80068),F=s(14071),C=s(21526),A=s.n(C);const O=(0,F.getLogger)("Trading.Requester");class D{constructor(t,e,s,i,r,o,n){this._currentPulseIndex=0,this._requestInterval=null,this._requestTimeOut=null,this._errorsCount=0,this._status=0,this._snapshot=!0,this._url=t,this._headers=s,this._method=e,this._body=i,this._requestInterval=r,this.update=new(A()),this.statusChanged=new(A()),this._extractResponseData=o,this._extractErrorMessage=n}start(){return this._status=1,this._errorsCount=0,this._currentPulseIndex++,this._request()}stop(){this._status=0,this._clearResetRequestTimeout()}pause(){this.stop()}unpause(){this.start()}status(){return this._status}changeUrl(t){(0,r.assert)(1!==this._status,"Cannot change URL: requester is running"),this._url=t}changeHeaders(t){(0,r.assert)(1!==this._status,"Cannot change headers: requester is running"),this._headers=t}async _request(){const t=this._currentPulseIndex;(0,r.assert)(1===this._status,"Unable to request: requester is inactive");try{const e=this._url,s=await k(this._url,this._method,this._headers,this._body,this._extractResponseData,this._extractErrorMessage);this._errorsCount=0,e===this._url&&1===this._status&&t===this._currentPulseIndex&&(this.update.fire(s,this._snapshot),this._snapshot=!1)}catch(e){O.logError(`${(0,g.getLoggerMessage)(e)}: ${this._url}`),this._errorsCount++,t===this._currentPulseIndex&&this._failOnErrorsCount((0,g.getErrorMessage)(e))}finally{null!==this._requestInterval&&1===this._status&&t===this._currentPulseIndex&&await this._makeNextRequest()}}_clearResetRequestTimeout(){null!==this._requestTimeOut&&(clearTimeout(this._requestTimeOut),this._requestTimeOut=null)}_failOnErrorsCount(t){this._errorsCount>20&&(this._clearResetRequestTimeout(),this._status=2,this.statusChanged.fire({requesterStatus:this._status,errorMessage:t}))}async _makeNextRequest(){const t=this._currentPulseIndex;this._requestTimeOut=null,this._requestTimeOut=setTimeout(async()=>{t===this._currentPulseIndex&&await this._request()},this._requestInterval)}}class q{constructor(t,e,s,i,r,o,n,a,u,c){this.update=new(A()),this.statusChanged=new(A()),this._data=[],this._status=0,this._requester=new D(t,e,s,i,r,a,u),this._idField=o,this._keys=n,this._useDeepEquals=c}start(){return this._status=1,this._requester.update.subscribe(this,this._onNewData),this._requester.statusChanged.subscribe(this,this._onStatusChanged),this._requester.start()}stop(){this._status=0,this._requester.update.unsubscribe(this,this._onNewData),this._requester.statusChanged.unsubscribe(this,this._onStatusChanged),this._requester.stop(),delete this._requester}pause(){this._status=0,this._requester.stop()}unpause(){this._status=1,this._requester.start()}changeHeaders(t){this._requester.changeHeaders(t)}_onNewData(t,e){if(1!==this._status)return;const s=(0,g.findArraysDifferences)(this._data,t,this._idField,this._keys,this._useDeepEquals);(s.added.length>0||s.modified.length>0||s.removed.length>0)&&(this._data=t,this.update.fire(s,e))}_onStatusChanged(t){this._status=t.requesterStatus,this.statusChanged.fire({
requesterStatus:t.requesterStatus,errorMessage:t.errorMessage})}}var B=s(56178),I=s(35838);const R={limit:1,market:2,stop:3,stoplimit:4},E={1:"limit",2:"market",3:"stop",4:"stoplimit"},U={placing:4,inactive:3,working:6,rejected:5,filled:2,cancelled:1},x=["qty","status","filledQty","avgPrice","limitPrice","stopPrice","parentId","duration","customFields","message"],M=["instrument","qty","side","avgPrice","unrealizedPl","realizedPl","stopLoss","trailingStopPips","takeProfit","message"],L=["available","total","btcValue"],V={checked:!1,text:""},z={positions:1e3,quotes:500,orders:500,accountManager:500,balances:1e3},$={locale:window.locale},Q=(0,i.t)("This market is not tradable with this brokerage account. Switch to another account and try again"),H=(0,i.t)("You can't trade this market with this brokerage account. Please switch over to a different market and have another try.");function G(t){return t.s&&"ok"!==t.s?{valid:!1,errormsg:t.errmsg}:{valid:!0,data:t.d}}function j(t){return R[t=t||"market"]}function N(t){return E[t=t||2]}function W(t){return"sell"===t?-1:1}function K(t){return-1===t?"sell":"buy"}function J(t){return void 0!==t.accountManager&&Array.isArray(t.accountManager)&&t.accountManager.length>0}function Y(t){return t.amData&&Array.isArray(t.amData)&&t.amData.length>0?t.amData:function(t){const e=(0,g.formatNumber)(t.balance),s=(0,g.formatNumber)(t.unrealizedPl);return[[[e,void 0!==t.equity?(0,g.formatNumber)(t.equity):(0,g.formatNumber)(t.balance+t.unrealizedPl),s]]]}(t)}function X(t){return t.map(t=>({price:t[0],volume:t[1]}))}function Z(t){return Object.assign({id:t.symbol},t)}function tt(t){return t.map(t=>{const e=!t.mutable;return delete t.mutable,{...t,inputType:"ComboBox",preventModify:e}})}function et(t,e){return e.filter(e=>!(e in t))}function st(t){return![2,1].includes(t.status)}const it=(0,i.t)("Accounts configuration is invalid"),rt=(0,i.t)("Broker configuration is invalid");class ot{constructor(t,e,s,i=null,o){var n,a;if(this._accounts=[],this._accountManagerTablesData=[],this._accountManagerTablesDelegates=[],this._fetchedBrokerSymbols=new Set,this._cryptoBalances=[],this._oAuthAuthorizationProvider=null,this._requesters={},this._depthSubscriptions={},this._customFormatters=[],this._permittedSymbolSearchGroups=[],this._accessTokenExpirationTimeout=null,this._loginTasks=null,this._orderColumns=h,this._orderHistoryColumns=d,this._positionColumns=p,this._makeInstrumentOrderDialogCustomFieldsMemoized=(0,B.memoize)(this._makeInstrumentOrderDialogCustomFields,t=>t.concat(this.currentAccount())),this._makeAccountOrderDialogCustomFieldsMemoized=(0,B.memoize)(this._makeAccountOrderDialogCustomFields,()=>this.currentAccount()),this._profitlossEmitters=new Map,this._reconnectOnFailCount=1,this._host=t,this._fastRenewOauthToken=o,this._restUrl=a="/"===(a=e)[a.length-1]?a:a+"/",this._metainfo=s,this._realtimeSubscriptions=new Set,this._pipValueSubscriptions=new Set,this._quotesSubscriptions=new Map,this._currentQuotes=new Map,this._priceFormatterCache=new Map,this._instruments=new Map,this._initData(),
this._tokenStorageKey=String("rest-token"),this._permittedSymbolSearchGroups=[(0,r.ensureDefined)(s.id)],this._lastAccountIdKey=String("rest-last-account-id-"+s.id),this._logger=t.getLogger(),this._status=this._host.factory.createWatchedValue(3),this._account=t.factory.createWatchedValue({id:"",name:"",currencySign:"",config:{},instruments:[],type:l.AccountType.Demo}),(null===(n=this._metainfo.configFlags)||void 0===n?void 0:n.supportUnhideSymbolSearchGroups)||this._createMapper(),i){const t=Date.now()+432e6;this._saveAccessToken({access_token:i,expiration:t}).then(()=>this._setAccessTokenExpirationTimeout(t))}this._setAccountBinded=this._setAccount.bind(this),this._createButtonDropdownOptions(),this._customFormatters.push({name:"avgPriceFormatter",format:t=>{const e=this._priceFormatterCache.get(t.row.symbol);return e?e.format(t.value):String(t.value)}},{name:"cryptoValueInCurrencyFormatter",format:t=>`${t.row.value} ${t.row.valueCurrency}`}),this._cryptoBalanceTableChangeDelegate=this._host.factory.createDelegate()}tryRestoreSession(){this._tryRestorePreviousSession()}chartContextMenuActions(t,e){return this._host.defaultContextMenuActions(t,e)}async accountsMetainfo(){return this._accounts}setCurrentAccount(t){const e=this._accounts.find(e=>e.id===t);void 0!==e&&this._account.setValue(e)}accountManagerInfo(){const t=this._accountSummaryRowData.titles.map((t,e)=>({text:t,wValue:this._accountSummaryRowData.values[e].readonly(),formatter:this._accountSummaryRowData.formatters[e]})),e=[],s=this._ensuredConfigFlags().supportOrderBrackets||this._ensuredConfigFlags().supportPositionBrackets,o=this._ensuredConfigFlags().supportBalances;if(J(this._brokerConfig))if(o){const t=0!==this._cryptoBalances.length?Object.keys(this._cryptoBalances[0]):_.map(t=>t.property),s=_.filter(e=>t.includes(e.property)),i=Object.assign({},{id:"cryptoBalances",name:"Balances",getData:()=>Promise.resolve(this._cryptoBalances.map(t=>Z(t))),changeDelegate:this._cryptoBalanceTableChangeDelegate,columns:s});e.push(i)}else{const t=(0,r.ensure)(this._brokerConfig.accountManager,"Account manager info: Account manager").map((t,e)=>({id:t.id,title:void 0!==t.title&&t.title.length>0?t.title:(0,i.t)("Account Info"),getData:()=>Promise.resolve(this._accountManagerTablesData[e]),changeDelegate:this._accountManagerTablesDelegates[e],columns:t.columns.map(t=>({label:t.title,help:t.tooltip,property:t.id,formatter:t.formatter,notSortable:!t.sortable,tooltip:t.tooltip,isCapitalize:t.isCapitalize}))}));e.push(...t)}const n=(0,r.ensureDefined)(this._metainfo),a=this._brokerConfig.durations&&this._brokerConfig.durations.some(t=>Boolean(t.hasDatePicker||t.hasTimePicker)),u=t=>s||"stopLoss"!==t.property&&"takeProfit"!==t.property,c=t=>this._ensuredConfigFlags().supportTrailingStop||"trailingStopPrice"!==t.property,l=void 0!==n.customPositionColumnTitles&&n.customPositionColumnTitles.length>0?this._positionColumns.map(t=>{const e=(0,
r.ensureDefined)(n.customPositionColumnTitles,"Account manager info: Custom position column titles").find(e=>e.hasOwnProperty(t.property));return t.label=void 0!==e?e[(0,r.ensureDefined)(t.property,"Account manager info: Custom position column title property")]:t.label,t}):this._positionColumns,h={accountTitle:(0,r.ensure)(this._metainfo.title),orderColumns:this._orderColumns.filter(u).filter(t=>this._brokerConfig.durations||"expiry"!==t.property).filter(t=>a||"expiryTime"!==t.property).filter(t=>this._ensuredConfigFlags().supportPartialOrderExecution||"filledQty"!==t.property).filter(c),pages:[{id:"summary",title:(0,i.t)("Account Summary"),tables:e}],positionColumns:l.filter(u).filter(t=>this._ensuredConfigFlags().supportMultiposition||"id"!==t.property).filter(c),summary:t,customFormatters:this._customFormatters};return this._ensuredConfigFlags().supportOrdersHistory&&(h.historyColumns=this._orderHistoryColumns.filter(u)),h}currentAccount(){return this._account.value().id}currentAccountType(){return 0!==this._accounts.length?this._accounts.some(t=>t.type===l.AccountType.Live)?l.AccountType.Live:l.AccountType.Demo:void 0}async executions(t){const e=this._mapFromTV(t);return null!==e&&!1===this._fetchedBrokerSymbols.has(e)&&await this._requestExecutions(e),this._tvExecutions.filter(e=>e.symbol===t)}orders(){return Promise.resolve(this._tvOrders)}async ordersHistory(){const t=await this._getOrdersHistoryByAccountId(this._account.value().id);return this._createTvOrders(t)}positions(){return Promise.resolve(this._tvPositions)}async cancelOrder(t){return v(this._getOrderIdRestUrl(t),this._getAccessToken(),f.Delete)}async modifyOrder(t,e){if(2===t.parentType)return this._modifyPositionBracketsByOrder(t);if(1===t.parentType){const s=this._tvOrderById((0,r.ensure)(t.parentId,"Modify order: Parent id"));return this._updateParentBrackets(s,t),2!==s.status?this.modifyOrder(s,e):this._modifySingleOrder(t,e)}return this._modifySingleOrder(t,e)}async placeOrder(t,e){var s;const i=this._ensuredConfigFlags().supportDigitalSignature;let r=null;if(t.customFields){if(i){r=((null===(s=t.customFields)||void 0===s?void 0:s.digitalSignature)||this._getDigitalSignatureState()).text,await this._setDigitalSignatureState(t.customFields.digitalSignature)}}else{const e=this._makeOrderDialogCustomFields(t.symbol).find(t=>"forceUserEnterInitialValue"in t&&t.forceUserEnterInitialValue);if(void 0!==e)throw new Error("To place order you need to select a {fieldTitle} in the order ticket.".replace("{fieldTitle}",e.title))}const o=Object.assign({},t.customFields);return delete o.digitalSignature,this._placeOrder(t,r,o,e)}async cancelOrders(t,e,s){return(()=>Promise.all(s.map(t=>this.cancelOrder(t))).then(()=>{}))()}editPositionBrackets(t,e){return v(this._getPositionIdRestUrl(t),this._getAccessToken(),f.Put,e)}reversePosition(t,e){const s=this._getPositionIdRestUrl(t),i=this._tvPositionById(t);if(void 0===i)throw new Error(`Failed to reverse position: Position ${t} not found`);const r=1===i.side?"sell":"buy",o=Object.assign({side:r},e)
;return v(s,this._getAccessToken(),f.Put,o)}closePosition(t,e){return v(this._getPositionIdRestUrl(t),this._getAccessToken(),f.Delete,{amount:e})}async isTradable(t){var e;const s=this._mapFromTV(t);if(null!==s){const t=this._instruments.has(s),e={tradable:t};if(!t){const t=this._getAccountWithTradableSymbol(s);null!==t&&(e.solutions={changeAccount:t.id},e.shortReason=Q,e.reason=Q)}return e}if(void 0!==this._metainfo.symbolPrefix){const s=t.split(":")[1],i=`${null!==(e=this._account.value().prefix)&&void 0!==e?e:this._metainfo.symbolPrefix}:${s}`,r=this._mapFromTV(i);if(null!==r){if(void 0!==this._instruments.get(r))return{tradable:!1,reason:H,shortReason:H,solutions:{changeSymbol:i}}}}return{tradable:!1}}subscribeRealtime(t){const e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.add(e),this._subscribeQuotes(e)):this._logger.logError("Symbol not found")}unsubscribeRealtime(t){const e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.delete(e),this._unsubscribeQuotes(e)):this._logger.logError("Symbol not found")}subscribePipValue(t){const e=this._mapFromTV(t);if(null!==e){if(!this._instrumentInfo(e).hasQuotes)return;this._pipValueSubscriptions.add(e),this._subscribeQuotes(e)}else this._logger.logError("Symbol not found")}unsubscribePipValue(t){const e=this._mapFromTV(t);null!==e?this._pipValueSubscriptions.has(e)&&(this._pipValueSubscriptions.delete(e),this._unsubscribeQuotes(e)):this._logger.logError("Symbol not found")}subscribeDOME(t){const e=this._mapFromTV(t);if(null!==e){const s=this._getDepthUrl(e),i=new D(s,f.Get,this._getHeaders(),null,this._getPullingInterval("quotes"),G),r=this._onDepthUpdate.bind(this,t);i.update.subscribe(this,r),i.start(),this._depthSubscriptions[t]={callback:r,requester:i}}else this._logger.logError("Symbol not found")}unsubscribeDOME(t){try{this._depthSubscriptions[t].requester.update.unsubscribe(this,this._depthSubscriptions[t].callback),this._depthSubscriptions[t].requester.stop(),delete this._depthSubscriptions[t]}catch(t){this._logger.logError((0,g.getLoggerMessage)(t))}}async signIn(t,e,s,o){this._setStatus(2),await this._host.credentialsStorage.clear(this._tokenStorageKey);try{let s;if(this._isSimplePasswordAuthorizationType()&&(s=async()=>{const s=await this._authorize(t,e);await this._saveAccessToken(s),await this._setAccessTokenExpirationTimeout(s.expiration)}),this._isTwoFactorAuthorizationType()){if(void 0===(null==o?void 0:o.verificationCode)){const s=await this._authorizeRequestTwoFactorCode(t,e);if(!("twoFactorMessage"in s))throw new Error((0,i.t)("Two Factor Authorization is not configured properly"));return void this._setStatus(4,{message:s.twoFactorMessage,disconnectType:l.DisconnectType.TwoFactorRequired})}s=async()=>{const s=await this._authorizeWithTwoFactorCode(t,e,(0,r.ensureDefined)(o.verificationCode,"Signin: Verification code"));await this._saveAccessToken(s),await this._setAccessTokenExpirationTimeout(s.expiration)}}await this._setAndStartLoginTasks(s),this._createButtonDropdownOptions(),this._reconnectOnFailCount=1,this._setStatus(1),
this._updatePLEmitters()}catch(t){this._logger.logError("Failed to connect to broker: "+(0,g.getLoggerMessage)(t));const{disconnectionInfo:e,connectionStatus:s}=(0,I.extractDisconnectionInfoAndConnectionStatus)(t);this._setStatus(s,e),await this._disconnect()}}async symbolInfo(t){const e=this._mapFromTV(t);if(null!==e)return this._instrumentInfo(e);throw new Error("Symbol not found")}connectionStatus(){return this._status.value()}async disconnect(t=!1){await this._disconnect(t),null!==this._loginTasks&&await this._loginTasks.terminate(),this._setStatus(3,{message:void 0,disconnectType:l.DisconnectType.LogOut})}supportFloatingPanel(){return!0}getRealtimeDataCheckParams(){return{token:this._getAccessToken()}}getVerifyLiveAccountParams(){return{token:this._getAccessToken()}}unhideSymbolSearchGroups(){return this._permittedSymbolSearchGroups}async formatter(t){return this._getPriceFormatterForSymbol(t)}async spreadFormatter(t){const e=this._mapFromTV(t);if(null!==e){const s=this._instruments.get(e);return void 0===s||"forex"!==s.type&&"cfd"!==s.type?this._host.defaultFormatter(t,!1):this._host.numericFormatter(1)}throw new Error("Symbol not found")}quantityFormatter(t){const e=this._mapFromTV(t);if(null!==e){const t=this._instruments.get(e);if(void 0!==t&&"crypto"===t.type)return this._host.quantityFormatter()}return this._host.quantityFormatter()}async previewOrder(t){const e=this._orderFromTV(t);(function(t){return"id"in t})(t)&&(e.id=t.id);const s=this._getOrderPreviewRestUrl();return void 0!==t.customFields&&Object.assign(e,t.customFields),v(s,this._getAccessToken(),f.Post,e)}async getOrderDialogOptions(t){return{customFields:this._makeOrderDialogCustomFields(t)}}getValidationRules(t){var e,s,i;const r=this._mapFromTV(t);if(null!==r)return null===(i=null===(s=null===(e=this._instruments.get(r))||void 0===e?void 0:e.ui)||void 0===s?void 0:s.validationRules)||void 0===i?void 0:i.map(t=>({...t,severity:"error"}))}async leverageInfo(t){const e=this._getLeverageUrl(u.GetLeverage);return this._makeLeverageRequest(t,f.Post,e)}async setLeverage(t){const e=this._getLeverageUrl(u.SetLeverage);return this._makeLeverageRequest(t,f.Post,e)}async previewLeverage(t){const e=this._leverageParamsFromTV(t);return v(this._getLeverageUrl(u.PreviewLeverage),this._getAccessToken(),f.Post,e)}async _updateMapper(t,e){return this._mapper=this._host.createMapperSync(t,e),this._mapper.ready()}async _updateAccount(t){void 0!==t.prefix&&t.prefix!==this._currentAccountPrefix&&(this._currentAccountPrefix=t.prefix,await this._updateMapper(this._metainfo.id,this._makeSymbolMapperOptions(t.prefix))),this._saveAccountId(t),this._account.setValue(t);const e=t.durations?t.durations:this._originalBrokerConfig.durations;this._brokerConfig=Object.assign({},this._originalBrokerConfig,t.ui,{durations:e}),this._metainfo.configFlags=Object.assign(this._metainfo.configFlags,t.config),this._ensuredConfigFlags().supportStopOrdersInBothDirections&&(this._ensuredConfigFlags().supportStopOrdersInBothDirectionsInUI=!0),
this._host.patchConfig(this._ensuredConfigFlags()),this._makeAccountSummaryRowData(),this._setCustomFields(t);for(const e of t.instruments)"forex"!==e.type&&"cfd"!==e.type||void 0===e.pipSize||(e.minPriceStep=n()(10).pow(-(0,g.numOfDecimalPlaces)(e.pipSize)).toNumber()),this._instruments.set(e.name,e);await this._initRequesters();const s=await this._getAccountState();for(let t=0;t<(0,r.ensure)(this._brokerConfig.accountManager,"Update account: Account manager").length;t++){const t=this._host.factory.createDelegate();this._accountManagerTablesDelegates.push(t),this._accountManagerTablesData.push([{}])}this._setAccountManagerTableData(Y(s)),this._setAccountSummaryRowData(s),this._brokerConfig.durations&&this._host.setDurations(function(t){const e=[];for(const s of t){const t={name:s.title,value:s.id,hasDatePicker:s.hasDatePicker,hasTimePicker:s.hasTimePicker};void 0!==s.supportedOrderTypes&&(t.supportedOrderTypes=s.supportedOrderTypes.map(t=>j(t))),"default"in s&&(t.default=s.default),e.push(t)}return e}(this._brokerConfig.durations)),this._changeQuotesRequesterUrl()}async _getAccounts(){const t=await v(this._getAccountsUrl(),this._getAccessToken()),e=this._metainfo.defaultAccountType||l.AccountType.Demo;if(!Array.isArray(t))throw new m.UserFriendlyError({detailedErrorMessage:it+": Response is not an array",userFriendlyMessage:it});if(0===t.length)throw new m.UserFriendlyError({detailedErrorMessage:it+": Response is empty",userFriendlyMessage:it});for(const s of t){const t=et(s,["id","name","type","config"]);if(0!==t.length)throw new m.UserFriendlyError({detailedErrorMessage:it+": Required fields are missing: "+t.join(", "),userFriendlyMessage:it});s.currency=s.currency||"",s.currencySign=s.currencySign||"",s.type=s.type||e}return t}async _setAccount(t){const e=1===this.connectionStatus();this._cleanup(),e&&this._setStatus(2),await this._updateAccount(t),e&&(this._setStatus(1),this._updatePLEmitters())}_updatePLEmitters(){var t;(null===(t=this._metainfo.configFlags)||void 0===t?void 0:t.supportPLUpdate)?this._stopPLEmitters():this._startPLEmitters()}_setAndStartLoginTasks(t){const e=[];return void 0!==t&&e.push(t),e.push(()=>this._getBrokerConfig().then(t=>{this._originalBrokerConfig=t}),...this._initializeAccountTasks()),this._loginTasks=new g.TasksWithTermination(e),this._loginTasks.execute()}_startPLEmitters(){this._profitlossEmitters.forEach(t=>{t.start()})}_createOAuthAuthorizationProvider(t){let e;const s={fastRenewOauthToken:this._fastRenewOauthToken,brokerId:(0,r.ensureDefined)(this._metainfo.id),environmentType:t,logger:this._logger,passLocalesLangInOAuth:this._ensuredConfigFlags().passLocalesLangInOAuth};return this._isOAuthImplicitFlowAuthType()?e=new OAuth2ImplicitFlowWithRenewTokenAuthorizationProvider(s):(s.passRedirectUrl=!0,e=new OAuth2CodeFlowAuthorizationProvider(s,this._host.credentialsStorage)),e}_instrumentInfo(t){const e=this._instruments.get(t);if(!e)throw new Error(`Symbol ${t} not found in instruments`);const s={qty:{min:e.minQty||1,max:e.maxQty||1e9,step:e.qtyStep||1},units:e.units,
pipValue:e.pipValue||1,pipSize:e.pipSize||.01,minTick:e.minTick||.01,description:e.description,brokerSymbol:t,hasQuotes:!e.hasOwnProperty("hasQuotes")||Boolean(e.hasQuotes)};return e.hasOwnProperty("lotSize")&&(s.lotSize=e.lotSize),e.hasOwnProperty("stopPriceStep")&&(s.stopPriceStep=e.stopPriceStep),e.hasOwnProperty("limitPriceStep")&&(s.limitPriceStep=e.limitPriceStep),"type"in e&&(s.type=e.type),"marginRate"in e&&(s.marginRate=e.marginRate),"baseCurrency"in e&&(s.baseCurrency=e.baseCurrency),"quoteCurrency"in e&&(s.quoteCurrency=e.quoteCurrency),s}_subscribeQuotes(t){const e=this._quotesSubscriptions.get(t),s=void 0===e?1:e+1;this._quotesSubscriptions.set(t,s),1===s&&this._changeQuotesRequesterUrl()}_unsubscribeQuotes(t){const e=this._quotesSubscriptions.get(t);if(void 0!==e)return 1===e?(this._quotesSubscriptions.delete(t),void this._changeQuotesRequesterUrl()):void this._quotesSubscriptions.set(t,e-1)}async _disconnect(t=!1){this._isOAuthAuthorizationType()&&this._cleanAndDestroyOauthAuthorizationProvider(),this._cleanup(),this._cleanAccessTokenExpirationTimeout(),!1===t&&(await this._host.credentialsStorage.clear(this._tokenStorageKey),this._ensuredConfigFlags().supportLogout&&await this._logout()),this._account.unsubscribe(this._setAccountBinded)}_getAccessToken(){return this._accessToken}_initializeAccountTasks(){const t=[];return t.push(()=>this._getAccounts().then(t=>{this._accounts=t})),t.push(()=>Promise.all(this._accounts.map(t=>this._getInstrumentsByAccountId(t.id).then(e=>{t.instruments=e})))),this._ensuredConfigFlags().supportUnhideSymbolSearchGroups?t.push(async()=>{this._permittedSymbolSearchGroups=await this._getPermittedSymbolSearchGroups();const t=this._getLastOrDefaultAccount();this._currentAccountPrefix=t.prefix,await this._updateMapper(this._metainfo.id,this._makeSymbolMapperOptions(t.prefix))}):t.push(()=>this._mapper.ready()),t.push(()=>{const t=this._getLastOrDefaultAccount();return this._setCustomFields(t),this._setAccountBinded(t).then(()=>this._account.subscribe(this._setAccountBinded))}),t}_makeSymbolMapperOptions(t){return{unhideSymbolSearchGroups:this.unhideSymbolSearchGroups(),exchange:t}}_setCustomFields(t){var e,s,i,r,o,n;const a=null!==(s=null===(e=t.ui)||void 0===e?void 0:e.orderCustomFields)&&void 0!==s?s:this._originalBrokerConfig.orderCustomFields;t.config.supportOrderCustomFields&&void 0!==a&&(this._orderColumns=this._mergeCustomFieldColumns(h,a));const u=null!==(r=null===(i=t.ui)||void 0===i?void 0:i.orderHistoryCustomFields)&&void 0!==r?r:this._originalBrokerConfig.orderHistoryCustomFields;t.config.supportOrderHistoryCustomFields&&void 0!==u&&(this._orderHistoryColumns=this._mergeCustomFieldColumns(d,u));const c=null!==(n=null===(o=t.ui)||void 0===o?void 0:o.positionCustomFields)&&void 0!==n?n:this._originalBrokerConfig.positionCustomFields;t.config.supportPositionCustomFields&&void 0!==c&&(this._positionColumns=this._mergeCustomFieldColumns(p,c))}_onQuotesUpdate(t){for(const e of t)if("ok"===e.s){const t=e.n,s=this._mapToTV(t);if(null!==s){const i=e.v;i.lp=i.lp||0,
i.ch=i.ch||0,i.chp=i.chp||0;const o=this._instruments.get(t);if(void 0===o)throw new Error(`Instrument ${t} not found`);if(("forex"===o.type||"cfd"===o.type)&&void 0!==o.pipSize){const t=(0,r.ensureDefined)(o.minPriceStep);i.spread=n()(i.ask).minus(i.bid).div(t).toNumber()}i.buyPipValue&&i.sellPipValue&&this._pipValueSubscriptions.has(t)&&(this._host.pipValueUpdate(s,{buyPipValue:i.buyPipValue,sellPipValue:i.sellPipValue}),o.pipValue=i.buyPipValue),this._currentQuotes.set(s,{ask:i.ask,bid:i.bid}),this._host.realtimeUpdate(s,i)}else this._logger.logError("Cannot map symbol")}}_changeQuotesRequesterUrl(){const t=this._getQuotesUrl();void 0!==this._requesters.quotes&&this._requesters.quotes.stop(),null!==t&&(void 0===this._requesters.quotes?(this._requesters.quotes=new D(t,f.Get,this._getHeaders(),null,this._getPullingInterval("quotes"),G),this._requesters.quotes.update.subscribe(this,this._onQuotesUpdate),this._requesters.quotes.statusChanged.subscribe(this,this._onRequesterStatusUpdate)):this._requesters.quotes.changeUrl(t),this._requesters.quotes.start())}_stopRequester(t){void 0!==t&&(t.stop(),t.update.unsubscribeAll(this))}async _requestExecutions(t){this._fetchedBrokerSymbols.add(t);const e=await k(this._getExecutionsUrl(t),f.Get,this._getHeaders(),null,G),s=(0,g.findArraysDifferences)(this._restExecutions,e,"id",["id"]);for(const t of s.added){this._restExecutions.push(t);const e=await this._executionToTv(t);this._tvExecutions.push(e),this._host.executionUpdate(e)}}_createMapper(){this._mapper=this._host.createMapperSync(this._metainfo.id,{unhideSymbolSearchGroups:this.unhideSymbolSearchGroups()})}async _requestExecutionsBySymbols(t){await Promise.all(t.map(t=>this._requestExecutions(t)))}_setAccountSummaryRowData(t){var e;const s=t.hasOwnProperty("equity")&&void 0!==t.equity?t.equity:t.balance+t.unrealizedPl;if(this._ensuredConfigFlags().supportCustomAccountSummaryRow){const e=(0,r.ensureDefined)(t.accountSummaryRowData,"Set Account Summary Row Data: Account summary row data");for(let t=0;t<e.length;t++)this._accountSummaryRowData.values[t].setValue(e[t])}else this._accountSummaryRowData.values[0].setValue(t.balance),this._accountSummaryRowData.values[1].setValue(s),(null===(e=this._metainfo.configFlags)||void 0===e?void 0:e.supportPLUpdate)?this._accountSummaryRowData.values[2].setValue(t.unrealizedPl):this._updateAccountPL();isFinite(s)&&this._host.equityUpdate(s)}_setAccountManagerTableData(t){if(0!==this._accountManagerTablesData.length)for(let e=0;e<t.length;e++){const s=t[e],i=this._accountManagerTablesData[e],o=(0,r.ensure)(this._brokerConfig.accountManager,"Set Account Manager Table Data: Account manager tables")[e].columns;i.length=s.length;for(let t=0;t<s.length;t++){const n=s[t],a={id:t};for(let t=0;t<n.length;t++){a[(0,r.ensure)(o[t].id)]=n[t]}i[t]=a,this._accountManagerTablesDelegates[e].fire(a)}}}async _createRequesters(){const t=this._getOrdersRestUrl(),e=this._getAccountStateRestUrl();if(this._requesters={
orders:new q(t,f.Get,this._getHeaders(),null,this._getPullingInterval("orders"),"id",x,G,void 0,!0),accountState:new D(e,f.Get,this._getHeaders(),null,this._getPullingInterval("accountManager"),G)},this._ensuredConfigFlags().supportPositions){const t=this._getPositionsRestUrl(),e=new q(t,f.Get,this._getHeaders(),null,this._getPullingInterval("positions"),"id",M,G);e.update.subscribe(this,this._onPositionsUpdate),e.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.positions=e}if(this._ensuredConfigFlags().supportBalances){const t=this._getBalancesRestUrl(),e=new D(t,f.Get,this._getHeaders(),null,this._getPullingInterval("balances"),G);e.update.subscribe(this,this._onCryptoBalancesUpdate),e.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.balances=e}const s=(0,r.ensure)(this._requesters.orders);s.update.subscribe(this,this._onOrdersUpdate),s.statusChanged.subscribe(this,this._onRequesterStatusUpdate),(0,r.ensure)(this._requesters.accountState).update.subscribe(this,this._onAccountStateUpdate)}async _startRequesters(){const t=[];Object.keys(this._requesters).forEach(e=>t.push((0,r.ensure)(this._requesters[e]).start())),await Promise.all(t),this._logger.logInfo("Requesters started")}_stopAndDeleteRequesters(){Object.keys(this._requesters).forEach(t=>{const e=this._requesters[t];void 0!==e&&this._stopRequester(e)}),this._requesters={}}_changeRequestersHeaders(){Object.keys(this._requesters).forEach(t=>{const e=(0,r.ensure)(this._requesters[t]);e.pause(),e.changeHeaders(this._getHeaders()),e.unpause()})}_cleanup(){this._stopAndDeleteRequesters(),this._cleanAndStopPLEmitters(),this._initData()}_cleanAndStopPLEmitters(){this._stopPLEmitters(),this._profitlossEmitters.clear()}_stopPLEmitters(){this._profitlossEmitters.forEach(t=>{t.stop()})}_setStatus(t,e){this._status.value()!==t&&(this._status.setValue(t),this._host.connectionStatusUpdate(t,e))}async _onRequesterStatusUpdate(t){2===t.requesterStatus&&(this._reconnectOnFailCount<=3?(this._logger.logError(`Requester error: ${t.errorMessage}. Reconnecting count: ${this._reconnectOnFailCount++} of 3.`),this._setStatus(4,{message:t.errorMessage}),await this._disconnect(!0),this._tryReconnect()):(this._logger.logError(`Requester error: ${t.errorMessage}. Maximum reconnect count reached. Disconnecting.`),this._setStatus(3,{message:t.errorMessage,disconnectType:l.DisconnectType.FailedRestoring}),await this._disconnect(!1)))}_onAccountStateUpdate(t){this._setAccountSummaryRowData(t);const e=Y(t);this._setAccountManagerTableData(e)}_onCryptoBalancesUpdate(t){const e=(0,g.findArraysDifferences)(this._cryptoBalances,t,"symbol",L);[...e.added,...e.modified].forEach(t=>{const e=this._cryptoBalanceIndexBySymbol(t.symbol);-1!==e?this._cryptoBalances[e]=t:this._cryptoBalances.push(t);const s=Z(t);this._cryptoBalanceTableChangeDelegate.fire(s),this._host.cryptoBalanceUpdate(t.symbol,t)}),e.removed.forEach(t=>{const e=this._cryptoBalanceIndexBySymbol(t.symbol);if(-1!==e){const s=0,i=0,r=0,o=Object.assign({},t,{total:s,available:i,
btcValue:r});this._cryptoBalances[e]=o;const n=Z(o);this._cryptoBalanceTableChangeDelegate.fire(n)}})}_cryptoBalanceIndexBySymbol(t){return this._cryptoBalances.findIndex(e=>e.symbol===t)}async _tryConnect(){const t=this._getStoredAuthResult();t&&(this._accessToken=t.access_token,this._setStatus(2),await this._setAndStartLoginTasks(),this._setAccessTokenExpirationTimeout(t.expiration),this._createButtonDropdownOptions(),this._setStatus(1),this._updatePLEmitters())}async _tryReconnect(){try{await this._tryConnect()}catch(t){this._logger.logError((0,g.getLoggerMessage)(t)),this._setStatus(3,{message:(0,g.getErrorMessage)(t),disconnectType:l.DisconnectType.FailedRestoring}),await this._disconnect()}}async _tryRestorePreviousSession(){try{await this._tryConnect()}catch(t){const e=(0,g.getErrorMessage)(t);this._logger.logNormal("Cannot restore session: "+e),this._setStatus(3,{message:void 0,disconnectType:l.DisconnectType.FailedRestoring}),await this._disconnect()}}_mergeCustomFieldColumns(t,e){const s=t.slice(),i=t.map(t=>t.property);for(const t of e){if(t.id in i){this._logger.logWarn(`Failed to add custom column. Column with id ${t.id} already exists.`);continue}const{id:e,title:o,tooltip:n,alignment:a}=t,u={label:o,property:e,help:n,notSortable:!0};void 0!==a&&((0,r.assert)(["left","right"].includes(a),"Cell alignment must be left or right"),u.alignment=a),s.splice(-1,0,u)}return s}_authorizeRequestTwoFactorCode(t,e){return async function(t,e,s){return v(t,void 0,f.Post,{...S(e,s),twoFactorRequired:!0})}(this._getAuthorizeUrl(),t,e)}_authorizeWithTwoFactorCode(t,e,s){return async function(t,e,s,i){return v(t,void 0,f.Post,{...S(e,s),twoFactorCode:i})}(this._getAuthorizeUrl(),t,e,s)}async _authorize(t,e){return async function(t,e,s){return v(t,void 0,f.Post,{...S(e,s)})}(this._getAuthorizeUrl(),t,e)}async _getInstrumentsByAccountId(t){return v(this._getInstrumentsUrlByAccountId(t),this._getAccessToken())}async _getOrdersHistoryByAccountId(t){return v(this._getOrdersHistoryUrlByAccountId(t),this._getAccessToken())}async _getPermittedSymbolSearchGroups(){const t=await v(this._getPermissionsUrl(),this._getAccessToken());return t.hasOwnProperty("groups")?t.groups:[(0,r.ensureDefined)(this._metainfo.id)]}async _getBrokerConfig(){const t=await v(this._getBrokerConfigUrl(),this._getAccessToken());if(null===t)throw new m.UserFriendlyError({detailedErrorMessage:rt+": Response is null",userFriendlyMessage:rt});return J(t)||(t.accountManager=[{id:"accountSummary",title:"",columns:[{id:"balance",title:(0,i.t)("Balance"),tooltip:"",sortable:!1},{id:"equity",title:(0,i.t)("Equity"),tooltip:"",sortable:!1},{id:"profit",title:(0,i.t)("Profit"),tooltip:"",sortable:!1}]}]),t}async _getAccountState(){return v(this._getAccountStateUrl(),this._getAccessToken())}async _placeOrder(t,e,s,i){const r=this._orderFromTV(t),o=this._getOrdersRestUrl()+"&requestId="+(0,w.randomHashN)(10);r.confirmId=i,null!==e&&(r.digitalSignature=e);const n=Object.assign(s,r);return v(o,this._getAccessToken(),f.Post,n)}async _modifyOrder(t,e,s,i){const r={id:t.id,
qty:t.qty};void 0===t.parentId&&(t.stopLoss&&(r.stopLoss=t.stopLoss),t.trailingStopPips&&(r.trailingStopPips=t.trailingStopPips),t.takeProfit&&(r.takeProfit=t.takeProfit)),void 0!==t.duration&&(r.durationType=t.duration.type,void 0!==t.duration.datetime&&(r.durationDateTime=Math.trunc(t.duration.datetime/1e3)));const o=this._currentQuotes.get(t.symbol);void 0!==o&&(r.currentAsk=o.ask,r.currentBid=o.bid),r.limitPrice=(t.type,t.limitPrice),r.stopPrice=(t.type,t.stopPrice);const n=this._getOrderIdRestUrl(t.id);null!==e&&(r.digitalSignature=e);const a=Object.assign(s,r);a.confirmId=i,await v(n,this._getAccessToken(),f.Put,a)}async _modifySingleOrder(t,e){const s=this._ensuredConfigFlags().supportDigitalSignature,i=t.customFields&&t.customFields.digitalSignature?t.customFields.digitalSignature:this._getDigitalSignatureState(),r=s?i.text:null;null!==r&&await this._setDigitalSignatureState(i);const o=Object.assign({},t.customFields);return delete o.digitalSignature,this._modifyOrder(t,r,o,e)}async _modifyPositionBracketsByOrder(t){if(void 0===this._tvPositionById(t.parentId))return;const e={...this._getPositionBrackets(t.parentId)};return 3===t.type&&(t.stopType===c.StopType.TrailingStop?(delete e.stopLoss,e.trailingStopPips=t.trailingStopPips):(delete e.trailingStopPips,e.stopLoss=t.stopPrice)),1===t.type&&(e.takeProfit=t.limitPrice),this.editPositionBrackets((0,r.ensure)(t.brokerSymbol,"Edit position brackets: Broker symbol"),e)}_createTvOrders(t){return t.map(t=>this._orderToTV(t))}_onOrdersUpdate(t){const e=this._createTvOrders(t.added),s=this._createTvOrders(t.modified),i=[];this._restOrders.push(...t.added);for(const e of t.modified)this._restOrders[this._restOrderIndexById(e.id)]=e;this._tvOrders.push(...e),i.push(...e);for(const t of s)this._tvOrders[this._tvOrderIndexById(t.id)]=t,i.push(t);for(const t of i){if(1===t.parentType){const e=this._tvOrderById(t.parentId);e&&(this._updateParentBrackets(e,t),this._host.orderUpdate(e))}else if(2===t.parentType){const e=this._tvPositionById(t.parentId);e&&e.qty>0&&(this._updateParentBrackets(e,t),this._host.positionPartialUpdate(e.id,{stopLoss:e.stopLoss,trailingStopPips:e.trailingStopPips,takeProfit:e.takeProfit}))}else if(!t.parentType){const e=this._getOrderBrackets(t.id);void 0!==e.stopLoss&&(t.stopLoss=e.stopLoss),void 0!==e.trailingStopPips&&(t.trailingStopPips=e.trailingStopPips),void 0!==e.takeProfit&&(t.takeProfit=e.takeProfit)}this._host.orderUpdate(t)}}_createTVPositions(t){return t.map(t=>this._positionToTV(t))}async _onPositionsUpdate(t){const e=[],s=this._createTVPositions(t.added),i=this._createTVPositions(t.modified);for(const e of t.added)this._addOrModifyPosition(e,this._restPositions);for(const e of t.modified)this._restPositions[this._restPositionIndexById(e.id)]=e;for(const t of s)this._updatePriceFormatterCacheForSymbol(t.symbol),this._updatePositionBrackets(t),this._host.positionUpdate(t),this._updatePositionPL(t),e.push((0,r.ensureDefined)(t.brokerSymbol,"Add position: Broker symbol")),this._addOrModifyPosition(t,this._tvPositions);for(const t of i){
const s=this._tvPositionById(t.id);if(void 0===s)return;this._updatePositionBrackets(t),this._host.positionUpdate(t),this._updatePositionPL(t),s.side===t.side&&s.qty===t.qty||e.push((0,r.ensureDefined)(t.brokerSymbol,"Update position: Broker symbol")),this._addOrModifyPosition(t,this._tvPositions)}t.removed.forEach(t=>{const s=this._tvPositionById(t.id);if(void 0===s)return;const i=this._restPositionById(t.id);s.qty=0,i.qty=0,e.push((0,r.ensureDefined)(s.brokerSymbol,"Remove position: Broker symbol"));const o=this._makePLEmitterKey(s),n=this._profitlossEmitters.get(o);void 0!==n&&(n.stop(),this._profitlossEmitters.delete(o)),this._host.positionUpdate(s)}),this._ensuredConfigFlags().supportExecutions&&await this._requestExecutionsBySymbols(e)}_updatePositionPL(t){var e,s;if(null===(e=this._metainfo.configFlags)||void 0===e?void 0:e.supportPLUpdate){const e=this._tvPositionById(t.id);(null==e?void 0:e.unrealizedPl)!==t.unrealizedPl&&(this._host.plUpdate(t.id,t.unrealizedPl),this._host.positionPartialUpdate(t.id,{unrealizedPl:t.unrealizedPl}))}else{const e=this._makePLEmitterKey(t);if(this._profitlossEmitters.has(e))null===(s=this._profitlossEmitters.get(e))||void 0===s||s.positionUpdate(t);else{const s=e=>{this._host.plUpdate(t.id,e),this._host.positionPartialUpdate(t.id,{unrealizedPl:e})},i=t.symbol,r=this._mapper.tvToBroker(i);try{if(null===r)throw new Error(`Symbol ${i} not found in mapping`);const o=this._instrumentInfo(r),n=this._host.createPLEmitter(t,s,o);this._profitlossEmitters.set(e,n),1===this.connectionStatus()&&n.start()}catch(t){this._logger.logError((0,g.getLoggerMessage)(t))}}}}_updateAccountPL(){let t=0;this._profitlossEmitters.forEach(e=>{t+=e.lastPL()}),this._accountSummaryRowData.values[2].setValue(t)}_updatePositionBrackets(t){this._findPositionBracketOrders(t.id).forEach(e=>this._updateParentBrackets(t,e))}_addOrModifyPosition(t,e){const s=e.findIndex(e=>e.id===t.id);-1!==s?e[s]=t:e.push(t)}_makePLEmitterKey(t){return this._ensuredConfigFlags().supportMultiposition?t.id:t.symbol}_restPositionIndexById(t){return this._restPositions.findIndex(e=>e.id===t)}_restPositionById(t){const e=this._restPositions.find(e=>e.id===t);if(!e)throw new Error("Cannot find REST position: "+t);return e}_restOrderIndexById(t){return this._restOrders.findIndex(e=>e.id===t)}_tvPositionById(t){return this._tvPositions.find(e=>e.id===t)}_tvOrderIndexById(t){return this._tvOrders.findIndex(e=>e.id===t)}_tvOrderById(t){const e=this._tvOrders.find(e=>e.id===t);if(!e)throw new Error("Cannot find TV order");return e}_getBaseRestUrl(){const t=this._account.value().id;return(0,r.assert)(!!t,"Unable to get base url - account is not properly initialized"),this._getBaseRestUrlByAccountId(t)}_getBaseRestUrlByAccountId(t){return`${this._restUrl}accounts/${encodeURIComponent(t)}`}_getAccountStateRestUrl(){return`${this._getBaseRestUrl()}/state?${a($)}`}_getExecutionsUrl(t){const e={...$,instrument:t};return`${this._getBaseRestUrl()}/executions?${a(e)}`}_getPullingInterval(t){let e=z[t]
;if(this._brokerConfig.hasOwnProperty("pullingInterval")&&void 0!==this._brokerConfig.pullingInterval){const s=this._brokerConfig.pullingInterval[t];void 0!==s&&(e=s)}return e}_getAuthorizeUrl(){return this._restUrl+"authorize"}_getBrokerConfigUrl(){return`${this._restUrl}config?${a($)}`}_getAccountsUrl(){return`${this._restUrl}accounts?${a($)}`}_getAccountStateUrl(){return`${this._getBaseRestUrl()}/state?${a($)}`}_getLeverageUrl(t){return`${this._getBaseRestUrl()}/${t}?${a($)}`}_getQuotesUrl(){const t=Array.from(this._quotesSubscriptions.keys()).filter(t=>this._instruments.has(t));if(0===t.length)return null;const e={...$,symbols:t.join(","),accountId:this._account.value().id};return`${this._restUrl}quotes?${a(e)}`}_getDepthUrl(t){const e={...$,symbol:t,accountId:this._account.value().id};return`${this._restUrl}depth?${a(e)}`}_getInstrumentsUrlByAccountId(t){return`${this._getBaseRestUrlByAccountId(t)}/instruments?${a($)}`}_getLogoutUrl(){return this._restUrl+"logout"}_getOrdersHistoryUrlByAccountId(t){const e={...$,maxCount:200};return`${this._getBaseRestUrlByAccountId(t)}/ordersHistory?${a(e)}`}_getPermissionsUrl(){return this._restUrl+"permissions"}_getOrdersRestUrl(){return`${this._getBaseRestUrl()}/orders?${a($)}`}_getOrderIdRestUrl(t){return`${this._getBaseRestUrl()}/orders/${t}?${a($)}`}_getPositionsRestUrl(){return`${this._getBaseRestUrl()}/positions?${a($)}`}_getPositionIdRestUrl(t){return`${this._getBaseRestUrl()}/positions/${t}?${a($)}`}_getBalancesRestUrl(){return`${this._getBaseRestUrl()}/balances?${a($)}`}_getOrderPreviewRestUrl(){return`${this._getBaseRestUrl()}/previewOrder?${a($)}`}async _logout(){try{await v(this._getLogoutUrl(),this._getAccessToken(),f.Post)}catch(t){this._logger.logError("Failed to logout request: "+(0,g.getLoggerMessage)(t))}}_getHeaders(){return b(this._getAccessToken())}_orderToTV(t){const e=this._mapToTV(t.instrument);null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument);const s={id:t.id,type:j(t.type),side:W(t.side),symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),filledQty:t.filledQty,status:(i=t.status,U[i]),avgPrice:t.avgPrice,limitPrice:t.limitPrice,stopPrice:t.stopPrice};var i;if(t.parentId&&(s.parentId=t.parentId,s.parentType=this._getOrderParentType(t.parentType),t.isTrailingStop&&(s.stopType=c.StopType.TrailingStop,s.trailingStopPips=t.trailingStopPips)),t.duration){s.duration={type:t.duration.type};const e=this._getOrderDuration(t.duration);if((0,r.assert)(void 0!==e,"Order duration is not in durations list. Please check the broker or account duration configuration"),s.expiry=void 0!==e?e.title:t.duration.type,t.duration.hasOwnProperty("datetime")&&void 0!==t.duration.datetime){const i=1e3*t.duration.datetime;s.duration.datetime=i,s.expiryTime={dateOrDateTime:i,hasTime:(0,r.ensureDefined)(e).hasTimePicker}}}return void 0!==t.message&&((0,g.isOrderOrPositionMessageType)(t.message.type)?s.message=t.message:this._logger.logError(`Order message type '${t.message.type}' is not supported`)),
void 0!==t.lastModified&&(s.updateTime=1e3*t.lastModified),void 0!==t.customFields&&(s.customFields=this._customFieldsToTv(t.customFields)),this._mergeCustomFields(t,s),s}_getOrderParentType(t){return"position"===t?2:1}_customFieldsToTv(t){const e={};for(const s of t)e[s.id]=s.value;return e}_mergeCustomFields(t,e){if(void 0!==t.customFields)for(const s of t.customFields)e[s.id]=s.value}_getOrderDuration(t){return(0,r.ensureDefined)(this._brokerConfig.durations,"Broker config: Durations").find(e=>e.id===(0,r.ensureDefined)(t).type)}_orderFromTV(t){var e,s;const i=this._mapFromTV(t.symbol);if(null!==i){const o={instrument:i,qty:t.qty,side:K(t.side),type:N(t.type),limitPrice:t.limitPrice,stopPrice:t.stopPrice};t.stopLoss&&(o.stopLoss=t.stopLoss),t.trailingStopPips&&(o.trailingStopPips=t.trailingStopPips),t.takeProfit&&(o.takeProfit=t.takeProfit),t.duration&&(o.durationType=t.duration.type,t.duration.datetime&&(o.durationDateTime=Math.trunc(t.duration.datetime/1e3)));const n=this._currentQuotes.get(t.symbol);return void 0===n&&null===t.seenPrice||(o.currentAsk=(0,r.ensure)(null!==(e=null==n?void 0:n.ask)&&void 0!==e?e:t.seenPrice,"OrderFromTv: Current ask"),o.currentBid=(0,r.ensure)(null!==(s=null==n?void 0:n.bid)&&void 0!==s?s:t.seenPrice,"OrderFromTv: Current bid")),o}throw new Error("Cannot map symbol: "+t.symbol)}_leverageParamsFromTV(t){const e=this._mapFromTV(t.symbol);if(null===e)throw new Error("Cannot map symbol: "+t.symbol);const s={instrument:e,side:K(t.side),orderType:N(t.orderType)};return"leverage"in t&&(s.leverage=t.leverage),void 0!==t.customFields&&Object.assign(s,t.customFields),s}_getBrackets(t){const e={};for(const s of t)3===s.type&&(s.stopType===c.StopType.TrailingStop?e.trailingStopPips=s.trailingStopPips:e.stopLoss=s.stopPrice),1===s.type&&(e.takeProfit=s.limitPrice);return e}_getOrderBrackets(t){const e=this._tvOrders.filter(e=>1===e.parentType&&e.parentId===t&&1!==e.status&&2!==e.status);return this._getBrackets(e)}_findPositionBracketOrders(t){return this._tvOrders.filter(e=>2===e.parentType&&e.parentId===t&&6===e.status)}_getPositionBrackets(t){const e=this._findPositionBracketOrders(t);return this._getBrackets(e)}_executionToTv(t){const e=this._mapToTV(t.instrument);return null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument),{id:t.id,symbol:e||"",brokerSymbol:t.instrument,price:t.price,qty:t.qty,side:W(t.side),time:1e3*t.time,orderId:t.orderId,isClose:t.isClose,positionId:t.positionId,commission:t.commission}}_positionToTV(t){const e=this._mapToTV(t.instrument);null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument);const s={id:t.id,symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),side:"buy"===t.side?1:-1,avgPrice:t.avgPrice,realizedPl:t.realizedPl,currency:this._account.value().currency};return void 0!==t.message&&((0,g.isOrderOrPositionMessageType)(t.message.type)?s.message=t.message:this._logger.logError(`Position message type '${t.message.type}' is not supported`)),this._ensuredConfigFlags().supportPLUpdate&&(s.unrealizedPl=t.unrealizedPl),
this._tvOrders.filter(t=>2===t.parentType&&t.parentId===s.id).forEach(t=>this._updateParentBrackets(s,t)),this._mergeCustomFields(t,s),s}_mapToTV(t){return this._mapper.brokerToTv(t)}_mapFromTV(t){return this._mapper.tvToBroker(t)}_initData(){this._accountManagerTablesDelegates=[],this._accountManagerTablesData=[],this._restExecutions=[],this._tvExecutions=[],this._restOrders=[],this._tvOrders=[],this._restPositions=[],this._tvPositions=[],this._instruments.clear(),this._priceFormatterCache.clear(),this._currentQuotes.clear(),this._cryptoBalances=[],this._accountSummaryRowData={titles:[],values:[],formatters:[]}}_createButtonDropdownOptions(){const t=this._host.defaultDropdownMenuActions({tradingProperties:!0});this._host.setButtonDropdownActions(t)}async _initRequesters(){this._accounts.length>0&&(await this._createRequesters(),await this._startRequesters())}_getStoredAuthResult(){return this._host.credentialsStorage.load(this._tokenStorageKey)}async _setAccessTokenExpirationTimeout(t){if(null===t)return;let e,s=this._checkAccessTokenExpiration.bind(this);e=1e3*(0,r.ensureDefined)(t,"Access token expiration")-Date.now().valueOf(),e<0?await this._checkAccessTokenExpiration():(s=this._checkAccessTokenExpiration.bind(this),e+=1e4,this._accessTokenExpirationTimeout=setTimeout(s,e))}async _saveAccessToken(t){await this._host.credentialsStorage.save(this._tokenStorageKey,t),this._accessToken=t.access_token}async _checkAccessTokenExpiration(){const t=this._getStoredAuthResult();if(t&&1e3*(0,r.ensureNotNull)(t.expiration,"Stored authorization result expiration")<=Date.now().valueOf()){const t=(0,i.t)("Access token has expired");this._logger.logError(t),this._setStatus(4,{message:t,disconnectType:l.DisconnectType.LogOut}),await this._disconnect()}}_onDepthUpdate(t,e){const s={snapshot:!0,asks:X(e.asks),bids:X(e.bids)};this._host.domeUpdate(t,s)}_getAccountWithTradableSymbol(t){let e=null;for(const s of this._accounts)if(-1!==s.instruments.findIndex(e=>t===e.name)){e=s;break}return e}async _createPriceFormatter(t){try{if(await this._host.isFractional(t))return await this._host.defaultFormatter(t,!0);const e=this._mapFromTV(t);if(null===e)throw new Error("Symbol not found");const s=this._instruments.get(e);if(void 0===s)throw new Error("Instrument not found");const i=Math.pow(10,(0,g.numOfDecimalPlaces)(s.minTick)),r=n()(s.minTick).mul(i).toNumber();return this._host.factory.createPriceFormatter(i,r,!1)}catch(e){return this._logger.logWarn(`Failed to create price formatter for symbol ${t}.`),this._host.factory.createPriceFormatter()}}async _getPriceFormatterForSymbol(t){let e=this._priceFormatterCache.get(t);return e||(e=await this._createPriceFormatter(t),this._priceFormatterCache.set(t,e)),e}async _updatePriceFormatterCacheForSymbol(t){if(!this._priceFormatterCache.has(t)){this._priceFormatterCache.set(t,null);const e=await this._createPriceFormatter(t);this._priceFormatterCache.set(t,e),this._tvPositions.filter(e=>e.symbol===t&&e.qty>0).forEach(t=>this._host.positionUpdate(t))}}_getAccountById(t){
return this._accounts.find(e=>e.id===t)}_saveAccountId(t){this._host.settings.save(this._lastAccountIdKey,JSON.stringify(t.id))}_getLastOrDefaultAccount(){var t;const e=this._host.settings.load(this._lastAccountIdKey,void 0);return void 0===e?this._accounts[0]:null!==(t=this._getAccountById(JSON.parse(e)))&&void 0!==t?t:this._accounts[0]}_isTwoFactorAuthorizationType(){return"password"===this._ensuredConfigFlags().authorizationType&&Boolean(this._ensuredConfigFlags().supportTwoFactorAuthorization)}_isSimplePasswordAuthorizationType(){return"password"===this._ensuredConfigFlags().authorizationType&&!this._ensuredConfigFlags().supportTwoFactorAuthorization}_isOAuthAuthorizationType(){return this._isOAuthCodeFlowAuthType()||this._isOAuthImplicitFlowAuthType()}_isOAuthImplicitFlowAuthType(){return"oauth2-implicit-flow"===this._ensuredConfigFlags().authorizationType}_isOAuthCodeFlowAuthType(){return"oauth2-code-flow"===this._ensuredConfigFlags().authorizationType}_makeDigitalSignatureCustomField(){return{inputType:"TextWithCheckBox",id:"digitalSignature",title:(0,i.t)("Digital Signature"),placeHolder:(0,i.t)("Enter your personal digital signature"),value:this._getDigitalSignatureState(),customInfo:{checkboxTitle:(0,i.t)("Save"),asterix:!0}}}async _setDigitalSignatureState(t){const e=t.checked?t:V;await this._host.credentialsStorage.save("digital-signature-state",e)}_getDigitalSignatureState(){const t=this._host.credentialsStorage.load("digital-signature-state");return null!==t?t:V}_makeAccountSummaryRowData(){let t=[],e=[];const s=[];if(this._ensuredConfigFlags().supportCustomAccountSummaryRow&&void 0!==this._brokerConfig.accountSummaryRow)for(const i of this._brokerConfig.accountSummaryRow)t.push(i.title),e.push(this._host.factory.createWatchedValue()),s.push("default");else t=[(0,i.t)("Account Balance"),(0,i.t)("Equity",{context:"trading"}),(0,i.t)("Profit")],e=[this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue()],s.fill("fixed",0,2);this._accountSummaryRowData.titles=t,this._accountSummaryRowData.values=e,this._accountSummaryRowData.formatters=s}_cleanAccessTokenExpirationTimeout(){null!==this._accessTokenExpirationTimeout&&(clearTimeout(this._accessTokenExpirationTimeout),this._accessTokenExpirationTimeout=null)}_cleanAndDestroyOauthAuthorizationProvider(){null!==this._oAuthAuthorizationProvider&&(this._oAuthAuthorizationProvider.renewTokenDelegate().unsubscribe(this,this._onRenewAccessTokenHandler),this._oAuthAuthorizationProvider.destroy(),this._oAuthAuthorizationProvider=null)}async _onRenewAccessTokenHandler(t){if(null===t)return this._setStatus(3),void await this._disconnect();await this._saveAccessToken(t),this._changeRequestersHeaders()}_ensuredConfigFlags(){return(0,r.ensureDefined)(this._metainfo.configFlags,"Config flags")}_makeAccountOrderDialogCustomFields(t){var e,s;return(null===(s=null===(e=t.ui)||void 0===e?void 0:e.orderDialogCustomFields)||void 0===s?void 0:s.comboBox)?tt(t.ui.orderDialogCustomFields.comboBox):[]}
_makeInstrumentOrderDialogCustomFields(t){var e,s;const i=this._mapFromTV(t);if(null===i)return[];const r=null===(s=null===(e=this._instruments.get(i))||void 0===e?void 0:e.ui)||void 0===s?void 0:s.orderDialogCustomFields;return void 0!==r?tt(r.comboBox):[]}_makeOrderDialogCustomFields(t){const e=this._makeInstrumentOrderDialogCustomFieldsMemoized(t),s=this._makeAccountOrderDialogCustomFieldsMemoized(this._account.value()),i=[...e.length>0?e:s];return this._ensuredConfigFlags().supportDigitalSignature&&i.push(this._makeDigitalSignatureCustomField()),i}_makeLeverageRequest(t,e,s){const i=this._leverageParamsFromTV(t);return v(s,this._getAccessToken(),e,i)}_updateParentBrackets(t,e){const s=st(e);if(!s){if(void 0!==this._tvOrders.find(s=>s.parentId===t.id&&s.id!==e.id&&s.type===e.type&&st(s)))return}const i=s?e.limitPrice:void 0,r=s?e.trailingStopPips:void 0,o=s?e.stopPrice:void 0;3===e.type&&(e.stopType===c.StopType.TrailingStop?(delete t.stopLoss,t.trailingStopPips=r,t.trailingStopPrice=o):(delete t.trailingStopPips,t.stopLoss=o)),1===e.type&&(t.takeProfit=i)}}},2005:(t,e,s)=>{s.r(e),s.d(e,{defaultConfigFlags:()=>i,applyDefaultsToConfigFlags:()=>r});const i={isSuspended:!1,supportDemoLiveSwitcher:!0,supportModifyOrderPrice:!0,supportEditAmount:!0,supportModifyBrackets:!0,supportMarketBrackets:!0,supportMarketOrders:!0,supportStopOrders:!0,supportLimitOrders:!0,supportStopLimitOrders:!1,supportPositions:!0,supportDOM:!0,supportModifyTrailingStop:!0,supportAddBracketsToExistingOrder:!0,supportVerifyLiveAccount:!0,supportReversePosition:!0,showNotificationsLog:!0,supportPLUpdate:!0,supportTwoFactorAuthorization:!1,supportDisplayBrokerNameInSymbolSearch:!0,supportCurrencyInOrderPreview:!0,supportRiskControls:!0};function r(t){return Object.assign({},i,t)}}}]);