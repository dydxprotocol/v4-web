(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[5142],{480849:t=>{t.exports={button:"button-VE6mnNFT"}},392612:t=>{t.exports={"trading-panel-content":"trading-panel-content-Rac5AHgL","trading-panel-spinner":"trading-panel-spinner-Rac5AHgL","trading-panel-handle":"trading-panel-handle-Rac5AHgL"}},645469:t=>{t.exports={"tablet-normal-breakpoint":"screen and (max-width: 768px)","small-height-breakpoint":"screen and (max-height: 360px)","tablet-small-breakpoint":"screen and (max-width: 430px)"}},849361:t=>{t.exports={dialog:"dialog-o2xKpnz8",wrapper:"wrapper-o2xKpnz8",separator:"separator-o2xKpnz8"}},424810:t=>{t.exports={"small-height-breakpoint":"screen and (max-height: 360px)",container:"container-HS2PTQRJ",unsetAlign:"unsetAlign-HS2PTQRJ",title:"title-HS2PTQRJ",subtitle:"subtitle-HS2PTQRJ",textWrap:"textWrap-HS2PTQRJ",ellipsis:"ellipsis-HS2PTQRJ",close:"close-HS2PTQRJ",icon:"icon-HS2PTQRJ"}},94725:t=>{t.exports={separator:"separator-LQ6E1iWj"}},600297:(t,e,i)=>{"use strict";i.d(e,{ButtonType:()=>s,Button:()=>n});var s,r=i(50959),o=i(480849);!function(t){t[t.PlusValue=0]="PlusValue",t[t.IncDec=1]="IncDec",t[t.Clear=2]="Clear",t[t.Default=3]="Default"}(s||(s={}));class n extends r.PureComponent{constructor(t){super(t),this._createClickHandler=(t,e=s.Default)=>()=>{this.props.onClick(t,e)}}render(){let t;switch(this.props.type){case s.PlusValue:case s.IncDec:t=this.props.value;break;case s.Clear:t="clear";break;case s.Default:t="default"}return r.createElement("div",{className:o.button,"data-value":t,"data-name":`qtyButtonCalculator-${t}`,onClick:this._createClickHandler(this.props.value,this.props.type)},this.props.icon||this.props.value)}}},190787:(t,e,i)=>{"use strict";function s(t,e){null===t.firstChild?t.textContent=e:t.firstChild.nodeValue=e}i.d(e,{updateTextNode:()=>s})},996038:(t,e,i)=>{"use strict";i.d(e,{DialogBreakpoints:()=>r});var s=i(645469);const r={SmallHeight:s["small-height-breakpoint"],TabletSmall:s["tablet-small-breakpoint"],TabletNormal:s["tablet-normal-breakpoint"]}},533408:(t,e,i)=>{"use strict";i.d(e,{AdaptivePopupDialog:()=>B});var s=i(50959),r=i(650151),o=i(416014),n=i(497754),a=i.n(n),l=i(180185),d=i(698043),c=i(40766),u=i(494707),h=i(996038),p=i(930052),_=i(910549);var g=i(206594),m=i(559410),b=i(72571),y=i(190410),v=i(507720),f=i(424810);function k(t){const{title:e,titleTextWrap:i=!1,subtitle:r,showCloseIcon:o=!0,onClose:n,onCloseButtonKeyDown:l,renderBefore:d,renderAfter:c,draggable:u,className:h,unsetAlign:p,closeAriaLabel:_,closeButtonReference:g}=t,[m,k]=(0,s.useState)(!1);return s.createElement(y.DialogHeaderContext.Provider,{value:{setHideClose:k}},s.createElement("div",{className:a()(f.container,h,(r||p)&&f.unsetAlign)},d,s.createElement("div",{"data-dragg-area":u,className:f.title},s.createElement("div",{className:a()(i?f.textWrap:f.ellipsis)},e),r&&s.createElement("div",{className:a()(f.ellipsis,f.subtitle)},r)),c,o&&!m&&s.createElement("button",{className:f.close,onClick:n,onKeyDown:l,"data-name":"close","aria-label":_,type:"button",ref:g
},s.createElement(b.Icon,{className:f.icon,icon:v,"data-name":"close","data-role":"button"}))))}var P=i(273388),S=i(849361);const C={vertical:20},w={vertical:0};class B extends s.PureComponent{constructor(){super(...arguments),this._controller=null,this._reference=null,this._orientationMediaQuery=null,this._renderChildren=(t,e)=>(this._controller=t,this.props.render({requestResize:this._requestResize,centerAndFit:this._centerAndFit,isSmallWidth:e})),this._handleReference=t=>this._reference=t,this._handleCloseBtnClick=()=>{this.props.onKeyboardClose&&this.props.onKeyboardClose(),this._handleClose()},this._handleClose=()=>{this.props.onClose()},this._handleOpen=()=>{void 0!==this.props.onOpen&&this.props.isOpened&&this.props.onOpen(this.props.fullScreen||window.matchMedia(h.DialogBreakpoints.TabletSmall).matches)},this._handleKeyDown=t=>{if(!t.defaultPrevented){if(this.props.onKeyDown&&this.props.onKeyDown(t),27===(0,l.hashFromEvent)(t)){if(t.defaultPrevented)return;if(this.props.forceCloseOnEsc&&this.props.forceCloseOnEsc())return this.props.onKeyboardClose&&this.props.onKeyboardClose(),void this._handleClose();const{activeElement:i}=document,s=(0,r.ensureNotNull)(this._reference);if(null!==i){if(t.preventDefault(),"true"===(e=i).getAttribute("data-haspopup")&&"true"!==e.getAttribute("data-expanded"))return void this._handleClose();if((0,d.isTextEditingField)(i))return void s.focus();if(s.contains(i))return this.props.onKeyboardClose&&this.props.onKeyboardClose(),void this._handleClose()}}var e,i;(function(t){if("function"==typeof t)return t();return Boolean(t)})(this.props.disableTabNavigationContainment)||(i=t,[9,l.Modifiers.Shift+9].includes((0,l.hashFromEvent)(i))&&i.stopPropagation())}},this._requestResize=()=>{null!==this._controller&&this._controller.recalculateBounds()},this._centerAndFit=()=>{null!==this._controller&&this._controller.centerAndFit()}}componentDidMount(){this.props.ignoreClosePopupsAndDialog||m.subscribe(g.CLOSE_POPUPS_AND_DIALOGS_COMMAND,this._handleClose,null),this._handleOpen(),void 0!==this.props.onOpen&&(this._orientationMediaQuery=window.matchMedia("(orientation: portrait)"),(0,o.mediaQueryAddEventListener)(this._orientationMediaQuery,this._handleOpen))}componentWillUnmount(){this.props.ignoreClosePopupsAndDialog||m.unsubscribe(g.CLOSE_POPUPS_AND_DIALOGS_COMMAND,this._handleClose,null),null!==this._orientationMediaQuery&&(0,o.mediaQueryRemoveEventListener)(this._orientationMediaQuery,this._handleOpen)}focus(){(0,r.ensureNotNull)(this._reference).focus()}getElement(){return this._reference}contains(t){var e,i;return null!==(i=null===(e=this._reference)||void 0===e?void 0:e.contains(t))&&void 0!==i&&i}render(){
const{className:t,wrapperClassName:e,headerClassName:i,isOpened:r,title:o,titleTextWrap:n,dataName:l,onClickOutside:d,additionalElementPos:g,additionalHeaderElement:m,backdrop:b,shouldForceFocus:y=!0,showSeparator:v,subtitle:f,draggable:B=!0,fullScreen:T=!1,showCloseIcon:E=!0,rounded:O=!0,isAnimationEnabled:D,growPoint:I,dialogTooltip:L,unsetHeaderAlign:A,onDragStart:N,dataDialogName:V,closeAriaLabel:x,containerAriaLabel:M,reference:R,containerTabIndex:q,closeButtonReference:F,onCloseButtonKeyDown:U}=this.props,W="after"!==g?m:void 0,Q="after"===g?m:void 0,H="string"==typeof o?o:V||"",$=(0,P.mergeRefs)([this._handleReference,R]);return s.createElement(p.MatchMedia,{rule:h.DialogBreakpoints.SmallHeight},(g=>s.createElement(p.MatchMedia,{rule:h.DialogBreakpoints.TabletSmall},(h=>s.createElement(c.PopupDialog,{rounded:!(h||T)&&O,className:a()(S.dialog,t),isOpened:r,reference:$,onKeyDown:this._handleKeyDown,onClickOutside:d,onClickBackdrop:d,fullscreen:h||T,guard:g?w:C,boundByScreen:h||T,shouldForceFocus:y,backdrop:b,draggable:B,isAnimationEnabled:D,growPoint:I,name:this.props.dataName,dialogTooltip:L,onDragStart:N,containerAriaLabel:M,containerTabIndex:q},s.createElement("div",{className:a()(S.wrapper,e),"data-name":l,"data-dialog-name":H},void 0!==o&&s.createElement(k,{draggable:B&&!(h||T),onClose:this._handleCloseBtnClick,renderAfter:Q,renderBefore:W,subtitle:f,title:o,titleTextWrap:n,showCloseIcon:E,className:i,unsetAlign:A,closeAriaLabel:x,closeButtonReference:F,onCloseButtonKeyDown:U}),v&&s.createElement(u.Separator,{className:S.separator}),s.createElement(_.PopupContext.Consumer,null,(t=>this._renderChildren(t,h||T)))))))))}}},190410:(t,e,i)=>{"use strict";i.d(e,{DialogHeaderContext:()=>s});const s=i(50959).createContext({setHideClose:()=>{}})},494707:(t,e,i)=>{"use strict";i.d(e,{Separator:()=>n});var s=i(50959),r=i(497754),o=i(94725);function n(t){return s.createElement("div",{className:r(o.separator,t.className)})}},132455:(t,e,i)=>{"use strict";i.d(e,{Spinner:()=>n});var s=i(50959),r=i(497754),o=i(663654);i(286625);function n(t){const e=r(t.className,"tv-spinner","tv-spinner--shown",`tv-spinner--size_${o.spinnerSizeMap[t.size||o.DEFAULT_SIZE]}`);return s.createElement("div",{className:e,style:t.style,role:"progressbar"})}},106056:(t,e,i)=>{"use strict";var s,r,o;i.d(e,{CloseTrigger:()=>s,ToastAnimationStage:()=>r,ToastPriority:()=>o}),function(t){t[t.Swipe=0]="Swipe",t[t.Click=1]="Click"}(s||(s={})),function(t){t[t.Add=0]="Add",t[t.Remove=1]="Remove",t[t.None=2]="None"}(r||(r={})),function(t){t[t.Low=0]="Low",t[t.Medium=1]="Medium",t[t.High=2]="High"}(o||(o={}))},987320:t=>{t.exports={loader:"loader-HS0L_8Ao","loader-animation":"loader-animation-HS0L_8Ao",loaderCircle:"loaderCircle-HS0L_8Ao"}},818940:t=>{t.exports={loader:"loader-vqx5DqPL",loaderItem:"loaderItem-vqx5DqPL","loader-animation":"loader-animation-vqx5DqPL",touchMode:"touchMode-vqx5DqPL"}},262927:t=>{t.exports={blockHidden:"blockHidden-Cky0LHBF","pane-button":"pane-button-Cky0LHBF"}},228161:t=>{t.exports={"css-value-padding":"4px"}},899516:t=>{
t.exports={"css-value-padding":"4px",wrapper:"wrapper-_W8EGxGy",notAvailableOnMobile:"notAvailableOnMobile-_W8EGxGy",column:"column-_W8EGxGy",button:"button-_W8EGxGy",sellButton:"sellButton-_W8EGxGy",buyButton:"buyButton-_W8EGxGy",brokerButton:"brokerButton-_W8EGxGy",highButtons:"highButtons-_W8EGxGy",withoutBg:"withoutBg-_W8EGxGy",lastCharSup:"lastCharSup-_W8EGxGy",spreadQtyWrapper:"spreadQtyWrapper-_W8EGxGy",spread:"spread-_W8EGxGy",withoutQty:"withoutQty-_W8EGxGy",qty:"qty-_W8EGxGy",loader:"loader-_W8EGxGy",circleLoader:"circleLoader-_W8EGxGy",loading:"loading-_W8EGxGy",buttonText:"buttonText-_W8EGxGy",brokerButtonIconWrap:"brokerButtonIconWrap-_W8EGxGy",brokerButtonDefault:"brokerButtonDefault-_W8EGxGy",touchMode:"touchMode-_W8EGxGy",buttons:"buttons-_W8EGxGy"}},864852:t=>{t.exports={popupWrapper:"popupWrapper-RRbMYOzv"}},138813:(t,e,i)=>{"use strict";i.d(e,{LoaderBaseRenderer:()=>r});var s=i(262927);class r{constructor(t,e={}){this._loadingEl=document.createElement("span"),this._renderLoading(e),this.toggleVisibility(!1),t.appendChild(this._loadingEl)}toggleVisibility(t){this._loadingEl.classList.toggle(s.blockHidden,!t)}_renderLoading(t){const{className:e}=t;e&&this._loadingEl.classList.add(e)}}},976496:(t,e,i)=>{"use strict";i.d(e,{LoaderPointsRenderer:()=>o});var s=i(138813),r=i(818940);class o extends s.LoaderBaseRenderer{_renderLoading(t){super._renderLoading(t),this._loadingEl.innerHTML=`\n\t\t\t<span class="${r.loaderItem}"></span>\n\t\t\t<span class="${r.loaderItem}"></span>\n\t\t\t<span class="${r.loaderItem}"></span>\n\t\t`,this._loadingEl.classList.add(r.loader)}}},291089:(t,e,i)=>{"use strict";i.d(e,{trackingModeIsAvailable:()=>s});const s=i(601227).CheckMobile.any()},535513:(t,e,i)=>{"use strict";i.d(e,{BrokerService:()=>r});var s=i(650151);class r{constructor(t){this._activeBroker=null,this._trading=t,this._trading.onConnectionStatusChange.subscribe(this,this._onStatusChange),this._onStatusChange(this._trading.connectStatus())}activeBroker(){return this._activeBroker}trading(){return this._trading}_stopService(){this.stopService(),(0,s.ensureNotNull)(this._activeBroker).currentAccountUpdate.unsubscribeAll(this)}_startService(){this.startService(),(0,s.ensureNotNull)(this._activeBroker).currentAccountUpdate.subscribe(this,this._onCurrentAccountUpdate)}_onStatusChange(t){const e=this._trading.activeBroker();this._activeBroker===e&&1===t||(null!==this._activeBroker&&(this._stopService(),this._activeBroker=null),null!==e&&1===t&&(this._activeBroker=e,this._startService(),this._lastAccountId=e.currentAccount()))}_onCurrentAccountUpdate(){const t=(0,s.ensureNotNull)(this._activeBroker);this._lastAccountId!==t.currentAccount()&&(this.stopService(),this.startService(),this._lastAccountId=t.currentAccount())}}},649990:(t,e,i)=>{"use strict";i.r(e),i.d(e,{addBroker:()=>bt,brokersList:()=>yt,createBrokerConnection:()=>ft});var s=i(509806),r=i(116193),o=i(484727),n=i(486028),a=i(922157),l=i.n(a),d=i(650151);class c{constructor(t){this._objects={},this._started=!1,this._isObjectsRequestActual=!1,
this._ordersPromise=null,this._getter=t,this.updateDelegate=new(l()),this.partialUpdateDelegate=new(l())}start(){this._started||(this._started=!0,this._ordersPromise=this._requestObjects())}stop(){this._objects={},this._started=!1,this._ordersPromise=null,this._isObjectsRequestActual=!1}update(t,e){this._started&&(this._isObjectsRequestActual?this._isObjectsRequestActual=!1:(this._objects[t.id]=t,this._onObjectUpdated(t,e)))}partialUpdate(t,e){if(!this._started)return;if(this._isObjectsRequestActual)return void(this._isObjectsRequestActual=!1);let i,s;(0,n.isObject)(t)?(i=t.id,s=t):(i=t,s=(0,d.ensure)(e));const r=this._objects[i];r&&(Object.assign(r,s),this.partialUpdateDelegate.fire(r,s))}fullUpdate(){this._started&&(this._isObjectsRequestActual?this._isObjectsRequestActual=!1:this._ordersPromise=this._requestObjects())}getObjects(){return this._ordersPromise||Promise.resolve(Object.values(this._objects))}_onObjectUpdated(t,e){this.updateDelegate.fire(t,e)}_onAllObjectsUpdated(){this._objectsCache().forEach((t=>this.updateDelegate.fire(t,!0)))}_objectsCache(){return Object.values(this._objects)}async _requestObjects(){let t=[];do{this._isObjectsRequestActual=!0,t=await this._getter()}while(!this._isObjectsRequestActual);var e;return this._objects=(e="id",t.reduce(((t,i)=>(t[i[e]]=i,t)),{})),this._ordersPromise=null,this._isObjectsRequestActual=!1,this._onAllObjectsUpdated(),t}}var u=i(817808),h=i(510986);class p extends c{constructor(t,e){super(t),this._brokerConfigGetter=e}_onObjectUpdated(t,e){this._patchTrades(this._objectsCache().filter((e=>e.symbol===t.symbol&&0!==e.qty)),t,e),super._onObjectUpdated(t,e)}_onAllObjectsUpdated(){this._patchTrades(this._objectsCache().filter((t=>0!==t.qty))),super._onAllObjectsUpdated()}_patchTrades(t,e,i){const s=this._brokerConfigGetter();let r;r=s.requiresFIFOCloseTrades?s.fifoOnlyForSameQty?m:g:_;const o=r(t);for(const t of o)e!==t&&super._onObjectUpdated(t,i)}}function _(t){const e=[];for(const i of t)i.canBeClosed||(i.canBeClosed=!0,e.push(i));return e}function g(t){const e={};for(const i of t){let t=e[i.symbol];void 0===t&&(t={oldest:null,all:[]},e[i.symbol]=t),(null===t.oldest||t.oldest.date>i.date)&&(t.oldest=i),t.all.push(i)}const i=[];for(const t of Object.keys(e)){const s=(0,d.ensureDefined)(e[t]);for(const t of s.all){const e=s.oldest===t,r=e!==t.canBeClosed;t.canBeClosed=e,r&&i.push(t)}}return i}function m(t){const e={};for(const i of t){let t=e[i.symbol];void 0===t&&(t={},e[i.symbol]=t);let s=t[i.qty];void 0===s&&(s={oldest:null,all:[]},t[i.qty]=s),(null===s.oldest||s.oldest.date>i.date)&&(s.oldest=i),s.all.push(i)}const i=[];for(const t of Object.keys(e)){const s=(0,d.ensureDefined)(e[t]);for(const t of Object.keys(s)){const e=(0,d.ensureDefined)(s[t]);for(const t of e.all){const s=e.oldest===t,r=s!==t.canBeClosed;t.canBeClosed=s,r&&i.push(t)}}}return i}var b=i(129917),y=i(696546),v=i(652945),f=i(872580),k=i(220863),P=i(842974);function S(t,e){return{symbol:e.symbol,type:2,side:1===e.side?-1:1,qty:Math.abs(t),seenPrice:null,isClose:!0}}var C=i(549387);class w{
constructor(){this._validators=new Map}add(t,e){this._validators.set(e,t)}validate(t){const e={};let i=!0;for(const[s,r]of this._validators.entries()){const o=r.validate(t);o.isValid||(i=!1,e[s]=o.errorMessage)}return i?{isValid:i}:{isValid:i,errorMessages:e}}}class B{constructor(t,e=[]){this._status=C.PlaceOrEditContextStatus.Undefined,this._onStatusChange=new(l()),this._errors={},this._isValidationEnabled=t,this._validator=new w;for(const{validator:t,validatorName:i}of e)this._validator.add(t,i)}onReady(){return this._onReady}data(){return this._orderData}status(){return this._status}errors(){return this._errors}onStatusChange(){return this._onStatusChange}async send(t){if(this._status!==C.PlaceOrEditContextStatus.Undefined)return!1;this._setStatus(C.PlaceOrEditContextStatus.Loading),await this._onReady;const e=await this._processSend(t),i=e?C.PlaceOrEditContextStatus.Undefined:C.PlaceOrEditContextStatus.Error;return this._setStatus(i),e}async _setData(t){this._orderData=await this._processOrderData(t),this._assertOrderIsValid()}_assertOrderIsValid(){const{isValid:t,errorMessages:e}=this._validate();let i=!1;if(t)i=this._status!==C.PlaceOrEditContextStatus.Undefined,this._errors={},this._status=C.PlaceOrEditContextStatus.Undefined;else{const[t]=(0,n.deepEquals)(this._errors,e);i=!t,this._errors=e,this._status=C.PlaceOrEditContextStatus.Error}i&&this._onStatusChange.fire()}_setStatus(t){this._status!==t&&(this._status=t,this._onStatusChange.fire())}_validate(){return this._isValidationEnabled?this._validator.validate(this._orderData):{isValid:!0}}}var T=i(578291),E=i(79581);class O{constructor(t){const{priceType:e,quotes:i,formatter:s,instrumentInfo:r,supportStopOrdersInBothDirections:o,supportStopLimitOrdersInBothDirections:n}=t;this._priceType=e,this._quotes=i,this._formatter=s,this._supportStopOrdersInBothDirections=Boolean(o),this._supportStopLimitOrdersInBothDirections=Boolean(n),this._symbolType=r.type||"",this._minTick=r.minTick,this._limitPriceStep=r.limitPriceStep,this._stopPriceStep=r.stopPriceStep,this._variableMinTickData=r.variableMinTick?(0,E.makeVariableMinTickData)(this._minTick,r.variableMinTick):void 0}validate(t){const{type:e,side:r,stopPrice:o,limitPrice:n}=t,a=2===this._priceType;if(2===e||a&&1===e||!a&&3===e)return{isValid:!0};const l=a?o:n;if(void 0===l)return{isValid:!1,errorMessage:s.t(null,void 0,i(347957))};const d=(0,P.getPriceStep)({price:l,priceType:this._priceType,minTick:this._minTick,variableMinTickData:this._variableMinTickData,limitPriceStep:this._limitPriceStep,stopPriceStep:this._stopPriceStep}),c=(0,P.roundToStepRequired)({priceType:this._priceType,minTick:this._minTick,limitPriceStep:this._limitPriceStep,stopPriceStep:this._stopPriceStep}),u=(0,T.validatePrice)({price:l,askOrBid:(0,P.getQuotePrice)(this._quotes,r),orderType:e,side:r,isStopPrice:a,isForex:"forex"===this._symbolType,formatter:this._formatter,supportStopOrdersInBothDirections:this._supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:this._supportStopLimitOrdersInBothDirections,step:d,
roundedToStep:c});return u.res?{isValid:!1,errorMessage:u.msg}:{isValid:!0}}}var D=i(886630);class I{constructor(t){this._quantityMetainfo=t}validate(t){const e=(0,D.checkQtyError)(this._quantityMetainfo,t.qty,!0);return e.res?{isValid:!1,errorMessage:e.msg}:{isValid:!0}}}class L extends B{constructor(t){const{orderData:e,instrumentInfo:i,quotes:s,configFlags:r,formatter:o,isValidationEnabled:n,callbacks:a}=t;super(n,[{validator:new I(i.qty),validatorName:"qty"},{validator:new O({priceType:2,quotes:s,formatter:o,instrumentInfo:i,supportStopOrdersInBothDirections:r.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:r.supportStopLimitOrdersInBothDirections}),validatorName:"stopPrice"},{validator:new O({priceType:1,quotes:s,formatter:o,instrumentInfo:i,supportStopOrdersInBothDirections:r.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:r.supportStopLimitOrdersInBothDirections}),validatorName:"limitPrice"}]),this._createInitialPreOrder=a.createInitialPreOrder,this._placeOrder=a.placeOrder,this._previewOrder=a.previewOrder,this._onReady=this._setData(e)}async preview(){return this._status===C.PlaceOrEditContextStatus.Error?{sections:[]}:this._previewOrder(this._orderData)}externalContext(){return{type:C.PlaceOrEditContextType.PlaceOrder,data:()=>this.data(),send:()=>this.send(),status:()=>this.status(),errors:()=>this.errors()}}_processSend(t){return this._placeOrder(this._orderData,t)}_processOrderData(t){return this._createInitialPreOrder(t)}}var A=i(822914),N=i(971204);class V extends B{constructor(t){const{orderData:e,callbacks:i}=t;super(!1),this._modifyOrder=i.modifyOrder,this._metainfo=i.metainfo,this._symbolInfo=i.symbolInfo,this._orderById=i.orderById,this._onReady=this._setData(e)}externalContext(){return{type:C.PlaceOrEditContextType.EditOrder,data:()=>this.data(),send:()=>this.send(),status:()=>this.status(),errors:()=>this.errors()}}async _processOrderData(t){if(!this._metainfo().configFlags.supportModifyTrailingStop){const e=await this._orderById(t.id);t.hasTrailingStopBracket=void 0!==e&&void 0!==e.trailingStopPips}const{limitPriceStep:e,stopPriceStep:i}=await this._symbolInfo(t.symbol);if(t.limitPrice=void 0!==e&&void 0!==t.limitPrice?(0,y.roundToStepByPriceTypeAndSide)(t.limitPrice,e,1,t.side):t.limitPrice,t.stopPrice=void 0!==i&&void 0!==t.stopPrice?(0,y.roundToStepByPriceTypeAndSide)(t.stopPrice,i,2,t.side):t.stopPrice,void 0!==t.parentId&&!o.enabled("always_pass_called_order_to_modify")){let e;try{e=await this._orderById(t.parentId)}catch(t){(0,y.getLoggerMessage)(t)}if(void 0!==e&&(0,P.isOrderActive)(e.status)){const i=(0,A.default)(e);return void 0!==t.limitPrice&&(i.takeProfit=t.limitPrice),void 0!==t.stopPrice&&(t.stopType===N.StopType.TrailingStop&&void 0!==t.trailingStopPips?(i.trailingStopPips=t.trailingStopPips,delete i.stopLoss):(i.stopLoss=t.stopPrice,delete i.trailingStopPips)),i}}return t}_processSend(t){return this._modifyOrder(this._orderData,t)}_configureValidator(){}}var x=i(159537);const M=(0,
u.getLogger)("Trading.BrokerConnectionAdapter"),R=s.t(null,void 0,i(473142)),q=s.t(null,void 0,i(945593));function F(t){(0,d.assert)("object"!=typeof t,"Expected not an object")}function U(t,e){return t.type===e.type&&t.qty===e.qty&&t.limitPrice===e.limitPrice&&t.stopPrice===e.stopPrice&&t.takeProfit===e.takeProfit&&t.stopLoss===e.stopLoss&&t.trailingStopPips===e.trailingStopPips}class W{constructor({brokerMetainfo:t,brokerConnection:e,host:r,brokerRealtimeAdapter:o,tradingStat:n,tradingSettingsStorageGetter:a,brokerPlan:d}){this.connectionStatusUpdate=new(l()),this.executionUpdate=new(l()),this.tradingOperationFinished=new(l()),this.currentAccountUpdate=new(l()),this._brokerPlan=null,this._subscriptions={},this._lastFireResult={},this._fakeDomeSubscriptions={},this._formattersCache={},this._spreadFormattersCache={},this._quantityFormattersCache={},this._tradesCache=null,this._fakePositionUpdateDelegate=null,this._realtimeSubscriptionState=[],this._loggedInManually=!1,this._pendingSubscriptions=[],this._sessionId=(0,k.guid)(),this.leverageInfo=t=>{if(this.config.supportLeverage&&this._brokerConnection.leverageInfo)return this._brokerConnection.leverageInfo(t);throw new Error("Method leverage is not implemented")},this.setLeverage=t=>{if(this.config.supportLeverage&&this._brokerConnection.setLeverage)return this._brokerConnection.setLeverage(t);throw new Error("Method setLeverage is not implemented")},this.previewLeverage=t=>{if(this.config.supportLeverage&&this._brokerConnection.previewLeverage)return this._brokerConnection.previewLeverage(t);throw new Error("Method previewLeverage is not implemented")},this.maintenanceStatus=async()=>{try{return void 0!==this._brokerConnection.maintenanceStatus?await this._brokerConnection.maintenanceStatus():{isMaintenance:!1}}catch(t){return this._brokerLogger.logError(`Failed to fetch maintenance status: ${(0,y.getLoggerMessage)(t)}`),{isMaintenance:!0,message:s.t(null,{replace:{brokerName:this._brokerMetainfo.title}},i(8793))}}},this.config=Object.assign({},t.configFlags),this._brokerMetainfo=this._patchMetainfo(t),this._brokerPlan=d||null,this._brokerConnection=e,this._host=r,this._tradingStat=n,this._getTradingSettingsStorage=a,this._brokerLogger=(0,u.getLogger)("Trading."+this._brokerMetainfo.id+".Connection"),r.setBrokerConnectionAdapter(this),this._initializeConnectProtection(),this._positionsCache=e.positions?new c((()=>e.positions?e.positions():Promise.resolve([]))):null,this._tradesCache=e.trades?new p((()=>e.trades?e.trades():Promise.resolve([])),(()=>this.config)):null,this._ordersCache=new c((()=>e.orders()));const h=t=>{1===t?(null!==this._positionsCache&&this._positionsCache.start(),this._ordersCache.start(),this._tradesCache&&this._tradesCache.start()):(null!==this._positionsCache&&this._positionsCache.stop(),this._ordersCache.stop(),this._tradesCache&&this._tradesCache.stop())};this.connectionStatusUpdate.subscribe(null,h),h(this.connectionStatus()),this._originalDOMESubscriptionMethods={subscribeDOME:e.subscribeDOME,unsubscribeDOME:e.unsubscribeDOME},
this._patchBrokerSubscribeUnsubscribeDOMEMethods(),this.connectionStatusUpdate.subscribe(null,(t=>{1===t&&this._patchBrokerSubscribeUnsubscribeDOMEMethods()})),t.configFlags.supportPositions||(this._fakePositionUpdateDelegate=new(l())),this._brokerRealtimeAdapter=o}tryRestoreSession(){if(this._brokerConnection.tryRestoreSession)return this._brokerConnection.tryRestoreSession()}get orderUpdate(){return this._ordersCache.updateDelegate}get positionUpdate(){return null===this._fakePositionUpdateDelegate?(0,d.ensure)(this._positionsCache).updateDelegate:this._fakePositionUpdateDelegate}get tradeUpdate(){return(0,d.ensure)(this._tradesCache).updateDelegate}get orderPartialUpdate(){return this._ordersCache.partialUpdateDelegate}get positionPartialUpdate(){return null===this._fakePositionUpdateDelegate?(0,d.ensure)(this._positionsCache).partialUpdateDelegate:this._fakePositionUpdateDelegate}get tradePartialUpdate(){return(0,d.ensure)(this._tradesCache).partialUpdateDelegate}onOrderUpdate(t){this._ordersCache.update(t)}onOrderPartialUpdate(t,e){this._ordersCache.partialUpdate(t,e)}onPositionUpdate(t,e){if((0,d.assert)(!!this.config.supportPositions,"Broker doesn`t support positions"),0===t.qty){const e=this._lastFireResult[t.id];e&&delete e.PL}(0,d.ensure)(this._positionsCache).update(t,e)}onPositionPartialUpdate(t,e){(0,d.assert)(!!this.config.supportPositions,"Broker doesn`t support positions"),(0,d.ensure)(this._positionsCache).partialUpdate(t,e)}onTradeUpdate(t,e){if((0,d.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),0===t.qty){const e=this._lastFireResult[t.symbol];e&&delete e.TradePL}(0,d.ensure)(this._tradesCache).update(t,e)}onTradePartialUpdate(t,e){(0,d.ensure)(this._tradesCache).partialUpdate(t,e)}onCurrentAccountChanged(){null!==this._positionsCache&&this._positionsCache.fullUpdate(),this._ordersCache.fullUpdate(),this._tradesCache&&this._tradesCache.fullUpdate();const t=this.currentAccount();this.currentAccountUpdate.fire(t)}patchConfig(t){(0,b.migrateConfigFlags)(t),Object.assign(this.config,t),Object.assign(this._brokerMetainfo.configFlags,t),this._brokerMetainfo=this._patchMetainfo(this._brokerMetainfo)}async getOrderDialogOptions(t){return void 0!==this._brokerConnection.getOrderDialogOptions?this._brokerConnection.getOrderDialogOptions(t):void 0}getPositionDialogOptions(){return void 0!==this._brokerConnection.getPositionDialogOptions?this._brokerConnection.getPositionDialogOptions():void 0}getValidationRules(t){return void 0!==this._brokerConnection.getValidationRules?this._brokerConnection.getValidationRules(t):void 0}chartContextMenuActions(t,e){return this._brokerConnection.chartContextMenuActions(t,e)}buttonDropdownActions(){return this._host.buttonDropdownActions()}connectionStatus(){return this._brokerConnection.connectionStatus()}isConnected(){return 1===this._brokerConnection.connectionStatus()}signIn(t,e,i,s){return this._brokerLogger.logNormal(`Try to login with username: ${t}`),this._loggedInManually=!0,this._brokerConnection.signIn(t,e,i,s)}loggedInManually(){
return this._loggedInManually}disconnect(t=!1){try{return this._brokerConnection.disconnect(t)}catch(t){M.logWarn("Failed to disconnect")}}currentAccount(){return this._brokerConnection.currentAccount?this._brokerConnection.currentAccount():""}currentAccountType(){return this._brokerConnection.currentAccountType?this._brokerConnection.currentAccountType():void 0}metainfo(){return this._brokerMetainfo}brokerPlan(){return this._brokerPlan}bro(){return this._brokerConnection}fireSubscription(t,e,i,s){if(void 0===this._lastFireResult[e]&&(this._lastFireResult[e]={Realtime:null,PL:null,Equity:null,DOME:null,TradePL:null,PipValue:null,MarginAvailable:null,CryptoBalance:null}),(0,d.ensure)(this._lastFireResult[e])[t]={data:i,time:Date.now()},void 0===this._subscriptions[e])return;const r=(0,d.ensure)(this._subscriptions[e]);(0,d.ensure)(r[t]).forEach((t=>t(e,i,s)))}positions(t){return this.config.supportPositions?(this._makeSureBrokerIsConnected(),this._positions().then((e=>e.filter((e=>void 0===t||e.symbol===t))))):Promise.resolve([])}disconnectWarningMessage(){return this._brokerConnection.disconnectWarningMessage?this._brokerConnection.disconnectWarningMessage():null}connectWarningMessage(){return this._brokerConnection.connectWarningMessage?this._brokerConnection.connectWarningMessage():null}trades(t){return this._makeSureBrokerIsConnected(),(0,d.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),this._trades().then((e=>e.filter((e=>void 0===t||e.symbol===t))))}positionById(t){return this._brokerConnection.positionById?this._brokerConnection.positionById(t):this.positions().then((e=>e.find((e=>e.id===t))))}tradeById(t){return(0,d.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),this.trades().then((e=>e.find((e=>e.id===t))))}orders(t){return this._makeSureBrokerIsConnected(),this._orders().then((e=>e.filter((e=>void 0===t||e.symbol===t))))}ordersHistory(){return this._makeSureBrokerIsConnected(),this.config.supportOrdersHistory&&this._brokerConnection.ordersHistory?this._brokerConnection.ordersHistory():Promise.resolve([])}async executions(t){return this.config.supportExecutions?(this._makeSureBrokerIsConnected(),this._brokerConnection.executions(t)):[]}async allExecutions(){return void 0===this._brokerConnection.allExecutions?[]:this._brokerConnection.allExecutions()}orderById(t){return this._makeSureBrokerIsConnected(),this._brokerConnection.orders().then((e=>e.find((e=>e.id===t))))}accountManagerInfo(){return this._brokerConnection.accountManagerInfo()}isTradable(t){return this._makeSureBrokerIsConnected(),this._brokerConnection.isTradable(t).then((e=>("object"!=typeof e&&(e={tradable:e}),e.tradable||void 0!==e.reason||(e.reason=(0,y.makeNonTradableSymbolText)((0,v.htmlEscape)(t),this._brokerMetainfo.title)),e)))}formatter(t,e=!0){return this._makeSureBrokerIsConnected(),this._formattersCache[t]||(this._formattersCache[t]=this._brokerConnection.formatter&&this._brokerConnection.formatter(t,e)||this._host.defaultFormatter(t,e)),(0,
h.makeTimeLimited)(this._formattersCache[t],1e4,"formatter not received")}spreadFormatter(t){return this._makeSureBrokerIsConnected(),this._spreadFormattersCache[t]||(this._spreadFormattersCache[t]=this._brokerConnection.spreadFormatter&&this._brokerConnection.spreadFormatter(t)||this._host.defaultFormatter(t,!1)),(0,h.makeTimeLimited)(this._spreadFormattersCache[t],1e4,"spreadFormatter not received")}quantityFormatter(t){return this._makeSureBrokerIsConnected(),this._quantityFormattersCache[t]||(this._quantityFormattersCache[t]=this._brokerConnection.quantityFormatter&&this._brokerConnection.quantityFormatter(t)||this._host.quantityFormatter()),(0,h.makeTimeLimited)(this._quantityFormattersCache[t],1e4,"quantityFormatter not received")}async createInitialPreOrder(t){return this._createInitialPreOrder(t)}async createPlaceOrderContext(t,e=!0){const[i,s,r]=await Promise.all([this.symbolInfo(t.symbol),this.formatter(t.symbol),this.quotesSnapshot(t.symbol)]),{configFlags:o}=this.metainfo(),n=new L({orderData:t,instrumentInfo:i,quotes:r,configFlags:o,formatter:s,isValidationEnabled:e,callbacks:{createInitialPreOrder:t=>this._createInitialPreOrder(t),placeOrder:(t,e)=>this._placeOrder(t,e),previewOrder:t=>this._previewOrder(t)}});return await n.onReady(),n}async createEditOrderContext(t){const e=new V({orderData:t,callbacks:{modifyOrder:this._modifyOrder.bind(this),metainfo:this.metainfo.bind(this),symbolInfo:this.symbolInfo.bind(this),orderById:this.orderById.bind(this)}});return await e.onReady(),e}placeOrder(t,e){return this._placeOrder(t,e)}previewOrder(t){return this._previewOrder(t)}modifyOrder(t,e){return this._modifyOrder(t,e)}cancelOrder(t){return F(t),this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.cancelOrder(t),!0,s.t(null,void 0,i(915926)))}cancelOrders(t,e,r){return this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.cancelOrders(t,e,r),!0,s.t(null,void 0,i(305140)))}async closePosition(t,e){let i;F(t),this._makeSureBrokerIsConnected(),(0,d.assert)(void 0===e||!!this.config.supportPartialClosePosition,"Broker doesn`t support partial position closing");const s=new Promise((async(s,r)=>{try{const r=await this._positionCopyById(t);i=t=>{void 0!==r&&t.id===r.id&&t.symbol===r.symbol&&t.qty!==r.qty&&(this.positionUpdate.unsubscribe(this,i),s(!0))},this.positionUpdate.subscribe(this,i),await this._closePosition(t,e)}catch(t){r(t)}}));return(0,h.makeTimeLimited)(s,3e4,"Position closing timeout").catch((t=>(this._brokerLogger.logError(`${R}: ${(0,y.getLoggerMessage)(t)}`),this.positionUpdate.unsubscribe(this,i),!1)))}async closeTrade(t,e){var r;F(t),this._makeSureBrokerIsConnected(),(0,d.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),(0,d.assert)(void 0===e||null!==(r=this.config.supportPartialCloseTrade)&&void 0!==r&&r,"Broker doesn`t support partial position closing");const o=(0,d.ensureDefined)(await this.tradeById(t));if(0===o.qty)return this._host.showNotification(s.t(null,void 0,i(791401)),s.t(null,void 0,i(715842)),0),!1
;if(void 0===e||e<=Math.abs(o.qty)){if(this._brokerConnection.closeTrade){const i=S(null!=e?e:Math.abs(o.qty),o);return this.processErrors(this._brokerConnection.closeTrade(t,e),!0,R,(()=>(0,d.ensureNotNull)(this._tradingStat).trackOrderPlaced(i)))}throw new Error("Method closeTrade is not implemented")}return this._host.showNotification(s.t(null,void 0,i(791401)),s.t(null,void 0,i(365389)),0),!1}reversePosition(t){if(F(t),this._makeSureBrokerIsConnected(),this.config.supportMultiposition&&!this.config.supportNativeReversePosition)throw new Error("Cannot reverse position on multiposition account");let e;const i=new Promise((async(i,s)=>{try{const s=await this._positionCopyById(t);e=t=>{void 0!==s&&t.symbol===s.symbol&&t.side!==s.side&&(this.positionUpdate.unsubscribe(this,e),i(!0))},this.positionUpdate.subscribe(this,e),await this._reversePosition(t)}catch(t){s(t)}}));return(0,h.makeTimeLimited)(i,3e4,"Position reversing timeout").catch((t=>(this._brokerLogger.logError(`${q}: ${(0,y.getLoggerMessage)(t)}`),this.positionUpdate.unsubscribe(this,e),!1)))}editPositionBrackets(t,e,r){if(this._makeSureBrokerIsConnected(),this._brokerConnection.editPositionBrackets)return this.processErrors(this._brokerConnection.editPositionBrackets(t,e,r),!0,s.t(null,void 0,i(140766)));throw new Error("Method editPositionBrackets is not implemented")}editTradeBrackets(t,e){if(this._makeSureBrokerIsConnected(),(0,d.assert)(!!this.config.supportTradeBrackets,"Broker doesn`t support brackets on trades"),this._brokerConnection.editTradeBrackets)return this.processErrors(this._brokerConnection.editTradeBrackets(t,e),!0,s.t(null,void 0,i(140766)));throw new Error("Method editTradeBrackets is not implemented")}async subscribeRealtime(t,e){this._makeSureBrokerIsConnected();const i={symbol:t,listener:e,provider:0};this._realtimeSubscriptionState.push(i);const s=await this.symbolInfo(t),r=this._realtimeSubscriptionState.findIndex((i=>i.symbol===t&&i.listener===e));if(-1!==r)return void 0!==s.hasQuotes&&!1===s.hasQuotes?(this._realtimeSubscriptionState[r].provider=1,(0,d.ensure)(this._brokerRealtimeAdapter).subscribeRealtime(t,e)):(this._realtimeSubscriptionState[r].provider=2,this._addSubscription("Realtime",t,e))}async quotesSnapshot(t){let e,i;const s=(t,r)=>{i=r,(r.ask||r.bid)&&(this.unsubscribeRealtime(t,s),null==e||e(r))},r=new Promise((i=>{e=i,this.subscribeRealtime(t,s)}));try{return await(0,h.makeTimeLimited)(r,1e4,"quotesSnapshot not received")}catch(e){if(this.unsubscribeRealtime(t,s),void 0!==i)return i;throw e}}subscribeDOME(t,e){return this._makeSureBrokerIsConnected(),this._addSubscription("DOME",t,e)}subscribePipValue(t,e){return this._makeSureBrokerIsConnected(),this._addSubscription("PipValue",t,e)}subscribePL(t,e){this._makeSureBrokerIsConnected(),this._addSubscription("PL",t,e)}subscribeTradePL(t,e){return this._makeSureBrokerIsConnected(),this._addSubscription("TradePL",t,e)}subscribeCryptoBalance(t,e){return this._makeSureBrokerIsConnected(),this._addSubscription("CryptoBalance",t,e)}subscribeEquity(t){
return this._makeSureBrokerIsConnected(),this._addSubscription("Equity","Equity",t)}subscribeMarginAvailable(t){return this._makeSureBrokerIsConnected(),this._addSubscription("MarginAvailable","MarginAvailable",t)}unsubscribeRealtime(t,e){const i=this._realtimeSubscriptionState.findIndex((i=>i.symbol===t&&i.listener===e));-1!==i&&(1===this._realtimeSubscriptionState[i].provider?(0,d.ensure)(this._brokerRealtimeAdapter).unsubscribeRealtime(t,e):this._removeSubscription("Realtime",t,e),this._realtimeSubscriptionState.splice(i,1))}unsubscribeDOME(t,e){this._removeSubscription("DOME",t,e)}unsubscribePipValue(t,e){this._removeSubscription("PipValue",t,e)}unsubscribePL(t,e){this._removeSubscription("PL",t,e)}unsubscribeTradePL(t,e){this._removeSubscription("TradePL",t,e)}unsubscribeCryptoBalance(t,e){this._removeSubscription("CryptoBalance",t,e)}unsubscribeEquity(t){this._removeSubscription("Equity","Equity",t)}unsubscribeMarginAvailable(t){this._removeSubscription("MarginAvailable","MarginAvailable",t)}async accountMetainfo(){const t=await this.accountsMetainfo(),e=this.currentAccount(),i=t.find((t=>t.id===e));if(void 0===i)throw new Error("accountMetainfo not received");return i}accountsMetainfo(){return(0,h.makeTimeLimited)(this._brokerConnection.accountsMetainfo(),1e4,"accountsMetainfo not received")}setCurrentAccount(t){if(void 0===this._brokerConnection.setCurrentAccount)throw new Error(`${this._brokerMetainfo.title} doesn't support sub-accounts`);this._brokerConnection.setCurrentAccount(t)}symbolInfo(t){return(0,h.makeTimeLimited)(this._brokerConnection.symbolInfo(t),1e4,"symbolInfo not received")}async getPositionCurrency(t){try{const e=await this._brokerConnection.symbolInfo(t);if(this._brokerMetainfo.configFlags.positionPLInInstrumentCurrency&&void 0!==e.currency)return e.currency;const i=await this.accountMetainfo();return(0,P.getCurrency)(i,!0)}catch(t){return void M.logError(t)}}sessionId(){return this._sessionId}bugReportInfo(){function t(t){return JSON.parse(JSON.stringify(t))}function e(t){if("object"!=typeof t)return t;if((0,n.isArray)(t))return t.map(e);const i={};for(const e in t)"object"!=typeof t[e]&&(i[e]=t[e]);return i}return Promise.all([this.orders(),this.positions(),this.config.supportTrades?this.trades():Promise.resolve([])]).then((i=>({activeBroker:this.metainfo().title,orders:e(t(i[0])),positions:e(t(i[1])),trades:e(t(i[2])),silentOrdersPlacement:this._host.silentOrdersPlacement().value(),floatingPanel:(0,d.ensureNotNull)(this._host.sellBuyButtonsVisibility()).value(),account:this.currentAccount(),accountType:this.currentAccountType(),lastUpdates:this._lastFireResult,time:Date.now(),brokerSpecific:this._brokerConnection.bugReportInfo?this._brokerConnection.bugReportInfo():null,sessionId:this._sessionId})))}processErrors(t,e,r,a){if(!(0,n.isPromise)(t))throw new Error("Broker incorrectly implements API, should return Promise");return t.then((t=>a&&a(t))).then((t=>"boolean"!=typeof t||t)).catch((t=>{if((0,x.isAbortError)((0,y.getErrorCauses)(t)[0]))return Promise.resolve(!1);let n=""
;return"string"==typeof t?n=t:"object"==typeof t&&"string"==typeof t.message&&(n=(0,v.removeTags)(t.message)),e&&o.enabled("trading_notifications")?(0!==n.length&&("."!==n.slice(-1)&&(n+="."),n+=" "),n+=s.t(null,void 0,i(352303)),this._host.showNotification(r||"",n,0)):M.logWarn(t),Promise.resolve(!1)})).then((t=>(this.tradingOperationFinished.fire(t),t)))}setDurations(t){this._brokerMetainfo.durations=t.slice()}setSymbolSearchId(t){this._brokerMetainfo.backendBrokerName=t}getRealtimeDataCheckParams(){return this._brokerConnection.getRealtimeDataCheckParams?this._brokerConnection.getRealtimeDataCheckParams():{}}getVerifyLiveAccountParams(){if(void 0===this._brokerConnection.getVerifyLiveAccountParams)throw new Error(`Method getVerifyLiveAccountParams for broker ${this._brokerMetainfo.id} is not implemented`);return this._brokerConnection.getVerifyLiveAccountParams()}unhideSymbolSearchGroups(){return this._brokerConnection.unhideSymbolSearchGroups?this._brokerConnection.unhideSymbolSearchGroups():[]}destroy(){void 0!==this._brokerConnection.destroy&&this._brokerConnection.destroy()}currentBroker(){return this._brokerMetainfo.id}async _createInitialPreOrder(t){var e,i,s;if(void 0===t.duration){const{allowedDurations:r}=await this.symbolInfo(t.symbol),{durations:o}=this.metainfo(),n=(0,P.getOrderDuration)({orderDuration:void 0,orderType:t.type,savedDuration:null!==(s=null===(i=null===(e=this._getTradingSettingsStorage)||void 0===e?void 0:e.call(this))||void 0===i?void 0:i.duration(t.symbol,t.type))&&void 0!==s?s:null,orderDurations:o,symbolDurations:r});null!==n&&(t.duration=n)}if(void 0===t.customFields){const e=await this._getSavedCustomFields(t.symbol,t.type);void 0!==e&&(t.customFields=e)}return t}async _getSavedCustomFields(t,e){var i,s;const r=await this.getOrderDialogOptions(t),o=null!==(s=null===(i=this._getTradingSettingsStorage)||void 0===i?void 0:i.call(this))&&void 0!==s?s:void 0;if(void 0===o||void 0===(null==r?void 0:r.customFields)||0===r.customFields.length)return;const n=r.customFields.map((t=>t.id)),a=o.customFields(t,e,n),l=(0,P.adjustSavedCustomFieldsValues)(a,r);return 0!==Object.keys(l).length?l:void 0}_placeOrder(t,e){return this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.placeOrder(t,e),!0,s.t(null,void 0,i(842180)),(e=>{(0,d.ensureNotNull)(this._tradingStat).trackOrderPlaced({...t,id:e.orderId}),this._host.trackEvent("","SilentMode",this._host.silentOrdersPlacement().value()?"On":"Off")}))}async _modifyOrder(t,e){this._makeSureBrokerIsConnected();const r=new Set((await this._orders()).map((({id:t})=>t)));r.delete(t.id);return await this.processErrors(this._brokerConnection.modifyOrder(t,e),!0,s.t(null,void 0,i(54746)))&&this._waitForOrderModification(t,r)}_previewOrder(t){if(!this._brokerConnection.previewOrder)throw new Error("Order preview is not supported");return this._brokerConnection.previewOrder(t)}_initializeConnectProtection(){let t=null;this.connectionStatusUpdate.subscribe(null,(e=>{if(t&&(clearTimeout(t),t=null),2===e){const e=(0,
P.isOAuthAuthType)(this.config.authorizationType)?3e5:6e4;t=setTimeout((()=>{this._host.selectBroker(),this._host.showNotification(s.t(null,void 0,i(170891)),s.t(null,void 0,i(247956)))}),e)}}))}_fakeSubscribeDOME(t){this._fakeDomeSubscriptions[t]=(t,e)=>{const i=e.ask||e.trade,s=e.bid||e.trade,r={snapshot:!0,asks:i?[{price:i,volume:e.ask_size||1/0}]:[],bids:s?[{price:s,volume:e.bid_size||1/0}]:[]};this._host.domeUpdate(t,r)},this.subscribeRealtime(t,this._fakeDomeSubscriptions[t])}_fakeUnsubscribeDOME(t){this.unsubscribeRealtime(t,this._fakeDomeSubscriptions[t])}_isMaintenance(){return isFeatureEnabled((0,P.makeMaintananceFeatureToggleName)(this._brokerMetainfo.id))}_isBrokerSideMaintenance(){return isFeatureEnabled((0,P.makeBrokerSideMaintananceFeatureToggleName)(this._brokerMetainfo.id))}async _positionCopyById(t){const e=await this.positionById(t);return void 0!==e?(0,r.default)(e):void 0}_patchBrokerSubscribeUnsubscribeDOMEMethods(){const t=!this._brokerMetainfo.configFlags.supportLevel2Data;this._brokerConnection.subscribeDOME=t?t=>{this._fakeSubscribeDOME(t)}:this._originalDOMESubscriptionMethods.subscribeDOME,this._brokerConnection.unsubscribeDOME=t?t=>{this._fakeUnsubscribeDOME(t)}:this._originalDOMESubscriptionMethods.unsubscribeDOME}_patchMetainfo(t){const e=(0,f.deepCopy)(t);return e.configFlags.supportNativeReversePosition=!this.config.supportMultiposition||this.config.supportNativeReversePosition,e.configFlags.supportClosePosition=!0,e.configFlags.supportPLUpdate=!0,e}_addSubscription(t,e,i){this._pendingSubscriptions.push({brokerMethodName:t,symbol:e,listener:i});const s=this._lastFireResult[e];if(void 0!==s&&void 0!==s[t]&&null!==s[t]&&i(e,s[t].data),!this._removePendingSubscription({brokerMethodName:t,symbol:e,listener:i}))return;void 0===this._subscriptions[e]&&(this._subscriptions[e]={Realtime:[],PL:[],Equity:[],DOME:[],TradePL:[],PipValue:[],MarginAvailable:[],CryptoBalance:[]});const r=(0,d.ensure)(this._subscriptions[e]),o=r[t].length>0;if(r[t].push(i),!o&&(r[t].length>0||"CryptoBalance"===t)){const i="subscribe"+t;this._brokerConnection[i]&&this._brokerConnection[i](e)}}_removePendingSubscription(t){const e=this._pendingSubscriptions.findIndex((e=>e.symbol===t.symbol&&e.brokerMethodName===t.brokerMethodName&&e.listener===t.listener));return-1!==e&&(this._pendingSubscriptions.splice(e,1),!0)}_removeSubscription(t,e,i){if(this._removePendingSubscription({brokerMethodName:t,symbol:e,listener:i}))return;if(void 0===this._subscriptions[e])return;const s=(0,d.ensure)(this._subscriptions[e]),r=s[t].indexOf(i);if(r>-1&&s[t].splice(r,1),0===s[t].length){const i="unsubscribe"+t;this._brokerConnection[i]&&this._brokerConnection[i](e)}}_positions(){return this._positionsCache?this._positionsCache.getObjects():Promise.resolve([])}_trades(){return this._tradesCache?this._tradesCache.getObjects():Promise.resolve([])}_orders(){return this._ordersCache.getObjects()}_makeSureBrokerIsConnected(){(0,d.assert)(1===this.connectionStatus(),"Broker is not connected")}_placeReversePositionOrder(t){const e=S(2*t.qty,t)
;return this._placeOrder(e)}async _closePosition(t,e){const r=(0,d.ensureDefined)(await this.positionById(t));if(0===r.qty){const t=s.t(null,void 0,i(715842));throw this._host.showNotification(R,t,0),new Error(t)}if(void 0===e||e<=Math.abs(r.qty)){const i=S(null!=e?e:Math.abs(r.qty),r);return this.config.supportClosePosition&&this._brokerConnection.closePosition?void await this.processErrors(this._brokerConnection.closePosition(t,e),!0,R,(()=>(0,d.ensureNotNull)(this._tradingStat).trackOrderPlaced(i))):void await this.processErrors(this._brokerConnection.placeOrder(i),!0,R,(()=>(0,d.ensureNotNull)(this._tradingStat).trackOrderPlaced(i)))}{const t=s.t(null,void 0,i(365389));throw this._host.showNotification(R,t,0),new Error(t)}}async _reversePosition(t){const e=(0,d.ensureDefined)(await this.positionById(t));if(0===e.qty){const t=s.t(null,void 0,i(726500));throw this._host.showNotification(q,t,0),new Error(t)}this.config.supportNativeReversePosition&&this._brokerConnection.reversePosition?await this.processErrors(this._brokerConnection.reversePosition(t),!0,q):await this.processErrors(this._placeReversePositionOrder(e),!0,q,(()=>(0,d.ensureNotNull)(this._tradingStat).trackOrderPlaced()))}async _waitForOrderModification(t,e){return new Promise((async i=>{const s=()=>{i(!0),o(),clearTimeout(n)},r=e=>{U(e,t)&&s()},o=()=>this.orderUpdate.unsubscribe(this,r),n=setTimeout((()=>{i(!1),this._brokerLogger.logError("Failed to modify order: timeout waiting for new order"),o()}),3e4);this.orderUpdate.subscribe(this,r);for(const i of await this._orders())if(!e.has(i.id)&&U(t,i))return void s()}))}}var Q=i(960521),H=i(870122),$=i.n(H),j=i(210596),z=i.n(j),G=i(871555),K=i(66568),J=i(778389),Z=i(588163),X=i(821737),Y=i(153055),tt=i(889384),et=i(278885),it=i(30021),st=i(844210),rt=i(546563);class ot{constructor(t,e,i,s){this._lastPL=0,this._isActive=!1,this._realtimeUpdate=(t,e)=>{this._realtimeData=e,this._updatePL()},this._symbol=t.symbol,this._adapter=i,this._onPlUpdate=e,this._side=t.side,this._qty=t.qty,this._avgPrice=t.avgPrice,this._instrumentInfo=s,this.positionUpdate(t)}positionUpdate(t){this._avgPrice=t.avgPrice,this._qty=t.qty,this._side=t.side,this._updatePL()}lastPL(){return this._lastPL}start(){this._isActive||(this._adapter.subscribeRealtime(this._symbol,this._realtimeUpdate),this._isActive=!0)}stop(){this._isActive&&(this._adapter.unsubscribeRealtime(this._symbol,this._realtimeUpdate),this._isActive=!1)}_updatePL(){var t;if(!this._realtimeData||void 0===this._realtimeData.bid||void 0===this._realtimeData.ask)return;const e=Number(new Q.Big(1===this._side?this._realtimeData.bid:this._realtimeData.ask).minus(Math.abs(this._avgPrice)).mul(1===this._side?1:-1).mul(this._qty).mul(null!==(t=this._instrumentInfo.lotSize)&&void 0!==t?t:1).div(this._instrumentInfo.pipSize).mul(this._instrumentInfo.pipValue));this._lastPL=e,this._onPlUpdate(e)}}class nt{constructor(t,e,i,s){var r;this._setDefaultDropdownActionsBound=this._setDefaultDropdownActions.bind(this),this.serverLogger=()=>this._serverLogger,this.createMapperAsync=t=>({
tvToBroker:async t=>t,brokerToTv:async t=>t}),this.createMapperSync=(t,e)=>{let i=null;{const t=Promise.resolve();i={ready:()=>t,tvToBroker:t=>t,brokerToTv:t=>t}}return i},this._trading=t,this._metainfo=e,this._serverLogger=null!==i?this._makeServerLoggerWithFilledInfo(i):null,this._setDefaultDropdownActionsBound=this._setDefaultDropdownActions.bind(this),this._defaultDropdownActions=!0,this._credentialsStorage=s,this._setDefaultDropdownActions(),null!==this._trading&&(null===(r=this.sellBuyButtonsVisibility())||void 0===r||r.subscribe(this._setDefaultDropdownActionsBound),(0,d.ensureNotNull)(this.orderPanelVisibility()).subscribe(this._setDefaultDropdownActionsBound),(0,d.ensureNotNull)(this.domPanelVisibility()).subscribe(this._setDefaultDropdownActionsBound))}createPLEmitter(t,e,i){return new ot(t,e,this._adapter,i)}getLogger(){return(0,u.getLogger)("Trading."+this._metainfo.id)}translate(t){return t}setBrokerConnectionAdapter(t){this._adapter=t}patchConfig(t){this._adapter.patchConfig(t)}showOrderDialog(t,e){return(0,d.ensureNotNull)(this._trading).orderViewController().showOrderView({order:t,focus:e})}showPositionBracketsDialog(t,e,i){return(0,d.ensureNotNull)(this._trading).orderViewController().showPositionView(t,e,i)}showCancelOrderDialog(t,e){return it.ConfirmOrderCancelDialog.get().open(t).then((t=>{t&&this._adapter.processErrors(e(),!0,s.t(null,void 0,i(915926)))}))}showCancelMultipleOrdersDialog(t,e,r,o){return it.ConfirmOrderCancelDialog.get().multiple(t,e,r).then((t=>{t&&this._adapter.processErrors(o(),!0,s.t(null,void 0,i(305140)))}))}showCancelBracketsDialog(t,e){return st.ConfirmBracketsCancelDialog.get().open(t).then((t=>{t&&this._adapter.processErrors(e(),!0,s.t(null,void 0,i(951099)))}))}showCancelMultipleBracketsDialog(t,e){return st.ConfirmBracketsCancelDialog.get().multiple(t).then((t=>{t&&this._adapter.processErrors(e(),!0,s.t(null,void 0,i(951099)))}))}showReversePositionDialog(t,e){return(0,rt.reversePositionDialog)(t,(0,d.ensureNotNull)(this._trading).showErrorNotification,e)}showMessageDialog(t,e,i=!1){i?(0,Y.showWarning)({title:t,html:e}):(0,Y.showWarning)({title:t,text:e})}showConfirmDialog(t,e,i,s,r){return(0,tt.showConfirmDialog)({title:t,content:e,mainButtonText:i,cancelButtonText:s,showDisableConfirmationsCheckbox:r})}showSimpleConfirmDialog(t,e,i,s,r){return(0,et.showSimpleConfirmDialog)({title:t,text:Array.isArray(e)?e.join(" "):e,mainButtonText:i,mainButtonIntent:"primary",cancelButtonText:s,showDisableConfirmationsCheckbox:r})}showSimpleConfirmDialogAndRespectAbort(t,e,i,s,r,o){return(0,et.showSimpleConfirmDialog)({title:t,text:Array.isArray(e)?e.join(" "):e,abortSignal:i,mainButtonText:s,mainButtonIntent:"primary",cancelButtonText:r,showDisableConfirmationsCheckbox:o})}setDurations(t){this._adapter.setDurations(t)}setSymbolSearchId(t){this._adapter.setSymbolSearchId(t)}activateBottomWidget(){return null!==this._trading?this._trading.toggleTradingWidget():Promise.reject("Activate bottom widget failed: trading is not defined")}trackEvent(t,e,i){
null!==this._trading&&this._trading.trackEvent(t,e,i)}defaultFormatter(t,e){return(0,Z.getQuoteSessionInstance)("simple").formatter(t,e)}numericFormatter(t){return Promise.resolve(new K.NumericFormatter(t))}quantityFormatter(t){return Promise.resolve(new J.QuantityFormatter(t))}selectBroker(){null!==this._trading&&this._trading.selectBroker(null)}showTradingProperties(){null!==this._trading&&this._trading.showTradingProperties()}async getSymbolType(t){return(await at(t)).type}async getSymbolMinTick(t){const e=await at(t);return(0,Q.Big)(e.minmov).div(e.pricescale).toNumber()}silentOrdersPlacement(){return(0,d.ensureNotNull)(this._trading).noConfirmEnabled}sellBuyButtonsVisibility(){return null!==this._trading&&o.enabled("buy_sell_buttons")?this._trading.showSellBuyButtons:null}domPanelVisibility(){return null!==this._trading?this._trading.domPanelVisibility():null}orderPanelVisibility(){return null!==this._trading?this._trading.orderPanelVisibility():null}showPricesWithZeroVolume(){return(0,d.ensureNotNull)(this._trading).showPricesWith().zeroVolume}showNotification(t,e,i=0){null!==this._trading&&(0===i?this._trading.showErrorNotification(t,e):this._trading.showSuccessNotification(t,e))}connectionStatusUpdate(t,e){this._adapter.connectionStatusUpdate.fire(t,e),1===t&&this._setDefaultDropdownActions()}orderUpdate(t){this._adapter.onOrderUpdate(t)}positionUpdate(t,e){this._adapter.onPositionUpdate(t,e)}tradeUpdate(t,e){this._adapter.onTradeUpdate(t,e)}orderPartialUpdate(t,e){this._adapter.onOrderPartialUpdate(t,e)}positionPartialUpdate(t,e){this._adapter.onPositionPartialUpdate(t,e)}tradePartialUpdate(t,e){this._adapter.onTradePartialUpdate(t,e)}executionUpdate(t){this._adapter.executionUpdate.fire(t)}currentAccountUpdate(){this._adapter.onCurrentAccountChanged()}realtimeUpdate(t,e){this._adapter.fireSubscription("Realtime",t,e)}domeUpdate(t,e){this._adapter.fireSubscription("DOME",t,e)}pipValueUpdate(t,e){this._adapter.fireSubscription("PipValue",t,e)}plUpdate(t,e){this._adapter.fireSubscription("PL",t,e)}tradePLUpdate(t,e){this._adapter.fireSubscription("TradePL",t,e)}equityUpdate(t){this._adapter.fireSubscription("Equity","Equity",t)}marginAvailableUpdate(t){this._adapter.fireSubscription("MarginAvailable","MarginAvailable",t)}cryptoBalanceUpdate(t,e){this._adapter.fireSubscription("CryptoBalance",t,e)}setButtonDropdownActions(t){var e;null!==this._trading&&this._defaultDropdownActions&&(this._defaultDropdownActions=!1,null===(e=this.sellBuyButtonsVisibility())||void 0===e||e.unsubscribe(this._setDefaultDropdownActionsBound),(0,d.ensureNotNull)(this.orderPanelVisibility()).unsubscribe(this._setDefaultDropdownActionsBound),(0,d.ensureNotNull)(this.domPanelVisibility()).unsubscribe(this._setDefaultDropdownActionsBound)),this._buttonDropdownActions=t}buttonDropdownActions(){return this._buttonDropdownActions}defaultContextMenuActions(...t){return null!==this._trading?this._trading.defaultContextMenuActions(...t):Promise.resolve([])}defaultDropdownMenuActions(t){
return null!==this._trading?this._trading.defaultDropdownMenuActions(t):[]}get factory(){return{createDelegate:()=>new(l()),createWatchedValue:t=>new(z())(t),createPriceFormatter:(t,e,i,s,r)=>new X.PriceFormatter(t,e,i,s,r)}}get settings(){return{save:(t,e)=>$().setJSON(`${this._metainfo.id}.${t}`,e),load:(t,e)=>$().getJSON(`${this._metainfo.id}.${t}`,e),clear:(t,e)=>$().remove(`${this._metainfo.id}.${t}`,e)}}get credentialsStorage(){return this._credentialsStorage}convertTimezone(t,e,i){const s=G.get_timezone(e),r=G.get_timezone(i),o=G.cal_to_utc(s,t);return G.utc_to_cal(r,o)}language(){return window.language}getUserSpecificHash(){return window.user.private_channel||""}activateFXCMCFD(){$().setValue("fxcm_cfd",!0)}async isFractional(t){return(await at(t)).fractional}_makeServerLoggerWithFilledInfo(t){return{log:e=>t.log({...this._makeServerLoggerEventAdditionalInfo(),...e}),debounceLog:(e,i,s)=>t.debounceLog({...this._makeServerLoggerEventAdditionalInfo(),...e},i,s)}}_makeServerLoggerEventAdditionalInfo(){return{accountType:this._adapter.currentAccountType(),brokerId:this._adapter.metainfo().id,sessionId:this._adapter.sessionId(),tvUsername:window.user.username,ref:location.href,online:navigator.onLine}}_setDefaultDropdownActions(){null!==this._trading&&this._defaultDropdownActions&&(this._buttonDropdownActions=this.defaultDropdownMenuActions())}}function at(t){return(0,Z.getQuoteSessionInstance)("full").snapshot(t)}var lt=i(337883);const dt=(0,u.getLogger)("Trading.EncryptedWebStorage");class ct{constructor({prefix:t,storageName:e,storage:i,cryptographer:s}){this._transientStorage={},this._handleStorageStateChange=t=>{const{key:e,storageArea:i}=t;i===this._persistentStorage&&this._storageName===e&&this._decryptStorage()},this._storageName=e,this._prefix=null==t?void 0:t.toLowerCase(),this._persistentStorage=i,this._cryptographer=s,this._decryptStorage=(0,lt.sequentialize)(this._decryptStorage),window.addEventListener("storage",this._handleStorageStateChange)}async setItem(t,e){const i=this._addPrefix(t);this._transientStorage[i]=JSON.stringify(e);try{await this._encryptStorageAndSave()}catch(t){dt.logError(`Unable to save value using key ${i}: ${(0,y.getLoggerMessage)(t)}`)}}getItem(t,e=null){const i=this._transientStorage[this._addPrefix(t)];if(void 0===i)return e;if("string"!=typeof i)return i;try{return JSON.parse(i)}catch(t){return i}}async removeItem(t){delete this._transientStorage[this._addPrefix(t)],await this._encryptStorageAndSave()}destroy(){window.removeEventListener("storage",this._handleStorageStateChange)}static async create(t,e,i,s){const r=new ct({prefix:t,storageName:e,storage:i,cryptographer:s});return await r._decryptStorage(),r}_addPrefix(t){return void 0!==this._prefix?`${this._prefix}.${t}`:t}async _decryptStorage(){const t=this._persistentStorage.getItem(this._storageName);if(null===t)return void(this._transientStorage={});const e=await this._cryptographer.decrypt(t);if(null===e)return this._persistentStorage.removeItem(this._storageName),void(this._transientStorage={});try{
this._transientStorage=JSON.parse(e)}catch(t){this._transientStorage={}}}async _encryptStorageAndSave(){const t=await this._cryptographer.encrypt(JSON.stringify(this._transientStorage));this._persistentStorage.setItem(this._storageName,t)}}const ut="credentials-storage";class ht{constructor(t,e,i){this._rememberCredentials=t,this._encryptedLocalStorage=e,this._encryptedSessionStorage=i}async save(t,e){this._currentEncryptedStorage().setItem(t,e)}load(t,e){return this._currentEncryptedStorage().getItem(t,e)}async clear(t){this._currentEncryptedStorage().removeItem(t)}destroy(){this._encryptedLocalStorage.destroy(),this._encryptedSessionStorage.destroy()}static async create(t,e,i){const s=await ct.create(t,ut,localStorage,i),r=await ct.create(t,ut,sessionStorage,i);return new ht(e,s,r)}_currentEncryptedStorage(){return this._rememberCredentials.value()?this._encryptedLocalStorage:this._encryptedSessionStorage}}var pt=i(698320),_t=i(458283);class gt{constructor(t){this._settingsKey=`trading.${t}.rememberCredentials`}value(){return $().getBool(this._settingsKey,!0)}setValue(t){$().setValue(this._settingsKey,t)}}const mt=[];function bt(t,e){t.configFlags=(0,_t.applyDefaultsToConfigFlags)(t.configFlags),mt.push({metainfo:t,createBrokerFunction:e})}function yt(){return mt.map((t=>t.metainfo))}let vt;async function ft(t,e,i,s,r){const o=mt.filter((t=>t.metainfo.id===e))[0];let n;if(null===s){const i=await ht.create(e,new gt(e),vt),s=r=>{(null==r?void 0:r.metainfo().id)!==e&&(null==t||t.onBrokerChange.unsubscribe(null,s),i.destroy())};null==t||t.onBrokerChange.subscribe(null,s),n=i}else n=s;const a=new nt(t,o.metainfo,i,n);try{const e=await o.createBrokerFunction(a,null==t?void 0:t.brokerTelemetry),i=new pt.BrokerRealtimeAdapter(o.metainfo.id);return new W({brokerMetainfo:o.metainfo,brokerConnection:e,host:a,brokerRealtimeAdapter:i,tradingStat:t&&t.tradingStat(),tradingSettingsStorageGetter:t&&t.getBrokerTradingSettingsStorage,brokerPlan:r})}catch(t){return Promise.reject(`${e} broker creation error: ${(0,y.getLoggerMessage)(t)}`)}}vt={encrypt:async t=>t,decrypt:async t=>t}},458283:(t,e,i)=>{"use strict";i.r(e),i.d(e,{defaultConfigFlags:()=>s,applyDefaultsToConfigFlags:()=>r});const s={isSuspended:!1,supportDemoLiveSwitcher:!0,supportModifyOrderPrice:!0,supportEditAmount:!0,supportModifyBrackets:!0,supportMarketBrackets:!0,supportMarketOrders:!0,supportStopOrders:!0,supportLimitOrders:!0,supportLeverageButton:!0,supportStopLimitOrders:!1,supportPositions:!0,supportDOM:!0,supportModifyTrailingStop:!0,supportAddBracketsToExistingOrder:!0,supportVerifyLiveAccount:!0,supportReversePosition:!0,showNotificationsLog:!0,supportPLUpdate:!0,supportTwoFactorAuthorization:!1,supportDisplayBrokerNameInSymbolSearch:!0,supportCurrencyInOrderPreview:!0,supportRiskControls:!0};function r(t){return Object.assign({},s,t)}},293274:(t,e,i)=>{"use strict";i.d(e,{DialogVisibility:()=>o});var s=i(947488),r=i(218286);class o{constructor(){this._value$=new s.BehaviorSubject({isVisible:!1}),this.value$=this._value$.asObservable().pipe((0,
r.distinctUntilChanged)(((t,e)=>t.isVisible===e.isVisible&&t.isFullScreen===e.isFullScreen)))}getValue(){return this._value$.getValue()}setValue(t){this._value$.next(t)}}},385146:(t,e,i)=>{"use strict";i.d(e,{DisabledConfirmations:()=>u});var s=i(870122),r=i.n(s),o=i(855385),n=i.n(o),a=i(128943);const l=/[0-9]+([\.,][0-9]+)*([\.,][0-9]+)?|\.[0-9]+/gm,d=/[A-Z]+/gm,c=a.settingsKeys.DISABLED_CONFIRMATIONS;class u{add(t){const e=this._getAll(),i=this._makeMessageHash(t);e.add(i),r().setJSON(c,Array.from(e))}has(t){const e=this._getAll(),i=this._makeMessageHash(t);return e.has(i)}clear(){r().remove(c)}_getAll(){return new Set(r().getJSON(c))}_makeMessageHash(t){const e=t.replace(l,"").replace(d,"");return i=n()(e),btoa(String.fromCharCode.apply(null,new Uint8Array(i)));var i}}},385249:(t,e,i)=>{"use strict";function s(t){return"string"==typeof t?t:Array.isArray(t)?t.join(""):void 0}i.d(e,{makeConfirmation:()=>s})},889384:(t,e,i)=>{"use strict";i.d(e,{showConfirmDialog:()=>n});var s=i(509806),r=i(385249),o=i(385146);async function n(t){const{title:e,content:n,mainButtonText:a,cancelButtonText:l,showDisableConfirmationsCheckbox:d,onOpen:c,onClose:u}=t,h=new o.DisabledConfirmations,p=(0,r.makeConfirmation)(n);if(d&&void 0!==p&&h.has(p))return!0;const{ConfirmDialogRenderer:_}=await Promise.all([i.e(4819),i.e(346),i.e(5761),i.e(8619),i.e(4884),i.e(1140),i.e(7177),i.e(6812),i.e(2754),i.e(1213),i.e(1309),i.e(994),i.e(3566)]).then(i.bind(i,742472)),g=new _(h),m={title:e,message:n,closeButton:null!=l?l:s.t(null,void 0,i(606255)),confirmButton:null!=a?a:s.t(null,void 0,i(879831)),showDisableConfirmationsCheckbox:d,onOpen:c,onClose:u};return(await g.open(m)).status}},278885:(t,e,i)=>{"use strict";i.d(e,{showSimpleConfirmDialog:()=>o});var s=i(159537),r=i(385146);async function o(t){const{showDisableConfirmationsCheckbox:e,text:o,onConfirm:n,onClose:a,onCancel:l,abortSignal:d}=t,c=new r.DisabledConfirmations;if(e&&c.has(o))return Promise.resolve(!0);if(null==d?void 0:d.aborted)return Promise.resolve(!1);const[{showSimpleDialog:u},{SimpleConfirmDialog:h}]=await Promise.all([Promise.all([i.e(4819),i.e(346),i.e(5761),i.e(8619),i.e(4884),i.e(1140),i.e(7177),i.e(6812),i.e(2754),i.e(1213),i.e(1309),i.e(994),i.e(3566)]).then(i.bind(i,480994)),Promise.all([i.e(4819),i.e(346),i.e(5761),i.e(8619),i.e(4884),i.e(1140),i.e(7177),i.e(6812),i.e(2754),i.e(1213),i.e(1309),i.e(994),i.e(3566)]).then(i.bind(i,443178))]);return new Promise(((e,i)=>{if(null==d?void 0:d.aborted)return void i((0,s.createAbortError)());const r=u({...t,disabledConfirmations:c,onConfirm:t=>{e(!0),void 0!==n&&n(),t.dialogClose()},onClose:()=>{e(!1),void 0!==a&&a()},onCancel:t=>{e(!1),void 0!==l&&l(t),t.dialogClose()}},h);null==d||d.addEventListener("abort",(()=>{r(),i((0,s.createAbortError)())}),{once:!0})}))}},844210:(t,e,i)=>{"use strict";i.d(e,{ConfirmBracketsCancelDialog:()=>o});var s=i(509806),r=i(278885);const o={get(){return this},open:t=>(0,r.showSimpleConfirmDialog)({title:s.t(null,void 0,i(232668)),text:s.t(null,void 0,i(289302)).replace("{orderId}",""!==t?t+" ":""),
mainButtonIntent:"primary"}),multiple:t=>(0,r.showSimpleConfirmDialog)({title:s.t(null,void 0,i(232668)),text:s.t(null,void 0,i(915610)).replace("{orderId}",""!==t?t+" ":""),mainButtonIntent:"primary"})}},30021:(t,e,i)=>{"use strict";i.d(e,{ConfirmOrderCancelDialog:()=>o});i(603605);var s=i(509806),r=i(278885);const o={get(){return this},open:t=>(0,r.showSimpleConfirmDialog)({title:s.t(null,void 0,i(709498)),text:s.t(null,void 0,i(438540)).replace("{orderId}",t),mainButtonIntent:"primary"}),multiple(t,e,o){let n=t;if(void 0!==e){n=`${n} ${1===e?s.t(null,void 0,i(864351)):s.t(null,void 0,i(807889))}`}return(0,r.showSimpleConfirmDialog)({title:s.t(null,void 0,i(709498)),text:s.t(null,void 0,i(109886)).replace("{qty}",String(o)).replace("{side}",n),mainButtonIntent:"primary"})}}},546563:(t,e,i)=>{"use strict";i.d(e,{reversePositionDialog:()=>o});var s=i(509806),r=i(278885);async function o(t,e,o,n){if(!await(0,r.showSimpleConfirmDialog)({title:s.t(null,void 0,i(172361)).replace("{positionId}",t),text:s.t(null,void 0,i(492698)).replace("{positionId}",t)+(n?" "+s.t(null,void 0,i(893827)):""),mainButtonText:s.t(null,void 0,i(920848)),mainButtonIntent:"primary",cancelButtonText:s.t(null,void 0,i(620036)),showBackdrop:!0}))return!1;try{return await o()}catch(t){return e(s.t(null,void 0,i(945593)),function(t){let e="";null!==t&&"object"==typeof t&&t.message?e=t.message:"string"==typeof t&&(e=t);return e}(t)),!1}}},860152:(t,e,i)=>{"use strict";i.d(e,{makeSubjectFromWatchedValue:()=>m,comparator:()=>b,shouldShowTotal:()=>y,displayedLeverage:()=>v,calculatePipValue:()=>f,calculateTradeValue:()=>k,calculateTradeValueByBigPointValue:()=>P,calculateUsedMargin:()=>S,calculatedMarginRatio:()=>C,formatInfoValue:()=>w,formatRiskReward:()=>T,alignQuotesToMinTick:()=>E,checkPriceByOrderType:()=>O,prepareCalculatorEventText:()=>D,i18nOrderResultText:()=>L,createCustomFieldModels:()=>A,prepareTradableSolution:()=>N,convertToBaseMonetaryUnit:()=>V,formatValue:()=>x});var s=i(509806),r=i(688401),o=i(947488),n=i(960521),a=i(922157),l=i.n(a),d=i(210596),c=i.n(d),u=i(486028),h=i(604406),p=i(609781),_=i(600297),g=i(79581);function m(t){const e=new o.BehaviorSubject(t.value()),i=t=>{e.next(t)};return t.subscribe(i),{subject:e,unsubscribe:()=>t.unsubscribe(i)}}function b(t,e){return(0,u.deepEquals)(t,e)[0]}function y(t){return void 0!==t&&Boolean(t.showTotal)}function v(t,e){if(void 0!==t)return t;if(void 0!==e){const t=Math.round(1/e);return String(t)+":1"}return null}function f(t,e,i){return null!==t?(void 0!==i?t*i:t)*e:0}function k(t,e,i,s,r){return P(t,e,i/s,r)}function P(t,e,i,s){return t*e*i*(s||1)}function S(t,e){return void 0!==e?t*e:0}function C(t,e){const i=0!==e?100*t/e:0;return i>100?100:i}function w(t){if("number"==typeof t){const e=(0,h.splitThousands)((t||0).toFixed(2)," ");return Number.isInteger(t)||t>=1?e:function(t){if(Number.isInteger(t))return t+"";return t<1?function(t){const e=(t+"").split(".")[1]||"";let i=e.length;for(let t=0;t<e.length;t++)if("0"!==e[t]){i=t+1;break}return t.toFixed(i)}(t):t.toFixed(2)}(t)}return(0,
h.splitThousands)(t," ")}const B=new p.VolumeFormatter(2);function T(t,e){return null!==t&&null!==e&&t/e>0?B.format(t/e):""}function E(t,e,i){const s=Object.assign({},t);return["trade","ask","bid"].forEach((t=>{const r=s[t];if(void 0!==r){const o=(0,g.getMinTick)({minTick:e,price:r,variableMinTickData:i});s[t]=function(t,e){return e>1?t:(0,n.Big)(t).div(e).round(0,1).mul(e).toNumber()}(r,o)}})),s}function O(t,e,i){return 4===t?null===e||null===i:3===t?null===i:null===e}function D(t,e){switch(e){case _.ButtonType.IncDec:return t<0?"-":"+";case _.ButtonType.PlusValue:return String(t);case _.ButtonType.Clear:return"Clear";default:return"Default"}}const I=" ",L={buy:{market:(t,e)=>s.t(null,void 0,i(447088)).format({qty:t,symbol:e,whitespaceNoBreak:I}),stop:(t,e,r)=>s.t(null,void 0,i(996188)).format({qty:t,symbol:e,stopPrice:r,whitespaceNoBreak:I}),limit:(t,e,r)=>s.t(null,void 0,i(227858)).format({qty:t,symbol:e,limitPrice:r,whitespaceNoBreak:I}),stopLimit:(t,e,r,o)=>s.t(null,void 0,i(409718)).format({qty:t,symbol:e,stopPrice:r,limitPrice:o,whitespaceNoBreak:I})},sell:{market:(t,e)=>s.t(null,void 0,i(575976)).format({qty:t,symbol:e,whitespaceNoBreak:I}),stop:(t,e,r)=>s.t(null,void 0,i(481577)).format({qty:t,symbol:e,stopPrice:r,whitespaceNoBreak:I}),limit:(t,e,r)=>s.t(null,void 0,i(55500)).format({qty:t,symbol:e,limitPrice:r,whitespaceNoBreak:I}),stopLimit:(t,e,r,o)=>s.t(null,void 0,i(530809)).format({qty:t,symbol:e,stopPrice:r,limitPrice:o,whitespaceNoBreak:I})}};function A(t,e,i,s,r){const o=[];return void 0!==s&&Array.isArray(s.customFields)&&s.customFields.forEach((s=>{if("TextWithCheckBox"===s.inputType&&o.push({id:s.id,type:s.inputType,inputType:s.customInfo.asterix?"password":"text",placeholder:s.placeHolder||"",title:s.title||"",checkboxTitle:s.customInfo.checkboxTitle,text:new(c())(s.value.text),checked:new(c())(s.value.checked),status:e,onControlFocused:new(l())}),"Checkbox"===s.inputType){let i;const n=null==r?void 0:r[s.id];try{i=JSON.parse(n)}catch(t){i=n}o.push({id:s.id,type:s.inputType,title:s.title,help:s.help,checked:new(c())(null!=i?i:s.value),status:e,onControlFocused:new(l()),disabled:t&&!s.supportModify,saveToSettings:s.saveToSettings})}if("ComboBox"===s.inputType&&Array.isArray(s.items)){let e=s.items[0];if(r&&s.id in r){const t=r[s.id],i=s.items.find((e=>e.value===t));void 0!==i&&(e=i)}else s.forceUserEnterInitialValue&&!t&&(e=void 0);o.push({id:s.id,type:s.inputType,title:s.title,items:s.preventModify&&t&&e?[e]:s.items,selectedItem:new(c())(null==e?void 0:e.value),onControlFocused:new(l()),saveToSettings:s.saveToSettings,isRequired:Boolean(s.forceUserEnterInitialValue),alwaysShowAttachedErrors:i})}})),o}async function N(t,e){if(void 0!==t.solutions){let o,n;if("changeSymbol"in t.solutions){const e=t.solutions.changeSymbol;o=s.t(null,void 0,i(562030)),n=()=>r.linking.symbol.setValue(e)}else{const r=t.solutions.changeAccount,a=(await e.accountsMetainfo()).filter((t=>t.id===r))[0].name;o=s.t(null,void 0,i(134542)).replace("{accountName}",a),n=()=>e.setCurrentAccount(r)}return{title:o,apply:n}}}
function V(t,e){return void 0===e?t:(0,n.Big)(t).div(e).toNumber()}function x(t,e){if(null===t)return null;const i=e.format(t);if(e.parse){const t=e.parse(i);if(t.res)return t.value}return parseFloat(i)}},549387:(t,e,i)=>{"use strict";var s,r;function o(t){return(null==t?void 0:t.type)===r.PlaceOrder}i.d(e,{PlaceOrEditContextStatus:()=>s,PlaceOrEditContextType:()=>r,isContextPlaceOrderContext:()=>o}),function(t){t[t.Undefined=0]="Undefined",t[t.Loading=1]="Loading",t[t.Error=2]="Error"}(s||(s={})),function(t){t[t.PlaceOrder=0]="PlaceOrder",t[t.EditOrder=1]="EditOrder",t[t.EditPosition=2]="EditPosition",t[t.EditTrade=3]="EditTrade"}(r||(r={}))},761139:(t,e,i)=>{"use strict";i.d(e,{isBracketOrderRawData:()=>h,cropOrderData:()=>_,OrdersService:()=>g});var s=i(650151),r=i(922157),o=i.n(r),n=i(486028),a=i(817808),l=i(535513),d=i(842974),c=i(852079);const u=(0,a.getLogger)("Trading.OrderService");function h(t){return"parentId"in t&&void 0!==t.parentId&&"parentType"in t&&void 0!==t.parentType}function p(t){return 1===t.type?(0,s.ensureDefined)(t.limitPrice):(0,s.ensureDefined)(t.stopPrice)}function _(t){return{id:t.id,parentId:t.parentId,parentType:t.parentType,symbol:t.symbol,type:t.type,side:t.side,avgPrice:t.avgPrice,limitPrice:t.limitPrice,stopPrice:t.stopPrice,price:t.price,stopLoss:t.stopLoss,trailingStopPips:t.trailingStopPips,stopType:t.stopType,takeProfit:t.takeProfit,status:t.status,qty:t.qty}}class g extends l.BrokerService{constructor(){super(...arguments),this._existingOrdersIds=new Set,this._activeOrders=new Map,this._activeOrderUpdate=new(o()),this._activeOrdersRemoved=new(o()),this._ordersRejected=new(o())}destroy(){this.stopService()}async getCurrency(){const t=(0,s.ensureNotNull)(this.activeBroker()),e=await t.accountMetainfo();return(0,d.getCurrency)(e,!0)||"USD"}orders(){return(0,s.ensureNotNull)(this.activeBroker()).orders()}find(t){return this._activeOrders.get(t)||null}activeOrders(){return Array.from(this._activeOrders.values())}activeOrdersUpdated(){return this._activeOrderUpdate}activeOrdersRemoved(){return this._activeOrdersRemoved}orderRejected(){return this._ordersRejected}stopService(){this._clearOrders();(0,s.ensureNotNull)(this.activeBroker()).orderUpdate.unsubscribeAll(this)}startService(){this._clearOrders(),this._requestOrders()}_clearOrders(){const t=Array.from(this._activeOrders.keys());this._activeOrders.clear(),this._existingOrdersIds.clear(),t.length>0&&u.logNormal(`All orders removed, id's: ${t}`),this._activeOrdersRemoved.fire(t)}async _requestOrders(){const t=this.activeBroker();if(!t)return;const e=await t.orders();for(const t of e)this._addActiveOrder(t);t.orderUpdate.unsubscribeAll(this),t.orderUpdate.subscribe(this,this._addActiveOrder)}_addActiveOrder(t){this._logOrderUpdate(t);const e=t.id,i=this._activeOrders.has(e),s=5===t.status,r=6!==t.status&&3!==t.status,o=2===t.type;if(i){if(r||o)return this._activeOrders.delete(e),void this._activeOrdersRemoved.fire([e])}else{if(o||r&&!s)return;if(s)return void this._ordersRejected.fire(p(t))}const n=this._getOrderData(t)
;this._activeOrders.set(e,n),this._activeOrderUpdate.fire(n)}_logOrderUpdate(t){const e=t.id;let i="update";this._existingOrdersIds.has(e)||(i="add",this._existingOrdersIds.add(e)),function(t,e){e(JSON.stringify(_(t)))}(t,(t=>{u.logNormal(`Order ${i}: ${t}`)}))}_getOrderData(t){const e=p(t);(0,n.isNumber)(e)||u.logError("order price is not defined");const i=(0,s.ensureNotNull)(this.activeBroker()).metainfo().configFlags,r=Boolean(i.supportOrderBrackets&&i.supportModifyBrackets&&i.supportAddBracketsToExistingOrder);return(0,n.merge)((0,n.clone)(t),{price:e,considerFilledQty:!0,supportModify:(0,d.isModifyOrderSupported)(t,i),supportMove:(0,d.isMoveOrderSupported)(t,i),supportCancel:!0,supportBrackets:r,supportModifyOrderPrice:Boolean(i.supportModifyOrderPrice),supportTrailingStop:r&&(0,c.checkTrailingStopAvailability)(i)})}}},129479:(t,e,i)=>{"use strict";i.d(e,{PositionsUpdateType:()=>u,cropPositionData:()=>h,PositionsService:()=>p});var s=i(650151),r=i(922157),o=i.n(r),n=i(486028),a=i(817808),l=i(535513),d=i(852079);const c=(0,a.getLogger)("Trading.PositionService");var u;function h(t){const e=t;return{id:e.id,symbol:e.symbol,side:e.side,avgPrice:e.avgPrice,pl:e.pl,price:e.price,qtyBySide:e.qtyBySide,stopType:e.stopType,takeProfit:e.takeProfit,stopLoss:e.stopLoss,trailingStopPips:e.trailingStopPips}}!function(t){t[t.Full=0]="Full",t[t.Partial=1]="Partial"}(u||(u={}));class p extends l.BrokerService{constructor(){super(...arguments),this._existingPositionIds=new Set,this._positions=new Map,this._positionUpdate=new(o()),this._positionsRemoved=new(o()),this._displayMode=1,this._updatePositionPLHandler=this._updatePositionPL.bind(this)}destroy(){this.stopService()}positions(){return Array.from(this._positions.values())}find(t){return this._positions.get(t)||null}async realIdFromBroker(t){const e=(0,s.ensureNotNull)(this.activeBroker());if(1===this._displayMode){const i=await e.positionById(t);if(void 0!==i)return i.id}else{const i=await e.tradeById(t);if(void 0!==i)return i.id}return null}positionUpdate(){return this._positionUpdate}positionsRemoved(){return this._positionsRemoved}isDisplayModeTrades(){return 0===this._displayMode}async getCurrency(t){return await(0,s.ensureNotNull)(this.activeBroker()).getPositionCurrency(t)||""}stopService(){this._clearPositions();const t=(0,s.ensureNotNull)(this.activeBroker());this.isDisplayModeTrades()?t.tradeUpdate.unsubscribeAll(this):t.positionUpdate.unsubscribeAll(this)}startService(){this._clearPositions(),this._displayMode=function(t){if(null===t)return 1;const e=t.metainfo().configFlags;return e.supportTrades?e.supportPositionBrackets?1:e.supportCloseTrade?0:1:1}(this.activeBroker()),this._requestPositions()}_clearPositions(){const t=(0,s.ensureNotNull)(this.activeBroker()),e=Array.from(this._positions.keys());for(const i of e)this.isDisplayModeTrades()?t.unsubscribeTradePL(i,this._updatePositionPLHandler):t.unsubscribePL(i,this._updatePositionPLHandler);this._positions.clear(),this._existingPositionIds.clear(),e.length>0&&c.logNormal(`All positions removed, id's: ${e}`),
this._positionsRemoved.fire(e)}async _requestPositions(){const t=this.activeBroker();if(!t)return;const e=this.isDisplayModeTrades(),i=await(e?t.trades():t.positions());for(const t of i)this._addPosition(t);e?t.tradeUpdate.subscribe(this,this._addPosition):t.positionUpdate.subscribe(this,this._addPosition)}_addPosition(t){const e=t.id,i=this._positions.has(e),r=(0,s.ensureNotNull)(this.activeBroker()),o=this.isDisplayModeTrades();if(!t.qty)return i&&(o?r.unsubscribeTradePL(e,this._updatePositionPLHandler):r.unsubscribePL(e,this._updatePositionPLHandler),this._positions.delete(e),this._positionsRemoved.fire([e])),void this._logPositionUpdate(t,!0);const n=this._getPositionData(t),a=this._updateType(n);this._logPositionUpdate(n,a===u.Full),this._positions.set(e,n),this._firePositionUpdate(n,a),i||(o?r.subscribeTradePL(e,this._updatePositionPLHandler):r.subscribePL(e,this._updatePositionPLHandler))}_updatePositionPL(t,e){const i=(0,s.ensureDefined)(this._positions.get(t));i.pl=(0,n.isNumber)(e)?e:null,i.profitState=(0,d.profitStateByPL)(e),this._firePositionUpdate(i,u.Partial)}_getPositionData(t){var e,i;const r=(0,s.ensureNotNull)(this.activeBroker()).metainfo().configFlags,o=this._positions.get(t.id),n=this.isDisplayModeTrades(),a=Boolean(n?r.supportTradeBrackets:r.supportPositionBrackets);let l,c="neutral",u=!1,h=null;if(n){const e=t;l=e.price,u=Boolean(e.canBeClosed)}else{const s=t;l=s.avgPrice,h=null!==(i=null!==(e=s.pl)&&void 0!==e?e:null==o?void 0:o.pl)&&void 0!==i?i:null,null!==h&&(c=(0,d.profitStateByPL)(h))}return{...t,pl:h,plBasedOnLast:r.calculatePLUsingLast||!1,price:Math.abs((0,s.ensureDefined)(l)),qtyBySide:Math.abs(t.qty)*(1===t.side?1:-1),profitState:c,supportClose:Boolean(n?r.supportCloseTrade&&u:r.supportClosePosition),supportReverse:Boolean(!n&&r.supportReversePosition),supportBrackets:a,supportOnlyPairBrackets:Boolean(r.supportOnlyPairPositionBrackets),supportTrailingStop:a&&(0,d.checkTrailingStopAvailability)(r)}}_firePositionUpdate(t,e){this._positionUpdate.fire({data:t,type:e})}_updateType(t){const e=this._positions.get(t.id);if(void 0===e)return u.Full;for(const i of Object.keys(e)){const s=i;if("pl"!==s&&"unrealizedPl"!==s&&e[s]!==t[s])return u.Full}return u.Partial}_logPositionUpdate(t,e){if(!e)return;const i=t.id;let s="update";this._existingPositionIds.has(i)||(s="add",this._existingPositionIds.add(i)),function(t,e){e(JSON.stringify(h(t)))}(t,(t=>{c.logNormal(`Position  ${s}: ${t}`)}))}}},852079:(t,e,i)=>{"use strict";i.d(e,{checkTrailingStopAvailability:()=>s,profitStateByPL:()=>r});function s(t){return Boolean(t.supportTrailingStop&&t.supportAddBracketsToExistingOrder&&t.supportModifyTrailingStop&&false)}function r(t){const e=null===t?0:Math.round(100*t)/100;return e>0?"positive":e<0?"negative":"neutral"}},550861:(t,e,i)=>{"use strict";i.r(e),i.d(e,{Trading:()=>ci,showSellBuyButtonsDefault:()=>di});var s=i(650151),r=i(509806),o=i(688401),n=i(870122),a=i(411589),l=i(69111),d=i(817808),c=i(210596),u=i.n(c),h=i(585161);const p=(0,d.getLogger)("Lib.Sound",{color:"#dea433"
}),_="notification/notification",g=[{title:r.t(null,void 0,i(792586)),path:"alert/alarm_clock",soundForAlerts:!0,filePath:h}];const m={};function b(){return g.filter((t=>!!t.soundForAlerts))}function y(t){if((0,l.isOnMobileAppPage)("any"))return;if(!t)return;if(!/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi/i.test(window.navigator.userAgent))return;if(Array.isArray(t)||(t=[t]),0===(t=t.filter((t=>{const e=v(t);return!(!e||!e.el.load||e._mobilePreloadActive)&&(e._mobilePreloadActive=!0,!0)}))).length)return void p.logNormal("enableForMobile no sounds passed");const e=()=>{const s=[];Array.isArray(t)&&t.forEach((t=>{const e=v(t);e.el.load();const i=e.play().catch((t=>{if("AbortError"!==t.name)throw p.logError(`enableForMobile for "${e.el.src}" preload error: - ${t.message}`),t}));e.el.pause(),s.push(i)})),Promise.all(s).then((()=>{p.logNormal("enableForMobile sounds initialized")})),i.forEach((t=>{document.removeEventListener(t,e,!0)}))},i=["click","touchend","keydown"];i.forEach((t=>{document.addEventListener(t,e,!0)}))}const v=t=>{if(t in m)return m[t];p.logNormal(`requested sound  ${t} not cached, building a new audio element`);const e=g.find((e=>e.path===t));if(void 0===e)throw new Error(`Cannot find sound "${t}"`);const i=new Audio(e.filePath),s={el:i,playing:new(u())(!1),play:(e=0)=>s.playing.value()?(p.logNormal("sound already playing"),Promise.reject("already playing")):(s.playing.setValue(!0),new Promise(((i,r)=>{let o=e>0;const n=()=>{const e=function(t){try{p.logNormal(`"${t.el.src}" triggering html5 play method, readyState - ${t.el.readyState}; muted - ${t.el.muted}; volume - ${t.el.volume}; currentTime - ${t.el.currentTime}`);let e=t.el.play();return e||(e=Promise.resolve()),e}catch(e){return p.logError(`play method for "${t.el.src}" catch error - ${e.message}`),Promise.reject(e)}}(s);e.catch((e=>{p.logNormal(`stop counting sound "${t}"; as playing due to an error: ${e.message}`),s.stop(),r(e)}))};s._onEnded=()=>{o?n():(s.stop(),i())},s.el.addEventListener("ended",s._onEnded),o&&setTimeout((()=>{p.logNormal(`"${t}" repeat timeout - ${e}s off`),o=!1}),1e3*e),n()}))),stop:()=>{s.el.pause(),s.playing.setValue(!1),s._onEnded&&s.el.removeEventListener("ended",s._onEnded)}};m[t]=s;return["canplaythrough","error"].forEach((e=>{i.addEventListener(e,(()=>{p.logNormal(`for sound "${t}", event - ${e} is fired`)}),!1)})),p.logNormal(`canPlayType - ${i.canPlayType("audio/mp3")}`),m[t]};y(g.filter((t=>!!t.common)).map((t=>t.path)));var f=i(947488),k=i(323002),P=i(997345),S=i(122621),C=i(842974),w=i(125361),B=i(79581),T=i(696546),E=i(21218),O=i(337883),D=i(484727),I=i(212775),L=i(96401),A=i(922157),N=i.n(A),V=i(577535);i(153055);var x=i(293274),M=i(649990),R=i(128943),q=i(698320),F=i(510986);const U=(0,d.getLogger)("Trading.RealtimeProvider");class W{constructor(t){this._results={},this._getter=t}get(t){return this._results[t]||(this._results[t]=this._getter(t)),this._results[t]}}class Q{constructor(t,e,i,s,r){this._stopped=!1,this._subscribed=!1,this._provider=null,this._formatters=null,this._symbol=t,
this._type=r,this._callback=e,this._providersCache=i,this._formattersCache=s,"Realtime"===this._type?this._handler=(t,i)=>{this._stopped||e(t,i,this._formatters)}:this._handler=(t,i)=>{this._stopped||e(t,i)},this._start().catch((t=>{}))}symbol(){return this._symbol}type(){return this._type}callback(){return this._callback}destroy(){this._ensureNotStopped(),this._subscribed&&("Realtime"===this._type?(0,s.ensureNotNull)(this._provider).unsubscribeRealtime(this._symbol,this._handler):(0,s.ensureNotNull)(this._provider).unsubscribeDOME(this._symbol,this._handler)),this._stopped=!0}async _start(){this._provider=await this._providersCache.get(this._symbol),this._ensureNotStopped(),this._formatters=await this._formattersCache.get(this._symbol),(0,s.ensure)(this._formatters),this._ensureNotStopped(),this._subscribed=!0,"Realtime"===this._type?this._provider.subscribeRealtime(this._symbol,this._handler):this._provider.subscribeDOME(this._symbol,this._handler)}_ensureNotStopped(){(0,s.assert)(!this._stopped,"Should not be stopped")}}class H{constructor(t,e,i){this.onStatusChanged=new(N()),this._subscriptions=[],this._currentBroker=null,this._activeBrokerGetter=t,e.subscribe(this,this._connectionStatusChanged),i.subscribe(this,this._connectionStatusChanged),this._tvProvider=new q.BrokerRealtimeAdapter("RealtimeProvider"),this._connectionStatusChanged()}isTradable(t){return this._tradableCache.get(t)}subscribeRealtime(t,e){this._subscriptions.some((i=>i.symbol()===t&&i.callback()===e&&"Realtime"===i.type()))||this._subscriptions.push(new Q(t,e,this._providersCache,this._formattersCache,"Realtime"))}unsubscribeRealtime(t,e){const i=this._subscriptions.findIndex((i=>i.symbol()===t&&i.callback()===e&&"Realtime"===i.type()));if(-1===i)return;this._subscriptions[i].destroy(),this._subscriptions.splice(i,1)}subscribeDOME(t,e){this._subscriptions.some((i=>i.symbol()===t&&i.callback()===e&&"Dome"===i.type()))||this._subscriptions.push(new Q(t,e,this._providersCache,this._formattersCache,"Dome"))}unsubscribeDOME(t,e){const i=this._subscriptions.findIndex((i=>i.symbol()===t&&i.callback()===e&&"Dome"===i.type()));if(-1===i)return void U.logWarn("Subscription not found");this._subscriptions[i].destroy(),this._subscriptions.splice(i,1)}formatter(t){return this._formattersCache.get(t).then((t=>t.formatter))}spreadFormatter(t){return this._formattersCache.get(t).then((t=>t.spreadFormatter))}quantityFormatter(t){return this._formattersCache.get(t).then((t=>t.quantityFormatter))}symbolInfo(t){if(!t){const t={minTick:NaN,qty:{min:NaN,max:NaN,step:NaN},pipValue:NaN,pipSize:NaN,description:"no symbol"};return Promise.resolve(t)}return this._providersCache.get(t).then((e=>e!==this._tvProvider?e.symbolInfo(t).then((e=>e||this._tvProvider.symbolInfo(t))).catch((e=>this._tvProvider.symbolInfo(t))):this._tvProvider.symbolInfo(t)))}quotesSnapshot(t){return this._providersCache.get(t).then((e=>e.quotesSnapshot(t)))}activeBroker(){return null!==this._currentBroker&&this._currentBroker!==this._tvProvider?this._currentBroker:null}_isTradable(t){
if(null===this._currentBroker||this._currentBroker===this._tvProvider)return Promise.resolve({tradable:!1});try{return(0,F.makeTimeLimited)(this._currentBroker.isTradable(t),6e4,"isTradable Promise Timeout").catch((()=>Promise.resolve({tradable:!1})))}catch(t){return Promise.resolve({tradable:!1})}}_haveRealtime(t){return this._tradableCache.get(t)||Promise.resolve(null===this._currentBroker)}_connectionStatusChanged(){const t=this._activeBrokerGetter(),e=this._currentBroker,i=t&&1===t.connectionStatus()?t:null;if(this._createCaches(),e!==i){const t=this._subscriptions.map((t=>({symbol:t.symbol(),callback:t.callback(),type:t.type()})));this._unsubscribeAll(),this._currentBroker=i,this._subscribeAll(t),this.onStatusChanged.fire()}}_createCaches(){this._providersCache=new W((t=>this._provider(t))),this._tradableCache=new W((t=>this._isTradable(t))),this._formattersCache=new W((t=>this._providersCache.get(t).then((e=>Promise.all([e.formatter(t,!1),e.spreadFormatter(t),e.quantityFormatter(t)]))).then((([t,e,i])=>({formatter:t,spreadFormatter:e,quantityFormatter:i})))))}_provider(t){return this._haveRealtime(t).then((t=>t.tradable&&this._currentBroker&&1===this._currentBroker.connectionStatus()?this._currentBroker:this._tvProvider))}_unsubscribeAll(){this._subscriptions.forEach((t=>{t.destroy()})),this._subscriptions=[]}_subscribeAll(t){t.forEach((t=>{this._subscriptions.push(new Q(t.symbol,t.callback,this._providersCache,this._formattersCache,t.type))}))}}var $=i(535513);class j extends $.BrokerService{constructor(t){super(t),this._userId=(window.user.id||"").toString(),window.loginStateChange&&window.loginStateChange.subscribe(this,this._onLoginStateChange)}trackOrderPlaced(t){this._trackOrderEvent("Placed",t)}startService(){(0,s.ensure)(this.activeBroker()).orderUpdate.subscribe(this,this._orderUpdate),this._trackTradingBrokerConnnected()}stopService(){(0,s.ensure)(this.activeBroker()).orderUpdate.unsubscribe(this,this._orderUpdate)}_orderUpdate(t,e){e||(5===t.status?this._trackOrderEvent("Rejected",t):2===t.status?this._trackOrderEvent("Executed",t):1===t.status&&this._trackOrderEvent("Canceled",t))}_trackOrderEvent(t,e){const i=this.activeBroker();if(e&&i){const s=e.id||null;i.symbolInfo(e.symbol).then((i=>{const r={amount:e.qty*(i.lotSize||1),orderId:s,instrumentType:i.type,eventName:"Order "+t,userId:this._userId,symbol:e.symbol};this._trackTradingOrder(r)}))}}_trackTradingOrder(t){const e=this.activeBroker();if(!e)throw new Error("no active broker")}_trackTradingBrokerConnnected(){const t=this.activeBroker();null!==t&&t.metainfo().id;if(!t)throw new Error("no active broker")}_onLoginStateChange(){this._userId=(window.user.id||"").toString()}}var z=i(32133),G=i(863697),K=i(106056);function J(t="default"){switch(t){case"danger":return G.ToastIntent.Danger;case"attention":return G.ToastIntent.Warning;case"success":return G.ToastIntent.Success;default:return G.ToastIntent.Default}}class Z{constructor(t){this._chartWidgetCollection=t}proSymbol(){return o.linking.proSymbol.value()}showTradingProperties(){
this._chartWidgetCollection.activeChartWidget.value().showGeneralChartProperties(V.TabNames.trading)}async closeAllNotifications(){const t=await this._chartWidgetCollection.getToasts();null!==t&&t.reset()}async showNotification(t,e,i,s){const r=await this._chartWidgetCollection.getToasts();if(null===r)return;let o="";"string"==typeof e&&(o=e),r.showSimpleToast({text:o,time:s,title:t,intent:J(i),priority:K.ToastPriority.Low})}showMaintenance(t){0}showBrokerSideMaintenance(t){0}trackEvent(t,e,i){(0,z.trackEvent)(t,e,i)}showReplayConfirmationDialog(){return Promise.resolve()}reconnectChartApi(t){0}setBroker(t){const e=(null==t?void 0:t.metainfo().backendBrokerName)||(null==t?void 0:t.metainfo().id.toLowerCase())||"";this._chartWidgetCollection.setBroker(e)}}var X=i(971204),Y=(i(603605),i(889384));async function tt(t){const{showErrorNotification:e,handler:s,message:o,onOpen:n,onClose:a}=t;if(!await(0,Y.showConfirmDialog)({title:r.t(null,void 0,i(424356)),content:o,mainButtonText:r.t(null,void 0,i(424356)),cancelButtonText:r.t(null,void 0,i(620036)),onOpen:n,onClose:a}))return!1;try{return await s()}catch(t){return e(r.t(null,void 0,i(791401)),function(t){let e="";null!==t&&"object"==typeof t&&t.message?e=t.message:"string"==typeof t&&(e=t);return e}(t)),!1}}var et=i(546563),it=i(30021),st=i(844210);i(651049),i(702054),i(860152),i(627687),i(816105);async function rt(t,e,s){const o=await async function(t){const{PartiallyClosingDialogRenderer:e}=await i.e(3168).then(i.bind(i,92657)),s=new e;return new Promise((e=>{s.open({...t,dialogActionHandler:e})}))}(t);if(!o.status)return!1;try{return await e(o.qty)}catch(t){return s(r.t(null,void 0,i(791401)),function(t){let e="";null!==t&&"object"==typeof t&&t.message?e=t.message:"string"==typeof t&&(e=t);return e}(t)),!1}}var ot=i(278885);const nt={async show(t){const e=r.t(null,{replace:{symbol:t}},i(97929)),s=r.t(null,{replace:{symbol:t}},i(469497));return(0,ot.showSimpleConfirmDialog)({title:s,text:e})}},at={async show(t){const e=r.t(null,{replace:{symbol:t}},i(965603)),s=r.t(null,{replace:{symbol:t}},i(447600));return(0,ot.showSimpleConfirmDialog)({title:s,text:e})}};var lt=i(50959),dt=i(604406);function ct(t){const{symbol:e,side:s,qty:o,price:n,id:a,closePositionCancelsOrders:l}=t,d=(0,dt.splitThousands)(o," "),c=(0,dt.splitThousands)(n," ");return lt.createElement(lt.Fragment,null,lt.createElement("div",null,void 0!==a?r.t(null,void 0,i(170392)).replace("{id}",a):r.t(null,void 0,i(381617))),lt.createElement("div",null,lt.createElement("b",null,e)),lt.createElement("div",null,lt.createElement("b",null,`${s} ${d} @ ${c}`)),lt.createElement("div",null,l&&` ${r.t(null,void 0,i(218329))}`))}var ut=i(52346);const ht=(0,d.getLogger)("Trading.BrokerCommandsUI"),pt={symbol:1,qty:1,side:1,type:1,seenPrice:1};class _t{constructor(t,e,i,s,r,o){this._closePositionDialogVisibility=new x.DialogVisibility,this._isClosePositionDialogLoading=!1,this._isCloseTradeDialogLoading=!1,this._onClosePositionDialogOpen=t=>{this._closePositionDialogVisibility.setValue({isVisible:!0,isFullScreen:t})},
this._onClosePositionDialogClose=()=>{this._closePositionDialogVisibility.setValue({isVisible:!1})},this._activeBroker=t,this._guiAccessor=e,this._orderViewController=s,this._showErrorNotification=r,this._noConfirmEnabled=i,this._trackEvent=o,this.closePositionDialogVisibility=this._closePositionDialogVisibility.value$}async placeOrder(t,e,i){const s=e&&this._noConfirmEnabled.value(),r=this._guiAccessor&&s?this._guiAccessor.showReplayConfirmationDialog():Promise.resolve(!1);try{await r}catch(t){Promise.resolve(!1)}const o=await this._activeBroker.isTradable(t.symbol);if(s&&o.tradable&&function(t){for(const e in pt)if(!(e in t))return!1;return!0}(t)){false;const e=await this._activeBroker.createInitialPreOrder(t);return this._activeBroker.placeOrder(e)}{const e=this._activeBroker.metainfo();if(e.customUI&&void 0!==e.customUI.showOrderDialog)return e.customUI.showOrderDialog(t)}return this._orderViewController().then((e=>this._activeBroker?e.showOrderView({order:t,focus:void 0,forceOrderDialog:i}):Promise.reject("Broker connection adapter is null")))}async modifyOrder(t,e,i,s){return e&&this._noConfirmEnabled.value()&&t.parentType,this._modifyOrder(t,e,i,s)}async closePosition(t){var e,i;if(this._makeSureBrokerIsConnected(),this._isClosePositionDialogLoading)return!1;let s,r;this._isClosePositionDialogLoading=!0;try{if(s=await this._activeBroker.positionById(t),void 0===s)return!1;const{tradable:e}=await this._activeBroker.isTradable(s.symbol);if(await this._assertPositionExistsAndNotClosed(s.id),!e)return this._closePositionForNonTradableSymbol(s);if(this._noConfirmEnabled.value())return this._activeBroker.closePosition(t);r=await this._obtainPositionClosingData(s)}finally{this._isClosePositionDialogLoading=!1}if(void 0===r)return!1;const{supportPartialClosePosition:o,...n}=r,a=this._activeBroker.metainfo();if(void 0!==(null===(e=a.customUI)||void 0===e?void 0:e.showClosePositionDialog))return null===(i=a.customUI)||void 0===i?void 0:i.showClosePositionDialog(s);if(o){const e=e=>(e!==(null==s?void 0:s.qty)?this._trackEvent("","Close Position Dialog","partial"):this._trackEvent("","Close Position Dialog","full"),this._activeBroker.closePosition(t,e));return rt({...n,positionOrTrade:s,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose},e,this._showErrorNotification)}{const e=()=>this._activeBroker.closePosition(t);return tt({showErrorNotification:this._showErrorNotification,handler:e,message:r.message,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose})}}async closeTrade(t){if(this._makeSureBrokerIsConnected(),(0,s.assert)(!!this._activeBroker.config.supportTrades,"Broker doesn`t support trades"),this._noConfirmEnabled.value())return this._activeBroker.closeTrade(t);{if(this._isCloseTradeDialogLoading)return!1;const e=await this._obtainTradeClosingData(t);if(void 0===e)return!1;const{supportPartialCloseTrade:i,trade:s,...r}=e;if(i){const e=async e=>(e!==s.qty?this._trackEvent("","Close Trade Dialog","partial"):this._trackEvent("","Close Trade Dialog","full"),
this._activeBroker.closeTrade(t,e));return rt({...r,positionOrTrade:s,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose},e,this._showErrorNotification)}return tt({showErrorNotification:this._showErrorNotification,handler:()=>this._activeBroker.closeTrade(t),message:e.message,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose})}}editPositionBrackets(t,e,i,r){return this._makeSureBrokerIsConnected(),(0,s.assert)(!!this._activeBroker.config.supportPositionBrackets,"Broker doesn`t support brackets on positions"),r&&this._noConfirmEnabled.value()?this._activeBroker.editPositionBrackets(t,null!=e?e:{}):this._activeBroker.positionById(t).then((t=>this._activeBroker?this._showPositionDialog((0,s.ensureDefined)(t),e,i):Promise.reject("Broker connection adapter is null")))}editTradeBrackets(t,e,i,r){return r&&this._noConfirmEnabled.value()?this._activeBroker.editTradeBrackets(t,null!=e?e:{}):this._activeBroker.tradeById(t).then((t=>this._activeBroker?this._showTradeDialog((0,s.ensureDefined)(t),e,i):Promise.reject("Broker connection adapter is null")))}reversePosition(t){return this._makeSureBrokerIsConnected(),this._activeBroker.metainfo().configFlags.supportMultiposition&&!this._activeBroker.config.supportNativeReversePosition?Promise.reject("Cannot reverse position on multiposition acount"):this._noConfirmEnabled.value()?this._activeBroker.reversePosition(t):this._activeBroker.positionById(t).then((e=>{if(!this._activeBroker)return Promise.reject("Broker connection adapter is null");const i=this._activeBroker.reversePosition.bind(this._activeBroker,t);return(0,et.reversePositionDialog)(t,this._showErrorNotification,i,this._activeBroker.config.closePositionCancelsOrders)}))}async cancelOrder(t){var e,i;this._makeSureBrokerIsConnected();const s=await this._activeBroker.orderById(t);if(void 0===s)return Promise.reject("Failed to find order");const{tradable:r}=await this._activeBroker.isTradable(s.symbol);if(await this._assertOrderExistsAndNotCanceled(s.id),!r)return this._cancelOrderForNonTradableSymbol(s.symbol,s.id);if(this._noConfirmEnabled.value())return this._activeBroker.cancelOrder(t);{const r=this._activeBroker.cancelOrder.bind(this._activeBroker,t),o=this._activeBroker.metainfo();if(void 0!==(null===(e=o.customUI)||void 0===e?void 0:e.showCancelOrderDialog))return null===(i=o.customUI)||void 0===i?void 0:i.showCancelOrderDialog(s);if(s.parentId){const t=(await this._activeBroker.orders()).filter((t=>t.refNumber===s.refNumber));return o.configFlags.supportCancellingBothBracketsOnly&&t.length>1?this._showCancelMultipleBracketsDialog(s.parentId,r):this._showCancelBracketsDialog(s.id,r)}return this._showCancelOrderDialog(s.id,r)}}cancelOrders(t,e){return this._makeSureBrokerIsConnected(),this._activeBroker.orders().then((i=>{if(!this._activeBroker)return Promise.reject("Broker connection adapter is null");const s=i.filter((i=>i.symbol===t&&(!e||i.side===e)&&function(t){return 4===t.status||3===t.status||6===t.status}(i)));if(!s.length)return Promise.resolve(!1)
;if(1===s.length)return this.cancelOrder(s[0].id);const r=s.map((t=>t.id));if(this._noConfirmEnabled.value())return this._activeBroker.cancelOrders(t,e,r);{const i=this._activeBroker.cancelOrders.bind(this._activeBroker);return this._showCancelMultipleOrdersDialog(t,e,r,i)}}))}async _modifyOrder(t,e,s,o){const n=this._activeBroker.metainfo();if(!n.configFlags.supportModifyTrailingStop){const e=(await this._activeBroker.orders()).find((e=>e.id===t.id));void 0!==e&&void 0!==e.trailingStopPips?t.hasTrailingStopBracket=!0:t.hasTrailingStopBracket=!1}if(this._makeSureBrokerIsConnected(),t.flags&&t.flags.trailingStop)return ht.logError("Attempt to modify trailing stop loss order"+t.id),this._showErrorNotification(r.t(null,void 0,i(292559)),r.t(null,void 0,i(507214))),Promise.resolve(!1);const a=await this._activeBroker.symbolInfo(t.symbol);t.limitPrice=void 0!==a.limitPriceStep&&void 0!==t.limitPrice?(0,T.roundToStepByPriceTypeAndSide)(t.limitPrice,a.limitPriceStep,1,t.side):t.limitPrice,t.stopPrice=void 0!==a.stopPriceStep&&void 0!==t.stopPrice?(0,T.roundToStepByPriceTypeAndSide)(t.stopPrice,a.stopPriceStep,2,t.side):t.stopPrice;const l=t.limitPrice,d=t.stopPrice,c=t.stopType,u=e&&this._noConfirmEnabled.value();let h=s||(1===t.type?1:2);if(t.parentId&&!D.enabled("always_pass_called_order_to_modify")){let e,i=this._activeBroker.orderById.bind(this._activeBroker);2===t.parentType&&(i=this._activeBroker.positionById.bind(this._activeBroker)),3===t.parentType&&(i=this._activeBroker.tradeById.bind(this._activeBroker));try{e=await i(t.parentId)}catch(t){e=void 0}if(e){h=s||(1===t.type?3:4);const i={takeProfit:l};if(c===X.StopType.TrailingStop?i.trailingStopPips=t.trailingStopPips:i.stopLoss=d,u&&(i.takeProfit=i.takeProfit||e.takeProfit,i.stopLoss=i.stopLoss||e.stopLoss,i.trailingStopPips=i.trailingStopPips||e.trailingStopPips),3===t.parentType)return u?this._activeBroker.editTradeBrackets(e.id,i):this._showTradeDialog(e,i,h);if(2===t.parentType&&t.qty===Math.abs(e.qty))return u?this._activeBroker.editPositionBrackets(e.id,i):this._showPositionDialog(e,i,h);const r=e;(0,C.isOrderActive)(r.status)&&(t=Object.assign({},r),l&&(t.takeProfit=l),d&&(c===X.StopType.TrailingStop?t.trailingStopPips=i.trailingStopPips||t.trailingStopPips:t.stopLoss=d))}}return u?this._activeBroker.modifyOrder(t):n.customUI&&void 0!==n.customUI.showOrderDialog?n.customUI.showOrderDialog(t,h):this._orderViewController().then((e=>this._activeBroker?e.showOrderView({order:t,focus:h,forceOrderDialog:o}):Promise.reject("Broker connection adapter is null")))}_makeSureBrokerIsConnected(){(0,s.assert)(1===this._activeBroker.connectionStatus(),"Broker is not connected")}async _showPositionDialog(t,e={},s){const o=await this._activeBroker.isTradable(t.symbol);if(!o.tradable){const e=void 0!==o.reason?o.reason:(0,T.makeNonTradableSymbolText)(t.symbol,this._activeBroker.metainfo().title);return this._showErrorNotification(r.t(null,void 0,i(326704)),e),Promise.resolve(!1)}{const i=this._activeBroker.metainfo()
;if(i.customUI&&void 0!==i.customUI.showPositionDialog)return i.customUI.showPositionDialog(t,{stopLoss:e.stopLoss||t.stopLoss,takeProfit:e.takeProfit||t.takeProfit},s)}return this._orderViewController().then((i=>this._activeBroker?i.showPositionView(t,{stopLoss:e.stopLoss,takeProfit:e.takeProfit,trailingStopPips:e.trailingStopPips},s||t.limitPrice&&3||t.stopPrice&&4):Promise.reject("Broker connection adapter is null")))}_showTradeDialog(t,e={},i){{const s=this._activeBroker.metainfo();if(s.customUI&&void 0!==s.customUI.showPositionDialog)return s.customUI.showPositionDialog(t,{stopLoss:e.stopLoss||t.stopLoss,takeProfit:e.takeProfit||t.takeProfit},i)}return this._orderViewController().then((s=>this._activeBroker?s.showTradeView(t,{stopLoss:e.stopLoss,takeProfit:e.takeProfit,trailingStopPips:e.trailingStopPips},i||t.limitPrice&&3||t.stopPrice&&4):Promise.reject("Broker connection adapter is null")))}_isMaintenance(){return isFeatureEnabled((0,C.makeMaintananceFeatureToggleName)(this._activeBroker.metainfo().id))}_isBrokerSideMaintenance(){return isFeatureEnabled((0,C.makeBrokerSideMaintananceFeatureToggleName)(this._activeBroker.metainfo().id))}_showCancelOrderDialog(t,e){return it.ConfirmOrderCancelDialog.get().open(t).then((i=>i?e(t):Promise.resolve(!1)))}_showCancelMultipleOrdersDialog(t,e,i,s){const r=i.length;return it.ConfirmOrderCancelDialog.get().multiple(t,e,r).then((r=>r?s(t,e,i):Promise.resolve(!1)))}async _showCancelBracketsDialog(t,e){return st.ConfirmBracketsCancelDialog.get().open(t).then((i=>i?e(t):Promise.resolve(!1)))}_showCancelMultipleBracketsDialog(t,e){return st.ConfirmBracketsCancelDialog.get().multiple(t).then((i=>i?e(t):Promise.resolve(!1)))}async _obtainPositionClosingData(t){try{const{supportLots:e,qtyStep:s,uiQtyStep:o,minQty:n,qtyFormatter:a,priceFormatter:l}=await this._obtainPositionOrTradeClosingCommonData(t),d=this._activeBroker.metainfo().configFlags.supportPartialClosePosition,c=ct({symbol:t.symbol,side:1===t.side?r.t(null,void 0,i(273064)):r.t(null,void 0,i(777851)),qty:a.format(t.qty),price:l.format(t.avgPrice),closePositionCancelsOrders:this._activeBroker.config.closePositionCancelsOrders});return{position:t,supportLots:e,qtyStep:s,uiQtyStep:o,minQty:n,supportPartialClosePosition:d,qtyFormatter:a,message:c}}catch(t){return}}async _obtainTradeClosingData(t){try{this._isCloseTradeDialogLoading=!0;const e=(0,s.ensureDefined)(await this._activeBroker.tradeById(t)),{supportLots:o,qtyStep:n,uiQtyStep:a,minQty:l,qtyFormatter:d,priceFormatter:c}=await this._obtainPositionOrTradeClosingCommonData(e),u=this._activeBroker.metainfo().configFlags.supportPartialCloseTrade,h=ct({symbol:e.symbol,side:1===e.side?r.t(null,void 0,i(273064)):r.t(null,void 0,i(777851)),qty:d.format(e.qty),price:c.format(e.price),id:t,closePositionCancelsOrders:this._activeBroker.config.closePositionCancelsOrders});return this._isCloseTradeDialogLoading=!1,{trade:e,supportLots:o,qtyStep:n,uiQtyStep:a,minQty:l,supportPartialCloseTrade:u,qtyFormatter:d,message:h}}catch(t){return void(this._isCloseTradeDialogLoading=!1)}}
async _obtainPositionOrTradeClosingCommonData(t){const e=await this._activeBroker.symbolInfo(t.symbol);return{supportLots:void 0!==e.lotSize,qtyStep:e.qty.step,uiQtyStep:e.qty.uiStep,minQty:e.qty.min,qtyFormatter:await this._activeBroker.quantityFormatter(t.symbol),priceFormatter:await this._activeBroker.formatter(t.symbol,!1)}}async _closePositionForNonTradableSymbol(t){const{supportClosePositionForNonTradableSymbol:e,supportClosePosition:s}=this._activeBroker.metainfo().configFlags;if(!e||!s){const e=r.t(null,{replace:{symbol:t.symbol}},i(946305));return this._showErrorNotification(e,r.t(null,void 0,i(348434))),!1}return!!await nt.show(t.symbol)&&this._activeBroker.closePosition(t.id)}async _cancelOrderForNonTradableSymbol(t,e){if(!this._activeBroker.metainfo().configFlags.supportCancelOrderForNonTradableSymbol){const e=r.t(null,{replace:{symbol:t}},i(993545));return this._showErrorNotification(e,r.t(null,void 0,i(30665))),!1}return!!await at.show(t)&&this._activeBroker.cancelOrder(e)}async _assertPositionExistsAndNotClosed(t){const e=await this._activeBroker.positionById(t);if(void 0===e||0===e.qty)throw new ut.UserFriendlyError({userFriendlyMessage:r.t(null,{replace:{positionId:t}},i(969233)),detailedErrorMessage:`Position ${t} doesn't exist or has already been closed`})}async _assertOrderExistsAndNotCanceled(t){const e=await this._activeBroker.orderById(t);if(void 0===e||1===e.status)throw new ut.UserFriendlyError({userFriendlyMessage:r.t(null,{replace:{orderId:t}},i(579287)),detailedErrorMessage:`Order ${t} doesn't exist or has already been canceled`})}}class gt{constructor(t,e,i,s){this._domePanel=null,this._resizerBridge=t,this._trading=i,this._qtySuggester=s,this._close=()=>{this.unmount(),e()}}mount(){return this._getDomPanel().then((t=>{t.setVisibility(!0)}))}unmount(){this._getDomPanel().then((t=>{t.setVisibility(!1)}))}async _getDomPanel(){if(null!==this._domePanel)return this._domePanel;const{DomePanel:t}=await Promise.all([i.e(2952),i.e(9673),i.e(7624),i.e(9333),i.e(4819),i.e(6092),i.e(346),i.e(8825),i.e(5761),i.e(8619),i.e(4884),i.e(105),i.e(3287),i.e(1282),i.e(3578),i.e(8819),i.e(2405),i.e(8671),i.e(9437),i.e(1448),i.e(7953),i.e(9402),i.e(1799),i.e(7125),i.e(4104),i.e(7638),i.e(7780),i.e(6256),i.e(7636)]).then(i.bind(i,616090)),e=this._domePanel=new t(this._trading,this._resizerBridge,this._qtySuggester);return e.setCloseHandler(this._close),e}}class mt{mount(){return Promise.resolve()}unmount(){}}var bt=i(991429),yt=i(392612);const vt=D.enabled("show_order_panel_on_start");class ft{constructor(t){this.isOpened=new(u())(!1),this.isVisible=new(u())(!1),this.activePage=new(u())(vt?bt.TradingPage.OrderPanel:bt.TradingPage.DomPanel),this.isLoading=new(u())(!1),this._pages={},this._width=bt.panelWidth,this.setPage=t=>{this.isOpened.value()&&this.activePage.value()!==t&&this._pages[this.activePage.value()]&&this._pages[this.activePage.value()].unmount(),this.activePage.setValue(t),n.setValue(R.settingsKeys.TRADING_PANEL_ACTIVE_PAGE,t)},this.openPage=t=>{this.setPage(t),this.open()},this.open=()=>{
this._pages[this.activePage.value()]&&(this._togglePanel(!0),this.isOpened.setValue(!0),this._pages[this.activePage.value()].mount())},this.close=()=>{this.isOpened.setValue(!1),this._pages[this.activePage.value()]&&this._pages[this.activePage.value()].unmount(),this._togglePanel(!1)},this._onLayoutResizeHandleMousedown=t=>{if(t.defaultPrevented||!t.cancelable)return;t.preventDefault();const e=Math.max(this._resizerBridge.width.value(),0);let i;i="touches"in t?t.touches[0].clientX:t.clientX;const s=t=>{let s;t.preventDefault(),s="touches"in t?t.touches[0].clientX:t.clientX;let r=e-(s-i);r<bt.panelWidth?r=bt.panelWidth:r>bt.maxPanelWidth&&(r=bt.maxPanelWidth),this._requestWidth(r)},r=()=>{document.removeEventListener("mousemove",s),document.removeEventListener("touchmove",s),document.removeEventListener("mouseup",r),document.removeEventListener("touchend",r),n.setValue(R.settingsKeys.PANEL_WIDTH,this._width)};document.addEventListener("mousemove",s),document.addEventListener("touchmove",s,{passive:!1}),document.addEventListener("mouseup",r),document.addEventListener("touchend",r,{passive:!1})},this._resizerBridge=t,this._rootContainer=this._resizerBridge.container.value(),this.container=document.createElement("div"),this.container.classList.add(yt["trading-panel-content"],"trading-panel-content"),this._rootContainer.appendChild(this.container),this._addSpinner(),this._addResizeHandler(),this._subscribeVisibility(),this.isLoading.subscribe(this._setLoading.bind(this)),this._rootContainer.style.overflow=this.isOpened.value()?"":"hidden"}addPage(t,e){this._pages[t]=e}isPageOpened(t){return this.isOpened.value()&&this.activePage.value()===t}_setLoading(t){t?this._rootContainer.appendChild(this._spinnerContainer):this._rootContainer.contains(this._spinnerContainer)&&this._rootContainer.removeChild(this._spinnerContainer)}_addSpinner(){this._spinnerContainer=document.createElement("div"),this._spinnerContainer.classList.add(yt["trading-panel-spinner"]),i.e(7102).then(i.bind(i,974063)).then((t=>{t.render(this._spinnerContainer)}))}_addResizeHandler(){this._handle=document.createElement("div"),this._handle.classList.add(yt["trading-panel-handle"]),this._rootContainer.appendChild(this._handle),this._handle.addEventListener("mousedown",this._onLayoutResizeHandleMousedown,{passive:!1}),this._handle.addEventListener("touchstart",this._onLayoutResizeHandleMousedown,{passive:!1}),this._width=n.getInt(R.settingsKeys.PANEL_WIDTH)||bt.panelWidth}_togglePanel(t){this._resizerBridge.negotiateWidth(t?this._width:0),this._resizerBridge.negotiateHeight(t?bt.panelHeight:0),this._rootContainer.style.overflow=t?"":"hidden",n.setValue(R.settingsKeys.TRADING_PANEL_OPENED,t)}_updateVisibility(){this.isVisible.setValue(Boolean(this._resizerBridge.visible.value()&&this._resizerBridge.availHeight.value()>=bt.panelHeight&&this._resizerBridge.availWidth.value()>=bt.panelWidth))}_subscribeVisibility(){this._updateVisibility(),this._resizerBridge.visible.subscribe((()=>{this._updateVisibility()})),this._resizerBridge.availHeight.subscribe((()=>{
this._updateVisibility()})),this._resizerBridge.availWidth.subscribe((()=>{this._updateVisibility()}))}_requestWidth(t){this._canOpen(t)&&this._resizerBridge.width.value()!==t&&(this._resizerBridge.negotiateWidth([{min:bt.panelWidth,max:t}]),this._width=t)}_canOpen(t){return t+46<=this._resizerBridge.availWidth.value()}}var kt=i(304889),Pt=i(872580);const St=["qty","stopPrice","limitPrice","status","filledQty","stopType"];function Ct(t,e,i){if(void 0===t||void 0===e)return!1;const s=i.indexOf(".");if(-1!==s){const r=i.substring(0,s);return Ct(t[r],e[r],i.substring(s+1))}return t[i]===e[i]}function wt(t,e){return t.enabled.value()&&(e.soundPath=t.path.value()),e}function Bt(t){return 6===t||3===t}class Tt extends $.BrokerService{constructor(t){super(t),this._orders=[],this._playSound=(0,kt.default)(this._playSoundImpl,50),y(b().map((t=>t.path)))}startService(){const t=(0,s.ensure)(this.activeBroker());t.orders().then((t=>this._orders=(0,Pt.deepCopy)(t))),t.orderUpdate.subscribe(this,this._orderUpdate)}stopService(){(0,s.ensure)(this.activeBroker()).orderUpdate.unsubscribe(this,this._orderUpdate)}_showNotification(t,e,i){D.enabled("trading_notifications")&&("error"===i?this.trading().showErrorNotification(t,e):this.trading().showSuccessNotification(t,e))}_formatter(t){return(0,s.ensureNotNull)(this.activeBroker()).formatter(t,!0)}_checkOrderModified(t,e){const i=this.activeBroker(),s=i&&i.metainfo().customNotificationFields||[],r=St.concat(s);let o=!1;return r.forEach((i=>{o||Ct(t,e,i)||(o=!0)})),o}_generateNotificationsInfo(t,e){const s=[],o=t.statusMessage?": "+t.statusMessage:"",n=(1===t.side?r.t(null,void 0,i(32241)):r.t(null,void 0,i(185631))).toUpperCase();const a=this.trading().orderExecutedSoundParams;return e?(this._checkOrderModified(t,e)&&(1===t.status?s.push({text:r.t(null,void 0,i(767207)),notificationType:1}):5===t.status?s.push({text:r.t(null,void 0,i(442060))+o,type:"error",notificationType:2}):2===t.status?s.push(wt(a,{side:n,text:r.t(null,void 0,i(499577)),notificationType:6})):e.filledQty!==t.filledQty?s.push(wt(a,{side:n,text:r.t(null,void 0,i(23750)),notificationType:4})):Bt(t.status)&&s.push({text:r.t(null,void 0,i(164105)),notificationType:5})),Object.assign(e,t)):Bt(t.status)?(this._orders.push(t),s.push({text:r.t(null,void 0,i(595536)),notificationType:0}),this.trading().trackEvent("","Order placed symbol",t.symbol)):1===t.status?s.push({text:r.t(null,void 0,i(767207)),notificationType:1}):5===t.status?(this._orders.push(t),s.push({text:r.t(null,void 0,i(442060))+o,type:"error",notificationType:2})):2===t.status&&(this._orders.push(t),s.push({text:r.t(null,void 0,i(595536)),notificationType:0},wt(a,{side:n,text:r.t(null,void 0,i(499577)),emptyOrderType:!0,notificationType:6})),this.trading().trackEvent("","Order placed symbol",t.symbol)),s}_orderUpdate(t,e){const s=(0,Pt.deepCopy)(t),o=this._orders.find((t=>t.id===s.id));if(e)return void(void 0===o&&this._orders.push(s));if(o&&(0,T.isFinalOrderStatus)(o.status))return;const n=this._generateNotificationsInfo(s,o)
;0!==n.length&&this._formatter(s.symbol).then((t=>{const e=(0,T.sideToText)(s.side,!0),o=s.qty,a=void 0!==s.filledQty&&s.filledQty>0?s.filledQty:void 0;let l="",d="";switch(s.type){case 2:l=s.avgPrice?" ("+(0,T.orderTypeToText)({orderType:s.type})+")":"",d=s.avgPrice?t.format(s.avgPrice):(0,T.orderTypeToText)({orderType:s.type});break;case 4:l=" "+r.t(null,void 0,i(916322)).format({price:t.format(s.stopPrice)}),d=t.format(s.avgPrice||s.limitPrice);break;default:l=" ("+(0,T.orderTypeToText)({orderType:s.type})+")",d=t.format(s.avgPrice||s.limitPrice||s.stopPrice)}const c=void 0!==s.message?`${s.message.text.charAt(0).toUpperCase()}${s.message.text.substring(1)}`:"";n.forEach((({text:t,type:n,side:u,emptyOrderType:h,soundPath:p,notificationType:_})=>{const g=4===_&&void 0!==a?a:o,m=(0,dt.splitThousands)(Math.abs(g)," ")+" "+(s.brokerSymbol||s.symbol)+" "+r.t(null,void 0,i(492903))+" "+d,b=`${r.t(null,void 0,i(922541))} ${s.id} ${t}`,y=`${u||e} ${m} ${h?"":l}\n${c}`;void 0!==p&&this._playSound(p),this._showNotification(b,y,n)}))}))}_playSoundImpl(t){if(this._playingSound){if(this._playingSound===t)return;!function(t){if((0,l.isOnMobileAppPage)("any"))return;let e=[];t?e.push(v(t)):e=Object.values(m),e.forEach((t=>{t.stop()}))}(this._playingSound)}this._playingSound=t,function(t=_,e){(0,l.isOnMobileAppPage)("any")?Promise.resolve():(p.logNormal(`Sound play attempt for "${t}" duration-${e}s;`),v(t).play(e))}(t),function(t,e){(0,l.isOnMobileAppPage)("any")||v(t).playing.subscribe((t=>{t||e()}),{once:!0})}(t,(()=>{delete this._playingSound}))}}var Et=i(382213);const Ot=(0,d.getLogger)("Chart.PointsetManager");let Dt=0;class It{constructor(t,e,i,s,r){this._currentPointsetId=null,this._onUpdate=new(N()),this._requestPoints=[],this._gateway=t,this._pointsetSuffix=e,this._isGatewayConnected=this._gateway.isConnected().spawn(),this._isGatewayConnected.subscribe(this._updateByGatewayConnection.bind(this)),this._addPoints(i,s,r)}onUpdate(){return this._onUpdate}destroy(){this._isGatewayConnected.value()&&null!==this._currentPointsetId&&this._gateway.removePointset(this._currentPointsetId),this._requestPoints=[],this._currentPointsetId=null,this._isGatewayConnected.destroy()}_updateByGatewayConnection(t){t||(this._currentPointsetId=null,this._requestPoints=[])}_addPoints(t,e,i){var r,o;this._isGatewayConnected.value()&&((0,s.assert)(t.length>0,"Can't possible create point set for empty array of time points"),this._requestPoints=t.map((t=>[t.time_t,t.offset])),this._currentPointsetId=(r=this._pointsetSuffix,o=++Dt,`pointset_${r}_${o}`),this._gateway.createPointset(this._currentPointsetId,"turnaround",e,(0,Et.getServerInterval)(i),this._requestPoints,this._onMessage.bind(this)))}_onMessage(t){switch(t.method){case"pointset_error":Ot.logNormal(`Pointset error with id ${t.params[0]} turnaround ${t.params[1]}`);break;case"data_update":{const e=[];for(const i of t.params.plots)e.push({time_t:this._requestPoints[i.index][0],index:i.value[0],barTime:i.value[1]});this._onUpdate.fire(e);break}}}}var Lt=i(896778);function At(t){
const e=t.mainSeries().data().first();return null===e?null:e.value[0]}async function Nt(t,e,s){const[r,o,n]=await Promise.all([Promise.all([i.e(2915),i.e(2650)]).then(i.bind(i,141095)),Promise.all([i.e(2915),i.e(2650)]).then(i.bind(i,684661)),Promise.all([i.e(2915),i.e(2650)]).then(i.bind(i,274937))]);t.addCustomSource("executions",((t,i)=>{const a=i.mainSeries(),l=a.dataEvents(),d=(0,Lt.createPrimitivePropertyFromGetterAndSubscription)(i.isInReplay.bind(i),i.onInReplayStateChanged()),c=(0,Lt.createPrimitivePropertyFromGetterAndSubscription)((()=>a.isConvertedToOtherCurrency()||a.isConvertedToOtherUnit()),a.symbolResolved()),u={arrowVisibility:(0,Lt.combineProperty)(((t,e,i)=>i&&!e),d,c,i.properties().childs().tradingProperties.childs().showExecutions),labelVisibility:i.properties().childs().tradingProperties.childs().showExecutionsLabels},h=function(t,e,i){return s=>{const r=i.seriesSource().symbolInstanceId(),o=i.interval();return null===r?null:new It(t,e,s,r,o)}}(i.chartApi(),"executions",a),p=(0,Lt.createWVFromGetterAndSubscription)(At.bind(null,i),l.barReceived()),_=new r.ExecutionsService(e,l,function(t){return()=>{const e=t.symbolInfo();return null!==e?e.pro_name||e.full_name:t.proSymbol()}}(a)),g=new o.ExecutionsPointsManager(_,h,p);return new n.ExecutionsSource(t,i,u,s,g)}))}var Vt=i(129479),xt=i(761139),Mt=i(150335),Rt=i(812813),qt=i(821737),Ft=i(486028);const Ut=r.t(null,void 0,i(505010)),Wt=r.t(null,void 0,i(703396)),Qt=r.t(null,void 0,i(538386)),Ht=r.t(null,void 0,i(893966)),$t=r.t(null,void 0,i(799559)),jt=r.t(null,void 0,i(435312)),zt=r.t(null,void 0,i(422540)),Gt=r.t(null,void 0,i(400241)),Kt=r.t(null,void 0,i(766596)),Jt=D.enabled("broker_button");class Zt{constructor({dataEvents:t,getSymbolName:e,isNonTradableInstrument:i,qtySuggester:s,tradingCommands:r,settings:o,isInReplay:n}){this.ask=new(u())(null),this.askTooltip=new(u())($t),this.bid=new(u())(null),this.bidTooltip=new(u())(jt),this.spread=new(u())(null),this.spreadTooltip=new(u())(zt),this.qty=new(u())(null),this.qtyTooltip=new(u())(""),this.brokerIconVisible=new(u())(!1),this.brokerIconLoading=new(u())(!1),this.brokerIconUrl=new(u())(null),this.isQtyVisible=new(u())(!1),this.hasAskBidAdditionalPrecision=new(u())(!1),this.canTrade=new(u())(!0),this._globalVisibility=null,this._isSymbolTradableResult=new Rt.WatchedObject(null),this._formatter=null,this._spreadFormatter=null,this._symbol=null,this.setQty=t=>{this.qty.setValue(String(t))},this._onSuggestedQtyChange=t=>{this._lastSuggestedQty=t,this.setQty(t)},this._dataEvents=t,this._getSymbolName=e,this._qtySuggester=s,this._realtimeProvider=r.realtimeProvider,this._onNeedSelectBroker=r.onNeedSelectBroker,this._toggleTradingWidget=r.toggleTradingWidget,this._toggleTradingPanelPopup=r.toggleTradingPanelPopup,this._brokerCommandsUI=r.brokerCommandsUI,this._updateRealtimeDataHandler=this._updateRealtimeData.bind(this),this._isBrokerConnected=(0,Lt.createWVFromGetterAndSubscription)((()=>null!==this._realtimeProvider.activeBroker()),this._realtimeProvider.onStatusChanged),
this._isBrokerConnected.subscribe(this._updateIsSymbolTraded.bind(this),{callWithLast:!0}),this._isBrokerConnected.subscribe(this._updateQtyTooltip.bind(this),{callWithLast:!0}),this._isBrokerConnected.subscribe(this._updateBrokerIcon.bind(this)),this._isBrokerConnected.subscribe(this._resubscribeQtySuggester.bind(this)),this._isBrokerConnecting=(0,Lt.createWVFromGetterAndSubscription)((()=>2===r.brokerConnectionStatus()),r.onBrokerConnectionStatusChange),this._isBrokerConnecting.subscribe(this._updateBrokerIcon.bind(this)),this.visible=new(u())(!1),this.visible.subscribe(this._toggleState.bind(this),{callWithLast:!0}),this._showSellBuyButtons=o.showSellBuyButtons.spawn(),this._isInReplay=n.spawn(),this._isNonTradableInstrument=i.spawn(),this._showSellBuyButtons.subscribe(this._updateVisibility.bind(this)),this._isInReplay.subscribe(this._updateVisibility.bind(this)),this._isNonTradableInstrument.subscribe(this._updateVisibility.bind(this)),this._updateVisibility(),this._isInstantMode=o.noConfirmEnabled.spawn(),this._themeName=o.themeName.spawn(),this._themeName.subscribe(this._updateBrokerIcon.bind(this),{callWithLast:!0}),this._tradePossibilityComputedWV=(0,L.combine)((()=>({})),this._isBrokerConnected,this._isSymbolTradableResult,this.ask,this.bid),this._tradePossibilityComputedWV.subscribe(this._updateTradePossibilityAndTooltip.bind(this),{callWithLast:!0}),this._isQtyVisibleComputedWV=(0,L.combine)((()=>({})),this.canTrade,this._isInstantMode),this._isQtyVisibleComputedWV.subscribe(this._updateIsQtyVisible.bind(this),{callWithLast:!0})}destroy(){var t;this._stop(),this._isBrokerConnected.destroy(),this._showSellBuyButtons.destroy(),this._isInReplay.destroy(),this._isNonTradableInstrument.destroy(),null===(t=this._globalVisibility)||void 0===t||t.destroy(),this._isInstantMode.destroy(),this._tradePossibilityComputedWV.destroy(),this._isQtyVisibleComputedWV.destroy(),this._themeName.destroy()}setGlobalVisibility(t){(0,s.assert)(null===this._globalVisibility,"GlobalVisibility can be set only once"),this._globalVisibility=t.spawn(),this._globalVisibility.subscribe(this._updateVisibility.bind(this),{callWithLast:!0})}async tryToPlaceSellOrder(){await this._tryToPlaceOrder(parseFloat((0,s.ensureNotNull)(this.bid.value())),-1)}async tryToPlaceBuyOrder(){await this._tryToPlaceOrder(parseFloat((0,s.ensureNotNull)(this.ask.value())),1)}async getQtyInfo(){return null!==this._symbol&&this.canTrade.value()?(await this._realtimeProvider.symbolInfo(this._symbol)).qty:null}applyQty(){if(null===this._symbol||!this.canTrade.value())return;const t=this.qty.value(),e=null!==t?Number(t):null;null!==e&&this._qtySuggester.setQty(this._symbol,e),void 0!==this._lastSuggestedQty&&e!==this._lastSuggestedQty&&this.qty.setValue(String(this._lastSuggestedQty))}canShowMobileTrading(){var t;return!(null===(t=window.TradingView.bottomWidgetBar)||void 0===t?void 0:t.isVisible().value())}_updateVisibility(){
const t=(null===this._globalVisibility||this._globalVisibility.value())&&this._showSellBuyButtons.value()&&!this._isInReplay.value()&&!this._isNonTradableInstrument.value();this.visible.setValue(t)}async _tryToPlaceOrder(t,e){var i,r;if(null===this._realtimeProvider.activeBroker())return this.canShowMobileTrading()?this._toggleTradingPanelPopup():await this._toggleTradingWidget(),void this._onNeedSelectBroker.fire();const o=Number(this.qty.value())||1,n=this._isMarketOrderSupported()?2:1,a=1===e?null===(i=this._currentQuotes)||void 0===i?void 0:i.ask:null===(r=this._currentQuotes)||void 0===r?void 0:r.bid,l={symbol:(0,s.ensureNotNull)(this._symbol),qty:o,side:e,type:n,seenPrice:null!=a?a:null,currentQuotes:this._currentQuotes};1===n&&(l.limitPrice=t),await(0,s.ensureNotNull)(this._brokerCommandsUI()).placeOrder(l,!0)}_toggleState(t){t?this._start():this._stop()}_start(){this._dataEvents.symbolResolved().subscribe(this,this._createTradedSymbol),this._dataEvents.symbolError().subscribe(this,this._createTradedSymbol),this._createTradedSymbol()}_stop(){this._clearTradedSymbol(),this._symbol=null,this._dataEvents.symbolResolved().unsubscribeAll(this),this._dataEvents.symbolError().unsubscribeAll(this)}_createTradedSymbol(){const t=this._getSymbolName();t!==this._symbol&&(this._clearTradedSymbol(),t.length>0&&this._initTradedSymbol(t))}_initTradedSymbol(t){this._symbol=t,this._updateIsSymbolTraded(),this._realtimeProvider.subscribeRealtime(this._symbol,this._updateRealtimeDataHandler),this._resubscribeQtySuggester()}_clearTradedSymbol(){var t;this._currentQuotes=void 0,this.ask.setValue(null),this.bid.setValue(null),this.spread.setValue(null),this.qty.setValue(null),null!==this._symbol&&(this._realtimeProvider.unsubscribeRealtime(this._symbol,this._updateRealtimeDataHandler),null===(t=this._qtySuggesterSubscription)||void 0===t||t.unsubscribe(),this._symbol=null,this._updateIsSymbolTraded())}async _resubscribeQtySuggester(){var t;const e=this._symbol;if(null===e)return;null===(t=this._qtySuggesterSubscription)||void 0===t||t.unsubscribe();const i=this._suggestedQtyPromise=this._qtySuggester.getQty(e),s=await i;i===this._suggestedQtyPromise&&e===this._symbol&&(this._lastSuggestedQty=s,this.setQty(s),this._qtySuggesterSubscription=this._qtySuggester.suggestedQtyChanged(e).subscribe(this._onSuggestedQtyChange))}_isMarketOrderSupported(){const t=this._realtimeProvider.activeBroker();return null===t||Boolean(t.metainfo().configFlags.supportMarketOrders)}_updateTradePossibilityAndTooltip(){this._updateCanTrade(),this._updateSellBuyTooltip()}_updateCanTrade(){const t=this._isSymbolTradableResult.value(),e=this._isBrokerConnected.value()&&null!==t&&t.tradable;this.canTrade.setValue(e)}_updateSellBuyTooltip(){var t,e;const i=this._getNonTradedTooltip();this.askTooltip.setValue(null!==(t=null!=i?i:this._getAskTooltip())&&void 0!==t?t:$t),this.bidTooltip.setValue(null!==(e=null!=i?i:this._getBidTooltip())&&void 0!==e?e:jt)}_getNonTradedTooltip(){const t=this._isSymbolTradableResult.value()
;if(null!==t&&!t.tradable)return void 0!==t.solutions?"":void 0!==t.shortReason&&""!==t.shortReason?t.shortReason:this._isBrokerConnected.value()?Wt:Ut}_getAskTooltip(){return null===this.ask.value()?Ht:void 0}_getBidTooltip(){return null===this.bid.value()?Qt:void 0}_updateRealtimeData(t,e,i){this._formatter=i.formatter,this._spreadFormatter=i.spreadFormatter;const s=e.ask,r=e.bid,o=(0,Mt.isNumber)(s),n=(0,Mt.isNumber)(r),a=o?this._formatter.format(s):null,l=n?this._formatter.format(r):null;this.ask.setValue(a),this.bid.setValue(l),o&&n&&(this._currentQuotes={ask:s,bid:r});const d=e.spread||(0,Mt.isNumber)(s)&&(0,Mt.isNumber)(r)&&s-r||0,c=(0,Mt.isNumber)(e.spread)?this._spreadFormatter:this._formatter;this.spread.setValue(c.format(d));let u=!1;(0,qt.isFormatterHasForexAdditionalPrecision)(this._formatter)&&(u=this._formatter.hasForexAdditionalPrecision()),this.hasAskBidAdditionalPrecision.setValue(u)}async _updateIsSymbolTraded(){if(null===this._symbol)return void this._isSymbolTradableResult.setValue(null);const t=await this._realtimeProvider.isTradable(this._symbol);this._isSymbolTradableResult.setValue((0,Ft.clone)(t))}_updateIsQtyVisible(){const t=this._isInstantMode.value()&&this.canTrade.value();this.isQtyVisible.setValue(t)}_updateQtyTooltip(){this.qtyTooltip.setValue(this._getQtyTooltip())}_getQtyTooltip(){const t=this._realtimeProvider.activeBroker();return null!==t&&t.metainfo().configFlags.showQuantityInsteadOfAmount?Kt:Gt}_updateBrokerIcon(){if(!Jt)return;let t;const e=this._realtimeProvider.activeBroker();if(null!==e){const i=e.metainfo();t="dark"===this._themeName.value()&&i.logoMiniBlackUrl?i.logoMiniBlackUrl:i.logoMiniUrl}this.brokerIconVisible.setValue(this._isBrokerConnected.value()),this.brokerIconLoading.setValue(this._isBrokerConnecting.value()),this.brokerIconUrl.setValue(t||null)}}var Xt=i(159255),Yt=i(343370),te=i(72304),ee=i(976496),ie=i(138813),se=i(987320);class re extends ie.LoaderBaseRenderer{_renderLoading(t){super._renderLoading(t),this._loadingEl.innerHTML=`\n\t\t\t<span class="${se.loaderCircle}"></span>\n\t\t`,this._loadingEl.classList.add(se.loader)}}var oe=i(291089),ne=i(140641);var ae=i(190787),le=i(899516),de=i(262927),ce=i(228161),ue=i(829883);const he=parseInt(ce["css-value-padding"]);function pe(t,e,i,r){let o=t.querySelector(`.${r}`);if(!i)return null!==o&&o.remove(),void(0,ae.updateTextNode)(t,e);null===o&&(o=document.createElement("span"),o.classList.add(r),t.appendChild(o)),(0,ae.updateTextNode)((0,s.ensureNotNull)(o),e.slice(-1)),(0,ae.updateTextNode)(t,e.slice(0,-1))}class _e{constructor({model:t,highButtonsMode:e,trackEvent:i,toggleMinimizeBottomWidgetBar:s}){this.element=document.createElement("div"),this._sellButtonEl=document.createElement("div"),this._sellButtonTextEl=document.createElement("span"),this._buyButtonEl=document.createElement("div"),this._buyButtonTextEl=document.createElement("span"),this._spreadQtyWrapper=document.createElement("div"),this._spreadEl=document.createElement("div"),this._qtyEl=document.createElement("div"),
this._qtyTextEl=document.createElement("span"),this._brokerButtonEl=document.createElement("div"),this._brokerIconWrapEl=document.createElement("div"),this._isCalcOpened=!1,this._calcContainer=document.createElement("div"),this._sellLoader=new ee.LoaderPointsRenderer(this._sellButtonEl,{className:le.loader}),this._buyLoader=new ee.LoaderPointsRenderer(this._buyButtonEl,{className:le.loader}),this._brokerLoader=new re(this._brokerButtonEl,{className:le.circleLoader}),this._windowResizeHandlerThrottle=(0,Yt.default)(this._windowResizeHandler.bind(this),100),this._isHiddenByViewport=!1,this._mode=2,this._height=new(u())(0),this._resizeObserver=null,this._cachedBreakPoints={},this._parentWidth=0,this._getCurrentQty=()=>{const t=this._qty.value();return null!==t?Number(t):null},this._model=t,this._toggleMinimizeBottomWidgetBar=s,this._ask=this._model.ask.spawn(),this._ask.subscribe(this._updateBuyButton.bind(this)),this._bid=this._model.bid.spawn(),this._bid.subscribe(this._updateSellButton.bind(this)),this._spread=this._model.spread.spawn(),this._spread.subscribe(this._updateSpread.bind(this)),this._qty=this._model.qty.spawn(),this._qty.subscribe(this._updateQty.bind(this)),this._brokerIconVisible=this._model.brokerIconVisible.spawn(),this._brokerIconVisible.subscribe(this._updateBrokerIconImage.bind(this)),this._brokerIconLoading=this._model.brokerIconLoading.spawn(),this._brokerIconLoading.subscribe(this._updateBrokerIconImage.bind(this)),this._brokerIconUrl=this._model.brokerIconUrl.spawn(),this._brokerIconUrl.subscribe(this._updateBrokerIconImage.bind(this),{callWithLast:!0}),this._trackEvent=i,this._render(),this._askTooltip=this._model.askTooltip.spawn(),this._askTooltip.subscribe(this._updateButtonTooltip.bind(this,this._buyButtonEl),{callWithLast:!0}),this._bidTooltip=this._model.bidTooltip.spawn(),this._bidTooltip.subscribe(this._updateButtonTooltip.bind(this,this._sellButtonEl),{callWithLast:!0}),this._spreadTooltip=this._model.spreadTooltip.spawn(),this._spreadTooltip.subscribe(this._updateButtonTooltip.bind(this,this._spreadEl),{callWithLast:!0}),this._qtyTooltip=this._model.qtyTooltip.spawn(),this._qtyTooltip.subscribe(this._updateButtonTooltip.bind(this,this._qtyEl),{callWithLast:!0}),this._isVisible=this._model.visible.spawn(),this._isVisible.subscribe(this._updateVisibility.bind(this),{callWithLast:!0}),this._isQtyVisible=this._model.isQtyVisible.spawn(),this._isQtyVisible.subscribe(this._updateQtyVisibility.bind(this),{callWithLast:!0}),this._isLastDigitSup=this._model.hasAskBidAdditionalPrecision.spawn(),this._isLastDigitSup.subscribe(this._updateLastDigitSup.bind(this)),this._highButtonsMode=e.spawn(),this._highButtonsMode.subscribe(this._updateHighButtonsMode.bind(this),{callWithLast:!0}),this._canTrade=this._model.canTrade.spawn(),this._canTrade.subscribe(this._updateBgButtonsMode.bind(this),{callWithLast:!0}),this._sellButtonHandler=this._onSellButton.bind(this),this._buyButtonHandler=this._onBuyButton.bind(this),this._qtyHandler=this._toggleCalcVisibility.bind(this),
this._brokerButtonHandler=this._onBrokerButton.bind(this),this._sellButtonEl.addEventListener("click",this._sellButtonHandler),this._buyButtonEl.addEventListener("click",this._buyButtonHandler),this._qtyEl.addEventListener("click",this._qtyHandler),this._brokerButtonEl.addEventListener("click",this._brokerButtonHandler),window.addEventListener("resize",this._windowResizeHandlerThrottle),this._windowResizeHandler()}destroy(){var t;this._ask.destroy(),this._askTooltip.destroy(),this._bid.destroy(),this._bidTooltip.destroy(),this._spread.destroy(),this._spreadTooltip.destroy(),this._qty.destroy(),this._qtyTooltip.destroy(),this._isVisible.destroy(),this._isQtyVisible.destroy(),this._isLastDigitSup.destroy(),this._highButtonsMode.destroy(),this._canTrade.destroy(),this._brokerIconUrl.destroy(),this._sellButtonEl.removeEventListener("click",this._sellButtonHandler),this._buyButtonEl.removeEventListener("click",this._buyButtonHandler),this._qtyEl.removeEventListener("click",this._qtyHandler),this._brokerButtonEl.removeEventListener("click",this._brokerButtonHandler),null===(t=this._resizeObserver)||void 0===t||t.disconnect(),this._resizeObserver=null,this.element.remove(),delete this.element,window.removeEventListener("resize",this._windowResizeHandlerThrottle)}updateModeByWidth(t){const e=this._cachedBreakPoints[0],i=this._cachedBreakPoints[1];this._mode=void 0!==e&&t<e?0:void 0!==i&&t<i?1:2,this._parentWidth=t,this.element.classList.toggle(le.column,1===this._mode),this._updateVisibility()}height(){return this._height}renderTo(t,e){void 0!==e?t.insertBefore(this.element,e):t.appendChild(this.element),null===this._resizeObserver&&(this._resizeObserver=new Xt.default(this._updateBreakPointsAndSize.bind(this))),this._resizeObserver.unobserve(this.element),this._resizeObserver.observe(this.element)}isHiddenByViewport(){return this._isHiddenByViewport}_render(){const t=this._bid.value()||"...";this._sellButtonTextEl.appendChild(document.createTextNode(t)),this._sellButtonTextEl.classList.add(le.buttonText),this._sellButtonEl.append(this._sellButtonTextEl),this._sellButtonEl.classList.add("apply-common-tooltip",le.button,le.sellButton);const e=this._spread.value()||"";this._spreadEl.appendChild(document.createTextNode(String(e))),this._spreadEl.classList.add("apply-common-tooltip",le.spread);const i=this._qty.value()||"";this._qtyTextEl.appendChild(document.createTextNode(i)),this._qtyEl.append(this._qtyTextEl),this._qtyEl.setAttribute("data-name","qtyEl"),this._qtyEl.classList.add("apply-common-tooltip",le.button,le.qty),this._spreadQtyWrapper.classList.add(le.spreadQtyWrapper),this._spreadQtyWrapper.appendChild(this._spreadEl),this._spreadQtyWrapper.appendChild(this._qtyEl);const s=this._ask.value()||"...";this._buyButtonTextEl.appendChild(document.createTextNode(String(s))),this._buyButtonTextEl.classList.add(le.buttonText),this._buyButtonEl.append(this._buyButtonTextEl),this._buyButtonEl.classList.add("apply-common-tooltip",le.button,le.buyButton),this._brokerButtonEl.appendChild(this._brokerIconWrapEl),
this._brokerIconWrapEl.classList.add(le.brokerButtonIconWrap),this._brokerButtonEl.classList.add(le.brokerButton),this.element.appendChild(this._sellButtonEl),this.element.appendChild(this._spreadQtyWrapper),this.element.appendChild(this._buyButtonEl),this.element.appendChild(this._brokerButtonEl),this.element.classList.add(le.wrapper),this.element.classList.toggle(le.touchMode,oe.trackingModeIsAvailable),this.element.classList.toggle(le.notAvailableOnMobile,false)}_updateBreakPointsAndSize(t){const e=t[0],i=2*he;2===this._mode&&(this._cachedBreakPoints[1]=Math.round(e.contentRect.width)+i),1===this._mode&&(this._cachedBreakPoints[0]=Math.round(e.contentRect.width)+i),this.updateModeByWidth(this._parentWidth);const s=e.contentRect.height>0?Math.round(e.contentRect.height)+i:0;this._height.setValue(s)}_updateBrokerIconImage(){const t=this._brokerIconLoading.value(),e=!this._brokerIconVisible.value()&&!t;if(this._brokerButtonEl.classList.toggle(de.blockHidden,e),e)return;if(this._toggleLoaderVisibility(this._brokerButtonEl,this._brokerLoader,t),t)return void(this._brokerIconWrapEl.innerHTML="");const i=this._brokerIconUrl.value(),s=null===i;this._brokerIconWrapEl.innerHTML=s?ue:`<image src="${i}" alt="Account Manager" />`,this._brokerButtonEl.classList.toggle(le.brokerButtonDefault,s)}async _onSellButton(){if(null===this._bid.value())return;const t=this._highButtonsMode.value();this._trackEvent("Sell/Buy Buttons","Sell",t?"Instant":"Not Instant"),t&&this._canTrade.value()&&this._toggleLoaderVisibility(this._sellButtonEl,this._sellLoader,!0),await this._model.tryToPlaceSellOrder(),t&&this._canTrade.value()&&setTimeout((()=>this._toggleLoaderVisibility(this._sellButtonEl,this._sellLoader,!1)),300)}async _onBuyButton(){if(null===this._ask.value())return;const t=this._highButtonsMode.value();this._trackEvent("Sell/Buy Buttons","Buy",t?"Instant":"Not Instant"),t&&this._canTrade.value()&&this._toggleLoaderVisibility(this._buyButtonEl,this._buyLoader,!0),await this._model.tryToPlaceBuyOrder(),t&&this._canTrade.value()&&setTimeout((()=>this._toggleLoaderVisibility(this._buyButtonEl,this._buyLoader,!1)),300)}_onBrokerButton(){this._model.canShowMobileTrading()?async function(){(await(0,ne.waitTradingService)()).tradingPanelPopup.show()}():this._toggleMinimizeBottomWidgetBar()}_toggleLoaderVisibility(t,e,i){t.classList.toggle(le.loading,i),e.toggleVisibility(i)}_updateBuyButton(t){const e=null!==t&&this._isLastDigitSup.value();pe(this._buyButtonTextEl,`${t||"..."}`,e,le.lastCharSup)}_updateSellButton(t){const e=null!==t&&this._isLastDigitSup.value();pe(this._sellButtonTextEl,`${t||"..."}`,e,le.lastCharSup)}_updateSpread(t){const e=`${t||""}`;(0,ae.updateTextNode)(this._spreadEl,e),this._updateVisibilityForSpreadQtyWrapper()}_updateQty(t){let e=`${t||""}`;!this._isCalcOpened&&e.length>0&&(e=(0,I.abbreviatedNumber)(Number(e))),(0,ae.updateTextNode)(this._qtyTextEl,e)}_updateHighButtonsMode(t){this.element.classList.toggle(le.highButtons,t)}_updateBgButtonsMode(t){this.element.classList.toggle(le.withoutBg,!t)}
_updateVisibilityForSpreadQtyWrapper(){const t=!this._isQtyVisible.value()&&null===this._spread.value();this._spreadQtyWrapper.classList.toggle(de.blockHidden,t)}_updateQtyVisibility(t){this._qtyEl.classList.toggle(de.blockHidden,!t),this._spreadQtyWrapper.classList.toggle(le.withoutQty,!t),this._updateVisibilityForSpreadQtyWrapper()}_updateVisibility(){const t=this._isVisible.value()&&0!==this._mode&&!this._isHiddenByViewport;this.element.classList.toggle(de.blockHidden,!t)}_updateLastDigitSup(){this._updateBuyButton(this._ask.value()),this._updateSellButton(this._bid.value())}_updateButtonTooltip(t,e){if(""===e)return(0,te.setTooltipData)(t,"text",e),void t.removeAttribute("title");t.setAttribute("title",e)}_toggleCalcVisibility(){this._isCalcOpened=!this._isCalcOpened,this._renderCalc()}_closeCalc(){this._isCalcOpened=!1,this._updateQty(this._qty.value()),this._model.applyQty(),this._renderCalc()}_renderCalc(){Promise.all([i.e(7624),i.e(346),i.e(3287),i.e(1282),i.e(6086),i.e(7125),i.e(3809)]).then(i.bind(i,713191)).then((async t=>{const e=await this._model.getQtyInfo();null!==e&&t.render(this._isCalcOpened,this._calcContainer,{...e,withInput:!0,valueGetter:this._getCurrentQty,position:this._getCalcPosition(),targetEl:this._qtyEl,onClose:this._closeCalc.bind(this),onValueChange:this._model.setQty,trackEventTarget:"Sell/Buy Buttons",trackEvent:this._trackEvent})}))}_getCalcPosition(){const t=this._qtyEl.getBoundingClientRect();return{x:t.left,y:t.bottom+2}}_windowResizeHandler(){false!==this._isHiddenByViewport&&(this._isHiddenByViewport=false,this._updateVisibility())}}var ge=i(710567);const me=r.t(null,void 0,i(73953));class be{constructor(t,e,i,s,r,o,n){this._showSellBuyButtons=o.showSellBuyButtons,this._isEconomySymbol=i,this._isInReplay=n,this._trackEvent=r.trackEvent,this._model=new Zt({dataEvents:t,getSymbolName:e,isNonTradableInstrument:i,qtySuggester:s,tradingCommands:r,settings:o,isInReplay:n}),this._renderer=new _e({model:this._model,highButtonsMode:o.noConfirmEnabled,trackEvent:r.trackEvent,toggleMinimizeBottomWidgetBar:r.toggleMinimizeBottomWidgetBar})}destroy(){this._model.destroy(),this._renderer.destroy()}renderTo(t,e){this._renderer.renderTo(t,e)}setGlobalVisibility(t){this._model.setGlobalVisibility(t)}visibility(){return this._model.visible}updateWidgetModeBySize(t){this._renderer.updateModeByWidth(t.width)}contextMenuActions(){if(this._renderer.isHiddenByViewport())return[];return[new ge.Action({actionId:"Trading.SellBuyButtonsToggleVisibility",checkable:!0,checked:this._showSellBuyButtons.value(),label:me,disabled:this._isInReplay.value()||this._isEconomySymbol.value(),onExecute:()=>{const t=!this._showSellBuyButtons.value();this._showSellBuyButtons.setValue(t),this._trackEvent("SellBuyButtonsWidget context menu","Show Sell/Buy Button",t?"Check":"Uncheck")}})]}height(){return this._renderer.height()}}var ye=i(500962),ve=i(231605),fe=i(533408),ke=i(864852);const Pe=lt.forwardRef(((t,e)=>lt.createElement("div",{ref:e,className:ke.popupWrapper},t.children)));var Se=i(753327);const Ce=(()=>{
let t,e,s,r=null,o=null;return async(n,a,l,d)=>{const c=null==n?void 0:n.currentAccount();if(null===r||o!==n||t!==c||s!==d){null==e||e.remove();const{AccountManager:h}=await Promise.all([i.e(7624),i.e(8230),i.e(9333),i.e(4819),i.e(6092),i.e(8825),i.e(5761),i.e(4884),i.e(105),i.e(8671),i.e(7507),i.e(7953),i.e(6972),i.e(7752),i.e(9255),i.e(8210),i.e(7664),i.e(3042),i.e(4104),i.e(852),i.e(8354)]).then(i.bind(i,495413)),p={container:a,visible:new(u())(!0)};r=a,o=n,t=c,s=d,e=await h.create({broker:n,bridge:p,mode:0,overlapManager:l,summaryFieldsVisibilityManager:d})}else a.appendChild(r)}})(),we=new(u())(null);function Be(t){const{broker:e,summaryFieldsVisibilityManager:i}=t,s=(0,lt.useRef)(null),r=(0,lt.useContext)(Se.SlotContext);return(0,lt.useEffect)((()=>{we.setValue(r)}),[r]),(0,lt.useEffect)((()=>{null!==s.current&&Ce(e,s.current,we.readonly(),i)}),[]),lt.createElement(Pe,{ref:s})}var Te=i(132455),Ee=i(747073),Oe=i(831979),De=i(496038);const Ie=r.t(null,void 0,i(890801));class Le extends ve.DialogRenderer{constructor(t){super(),this._title=Ie,this._isSubscribed=!1,this._showSeparator=!0,this._unsetHeaderAlign=!0,this._handleClose=()=>{ye.unmountComponentAtNode(this._container),this._setVisibility(!1)},this._trading=t}visible(){return this._visibility.spawn().readonly()}show(){this._isSubscribed||(this._isSubscribed=!0,this._onStatusChange(this._trading.connectStatus()),this._trading.onConnectionStatusChange.subscribe(this,this._onStatusChange)),this._setVisibility(!0),this._renderComponent()}hide(){this._handleClose()}_onStatusChange(t,e){var i,s;null===(i=this._trading.activeBroker())||void 0===i||i.currentAccountUpdate.unsubscribe(this,this._renderAccountManager),this._connectStatus!==t&&(this._connectStatus=t,window.navigator.onLine?2!==t&&(null==e?void 0:e.disconnectType)!==S.DisconnectType.Offline&&3!==t&&4!==t?1===t&&(null===(s=this._trading.activeBroker())||void 0===s||s.currentAccountUpdate.subscribe(this,this._renderAccountManager),this._renderAccountManager()):this._renderSpinner():this._renderOfflineScreen())}_renderComponent(){ye.render(lt.createElement(fe.AdaptivePopupDialog,{dataName:"trading-dialog",isOpened:this.visible().value(),onClose:this._handleClose,showSeparator:this._showSeparator,unsetHeaderAlign:this._unsetHeaderAlign,fullScreen:!0,draggable:!1,title:this._title,render:()=>this._content}),this._container)}_renderSpinner(){this._unsetHeaderAlign=!1,this._showSeparator=!0,this._title=Ie,this._changeDialogContent(lt.createElement(Te.Spinner,null))}_renderOfflineScreen(){this._title=Ie,this._changeDialogContent(lt.createElement(De.OfflineScreen,null))}async _renderBrokerSelectScreen(){0}async _renderAccountManager(){const t=(0,s.ensureNotNull)(this._trading.activeBroker()).accountManagerInfo().summary,e=new Oe.SummaryFieldsVisibilityManager(t,this._trading.getBrokerTradingSettingsStorage),r=await(0,Ee.makeAccountManagerHeaderDropdownsProps)(this._trading,e);if(this._showSeparator=!1,this._unsetHeaderAlign=!0,this._title=Ie,void 0!==r){
const{AccountManagerHeaderDropdowns:t}=await Promise.all([i.e(7624),i.e(8230),i.e(9333),i.e(4819),i.e(6092),i.e(8825),i.e(5761),i.e(4884),i.e(105),i.e(8671),i.e(7507),i.e(7953),i.e(6972),i.e(7752),i.e(9255),i.e(8210),i.e(7664),i.e(3042),i.e(4104),i.e(852),i.e(8354)]).then(i.bind(i,496894));this._title=lt.createElement(t,{...r})}this._content=lt.createElement(Be,{broker:this._trading.activeBroker(),summaryFieldsVisibilityManager:e}),this._renderComponent()}_changeDialogContent(t){this._content=lt.createElement(Pe,null,t),this._renderComponent()}}var Ae,Ne=i(385146),Ve=i(601227);async function xe(t,e){localStorage.setItem(t,e)}!function(t){t.get=async function(){return Ve.CheckMobile.any()||await async function(){const t=n.getValue(R.settingsKeys.ACTIVE_BROKER);if(n.remove(R.settingsKeys.ACTIVE_BROKER,{forceFlush:!0}),void 0===t)return;await xe(R.settingsKeys.ACTIVE_BROKER,t)}(),async function(t){return localStorage.getItem(t);const e=localStorage.getItem(t);if(null===e)return null;const i=await userSpecificDecrypt(e);null===i&&localStorage.removeItem(t);return i}(R.settingsKeys.ACTIVE_BROKER)},t.set=async function(t){await xe(R.settingsKeys.ACTIVE_BROKER,t)},t.clear=function(){n.remove(R.settingsKeys.ACTIVE_BROKER,{forceFlush:!0}),localStorage.removeItem(R.settingsKeys.ACTIVE_BROKER)}}(Ae||(Ae={}));var Me=i(960521),Re=i.n(Me),qe=i(173587),Fe=i(233064),Ue=i(757604),We=i(218286),Qe=i(169977),He=i(312694),$e=i(749401),je=i(265728),ze=i(482165),Ge=i(839874),Ke=i(218954),Je=i(886630);class Ze{constructor(t){this._rawAndFilteredQtyMap=new Map,this._qtyInfo=new Map;const{symbolInfoGetter:e,onResetNeeded:i,qtySettingsStorageGetter:s}=t;this._getQtySettingsStorage=s,this._getSymbolInfo=e,i.subscribe(this,this._reset)}async getQty(t){return(0,$e.firstValueFrom)(this._getRawAndFilteredQty(t).filteredQty$)}setQty(t,e){this._getRawAndFilteredQty(t).rawQty$.next(e)}suggestedQtyChanged(t){return this._getRawAndFilteredQty(t).filteredQty$.pipe((0,qe.skip)(1))}_getRawAndFilteredQty(t){var e;return null!==(e=this._rawAndFilteredQtyMap.get(t))&&void 0!==e?e:this._makeRawAndFilteredQty(t)}_makeRawAndFilteredQty(t){const e=new je.ReplaySubject(1),i=this._getInitialQty(t).pipe((0,Fe.switchMap)((t=>e.pipe((0,Ue.startWith)(t)))),(0,We.distinctUntilChanged)(),(0,Qe.filter)((e=>this._isQtyCorrect(t,e))),(0,ze.tap)((e=>{var i;return null===(i=this._getQtySettingsStorage())||void 0===i?void 0:i.setSymbolQty(t,e)})),(0,He.share)({connector:()=>new je.ReplaySubject(1),resetOnRefCountZero:!1})),s={rawQty$:e,filteredQty$:i};return this._rawAndFilteredQtyMap.set(t,s),s}_isQtyCorrect(t,e){const i=(0,s.ensureDefined)(this._qtyInfo.get(t));return!(0,Je.checkQtyError)(i,e,!0).res}_getInitialQty(t){return(0,Ge.from)(this._getSymbolInfo(t)).pipe((0,P.map)((({qty:e})=>{var i;this._qtyInfo.set(t,e);const s=null===(i=this._getQtySettingsStorage())||void 0===i?void 0:i.symbolQty(t),r=e.default||e.min;return void 0!==s&&s>0?(o=(0,Ke.clamp)(s,e.min,e.max),n=e.min,a=e.step,Re()(o).minus(n).div(a).round(0,1).mul(a).plus(n).toNumber()):r;var o,n,a})))}_reset(){
this._rawAndFilteredQtyMap.forEach((({rawQty$:t})=>t.complete())),this._rawAndFilteredQtyMap.clear(),this._qtyInfo.clear()}}var Xe=i(316230);class Ye{constructor(){this._context=null,this._onContextChanged=new(N()),this._contextChange=()=>{this._onContextChanged.fire(this.context())}}context(){var t,e;return null!==(e=null===(t=this._context)||void 0===t?void 0:t.externalContext())&&void 0!==e?e:null}setContext(t){var e;this._isEqualContexts(t)||(this._clearSubscription(),this._context=t,null===(e=this._context)||void 0===e||e.onStatusChange().subscribe(this,this._contextChange),this._contextChange())}onContextChanged(){return this._onContextChanged}clear(){this.setContext(null)}_clearSubscription(){var t;null===(t=this._context)||void 0===t||t.onStatusChange().unsubscribeAll(this)}_isEqualContexts(t){var e;return null===this._context||null===t?this._context===t:(null===(e=this.context())||void 0===e?void 0:e.type)===(null==t?void 0:t.externalContext().type)&&(this._context.status()===t.status()&&(0,Xe.default)(this._context.errors(),t.errors())&&(0,Xe.default)(this._context.data(),t.data()))}}class ti{constructor(t){this._transientStorage={},this._persistentStorageKey=`trading.${t}`;const e=n.getJSON(this._persistentStorageKey,{});delete e.orderTicketQuantity,this._transientStorage=e}setTakeProfitPips(t,e,i){this._setPips("takeProfit",t,e,i)}takeProfitPips(t){return this._getSectionValue("takeProfit",t)}setStopLossPips(t,e,i){this._setPips("stopLoss",t,e,i)}stopLossPips(t){return this._getSectionValue("stopLoss",t)}setDuration(t,e,i){const s=this.duration(t,e);null!==i&&void 0!==s&&s.type===i.type&&s.datetime===i.datetime||null===i&&void 0===s||(this._setDuration(t,e,i),this._syncStorage())}duration(t,e){var i;return this._migrateDuration(t,e),null===(i=this._getSectionValue("duration",t))||void 0===i?void 0:i[e]}setSymbolQty(t,e){this._getOrCreateSection("qty")[t]=e,this._syncStorage()}symbolQty(t){return this._getSectionValue("qty",t)}setCustomFields(t,e,i){var s,r,o;const n=this._getOrCreateSection("customFields");null!==(s=n[t])&&void 0!==s||(n[t]={}),null!==(r=(o=n[t])[e])&&void 0!==r||(o[e]={});const a=n[t][e];for(const[t,e]of Object.entries(i))"string"==typeof e&&""!==e||"boolean"==typeof e?a[t]=e:delete a[t];0===Object.keys(a).length&&delete n[t][e],0===Object.keys(n[t]).length&&delete n[t],this._syncStorage()}customFields(t,e,i){this._migrateCustomFields(t,e,i);const s={},r=this._transientStorage.customFields;if(void 0===r||void 0===r[t])return s;const o=r[t][e];return void 0===o||i.forEach((t=>{const e=o[t];""!==e&&void 0!==e&&(s[t]=e)})),s}orderType(t){return this._getSectionValue("orderType",t)}setOrderType(t,e){this._getOrCreateSection("orderType")[t]=e,this._syncStorage()}setTableColumnsOrder(t,e){this._getOrCreateSection("tableColumnsOrder")[t]=e,this._syncStorage()}tableColumnsOrder(t){return this._getSectionValue("tableColumnsOrder",t)}summaryFieldsVisibilityInfo(){const t=new Map,e=this._transientStorage.summaryFields;if(void 0===e)return t;for(const[i,s]of Object.entries(e))t.set(i,{id:i,visible:s
});return t}setSummaryFieldsVisibilityInfo(t){t.forEach((({id:t,visible:e})=>{this._getOrCreateSection("summaryFields")[t]=e})),this._syncStorage()}_getOrCreateSection(t){return t in this._transientStorage||(this._transientStorage[t]={}),this._transientStorage[t]}_getSectionValue(t,e){const i=this._transientStorage[t];return void 0!==i?i[e]:void 0}_removeValue(t,e){const i=this._transientStorage[t];void 0!==i&&(delete i[e],0===Object.keys(i).length&&delete this._transientStorage[t])}_setPips(t,e,i,s){const r=this._getSectionValue(t,e);if(!(void 0!==r&&r===i||void 0===r&&i===s)){if(void 0!==r&&i===s)this._removeValue(t,e);else{this._getOrCreateSection(t)[e]=i}this._syncStorage()}}_setDuration(t,e,i){var s;const r=this._getOrCreateSection("duration");if(null===i){if(void 0===r[t])return;return delete r[t][e],void(0===Object.keys(r[t]).length&&delete r[t])}null!==(s=r[t])&&void 0!==s||(r[t]={}),r[t][e]=i}_migrateCustomFields(t,e,i){const s={},r=this._transientStorage.customFields;void 0===r||"object"==typeof r&&void 0!==r[t]||(i.forEach((e=>{const i=r[`${t}.${e}`];""!==i&&void 0!==i&&(s[e]=i,this._removeValue("customFields",`${t}.${e}`))})),this.setCustomFields(t,e,s))}_migrateDuration(t,e){const i=this._getSectionValue("duration",t);if("string"!=typeof i)return;const s={type:i},r=this._getSectionValue("durationDatetime",t);"number"==typeof r&&(s.datetime=r,this._removeValue("durationDatetime",t)),this._removeValue("duration",t),this._setDuration(t,e,s),this._syncStorage()}_syncStorage(){n.setJSON(this._persistentStorageKey,this._transientStorage)}}var ei=i(951983),ii=i(472382),si=i(198083);const ri=(0,d.getLogger)("Trading.Core"),oi={1:"Connected",2:"Connecting",3:"Disconnected",4:"Error"},ni="alert/alarm_clock";function ai(t){return b().some((e=>t===e.path))}const li=D.enabled("buy_sell_buttons"),di=!0;window.TRADING_SERVER_LOGGER_URL;class ci{constructor(t,e){this.accountType=new(u()),this.onBrokerChange=new(N()),this.onBrokerLoading=new(N()),this.onConnectionStatusChange=new(N()),this.onNewNotification=new(N()),this.onNeedSelectBroker=new(N()),this.onNotificationsChanged=new(N()),this.showTradedSources=new(u())(!0),this.showSellBuyButtons=new(u()),this.noConfirmEnabled=new(u()),this.showOnlyRejectionNotifications=new(u()),this.showPricesWithZeroVolume=new(u()),this.showSpread=new(u()),this.orderExecutedSoundParams=function(){const t=ai(ni)?ni:b()[0].path;return{enabled:new(u())(!1),path:new(u())(t)}}(),this._activeBroker=null,this._orderViewController=null,this._orderControllerPromise=null,this._brokerCommandsUI=null,this._showPricesWithZeroVolume=new(u()),this._showSpread=new(u()),this._closePositionDialogVisibility=new x.DialogVisibility,this._orderDialogVisibility=new x.DialogVisibility,this._loginDialogVisibility=new x.DialogVisibility,this._tradingPanelPopupVisibility=new x.DialogVisibility,this._tradingSettingsStorage=null,this._offlineListener=this._offlineHandler.bind(this),this._onlineListener=this._onlineHandler.bind(this),this._notifications=[],this._account=null,this._domPanelVisibility=new(u())(!1),
this._orderPanelVisibility=new(u())(!1),this._pipValueType$=new f.BehaviorSubject(S.PipValueType.None),this._switchingBroker=!1,this._isReconnectNeeded=!1,this._accountVerificationPromise=null,this._chartWidgetCollection=null,this._tradedItemsChartCollectionFacadePromise=null,this._tradeNowBrokerId=null,this.getBrokerTradingSettingsStorage=()=>this._tradingSettingsStorage,this.trackEvent=(t,e,i)=>{const s=t?`[${t}] ${e}`:e;if(this._gui()){const t=this._activeBroker?this._activeBroker.metainfo().id+" Trading":"Trading No Broker",e=this._activeBroker?this._activeBroker.currentAccountType():void 0;this._gui().trackEvent(t,s,i||e)}},this.getTradeNowBrokerId=()=>this._tradeNowBrokerId,this.clearTradeNowBrokerId=()=>{this._tradeNowBrokerId=null},this._handleVisibilityChange=()=>{null!==this._activeBroker&&this._activeBroker.metainfo().configFlags.usesWSConnection&&"visible"!==document.visibilityState&&(this._isReconnectNeeded=!0,this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!1,disconnectInfo:{disconnectType:S.DisconnectType.BrokenConnection}}).then((()=>{if(this._isReconnectNeeded)return this._tryReconnectLastBroker()})))},this._tryReconnectLastBroker=async()=>{if(this._isReconnectNeeded){if("hidden"===document.visibilityState)return window.addEventListener("visibilitychange",this._tryReconnectLastBroker,{once:!0});this._isReconnectNeeded=!1,await this._selectLastBroker()}},this._onCurrentAccountUpdate=()=>{const t=(0,s.ensureNotNull)(this._activeBroker).currentAccount();this._account!==t&&(this._tradedContextLinking.clear(),this._account=t,this.onNotificationsChanged.fire(this.getNotifications()))},this._onFullScreenDialogOpen=()=>{this._guiAccessor.closeAllNotifications()},this._setPipValueType=async()=>{const t=o.linking.proSymbol.value(),{type:e}=await this._realtimeProvider.symbolInfo(t);let i=S.PipValueType.Ticks;"crypto"===e?i=S.PipValueType.None:"forex"===e&&(i=S.PipValueType.Pips),this._pipValueType$.next(i)},this._trackNonTradableSymbol=async()=>{var t;if(1===(null===(t=this._activeBroker)||void 0===t?void 0:t.connectionStatus())){const t=o.linking.proSymbol.value();if(void 0===t)return;const e=await this._activeBroker.isTradable(t);e&&!e.tradable&&this.trackEvent("Symbol is not tradable",t)}},this._onBrokerChanged=t=>{this._tradingSettingsStorage=null!==t?new ti(t.metainfo().id):null},this._onTradingPanelVisibilityChanged=t=>{t&&(this.setOrderPanelVisibility(t),this.tradingPanel.isVisible.unsubscribe(this._onTradingPanelVisibilityChanged))},this._tradeNow=async()=>{if(void 0!==window.TradingView.bottomWidgetBar&&null!==this._tradeNowBrokerId)try{await window.TradingView.bottomWidgetBar.toggleWidget("paper_trading",!0)}catch(t){this._tradingWizard.drawAttention()}},this._setPipValueType=(0,O.sequentialize)(this._setPipValueType),this._selectBrokerInternal=(0,O.sequentialize)(this._selectBrokerInternal),this._showSellBuyButtonsKey=this._makeShowSellBuyButtonsKey(),this._resizerBridge=t,
this._realtimeProvider=new H((()=>this.activeBroker()),this.onBrokerChange,this.onConnectionStatusChange),this._positionService=new Vt.PositionsService(this),this._ordersService=new xt.OrdersService(this),this._tradingStat=new j(this),this._serverLogger=null,this._tradedContextLinking=new Ye,this.onBrokerChange.subscribe(this,this._onBrokerChanged),this.tradingPanelPopup=new Le(this),this.tradingPanelPopup.visible().subscribe((t=>{t?(this._tradingPanelPopupVisibility.setValue({isVisible:t,isFullScreen:!0}),this._onFullScreenDialogOpen()):this._tradingPanelPopupVisibility.setValue({isVisible:t})})),this.tradingPanel=new ft(t);this._qtySuggester=new Ze({onResetNeeded:this.onConnectionStatusChange,symbolInfoGetter:t=>this._realtimeProvider.symbolInfo(t),qtySettingsStorageGetter:()=>this._tradingSettingsStorage});const i=new gt(t,(()=>this.tradingPanel.close()),this,this._qtySuggester);this.tradingPanel.addPage(bt.TradingPage.DomPanel,i);const r=new mt;this.tradingPanel.addPage(bt.TradingPage.OrderPanel,r);const a=n.getValue(R.settingsKeys.TRADING_PANEL_ACTIVE_PAGE),l=n.getBool(R.settingsKeys.TRADING_PANEL_OPENED,D.enabled("show_order_panel_on_start"));a&&this.tradingPanel.activePage.setValue(a),l&&this.tradingPanel.open(),this.tradingPanel.isPageOpened(bt.TradingPage.OrderPanel)&&(this.tradingPanel.isVisible.value()?this.setOrderPanelVisibility(!0):this.tradingPanel.isVisible.subscribe(this._onTradingPanelVisibilityChanged)),(0,L.combine)((()=>({})),this.tradingPanel.activePage,this.tradingPanel.isOpened).subscribe((()=>{this._domPanelVisibility.setValue(this.tradingPanel.isPageOpened(bt.TradingPage.DomPanel)),this._orderPanelVisibility.setValue(this.tradingPanel.isPageOpened(bt.TradingPage.OrderPanel))})),this.closePositionDialogVisibility=this._closePositionDialogVisibility.value$,this.orderDialogVisibility=this._orderDialogVisibility.value$,this.loginDialogVisibility=this._loginDialogVisibility.value$,this.possibleFullScreenDialogsVisibility=(0,k.merge)(this.closePositionDialogVisibility.pipe((0,P.map)((t=>({...t,name:"close-position-dialog"})))),this.orderDialogVisibility.pipe((0,P.map)((t=>({...t,name:"order-dialog"})))),this.loginDialogVisibility.pipe((0,P.map)((t=>({...t,name:"login-dialog"})))),this._tradingPanelPopupVisibility.value$.pipe((0,P.map)((t=>({...t,name:"trading-panel-popup"})))))}setChartWidgetCollection(t){(0,s.assert)(null===this._chartWidgetCollection,"ChartWidgetCollection can be set only once"),this._chartWidgetCollection=t,this._guiAccessor=new Z(t),new Tt(this),this._loadState(),n.onSync.subscribe(this,this._loadState);const e=()=>{this._save()};this.showSellBuyButtons.subscribe(e),this.noConfirmEnabled.subscribe(e),this.showOnlyRejectionNotifications.subscribe(e),this._showPricesWithZeroVolume.subscribe(e),this._showSpread.subscribe(e),this.orderExecutedSoundParams.enabled.subscribe(e),this.orderExecutedSoundParams.path.subscribe(e),window.addEventListener("offline",this._offlineListener),window.addEventListener("online",this._onlineListener),this.bindShortcuts(),
this._tradedItemsChartCollectionFacadePromise=this._createTradedItemsChartCollectionFacade(t),this._registerCustomSources(t),this._registerCustomWidgets(t)}showPricesWith(){return{zeroVolume:this._showPricesWithZeroVolume,spread:this._showSpread}}domPanelVisibility(){return this._domPanelVisibility}orderPanelVisibility(){return this._orderPanelVisibility}realtimeProvider(){return this._realtimeProvider}toggleTradingPanelPopup(){this.tradingPanelPopup.visible().value()?this.tradingPanelPopup.hide():this.tradingPanelPopup.show()}toggleTradingWidget(){return window.TradingView.bottomWidgetBar?window.TradingView.bottomWidgetBar.activateTradingTab():Promise.resolve()}toggleMinimizeBottomWidgetBar(){if(window.TradingView.bottomWidgetBar)return window.TradingView.bottomWidgetBar.toggleMinimize()}tradingWizard(){return this._tradingWizard}showTradingProperties(){this._gui()&&this._gui().showTradingProperties()}brokersList(){return M.brokersList()}brokersPlans(){return this._getBrokerPlans()}activeBroker(){return this._activeBroker}brokerCommandsUI(){return this._brokerCommandsUI}async selectBroker(t,e){await this._selectBrokerInternal({brokerId:t,isUserAction:!0,keepSessionAlive:e})}async pickDefaultBroker(){if(this._activeBroker)return;let t=null;const e=this.brokersList().filter((t=>!t.configFlags.isSuspended));if(1===e.length)t=e[0].id;else{const i=await Ae.get();i&&e.some((t=>t.id===i))&&(t=i)}t&&this._selectBrokerInternal({brokerId:t,isUserAction:!1})}async makeNewOrderContextMenuAction(t,e,s){const o=await this._qtySuggester.getQty(t);return{name:"trade-new-order",action:()=>{this.trackEvent(e,"New Order"),this._checkAndOpenOrderDialog({symbol:t,qty:o,limitPrice:s,stopPrice:s})},text:(0,E.appendEllipsis)(r.t(null,void 0,i(967498))),statName:"NewOrder"}}async defaultContextMenuActions(t,{onlyMainActions:e=!1,gaOrigin:s="Chart Context Menu"}={}){const o=await this._qtySuggester.getQty(t.symbol),n=t.value||void 0,{bid:a,ask:l}=await this.realtimeProvider().quotesSnapshot(t.symbol),d=[];if(null!==t.value&&void 0!==l&&void 0!==a&&(t.value>=l||t.value<=a)){const e=(a+l)/2;d.push(...await this._makeSubActions(t,o,e,s))}return d.push(await this.makeNewOrderContextMenuAction(t.symbol,s,n)),!e&&D.enabled("property_pages")&&(d.push({separator:!0}),d.push({name:"trade-properties",action:()=>{this.trackEvent(s,"Trading Properties"),this.showTradingProperties()},text:(0,E.appendEllipsis)(r.t(null,void 0,i(873503))),icon:ei,statName:"Properties"})),d}defaultDropdownMenuActions(t){const e="Bottom Panel Dropdown",s=[],o=this.activeBroker(),n=t||{tradingProperties:!0,restoreConfirmations:o&&o.metainfo().configFlags.supportConfirmations};return D.enabled("property_pages")||(n.tradingProperties=!1),n.tradingProperties&&s.push({action:()=>{this.showTradingProperties(),this.trackEvent(e,"Trading Properties")},text:(0,E.appendEllipsis)(r.t(null,void 0,i(873503))),icon:ei}),n.restoreConfirmations&&s.push({action:()=>{this._showRestoreConfirmations(),this.trackEvent(e,"Restore confirmations")},text:(0,
E.appendEllipsis)(r.t(null,void 0,i(102653)))}),s}chartContextMenuActions(t,e){return(this._activeBroker&&1===this._activeBroker.connectionStatus()?this._activeBroker.chartContextMenuActions(t,e):this.defaultContextMenuActions(t,e)).then((t=>(0,C.convertActionDescriptionsToActions)(t)))}connectStatus(){return this._activeBroker?this._activeBroker.connectionStatus():3}bindShortcuts(){if(this._hotkeys)return;this._hotkeys=a.createGroup({desc:"Trading"});const t=async t=>{const e=this._gui().proSymbol(),i={qty:await this._qtySuggester.getQty(e),side:t,symbol:e,type:2,seenPrice:null};this.trackEvent("Shortcut",-1===t?"Sell":"Buy"),this._checkAndPlaceOrder(i)};this._hotkeys.add({desc:"Buy",hotkey:a.Modifiers.Shift+66,handler:()=>t(1)}),this._hotkeys.add({desc:"Sell",hotkey:a.Modifiers.Shift+83,handler:()=>t(-1)})}formatter(t){return this.realtimeProvider().formatter(t)}showSuccessNotification(t,e,i=1e4){this.showOnlyRejectionNotifications.value()||this._showNotification(t,e,"success",i),D.enabled("show_trading_notifications_history")&&this._addNotificationRow(t,e,"success",i),this._log(t,e)}showErrorNotification(t,e,i=25e3){this._showNotification(t,e,"danger",i),D.enabled("show_trading_notifications_history")&&this._addNotificationRow(t,e,"danger",i),this._log(t,e)}getNotifications(){return this._notifications.filter((t=>t.account===this._account&&t.broker===(this._activeBroker?this._activeBroker.metainfo().id:null)))}setDomPanelVisibility(t){t?this.tradingPanel.openPage(bt.TradingPage.DomPanel):this.tradingPanel.close()}setOrderPanelVisibility(t){this._getOrderViewController().then((e=>{t?e.openPanel():e.closePanel()}))}orderViewController(){return(0,s.ensureNotNull)(this._orderViewController)}tradingStat(){return this._tradingStat}async verifyBrokerLiveAccount(){return this._verifyLiveAccount(),null!==this._accountVerificationPromise?this._accountVerificationPromise:Promise.reject("Account verification is not needed")}pipValueType(){return this._pipValueType$.asObservable()}tradedItemsChartCollectionFacade(){return(0,s.ensureNotNull)(this._tradedItemsChartCollectionFacadePromise)}async checkRealtimeDataPermissions(){const t=(0,s.ensureNotNull)(this._activeBroker);await checkRealtimeDataSubscription(t.metainfo().id,t.getRealtimeDataCheckParams())&&this._guiAccessor.reconnectChartApi(!0)}async removeRealtimeDataPermissions(){await removeRealtimeDataSubscription((0,s.ensureNotNull)(this._activeBroker).metainfo().id)&&this._guiAccessor.reconnectChartApi(!0)}async _getOrderViewController(){return null!==this._orderViewController?this._orderViewController:(await this._createOrderController(),this._getOrderViewController())}async _selectBrokerInternal(t){var e;const{brokerId:s,isUserAction:o,keepSessionAlive:n=!1,disconnectInfo:a}=t;if(this._switchingBroker)return void ri.logWarn(`Broker is already selected, but a new broker id: ${s} was received.`);if(s!==(this._activeBroker?this._activeBroker.metainfo().id:null)){if(this._activeBroker){
const t=this._activeBroker&&this._activeBroker.disconnectWarningMessage(),e=()=>this._showReviewDialogIfNeeded(3,{disconnectType:S.DisconnectType.LogOut});if(null!==t&&window.is_authenticated){if(!await(0,ot.showSimpleConfirmDialog)({title:r.t(null,void 0,i(349391)),text:t,mainButtonText:r.t(null,void 0,i(162058)),mainButtonIntent:"danger",cancelButtonText:r.t(null,void 0,i(620036)),onConfirm:()=>{e(),this._logOut(o,n,a)},onCancel:()=>{e()}}))return}else e(),this._logOut(o,n,a)}if(null!=s){let t;this._tradeNowBrokerId=null,this._switchingBroker=!0;try{const e=await M.createBrokerConnection(this,s,this._serverLogger,null,t),{isMaintenance:i,message:r}=await e.maintenanceStatus();if(i){if(!await this._showBrokerSideMaintenanceWarning(e.metainfo().id,r))return this._switchingBroker=!1,void e.disconnect(!0)}0,await this._initBroker(e,n)}catch(t){this._switchingBroker=!1,ri.logError((0,T.getLoggerMessage)(t))}}else o&&setTimeout((()=>{Ae.clear()})),this.onBrokerChange.fire(null),null===(e=this._closePositionDialogVisibilitySubscription)||void 0===e||e.unsubscribe(),this._brokerCommandsUI=null}else ri.logWarn(`${s} is already selected.`)}async _initBroker(t,e){this._activeBroker=t,this._activeBroker.connectionStatusUpdate.subscribe(this,this._connectionListener),this._activeBroker.currentAccountUpdate.subscribe(this,this._onCurrentAccountUpdate),this._realtimeProvider.onStatusChanged.subscribe(null,this._setPipValueType),o.linking.proSymbol.subscribe(this._setPipValueType),this._realtimeProvider.onStatusChanged.subscribe(null,this._trackNonTradableSymbol),o.linking.proSymbol.subscribe(this._trackNonTradableSymbol),this._brokerCommandsUI=new _t(this._activeBroker,this._guiAccessor,this.noConfirmEnabled,this._getOrderViewController.bind(this),this.showErrorNotification.bind(this),this.trackEvent),this._closePositionDialogVisibilitySubscription=this._brokerCommandsUI.closePositionDialogVisibility.subscribe(this._makeDialogVisibilityHandler(this._closePositionDialogVisibility)),this._activeBroker.tryRestoreSession(),await Ae.set(this._activeBroker.metainfo().id),this.onBrokerChange.fire(this._activeBroker),this._getOrderViewController(),this._updateConnectionStatus(this.connectStatus()),this._switchingBroker=!1}async _showBrokerSideMaintenanceWarning(t,e){return(0,ot.showSimpleConfirmDialog)({title:r.t(null,{replace:{brokerId:t}},i(103718)),text:null!=e?e:r.t(null,void 0,i(536263)),cancelButtonText:r.t(null,void 0,i(620036)),mainButtonIntent:"primary",mainButtonText:r.t(null,void 0,i(891268)),showBackdrop:!0})}_makeDialogVisibilityHandler(t){return e=>{t.setValue(e),e.isFullScreen&&this._onFullScreenDialogOpen()}}_gui(){return this._guiAccessor}_addNotificationRow(t,e,i,s){const r={id:this._notifications.length,account:this._account,broker:this._activeBroker?this._activeBroker.metainfo().id:null,time:new Date,title:t,text:e,type:i};this._notifications.push(r),this.onNewNotification.fire(r)}_offlineHandler(){this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!1,disconnectInfo:{
disconnectType:S.DisconnectType.Offline}}),ri.logNormal("The connection to the Internet was interrupted")}async _onlineHandler(){await this._selectLastBroker()&&ri.logNormal("The connection to the Internet was restored")}_showNotification(t,e,i,s){this._gui()&&this._gui().showNotification(t,e,i,s)}_showReviewDialogIfNeeded(t,e){if(null===this._activeBroker)return;this._activeBroker}_connectionListener(t,e){const i=this.connectStatus();this._showReviewDialogIfNeeded(t,e);const s=this._isReconnectNeeded=(null==e?void 0:e.disconnectType)===S.DisconnectType.BrokenConnection;3!==t||(null==e?void 0:e.disconnectType)!==S.DisconnectType.LogOut&&!this._isReconnectNeeded||this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!1,disconnectInfo:e}).then((()=>{if(this._isReconnectNeeded)return this._tryReconnectLastBroker()})),(null==e?void 0:e.disconnectType)===S.DisconnectType.CancelAuthorization&&this.trackEvent("Signin","OAuth popup closed","By user"),(null==e?void 0:e.disconnectType)===S.DisconnectType.TimeOutForAuthorization&&this.trackEvent("Signin","OAuth popup closed","By timeout"),this._updateConnectionStatus(i,!s,e)}async _selectLastBroker(){const t=await Ae.get();return null!==t&&(await this._selectBrokerInternal({brokerId:t,isUserAction:!1}),!0)}_updateOrderPanelSpinnerState(){const t=this._orderViewController,e=2===this.connectStatus(),i=null!==t&&t.stateChanging.value();this.tradingPanel.isLoading.setValue(e||i)}async _updateConnectionStatus(t,e=!0,i){var s;this._updateOrderPanelSpinnerState(),this.onConnectionStatusChange.fire(t,i),this._log("Connection status",oi[t]);this._activeBroker;if(e){const t=null===(s=this._activeBroker)||void 0===s?void 0:s.metainfo().id;void 0!==t?await Ae.set(t):Ae.clear()}null!==this._activeBroker?1===t?(this._account=this._activeBroker.currentAccount(),this._guiAccessor.setBroker(this._activeBroker)):this._tradedContextLinking.clear():(this._accountVerificationPromise=null,this._guiAccessor.setBroker(null),this._tradedContextLinking.clear())}async _checkOrRemoveRealtimeDataIfNeeded(t){if(!t.configFlags.supportRealtimeDataCheck)return;const{realtimeDataPermissionsToggleConfig:e}=t;if(void 0===e)return void this.checkRealtimeDataPermissions();const s=`${R.settingsKeys.REALTIME_DATA_ACCEPTED}.${t.id}`;switch(n.getValue(s)){case"true":return void this.checkRealtimeDataPermissions();case"false":return void this.removeRealtimeDataPermissions();default:const t=await(0,ot.showSimpleConfirmDialog)({title:r.t(null,void 0,i(75715)),text:e.enableRealtimeDataPermissionsToggleText,mainButtonText:r.t(null,void 0,i(83453)),cancelButtonText:r.t(null,void 0,i(546472)),showCloseButton:!1,closeOnOutsideClick:!1,mainButtonIntent:"primary",closeOnEscapePress:!1});t?await this.checkRealtimeDataPermissions():await this.removeRealtimeDataPermissions(),n.setValue(s,t)}}_verifyLiveAccount(){if(null!==this._accountVerificationPromise)return;const t=(0,s.ensureNotNull)(this._activeBroker);t.metainfo().configFlags.supportVerifyLiveAccount&&(t.currentAccountType(),S.AccountType.Live)}_save(){
const t=n.getJSON(R.settingsKeys.PROPERTIES,{});n.setJSON(R.settingsKeys.PROPERTIES,{...t,[this._showSellBuyButtonsKey]:+!!this.showSellBuyButtons.value(),noConfirmEnabled:+!!this.noConfirmEnabled.value(),qweqrq:+!!this.showOnlyRejectionNotifications.value(),showPricesWithZeroVolume:+!!this._showPricesWithZeroVolume.value(),showSpread:+!!this._showSpread.value(),orderExecutedSoundParams:JSON.stringify({enabled:+!!this.orderExecutedSoundParams.enabled.value(),name:this.orderExecutedSoundParams.path.value()})})}_loadState(){const t=n.getJSON(R.settingsKeys.PROPERTIES,{}),e=t[this._showSellBuyButtonsKey];if(this.showSellBuyButtons.setValue(void 0!==e?!!e:di),this.noConfirmEnabled.setValue(!!t.noConfirmEnabled),this.showOnlyRejectionNotifications.setValue(!!t.qweqrq),this._showPricesWithZeroVolume.setValue(!t.hasOwnProperty("showPricesWithZeroVolume")||t.showPricesWithZeroVolume),this._showSpread.setValue(!t.hasOwnProperty("showSpread")||t.showSpread),t.hasOwnProperty("orderExecutedSoundParams")){const e=JSON.parse(t.orderExecutedSoundParams);this.orderExecutedSoundParams.enabled.setValue(!!e.enabled),this.orderExecutedSoundParams.path.setValue(ai(e.name)?e.name:this.orderExecutedSoundParams.path.value())}}_makeShowSellBuyButtonsKey(){return"showSellBuyButtons"}_log(t,e){ri.logNormal(`${this._activeBroker?this._activeBroker.metainfo().id+" Trading: ":""}${t} - ${e}`)}_makeSureCanTrade(){const t=this.activeBroker(),e=this.brokerCommandsUI();return t&&e?1===t.connectionStatus()||(this.toggleTradingWidget(),!1):(this.toggleTradingWidget().then((()=>this.onNeedSelectBroker.fire())),!1)}_checkAndPlaceOrder(t,e=!0){this._makeSureCanTrade()&&(0,s.ensureNotNull)(this.brokerCommandsUI()).placeOrder(t,e)}_checkAndOpenOrderDialog(t){this._makeSureCanTrade()&&(0,s.ensureNotNull)(this.brokerCommandsUI()).placeOrder(t)}_makeSubAction({context:t,side:e,orderType:s,orderPrices:o,currentQuotes:n,qty:a,gaOrigin:l}){const d=1===e?si:ii,c=1===e?"Buy":"Sell",u=1===s?"Limit":3===s?"Stop":"StopLimit",h=function(t){return"altPrice"in t&&"formattedAltPrice"in t}(o),p=c+u,_={BuyLimit:r.t(null,void 0,i(302122)).format({symbol:t.displaySymbol,qty:(0,I.abbreviatedNumber)(a),value:o.formattedPrice}),SellStop:r.t(null,void 0,i(627392)).format({symbol:t.displaySymbol,qty:(0,I.abbreviatedNumber)(a),value:o.formattedPrice}),SellLimit:r.t(null,void 0,i(476678)).format({symbol:t.displaySymbol,qty:(0,I.abbreviatedNumber)(a),value:o.formattedPrice}),BuyStop:r.t(null,void 0,i(255481)).format({symbol:t.displaySymbol,qty:(0,I.abbreviatedNumber)(a),value:o.formattedPrice})};return h&&(_.SellStopLimit=r.t(null,void 0,i(194240)).format({symbol:t.displaySymbol,qty:(0,I.abbreviatedNumber)(a),value:o.formattedPrice,altValue:o.formattedAltPrice}),_.BuyStopLimit=r.t(null,void 0,i(353343)).format({symbol:t.displaySymbol,qty:(0,I.abbreviatedNumber)(a),value:o.formattedPrice,altValue:o.formattedAltPrice})),{name:`trade-${c}-${u}`.toLowerCase(),action:()=>{this.trackEvent(l,`${c} ${u}`)
;const i=1===s?"limitPrice":"stopPrice",r=1===e?null==n?void 0:n.ask:null==n?void 0:n.bid,d={qty:a,side:e,symbol:t.symbol,type:s,seenPrice:null!=r?r:null,currentQuotes:n};null!==o.price&&(d[i]=o.price),4===s&&h&&(d.limitPrice=o.altPrice),this._checkAndPlaceOrder(d)},icon:d,text:_[p],statName:p}}_createOrderController(){return null===this._orderControllerPromise&&(this._orderControllerPromise=Promise.all([i.e(9863),i.e(7953),i.e(245),i.e(660)]).then(i.bind(i,683e3)).then((({OrderViewController:t})=>new t({resizerBridge:this._resizerBridge,onNeedSelectBroker:this.onNeedSelectBroker,realtimeProvider:this.realtimeProvider(),pipValueType$:this.pipValueType(),trackEvent:this.trackEvent,toggleTradingWidget:this.toggleTradingWidget.bind(this),toggleTradingPanelPopup:this.toggleTradingPanelPopup.bind(this),showErrorNotification:this.showErrorNotification.bind(this),getTradingSettingsStorage:()=>this._tradingSettingsStorage},{container:this.tradingPanel.container,isOpened:this.tradingPanel.isOpened,isVisible:this.tradingPanel.isVisible,activePage:this.tradingPanel.activePage,close:this.tradingPanel.close.bind(this.tradingPanel),openPage:this.tradingPanel.openPage.bind(this.tradingPanel)},this._qtySuggester))).then((t=>{this._orderControllerPromise=null,this._orderViewController=t,this._orderViewController.stateChanging.subscribe((()=>this._updateOrderPanelSpinnerState())),this._orderViewController.dialogVisibility.subscribe(this._makeDialogVisibilityHandler(this._orderDialogVisibility))}))),this._orderControllerPromise}async _registerCustomSources(t){!async function(t,e){const s=await Promise.all([i.e(2915),i.e(2650)]).then(i.bind(i,825652));t.addCustomSource("bidask",((i,r)=>new s.BidAsk(i,r,e.realtimeProvider(),(()=>{t.activeChartWidget.value().showGeneralChartProperties(V.TabNames.symbol)}))))}(t,this),Nt(t,this,this.showTradedSources);new((await Promise.all([i.e(7624),i.e(9333),i.e(6092),i.e(7507),i.e(2915),i.e(8550),i.e(1652)]).then(i.bind(i,622667))).TradedSourcesManager)(this._ordersService,this._positionService,t,{activeTradedLinking:this._tradedContextLinking,showTradedSources:this.showTradedSources,realtimeProvider:this._realtimeProvider,qtySuggester:this._qtySuggester,brokerCommandsUI:this.brokerCommandsUI.bind(this),trackEvent:this.trackEvent,pipValueType$:this.pipValueType()})}_registerCustomWidgets(t){li&&function(t,e,i){t.addCustomWidgetToLegend(((t,s)=>{const r=t.mainSeries(),o=(0,Lt.createWVFromGetterAndSubscription)(t.isInReplay.bind(t),t.onInReplayStateChanged()),n=(0,Lt.createWVFromGetterAndSubscriptions)((()=>{var t;return"economic"===(null===(t=r.symbolInfo())||void 0===t?void 0:t.type)}),[r.dataEvents().symbolResolved(),r.dataEvents().symbolError()]);return new be(r.dataEvents(),function(t){return()=>{const e=t.symbolInfo();return null!==e?e.pro_name||e.full_name||e.name||"":t.proSymbol()}}(r),n,i,{onNeedSelectBroker:e.onNeedSelectBroker,realtimeProvider:e.realtimeProvider(),onBrokerConnectionStatusChange:e.onConnectionStatusChange,brokerConnectionStatus:e.connectStatus.bind(e),trackEvent:e.trackEvent,
toggleTradingWidget:e.toggleTradingWidget.bind(e),toggleTradingPanelPopup:e.toggleTradingPanelPopup.bind(e),brokerCommandsUI:e.brokerCommandsUI.bind(e),toggleMinimizeBottomWidgetBar:()=>e.toggleMinimizeBottomWidgetBar()},{showSellBuyButtons:e.showSellBuyButtons,noConfirmEnabled:e.noConfirmEnabled,themeName:s},o)}),{block:0,position:0})}(t,this,this._qtySuggester)}async _makeSubActions(t,e,i,s){const r=[];if(null===t.value)return r;const o=this.activeBroker();let n,a,l,d,c,u,h,p,_,g,m,b,y,v=null===o,f=null===o,k=null===o,P=null===o;const S=t.symbol;null!==o&&1===o.connectionStatus()&&(y=await o.isTradable(S));const[C,E,O]=await Promise.all([this._realtimeProvider.symbolInfo(S),this._realtimeProvider.formatter(S),this._realtimeProvider.quotesSnapshot(S)]),D=C.variableMinTick?(0,B.makeVariableMinTickData)(C.minTick,C.variableMinTick):void 0,I=t=>(0,B.getMinTick)({minTick:C.minTick,price:t,variableMinTickData:D});if(null!==o&&y&&y.tradable){const e=o.metainfo().configFlags,i=(0,w.alignToStep)(t.value,I(t.value));n=i,l=i,d=i,a=i,c=d+I(d),u=a-I(a),v=Boolean(e.supportLimitOrders),f=Boolean(e.supportStopOrders),k=Boolean(e.supportStopOrdersInBothDirectionsInUI),P=Boolean(e.supportStopLimitOrders),void 0!==C.limitPriceStep&&(n=(0,T.roundToStepByPriceTypeAndSide)(t.value,C.limitPriceStep,1,1),l=(0,T.roundToStepByPriceTypeAndSide)(t.value,C.limitPriceStep,1,-1),c=(0,T.roundToStepByPriceTypeAndSide)(t.value+I(t.value),C.limitPriceStep,1,1),u=(0,T.roundToStepByPriceTypeAndSide)(t.value-I(t.value),C.limitPriceStep,1,-1)),void 0!==C.stopPriceStep&&(d=(0,T.roundToStepByPriceTypeAndSide)(t.value,C.stopPriceStep,2,1),a=(0,T.roundToStepByPriceTypeAndSide)(t.value,C.stopPriceStep,2,-1)),h=E.format(n),p=E.format(a),_=E.format(l),g=E.format(d),m=E.format(c),b=E.format(u)}else n=l=d=a=t.value,h=p=_=g=t.formattedValue,c=d+I(d),u=a-I(a),m=E.format(c),b=E.format(u);let L;if(void 0!==O.ask&&void 0!==O.bid&&(L={ask:O.ask,bid:O.bid}),t.value<=i){if(v){const i={price:n,formattedPrice:h};r.push(this._makeSubAction({context:t,side:1,orderType:1,orderPrices:i,qty:e,gaOrigin:s,currentQuotes:L}))}if(k){const i={price:d,formattedPrice:g};r.push(this._makeSubAction({context:t,side:1,orderType:3,orderPrices:i,qty:e,gaOrigin:s,currentQuotes:L}))}if(f||k){const i={price:a,formattedPrice:p};r.push(this._makeSubAction({context:t,side:-1,orderType:3,orderPrices:i,qty:e,gaOrigin:s,currentQuotes:L}))}if(P){const i={price:a,formattedPrice:p,altPrice:u,formattedAltPrice:b};r.push(this._makeSubAction({context:t,side:-1,orderType:4,orderPrices:i,qty:e,gaOrigin:s,currentQuotes:L}))}}else{if(v){const i={price:l,formattedPrice:_};r.push(this._makeSubAction({context:t,side:-1,orderType:1,orderPrices:i,qty:e,gaOrigin:s,currentQuotes:L}))}if(k){const i={price:a,formattedPrice:p};r.push(this._makeSubAction({context:t,side:-1,orderType:3,orderPrices:i,qty:e,gaOrigin:s,currentQuotes:L}))}if(f||k){const i={price:d,formattedPrice:g};r.push(this._makeSubAction({context:t,side:1,orderType:3,orderPrices:i,qty:e,gaOrigin:s,currentQuotes:L}))}if(P){const i={price:d,
formattedPrice:g,altPrice:c,formattedAltPrice:m};r.push(this._makeSubAction({context:t,side:1,orderType:4,orderPrices:i,qty:e,gaOrigin:s,currentQuotes:L}))}}return r}_initPaidBrokersByUserRegion(){this._brokersListPromise=fetch("/api/v1/brokers/trading_panel",{method:"GET"}).then((t=>t.json())).catch((t=>{ri.logWarn("Failed to fetch brokers info: "+t)}))}async _getBrokerPlans(){let t=[];try{if(t=await this._brokersListPromise,!Array.isArray(t))throw new Error("Request result is not valid")}catch(t){ri.logError(`Failed to fetch broker list by user region: ${t.message}`)}return t}async _checkCQGCredentials(t){}async _showRestoreConfirmations(){const t=await(0,ot.showSimpleConfirmDialog)({title:r.t(null,void 0,i(102653)),text:r.t(null,void 0,i(526227)),mainButtonIntent:"primary"});null!==this._activeBroker&&t&&(new Ne.DisabledConfirmations).clear()}_logOut(t,e,i){const r=(0,s.ensureNotNull)(this._activeBroker);r.connectionStatusUpdate.unsubscribe(this,this._connectionListener),r.currentAccountUpdate.unsubscribe(this,this._onCurrentAccountUpdate),this._realtimeProvider.onStatusChanged.unsubscribe(null,this._setPipValueType),o.linking.proSymbol.unsubscribe(this._setPipValueType),this._realtimeProvider.onStatusChanged.unsubscribe(null,this._trackNonTradableSymbol),o.linking.proSymbol.unsubscribe(this._trackNonTradableSymbol),r.disconnect(e||!t),r.destroy(),this._activeBroker=null,this._updateConnectionStatus(3,t,i)}async _createTradedItemsChartCollectionFacade(t){return new((await Promise.all([i.e(2915),i.e(2650)]).then(i.bind(i,138504))).TradedItemsChartCollectionFacade)(t)}_tradeNowInit(){const t=new URL(decodeURIComponent(window.location.href)),e=t.searchParams.get("trade-now");t.searchParams.delete("trade-now"),window.history.replaceState(null,document.title,t.toString()),null===e||isMobileTradingAvailable()||(this._tradeNowBrokerId=e,Ae.clear())}}},886630:(t,e,i)=>{"use strict";i.d(e,{qtyErrors:()=>n,checkQtyError:()=>l});var s=i(509806),r=i(960521),o=i.n(r);const n={min:s.t(null,void 0,i(430999)),max:s.t(null,void 0,i(734266)),step:s.t(null,void 0,i(136443)),balance:s.t(null,void 0,i(409232))},a=(s.t(null,void 0,i(611835)),s.t(null,void 0,i(706035)));function l(t,e,i=!1){if(null===e)return{res:!0,msg:a};const s=t.step,r=t.min,l=t.max;if(e<r)return{res:!0,msg:n.min.format({min:r.toString()})};if(e>l)return{res:!0,msg:n.max.format({max:l.toString()})};const d=new(o())(e).minus(r).mod(s);return i&&!d.eq(0)?{res:!0,msg:n.step.format({step:s.toString()})}:{res:!1}}},578291:(t,e,i)=>{"use strict";i.d(e,{validatePrice:()=>d});var s=i(509806),r=i(960521),o=i.n(r),n=i(842974);const a=s.t(null,void 0,i(134986));function l(t,e){return o()(t).minus(e).abs().gt(o()(t).div(2))}function d(t){const{price:e,askOrBid:r,orderType:d,side:c,isStopPrice:u,isForex:h,formatter:p,supportStopOrdersInBothDirections:_,supportStopLimitOrdersInBothDirections:g,step:m,roundedToStep:b}=t;if((!h||b)&&!1===(0,n.isMintickMultiple)(e,m))return{res:!0,severity:"error",msg:s.t(null,void 0,i(130927)).format({minTick:p.format(m)})}
;const y=e<0||o()(r).mul(100).lt(e)||function(t){const{price:e,askOrBid:i,orderType:s,side:r,isStopPrice:o,supportStopOrdersInBothDirections:n,supportStopLimitOrdersInBothDirections:a}=t;return 1===s?1===r?e>i&&l(i,e):e<i&&l(i,e):!!(3===s&&!n||4===s&&o&&!a)&&(1===r?e<i:e>i)}({price:e,askOrBid:r,orderType:d,side:c,isStopPrice:u,supportStopOrdersInBothDirections:_,supportStopLimitOrdersInBothDirections:g});return y?{res:!0,severity:"error",msg:a}:{res:!1}}},212775:(t,e,i)=>{"use strict";i.d(e,{abbreviatedNumber:()=>o});var s=i(66568);const r=["","K","M","G","T","Y"];function o(t){if(t<1)return s.NumericFormatter.formatNoE(t);let e=0,i=+t;if(isFinite(i))for(;i>=1e3&&i%100==0;)e++,i/=1e3;return i+(e<r.length?r[e]:"e"+3*e)}},337883:(t,e,i)=>{"use strict";function s(t){let e=Promise.resolve();return function(...i){const s=e.then((()=>t.apply(this,i)));return e=s.catch((()=>{})),s}}i.d(e,{sequentialize:()=>s})},198083:t=>{t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M19.9792 16.6205C19.7396 16.8955 19.3241 16.9285 19.044 16.6948L14.3924 12.8117L14.072 12.5442L13.7516 12.8117L9.10009 16.6947C8.82008 16.9285 8.40456 16.8955 8.16495 16.6205C7.92467 16.3447 7.94981 15.9272 8.22144 15.6822L14.0721 10.4057L19.9227 15.6822C20.1943 15.9272 20.2195 16.3447 19.9792 16.6205ZM18.4032 17.4624C19.1009 18.0448 20.1362 17.9626 20.7332 17.2774C21.3318 16.5902 21.2692 15.55 20.5924 14.9396L14.407 9.36109L14.0721 9.05908L13.7373 9.36109L7.55171 14.9396C6.87492 15.55 6.81229 16.5902 7.41096 17.2774C8.00796 17.9626 9.04326 18.0448 9.74094 17.4624L14.072 13.8468L18.4032 17.4624Z"/></svg>'},472382:t=>{t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M19.9792 12.2892C19.7396 12.0142 19.3241 11.9812 19.044 12.2149L14.3924 16.098L14.072 16.3655L13.7516 16.098L9.10009 12.2149C8.82008 11.9812 8.40456 12.0142 8.16495 12.2892C7.92467 12.565 7.94981 12.9825 8.22144 13.2275L14.0721 18.504L19.9227 13.2275C20.1943 12.9825 20.2195 12.565 19.9792 12.2892ZM18.4032 11.4472C19.1009 10.8648 20.1362 10.9471 20.7332 11.6323C21.3318 12.3195 21.2692 13.3597 20.5924 13.9701L14.407 19.5486L14.0721 19.8506L13.7373 19.5486L7.55171 13.9701C6.87492 13.3597 6.81229 12.3195 7.41096 11.6323C8.00796 10.9471 9.04326 10.8648 9.74094 11.4473L14.072 15.0628L18.4032 11.4472Z"/></svg>'},507720:t=>{t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 17" width="17" height="17" fill="currentColor"><path d="m.58 1.42.82-.82 15 15-.82.82z"/><path d="m.58 15.58 15-15 .82.82-15 15z"/></svg>'},816105:t=>{
t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" width="72" height="72" fill="none"><g clip-path="url(#clip0)"><path fill="#363A45" fill-rule="evenodd" clip-rule="evenodd" d="M62.1259 28.2153C61.4066 28.8157 61.0001 29.7273 61.0858 30.6604C61.6716 37.0347 59.7763 44.3291 55.3181 50.8221C46.9016 63.0797 32.5383 67.839 23.2366 61.4522C13.935 55.0654 13.2174 39.9512 21.6339 27.6935C26.4984 20.6088 33.3496 16.029 40.0619 14.6585C40.9752 14.472 41.731 13.8291 42.1024 12.9741C42.485 12.0934 42.9606 11.2346 43.5313 10.4123C47.906 4.1093 56.2129 2.33004 62.0853 6.4382C67.9578 10.5464 69.172 18.9863 64.7974 25.2892C64.0194 26.4103 63.1169 27.3882 62.1259 28.2153Z"/><rect width="47.2" height="34" fill="#1E222D" stroke="#B2B5BE" stroke-width="2" rx="3.8" x="12.4004" y="16"/><path stroke="#B2B5BE" stroke-linecap="round" stroke-width="2" d="M3.59961 54H67.1996"/><path fill="#B2B5BE" fill-rule="evenodd" clip-rule="evenodd" d="M29.1178 31.1324L30.8107 32.8253L32.225 31.4111L30.5321 29.7182L32.225 28.0253L30.8107 26.6111L29.1178 28.304L27.425 26.6111L26.0107 28.0253L27.7036 29.7182L26.0107 31.4111L27.425 32.8253L29.1178 31.1324Z"/><path fill="#B2B5BE" fill-rule="evenodd" clip-rule="evenodd" d="M43.5182 31.1324L45.2111 32.8253L46.6253 31.4111L44.9325 29.7182L46.6253 28.0253L45.2111 26.6111L43.5182 28.304L41.8253 26.6111L40.4111 28.0253L42.104 29.7182L40.4111 31.4111L41.8253 32.8253L43.5182 31.1324Z"/><path stroke="#B2B5BE" stroke-width="2" d="M30.5996 38.7H40.7996"/></g></svg>'},627687:t=>{t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" width="72" height="72" fill="none"><g clip-path="url(#clip0)"><path fill="#F0F3FA" fill-rule="evenodd" clip-rule="evenodd" d="M62.1259 28.2153C61.4066 28.8157 61.0001 29.7273 61.0858 30.6604C61.6716 37.0347 59.7763 44.3291 55.3181 50.8221C46.9016 63.0797 32.5383 67.839 23.2366 61.4522C13.935 55.0654 13.2174 39.9512 21.6339 27.6935C26.4984 20.6088 33.3496 16.029 40.0619 14.6585C40.9752 14.472 41.731 13.8291 42.1024 12.9741C42.485 12.0934 42.9606 11.2346 43.5313 10.4123C47.906 4.1093 56.2129 2.33004 62.0853 6.4382C67.9578 10.5464 69.172 18.9863 64.7974 25.2892C64.0194 26.4103 63.1169 27.3882 62.1259 28.2153Z"/><rect width="47.2" height="34" fill="#fff" stroke="#1E222D" stroke-width="2" rx="3.8" x="12.4004" y="16"/><path stroke="#1E222D" stroke-linecap="round" stroke-width="2" d="M3.59961 54H67.1996"/><path fill="#000" fill-rule="evenodd" clip-rule="evenodd" d="M29.1178 31.1324L30.8107 32.8253L32.225 31.4111L30.5321 29.7182L32.225 28.0253L30.8107 26.6111L29.1178 28.304L27.425 26.6111L26.0107 28.0253L27.7036 29.7182L26.0107 31.4111L27.425 32.8253L29.1178 31.1324Z"/><path fill="#000" fill-rule="evenodd" clip-rule="evenodd" d="M43.5182 31.1324L45.2111 32.8253L46.6253 31.4111L44.9325 29.7182L46.6253 28.0253L45.2111 26.6111L43.5182 28.304L41.8253 26.6111L40.4111 28.0253L42.104 29.7182L40.4111 31.4111L41.8253 32.8253L43.5182 31.1324Z"/><path stroke="#000" stroke-width="2" d="M30.5996 38.7H40.7996"/></g></svg>'},829883:t=>{
t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 16" width="20" height="16"><path fill="currentColor" fill-rule="evenodd" d="M7.5 2.5C7.5 1.67 8.17 1 9 1h2c.83 0 1.5.67 1.5 1.5v.15h-5V2.5zm6 0v.15H17a2.5 2.5 0 0 1 2.5 2.5v8.35A2.5 2.5 0 0 1 17 16H3a2.5 2.5 0 0 1-2.5-2.5V5.15A2.5 2.5 0 0 1 3 2.65h3.5V2.5A2.5 2.5 0 0 1 9 0h2a2.5 2.5 0 0 1 2.5 2.5zm-12 2.65c0-.83.67-1.5 1.5-1.5h14c.83 0 1.5.67 1.5 1.5v8.35c0 .83-.67 1.5-1.5 1.5H3a1.5 1.5 0 0 1-1.5-1.5V5.15zM9.25 6.5a1.75 1.75 0 1 0 0 3.5h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75h-1c0 .97.78 1.75 1.75 1.75h.25v1h1v-1h.25a1.75 1.75 0 1 0 0-3.5h-1.5a.75.75 0 0 1 0-1.5h1.5c.41 0 .75.34.75.75h1c0-.97-.78-1.75-1.75-1.75h-.25v-1h-1v1h-.25z"/></svg>'},585161:(t,e,i)=>{"use strict";t.exports=i.p+"alarm_clock.ba219c712b5dce956b08.mp3"}}]);