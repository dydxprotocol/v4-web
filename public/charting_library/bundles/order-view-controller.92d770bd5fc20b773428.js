(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[660],{58825:e=>{e.exports={mobile:"screen and (max-width: 567px)"}},22452:(e,t,i)=>{"use strict";i.d(t,{parsePrice:()=>r,generateSingleDirectionItems:()=>o,generatePriceRangeFrom:()=>n,getDropdownItemsForDevice:()=>a});var s=i(37678);function r(e,t,i){if(t.parse){const i=t.parse(e);if(i.res)return i.value}return void 0!==i?i:parseFloat(e)}function o(e,t,i,s,r){const o=Array.from({length:e},function(e,t,i,s){return(r,o)=>s.format(e+i*t*(o+1))}(t,i,s,r));return 1===s?o.reverse():o}function n(e,t,i,s){return[...o(s,e,t,1,i),i.format(e),...o(s,e,t,-1,i)]}function a(){return"phone"!==s.mediaState.device&&"phone-vertical"!==s.mediaState.device?6:4}},46055:(e,t,i)=>{"use strict";i.d(t,{OrderPanelStatus:()=>s,OrderPlacingStatus:()=>r,OrderEditorDisplayMode:()=>o,PriceType:()=>n,BracketDefaultPips:()=>a,BracketSubControlType:()=>l,QuantitySubControlType:()=>u,PriceSubControlType:()=>h,CalculatorDecKeyCodes:()=>d,CalculatorIncKeyCodes:()=>c,Context:()=>b,orderTypes:()=>y});var s,r,o,n,a,l,u,h,d,c,p=i(67294),_=i(74245);!function(e){e[e.Wait=0]="Wait",e[e.Active=1]="Active",e[e.Editing=2]="Editing",e[e.Preview=3]="Preview"}(s||(s={})),function(e){e[e.Creating=0]="Creating",e[e.Placed=1]="Placed"}(r||(r={})),function(e){e.Popup="popup",e.Panel="panel"}(o||(o={})),function(e){e[e.Stop=0]="Stop",e[e.Limit=1]="Limit"}(n||(n={})),function(e){e[e.TakeProfit=75]="TakeProfit",e[e.StopLoss=25]="StopLoss"}(a||(a={})),function(e){e.Price="Price",e.Pips="Pips",e.Money="Money",e.Percent="Percent"}(l||(l={})),function(e){e.Units="Units",e.RiskInCurrency="RiskInCurrency",e.RiskInPercent="RiskInPercent",e.BaseCurrency="BaseCurrency",e.QuoteCurrency="QuoteCurrency"}(u||(u={})),function(e){e.Absolute="Absolute",e.Relative="Relative"}(h||(h={})),function(e){e[e.Minus=189]="Minus",e[e.NumMinus=109]="NumMinus",e[e.FirefoxMinus=173]="FirefoxMinus"}(d||(d={})),function(e){e[e.Plus=187]="Plus",e[e.NumPlus=107]="NumPlus",e[e.FirefoxPlus=61]="FirefoxPlus"}(c||(c={}));const b=p.createContext({resizerWidth:null,mode:o.Panel,supportTrailingStop:!1}),y={1:(0,_.t)("Limit"),2:(0,_.t)("Market"),3:(0,_.t)("Stop"),4:(0,_.t)("Stop Limit")}},37016:(e,t,i)=>{"use strict";i.d(t,{defaultSettings:()=>r,defaultCryptoBracketsSettings:()=>o,SettingsContext:()=>n});var s=i(67294);const r={showRelativePriceControl:!0,showCurrencyRiskInQty:!0,showPercentRiskInQty:!0,showBracketsInCurrency:!0,showBracketsInPercent:!0,showOrderPreview:!0,showCryptoBracketsInCurrency:!1,showCryptoBracketsInPercent:!1},o={showCryptoBracketsInCurrency:!1,showCryptoBracketsInPercent:!1},n=s.createContext({value:r,setValue:e=>{console.warn("unable to modify order ticket settings because context.setValue is not defined")}})},43025:(e,t,i)=>{"use strict";i.r(t),i.d(t,{OrderViewController:()=>Bt});var s=i(69671),r=i(79442),o=i(16282),n=i(7424),a=i(19160),l=i.n(a),u=i(74245),h=i(28353),d=i(25038),c=i(65583),p=i(98536),_=i(29127),b=i(53741),y=i(86515),g=i(81480),P=i(58474),m=i(35987),v=Array.isArray;function f(e){return(0,
_.map)((function(t){return function(e,t){return v(t)?e.apply(void 0,(0,m.__spreadArray)([],(0,m.__read)(t),!1)):e(t)}(e,t)}))}function k(e,t,i){return i?k(e,t).pipe(f(i)):new g.Observable((function(i){var s=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i.next(1===e.length?e[0]:e)},r=e(s);return(0,P.isFunction)(t)?function(){return t(s,r)}:void 0}))}var S=i(48346),M=i(16716),C=i(87878);var w={connector:function(){return new M.Subject},resetOnDisconnect:!0};function V(e,t){void 0===t&&(t=w);var i=null,s=t.connector,r=t.resetOnDisconnect,o=void 0===r||r,n=s(),a=new g.Observable((function(e){return n.subscribe(e)}));return a.connect=function(){var t;return i&&!i.closed||(i=(t=function(){return e},new g.Observable((function(e){(0,C.innerFrom)(t()).subscribe(e)}))).subscribe(n),o&&i.add((function(){return n=s()}))),i},a}var T=Array.isArray,O=Object.getPrototypeOf,I=Object.prototype,B=Object.keys;function $(e){if(1===e.length){var t=e[0];if(T(t))return{args:t,keys:null};if((s=t)&&"object"==typeof s&&O(s)===I){var i=B(t);return{args:i.map((function(e){return t[e]})),keys:i}}}var s;return{args:e,keys:null}}var F=i(11954),R=i(90278),q=i(57617);function L(e,t){return e.reduce((function(e,i,s){return e[i]=t[s],e}),{})}var D=i(2566),E=i(47845);function N(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=(0,q.popScheduler)(e),s=(0,q.popResultSelector)(e),r=$(e),o=r.args,n=r.keys;if(0===o.length)return(0,F.from)([],i);var a=new g.Observable(x(o,i,n?function(e){return L(n,e)}:R.identity));return s?a.pipe(f(s)):a}function x(e,t,i){return void 0===i&&(i=R.identity),function(s){j(t,(function(){for(var r=e.length,o=new Array(r),n=r,a=r,l=function(r){j(t,(function(){var l=(0,F.from)(e[r],t),u=!1;l.subscribe(new D.OperatorSubscriber(s,(function(e){o[r]=e,u||(u=!0,a--),a||s.next(i(o.slice()))}),(function(){--n||s.complete()})))}),s)},u=0;u<r;u++)l(u)}),s)}}function j(e,t,i){e?(0,E.executeSchedule)(i,e,t):t()}function W(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=(0,q.popScheduler)(e);return(0,F.from)(e,i)}var A=i(37560),Q=i(46055),z=i(80068),U=i(21526),H=i.n(U),K=i(200),G=i(87915),J=i(98658),Y=i(14071),X=i(12781);const Z=["tpPercent"],ee=["slPercent"],te=["stopPercent"],ie=["limitPercent"];function se(e){return re(e)||oe(e)}function re(e){return ie.includes(e.id)}function oe(e){return te.includes(e.id)}function ne(e,t,i){var s;return null===(s=e.getValidationRules(t))||void 0===s?void 0:s.filter(e=>i.includes(e.id))}function ae(e,t){return ne(e,t,Z)}function le(e,t){return ne(e,t,ee)}const ue=(0,u.t)("Long"),he=(0,u.t)("Short");class de{constructor(e,t,i,s,r,o,a,u,h,d,c,p,_=!1){this.description="",this.isTradable=!0,this._pinButtonClicked=new(H()),this._backButtonClicked=new(H()),this._cancelButtonClicked=new(H()),this._closeButtonClicked=new(H()),this._onStatusChanged=()=>{this.hasBackButton.setValue(this._hasBackButton()),this.hasCloseButton.setValue(n.enabled("order_panel_close_button")),this.hasCancelButton.setValue(this._hasCancelButton()),
this.description=this._text(),this.title=this._title()},this._onQuotes=e=>{this.hasDelayedWarning.setValue(Boolean(e.isDelayed))},this._data=c,this._displaySymbolName=e,this._formatter=p,this._brokerName=i,this.status=r,this._mode=s,this.type=o,this._existingOrder=a,this.isTradable=u,this.isTradingPanelVisible=d,this.symbol=t,this.hasBackButton=new(l())(this._hasBackButton()),this.hasCloseButton=new(l())(n.enabled("order_panel_close_button")),this.hasCancelButton=new(l())(!1),this.hasDelayedWarning=new(l())(!1),this.hasBatsQuotes=_,this.title=this._title(),this.description=this._text(),this.status.subscribe(this._onStatusChanged),this._mode.subscribe(this._onStatusChanged),h&&(this._quotesSubscription=h.subscribe(this._onQuotes))}unsubscribe(){this._mode.unsubscribe(this._onStatusChanged),this.status.unsubscribe(this._onStatusChanged),this._quotesSubscription&&this._quotesSubscription.unsubscribe()}showCancelButton(){this.hasCancelButton.setValue(!0)}hideCancelButton(){this.hasCancelButton.setValue(!1)}back(){this._backButtonClicked.fire()}pin(){this._pinButtonClicked.fire()}cancel(){this._cancelButtonClicked.fire()}close(){this._closeButtonClicked.fire()}pinButtonClicked(){return this._pinButtonClicked}backButtonClicked(){return this._backButtonClicked}cancelButtonClicked(){return this._cancelButtonClicked}closeButtonClicked(){return this._closeButtonClicked}_hasBackButton(){return!(this._mode.value()!==Q.OrderEditorDisplayMode.Panel||!this._existingOrder&&2!==this.type&&this.status.value()!==Q.OrderPanelStatus.Preview)}_hasCancelButton(){return this._mode.value()===Q.OrderEditorDisplayMode.Panel&&this.status.value()===Q.OrderPanelStatus.Active&&!this._existingOrder&&2!==this.type}_title(){return this.status.value()===Q.OrderPanelStatus.Preview?(0,u.t)("Order confirmation"):this._displaySymbolName}_text(){if(this.status.value()===Q.OrderPanelStatus.Preview)return"";if(this._existingOrder&&this._data&&this._formatter){if(2===this.type){const e=this._data.side,t=this._data.qty,i=this._formatter.format(this._data.price||this._data.avgPrice||this._data.limitPrice);return", "+(1===e?ue:he)+" "+t+" @ "+i}return", "+(0,u.t)("order")+" "+this._data.id}return this._brokerName?", "+this._brokerName:""}}var ce=i(90592);class pe{constructor({initialSide:e,quotes$:t,priceFormatter:i,spreadFormatter:s,status:r,baseCurrency:o}){this.baseCurrency=null,this.onControlFocused=new(H()),this._formattedQuotes$=new y.BehaviorSubject({ask:" ",bid:" "}),this._quotes={ask:0,bid:0},this._waitQuotesTimeout=void 0,this.getValue=()=>this._value$.getValue(),this.setValue=e=>{this._value$.next(e)},this.getFormattedQuotes=()=>this._formattedQuotes$.getValue(),this.currentQuotes=()=>this._quotes,this._value$=new y.BehaviorSubject(e),this.value$=this._value$.asObservable(),this.formattedQuotes$=this._formattedQuotes$.asObservable(),this.baseCurrency=o,this.status=r,this._quotes$=t,this._priceFormatter=i,this._spreadFormatter=s}subscribe(){return this._waitQuotesTimeout=setTimeout(()=>{this._formattedQuotes$.next({}),this._quotes={}},5e3),
this._subscription=this._quotes$.subscribe(e=>{this._formattedQuotes$.next(this._generateText(e)),this._quotes=e,clearTimeout(this._waitQuotesTimeout)}),this._subscription}unsubscribe(){var e;null===(e=this._subscription)||void 0===e||e.unsubscribe(),clearTimeout(this._waitQuotesTimeout)}_generateText(e){const t={},i=(0,X.getAsk)(e),s=(0,X.getBid)(e);return t.ask=this._priceFormatter.format(i),t.bid=this._priceFormatter.format(s),t.spread=(0,ce.isNumber)(e.spread)?this._spreadFormatter.format(e.spread):this._priceFormatter.format(i-s),t}}var _e=i(93302),be=i(55023),ye=i(22452),ge=i(40160);const Pe=(0,u.t)("Order price is not appropriate for this order type/direction."),me=(0,u.t)("Order price is too close to the market price. It can lead to placing wrong order type due to specifics of the order placement in {brokerTitle}");function ve(e,t,i,s){const r=new _e.Big(t),o=r.mul(e).div(100);return r.minus(o.mul(i).mul(s)).toNumber()}function fe(e,t){return(0,_e.Big)(e).minus(t).abs().gt((0,_e.Big)(e).div(2))}function ke(e,t,i,s,r,o,n,a,l,h){const d=e<0||(0,_e.Big)(t).mul(100).lt(e)||function(e,t,i,s,r,o){return 1===i?1===s?e>t&&fe(t,e):e<t&&fe(t,e):!!(3===i&&!o||4===i&&r)&&(1===s?e<t:e>t)}(e,t,i,s,r,a);return o&&!h||!1!==(0,X.isMintickMultiple)(e,l)?{res:d,severity:"error",msg:d?Pe:void 0}:{res:!0,msg:(0,u.t)("Order price should be a multiple of {minTick}").format({minTick:n.format(l)})}}class Se{constructor(e,t,i,s,r,o,n,a,h,d,c,p,_,b,g){var P,m;this.id=(0,z.randomHashN)(6),this.price=new(l())(null),this.displayPrice=new(l())(""),this.relativePrice=new be.WatchedObject(null,X.comparator),this.priceError=new(l()),this.quotes=new be.WatchedObject({ask:0,bid:0,last:0},X.comparator),this.side=new(l()),this.step=new(l()),this.error=new be.WatchedObject({res:!1},X.comparator),this.onControlFocused=new(H()),this.$value=new y.BehaviorSubject(null),this._controlError=new y.BehaviorSubject(!1),this._syncPrice=null,this._symbolType="",this._priceRules=[],this._stopLimitPercentPriceRuleCheckers=[],this.setControlError=e=>{this._controlError.next(e)},this._isPriceRules=e=>"limitPriceDistance"===e.id||"stopPriceDistance"===e.id,this._updateFocusIfNeeded=()=>{1!==this.focusedControl.value()||!this.isRelativePriceControlHidden&&this._settings.value().showRelativePriceControl||this.focusedControl.setValue(0)},this.side.setValue(i),this._instrumentInfo=s,this.status=r,this.orderType=a,this._isLimitPrice=h,this._settings=d,this._settings.subscribe(this._updateFocusIfNeeded),this.isRelativePriceControlHidden=this._roundToStepRequired(),this._setStep(),this.formatter=n,this.orderWidgetStat=p,this.supportStopOrdersInBothDirections=!0===g;const v=b||this.isRelativePriceControlHidden||!this._settings.value().showRelativePriceControl;this.focusedControl=new(l())(v?0:1),this.modifiedAbsolutePriceControlStat=null!==p?()=>p.setPriceControlModifiedProperty(Q.PriceSubControlType.Absolute):()=>{},this.modifiedRelativePriceControlStat=null!==p?()=>p.setPriceControlModifiedProperty(Q.PriceSubControlType.Relative):()=>{},
this.displayPrice.setValue(this.formatter.format(0)),void 0!==o&&(this.forceAbsolutePriceUpdate(o,!0),this.$value.next(this.price.value())),this._symbolType=s.type||"",this._quotes=e,this._side$=t,this._priceSubscription=(0,X.makeSubjectFromWatchedValue)(this.price),this._orderTypeSubscription=(0,X.makeSubjectFromWatchedValue)(this.orderType),this._orderTypeSubj=this._orderTypeSubscription.subject,this._resultSubscription=N([this._priceSubscription.subject,this._quotes,this._side$,this._orderTypeSubscription.subject,this._controlError]).subscribe(([e,t,i,s,r])=>{const o=(0,X.getQuotePrice)(i,t),n="forex"===this._symbolType,a=this.status.value(),l=a!==Q.OrderPanelStatus.Wait,u=a===Q.OrderPanelStatus.Editing;let h={res:!1};if(null!==e&&null!==s&&2!==s){h=ke(e,o,s,i,!this._isLimitPrice,n,this.formatter,this.supportStopOrdersInBothDirections,this.step.value(),this._roundToStepRequired());for(const t of this._stopLimitPercentPriceRuleCheckers)if(h=t(e,o,i,s,this.step.value(),u),h.res)break}const d=null!==e?this._checkPriceWarning(e,t,i):{res:!1},c=h.res||r||d.res,p=h.res||r?"error":"warning",_=r?void 0:h.res?h.msg:d.msg;this.error.setValue({res:!!l&&c,severity:p,msg:l?_:void 0}),this.$value.next(h.res||r?null:e)}),this._pipSize=s.pipSize;const f=null!=_?_:[];this._priceRules=null!==(P=f.filter(this._isPriceRules))&&void 0!==P?P:[];const k=null!==(m=f.filter(se))&&void 0!==m?m:[],S=this._isLimitPrice?re:oe;k.filter(S).forEach(e=>{this._stopLimitPercentPriceRuleCheckers.push(function(e,t){let i;return(s,r,o,n,a,l)=>{const h=-1===o?1:-1,d=3===n?1:-1,c=ve(e,r,h,d),p=ve(t,r,h,d),_=1===n?1:2,b=(0,ge.roundToStepByPriceTypeAndSide)(c,a,_,o),y=(0,ge.roundToStepByPriceTypeAndSide)(p,a,_,o);let g=Math.min(b,y),P=Math.max(b,y);l&&(void 0===i&&(i=s),g=Math.min(g,i),P=Math.max(P,i));return s>=g&&s<=P?{res:!1}:{res:!0,msg:(0,u.t)("Order price should be in the range of {min} and {max}").replace("{min}",g.toString()).replace("{max}",P.toString())}}}(e.options.min,e.options.max))}),this._brokerTitle=c}onAbsolutePriceSelected(e){let t,i;t=this.formatter.parse?this.formatter.parse(e):{res:!1,error:"Formatter does not support parse"},t.res?(this.price.setValue(t.value),this.displayPrice.setValue(e)):this.displayPrice.setValue(e),i=this._isLimitPrice&&4===this.orderType.value()&&null!==this._syncPrice?this._syncPrice:this._getQuotesBySide(this.side.value());const s={base:this._getBase(this.side.value(),this.orderType.value()),offset:this.calcOffset(t.res?t.value:0,i,this.step.value())};this.relativePrice.setValue(s)}onRelativePriceSelected(e){if(this.isRelativePriceControlHidden||!this._settings.value().showRelativePriceControl)return;let t;if(this.relativePrice.setValue(e),null===e)t=0;else if("ask"===e.base)t=(0,_e.Big)(this.step.value()).mul(e.offset).plus(this.quotes.value().ask).toNumber();else if("bid"===e.base)t=(0,_e.Big)(this.step.value()).mul(e.offset).plus(this.quotes.value().bid).toNumber();else{let i;i=this._isLimitPrice&&4===this.orderType.value()&&null!==this._syncPrice?this._syncPrice:this._getQuotesBySide(this.side.value()),
t=(0,_e.Big)(this.step.value()).mul(e.offset).plus(i).toNumber()}this._checkOutOfRange(this.quotes.value(),t)&&(t=this._getQuotesBySide(this.side.value()),this.relativePrice.setValue({base:this._getBase(this.side.value(),this.orderType.value()),offset:0}));const i=this.formatter.format(t);this.price.setValue((0,ye.parsePrice)(i,this.formatter,t)),this.displayPrice.setValue(i)}subscribe(){return N([this._side$,this._quotes,this._orderTypeSubj]).subscribe(([e,t,i])=>{this.orderType.setValue(i),this.isRelativePriceControlHidden=this._roundToStepRequired(),this._setStep(),(this._isLimitPrice&&4!==i||!1===this._isLimitPrice||this.isRelativePriceControlHidden)&&(this._updateAbsolutePriceOnQuotes(e,t),this._updateRelativePriceOnQuotes(e,t,i)),this.quotes.setValue({ask:(0,X.getAsk)(t),bid:(0,X.getBid)(t),last:(0,X.getLast)(t)}),this.side.setValue(e),this.orderType.setValue(i)})}unsubscribe(){this._priceSubscription.unsubscribe(),this._orderTypeSubscription.unsubscribe(),this._resultSubscription.unsubscribe(),this._settings.unsubscribe(this._updateFocusIfNeeded)}forcePricesUpdate(e){this.focusedControl.setValue(this._settings.value().showRelativePriceControl&&!this.isRelativePriceControlHidden?1:0),this.forceAbsolutePriceUpdate(e),this.forceRelativePriceUpdate()}forceAbsolutePriceUpdate(e,t=!1){if(null===e)return;const i=this._roundToStepRequired()||t,s=this._getPriceType();e=i?(0,ge.roundToStepByPriceTypeAndSide)(e,this.step.value(),s,this.side.value()):e,this.price.setValue(e),this.displayPrice.setValue(this.formatter.format(e))}forceRelativePriceUpdate(){const e=this._getOffsetFromAbsolutePrice(this.price.value(),this.side.value(),this.quotes.value()),t={base:this._getBase(this.side.value(),this.orderType.value()),offset:e};this.onRelativePriceSelected(t)}forceStopLimitRelativePriceUpdate(){const e={base:"stop",offset:this.side.value()};this.onRelativePriceSelected(e)}syncWithPrice(e){const t=null!==e?e:0;this._syncPrice=t;const i=this.price.value(),s=null!==i?i:0,r=this.calcOffset(s,t,this.step.value());if(0===this.focusedControl.value()){const e={base:"stop",offset:r};this.relativePrice.setValue(e)}else{const e=this.relativePrice.value(),i=t+(null!==e?e.offset:0)*this.step.value();this.forceAbsolutePriceUpdate(i)}}calcOffset(e,t,i){return Math.round((e-t)/i)}_checkOutOfRange(e,t){const i=null!==t&&t>=0,s=null!==t&&t<=100*(0,X.getQuotePrice)(this.side.value(),e);return!i||!s}_checkPriceWarning(e,t,i){const s=this._priceRules.find(s=>this._isDistanceRuleViolated(e,t,s,i));return s?{res:!0,severity:s.severity,msg:me.format({brokerTitle:this._brokerTitle})}:{res:!1,msg:void 0}}_isDistanceRuleViolated(e,t,i,s){if("limitPriceDistance"===i.id&&!this._isLimitPrice||"stopPriceDistance"===i.id&&this._isLimitPrice)return!1;const r=1===s,o=(0,X.getQuotePrice)(s,t);let n=null;if(r&&"buyDirectionPips"in i.options&&(n=i.options.buyDirectionPips),!r&&"sellDirectionPips"in i.options&&(n=i.options.sellDirectionPips),null===n)return!1;return Math.abs(o-e)<n*this._pipSize}_getBase(e,t){
return 4===t&&!0===this._isLimitPrice?"stop":1===e?"ask":"bid"}_getQuotesBySide(e){return 1===e?this.quotes.value().ask:this.quotes.value().bid}_getOffsetFromAbsolutePrice(e,t,i){const s=1===t?(0,X.getAsk)(i):(0,X.getBid)(i);return this.calcOffset(null!==e?e:s,s,this.step.value())}_getOffsetFromRelativePrice(){const e=this.relativePrice.value();return null!==e?e.offset:0}_updateAbsolutePriceOnQuotes(e,t){const i=(0,X.getQuotePrice)(e,t);if(null===this.price.value())this.forceAbsolutePriceUpdate(i);else if(1===this.focusedControl.value()){const e=this._getOffsetFromRelativePrice(),t=(0,_e.Big)(e).mul(this.step.value()).plus(i).toNumber();this.forceAbsolutePriceUpdate(t)}}_updateRelativePriceOnQuotes(e,t,i){if(!this.isRelativePriceControlHidden&&this._settings.value().showRelativePriceControl&&(null===this.relativePrice.value()||0===this.focusedControl.value()||this.side.value()!==e||this.orderType.value()!==i)){let s;s=this.side.value()===e?4===i&&null===this.relativePrice.value()?e:this._getOffsetFromAbsolutePrice(this.price.value(),e,t):1===this.focusedControl.value()?0:4===i?e:-this._getOffsetFromRelativePrice();const r={base:this._getBase(e,i),offset:s};this.relativePrice.setValue(r)}}_getPriceType(){const e=this.orderType.value();return 1===e||4===e&&this._isLimitPrice?1:2}_setStep(){const e=this._getPriceType();1===e&&void 0!==this._instrumentInfo.limitPriceStep?this.step.setValue(this._instrumentInfo.limitPriceStep):2===e&&void 0!==this._instrumentInfo.stopPriceStep?this.step.setValue(this._instrumentInfo.stopPriceStep):this.step.setValue(this._instrumentInfo.minTick||this._instrumentInfo.pipSize)}_roundToStepRequired(){const e=this._getPriceType(),t=this._instrumentInfo.minTick||this._instrumentInfo.pipSize;return 2===e&&void 0!==this._instrumentInfo.stopPriceStep?this._instrumentInfo.stopPriceStep!==t:1===e&&void 0!==this._instrumentInfo.limitPriceStep&&this._instrumentInfo.limitPriceStep!==t}}var Me=i(77445),Ce=i(21786),we=i(72989);function Ve(e,t,i,s,r){if(!t)return 0;return Be((0,_e.Big)(e).div(t).div(i).div(r||1),s).toNumber()}function Te(e,t,i,s,r,o){if(!i)return 0;return Be((0,_e.Big)(e).mul(t).div(i).div(s).div(o||1).div(100),r).toNumber()}function Oe(e,t,i,s){return(0,_e.Big)(t).mul(i).mul(e).mul(s||1).toNumber()}function Ie(e,t,i,s,r){return s&&e?(0,_e.Big)(t).mul(i).mul(e).mul(r||1).mul(100).div(s).toNumber():0}function Be(e,t){return e.div(t).round(0,0).mul(t)}class $e{constructor(e,t,i,s,r,o,n,a,u,h,d){this.formatter=new Ce.SplitThousandsFormatter,this.riskInCurrencyFormatter=new J.PriceFormatter(100),this.riskInPercentFormatter=new J.PriceFormatter(100),this.isRiskAvailable=new(l())(!1),this.focusedControl=new(l())(null),this.riskStep=.01,this.error=new be.WatchedObject({res:!1},X.comparator),this.onControlFocused=new(H()),this.$value=new y.BehaviorSubject(null),this._focusSubscription=(0,X.makeSubjectFromWatchedValue)(this.focusedControl),this._focusSubj=this._focusSubscription.subject,this._controlError=new y.BehaviorSubject({res:!1}),this.setControlError=e=>{this._controlError.next({res:e})},
this._updateFocusIfNeeded=e=>{const t=this.focusedControl.value(),i=1===t&&!e.showCurrencyRiskInQty,s=2===t&&!e.showPercentRiskInQty;(i||s)&&this.focusedControl.setValue(0)},this.qty=r.qty,this.units=r.units,this._lotSize=r.lotSize,this.quantity={value:new(l())(null!==n?n:this.qty.default),onModifiedCallback:()=>null!==h?h.setQtyControlModifiedProperty(Q.QuantitySubControlType.Units):()=>{},calculatorUsedStat:()=>null!==h?h.setCalculatorUsedProperty():()=>{}},this._quantitySubscription=(0,X.makeSubjectFromWatchedValue)(this.quantity.value),this._quantitySubj=this._quantitySubscription.subject,this.currency=o||"",this.riskInCurrency={value:new(l())(null),onModifiedCallback:()=>null!==h?h.setQtyControlModifiedProperty(Q.QuantitySubControlType.RiskInCurrency):()=>{},calculatorUsedStat:()=>null!==h?h.setCalculatorUsedProperty():()=>{}},this.riskInPercent={value:new(l())(null),onModifiedCallback:()=>null!==h?h.setQtyControlModifiedProperty(Q.QuantitySubControlType.RiskInPercent):()=>{},calculatorUsedStat:()=>null!==h?h.setCalculatorUsedProperty():()=>{}},this.showRiskControls=d,this._riskInCurrencySubscription=(0,X.makeSubjectFromWatchedValue)(this.riskInCurrency.value),this._riskInPercentSubscription=(0,X.makeSubjectFromWatchedValue)(this.riskInPercent.value),this._riskInCurrencySubj=this._riskInCurrencySubscription.subject,this._riskInPercentSubj=this._riskInPercentSubscription.subject,this.status=a,this._equity=i,this._pipValue=s,this._stopLossAvailable=e,this._stopLossPips=t,this._stopLossSubscription=this._stopLossAvailable.subscribe(e=>{this.isRiskAvailable.setValue(e),e||this.focusedControl.setValue(0)}),this._valuesSubscription=N([this._createQuantityObservable(),this._createRiskInCurrencyObservable(),this._createRiskInPercentObservable(),this._focusSubj]).subscribe(([e,t,i,s])=>{this.quantity.value.value()===e&&this.riskInCurrency.value.value()===t&&this.riskInPercent.value.value()===i&&this.focusedControl.value()===s||this._setValuesForUnfocusedControls(s,e,t,i)}),this._resultSubscription=N({qty:this._quantitySubj,controlError:this._controlError,focus:this._focusSubj}).pipe((0,b.distinctUntilChanged)(Me.default)).subscribe(e=>{const{qty:t,controlError:i,focus:s}=e,r=(0,we.checkQtyError)(this.qty,t,!0),o=i.res?i.msg:r.msg;this.error.setValue({res:r.res||i.res,msg:o}),this.$value.next(r.res||i.res||null===s?null:t)}),this.focusedControl.setValue(0),this._settings=u,this._settings.subscribe(this._updateFocusIfNeeded)}unsubscribe(){this._stopLossSubscription.unsubscribe(),this._valuesSubscription.unsubscribe(),this._resultSubscription.unsubscribe(),this._focusSubscription.unsubscribe(),this._quantitySubscription.unsubscribe(),this._riskInCurrencySubscription.unsubscribe(),this._riskInPercentSubscription.unsubscribe(),this._settings.unsubscribe(this._updateFocusIfNeeded)}_setValuesForUnfocusedControls(e,t,i,s){0!==e&&this.quantity.value.setValue(t),1!==e&&this.riskInCurrency.value.setValue(i),2!==e&&this.riskInPercent.value.setValue(s)}_createQuantityObservable(){return N({focus:this._focusSubj,
pipValue:this._pipValue,quantity:this._quantitySubj,riskInCurrency:this._riskInCurrencySubj,riskInPercent:this._riskInPercentSubj,stopLossPips:this._stopLossPips,equity:this._equity}).pipe((0,_.map)(e=>{const{focus:t,pipValue:i,quantity:s,riskInCurrency:r,riskInPercent:o,stopLossPips:n,equity:a}=e;switch(t){case 0:return s;case 1:return null===r||null===n?null:Ve(r,n,i,this.qty.step,this._lotSize);case 2:return null===o||null===n?null:Te(o,a,n,i,this.qty.step,this._lotSize);default:return s}}))}_createRiskInCurrencyObservable(){return N({focus:this._focusSubj,pipValue:this._pipValue,quantity:this._quantitySubj,riskInCurrency:this._riskInCurrencySubj,riskInPercent:this._riskInPercentSubj,stopLossPips:this._stopLossPips,equity:this._equity}).pipe((0,_.map)(e=>{const{focus:t,pipValue:i,quantity:s,riskInCurrency:r,riskInPercent:o,stopLossPips:n,equity:a}=e;switch(t){case 0:return null===s||null===n?null:Oe(s,n,i,this._lotSize);case 1:return r;case 2:if(null===o||null===n)return null;return Oe(Te(o,a,n,i,this.qty.step,this._lotSize),n,i,this._lotSize);default:return null===s||null===n?null:Oe(s,n,i)}}))}_createRiskInPercentObservable(){return N({focus:this._focusSubj,pipValue:this._pipValue,quantity:this._quantitySubj,riskInCurrency:this._riskInCurrencySubj,riskInPercent:this._riskInPercentSubj,stopLossPips:this._stopLossPips,equity:this._equity}).pipe((0,_.map)(e=>{const{focus:t,pipValue:i,quantity:s,riskInCurrency:r,riskInPercent:o,stopLossPips:n,equity:a}=e,l=null===n;switch(t){case 0:return null===s||l?null:Ie(s,n,i,a,this._lotSize);case 1:if(null===r||l)return null;return Ie(Ve(r,n,i,this.qty.step,this._lotSize),n,i,a,this._lotSize);case 2:return o;default:return null===s||l?null:Ie(s,n,i,a,this._lotSize)}}))}}var Fe=i(29699);class Re{constructor(e,t,i,s,r,o,n,a,u){this.focusedControl=new(l())(3),this.error=new be.WatchedObject({res:!1},X.comparator),this.onControlFocused=new(H()),this.baseCurrencyCryptoBalance=new(l())(null),this.quoteCurrencyCryptoBalance=new(l())(null),this.$value=new y.BehaviorSubject(null),this._focusSubscription=(0,X.makeSubjectFromWatchedValue)(this.focusedControl),this._controlError=new y.BehaviorSubject({res:!1}),this._focusSubj=this._focusSubscription.subject,this.setControlError=e=>{this._controlError.next({res:e})},this.info=e,this.status=o,this.formatter=new Fe.QuantityFormatter,this.quoteCurrencyUiParams$=t.pipe((0,_.map)(t=>{const i=(0,_e.Big)(t).mul(e.qty.step),s=(0,ge.roundDownToPowerOf10)(i.toNumber()),r=(0,_e.Big)(Math.ceil(i.div(s).toNumber())).mul(s),o=(0,_e.Big)(e.qty.min).div(e.qty.step);return{min:r.mul(o).toNumber(),step:s}})),this.quantity={value:new(l())(null!==r?r:e.qty.default||e.qty.step),onModifiedCallback:null!==u?()=>u.setQtyControlModifiedProperty(Q.QuantitySubControlType.BaseCurrency):()=>{}},this.quoteCurrencyQuantity={value:new(l())(null!==r?r:e.qty.default||e.qty.step),onModifiedCallback:null!==u?()=>u.setQtyControlModifiedProperty(Q.QuantitySubControlType.QuoteCurrency):()=>{}},this.side$=n,this.getSide=a,this._quoteCurrencyQuantitySubscription=(0,
X.makeSubjectFromWatchedValue)(this.quoteCurrencyQuantity.value),this._baseCurrencyQuantitySubscription=(0,X.makeSubjectFromWatchedValue)(this.quantity.value),this._baseCurrencyQuantitySubj=this._baseCurrencyQuantitySubscription.subject,this._quoteCurrencyQuantitySubj=this._quoteCurrencyQuantitySubscription.subject;const h=[this._baseCurrencyQuantitySubj,this._quoteCurrencyQuantitySubj,this._controlError,this._focusSubj,this.side$];i&&s&&(h.push(i),h.push(s)),this._subscriptions=[N([this._focusSubj,t,this._baseCurrencyQuantitySubj,this._quoteCurrencyQuantitySubj]).subscribe(([t,i,s,r])=>{if(4===t){if(null!==r){const t=(0,_e.Big)(r).div(i).div(e.qty.step).round(0,0).mul(e.qty.step).toNumber();this.quantity.value.setValue(t)}}else null!==s&&this.quoteCurrencyQuantity.value.setValue((0,_e.Big)(s).mul(i).toNumber())}),N(h).subscribe(t=>{const[i,s,r,o,n,a,l]=t,u=(0,we.checkQtyError)(e.qty,i),h=-1===n?this._checkBalanceError(i,a):this._checkBalanceError(s,l);this.error.setValue({res:u.res||h.res||r.res,msg:u.msg||h.msg||r.msg}),this.$value.next(u.res||h.res||r.res||null===o?null:i)})],i&&this._subscriptions.push(i.subscribe(e=>{this.baseCurrencyCryptoBalance.setValue(e)})),s&&this._subscriptions.push(s.subscribe(e=>{this.quoteCurrencyCryptoBalance.setValue(e)}))}unsubscribe(){this._subscriptions.forEach(e=>e&&e.unsubscribe())}_checkBalanceError(e,t){return null!==e&&t&&e>t.available?{res:!0,msg:we.qtyErrors.balance}:{res:!1}}}var qe=i(34978),Le=i(74727),De=Array.isArray;function Ee(e){return 1===e.length&&De(e[0])?e[0]:e}var Ne=i(1545);function xe(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=(0,q.popResultSelector)(e),s=Ee(e);return s.length?new g.Observable((function(e){var t=s.map((function(){return[]})),r=s.map((function(){return!1}));e.add((function(){t=r=null}));for(var o=function(o){(0,C.innerFrom)(s[o]).subscribe(new D.OperatorSubscriber(e,(function(s){if(t[o].push(s),t.every((function(e){return e.length}))){var n=t.map((function(e){return e.shift()}));e.next(i?i.apply(void 0,(0,m.__spreadArray)([],(0,m.__read)(n),!1)):n),t.some((function(e,t){return!e.length&&r[t]}))&&e.complete()}}),(function(){r[o]=!0,!t[o].length&&e.complete()})))},n=0;!e.closed&&n<s.length;n++)o(n);return function(){t=r=null}})):Ne.EMPTY}function je(e,t,i,s){return(0,_e.Big)(e).minus(t).div(s).div(i).toNumber()}function We(e,t,i,s){const r=(0,_e.Big)(i).mul(t).mul(s||1);if(r.eq(0))return 0;const o=(0,_e.Big)(e).div(r).toNumber();return Math.floor(o)}function Ae(e,t,i,s,r){const o=(0,_e.Big)(s).mul(t).mul(r||1).mul(100);if(o.eq(0))return 0;const n=(0,_e.Big)(e).mul(i).div(o).toNumber();return Math.floor(n)}function Qe(e,t,i,s){return(0,_e.Big)(i).mul(e).mul(s).plus(t).toNumber()}function ze(e,t,i,s){return(0,_e.Big)(e).mul(i).mul(t).mul(s||1).toNumber()}function Ue(e,t,i,s,r){return i?(0,_e.Big)(e).mul(s).mul(t).mul(r||1).mul(100).div(i).toNumber():0}const He={orderStopLoss:{long:(0,u.t)("Stop loss order must be below entry price."),short:(0,u.t)("Stop loss order must be higher entry price.")},orderTakeProfit:{long:(0,
u.t)("Take profit order must be above entry price."),short:(0,u.t)("Take profit order must be lower entry price.")},positionStopLoss:{long:e=>(0,u.t)("Stop loss must be below current {value}.",{replace:{value:e}}),short:e=>(0,u.t)("Stop loss must be above current {value}.",{replace:{value:e}})},positionTakeProfit:{long:e=>(0,u.t)("Take profit must be above current {value}.",{replace:{value:e}}),short:e=>(0,u.t)("Take profit must be below current {value}.",{replace:{value:e}})}};function Ke(e,t){let i,s,r;const o=(e,t,i,s)=>{const r=new _e.Big(t),o=r.mul(e).div(100);return r.minus(o.mul(i).mul(s)).toNumber()};return(n,a,l,h,d,c,p,_)=>{const b=-1===l?-1:1,y=h===A.BracketType.TakeProfit?-1:1,g=o(e,a,b,y),P=o(t,a,b,y),m=(0,ge.roundToStepByPriceTypeAndSide)(g,c,d,l),v=(0,ge.roundToStepByPriceTypeAndSide)(P,c,d,l);let f=Math.min(m,v),k=Math.max(m,v);p&&(void 0!==i&&void 0!==s&&r?(f=i,k=s):void 0===i&&void 0===s&&(f=Math.min(f,n),k=Math.max(k,n),i=f,s=k,r=_));if(!(n>=f&&n<=k))return{res:!0,msg:(0,u.t)("Bracket price should be in the range of {min} and {max}").replace("{min}",f.toString()).replace("{max}",k.toString())};return(b*y==-1?m>=a&&v>=a:m<=a&&v<=a)?{res:!1}:{res:!0,msg:(0,u.t)("Calculated boundaries do not match parent order side")}}}function Ge(e,t){if(null===e)return null;const i=t.format(e);if(t.parse){const e=t.parse(i);if(e.res)return e.value}return parseFloat(i)}class Je{constructor({initialPrice:e,initialEnabled:t,initialBracketType:i,formatter:s,equity$:r,quotes$:o,info:n,pipValue$:a,side$:l,amount$:h,parentPrice$:d,orderType$:c,currency:p,parentType:b,savedPips:g,settings:P,orderWidgetStat:m,showRiskControls:v,status:f,validationRules:k,supportModifyBrackets:S,supportModifyTrailingStop:M,supportCryptoBrackets:C,supportAddBracketsToExistingOrder:w}){if(this.isValuesInitialized=!1,this.onControlFocused=new(H()),this.stopLossTypes=[A.BracketType.StopLoss,A.BracketType.TrailingStop],this.roundToStopLimitPriceStepRequired=!1,this._value$=new y.BehaviorSubject(null),this._pips$=new y.BehaviorSubject(null),this._price$=new y.BehaviorSubject(null),this._riskInCurrency$=new y.BehaviorSubject(null),this._riskInPercent$=new y.BehaviorSubject(null),this._focusedControl$=new y.BehaviorSubject(1),this._error$=new y.BehaviorSubject({res:!1}),this._controlError$=new y.BehaviorSubject({res:!1}),this._subscriptions=[],this._bracketPercentPriceRuleCheckers=[],this.getValue=()=>this._value$.getValue(),this.getFocusedControl=()=>this._focusedControl$.getValue(),this.getEnabled=()=>this._enabled$.getValue(),this.getBracketType=()=>this._bracketType$.getValue(),this.getError=()=>this._error$.getValue(),this.setFocusedControl=e=>{this._focusedControl$.next(e)},this.setEnabled=e=>{this._enabled$.next(e)},this.setBracketType=e=>{this._bracketType$.next(e)},this.setControlError=e=>{this._controlError$.next({res:e,msg:void 0})},this._bracketValuesWithFocusedControlObservable=()=>this._focusedControl$.pipe((0,
qe.switchMap)(e=>1===e?this._priceObservable(e):2===e?this._riskInCurrencyObservable(e):3===e?this._riskInPercentObservable(e):this._pipsObservable(e))),this._updateFocusIfNeeded=e=>{const t=this.getFocusedControl(),i=this._supportCryptoBrackets?"showCryptoBracketsInPercent":"showBracketsInPercent",s=this._supportCryptoBrackets?"showCryptoBracketsInCurrency":"showBracketsInCurrency";(3===t&&!e[i]||2===t&&!e[s])&&this.setFocusedControl(0)},this._getPips=()=>this._pips$.getValue(),this._getPrice=()=>this._price$.getValue(),this._getRiskInCurrency=()=>this._riskInCurrency$.getValue(),this._getRiskInPercent=()=>this._riskInPercent$.getValue(),this._setPips=e=>{this._pips$.next(Ge(e,this._pipsFormatter))},this._setPrice=e=>{this._price$.next(Ge(e,this._priceFormatter))},this._setRiskInCurrency=e=>{this._riskInCurrency$.next(Ge(e,this._riskInCurrencyFormatter))},this._setRiskInPercent=e=>{this._riskInPercent$.next(Ge(e,this._riskInPercentFormatter))},this._enabled$=new y.BehaviorSubject(t),this._bracketType$=new y.BehaviorSubject(i),this._equity$=r,this._pipValue$=a,this._side$=l,this._sideSign$=l.pipe((0,_.map)(e=>(i!==A.BracketType.TakeProfit?-1:1)*e)),this._quotes$=o,this._amount$=h,this._pipSize=n.pipSize,this._lotSize=n.lotSize,this._settings=P,this._parentType=b,this._priceType=i===A.BracketType.TakeProfit?1:2,this._supportCryptoBrackets=Boolean(C),this._isStatusEditing=1!==b||f===Q.OrderPanelStatus.Editing,this._pipsFormatter=new J.PriceFormatter(n.pipSize!==n.minTick?10:1),this._priceFormatter=s,this._riskInCurrencyFormatter=new J.PriceFormatter(100),this._riskInPercentFormatter=new J.PriceFormatter(100),this._parentPrice$=N({parentPrice:d,orderType:c,bracketType:this._bracketType$,quotes:this._quotes$,side:this._side$}).pipe((0,_.map)(e=>{const{parentPrice:t,orderType:i,bracketType:s,quotes:r,side:o}=e;return s!==A.BracketType.TrailingStop||2!==i&&1===this._parentType?t:1===o?(0,X.getAsk)(r):(0,X.getBid)(r)})),void 0!==k)for(const e of k)this._bracketPercentPriceRuleCheckers.push(Ke(e.options.min,e.options.max));this._priceStep=n.minTick||n.pipSize,i===A.BracketType.StopLoss&&void 0!==n.stopPriceStep&&n.stopPriceStep!==this._priceStep&&(this._priceStep=n.stopPriceStep,this.roundToStopLimitPriceStepRequired=!0),i===A.BracketType.TakeProfit&&void 0!==n.limitPriceStep&&n.limitPriceStep!==this._priceStep&&(this._priceStep=n.limitPriceStep,this.roundToStopLimitPriceStepRequired=!0),N({parentPrice:this._parentPrice$,sideSign:this._sideSign$,pipValue:this._pipValue$,equity:this._equity$,amount:this._amount$}).pipe((0,Le.take)(1)).subscribe(t=>{const{parentPrice:s,sideSign:r,pipValue:o,equity:n,amount:a}=t;let l,u,h=0;null!==e?(h=1,l=null,u=e):(l=null!==g?g:this._getDefaultPips(i),u=null);const{pips:d,price:c,riskInCurrency:p,riskInPercent:_}=this._calculateBracketValues({sideSign:r,pipValue:o,equity:n,parentPrice:s,amount:a,focusedControl:h,pips:l,price:u,riskInCurrency:null,riskInPercent:null});this.setFocusedControl(h),this._setPips(d),this._setPrice(c),this._setRiskInCurrency(p),this._setRiskInPercent(_),
this.isValuesInitialized=!0}),this._bracketValuesWithFocusedControl$=this._bracketValuesWithFocusedControlObservable(),this.pips={value$:this._pips$.asObservable(),step:1,formatter:this._pipsFormatter,getValue:this._getPips,setValue:this._setPips,onModifiedCallback:null!==m?()=>m.setBracketControlModifiedProperty(i,Q.BracketSubControlType.Pips):()=>{}},this.price={value$:this._price$.asObservable(),step:this._priceStep,formatter:this._priceFormatter,getValue:this._getPrice,setValue:this._setPrice,onModifiedCallback:null!==m?()=>m.setBracketControlModifiedProperty(i,Q.BracketSubControlType.Price):()=>{}},this.riskInCurrency={value$:this._riskInCurrency$.asObservable(),step:.01,formatter:this._riskInCurrencyFormatter,getValue:this._getRiskInCurrency,setValue:this._setRiskInCurrency,onModifiedCallback:null!==m?()=>m.setBracketControlModifiedProperty(i,Q.BracketSubControlType.Money):()=>{}},this.riskInPercent={value$:this._riskInPercent$.asObservable(),step:.01,formatter:this._riskInPercentFormatter,getValue:this._getRiskInPercent,setValue:this._setRiskInPercent,onModifiedCallback:null!==m?()=>m.setBracketControlModifiedProperty(i,Q.BracketSubControlType.Percent):()=>{}},this.value$=this._value$.asObservable(),this.enabled$=this._enabled$.asObservable(),this.bracketType$=this._bracketType$.asObservable(),this.focusedControl$=this._focusedControl$.asObservable(),this.error$=this._error$.asObservable(),this.controlState=this._computeControlState(b,i,S,M,w),this.currency=p.length>0?p:(0,u.t)("Money"),this.showRiskControls=v}subscribe(){this._settings.subscribe(this._updateFocusIfNeeded);const e=N({enabled:this._enabled$,parentPrice:this._parentPrice$,sideSign:this._sideSign$,pipValue:this._pipValue$,equity:this._equity$,amount:this._amount$,bracketValuesWithFocusedControl:this._bracketValuesWithFocusedControl$}).subscribe(e=>{const{enabled:t,parentPrice:i,sideSign:s,pipValue:r,equity:o,amount:n,bracketValuesWithFocusedControl:a}=e,{focusedControl:l,pips:u,price:h,riskInCurrency:d,riskInPercent:c}=a,{pips:p,price:_,riskInCurrency:b,riskInPercent:y}=this._calculateBracketValues({sideSign:s,pipValue:r,equity:o,parentPrice:i,amount:n,focusedControl:l,pips:u,price:h,riskInCurrency:d,riskInPercent:c});!t&&null!==d||u===p&&h===_&&d===b&&c===y||this._setValuesForUnfocusedControls(l,p,_,b,y)}),t=N({side:this._side$,enabled:this._enabled$,controlError:this._controlError$,bracketValuesWithFocusedControl:this._bracketValuesWithFocusedControl$,parentPrice:this._parentPrice$,quotes:this._quotes$,bracketType:this._bracketType$}).subscribe(e=>{const{side:t,enabled:i,controlError:s,bracketValuesWithFocusedControl:r,parentPrice:o,quotes:n,bracketType:a}=e,{focusedControl:l,pips:u,price:h}=r;i&&this._setError({side:t,parentPrice:o,quotes:n,bracketType:a,controlError:s,focusedControl:l,pips:u,price:h})}),i=N({pips:this._pips$,error:this._error$,enabled:this._enabled$}).subscribe(e=>{const{pips:t,error:i,enabled:s}=e;this._value$.next(i.res||!s?null:t)});return this._subscriptions=[e,t,i],this._subscriptions}unsubscribe(){
this._subscriptions.forEach(e=>e.unsubscribe()),this._settings.unsubscribe(this._updateFocusIfNeeded)}isValueIncorrect(){const e=this.getEnabled(),t=this.getValue();return e&&null===t}_getDefaultPips(e){return e===A.BracketType.TakeProfit?Q.BracketDefaultPips.TakeProfit:Q.BracketDefaultPips.StopLoss}_setValuesForUnfocusedControls(e,t,i,s,r){0!==e&&this._setPips(t),1!==e&&this._setPrice(i),2!==e&&this._setRiskInCurrency(s),3!==e&&this._setRiskInPercent(r)}_setError(e){const{side:t,parentPrice:i,quotes:s,bracketType:r,controlError:o,focusedControl:n,pips:a,price:l}=e;if(o.res)return void this._error$.next(o);let h={res:!1};null===l||null===a?h={res:!0,msg:"Order don't have price or pips."}:(h=2===this._parentType?this._checkPositionError(t,l,i,r,s):this._checkOrderError(t,a,l,i,r),this.roundToStopLimitPriceStepRequired&&!h.res&&1===n&&(h=function(e,t,i){return(0,X.isMintickMultiple)(e,t)?{res:!1}:{res:!0,msg:(0,u.t)("Bracket price should be a multiple of {minTick}").format({minTick:i.format(t)})}}(l,this._priceStep,this._priceFormatter))),this._error$.next(h)}_checkBracketPercentValidationRules(e,t,i,s){for(const r of this._bracketPercentPriceRuleCheckers){const o=r(t,i,e,s,this._priceType,this._priceStep,this._isStatusEditing,this.getEnabled());if(o.res)return o}return{res:!1}}_checkOrderError(e,t,i,s,r){let o=this._bracketPercentPriceRuleCheckers.length>0?this._checkBracketPercentValidationRules(e,i,s,r):{res:!1};if(t<=0||i<=0){const t=r===A.BracketType.TakeProfit?He.orderTakeProfit:He.orderStopLoss;o={res:!0,msg:1===e?t.long:t.short}}return o}_checkPositionError(e,t,i,s,r){const o=(s===A.BracketType.TakeProfit?-1:1)*e,n=-1===e?(0,X.getAsk)(r):(0,X.getBid)(r),a=-1===e?(0,u.t)("ask"):(0,u.t)("bid"),l=s===A.BracketType.TakeProfit?He.positionTakeProfit:He.positionStopLoss;let h=this._bracketPercentPriceRuleCheckers.length>0?this._checkBracketPercentValidationRules(e,t,i,s):{res:!1};return n&&Math.sign(t-n)===o&&(h={res:!0,msg:-1===e?l.short(a):l.long(a)}),h}_pipsObservable(e){return this._pips$.pipe((0,qe.switchMap)(t=>xe([this._price$,this._riskInCurrency$,this._riskInPercent$]).pipe((0,_.map)(i=>{const[s,r,o]=i;return{focusedControl:e,pips:t,price:s,riskInCurrency:r,riskInPercent:o}}))))}_priceObservable(e){return this._price$.pipe((0,qe.switchMap)(t=>xe([this._pips$,this._riskInCurrency$,this._riskInPercent$]).pipe((0,_.map)(i=>{const[s,r,o]=i;return{focusedControl:e,pips:s,price:t,riskInCurrency:r,riskInPercent:o}}))))}_riskInCurrencyObservable(e){return this._riskInCurrency$.pipe((0,qe.switchMap)(t=>xe([this._pips$,this._price$,this._riskInPercent$]).pipe((0,_.map)(i=>{const[s,r,o]=i;return{focusedControl:e,pips:s,price:r,riskInCurrency:t,riskInPercent:o}}))))}_riskInPercentObservable(e){return this._riskInPercent$.pipe((0,qe.switchMap)(t=>xe([this._pips$,this._price$,this._riskInCurrency$]).pipe((0,_.map)(i=>{const[s,r,o]=i;return{focusedControl:e,pips:s,price:r,riskInCurrency:o,riskInPercent:t}}))))}_calculateBracketValues(e){return{pips:Ge(this._calculatePips(e),this._pipsFormatter),
price:Ge(this._calculatePrice(e),this._priceFormatter),riskInCurrency:Ge(this._calculateRiskInCurrency(e),this._riskInCurrencyFormatter),riskInPercent:Ge(this._calculateRiskInPercent(e),this._riskInPercentFormatter)}}_calculatePips(e){const{sideSign:t,pipValue:i,equity:s,parentPrice:r,amount:o,focusedControl:n,pips:a,price:l,riskInCurrency:u,riskInPercent:h}=e;switch(n){case 0:return a;case 1:return null===l?null:je(l,r,t,this._pipSize);case 2:return null===u||null===o?null:We(u,o,i,this._lotSize);case 3:return null===h||null===o?null:Ae(h,o,s,i,this._lotSize);default:return a}}_calculatePrice(e){const{sideSign:t,pipValue:i,equity:s,parentPrice:r,amount:o,focusedControl:n,pips:a,price:l,riskInCurrency:u,riskInPercent:h}=e;let d,c;switch(n){case 0:if(null===a)return null;c=Qe(a,r,t,this._pipSize);break;case 1:return l;case 2:if(null===u||null===o)return null;d=We(u,o,i,this._lotSize),c=Qe(d,r,t,this._pipSize);break;case 3:if(null===h||null===o)return null;d=Ae(h,o,s,i,this._lotSize),c=Qe(d,r,t,this._pipSize);break;default:if(null===a)return null;c=Qe(a,r,t,this._pipSize)}return this.roundToStopLimitPriceStepRequired?(0,ge.roundToStepByPriceTypeAndSide)(c,this._priceStep,this._priceType,t):c}_calculateRiskInCurrency(e){const{sideSign:t,pipValue:i,equity:s,parentPrice:r,amount:o,focusedControl:n,pips:a,price:l,riskInCurrency:u,riskInPercent:h}=e;let d;const c=null===a||null===o;switch(n){case 0:return c?null:ze(a,o,i,this._lotSize);case 1:return null===l||c?null:(d=je(l,r,t,this._pipSize),ze(d,o,i,this._lotSize));case 2:return u;case 3:return null===h||c?null:(d=Ae(h,o,s,i,this._lotSize),ze(d,o,i,this._lotSize));default:return c?null:ze(a,o,i,this._lotSize)}}_calculateRiskInPercent(e){const{sideSign:t,pipValue:i,equity:s,parentPrice:r,amount:o,focusedControl:n,pips:a,price:l,riskInCurrency:u,riskInPercent:h}=e;let d;const c=null===a||null===o;switch(n){case 0:return c?null:Ue(a,o,s,i,this._lotSize);case 1:return null===l||c?null:(d=je(l,r,t,this._pipSize),Ue(d,o,s,i,this._lotSize));case 2:return null===u||null===o?null:(d=We(u,o,i,this._lotSize),Ue(d,o,s,i,this._lotSize));case 3:return h;default:return c?null:Ue(a,o,s,i,this._lotSize)}}_computeControlState(e,t,i,s,r){const o=this._isStatusEditing&&t===A.BracketType.TrailingStop&&!s,n=this._isStatusEditing&&t!==A.BracketType.TakeProfit&&this.getEnabled()&&!s,a=this._isStatusEditing&&!i,l=Boolean(1===e&&this._isStatusEditing&&!this.getEnabled()&&!r);return{inputDisabled:o||a||l,labelDisabled:n||a||l,checkboxDisabled:a||l}}}var Ye=i(96798),Xe=i(22967);function Ze(e){return(0,Ye.operate)((function(t,i){(0,C.innerFrom)(e).subscribe(new D.OperatorSubscriber(i,(function(){return i.complete()}),Xe.noop)),!i.closed&&t.subscribe(i)}))}class et{constructor(e,t,i,s){this.onControlFocused=new(H()),this._stop$=new M.Subject,this.durationMetaInfoList=t,this.orderType=i;const r=this._getDurationByOrderType(e,i.value());this.$value=new y.BehaviorSubject(r),this.currentDuration=new be.WatchedObject(r,X.comparator),this._currentDurationSubscription=(0,
X.makeSubjectFromWatchedValue)(this.currentDuration),this._orderTypeSubscription=(0,X.makeSubjectFromWatchedValue)(this.orderType),this._currentDurationSubscription.subject.pipe(Ze(this._stop$)).subscribe(e=>{this.$value.next(e)}),this._orderTypeSubscription.subject.pipe(Ze(this._stop$)).subscribe(e=>{const t=this._getDurationByOrderType(this.getValue(),e);this.currentDuration.setValue(t)}),this.onModifiedCallback=null!==s?()=>s.setDurationControlModifiedProperty():()=>{}}isDurationsAvailable(){return null!==this._getDurationByOrderType(this.currentDuration.value(),this.orderType.value())}unsubscribe(){this._stop$.next(),this._stop$.complete(),this._currentDurationSubscription.unsubscribe(),this._orderTypeSubscription.unsubscribe()}getValue(){const e=this.$value.getValue();if(null===e)return null;const t=this.durationMetaInfoList.find(t=>e.type===t.value);if(void 0===t)return null;const i={type:e.type};return(t.hasDatePicker||t.hasTimePicker)&&(i.datetime=e.datetime),i}_getDurationByOrderType(e,t){const i=(0,K.filterDurationsByOrderType)(t,this.durationMetaInfoList);if(0===i.length)return null;return null!==e&&i.some(t=>e.type===t.value)?e:(0,K.makeInitialOrderDuration)(t,i)}}var tt=i(47753);function it(e,t=100,i){const s=new Map,r=new Map;return function(...o){var n;const a=String(i?i.apply(null,o):o),l=Date.now();if(s.has(a)&&(null!==(n=r.get(a))&&void 0!==n?n:-1/0)>l)return s.get(a);const u=e.apply(this,o);return s.set(a,u),r.set(a,l+t),u}}var st=i(98162);const rt=(0,Y.getLogger)("Trading.LeverageViewModel");class ot{constructor({adapterLeverageInfo:e,adapterSetLeverage:t,adapterPreviewLeverage:i,brokerName:s,symbol:r,displaySymbol:n,orderType$:a,side$:h,initialSide:d,customFieldModels:c,customFieldsGetter:p,blocked:_,onBlockedClick:b}){this.onControlFocused=new(H()),this.leverageInfoWatchedValue=new(l())(null),this._leverageInfo$=new y.BehaviorSubject(null),this._leveragePreviewResult$=new y.BehaviorSubject(null),this._subscriptions=[],this.leverageInfo=()=>this._leverageInfo$.getValue(),this.leveragePreviewResult=()=>this._leveragePreviewResult$.getValue(),this.setLeverage=async e=>{try{const t=await this._adapterSetLeverage(e),i=this.leverageInfo();null!==i&&(this._leverageInfo$.next({...i,leverage:t.leverage}),this.leverageInfoWatchedValue.setValue({...i,leverage:t.leverage}))}catch(e){throw rt.logError("Failed to set leverage: "+(0,ge.getLoggerMessage)(e)),new Error((0,u.t)("Failed to set leverage"))}},this.previewLeverage=async e=>{try{const t=await this._adapterPreviewLeverage(e);return this._leveragePreviewResult$.next(t),t}catch(e){throw this._leveragePreviewResult$.next(null),rt.logError("Failed to preview leverage: "+(0,ge.getLoggerMessage)(e)),new Error((0,u.t)("Failed to preview leverage"))}},this._updateLeverageInfo=async()=>{if(this.blocked.value())return;const e=await this.getLeverageInfo({symbol:this.symbol,orderType:this.orderType,side:this.side,customFields:this.customFields});this._leverageInfo$.next(e),this.leverageInfoWatchedValue.setValue(e)},this._adapterLeverageInfo=e,
this._adapterSetLeverage=t,this._adapterPreviewLeverage=i,this.symbol=r,this.displaySymbol=n,this._orderType$=a,this._side$=h,this._customFieldModels=c,this.brokerName=s,this._updateLeverageInfo=(0,st.sequentialize)(this._updateLeverageInfo),this.orderType=(0,o.ensureNotNull)(a.value),this.side=d,this.customFields=p(this._customFieldModels.value()),this._customFieldsGetter=p,this.blocked=_,this.onBlockedClick=b,this._selectedItems$=this._customFieldModels.value().filter(e=>"ComboBox"===e.type&&"selectedItem"in e).map(e=>{const t=(0,X.makeSubjectFromWatchedValue)(e.selectedItem);return e.subscription=t,t.subject}),this._subscribe(),this.ready=this._updateLeverageInfo(),this.getLeverageInfo=it(this.getLeverageInfo)}unsubscribe(){this._subscriptions.forEach(e=>{e.unsubscribe()}),this.blocked.unsubscribe(this._updateLeverageInfo)}async getLeverageInfo(e){try{const t=await this._adapterLeverageInfo(e);return this.leverageInfoWatchedValue.setValue(t),t}catch(e){return rt.logError("Failed to get leverage info: "+(0,ge.getLoggerMessage)(e)),null}}_subscribe(){const e=N([this._orderType$,this._side$]).pipe((0,tt.skip)(1)).subscribe(async([e,t])=>{this.orderType=(0,o.ensureNotNull)(e),this.side=t,this._updateLeverageInfo()}),t=N(this._selectedItems$).pipe((0,tt.skip)(1)).subscribe(()=>{this.customFields=this._customFieldsGetter(this._customFieldModels.value()),this._updateLeverageInfo()});this.blocked.subscribe(this._updateLeverageInfo),this._subscriptions=[e,t]}}i(22190);const nt=(0,u.t)("Modify"),at=(0,u.t)("Modify order");class lt{constructor(e,t,i,s){if(this.value=new(l())(""),this.unsubscribe=()=>{this._orderSubscription&&this._orderSubscription.unsubscribe()},i||2===e)this.value.setValue(1===e?at:nt);else{const e=(0,o.ensureDefined)(s);this._orderTypeSubsctiption=(0,X.makeSubjectFromWatchedValue)(e.orderType),this._orderTypeSubj=this._orderTypeSubsctiption.subject,this._statusSubscription=(0,X.makeSubjectFromWatchedValue)(t),this._statusSubj=this._statusSubscription.subject,this._orderSubscription=N([this._orderTypeSubj,this._statusSubj,e.orderPlacingStatus,e.side,e.quantity,e.stopPrice,e.limitPrice]).subscribe(([t,i,s,r,...o])=>{const[n,a,l]=o;if(i===Q.OrderPanelStatus.Preview)return this.value.setValue((0,u.t)("Send"));if(i===Q.OrderPanelStatus.Wait)return s===Q.OrderPlacingStatus.Placed?this.value.setValue((0,u.t)("Order sent")):this.value.setValue((0,u.t)("Click any field to activate order placement"));const h=null!==a?e.formatter.format(a):"",d=null!==l?e.formatter.format(l):"",c=null!==n?e.quantityFormatter.format(n):"",p=1===r?X.i18nOrderResultText.buy:X.i18nOrderResultText.sell;switch(t){case 2:return this.value.setValue(p.market(c,e.symbol));case 3:return this.value.setValue(p.stop(c,e.symbol,h));case 1:return this.value.setValue(p.limit(c,e.symbol,d));case 4:return this.value.setValue(p.stopLimit(c,e.symbol,h,d))}})}}}class ut{constructor({marginAvailable$:e,qty$:t,currency:i,pipValue$:s,price$:r,side$:o,showTotalInsteadOfTradeValue:n,showRiskControls:a,info:u,tpInfo:h,slInfo:d,supportMargin:c,pipValueType:p}){
this._availableMargin=new(l())(0),this._usedMargin=new(l())(0),this._infoTableData=new be.WatchedObject({rows:[]},X.comparator),this._tpEnabled$=null,this._tpRiskInCurrency$=null,this._tpRiskInPercent$=null,this._slEnabled$=null,this._slRiskInCurrency$=null,this._slRiskInPercent$=null,this._riskFormatter=new J.PriceFormatter(100),this._marginAvailable$=e,this._qty$=t,this._pipValue$=s,this._side$=o,this._type=u.type,this._pipValueType=p,this._currency=i,this._marginRate=u.marginRate,this._hasMarginMeter=c&&void 0!==this._marginRate,this._price$=r,this._showTotalInsteadOfTradeValue=n,this._showRiskControls=a,this._bigPointValue=u.bigPointValue||1,this._instrumentCurrency=u.currency,this._leverage=u.leverage,this._lotSize=u.lotSize,this._symbolPipSize=u.pipSize,this._pipValueForCurrentQuantity=0,this._tradeValueInSymbolCurrency=0,this._tradeValue=0,h&&d&&(this._tpEnabled$=h.enabled,this._tpRiskInCurrency$=h.riskInCurrency,this._tpRiskInPercent$=h.riskInPercent,this._slEnabled$=d.enabled,this._slRiskInCurrency$=d.riskInCurrency,this._slRiskInPercent$=d.riskInPercent)}subscribe(){const e=[N([this._price$,this._pipValue$,this._side$,this._qty$,null!==this._tpEnabled$?this._tpEnabled$:W(null),null!==this._tpRiskInCurrency$?this._tpRiskInCurrency$:W(null),null!==this._tpRiskInPercent$?this._tpRiskInPercent$:W(null),null!==this._slEnabled$?this._slEnabled$:W(null),null!==this._slRiskInCurrency$?this._slRiskInCurrency$:W(null),null!==this._slRiskInPercent$?this._slRiskInPercent$:W(null)]).subscribe(e=>{const[t,i,,s,r,o,n,a,l,u]=e;this._pipValueForCurrentQuantity=(0,X.calculatePipValue)(s,i,this._lotSize),this._tradeValueInSymbolCurrency=null!==s?(0,X.calculateTradeValueByBigPointValue)(s,t,this._bigPointValue,this._lotSize):0,null===s?this._tradeValue=0:"crypto"===this._type?this._tradeValue=s*t:this._tradeValue=(0,X.calculateTradeValue)(s,t,i,this._symbolPipSize,this._lotSize),this._usedMargin.setValue((0,X.calculateUsedMargin)(this._tradeValue,this._marginRate));const h=[];h.push(...this._makeLeverageInfo(),...this._makeLotSizeInfo(),...this._makePipValueInfo(),...this._makeTradeValueInfo(),...this._makeRewardInfo(r,o,n),...this._makeRiskInfo(a,l,u)),this._infoTableData.setValue({rows:h})})];return this._hasMarginMeter&&e.push((0,o.ensureNotNull)(this._marginAvailable$).subscribe(e=>this._updateAvailableMargin(e))),e}title(){return(0,u.t)("Order info")}infoTableData(){return this._infoTableData}hasMarginMeter(){return this._hasMarginMeter}availableMargin(){return this._availableMargin}usedMargin(){return this._usedMargin}pipValue(){throw new Error("not supported")}tradeValue(){throw new Error("not supported")}_updateAvailableMargin(e){this._availableMargin.setValue(e)}_makeLeverageInfo(){const e=(0,X.displayedLeverage)(this._leverage,this._marginRate);return null===e?[]:[{title:(0,u.t)("Leverage"),value:e}]}_makeLotSizeInfo(){return"number"==typeof this._lotSize&&Number.isFinite(this._lotSize)?[{title:(0,u.t)("Lot size"),value:String(this._lotSize)}]:[]}_makePipValueInfo(){
return this._showRiskControls&&this._pipValueType.value()!==A.PipValueType.None&&Number.isFinite(this._pipValueForCurrentQuantity)?[{title:this._pipValueType.value()===A.PipValueType.Pips?(0,u.t)("Pip value"):(0,u.t)("Tick value"),value:`${this._currency} ${(0,X.formatInfoValue)(this._pipValueForCurrentQuantity)}`}]:[]}_makeTradeValueInfo(){const e=this._getTradeValue();if(void 0===e)return[];const t=this._showTotalInsteadOfTradeValue?(0,u.t)("Total"):(0,u.t)("Trade value"),i=this._getTradeValueInSymbolCurrency();return void 0===i?[{title:t,value:`${this._currency} ${e}`}]:[{title:t},{title:(0,u.t)("in account currency"),value:`${this._currency} ${e}`,listMarker:!0},{title:(0,u.t)("in symbol currency"),value:`${this._instrumentCurrency} ${i}`,listMarker:!0}]}_getTradeValue(){const e=this._getMarginRate();if(this._showRiskControls&&Number.isFinite(this._tradeValue)&&(this._isSymbolTypeSupportTradeValue()||void 0!==e))return(0,X.formatInfoValue)(this._tradeValue*(null!=e?e:1))}_getTradeValueInSymbolCurrency(){var e;const t=null!==(e=this._getMarginRate())&&void 0!==e?e:1;if(void 0!==this._instrumentCurrency&&this._instrumentCurrency!==this._currency&&Number.isFinite(this._tradeValueInSymbolCurrency))return(0,X.formatInfoValue)(this._tradeValueInSymbolCurrency*t)}_getMarginRate(){return void 0!==this._marginRate&&this._marginRate>0?this._marginRate:void 0}_isSymbolTypeSupportTradeValue(){return void 0!==this._type&&["stock","dr","right","bond","warrant","structured"].includes(this._type)}_makeRewardInfo(e,t,i){return this._showRiskControls&&e&&null!==t&&null!==i?[{title:(0,u.t)("Reward"),value:this._riskFormatter.format(i)+"% ("+this._currency+" "+this._riskFormatter.format(t)+")"}]:[]}_makeRiskInfo(e,t,i){return this._showRiskControls&&e&&null!==t&&null!==i?[{title:(0,u.t)("Risk"),value:this._riskFormatter.format(i)+"% ("+this._currency+" "+this._riskFormatter.format(t)+")"}]:[]}}const ht=(0,Y.getLogger)("PromiseWithDefault");function dt(e,t,i){return e.catch(e=>(ht.logError(e),i&&i(),t))}const ct={symbol:(0,u.t)("Symbol"),ask:(0,u.t)("Ask"),bid:(0,u.t)("Bid"),orderType:(0,u.t)("Type"),side:(0,u.t)("Side"),quantity:(0,u.t)("Quantity"),price:(0,u.t)("Price"),stopPrice:(0,u.t)("Stop price"),limitPrice:(0,u.t)("Limit price"),currency:(0,u.t)("Currency"),stopLoss:(0,u.t)("Stop Loss"),takeProfit:(0,u.t)("Take Profit"),buy:(0,u.t)("Buy"),sell:(0,u.t)("Sell"),warning:(0,u.t)("Estimated money impact is for main order only.")};class pt{constructor(e,t,i,s,r,o,n,a){this.warnings=[],this.errors=[],this._infoTableQuotesData=new be.WatchedObject({rows:[]},X.comparator),this._infoTableOrderData={rows:[]},this._infoTableCustomData=[],this.order=e,this.confirmId=t.confirmId,this.onCancelClick=s,this.onPlaceClick=r,this._quotes$=i,this._currency=a,this._formatter=o,this._quantityFormatter=n,this._infoTableCustomData=t.sections,this._fillQuotesInfo(),this._fillOrderInfo(),(e.takeProfit||e.stopLoss)&&this.warnings.push(ct.warning),t.warnings&&this.warnings.push(...t.warnings),t.errors&&this.errors.push(...t.errors)}subscribe(){
return this._quotes$.subscribe(e=>this._fillQuotesInfo(e))}infoTableQuotesData(){return this._infoTableQuotesData}infoTableOrderData(){return this._infoTableOrderData}infoTableCustomData(){return this._infoTableCustomData}_fillQuotesInfo(e){const t=[{title:ct.symbol,value:this.order.symbol},{title:ct.ask,value:e?this._formatter.format(e.ask):""},{title:ct.bid,value:e?this._formatter.format(e.bid):""}];this._infoTableQuotesData.setValue({rows:t})}_fillOrderInfo(){this._infoTableOrderData.rows.push({title:ct.orderType,value:this.order.type?Q.orderTypes[this.order.type]:""},{title:ct.side,value:1===this.order.side?ct.buy:ct.sell,type:1===this.order.side?0:1},{title:ct.quantity,value:this._quantityFormatter.format(this.order.qty)}),3!==this.order.type&&1!==this.order.type||this._infoTableOrderData.rows.push({title:ct.price,value:this._formatter.format(3===this.order.type?this.order.stopPrice:this.order.limitPrice)}),4===this.order.type&&this._infoTableOrderData.rows.push({title:ct.stopPrice,value:this._formatter.format(this.order.stopPrice)},{title:ct.limitPrice,value:this._formatter.format(this.order.limitPrice)}),this.order.stopLoss&&this._infoTableOrderData.rows.push({title:ct.stopLoss,value:String(this.order.stopLoss)}),this.order.takeProfit&&this._infoTableOrderData.rows.push({title:ct.takeProfit,value:String(this.order.takeProfit)}),this._currency.length>0&&this._infoTableOrderData.rows.push({title:ct.currency,value:this._currency})}}const _t=(0,Y.getLogger)("Trading.OrderViewModel");function bt(e){return"ComboBox"===e.type}class yt{constructor({adapter:e,order:t,mode:i,settings:s,isTradable:r,isTradingPanelVisible:n,isTradingPanelOpened:a,orderWidgetStat:_=null,pipValueType:b,onNeedSelectBroker:g,trackEvent:P,toggleTradingWidget:m,showErrorNotification:v,handler:f,savedInputState:M,forceAbsolutePriceUpdate:C,qtySuggester:w}){var T;if(this.orderType=new(l())(null),this.orderInfoModel=null,this.orderPreviewModel=null,this.customFieldModels=new(l())([]),this.onDoneButtonClicked=(0,h.createDeferredPromise)(),this.status=new(l())(Q.OrderPanelStatus.Active),this.rewardRisk=new(l())(""),this.disabled=new(l())(!0),this.loading=new(l())(!1),this.needSignIn=!1,this.noBroker=!1,this.isNoQuotes=new(l())(!1),this.symbolHasLotSize=!1,this.id=(0,z.randomHashN)(6),this.existingOrder=!1,this._isEmptyRequiredCustomFieldsHighlighted=new(l())(!1),this._prevOrderType=new(l())(null),this._onModeChanged=new(H()),this._onInputStateChanged=new(H()),this._onCloseButtonClicked=new(H()),this._onBackButtonClicked=new(H()),this._subscriptions=[],this._stopLossPips=new y.BehaviorSubject(null),this._orderWidgetStat=null,this._existingPlacedOrder=null,this._marginAvailable$=null,this._baseCurrencyCryptoBalance$=null,this._quoteCurrencyCryptoBalance$=null,this._orderPlacingStatus=new y.BehaviorSubject(Q.OrderPlacingStatus.Creating),this._destroyed=!1,this._setSolutionAccount=null,this._isBats=!1,this._isCustomFieldsNotSelected=new(l())(!0),this.doneButtonClick=()=>{var e;if(this.loading.value())return;this.loading.setValue(!0)
;const t=this.sideModel.currentQuotes(),i=this.sideModel.getValue(),s=null!==(e=1===i?t.ask:t.bid)&&void 0!==e?e:0;let r={symbol:this.symbol,type:(0,o.ensureNotNull)(this.orderType.value()),side:i,qty:0,seenPrice:s};r.qty=(0,o.ensureNotNull)(this.quantityModel.$value.getValue()),4===this.orderType.value()?(r.stopPrice=(0,o.ensureNotNull)(this.stopPriceModel.$value.getValue()),r.limitPrice=(0,o.ensureNotNull)(this.limitPriceModel.$value.getValue())):3===this.orderType.value()?r.stopPrice=(0,o.ensureNotNull)(this.stopPriceModel.$value.getValue()):1===this.orderType.value()&&(r.limitPrice=(0,o.ensureNotNull)(this.limitPriceModel.$value.getValue()));const n=this.durationModel.getValue();null!==n&&(r.duration=n),this.stopLossModel&&(delete r.stopLoss,delete r.trailingStopPips,this.stopLossModel.getBracketType()===A.BracketType.StopLoss&&(r.stopLoss=this.stopLossModel.getEnabled()?(0,o.ensureNotNull)(this.stopLossModel.getValue()&&this.stopLossModel.price.getValue()):void 0,r.trailingStopPips=void 0),this.stopLossModel.getBracketType()===A.BracketType.TrailingStop&&(r.trailingStopPips=this.stopLossModel.getEnabled()?(0,o.ensureNotNull)(this.stopLossModel.getValue()):void 0,r.stopLoss=void 0!==r.trailingStopPips?void 0:r.stopLoss)),this.takeProfitModel&&(r.takeProfit=this.takeProfitModel.getEnabled()?(0,o.ensureNotNull)(this.takeProfitModel.getValue()&&this.takeProfitModel.price.getValue()):void 0),Array.isArray(this.customFieldModels.value())&&(r.customFields=this._getCustomFields());if((this.existingOrder?this.supportModifyOrderPreview:this.supportPlaceOrderPreview)&&this._settings.value().showOrderPreview){if(null===this.orderPreviewModel){const e=this.supportModifyOrderPreview&&null!==this._existingPlacedOrder?{...r,id:this._existingPlacedOrder.id}:r;return void this._adapter.previewOrder(e).then(t=>{this.orderPreviewModel=new pt(e,t,this._quotes$,this._back,this.doneButtonClick,this.formatter,this.quantityModel.formatter,this.supportCurrencyInOrderPreview?(0,o.ensureDefined)(this.currency):""),this._subscriptions.push(this.orderPreviewModel.subscribe()),this.loading.setValue(!1),this.status.setValue(Q.OrderPanelStatus.Preview)}).catch(e=>{this.loading.setValue(!1),this._showErrorNotification((0,u.t)("Order preview"),"object"==typeof e?e.message:e)})}r=this.orderPreviewModel.order}this._doneHandler(r,null!==this.orderPreviewModel?this.orderPreviewModel.confirmId:void 0).then(e=>{this.loading.setValue(!1),e&&(this.onDoneButtonClicked.resolve(!0),this.mode.value()===Q.OrderEditorDisplayMode.Popup?this.headerModel.close():this._backToDefaultOrderPanel(),this.existingOrder||this._orderPlacingStatus.next(Q.OrderPlacingStatus.Placed)),e||null===this.orderPreviewModel||this._back(),this.orderPreviewModel=null})},this.activateOrderPanel=()=>{this.status.setValue(this.existingOrder?Q.OrderPanelStatus.Editing:Q.OrderPanelStatus.Active),this.orderType.unsubscribe(this.activateOrderPanel),this.sideModel&&this.sideModel.onControlFocused.unsubscribe(this,this.activateOrderPanel),
this.limitPriceModel&&this.limitPriceModel.onControlFocused.unsubscribe(this,this.activateOrderPanel),this.stopPriceModel&&this.stopPriceModel.onControlFocused.unsubscribe(this,this.activateOrderPanel),this.quantityModel&&this.quantityModel.onControlFocused.unsubscribe(this,this.activateOrderPanel),this.takeProfitModel&&this.takeProfitModel.onControlFocused.unsubscribe(this,this.activateOrderPanel),this.stopLossModel&&this.stopLossModel.onControlFocused.unsubscribe(this,this.activateOrderPanel),this.durationModel&&this.durationModel.onControlFocused.unsubscribe(this,this.activateOrderPanel),Array.isArray(this.customFieldModels.value())&&this.customFieldModels.value().length>0&&this.customFieldModels.value().forEach(e=>{e.onControlFocused.unsubscribe(this,this.activateOrderPanel)}),this._orderPlacingStatus.next(Q.OrderPlacingStatus.Creating)},this._noQuotesCallback=()=>{this._trackEvent("Order Ticket","No Quotes")},this._updateMode=()=>{this.mode.value()===Q.OrderEditorDisplayMode.Popup&&this.status.value()!==Q.OrderPanelStatus.Preview&&this.activateOrderPanel(),this.toggleCancelButton()},this._mergeInputStateDiff=e=>{(0,d.default)(this._currentInputState,e)},this._syncOrderPricesAndFocuses=()=>{1===this.orderType.value()&&4===this._prevOrderType.value()&&(this.limitPriceModel.forceAbsolutePriceUpdate(this.stopPriceModel.price.value()),this.limitPriceModel.forceRelativePriceUpdate()),1===this.orderType.value()&&3===this._prevOrderType.value()&&(this.limitPriceModel.forceAbsolutePriceUpdate(this.stopPriceModel.price.value()),this.limitPriceModel.focusedControl.setValue(this.stopPriceModel.focusedControl.value()),this.limitPriceModel.forceRelativePriceUpdate()),3===this.orderType.value()&&1===this._prevOrderType.value()&&(this.stopPriceModel.forceAbsolutePriceUpdate(this.limitPriceModel.price.value()),this.stopPriceModel.focusedControl.setValue(this.limitPriceModel.focusedControl.value()),this.stopPriceModel.forceRelativePriceUpdate()),4===this.orderType.value()&&(1===this._prevOrderType.value()&&(this.stopPriceModel.forceAbsolutePriceUpdate(this.limitPriceModel.price.value()),this.stopPriceModel.forceRelativePriceUpdate()),3===this._prevOrderType.value()&&this.limitPriceModel.forceAbsolutePriceUpdate(this.stopPriceModel.price.value()),this._syncStopLimitPrices(),this.limitPriceModel.forceStopLimitRelativePriceUpdate()),this._prevOrderType.setValue(this.orderType.value())},this._syncStopLimitPrices=()=>{4===this.orderType.value()&&this.limitPriceModel.syncWithPrice(this.stopPriceModel.price.value())},this._back=()=>{this._cleanUp(),this._onBackButtonClicked.fire()},this._highlightEmptyRequiredCustomFields=()=>{this._isEmptyRequiredCustomFieldsHighlighted.setValue(!0)},this._checkIsCustomFieldNotSelected=()=>{const e=[];for(const t of this.customFieldModels.value())bt(t)&&e.push(t);const t=e.some(e=>void 0===e.selectedItem.value());this._isCustomFieldsNotSelected.setValue(t)},this._onSuggestedQtyChange=e=>{this._suggestedQty=e,
this.quantityModel&&this.quantityModel.quantity.value.value()!==e&&(this.quantityModel.focusedControl.setValue(this.supportCryptoExchangeOrderTicket?3:0),this.quantityModel.quantity.value.setValue(e))},this._onQtyChange=e=>{null!==e&&this._qtySuggester.setQty(this.symbol,e)},this._toggleTradingWidget=m,this._onNeedSelectBroker=g,this._showErrorNotification=v,this._trackEvent=P,this._orderWidgetStat=_,this._pipValueType=b,this._qtySuggester=w,this.mode=i,this._settings=s,function(e){return e.hasOwnProperty("id")}(t)&&(this.existingOrder=!0,this._existingPlacedOrder=t),this.status=new(l())(this.existingOrder?Q.OrderPanelStatus.Editing:Q.OrderPanelStatus.Active),this.isEmptyRequiredCustomFieldsHighlighted=this._isEmptyRequiredCustomFieldsHighlighted.readonly(),this.symbol=t.symbol,this._orderStatusSubscription=(0,X.makeSubjectFromWatchedValue)(this.status),this._loadingSubscription=(0,X.makeSubjectFromWatchedValue)(this.loading),this._status=this._orderStatusSubscription.subject,this._loading=this._loadingSubscription.subject,this._isTradingPanelVisible=n,this._isTradingPanelOpened=a,this._stopLossAvailable=new y.BehaviorSubject(Boolean(t.trailingStopPips?t.trailingStopPips:t.stopLoss)),null===e)return void(this.onReady=Promise.resolve());if(this._adapter=e,this.brokerName=e.metainfo().title,!r.tradable)return void(this.onReady=this._prepareTradableSolution(r));this._handler=f,this._orderTemplate=Object.assign({},t),this.existingOrder=t.hasOwnProperty("id"),this.status.setValue(this.existingOrder?Q.OrderPanelStatus.Editing:Q.OrderPanelStatus.Active);const O=e.metainfo().configFlags;this.supportModifyOrderPrice=O.supportModifyOrderPrice,this.supportModifyQuantity=!this.existingOrder||Boolean(this.existingOrder&&O.supportEditAmount),this.showQuantityInsteadOfAmount=O.showQuantityInsteadOfAmount,this.supportMarketOrders=O.supportMarketOrders,this.supportLimitOrders=O.supportLimitOrders,this.supportStopOrders=O.supportStopOrders,this.supportStopLimitOrders=O.supportStopLimitOrders,this.supportBrackets=O.supportOrderBrackets&&!(t.hasOwnProperty("parentId")&&t.parentId),this.supportModifyBrackets=this.supportBrackets&&O.supportModifyBrackets,this.supportAddBracketsToExistingOrder=this.supportModifyBrackets&&O.supportAddBracketsToExistingOrder,this.supportTrailingStop=this.supportBrackets&&O.supportTrailingStop,this.supportModifyTrailingStop=this.supportTrailingStop&&O.supportModifyTrailingStop,this.supportMarketBrackets=this.supportBrackets&&O.supportMarketBrackets,this.supportModifyDuration=O.supportModifyDuration,this.supportLeverage=O.supportLeverage,this.supportPlaceOrderPreview=O.supportPlaceOrderPreview,this.supportModifyOrderPreview=O.supportModifyOrderPreview,this.supportCryptoExchangeOrderTicket=O.supportCryptoExchangeOrderTicket,this.supportBalances=O.supportBalances,this.supportCryptoBrackets=O.supportCryptoBrackets,this.supportStopOrdersInBothDirections=O.supportStopOrdersInBothDirections,this.supportCurrencyInOrderPreview=O.supportCurrencyInOrderPreview,
this.orderType.setValue("type"in t&&t.type||this.supportLimitOrders&&1||this.supportMarketOrders&&2||this.supportStopLimitOrders&&4||this.supportStopOrders&&3||null),this._prevOrderType.setValue(this.orderType.value()),this._orderTypeSubscription=(0,X.makeSubjectFromWatchedValue)(this.orderType),this._orderType=this._orderTypeSubscription.subject,this.onReady=Promise.all([e.symbolInfo(t.symbol),e.getOrderDialogOptions(t.symbol),dt(e.accountMetainfo(),{id:e.currentAccount(),name:e.metainfo().title}),dt(e.quotesSnapshot(t.symbol),{},this._noQuotesCallback),dt(e.formatter(t.symbol,!1),new J.PriceFormatter),dt(e.spreadFormatter(t.symbol),new J.PriceFormatter),null===(T=this.leverageModel)||void 0===T?void 0:T.ready]).then(async([i,s,o,n,a,l])=>{this._isBats=(0,G.isBatsQuotes)(n),this._symbolInfo=i,this._destroyed||(this.displaySymbolName=i.brokerSymbol||"brokerSymbol"in t&&t.brokerSymbol||this.symbol,this.symbolType=i.type,this.currency=(0,G.getCurrency)(o),this._currencyName=(0,G.getCurrency)(o,!0),this.formatter=a,this.symbolHasLotSize=i.hasOwnProperty("lotSize"),this.showRiskControls=O.supportRiskControls&&0!==i.pipValue,this._suggestedQty=await this._qtySuggester.getQty(this.symbol),this._initialInputState=this._getInitialInputState(t,i,M),this._currentInputState=Object.assign({},this._initialInputState),this.customFieldModels.setValue((0,X.createCustomFieldModels)(this.existingOrder,this.status,this._isEmptyRequiredCustomFieldsHighlighted,s,Object.assign(this._currentInputState.customFields||{},t.customFields))),this._checkIsCustomFieldNotSelected(),this._quotes$=k(i=>e.subscribeRealtime(t.symbol,i),i=>e.unsubscribeRealtime(t.symbol,i),(e,t)=>(0,X.alignQuotesToMinTick)(t,i.minTick)).pipe((0,c.share)({connector:()=>new S.ReplaySubject(1)})),this._equity$=k(t=>e.subscribeEquity(t),t=>e.unsubscribeEquity(t),(e,t)=>t).pipe((0,p.startWith)(NaN),(0,c.share)({connector:()=>new S.ReplaySubject(1)})),this._marginAvailable$=O.supportMargin?V(k(t=>e.subscribeMarginAvailable(t),t=>e.unsubscribeMarginAvailable(t),(e,t)=>t)):null,this._baseCurrencyCryptoBalance$=O.supportBalances?V(k(t=>e.subscribeCryptoBalance(i.baseCurrency||"",t),t=>e.unsubscribeCryptoBalance(i.baseCurrency||"",t),(e,t)=>t).pipe((0,p.startWith)({symbol:i.baseCurrency||"",total:0,available:0}))):null,this._quoteCurrencyCryptoBalance$=O.supportBalances?V(k(t=>e.subscribeCryptoBalance(i.quoteCurrency||"",t),t=>e.unsubscribeCryptoBalance(i.quoteCurrency||"",t),(e,t)=>t).pipe((0,p.startWith)({symbol:i.quoteCurrency||"",total:0,available:0}))):null,this._pipValues$=V(k(i=>e.subscribePipValue(t.symbol,i),i=>e.unsubscribePipValue(t.symbol,i),(e,t)=>t).pipe((0,p.startWith)({buyPipValue:i.pipValue,sellPipValue:i.pipValue}))),0===this._orderTemplate.limitPrice&&!1===this.existingOrder&&(this._orderTemplate.limitPrice=1===this._orderTemplate.side?(0,X.getAsk)(n):(0,X.getBid)(n)),0===this._orderTemplate.stopPrice&&!1===this.existingOrder&&(this._orderTemplate.stopPrice=1===this._orderTemplate.side?(0,X.getBid)(n):(0,X.getAsk)(n)),this._createModels(t,i,l,r.tradable,C,s),
this._subscribe(),this._onInputStateChanged.fire(this._getCurrentInputState()))}).catch(e=>{throw _t.logError("Failed to create order model: "+e),e})}destroy(){this._destroyed=!0,this.onInputStateChanged().unsubscribe(this,this._mergeInputStateDiff),this._subscriptions.forEach(e=>e&&e.unsubscribe()),this._orderStatusSubscription.unsubscribe(),this._loadingSubscription.unsubscribe(),this._orderTypeSubscription&&this._orderTypeSubscription.unsubscribe(),this.headerModel&&(this.headerModel.unsubscribe(),this.headerModel.pinButtonClicked().unsubscribe(this,this._toggleMode),this.headerModel.cancelButtonClicked().unsubscribe(this,this._cancel),this.headerModel.closeButtonClicked().unsubscribe(this,this._closeWidget),this.headerModel.backButtonClicked().unsubscribe(this,this._back)),this.sideModel&&(this.sideModel.unsubscribe(),this.sideModel.onControlFocused.unsubscribe(this,this.activateOrderPanel)),this.limitPriceModel&&(this.limitPriceModel.unsubscribe(),this.limitPriceModel.onControlFocused.unsubscribe(this,this.activateOrderPanel)),this.stopPriceModel&&(this.stopPriceModel.price.unsubscribe(this._syncStopLimitPrices),this.stopPriceModel.unsubscribe(),this.stopPriceModel.onControlFocused.unsubscribe(this,this.activateOrderPanel)),this.quantityModel&&(this.quantityModel.unsubscribe(),this.quantityModel.onControlFocused.unsubscribe(this,this.activateOrderPanel),this.quantityModel.quantity.value.unsubscribe(this._onQtyChange)),this.takeProfitModel&&(this.takeProfitModel.unsubscribe(),this.takeProfitModel.onControlFocused.unsubscribe(this,this.activateOrderPanel)),this.stopLossModel&&(this.stopLossModel.unsubscribe(),this.stopLossModel.onControlFocused.unsubscribe(this,this.activateOrderPanel)),this.durationModel&&(this.durationModel.unsubscribe(),this.durationModel.onControlFocused.unsubscribe(this,this.activateOrderPanel)),void 0!==this.leverageModel&&(this.leverageModel.unsubscribe(),this.leverageModel.onControlFocused.unsubscribe(this,this.activateOrderPanel)),Array.isArray(this.customFieldModels.value())&&this.customFieldModels.value().length>0&&this.customFieldModels.value().forEach(e=>{e.onControlFocused.unsubscribe(this,this.activateOrderPanel),e.subscription&&e.subscription.unsubscribe()}),this.buttonModel&&this.buttonModel.unsubscribe(),this._customFieldsSubscription&&this._customFieldsSubscription.unsubscribe(),this._adapter&&this._adapter.orderUpdate.unsubscribe(this,this._orderUpdate),this.orderType.unsubscribe(this._syncOrderPricesAndFocuses),this.orderType.unsubscribe(this.activateOrderPanel),this.mode.unsubscribe(this._updateMode)}onModeChanged(){return this._onModeChanged}onInputStateChanged(){return this._onInputStateChanged}onCloseButtonClicked(){return this._onCloseButtonClicked}onBackButtonClicked(){return this._onBackButtonClicked}side(){var e;return null===(e=this.sideModel)||void 0===e?void 0:e.getValue()}setSolutionAccount(){null!==this._setSolutionAccount&&this._setSolutionAccount()}selectBroker(){this._toggleTradingWidget().then(()=>this._onNeedSelectBroker.fire())}orderWidgetStat(){
return this._orderWidgetStat}resetOrderPanel(){this._cancel()}deactivateOrderPanel(){this.status.value()!==Q.OrderPanelStatus.Wait&&(this.status.setValue(Q.OrderPanelStatus.Wait),this.orderType.subscribe(this.activateOrderPanel),this.sideModel&&this.sideModel.onControlFocused.subscribe(this,this.activateOrderPanel),this.limitPriceModel&&this.limitPriceModel.onControlFocused.subscribe(this,this.activateOrderPanel),this.stopPriceModel&&this.stopPriceModel.onControlFocused.subscribe(this,this.activateOrderPanel),this.quantityModel&&this.quantityModel.onControlFocused.subscribe(this,this.activateOrderPanel),void 0!==this.leverageModel&&this.leverageModel.onControlFocused.subscribe(this,this.activateOrderPanel),this.takeProfitModel&&(this.takeProfitModel.setEnabled(!1),this.takeProfitModel.onControlFocused.subscribe(this,this.activateOrderPanel)),this.stopLossModel&&(this.stopLossModel.setEnabled(!1),this.stopLossModel.onControlFocused.subscribe(this,this.activateOrderPanel)),this.durationModel&&this.durationModel.onControlFocused.subscribe(this,this.activateOrderPanel),Array.isArray(this.customFieldModels.value())&&this.customFieldModels.value().length>0&&this.customFieldModels.value().forEach(e=>{e.onControlFocused.subscribe(this,this.activateOrderPanel)}),this._setDisabledIfNeeded({status:this._status.getValue(),loading:this._loading.getValue(),quotes:null,side:this.sideModel?this.sideModel.getValue():null,limitPrice:this.limitPriceModel?this.limitPriceModel.$value.getValue():null,stopPrice:this.stopPriceModel?this.stopPriceModel.$value.getValue():null,quantity:this.quantityModel?this.quantityModel.$value.getValue():null,isTakeProfitIncorrect:!!this.takeProfitModel&&this.takeProfitModel.isValueIncorrect(),isStopLossIncorrect:!!this.stopLossModel&&this.stopLossModel.isValueIncorrect(),customFields:this._getCustomFields(this.customFieldModels.value())}))}toggleCancelButton(){this.mode.value()===Q.OrderEditorDisplayMode.Panel&&this.status.value()===Q.OrderPanelStatus.Active?this.headerModel.showCancelButton():this.headerModel.hideCancelButton()}_createSimpleDialog(e){this.orderType.setValue(null),this.status.setValue(Q.OrderPanelStatus.Wait),this.headerModel=new de(this.symbol,this.symbol,e?e.metainfo().title:"",this.mode,this.status,1,!1,!1,this._quotes$,this._isTradingPanelVisible,void 0,void 0,this._isBats),this.headerModel.closeButtonClicked().subscribe(this,this._closeWidget)}_createModels(e,t,i,s,r,n){var a,l;this.sideModel=new pe({initialSide:this._orderTemplate.side||1,quotes$:this._quotes$,priceFormatter:this.formatter,spreadFormatter:i,status:this.status,baseCurrency:this.supportCryptoExchangeOrderTicket&&"crypto"===t.type&&t.baseCurrency||null}),this._pipValue$=N([this._pipValues$,this.sideModel.value$]).pipe((0,_.map)(([e,t])=>1===t?e.buyPipValue:e.sellPipValue));const{orderRules:u=[],title:h}=this._adapter.metainfo();let d=[],c=[];var p,y;this.supportStopOrdersInBothDirections||(d=null!==(p=this._adapter,y=this.symbol,a=ne(p,y,ie))&&void 0!==a?a:[],c=null!==(l=function(e,t){return ne(e,t,te)
}(this._adapter,this.symbol))&&void 0!==l?l:[]),this.limitPriceModel=new Se(this._quotes$,this.sideModel.value$,this.sideModel.getValue(),t,this.status,this._orderTemplate.limitPrice,this.formatter,this.orderType,!0,this._settings,h,this._orderWidgetStat,[...u,...d],r),this.stopPriceModel=new Se(this._quotes$,this.sideModel.value$,this.sideModel.getValue(),t,this.status,this._orderTemplate.stopPrice,this.formatter,this.orderType,!1,this._settings,h,this._orderWidgetStat,[...u,...c],r,this.supportStopOrdersInBothDirections),this._syncStopLimitPrices(),this._price$=N([this._orderType,this.sideModel.value$,this._quotes$,this.stopPriceModel.$value,this.limitPriceModel.$value]).pipe((0,_.map)(([e,t,i,s,r])=>{const o=1===t?(0,X.getAsk)(i):(0,X.getBid)(i),n=(i.trade?i.trade:o)||0;switch(this._initialInputState.limitPrice=o,this._initialInputState.stopPrice=o,e){case 1:case 4:return(null===r?this.limitPriceModel.price.value():r)||n;case 3:return(null===s?this.stopPriceModel.price.value():s)||n;default:return o}}),(0,b.distinctUntilChanged)()),this.supportCryptoExchangeOrderTicket?this.quantityModel=new Re(t,this._price$,this._baseCurrencyCryptoBalance$,this._quoteCurrencyCryptoBalance$,this._initialInputState.quantity,this.status,this.sideModel.value$,this.sideModel.getValue,this._orderWidgetStat):this.quantityModel=new $e(this._stopLossAvailable,this._stopLossPips,this._equity$,this._pipValue$,t,(0,o.ensureDefined)(this.currency),this._initialInputState.quantity,this.status,this._settings,this._orderWidgetStat,this.showRiskControls),this.quantityModel.quantity.value.subscribe(this._onQtyChange),(this.supportBrackets||this.supportCryptoBrackets)&&this._createBracketsModels(e,t,(0,o.ensureDefined)(this.currency)),this.headerModel=new de(this.displaySymbolName,this.symbol,this._adapter.metainfo().title,this.mode,this.status,1,this.existingOrder,s,this._quotes$,this._isTradingPanelVisible,e,this.formatter,this._isBats);const g=(0,X.shouldShowTotal)(n);this.supportCryptoExchangeOrderTicket||(this.orderInfoModel=new ut({marginAvailable$:this._marginAvailable$,qty$:this.quantityModel.$value,currency:(0,o.ensureDefined)(this._currencyName),pipValue$:this._pipValue$,price$:this._price$,side$:this.sideModel.value$,showTotalInsteadOfTradeValue:g,showRiskControls:this.showRiskControls,info:t,tpInfo:this.supportBrackets&&this.takeProfitModel?{enabled:this.takeProfitModel.enabled$,riskInCurrency:this.takeProfitModel.riskInCurrency.value$,riskInPercent:this.takeProfitModel.riskInPercent.value$}:null,slInfo:this.supportBrackets&&this.stopLossModel?{enabled:this.stopLossModel.enabled$,riskInCurrency:this.stopLossModel.riskInCurrency.value$,riskInPercent:this.stopLossModel.riskInPercent.value$}:null,supportMargin:this._adapter.metainfo().configFlags.supportMargin||!1,pipValueType:this._pipValueType})),this.durationModel=new et(this._initialInputState.duration,this._getDurationMetaInfoList(),this.orderType,this._orderWidgetStat),this.supportLeverage&&(this.leverageModel=new ot({adapterLeverageInfo:this._adapter.leverageInfo,
adapterSetLeverage:this._adapter.setLeverage,adapterPreviewLeverage:this._adapter.previewLeverage,brokerName:this._adapter.metainfo().title,symbol:this.symbol,displaySymbol:this.displaySymbolName,orderType$:this._orderType,side$:this.sideModel.value$,initialSide:this.sideModel.getValue(),customFieldModels:this.customFieldModels,customFieldsGetter:this._getCustomFields,blocked:this._isCustomFieldsNotSelected,onBlockedClick:this._highlightEmptyRequiredCustomFields}))}_createBracketsModels(e,t,i){const s=ae(this._adapter,this.symbol),r=le(this._adapter,this.symbol);this.takeProfitModel=new Je({initialPrice:e.takeProfit||null,initialEnabled:Boolean(e.takeProfit),initialBracketType:A.BracketType.TakeProfit,formatter:this.formatter,equity$:this._equity$,quotes$:this._quotes$,info:t,pipValue$:this._pipValue$,side$:this.sideModel.value$,amount$:this.quantityModel.$value,parentPrice$:this._price$,orderType$:this._orderType,currency:i,parentType:1,savedPips:this._currentInputState.takeProfitPips,settings:this._settings,orderWidgetStat:this._orderWidgetStat,showRiskControls:this.showRiskControls,status:this.status.value(),validationRules:s,supportModifyBrackets:this.supportModifyBrackets,supportModifyTrailingStop:this.supportModifyTrailingStop,supportCryptoBrackets:this.supportCryptoBrackets,supportAddBracketsToExistingOrder:this.supportAddBracketsToExistingOrder});const o=Boolean(e.trailingStopPips);this.stopLossModel=new Je({initialPrice:o?null:e.stopLoss||null,initialEnabled:Boolean(o?e.trailingStopPips:e.stopLoss),initialBracketType:o?A.BracketType.TrailingStop:A.BracketType.StopLoss,formatter:this.formatter,equity$:this._equity$,quotes$:this._quotes$,info:t,pipValue$:this._pipValue$,side$:this.sideModel.value$,amount$:this.quantityModel.$value,parentPrice$:this._price$,orderType$:this._orderType,currency:i,parentType:1,savedPips:(o?e.trailingStopPips:this._currentInputState.stopLossPips)||null,settings:this._settings,orderWidgetStat:this._orderWidgetStat,showRiskControls:this.showRiskControls,status:this.status.value(),validationRules:r,supportModifyBrackets:this.supportModifyBrackets,supportModifyTrailingStop:this.supportModifyTrailingStop,supportCryptoBrackets:this.supportCryptoBrackets,supportAddBracketsToExistingOrder:this.supportAddBracketsToExistingOrder}),this.supportCryptoExchangeOrderTicket||(this.stopLossModel.focusedControl$.subscribe(e=>{2!==e&&3!==e||this.quantityModel.focusedControl.setValue(0)}),this.quantityModel.focusedControl.subscribe(e=>{!this.stopLossModel||1===this.stopLossModel.getFocusedControl()||1!==e&&2!==e||this.stopLossModel.setFocusedControl(0)}))}_subscribe(){var e,t,i,s,r,o,n,a;if(this.mode.subscribe(this._updateMode),this.onInputStateChanged().subscribe(this,this._mergeInputStateDiff),this.headerModel.pinButtonClicked().subscribe(this,this._toggleMode),this.headerModel.cancelButtonClicked().subscribe(this,this._cancel),this.headerModel.closeButtonClicked().subscribe(this,this._closeWidget),this.headerModel.backButtonClicked().subscribe(this,this._back),
this.buttonModel=new lt(1,this.status,this.existingOrder,{orderType:this.orderType,side:this.sideModel.value$,quantity:this.quantityModel.$value,symbol:this.displaySymbolName,stopPrice:this.stopPriceModel.$value,limitPrice:this.limitPriceModel.$value,formatter:this.formatter,quantityFormatter:this.quantityModel.formatter,orderPlacingStatus:this._orderPlacingStatus}),this._buttonDataSubscription=N({status:this._status,side:this.sideModel.value$,loading:this._loading,quotes:this._quotes$,limitPrice:this.limitPriceModel.$value,stopPrice:this.stopPriceModel.$value,quantity:this.quantityModel.$value,takeProfit:null!==(t=null===(e=this.takeProfitModel)||void 0===e?void 0:e.value$)&&void 0!==t?t:W(null),stopLoss:null!==(s=null===(i=this.stopLossModel)||void 0===i?void 0:i.value$)&&void 0!==s?s:W(null),takeProfitEnabled:null!==(o=null===(r=this.takeProfitModel)||void 0===r?void 0:r.enabled$)&&void 0!==o?o:W(!1),stopLossEnabled:null!==(a=null===(n=this.stopLossModel)||void 0===n?void 0:n.enabled$)&&void 0!==a?a:W(!1),duration:this.durationModel.$value}).subscribe(e=>{const{status:t,side:i,loading:s,quotes:r,limitPrice:o,stopPrice:n,quantity:a,takeProfit:l,stopLoss:u,takeProfitEnabled:h,stopLossEnabled:d,duration:c}=e;this._setDisabledIfNeeded({status:t,loading:s,quotes:r,side:i,limitPrice:o,stopPrice:n,quantity:a,isTakeProfitIncorrect:h&&null===l,isStopLossIncorrect:d&&null===u,customFields:this._getCustomFields(this.customFieldModels.value())}),this._compareInputStates({side:i,limitPrice:o,stopPrice:n,quantity:a,takeProfit:l,stopLoss:u,duration:c})}),this._waitQuotesTimeout=setTimeout(()=>this.isNoQuotes.setValue(!0),5e3),this._noQuotesSubscription=this._quotes$.subscribe(e=>{this.isNoQuotes.setValue((0,X.isNoQuotes)(e)),clearTimeout(this._waitQuotesTimeout)}),this.customFieldModels){const e=[];for(const t of this._getSavableCustomFieldsModels()){const i="Checkbox"===t.type?t.checked:t.selectedItem,s=(0,X.makeSubjectFromWatchedValue)(i);e.push(s.subject),t.subscription=s}this._customFieldsSubscription=N(e).subscribe(()=>{this._setDisabledIfNeeded({status:this._status.getValue(),loading:this._loading.getValue(),quotes:this.sideModel.currentQuotes(),side:this.sideModel?this.sideModel.getValue():null,limitPrice:this.limitPriceModel?this.limitPriceModel.$value.getValue():null,stopPrice:this.stopPriceModel?this.stopPriceModel.$value.getValue():null,quantity:this.quantityModel?this.quantityModel.$value.getValue():null,isTakeProfitIncorrect:!!this.takeProfitModel&&this.takeProfitModel.isValueIncorrect(),isStopLossIncorrect:!!this.stopLossModel&&this.stopLossModel.isValueIncorrect(),customFields:this._getCustomFields(this.customFieldModels.value())}),this._onInputStateChanged.fire({customFields:this._getCustomFields(this._getSavableCustomFieldsModels())}),this._checkIsCustomFieldNotSelected()})}if(this._subscriptions=[this.sideModel.subscribe(),this.limitPriceModel.subscribe(),this.stopPriceModel.subscribe(),this._price$.subscribe(),this._qtySuggester.suggestedQtyChanged(this.symbol).subscribe(this._onSuggestedQtyChange)],
void 0!==this.takeProfitModel&&this._subscriptions.push(...this.takeProfitModel.subscribe()),void 0!==this.stopLossModel){const e=N([this.stopLossModel.value$,this.stopLossModel.enabled$]).subscribe(([e,t])=>{this._stopLossAvailable.next(t),t&&this._stopLossPips.next(e)});this._subscriptions.push(e,...this.stopLossModel.subscribe())}if(void 0!==this.takeProfitModel&&void 0!==this.stopLossModel){const e=N([this.takeProfitModel.value$,this.stopLossModel.value$]).subscribe(([e,t])=>{this.rewardRisk.setValue((0,X.formatRiskReward)(e,t))});this._subscriptions.push(e)}null!==this.orderInfoModel&&this._subscriptions.push(...this.orderInfoModel.subscribe()),this._subscriptions.push(this._buttonDataSubscription,this._noQuotesSubscription,this._pipValues$.connect()),null!==this._marginAvailable$&&this._subscriptions.push(this._marginAvailable$.connect()),null!==this._baseCurrencyCryptoBalance$&&this._subscriptions.push(this._baseCurrencyCryptoBalance$.connect()),null!==this._quoteCurrencyCryptoBalance$&&this._subscriptions.push(this._quoteCurrencyCryptoBalance$.connect()),this.orderType.subscribe(this._syncOrderPricesAndFocuses),this._adapter.orderUpdate.subscribe(this,this._orderUpdate),this.stopPriceModel.price.subscribe(this._syncStopLimitPrices)}_backToDefaultOrderPanel(){this.mode.value()===Q.OrderEditorDisplayMode.Panel&&this._cancel()}_orderUpdate(e){(this._isTradingPanelOpened.value()||this.mode.value()===Q.OrderEditorDisplayMode.Popup)&&this.existingOrder&&e.id===this._orderTemplate.id&&6!==e.status&&this._back()}async _doneHandler(e,t){await this._getAndSendStatistics(e),null!==this._orderWidgetStat&&this._orderWidgetStat.clear();const i=this._handler;return this._isHandlerPlacedOrder(i)?i(Object.assign({},this._existingPlacedOrder,e),t):i(e,t)}_isHandlerPlacedOrder(e){return this.existingOrder}async _getAndSendStatistics(e){var t;const i=this.stopLossModel&&this.stopLossModel.getEnabled(),s=this.takeProfitModel&&this.takeProfitModel.getEnabled(),r=i&&this.supportTrailingStop,o=1===e.side?"Buy":"Sell",n=["Price","Pips"],a=["Units","RiskInCurrency","RiskInPercent","BaseCurrencyQuantity","QuoteCurrencyQuantity"],l=this.quantityModel.focusedControl.value(),u=["Pips","Price","RiskInCurrency","RiskInPercent"],h=["Limit","Market","Stop","StopLimit"][e.type-1],d=this.durationModel.getValue(),c=this.leverageModel?this.leverageModel.leverageInfo():null,p=4===e.type,_=3===e.type||p,b=1===e.type||p,y=Object.assign({},this._settings.value()),g=this.limitPriceModel&&!this.limitPriceModel.isRelativePriceControlHidden||this.stopPriceModel&&!this.stopPriceModel.isRelativePriceControlHidden,P=Boolean(this.supportBrackets);function m(e,t){return t[null!==e?e:0]}y.showRelativePriceControl=y.showRelativePriceControl&&g,y.showCurrencyRiskInQty=y.showCurrencyRiskInQty&&P,y.showPercentRiskInQty=y.showPercentRiskInQty&&P,y.showBracketsInCurrency=y.showBracketsInCurrency&&P,y.showBracketsInPercent=y.showBracketsInPercent&&P,y.showOrderPreview=y.showOrderPreview&&Boolean(this.supportPlaceOrderPreview||this.supportModifyOrderPreview),
null!==this._orderWidgetStat&&(this._orderWidgetStat.setStaticSnowplowEventDataProperty({accountType:this._adapter.currentAccountType(),brokerId:this._adapter.metainfo().id,orderTicketMode:this.mode.value(),side:o,orderType:h,leverageInfo:c,symbolType:void 0!==this._symbolInfo.type?this._symbolInfo.type:null,operation:this.existingOrder?"Modify":"Place",stopLoss:i?this._currentInputState.stopLossPips:null,takeProfit:s?this._currentInputState.takeProfitPips:null,trailingStop:r?this._currentInputState.stopLossPips:null,guaranteedStop:null,focusedTPField:s&&this.takeProfitModel?m(this.takeProfitModel.getFocusedControl(),u):null,focusedSLField:i&&void 0!==this.stopLossModel?m(this.stopLossModel.getFocusedControl(),u):null,focusedQtyField:null!==(t=a[null!==l?l:0])&&void 0!==t?t:null,focusedLimitPriceField:b||p&&this.limitPriceModel?m(this.limitPriceModel.focusedControl.value(),n):null,focusedStopPriceField:_&&this.stopPriceModel?n[this.stopPriceModel.focusedControl.value()]:null,duration:null!==d?d.type:null,isDefaultDuration:null!==d?d.type===this._getDefaultDuration().value:null,showBracketsInCurrency:y.showBracketsInCurrency,showBracketsInPercent:y.showBracketsInPercent,showCurrencyRiskInQty:y.showCurrencyRiskInQty,showOrderPreview:y.showOrderPreview,showPercentRiskInQty:y.showPercentRiskInQty,showRelativePriceControl:y.showRelativePriceControl}),await this._orderWidgetStat.trackStat())}_getDurationMetaInfoList(){var e;const t=this._symbolInfo.allowedDurations,i=null!==(e=this._adapter.metainfo().durations)&&void 0!==e?e:[];return 0===i.length||void 0===t?i:i.filter(({value:e})=>t.includes(e))}_getDurationInitialState(e,t){return void 0!==e.duration?{...e.duration}:void 0!==t&&null!==t.duration?{...t.duration}:(0,K.makeInitialOrderDuration)(this.orderType.value(),this._getDurationMetaInfoList())}_getInitialInputState(e,t,i){var s,r;return{symbol:this.symbol,side:e.side||1,limitPrice:e.limitPrice||e.price||e.stopPrice||0,stopPrice:e.stopPrice||e.price||e.limitPrice||0,quantity:e.qty||(null==i?void 0:i.quantity)||this._suggestedQty||t.qty.min,takeProfitPips:void 0!==i?i.takeProfitPips:Q.BracketDefaultPips.TakeProfit,stopLossPips:void 0!==i?i.stopLossPips:Q.BracketDefaultPips.StopLoss,customFields:null!==(r=null!==(s=e.customFields)&&void 0!==s?s:null==i?void 0:i.customFields)&&void 0!==r?r:{},duration:this._getDurationInitialState(e,i)}}_compareInputStates({side:e,limitPrice:t,stopPrice:i,quantity:s,takeProfit:r,stopLoss:o,duration:n}){0===this._initialInputState.limitPrice&&null!==t&&(this._initialInputState.limitPrice=t),0===this._initialInputState.stopPrice&&null!==i&&(this._initialInputState.stopPrice=i);const a=this.orderType.value(),l={};let u=null===t;if(null!==t){const e=this.formatter.format(t),i=null!==this._currentInputState.limitPrice?this.formatter.format(this._currentInputState.limitPrice):null;u=3!==a&&e!==i}u&&(l.limitPrice=t);let h=null!==i;if(null!==i){const e=this.formatter.format(i),t=null!==this._currentInputState.stopPrice?this.formatter.format(this._currentInputState.stopPrice):null
;h=(3===a||4===a)&&e!==t}h&&(l.stopPrice=i),null!==s&&this._currentInputState.quantity!==s&&(l.quantity=s),null!==r&&this._currentInputState.takeProfitPips!==r&&(l.takeProfitPips=r),null!==o&&this._currentInputState.stopLossPips!==o&&(l.stopLossPips=o),null===n||null===this._currentInputState.duration||this._currentInputState.duration.type===n.type&&this._currentInputState.duration.datetime===n.datetime||(l.duration=n),null!==e&&this._currentInputState.side!==e&&(l.side=e),this._currentInputState.symbol!==this.symbol&&(l.symbol=this.symbol),0!==Object.keys(l).length&&this._onInputStateChanged.fire(l)}_getSavableComboBoxModels(){return this.customFieldModels.value().filter(e=>e.saveToSettings&&"ComboBox"===e.type)}_getSavableCheckboxModels(){return this.customFieldModels.value().filter(e=>e.saveToSettings&&"Checkbox"===e.type)}_getSavableCustomFieldsModels(){return[...this._getSavableComboBoxModels(),...this._getSavableCheckboxModels()]}_getCustomFields(e){e||(e=this.customFieldModels.value());const t={};return e.forEach(e=>{"TextWithCheckBox"===e.type&&(t[e.id]={text:e.text.value().replace(/&quote;/g,'"'),checked:e.checked.value()}),"Checkbox"===e.type&&(t[e.id]=e.checked.value()),"ComboBox"===e.type&&(t[e.id]=e.selectedItem.value())}),t}_getCurrentInputState(){return{symbol:this.symbol,side:this.sideModel.getValue(),limitPrice:this.limitPriceModel.$value.getValue(),stopPrice:this.stopPriceModel.$value.getValue(),quantity:this.quantityModel.$value.getValue(),takeProfitPips:this.takeProfitModel?this.takeProfitModel.pips.getValue():null,stopLossPips:this.stopLossModel?this.stopLossModel.pips.getValue():null,duration:this.durationModel.getValue(),customFields:this._getCustomFields(this._getSavableCustomFieldsModels())}}_setDisabledIfNeeded({status:e,loading:t,quotes:i,side:s,limitPrice:r,stopPrice:o,quantity:n,isTakeProfitIncorrect:a,isStopLossIncorrect:l,customFields:u}){this.disabled.setValue(this.mode.value()===Q.OrderEditorDisplayMode.Panel&&e===Q.OrderPanelStatus.Wait||t||(0,X.isNoQuotes)(i)||null===s||(0,X.checkPriceByOrderType)(this.orderType.value(),r,o)||null===n||a||l||Object.values(u).some(e=>void 0===e))}_toggleMode(){this.mode.setValue(this.mode.value()===Q.OrderEditorDisplayMode.Panel?Q.OrderEditorDisplayMode.Popup:Q.OrderEditorDisplayMode.Panel),this._updateMode(),this._onModeChanged.fire(this.mode.value())}_closeWidget(){this._cleanUp(),this._onCloseButtonClicked.fire()}_cancel(){this._cleanUp(),this.deactivateOrderPanel(),this._currentInputState=Object.assign({},this._initialInputState),this.limitPriceModel&&this.limitPriceModel.forcePricesUpdate(this._initialInputState.limitPrice),this.stopPriceModel&&this.stopPriceModel.forcePricesUpdate(this._initialInputState.stopPrice),this.takeProfitModel&&this.takeProfitModel.setEnabled(!1),this.stopLossModel&&this.stopLossModel.setEnabled(!1),this._orderPlacingStatus.next(Q.OrderPlacingStatus.Creating),this.existingOrder&&this._back()}_cleanUp(){this.orderPreviewModel=null,this.onDoneButtonClicked.resolve(!1),
this.quantityModel&&void 0!==this._suggestedQty&&this.quantityModel.quantity.value.setValue(this._suggestedQty)}_getDefaultDuration(){const e=(0,o.ensureDefined)(this._adapter.metainfo().durations);return e.find(e=>Boolean(e.default))||e[0]}async _prepareTradableSolution(e){this.tradableSolution=await(0,X.prepareTradableSolution)(e,this._adapter),this._createSimpleDialog(this._adapter),this.notTradableText=e.reason}}function gt(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=(0,q.popResultSelector)(e);return(0,Ye.operate)((function(t,s){for(var r=e.length,o=new Array(r),n=e.map((function(){return!1})),a=!1,l=function(t){(0,C.innerFrom)(e[t]).subscribe(new D.OperatorSubscriber(s,(function(e){o[t]=e,a||n[t]||(n[t]=!0,(a=n.every(R.identity))&&(n=null))}),Xe.noop))},u=0;u<r;u++)l(u);t.subscribe(new D.OperatorSubscriber(s,(function(e){if(a){var t=(0,m.__spreadArray)([e],(0,m.__read)(o),!1);s.next(i?i.apply(void 0,(0,m.__spreadArray)([],(0,m.__read)(t),!1)):t)}})))}))}const Pt={title:(0,u.t)("Position info"),pipValue:(0,u.t)("Pip value"),tradeValue:(0,u.t)("Trade value"),total:(0,u.t)("Total"),leverage:(0,u.t)("Leverage"),lotSize:(0,u.t)("Lot size")};class mt{constructor({qty:e,currency:t,positionPrice:i,showTotalInsteadOfTradeValue:s,info:r,pipValueType:o,tpInfo:n,slInfo:a,showRiskControls:l}){this._infoTableData=new be.WatchedObject({rows:[]},X.comparator),this._riskFormatter=new J.PriceFormatter(100),this._tpEnabled$=null,this._tpRiskInCurrency$=null,this._tpRiskInPercent$=null,this._slEnabled$=null,this._slRiskInCurrency$=null,this._slRiskInPercent$=null,this._currency=t,this._showTotalInsteadOfTradeValue=s,this._showRiskControls=l,this._type=r.type,this._leverage=r.leverage,this._marginRate=r.marginRate,this._lotSize=r.lotSize,this._pipValue=(0,X.calculatePipValue)(e,r.pipValue,this._lotSize),this._pipValueType=o,null===e?this._tradeValue=0:"crypto"===this._type?this._tradeValue=e*i:this._tradeValue=(0,X.calculateTradeValue)(e,i,r.pipValue,r.pipSize,this._lotSize),n&&a&&(this._tpEnabled$=n.enabled,this._tpRiskInCurrency$=n.riskInCurrency,this._tpRiskInPercent$=n.riskInPercent,this._slEnabled$=a.enabled,this._slRiskInCurrency$=a.riskInCurrency,this._slRiskInPercent$=a.riskInPercent)}subscribe(){return this._subscription=N({tpEnabled:null!==this._tpEnabled$?this._tpEnabled$:W(null),tpRiskInCurrency:null!==this._tpRiskInCurrency$?this._tpRiskInCurrency$:W(null),tpRiskInPercent:null!==this._tpRiskInPercent$?this._tpRiskInPercent$:W(null),slEnabled:null!==this._slEnabled$?this._slEnabled$:W(null),slRiskInCurrency:null!==this._slRiskInCurrency$?this._slRiskInCurrency$:W(null),slRiskInPercent:null!==this._slRiskInPercent$?this._slRiskInPercent$:W(null)}).subscribe(e=>{const{tpEnabled:t,tpRiskInCurrency:i,tpRiskInPercent:s,slEnabled:r,slRiskInCurrency:o,slRiskInPercent:n}=e,a=[];a.push(...this._makeLeverageInfo(),...this._makeLotSizeInfo(),...this._makePipValueInfo(),...this._makeTradeValueInfo(),...this._makeRewardInfo(t,i,s),...this._makeRiskInfo(r,o,n)),this._infoTableData.setValue({rows:a})}),
this._subscription}unsubscribe(){var e;null===(e=this._subscription)||void 0===e||e.unsubscribe()}title(){return Pt.title}infoTableData(){return this._infoTableData}pipValue(){throw new Error("not supported")}tradeValue(){throw new Error("not supported")}_makeLeverageInfo(){const e=(0,X.displayedLeverage)(this._leverage,this._marginRate);return null===e?[]:[{title:(0,u.t)("Leverage"),value:e}]}_makeLotSizeInfo(){return"number"==typeof this._lotSize&&Number.isFinite(this._lotSize)?[{title:(0,u.t)("Lot size"),value:String(this._lotSize)}]:[]}_makePipValueInfo(){return this._showRiskControls&&this._pipValueType.value()!==A.PipValueType.None&&Number.isFinite(this._pipValue)?[{title:this._pipValueType.value()===A.PipValueType.Pips?(0,u.t)("Pip value"):(0,u.t)("Tick value"),value:`${this._currency} ${(0,X.formatInfoValue)(this._pipValue)}`}]:[]}_makeTradeValueInfo(){const e=this._getTradeValue();if(void 0===e)return[];return[{title:this._showTotalInsteadOfTradeValue?(0,u.t)("Total"):(0,u.t)("Trade value"),value:`${this._currency} ${e}`}]}_getTradeValue(){const e=this._getMarginRate();if(this._showRiskControls&&Number.isFinite(this._tradeValue)&&(this._isSymbolTypeSupportTradeValue()||void 0!==e))return(0,X.formatInfoValue)(this._tradeValue*(null!=e?e:1))}_getMarginRate(){return void 0!==this._marginRate&&this._marginRate>0?this._marginRate:void 0}_isSymbolTypeSupportTradeValue(){return void 0!==this._type&&["stock","dr","right","bond","warrant","structured"].includes(this._type)}_makeRewardInfo(e,t,i){return this._showRiskControls&&e&&null!==t&&null!==i?[{title:(0,u.t)("Reward"),value:this._riskFormatter.format(i)+"% ("+this._currency+" "+this._riskFormatter.format(t)+")"}]:[]}_makeRiskInfo(e,t,i){return this._showRiskControls&&e&&null!==t&&null!==i?[{title:(0,u.t)("Risk"),value:this._riskFormatter.format(i)+"% ("+this._currency+" "+this._riskFormatter.format(t)+")"}]:[]}}var vt;!function(e){e[e.Position=0]="Position",e[e.Trade=1]="Trade"}(vt||(vt={}));class ft{constructor({adapter:e,position:t,brackets:i,mode:s,settings:r,realtimeProvider:o,isTradingPanelVisible:n,isTradingPanelOpened:a,viewType:u,pipValueType:d,handler:c,trackEvent:b}){this.positionInfoModel=null,this.customFieldModels=new(l())([]),this.onDoneButtonClicked=(0,h.createDeferredPromise)(),this.rewardRisk=new(l())(""),this.disabled=new(l())(!1),this.loading=new(l())(!1),this.status=new(l())(Q.OrderPanelStatus.Active),this.id=(0,z.randomHashN)(6),this.warning=new(l())(void 0),this.isEmptyRequiredCustomFieldsHighlighted=new(l())(!1),this._onModeChanged=new(H()),this._onBackButtonClicked=new(H()),this._onCloseButtonClicked=new(H()),this._loadingSubscription=(0,X.makeSubjectFromWatchedValue)(this.loading),this._loading=this._loadingSubscription.subject,this.mode=s,this._position=t,this._settings=r,this._adapter=e,this._pipValueType=d,this.position=t,this.symbol=t.symbol,this.brackets=i,this._handler=c,this._isTradingPanelVisible=n,this._isTradingPanelOpened=a;const y=this._adapter.metainfo().configFlags
;this.supportBrackets=u===vt.Trade?y.supportTradeBrackets:y.supportPositionBrackets,this.supportTrailingStop=this.supportBrackets&&y.supportTrailingStop,this.supportModifyTrailingStop=this.supportTrailingStop&&y.supportModifyTrailingStop,this.supportPositions=u===vt.Position&&y.supportPositions,this.supportTrades=u===vt.Trade&&y.supportTrades,this.supportOnlyPairPositionBrackets=y.supportOnlyPairPositionBrackets,this.supportCryptoExchangeOrderTicket=y.supportCryptoExchangeOrderTicket,this._adapter.orders().then(e=>{const i=e.filter(e=>2===e.parentType&&e.parentId===t.id),s=i.length?i[0].customFields:void 0,r=this._adapter.getPositionDialogOptions();this.customFieldModels.setValue((0,X.createCustomFieldModels)(Boolean(i.length),this.status,new(l())(!1),r,s)),this.supportOnlyPairPositionBrackets&&this._updateWarning()}),this._trackEvent=b,this.onReady=Promise.all([e.symbolInfo(t.symbol),e.getOrderDialogOptions(t.symbol),dt(e.accountMetainfo(),{id:e.metainfo().id,name:e.metainfo().title}),dt(e.formatter(t.symbol,!1),new J.PriceFormatter)]).then(([s,r,n,a])=>{this.showRiskControls=y.supportRiskControls&&0!==s.pipValue,this.currency=(0,G.getCurrency)(n),this.symbolType=s.type,this.brokerSymbol=s.brokerSymbol||t.brokerSymbol||this.symbol,this._quotes$=V(k(e=>o.subscribeRealtime(t.symbol,e),e=>o.unsubscribeRealtime(t.symbol,e),(e,t)=>t)),this._equity$=V(k(t=>e.subscribeEquity(t),t=>e.unsubscribeEquity(t),(e,t)=>t)),this._pipValues$=V(k(i=>e.subscribePipValue(t.symbol,i),i=>e.unsubscribePipValue(t.symbol,i),(e,t)=>t).pipe((0,p.startWith)({buyPipValue:s.pipValue,sellPipValue:s.pipValue}))),this._pipValue$=this._pipValues$.pipe((0,_.map)(e=>1===t.side?e.buyPipValue:e.sellPipValue)),this._createModels(i,s,n,this.mode,a,r),this._subscribe()})}destroy(){this._subscriptions&&this._subscriptions.forEach(e=>e.unsubscribe()),this.headerModel&&(this.headerModel.unsubscribe(),this.headerModel.pinButtonClicked().unsubscribe(this,this._toggleMode),this.headerModel.backButtonClicked().unsubscribe(this,this._back),this.headerModel.closeButtonClicked().unsubscribe(this,this._closeWidget)),this.buttonModel&&this.buttonModel.unsubscribe(),null!==this.positionInfoModel&&this.positionInfoModel.unsubscribe(),this.supportPositions&&this._adapter.positionUpdate.unsubscribe(this,this._positionOrTradeUpdate),this.supportTrades&&this._adapter.tradeUpdate.unsubscribe(this,this._positionOrTradeUpdate),this.supportOnlyPairPositionBrackets&&this._adapter.orderUpdate.unsubscribe(this,this._updateWarning)}side(){return this._position.side}doneButtonClick(){this.loading.setValue(!0),this._doneHandler().then(e=>{e&&(this.onDoneButtonClicked.resolve(!0),this.mode.value()===Q.OrderEditorDisplayMode.Popup?this.headerModel.close():this._back(),this._trackEvent("Position Ticket","Modify Position",this.mode.value()===Q.OrderEditorDisplayMode.Panel?"Panel":"Popup")),this.loading.setValue(!1)})}onModeChanged(){return this._onModeChanged}onBackButtonClicked(){return this._onBackButtonClicked}onCloseButtonClicked(){return this._onCloseButtonClicked}
_createModels(e,t,i,s,r,o){const n=ae(this._adapter,this.symbol),a=le(this._adapter,this.symbol),l=(0,G.getCurrency)(i)||"$",u=new y.BehaviorSubject(this._position.side||-1);this.headerModel=new de(this.brokerSymbol,this.symbol," ",s,this.status,2,!0,!0,this._quotes$,this._isTradingPanelVisible,this._position,this._position.priceFormatter?this._position.priceFormatter:r),this.takeProfitModel=new Je({initialPrice:e.takeProfit||this._position.takeProfit||null,initialEnabled:Boolean(e.takeProfit||this._position.takeProfit),initialBracketType:A.BracketType.TakeProfit,formatter:r,equity$:this._equity$,quotes$:this._quotes$,info:t,pipValue$:this._pipValue$,side$:u,amount$:new y.BehaviorSubject(this._position.qty),parentPrice$:new y.BehaviorSubject(this._position.avgPrice),orderType$:new y.BehaviorSubject(null),currency:l,parentType:2,savedPips:null,settings:this._settings,orderWidgetStat:null,showRiskControls:this.showRiskControls,status:this.status.value(),validationRules:n,supportModifyBrackets:this.supportBrackets,supportModifyTrailingStop:this.supportModifyTrailingStop});const h=e.trailingStopPips||this._position.trailingStopPips,d=e.stopLoss||this._position.stopLoss,c=Boolean(h);this.stopLossModel=new Je({initialPrice:c?null:d||null,initialEnabled:Boolean(c?h:d),initialBracketType:c?A.BracketType.TrailingStop:A.BracketType.StopLoss,formatter:r,equity$:this._equity$,quotes$:this._quotes$,info:t,pipValue$:this._pipValue$,side$:u,amount$:new y.BehaviorSubject(this._position.qty),parentPrice$:new y.BehaviorSubject(this._position.avgPrice),orderType$:new y.BehaviorSubject(null),currency:l,parentType:2,savedPips:h||null,settings:this._settings,orderWidgetStat:null,showRiskControls:this.showRiskControls,status:this.status.value(),validationRules:a,supportModifyBrackets:this.supportBrackets,supportModifyTrailingStop:this.supportModifyTrailingStop});const p=(0,X.shouldShowTotal)(o);this.supportCryptoExchangeOrderTicket||(this.positionInfoModel=new mt({qty:this._position.qty,currency:(0,G.getCurrency)(i),positionPrice:this._position.avgPrice,showTotalInsteadOfTradeValue:p,info:t,pipValueType:this._pipValueType,tpInfo:this.supportBrackets&&this.takeProfitModel?{enabled:this.takeProfitModel.enabled$,riskInCurrency:this.takeProfitModel.riskInCurrency.value$,riskInPercent:this.takeProfitModel.riskInPercent.value$}:null,slInfo:this.supportBrackets&&this.stopLossModel?{enabled:this.stopLossModel.enabled$,riskInCurrency:this.stopLossModel.riskInCurrency.value$,riskInPercent:this.stopLossModel.riskInPercent.value$}:null,showRiskControls:this.showRiskControls})),this.buttonModel=new lt(2,this.status,!0)}_updateWarning(){this._adapter.orders().then(e=>{const t=e.find(e=>e.symbol===this._position.symbol&&e.side!==this._position.side&&(6===e.status&&void 0===e.parentId||3===e.status));this.warning.setValue(t?(0,u.t)("You already have at least one working order that can affect this position"):void 0)})}_subscribe(){if(this.headerModel.pinButtonClicked().subscribe(this,this._toggleMode),
this.headerModel.backButtonClicked().subscribe(this,this._back),this.headerModel.closeButtonClicked().subscribe(this,this._closeWidget),this._buttonDataSubscription=N({loading:this._loading,quotes:this._quotes$,takeProfit:this.takeProfitModel.value$,stopLoss:this.stopLossModel.value$,takeProfitEnabled:this.takeProfitModel.enabled$,stopLossEnabled:this.stopLossModel.enabled$}).subscribe(e=>{const{loading:t,quotes:i,takeProfit:s,stopLoss:r,takeProfitEnabled:o,stopLossEnabled:n}=e;this.disabled.setValue(t||(0,X.isNoQuotes)(i)||o&&null===s||n&&null===r)}),this._rewardRiskSubscription=N([this.takeProfitModel.value$,this.stopLossModel.value$]).subscribe(([e,t])=>{this.rewardRisk.setValue((0,X.formatRiskReward)(e,t))}),this._subscriptions=[...this.takeProfitModel.subscribe(),...this.stopLossModel.subscribe(),this._rewardRiskSubscription,this._buttonDataSubscription,this._equity$.connect(),this._quotes$.connect(),this._pipValues$.connect()],null!==this.positionInfoModel&&this._subscriptions.push(this.positionInfoModel.subscribe()),this.supportPositions&&this._adapter.positionUpdate.subscribe(this,this._positionOrTradeUpdate),this.supportTrades&&this._adapter.tradeUpdate.subscribe(this,this._positionOrTradeUpdate),this.supportOnlyPairPositionBrackets){this._adapter.orderUpdate.subscribe(this,this._updateWarning);const e=this.stopLossModel.enabled$.pipe(gt(this.takeProfitModel.enabled$)).subscribe(e=>{const[t,i]=e;i!==t&&this.takeProfitModel.setEnabled(t)}),t=this.takeProfitModel.enabled$.pipe(gt(this.stopLossModel.enabled$)).subscribe(e=>{const[t,i]=e;i!==t&&this.stopLossModel.setEnabled(t)});this._subscriptions.push(t,e)}}_doneHandler(){const e=null!==this.stopLossModel.getValue()?this.stopLossModel.price.getValue():null,t=this.stopLossModel.getValue(),i=null!==this.takeProfitModel.getValue()?this.takeProfitModel.price.getValue():null,s={};if(null!==t&&null!==e&&(this.stopLossModel.getBracketType()===A.BracketType.StopLoss&&(s.stopLoss=e),this.stopLossModel.getBracketType()===A.BracketType.TrailingStop&&(s.trailingStopPips=t)),null!==i&&(s.takeProfit=i),Array.isArray(this.customFieldModels.value())){const e={};return this.customFieldModels.value().forEach(t=>{"TextWithCheckBox"===t.type&&(e[t.id]={text:t.text.value().replace(/&quote;/g,'"'),checked:t.checked.value()}),"Checkbox"===t.type&&(e[t.id]={checked:t.checked.value()}),"ComboBox"===t.type&&(e[t.id]=t.selectedItem.value())}),this._getAndSendStatistics(),this._handler(this.position.id,s,e)}return this._getAndSendStatistics(),this._handler(this.position.id,s)}_getAndSendStatistics(){const e=this.stopLossModel.getEnabled(),t=this.stopLossModel.getFocusedControl(),i=this.takeProfitModel.getEnabled(),s=this.takeProfitModel.getFocusedControl(),r=this.stopLossModel&&this.stopLossModel.getBracketType(),o=["Pips","Price","RiskInCurrency","RiskInPercent"],n=[" Disabled"," Active"],a=["StopLoss","TakeProfit","TrailingStop"],l={SL:{active:n[+e],mode:o[t]},TP:{active:n[+i],mode:o[s]}};this.supportTrailingStop&&(l.SLType={active:n[+e],mode:a[r]});const u=this._settings.value()
;Object.keys(u).filter(e=>["showBracketsInCurrency","showBracketsInPercent"].includes(e)).forEach(e=>{this._trackEvent("Order Ticket",e,u[e]?"on":"off")}),Object.keys(l).forEach(e=>{l[e].active&&this._trackEvent("Position Ticket",e,l[e].mode)})}_positionOrTradeUpdate(e){!this._isTradingPanelOpened.value()&&this.mode.value()!==Q.OrderEditorDisplayMode.Popup||e.id!==this.position.id||0!==e.qty&&this.position.side===e.side||this._back()}_toggleMode(){this.mode.setValue(this.mode.value()===Q.OrderEditorDisplayMode.Panel?Q.OrderEditorDisplayMode.Popup:Q.OrderEditorDisplayMode.Panel),this._onModeChanged.fire(this.mode.value())}_closeWidget(){this.onDoneButtonClicked.resolve(!1),this._onCloseButtonClicked.fire()}_back(){this.onDoneButtonClicked.resolve(!1),this._onBackButtonClicked.fire()}}var kt=i(35849);class St{constructor(e){this._brokerId="",this._settingsAdapter=e}setBrokerId(e){this._brokerId=e}saveSettings(e){this._settingsAdapter.setValue(this._makeKey(kt.settingsKeys.ORDER_PANEL_SETTINGS,this._brokerId),JSON.stringify(e))}getSettings(){const e=this._settingsAdapter.getValue(this._makeKey(kt.settingsKeys.ORDER_PANEL_SETTINGS,this._brokerId));try{return JSON.parse(e)}catch(e){return null}}setWidgetMode(e){this._settingsAdapter.setValue(kt.settingsKeys.ORDER_WIDGET_MODE,e)}widgetMode(){const e=this._settingsAdapter.getValue(kt.settingsKeys.ORDER_WIDGET_MODE);return e||null}_makeKey(e,t,i){return e+t+("string"==typeof i?"."+i:"")}}var Mt=i(44521),Ct=i(51453),wt=i(37016),Vt=i(71701),Tt=i(91109);function Ot(){return Promise.all([i.e(7610),i.e(9448),i.e(8193),i.e(3894),i.e(3996),i.e(7936),i.e(706),i.e(4078),i.e(83),i.e(9843),i.e(2273),i.e(9305),i.e(6473),i.e(2),i.e(2778),i.e(6637),i.e(4267),i.e(1778),i.e(2321),i.e(3972),i.e(4084),i.e(7422),i.e(4479),i.e(3455),i.e(7775),i.e(6480),i.e(4849),i.e(5514),i.e(9253),i.e(268),i.e(8961),i.e(3668),i.e(7467),i.e(1891),i.e(1436),i.e(7019),i.e(5075),i.e(6684),i.e(6256),i.e(5566),i.e(7502)]).then(i.bind(i,18744))}function It(){return Promise.all([i.e(7610),i.e(9448),i.e(8193),i.e(3894),i.e(3996),i.e(7936),i.e(706),i.e(83),i.e(9843),i.e(2273),i.e(9305),i.e(6473),i.e(2),i.e(2778),i.e(6637),i.e(3972),i.e(7422),i.e(4479),i.e(1990),i.e(3455),i.e(1018),i.e(6697),i.e(5514),i.e(9253),i.e(268),i.e(8961),i.e(3668),i.e(7467),i.e(1891),i.e(1436),i.e(6684),i.e(6256),i.e(8751)]).then(i.bind(i,95937))}class Bt{constructor(e,t,i){if(this._state=null,this._orderViewModel=null,this._positionViewModel=null,this._statusChangeIndex=0,this._saveSettingsBinded=this._saveSettings.bind(this),this._orderWidgetStat=null,this._settings=new(l())(wt.defaultSettings),this._mode=new(l())(Q.OrderEditorDisplayMode.Panel),this._visibility=new Tt.DialogVisibility,this._updateContent=e=>{e!==Mt.TradingPage.OrderPanel&&(this._positionViewModel&&(this._unmountPositionPanel(),this._unsubscribePositionViewModel()),null!==this._orderViewModel&&this._orderViewModel.existingOrder&&this._orderViewModel.onDoneButtonClicked.reject(),this._unmountOrderPanel())},this._onOrderWidgetModeChanged=e=>{
null!==this._state&&null!==this._state.broker&&null!==this._orderViewModel&&(this._state.symbol!==this._orderViewModel.symbol?this.showOrderView(this._state.broker,this._orderStub):this._showOrderView()),e===Q.OrderEditorDisplayMode.Panel?this._closePositionDialog():this._closeTradingPanel()},this._onOrderWidgetInputStateChanged=e=>{var t,i,s,r,o;if(null!==this._state){if((0,G.isDefined)(e.quantity)&&(null===(t=this._getTradingSettingsStorage())||void 0===t||t.setSymbolQty(this._state.symbol,e.quantity)),(0,G.isDefined)(e.takeProfitPips)&&(null===(i=this._getTradingSettingsStorage())||void 0===i||i.setTakeProfitPips(this._state.symbol,e.takeProfitPips,Q.BracketDefaultPips.TakeProfit)),(0,G.isDefined)(e.stopLossPips)&&(null===(s=this._getTradingSettingsStorage())||void 0===s||s.setStopLossPips(this._state.symbol,e.stopLossPips,Q.BracketDefaultPips.StopLoss)),(0,G.isDefined)(e.duration)){const t=this._state.broker&&this._state.broker.metainfo().durations,i=t&&(t.find(e=>e.default)||t[0]),s=i&&i.name===e.duration.type?null:e.duration.type;null===(r=this._getTradingSettingsStorage())||void 0===r||r.setDuration(this._state.symbol,s)}(0,G.isDefined)(e.customFields)&&(null===(o=this._getTradingSettingsStorage())||void 0===o||o.setCustomFields(this._state.symbol,e.customFields))}},this._onOrderWidgetCloseButtonClicked=()=>{this._mode.value()===Q.OrderEditorDisplayMode.Panel&&this._closeTradingPanel()},this._onOrderWidgetBackButtonClicked=()=>{null!==this._state&&null!==this._state.broker&&(this._orderViewModel&&this._orderViewModel.status.value()===Q.OrderPanelStatus.Preview?(this._showOrderView(),this._activateOrderPanel()):(this._orderStub=this._createOrderStub(),this.showOrderView(this._state.broker,this._orderStub,void 0,void 0,()=>{this._mode.value()===Q.OrderEditorDisplayMode.Popup?(this._closeOrderDialog(),this._closePositionDialog()):this._deactivateOrderPanel()})))},this._onPositionWidgetModeChanged=e=>{null!==this._positionViewModel&&this._showPositionOrTradeView(),e===Q.OrderEditorDisplayMode.Panel?this._closeOrderDialog():this._closeTradingPanel()},this._onPositionWidgetBackButtonClicked=()=>{null!==this._state&&null!==this._state.broker&&(this._mode.value()===Q.OrderEditorDisplayMode.Panel?(this._unmountPositionPanel(),this._showOrderView(void 0,()=>this._resetOrderPanel())):this._closePositionDialog())},this._onPositionWidgetCloseButtonClicked=()=>{this._mode.value()===Q.OrderEditorDisplayMode.Panel?(this._unsubscribePositionViewModel(),this._recreateOrderViewModel().then(()=>{this._closePositionPanel(),this._resetOrderPanel()}),this._closeTradingPanel()):this._closePositionDialog()},this._tradingCommands=e,this._trackEvent=e.trackEvent,this._realtimeProvider=e.realtimeProvider,this._resizerBridge=e.resizerBridge,this._orderViewDataStorage=new St(s),this._tradingPanelContainer=t.container,this._isTradingPanelVisible=t.isVisible,this._isTradingPanelOpened=t.isOpened,this._qtySuggester=i,this._tradingPanelActivePage=t.activePage,this._closeTradingPanel=t.close,this._openTradingPanelPage=t.openPage,
this._getTradingSettingsStorage=e.getTradingSettingsStorage,this.visibility=this._visibility.value$,window.matchMedia(Vt.TradingLayoutBreakpoint.Mobile).matches)this._mode.setValue(Q.OrderEditorDisplayMode.Popup);else if(n.enabled("order_panel")){const e=this._orderViewDataStorage.widgetMode();this._mode.setValue(null!==e?e:Q.OrderEditorDisplayMode.Panel)}else this._mode.setValue(Q.OrderEditorDisplayMode.Popup);t.isVisible.subscribe(e=>{"visible"!==document.visibilityState||e||this._mode.value()!==Q.OrderEditorDisplayMode.Panel||(t.close(),this._mode.setValue(Q.OrderEditorDisplayMode.Popup))}),this._realtimeProvider.onStatusChanged.subscribe(null,()=>this._onStatusChanged()),r.linking.proSymbol.subscribe(()=>{this._mode.value()===Q.OrderEditorDisplayMode.Popup&&this._closeOrderDialog(),this._onStatusChanged()}),window.loginStateChange&&window.loginStateChange.subscribe(this,this._onStatusChanged),this._settings.subscribe(this._saveSettingsBinded),this._onStatusChanged(),this._orderViewDataStorage.setWidgetMode(this._mode.value()),t.activePage.subscribe(this._updateContent),this.stateChanging=this._createStateChanging()}openPanel(){return this._closeOrderDialog(),this._closePositionDialog(),this._mode.setValue(Q.OrderEditorDisplayMode.Panel),null!==this._positionViewModel?(this._positionViewModel.onDoneButtonClicked.reject(),this._recreateOrderViewModel().then(()=>{this._openOrderPanel(),this._resetOrderPanel(),this._unsubscribePositionViewModel()})):null!==this._orderViewModel&&this._orderViewModel.existingOrder?(this._orderViewModel.onDoneButtonClicked.reject(),this._unsubscribeOrderViewModel(),this._recreateOrderViewModel().then(()=>{this._openOrderPanel(),this._resetOrderPanel()})):(this._openOrderPanel(),this._resetOrderPanel(),Promise.resolve())}closePanel(){null!==this._positionViewModel?(this._positionViewModel.onDoneButtonClicked.reject(),this._closePositionPanel(),this._unsubscribePositionViewModel()):(null!==this._orderViewModel&&this._orderViewModel.existingOrder&&(this._orderViewModel.onDoneButtonClicked.reject(),this._unsubscribeOrderViewModel(),this._recreateOrderViewModel()),this._closeOrderPanel())}async showOrderView(e,t,i,s,r){const n=await e.isTradable(t.symbol);if(!n.tradable&&this._mode.value()===Q.OrderEditorDisplayMode.Popup)return(0,Ct.showNonTradableSymbolDialog)({isTradableResult:n,activeBroker:e}),!1;null!==this._orderViewModel&&(this._orderViewModel.existingOrder&&this._orderViewModel.onDoneButtonClicked.reject(),this._unsubscribeOrderViewModel());const a=t.hasOwnProperty("id")?e.modifyOrder:e.placeOrder;let l;this._orderStub=Object.assign(this._createOrderStub(),t),s&&this._mode.setValue(Q.OrderEditorDisplayMode.Popup),n.tradable&&(l=await this._getInputStateFromStorage()),l&&Object.assign(l,{stopLossPips:t.stopLoss||l.stopLossPips,takeProfitPips:t.takeProfit||l.takeProfitPips});const u=new yt({...this._commonOrderViewModelProps(),adapter:e,isTradable:n,isTradingPanelVisible:this._isTradingPanelVisible.value(),handler:a.bind(e),savedInputState:l,forceAbsolutePriceUpdate:!0})
;return this._orderViewModel=u,(0,o.ensureNotNull)(this._orderViewModel).onReady.then(()=>this._orderViewModel!==u?Promise.resolve(!1):(null!==this._positionViewModel&&this._unsubscribePositionViewModel(),this._subscribeOrderViewModel(),this._showOrderView(i,r,s)))}showPositionView(e,t,i,s){return this._createAndShowPositionOrTradeView({adapter:e,position:t,viewType:vt.Position,brackets:i,handler:e.editPositionBrackets.bind(e),focus:s})}showTradeView(e,t,i,s){return this._createAndShowPositionOrTradeView({adapter:e,position:t,viewType:vt.Trade,brackets:i,handler:e.editTradeBrackets.bind(e),focus:s})}mode(){return this._mode}status(){return(0,o.ensureNotNull)(this._orderViewModel).status.value()}orderViewDataStorage(){return this._orderViewDataStorage}_createAndShowPositionOrTradeView({adapter:e,position:t,viewType:i,brackets:s,handler:r,focus:n}){null!==this._positionViewModel&&(this._unmountPositionPanel(),this._unsubscribePositionViewModel()),null!==this._orderViewModel&&this._orderViewModel.existingOrder&&(this._orderViewModel.onDoneButtonClicked.reject(),this._recreateOrderViewModel());const a=new ft({adapter:e,position:t,brackets:s,mode:this._mode,settings:this._settings,realtimeProvider:this._tradingCommands.realtimeProvider,isTradingPanelVisible:this._isTradingPanelVisible.value(),isTradingPanelOpened:this._isTradingPanelOpened,viewType:i,pipValueType:this._tradingCommands.pipValueType,handler:r.bind(e),trackEvent:this._tradingCommands.trackEvent});return this._positionViewModel=a,(0,o.ensureNotNull)(this._positionViewModel).onReady.then(()=>this._positionViewModel!==a?Promise.resolve(!1):(this._subscribePositionViewModel(),this._showPositionOrTradeView(n)))}_showPositionOrTradeView(e){return null===this._positionViewModel?Promise.resolve(!1):(0,o.ensureNotNull)(this._positionViewModel).onReady.then(()=>(this._mode.value()===Q.OrderEditorDisplayMode.Panel?this._openPositionPanel(e):this._showPositionDialog(e),this._orderViewDataStorage.setWidgetMode(this._mode.value()),(0,o.ensureNotNull)(this._positionViewModel).onDoneButtonClicked.promise.then(e=>e)))}_showOrderView(e,t,i){return null===this._orderViewModel?Promise.resolve(!1):(0,o.ensureNotNull)(this._orderViewModel).onReady.then(()=>(this._mode.value()===Q.OrderEditorDisplayMode.Panel?this._openOrderPanel(e):this._showOrderDialog(e),this._orderViewDataStorage.setWidgetMode(this._mode.value()),"function"==typeof t&&t(),(0,o.ensureNotNull)(this._orderViewModel).onDoneButtonClicked.promise.then(e=>e)))}_defaultBrokerOrderType(){const e=this._realtimeProvider.activeBroker(),t=null!==e?e.metainfo().configFlags:null;return null===t?null:(t.supportLimitOrders?1:t.supportMarketOrders&&2)||t.supportStopLimitOrders&&4||t.supportStopOrders&&3||null}async _onStatusChanged(){var e;const t=++this._statusChangeIndex,i=r.linking.proSymbol.value()||r.linking.symbol.value(),s=this._realtimeProvider.activeBroker(),n=this._state,a=this._defaultBrokerOrderType(),l=s?s.metainfo().id:"";if(this._orderViewDataStorage.setBrokerId(l),this._state={broker:s,symbol:i,
side:(null===(e=this._orderViewModel)||void 0===e?void 0:e.side())||1,orderType:null!==this._orderViewModel&&this._orderViewModel.orderType?this._orderViewModel.orderType.value():a,accountId:null!==s?s.currentAccount():null},this._orderStub=this._createOrderStub(),null!==this._orderViewModel&&(this._orderViewModel.existingOrder&&this._orderViewModel.onDoneButtonClicked.reject(),this._unsubscribeOrderViewModel()),null!==this._positionViewModel&&(this._positionViewModel.onDoneButtonClicked.reject(),this._unsubscribePositionViewModel()),!n||n.broker===this._state.broker&&n.accountId===this._state.accountId||(await Promise.all([this._closeOrderDialog(),this._closePositionDialog(),this._unmountPositionPanel()]),t===this._statusChangeIndex))if(null===s){const e=new yt({...this._commonOrderViewModelProps(),adapter:s,isTradable:{tradable:!1},isTradingPanelVisible:this._isTradingPanelVisible.value(),handler:()=>Promise.resolve(!0)});if(this._orderViewModel=e,await(0,o.ensureNotNull)(this._orderViewModel).onReady,t!==this._statusChangeIndex||this._orderViewModel!==e)return;this._subscribeOrderViewModel(),this._deactivateOrderPanel(),this._isTradingPanelOpened.value()&&this._mode.value()===Q.OrderEditorDisplayMode.Panel&&null===this._positionViewModel&&this._tradingPanelActivePage.value()===Mt.TradingPage.OrderPanel&&this._showOrderView()}else{this._initializeSettings();const e=await s.isTradable(i);let r;if(e.tradable&&(r=await this._getInputStateFromStorage()),t!==this._statusChangeIndex)return;const n=new yt({...this._commonOrderViewModelProps(),adapter:s,isTradable:e,isTradingPanelVisible:this._isTradingPanelVisible.value(),handler:s.placeOrder.bind(s),savedInputState:r});if(this._orderViewModel=n,await(0,o.ensureNotNull)(this._orderViewModel).onReady,this._orderViewModel!==n)return;this._resetOrderPanel(),this._deactivateOrderPanel(),this._subscribeOrderViewModel(),this._isTradingPanelOpened.value()&&this._mode.value()===Q.OrderEditorDisplayMode.Panel&&null===this._positionViewModel&&this._tradingPanelActivePage.value()===Mt.TradingPage.OrderPanel&&this._showOrderView()}}_initializeSettings(){this._settings.unsubscribe(this._saveSettingsBinded);const e=!0===(0,o.ensureNotNull)(this._realtimeProvider.activeBroker()).metainfo().configFlags.supportCryptoBrackets;let t=this._orderViewDataStorage.getSettings()||wt.defaultSettings;e&&(t=Object.assign({},wt.defaultCryptoBracketsSettings,t)),this._settings.setValue(t),this._settings.subscribe(this._saveSettingsBinded)}_saveSettings(e){this._orderViewDataStorage.saveSettings(e)}_createOrderStub(){const e=(0,o.ensureNotNull)(this._state),t=this._defaultBrokerOrderType(),i=null!==t?t:1;return{limitPrice:0,stopPrice:0,qty:0,side:e.side,symbol:e.symbol,type:null!==e.orderType?e.orderType:i,takeProfit:void 0,stopLoss:void 0}}_activateOrderPanel(){null!==this._orderViewModel&&this._orderViewModel.activateOrderPanel()}_deactivateOrderPanel(){null!==this._orderViewModel&&this._orderViewModel.deactivateOrderPanel()}_resetOrderPanel(){
null!==this._orderViewModel&&this._orderViewModel.resetOrderPanel()}async _recreateOrderViewModel(){if(null!==this._state&&null!==this._state.broker){const e=this._state.broker.metainfo().id;this._orderViewDataStorage.setBrokerId(e),this._orderStub=this._createOrderStub();const t=await this._state.broker.isTradable(this._state.symbol);let i;t.tradable&&(i=await this._getInputStateFromStorage());const s=new yt({...this._commonOrderViewModelProps(),adapter:this._state.broker,isTradable:t,isTradingPanelVisible:this._isTradingPanelVisible.value(),handler:this._state.broker.placeOrder.bind(this._state.broker),savedInputState:i});return this._orderViewModel=s,this._subscribeOrderViewModel(),s.onReady}}async _openOrderPanel(e){return await this._mountOrderPanel(e),this._openTradingPanelPage(Mt.TradingPage.OrderPanel)}async _mountOrderPanel(e){const{mountOrderPanel:t}=await Ot();null!==this._orderViewModel&&t(this._orderViewModel,this._settings,this._tradingPanelContainer,(0,o.ensureNotNull)(this._resizerBridge).width,e,this._trackEvent)}async _closeOrderPanel(){return await this._unmountOrderPanel(),this._closeTradingPanel()}async _unmountOrderPanel(){const{unmountOrderPanel:e}=await Ot();e((0,o.ensureNotNull)(this._tradingPanelContainer))}async _showOrderDialog(e){const{showOrderDialog:t}=await Ot();null!==this._orderViewModel&&t({viewModel:this._orderViewModel,settings:this._settings,focus:e,trackEvent:this._trackEvent,onOpen:e=>{this._visibility.setValue({isVisible:!0,isFullScreen:e})},onClose:()=>{this._visibility.setValue({isVisible:!1})}})}async _closeOrderDialog(){const{closeOrderDialog:e}=await Ot();e(()=>this._visibility.setValue({isVisible:!1}))}_subscribeOrderViewModel(){(0,o.ensureNotNull)(this._orderViewModel).onModeChanged().subscribe(this,this._onOrderWidgetModeChanged),(0,o.ensureNotNull)(this._orderViewModel).onInputStateChanged().subscribe(this,this._onOrderWidgetInputStateChanged),(0,o.ensureNotNull)(this._orderViewModel).onCloseButtonClicked().subscribe(this,this._onOrderWidgetCloseButtonClicked),(0,o.ensureNotNull)(this._orderViewModel).onBackButtonClicked().subscribe(this,this._onOrderWidgetBackButtonClicked)}_unsubscribeOrderViewModel(){(0,o.ensureNotNull)(this._orderViewModel).onModeChanged().unsubscribe(this,this._onOrderWidgetModeChanged),(0,o.ensureNotNull)(this._orderViewModel).onInputStateChanged().unsubscribe(this,this._onOrderWidgetInputStateChanged),(0,o.ensureNotNull)(this._orderViewModel).onCloseButtonClicked().unsubscribe(this,this._onOrderWidgetCloseButtonClicked),(0,o.ensureNotNull)(this._orderViewModel).onBackButtonClicked().unsubscribe(this,this._onOrderWidgetBackButtonClicked),(0,o.ensureNotNull)(this._orderViewModel).destroy(),this._orderViewModel=null}_openPositionPanel(e){return this._mountPositionPanel(e).then(()=>this._openTradingPanelPage(Mt.TradingPage.OrderPanel))}async _mountPositionPanel(e){const{mountPositionPanel:t}=await It();if(null!==this._positionViewModel)return t(this._positionViewModel,this._settings,this._tradingPanelContainer,e)}async _closePositionPanel(){
return await this._unmountPositionPanel(),this._closeTradingPanel()}async _unmountPositionPanel(){const{unmountPositionPanel:e}=await It();null!==this._positionViewModel&&e(this._positionViewModel,this._tradingPanelContainer)}async _showPositionDialog(e){const{showPositionDialog:t}=await It();null!==this._positionViewModel&&t({viewModel:this._positionViewModel,settings:this._settings,focus:e,onOpen:e=>{this._visibility.setValue({isVisible:!0,isFullScreen:e})},onClose:()=>{this._visibility.setValue({isVisible:!1})}})}async _closePositionDialog(){const{closePositionDialog:e}=await It();e(()=>this._visibility.setValue({isVisible:!1}))}_subscribePositionViewModel(){(0,o.ensureNotNull)(this._positionViewModel).onModeChanged().subscribe(this,this._onPositionWidgetModeChanged),(0,o.ensureNotNull)(this._positionViewModel).onBackButtonClicked().subscribe(this,this._onPositionWidgetBackButtonClicked),(0,o.ensureNotNull)(this._positionViewModel).onCloseButtonClicked().subscribe(this,this._onPositionWidgetCloseButtonClicked)}_unsubscribePositionViewModel(){(0,o.ensureNotNull)(this._positionViewModel).onModeChanged().unsubscribe(this,this._onPositionWidgetModeChanged),(0,o.ensureNotNull)(this._positionViewModel).onBackButtonClicked().unsubscribe(this,this._onPositionWidgetBackButtonClicked),(0,o.ensureNotNull)(this._positionViewModel).onCloseButtonClicked().unsubscribe(this,this._onPositionWidgetCloseButtonClicked),(0,o.ensureNotNull)(this._positionViewModel).onDoneButtonClicked.resolve(!1),(0,o.ensureNotNull)(this._positionViewModel).destroy(),this._positionViewModel=null}_createStateChanging(){const e=new(l())(!1);this.stateChanging=e;const t=this._onStatusChanged;let i=0;return this._onStatusChanged=()=>(e.setValue(!0),i++,t.call(this).then(()=>{i--,e.setValue(0!==i)}).catch(t=>{throw i--,e.setValue(0!==i),t})),e}async _getInputStateFromStorage(){var e,t,i,s,r,o;if(null===this._state)return;let n;const a=await(null===(e=this._state.broker)||void 0===e?void 0:e.getOrderDialogOptions(this._state.symbol));return a&&a.customFields&&(n=null===(t=this._getTradingSettingsStorage())||void 0===t?void 0:t.customFields(this._state.symbol,a.customFields.map(e=>e.id))),{symbol:this._state.symbol,side:this._state.side,limitPrice:null,stopPrice:null,quantity:(null===(i=this._getTradingSettingsStorage())||void 0===i?void 0:i.symbolQty(this._state.symbol))||null,takeProfitPips:(null===(s=this._getTradingSettingsStorage())||void 0===s?void 0:s.takeProfitPips(this._state.symbol))||null,stopLossPips:(null===(r=this._getTradingSettingsStorage())||void 0===r?void 0:r.stopLossPips(this._state.symbol))||null,duration:(null===(o=this._getTradingSettingsStorage())||void 0===o?void 0:o.duration(this._state.symbol))||null,customFields:n||null}}_commonOrderViewModelProps(){return{order:this._orderStub,mode:this._mode,settings:this._settings,orderWidgetStat:this._orderWidgetStat,isTradingPanelOpened:this._isTradingPanelOpened,pipValueType:this._tradingCommands.pipValueType,onNeedSelectBroker:this._tradingCommands.onNeedSelectBroker,
trackEvent:this._tradingCommands.trackEvent,toggleTradingWidget:this._tradingCommands.toggleTradingWidget,showErrorNotification:this._tradingCommands.showErrorNotification,qtySuggester:this._qtySuggester}}}},71701:(e,t,i)=>{"use strict";i.d(t,{TradingLayoutBreakpoint:()=>r});var s=i(58825);const r={Mobile:s.mobile}},21786:(e,t,i)=>{"use strict";i.d(t,{SplitThousandsFormatter:()=>o});var s=i(6867),r=i(74605);class o{constructor(e=" "){this._divider=e}format(e){const t=(0,s.splitThousands)(e,this._divider);return(0,r.isRtl)()?(0,r.startWithLTR)(t):t}parse(e){const t=(0,r.stripLTRMarks)(e).split(this._divider).join(""),i=Number(t);return isNaN(i)||/e/i.test(t)?{res:!1}:{res:!0,value:i,suggest:this.format(i)}}}}}]);