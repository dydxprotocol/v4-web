(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[5142],{744633:t=>{t.exports={separator:"separator-gVkHdN_4"}},867768:t=>{t.exports={button:"button-KKlWfyVF"}},483830:t=>{t.exports={"trading-panel-content":"trading-panel-content-LlInYWMC","trading-panel-spinner":"trading-panel-spinner-LlInYWMC","trading-panel-handle":"trading-panel-handle-LlInYWMC"}},488803:t=>{t.exports={"tablet-normal-breakpoint":"screen and (max-width: 768px)","small-height-breakpoint":"screen and (max-height: 360px)","tablet-small-breakpoint":"screen and (max-width: 430px)"}},755596:t=>{t.exports={dialog:"dialog-b8SxMnzX",wrapper:"wrapper-b8SxMnzX",separator:"separator-b8SxMnzX"}},869827:t=>{t.exports={"small-height-breakpoint":"screen and (max-height: 360px)",container:"container-BZKENkhT",unsetAlign:"unsetAlign-BZKENkhT",title:"title-BZKENkhT",subtitle:"subtitle-BZKENkhT",textWrap:"textWrap-BZKENkhT",ellipsis:"ellipsis-BZKENkhT",close:"close-BZKENkhT",icon:"icon-BZKENkhT"}},345719:t=>{t.exports={separator:"separator-Pf4rIzEt"}},600297:(t,e,i)=>{"use strict";i.d(e,{Button:()=>n,ButtonType:()=>r});var r,s=i(50959),o=i(867768);!function(t){t[t.PlusValue=0]="PlusValue",t[t.IncDec=1]="IncDec",t[t.Clear=2]="Clear",t[t.Default=3]="Default"}(r||(r={}));class n extends s.PureComponent{constructor(t){super(t),this._createClickHandler=(t,e=r.Default)=>()=>{this.props.onClick(t,e)}}render(){let t;switch(this.props.type){case r.PlusValue:case r.IncDec:t=this.props.value;break;case r.Clear:t="clear";break;case r.Default:t="default"}return s.createElement("div",{className:o.button,"data-value":t,"data-name":`qtyButtonCalculator-${t}`,onClick:this._createClickHandler(this.props.value,this.props.type)},this.props.icon||this.props.value)}}},190787:(t,e,i)=>{"use strict";function r(t,e){null===t.firstChild?t.textContent=e:t.firstChild.nodeValue=e}i.d(e,{updateTextNode:()=>r})},996038:(t,e,i)=>{"use strict";i.d(e,{DialogBreakpoints:()=>s});var r=i(488803);const s={SmallHeight:r["small-height-breakpoint"],TabletSmall:r["tablet-small-breakpoint"],TabletNormal:r["tablet-normal-breakpoint"]}},533408:(t,e,i)=>{"use strict";i.d(e,{AdaptivePopupDialog:()=>B});var r=i(50959),s=i(650151),o=i(660538),n=i(497754),a=i.n(n),l=i(180185),c=i(698043),d=i(40766),u=i(494707),h=i(996038),p=i(930052),_=i(910549);var g=i(206594),m=i(559410),b=i(72571),y=i(190410),v=i(507720),f=i(869827);function k(t){const{title:e,titleTextWrap:i=!1,subtitle:s,showCloseIcon:o=!0,onClose:n,onCloseButtonKeyDown:l,renderBefore:c,renderAfter:d,draggable:u,className:h,unsetAlign:p,closeAriaLabel:_,closeButtonReference:g}=t,[m,k]=(0,r.useState)(!1);return r.createElement(y.DialogHeaderContext.Provider,{value:{setHideClose:k}},r.createElement("div",{className:a()(f.container,h,(s||p)&&f.unsetAlign)},c,r.createElement("div",{"data-dragg-area":u,className:f.title},r.createElement("div",{className:a()(i?f.textWrap:f.ellipsis)},e),s&&r.createElement("div",{className:a()(f.ellipsis,f.subtitle)},s)),d,o&&!m&&r.createElement("button",{className:f.close,onClick:n,onKeyDown:l,
"data-name":"close","aria-label":_,type:"button",ref:g},r.createElement(b.Icon,{className:f.icon,icon:v,"data-name":"close","data-role":"button"}))))}var P=i(273388),S=i(755596);const C={vertical:20},w={vertical:0};class B extends r.PureComponent{constructor(){super(...arguments),this._controller=null,this._reference=null,this._orientationMediaQuery=null,this._renderChildren=(t,e)=>(this._controller=t,this.props.render({requestResize:this._requestResize,centerAndFit:this._centerAndFit,isSmallWidth:e})),this._handleReference=t=>this._reference=t,this._handleCloseBtnClick=()=>{this.props.onKeyboardClose&&this.props.onKeyboardClose(),this._handleClose()},this._handleClose=()=>{this.props.onClose()},this._handleOpen=()=>{void 0!==this.props.onOpen&&this.props.isOpened&&this.props.onOpen(this.props.fullScreen||window.matchMedia(h.DialogBreakpoints.TabletSmall).matches)},this._handleKeyDown=t=>{if(!t.defaultPrevented){if(this.props.onKeyDown&&this.props.onKeyDown(t),27===(0,l.hashFromEvent)(t)){if(t.defaultPrevented)return;if(this.props.forceCloseOnEsc&&this.props.forceCloseOnEsc())return this.props.onKeyboardClose&&this.props.onKeyboardClose(),void this._handleClose();const{activeElement:i}=document,r=(0,s.ensureNotNull)(this._reference);if(null!==i){if(t.preventDefault(),"true"===(e=i).getAttribute("data-haspopup")&&"true"!==e.getAttribute("data-expanded"))return void this._handleClose();if((0,c.isTextEditingField)(i))return void r.focus();if(r.contains(i))return this.props.onKeyboardClose&&this.props.onKeyboardClose(),void this._handleClose()}}var e,i;(function(t){if("function"==typeof t)return t();return Boolean(t)})(this.props.disableTabNavigationContainment)||(i=t,[9,l.Modifiers.Shift+9].includes((0,l.hashFromEvent)(i))&&i.stopPropagation())}},this._requestResize=()=>{null!==this._controller&&this._controller.recalculateBounds()},this._centerAndFit=()=>{null!==this._controller&&this._controller.centerAndFit()}}componentDidMount(){this.props.ignoreClosePopupsAndDialog||m.subscribe(g.CLOSE_POPUPS_AND_DIALOGS_COMMAND,this._handleClose,null),this._handleOpen(),void 0!==this.props.onOpen&&(this._orientationMediaQuery=window.matchMedia("(orientation: portrait)"),(0,o.mediaQueryAddEventListener)(this._orientationMediaQuery,this._handleOpen))}componentWillUnmount(){this.props.ignoreClosePopupsAndDialog||m.unsubscribe(g.CLOSE_POPUPS_AND_DIALOGS_COMMAND,this._handleClose,null),null!==this._orientationMediaQuery&&(0,o.mediaQueryRemoveEventListener)(this._orientationMediaQuery,this._handleOpen)}focus(){(0,s.ensureNotNull)(this._reference).focus()}getElement(){return this._reference}contains(t){var e,i;return null!==(i=null===(e=this._reference)||void 0===e?void 0:e.contains(t))&&void 0!==i&&i}render(){
const{className:t,wrapperClassName:e,headerClassName:i,isOpened:s,title:o,titleTextWrap:n,dataName:l,onClickOutside:c,additionalElementPos:g,additionalHeaderElement:m,backdrop:b,shouldForceFocus:y=!0,shouldReturnFocus:v,showSeparator:f,subtitle:B,draggable:T=!0,fullScreen:O=!1,showCloseIcon:E=!0,rounded:L=!0,isAnimationEnabled:D,growPoint:I,dialogTooltip:A,unsetHeaderAlign:N,onDragStart:M,dataDialogName:V,closeAriaLabel:x,containerAriaLabel:R,reference:F,containerTabIndex:q,closeButtonReference:U,onCloseButtonKeyDown:W}=this.props,Q="after"!==g?m:void 0,$="after"===g?m:void 0,j="string"==typeof o?o:V||"",z=(0,P.mergeRefs)([this._handleReference,F]);return r.createElement(p.MatchMedia,{rule:h.DialogBreakpoints.SmallHeight},(g=>r.createElement(p.MatchMedia,{rule:h.DialogBreakpoints.TabletSmall},(h=>r.createElement(d.PopupDialog,{rounded:!(h||O)&&L,className:a()(S.dialog,t),isOpened:s,reference:z,onKeyDown:this._handleKeyDown,onClickOutside:c,onClickBackdrop:c,fullscreen:h||O,guard:g?w:C,boundByScreen:h||O,shouldForceFocus:y,shouldReturnFocus:v,backdrop:b,draggable:T,isAnimationEnabled:D,growPoint:I,name:this.props.dataName,dialogTooltip:A,onDragStart:M,containerAriaLabel:R,containerTabIndex:q},r.createElement("div",{className:a()(S.wrapper,e),"data-name":l,"data-dialog-name":j},void 0!==o&&r.createElement(k,{draggable:T&&!(h||O),onClose:this._handleCloseBtnClick,renderAfter:$,renderBefore:Q,subtitle:B,title:o,titleTextWrap:n,showCloseIcon:E,className:i,unsetAlign:N,closeAriaLabel:x,closeButtonReference:U,onCloseButtonKeyDown:W}),f&&r.createElement(u.Separator,{className:S.separator}),r.createElement(_.PopupContext.Consumer,null,(t=>this._renderChildren(t,h||O)))))))))}}},190410:(t,e,i)=>{"use strict";i.d(e,{DialogHeaderContext:()=>r});const r=i(50959).createContext({setHideClose:()=>{}})},494707:(t,e,i)=>{"use strict";i.d(e,{Separator:()=>n});var r=i(50959),s=i(497754),o=i(345719);function n(t){return r.createElement("div",{className:s(o.separator,t.className)})}},665276:(t,e,i)=>{"use strict";i.d(e,{Spinner:()=>n});var r=i(50959),s=i(497754),o=i(843442);i(683135);function n(t){const e=s(t.className,"tv-spinner","tv-spinner--shown",`tv-spinner--size_${o.spinnerSizeMap[t.size||o.DEFAULT_SIZE]}`);return r.createElement("div",{className:e,style:t.style,role:"progressbar"})}},106056:(t,e,i)=>{"use strict";var r,s,o;i.d(e,{CloseTrigger:()=>r,ToastAnimationStage:()=>s,ToastPriority:()=>o}),function(t){t.Swipe="swipe",t.Click="click"}(r||(r={})),function(t){t[t.Add=0]="Add",t[t.Remove=1]="Remove",t[t.None=2]="None"}(s||(s={})),function(t){t[t.Low=0]="Low",t[t.Medium=1]="Medium",t[t.High=2]="High"}(o||(o={}))},673543:t=>{t.exports={loader:"loader-AR4z1Ifp","loader-animation":"loader-animation-AR4z1Ifp",loaderCircle:"loaderCircle-AR4z1Ifp"}},234362:t=>{t.exports={loader:"loader-_7n3rLPY",loaderItem:"loaderItem-_7n3rLPY","loader-animation":"loader-animation-_7n3rLPY",touchMode:"touchMode-_7n3rLPY"}},707488:t=>{t.exports={blockHidden:"blockHidden-e6PF69Df","pane-button":"pane-button-e6PF69Df"}},844012:t=>{t.exports={
"css-value-padding":"4px"}},199056:t=>{t.exports={"css-value-padding":"4px",container:"container-hw_3o_pb",informerWrapper:"informerWrapper-hw_3o_pb",notAvailableOnMobile:"notAvailableOnMobile-hw_3o_pb",column:"column-hw_3o_pb",touchMode:"touchMode-hw_3o_pb",buttonsWrapper:"buttonsWrapper-hw_3o_pb",button:"button-hw_3o_pb",sellButton:"sellButton-hw_3o_pb",buyButton:"buyButton-hw_3o_pb",brokerButton:"brokerButton-hw_3o_pb",highButtons:"highButtons-hw_3o_pb",withoutBg:"withoutBg-hw_3o_pb",lastCharSup:"lastCharSup-hw_3o_pb",spreadQtyWrapper:"spreadQtyWrapper-hw_3o_pb",spread:"spread-hw_3o_pb",withoutQty:"withoutQty-hw_3o_pb",qty:"qty-hw_3o_pb",loader:"loader-hw_3o_pb",circleLoader:"circleLoader-hw_3o_pb",loading:"loading-hw_3o_pb",buttonText:"buttonText-hw_3o_pb",brokerButtonIconWrap:"brokerButtonIconWrap-hw_3o_pb",brokerButtonDefault:"brokerButtonDefault-hw_3o_pb",buttons:"buttons-hw_3o_pb"}},640712:t=>{t.exports={popupWrapper:"popupWrapper-sxxSUmLh"}},517516:t=>{t.exports={"small-height-breakpoint":"screen and (max-height: 360px)",moreButton:"moreButton-LjodxXHh"}},851237:(t,e,i)=>{"use strict";i.d(e,{LoaderBaseRenderer:()=>s});var r=i(707488);class s{constructor(t,e={}){this._loadingEl=document.createElement("span"),this._renderLoading(e),this.toggleVisibility(!1),t.appendChild(this._loadingEl)}toggleVisibility(t){this._loadingEl.classList.toggle(r.blockHidden,!t)}_renderLoading(t){const{className:e}=t;e&&this._loadingEl.classList.add(e)}}},462892:(t,e,i)=>{"use strict";i.d(e,{LoaderPointsRenderer:()=>o});var r=i(851237),s=i(234362);class o extends r.LoaderBaseRenderer{_renderLoading(t){super._renderLoading(t),this._loadingEl.innerHTML=`\n\t\t\t<span class="${s.loaderItem}"></span>\n\t\t\t<span class="${s.loaderItem}"></span>\n\t\t\t<span class="${s.loaderItem}"></span>\n\t\t`,this._loadingEl.classList.add(s.loader)}}},521744:(t,e,i)=>{"use strict";i.d(e,{trackingModeIsAvailable:()=>r});const r=i(601227).CheckMobile.any()},943778:(t,e,i)=>{"use strict";i.d(e,{pipsToPrice:()=>a,pipsToRiskInCurrency:()=>l,pipsToRiskInPercent:()=>c,priceToPips:()=>s,riskInCurrencyToPips:()=>o,riskInPercentToPips:()=>n});var r=i(960521);function s(t,e,i,s){return(0,r.Big)(t).minus(e).div(s).div(i).toNumber()}function o(t,e,i,s,o){const n=(0,r.Big)(i).mul(e).mul(o||1);if(n.eq(0))return 0;const a=(0,r.Big)(t).div(n).mul(s).toNumber();return Math.floor(a)}function n(t,e,i,s,o,n){const a=(0,r.Big)(s).mul(e).mul(n||1).mul(100);if(a.eq(0))return 0;const l=(0,r.Big)(t).mul(i).div(a).mul(o).toNumber();return Math.floor(l)}function a(t,e,i,s){return(0,r.Big)(i).mul(t).mul(s).plus(e).toNumber()}function l(t,e,i,s,o){return(0,r.Big)(t).mul(i).mul(e).mul(o||1).div(s).toNumber()}function c(t,e,i,s,o,n){return i?(0,r.Big)(t).mul(s).mul(e).mul(n||1).mul(100).div(i).div(o).toNumber():0}},481853:(t,e,i)=>{"use strict";i.d(e,{BrokerService:()=>s});var r=i(650151);class s{constructor(t){this._activeBroker=null,this._trading=t,this._trading.onConnectionStatusChange.subscribe(this,this._onStatusChange),this._onStatusChange(this._trading.connectStatus())}
activeBroker(){return this._activeBroker}trading(){return this._trading}_stopService(){this.stopService(),(0,r.ensureNotNull)(this._activeBroker).currentAccountUpdate.unsubscribeAll(this)}_startService(){this.startService(),(0,r.ensureNotNull)(this._activeBroker).currentAccountUpdate.subscribe(this,this._onCurrentAccountUpdate)}_onStatusChange(t){const e=this._trading.activeBroker();this._activeBroker===e&&1===t||(null!==this._activeBroker&&(this._stopService(),this._activeBroker=null),null!==e&&1===t&&(this._activeBroker=e,this._startService(),this._lastAccountId=e.currentAccount()))}_onCurrentAccountUpdate(){const t=(0,r.ensureNotNull)(this._activeBroker);this._lastAccountId!==t.currentAccount()&&(this.stopService(),this.startService(),this._lastAccountId=t.currentAccount())}}},447485:(t,e,i)=>{"use strict";i.r(e),i.d(e,{addBroker:()=>wt,addBrokerByLaunchCountries:()=>Bt,brokersList:()=>Tt,createBrokerConnection:()=>Et});var r=i(509806),s=i(116193),o=i(148442),n=i(156963),a=i(372605),l=i(466052),c=i.n(l),d=i(650151);class u{constructor(t){this._objects={},this._started=!1,this._isObjectsRequestActual=!1,this._ordersPromise=null,this._getter=t,this.updateDelegate=new(c()),this.partialUpdateDelegate=new(c())}start(){this._started||(this._started=!0,this._ordersPromise=this._requestObjects())}stop(){this._objects={},this._started=!1,this._ordersPromise=null,this._isObjectsRequestActual=!1}update(t,e){this._started&&(this._isObjectsRequestActual?this._isObjectsRequestActual=!1:(this._objects[t.id]=t,this._onObjectUpdated(t,e)))}partialUpdate(t,e){if(!this._started)return;if(this._isObjectsRequestActual)return void(this._isObjectsRequestActual=!1);let i,r;(0,a.isObject)(t)?(i=t.id,r=t):(i=t,r=(0,d.ensure)(e));const s=this._objects[i];s&&(Object.assign(s,r),this.partialUpdateDelegate.fire(s,r))}fullUpdate(){this._started&&(this._isObjectsRequestActual?this._isObjectsRequestActual=!1:this._ordersPromise=this._requestObjects())}getObjects(){return this._ordersPromise||Promise.resolve(Object.values(this._objects))}_onObjectUpdated(t,e){this.updateDelegate.fire(t,e)}_onAllObjectsUpdated(){this._objectsCache().forEach((t=>this.updateDelegate.fire(t,!0)))}_objectsCache(){return Object.values(this._objects)}async _requestObjects(){let t=[];do{this._isObjectsRequestActual=!0,t=await this._getter()}while(!this._isObjectsRequestActual);var e;return this._objects=(e="id",t.reduce(((t,i)=>(t[i[e]]=i,t)),{})),this._ordersPromise=null,this._isObjectsRequestActual=!1,this._onAllObjectsUpdated(),t}}var h=i(6835),p=i(511990);class _ extends u{constructor(t,e){super(t),this._brokerConfigGetter=e}_onObjectUpdated(t,e){this._patchTrades(this._objectsCache().filter((e=>e.symbol===t.symbol&&0!==e.qty)),t,e),super._onObjectUpdated(t,e)}_onAllObjectsUpdated(){this._patchTrades(this._objectsCache().filter((t=>0!==t.qty))),super._onAllObjectsUpdated()}_patchTrades(t,e,i){const r=this._brokerConfigGetter();let s;s=r.requiresFIFOCloseTrades?r.fifoOnlyForSameQty?b:m:g;const o=s(t);for(const t of o)e!==t&&super._onObjectUpdated(t,i)}}function g(t){
const e=[];for(const i of t)i.canBeClosed||(i.canBeClosed=!0,e.push(i));return e}function m(t){const e={};for(const i of t){let t=e[i.symbol];void 0===t&&(t={oldest:null,all:[]},e[i.symbol]=t),(null===t.oldest||t.oldest.date>i.date)&&(t.oldest=i),t.all.push(i)}const i=[];for(const t of Object.keys(e)){const r=(0,d.ensureDefined)(e[t]);for(const t of r.all){const e=r.oldest===t,s=e!==t.canBeClosed;t.canBeClosed=e,s&&i.push(t)}}return i}function b(t){const e={};for(const i of t){let t=e[i.symbol];void 0===t&&(t={},e[i.symbol]=t);let r=t[i.qty];void 0===r&&(r={oldest:null,all:[]},t[i.qty]=r),(null===r.oldest||r.oldest.date>i.date)&&(r.oldest=i),r.all.push(i)}const i=[];for(const t of Object.keys(e)){const r=(0,d.ensureDefined)(e[t]);for(const t of Object.keys(r)){const e=(0,d.ensureDefined)(r[t]);for(const t of e.all){const r=e.oldest===t,s=r!==t.canBeClosed;t.canBeClosed=r,s&&i.push(t)}}}return i}var y=i(387098),v=i(637401),f=i(311757),k=i(508334),P=i(189904),S=i(481330);function C(t,e){return{symbol:e.symbol,type:2,side:1===e.side?-1:1,qty:Math.abs(t),seenPrice:null,isClose:!0}}var w=i(864348),B=i(656846);class T{constructor(){this._validators=new Map}add(t,e){this._validators.set(e,t)}validate(t){const e={};let i=!0;for(const[r,s]of this._validators.entries()){const o=s.validate(t);o.isValid||(i=!1,e[r]=o.errorMessage)}return i?{isValid:i}:{isValid:i,errorMessages:e}}}class O{constructor(t,e=[]){this._status=w.PlaceOrEditContextStatus.Undefined,this._onStatusChange=new(c()),this._errors={},this._isValidationEnabled=t,this._validator=new T;for(const{validator:t,validatorName:i}of e)this._validator.add(t,i)}onReady(){return this._onReady}data(){return this._orderData}status(){return this._status}errors(){return this._errors}onStatusChange(){return this._onStatusChange}async send(t){if(this._status!==w.PlaceOrEditContextStatus.Undefined)return!1;this._setStatus(w.PlaceOrEditContextStatus.Loading),await this._onReady;const e=await this._processSend(t),i=e?w.PlaceOrEditContextStatus.Undefined:w.PlaceOrEditContextStatus.Error;return this._setStatus(i),e}async _setData(t){this._orderData=await this._processOrderData(t),this._assertOrderIsValid()}_assertOrderIsValid(){const{isValid:t,errorMessages:e}=this._validate();let i=!1;if(t)i=this._status!==w.PlaceOrEditContextStatus.Undefined,this._errors={},this._status=w.PlaceOrEditContextStatus.Undefined;else{const[t]=(0,a.deepEquals)(this._errors,e);i=!t,this._errors=e,this._status=w.PlaceOrEditContextStatus.Error}i&&this._onStatusChange.fire()}_setStatus(t){this._status!==t&&(this._status=t,this._onStatusChange.fire())}_validate(){return this._isValidationEnabled?this._validator.validate(this._orderData):{isValid:!0}}}var E=i(957877),L=i(807107);class D{constructor(t){const{priceType:e,quotes:i,formatter:r,instrumentInfo:s,supportStopOrdersInBothDirections:o,supportStopLimitOrdersInBothDirections:n}=t;this._priceType=e,this._quotes=i,this._formatter=r,this._supportStopOrdersInBothDirections=Boolean(o),this._supportStopLimitOrdersInBothDirections=Boolean(n),
this._symbolType=s.type||"",this._minTick=s.minTick,this._limitPriceStep=s.limitPriceStep,this._stopPriceStep=s.stopPriceStep,this._variableMinTickData=s.variableMinTick?(0,L.makeVariableMinTickData)(this._minTick,s.variableMinTick):void 0}validate(t){const{type:e,side:s,stopPrice:o,limitPrice:n}=t,a=2===this._priceType;if(2===e||a&&1===e||!a&&3===e)return{isValid:!0};const l=a?o:n;if(void 0===l)return{isValid:!1,errorMessage:r.t(null,void 0,i(347957))};const c=(0,S.getPriceStep)({price:l,priceType:this._priceType,minTick:this._minTick,variableMinTickData:this._variableMinTickData,limitPriceStep:this._limitPriceStep,stopPriceStep:this._stopPriceStep}),d=(0,S.roundToStepRequired)({priceType:this._priceType,minTick:this._minTick,limitPriceStep:this._limitPriceStep,stopPriceStep:this._stopPriceStep}),u=(0,E.validatePrice)({price:l,askOrBid:(0,S.getQuotePrice)(this._quotes,s),orderType:e,side:s,isStopPrice:a,isForex:"forex"===this._symbolType,formatter:this._formatter,supportStopOrdersInBothDirections:this._supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:this._supportStopLimitOrdersInBothDirections,step:c,roundedToStep:d});return u.res?{isValid:!1,errorMessage:u.msg}:{isValid:!0}}}var I=i(99708);class A{constructor(t){this._quantityMetainfo=t}validate(t){const e=(0,I.checkQtyError)(this._quantityMetainfo,t.qty,!0);return e.res?{isValid:!1,errorMessage:e.msg}:{isValid:!0}}}var N=i(164530),M=i(346849),V=i(943778);class x{constructor(t){this._bracketPercentPriceRuleCheckers=[];const{bracketType:e,priceType:i,parentType:r,quotes:s,formatter:o,instrumentInfo:n,validationRules:a}=t;if(this._bracketType=e,this._priceType=i,this._parentType=r,this._quotes=s,this._formatter=o,this._pipSize=n.pipSize,this._priceStep=(0,S.getPriceStep)({priceType:i,minTick:n.minTick||n.pipSize,limitPriceStep:n.limitPriceStep,stopPriceStep:n.stopPriceStep}),this._roundToStepRequired=(0,S.roundToStepRequired)({priceType:i,minTick:n.minTick||n.pipSize,limitPriceStep:n.limitPriceStep,stopPriceStep:n.stopPriceStep}),void 0!==a)for(const t of a)this._bracketPercentPriceRuleCheckers.push((0,M.makeBracketPercentPriceRuleChecker)(t.options.min,t.options.max))}validate(t){const{side:e,takeProfit:s,stopLoss:o,trailingStopPips:n}=t;if(this._bracketType===N.BracketType.TakeProfit&&void 0===s||this._bracketType===N.BracketType.StopLoss&&void 0===o||this._bracketType===N.BracketType.TrailingStop&&void 0===n)return{isValid:!0};const a=function(t,e){switch(t.type){case 1:case 4:return t.limitPrice;case 3:return t.stopPrice;default:return(0,S.getQuotePrice)(e,t.side)}}(t,this._quotes);if(void 0===a)return{isValid:!1,errorMessage:r.t(null,void 0,i(762686))};const l=(this._bracketType!==N.BracketType.TakeProfit?-1:1)*e,c=this._getPrice(t,a,l),d=this._getPips(t,a,l),u=(0,M.checkBracketError)({quotes:this._quotes,side:e,price:c,pips:d,priceType:this._priceType,priceStep:this._priceStep,parentPrice:a,parentType:this._parentType,bracketType:this._bracketType,isStatusEditing:!1,isEnabled:!0,
bracketPercentPriceRuleCheckers:this._bracketPercentPriceRuleCheckers,priceFormatter:this._formatter,isRoundToPriceStep:this._roundToStepRequired});return u.res?{isValid:!1,errorMessage:u.msg}:{isValid:!0}}_getPrice(t,e,i){var r,s;switch(this._bracketType){case N.BracketType.TakeProfit:return null!==(r=t.takeProfit)&&void 0!==r?r:null;case N.BracketType.StopLoss:return null!==(s=t.stopLoss)&&void 0!==s?s:null;case N.BracketType.TrailingStop:return void 0===t.trailingStopPips?null:(0,V.pipsToPrice)(t.trailingStopPips,e,i,this._pipSize);default:return null}}_getPips(t,e,i){var r;switch(this._bracketType){case N.BracketType.TakeProfit:return void 0===t.takeProfit?null:(0,V.priceToPips)(t.takeProfit,e,i,this._pipSize);case N.BracketType.StopLoss:return void 0===t.stopLoss?null:(0,V.priceToPips)(t.stopLoss,e,i,this._pipSize);case N.BracketType.TrailingStop:return null!==(r=t.trailingStopPips)&&void 0!==r?r:null;default:return null}}}class R{constructor(t){const{orderDialogOptions:e}=t;this._orderDialogOptions=e}validate(t){var e;const{customFields:s}=t;if(void 0===(null===(e=this._orderDialogOptions)||void 0===e?void 0:e.customFields)||0===this._orderDialogOptions.customFields.length)return{isValid:!0};const o=[];return this._orderDialogOptions.customFields.forEach((t=>{void 0===(null==s?void 0:s[t.id])&&o.push(t.title)})),0===o.length?{isValid:!0}:{isValid:!1,errorMessage:r.t(null,void 0,i(346881)).format({customFields:o.join(", ")})}}}class F extends O{constructor(t){const{orderData:e,instrumentInfo:i,quotes:r,configFlags:s,formatter:o,tpValidationRules:n,slValidationRules:a,isValidationEnabled:l,orderDialogOptions:c,callbacks:d}=t;super(l,[{validator:new A(i.qty),validatorName:"qty"},{validator:new D({priceType:2,quotes:r,formatter:o,instrumentInfo:i,supportStopOrdersInBothDirections:s.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:s.supportStopLimitOrdersInBothDirections}),validatorName:"stopPrice"},{validator:new D({priceType:1,quotes:r,formatter:o,instrumentInfo:i,supportStopOrdersInBothDirections:s.supportStopOrdersInBothDirections,supportStopLimitOrdersInBothDirections:s.supportStopLimitOrdersInBothDirections}),validatorName:"limitPrice"},{validator:new R({orderDialogOptions:c}),validatorName:"customFields"},{validator:new x({bracketType:B.BracketType.TakeProfit,priceType:1,parentType:1,quotes:r,formatter:o,instrumentInfo:i,validationRules:n}),validatorName:"takeProfit"},{validator:new x({bracketType:B.BracketType.StopLoss,priceType:2,parentType:1,quotes:r,formatter:o,instrumentInfo:i,validationRules:a}),validatorName:"stopLoss"},{validator:new x({bracketType:B.BracketType.TrailingStop,priceType:2,parentType:1,quotes:r,formatter:o,instrumentInfo:i,validationRules:a}),validatorName:"trailingStopPips"}]),this._createInitialPreOrder=d.createInitialPreOrder,this._placeOrder=d.placeOrder,this._previewOrder=d.previewOrder,this._onReady=this._setData(e)}async preview(){return this._status===w.PlaceOrEditContextStatus.Error?{sections:[]}:this._previewOrder(this._orderData)}externalContext(){
return{type:w.PlaceOrEditContextType.PlaceOrder,data:()=>this.data(),send:()=>this.send(),status:()=>this.status(),errors:()=>this.errors()}}_processSend(t){return this._placeOrder(this._orderData,t)}_processOrderData(t){return this._createInitialPreOrder(t)}}var q=i(822914),U=i(282729);class W extends O{constructor(t){const{orderData:e,callbacks:i}=t;super(!1),this._modifyOrder=i.modifyOrder,this._metainfo=i.metainfo,this._symbolInfo=i.symbolInfo,this._orderById=i.orderById,this._onReady=this._setData(e)}externalContext(){return{type:w.PlaceOrEditContextType.EditOrder,data:()=>this.data(),send:()=>this.send(),status:()=>this.status(),errors:()=>this.errors()}}async _processOrderData(t){if(!this._metainfo().configFlags.supportModifyTrailingStop){const e=await this._orderById(t.id);t.hasTrailingStopBracket=void 0!==e&&void 0!==e.trailingStopPips}const{limitPriceStep:e,stopPriceStep:i}=await this._symbolInfo(t.symbol);if(t.limitPrice=void 0!==e&&void 0!==t.limitPrice?(0,v.roundToStepByPriceTypeAndSide)(t.limitPrice,e,1,t.side):t.limitPrice,t.stopPrice=void 0!==i&&void 0!==t.stopPrice?(0,v.roundToStepByPriceTypeAndSide)(t.stopPrice,i,2,t.side):t.stopPrice,void 0!==t.parentId&&!n.enabled("always_pass_called_order_to_modify")){let e;try{e=await this._orderById(t.parentId)}catch(t){(0,v.getLoggerMessage)(t)}if(void 0!==e&&(0,S.isOrderActive)(e.status)){const i=(0,q.default)(e);return void 0!==t.limitPrice&&(i.takeProfit=t.limitPrice),void 0!==t.stopPrice&&(t.stopType===U.StopType.TrailingStop&&void 0!==t.trailingStopPips?(i.trailingStopPips=t.trailingStopPips,delete i.stopLoss):(i.stopLoss=t.stopPrice,delete i.trailingStopPips)),i}}return t}_processSend(t){return this._modifyOrder(this._orderData,t)}_configureValidator(){}}var Q=i(232192);const $=(0,h.getLogger)("Trading.BrokerConnectionAdapter"),j=r.t(null,void 0,i(473142)),z=r.t(null,void 0,i(945593));function H(t){(0,d.assert)("object"!=typeof t,"Expected not an object")}function K(t,e){return t.type===e.type&&t.qty===e.qty&&t.limitPrice===e.limitPrice&&t.stopPrice===e.stopPrice&&t.takeProfit===e.takeProfit&&t.stopLoss===e.stopLoss&&t.trailingStopPips===e.trailingStopPips}class G{constructor({brokerMetainfo:t,brokerConnection:e,host:s,brokerRealtimeAdapter:o,tradingStat:n,tradingSettingsStorageGetter:a,brokerPlan:l}){this.connectionStatusUpdate=new(c()),this.executionUpdate=new(c()),this.tradingOperationFinished=new(c()),this.currentAccountUpdate=new(c()),this._brokerPlan=null,this._subscriptions={},this._lastFireResult={},this._fakeDOMSubscriptions={},this._formattersCache={},this._spreadFormattersCache={},this._quantityFormattersCache={},this._tradesCache=null,this._fakePositionUpdateDelegate=null,this._realtimeSubscriptionState=[],this._loggedInManually=!1,this._pendingSubscriptions=[],this._sessionId=(0,P.guid)(),this.leverageInfo=t=>{if(this.config.supportLeverage&&this._brokerConnection.leverageInfo)return this._brokerConnection.leverageInfo(t);throw new Error("Method leverage is not implemented")},this.setLeverage=t=>{
if(this.config.supportLeverage&&this._brokerConnection.setLeverage)return this._brokerConnection.setLeverage(t);throw new Error("Method setLeverage is not implemented")},this.previewLeverage=t=>{if(this.config.supportLeverage&&this._brokerConnection.previewLeverage)return this._brokerConnection.previewLeverage(t);throw new Error("Method previewLeverage is not implemented")},this.maintenanceStatus=async()=>{try{return void 0!==this._brokerConnection.maintenanceStatus?await this._brokerConnection.maintenanceStatus():{isMaintenance:!1}}catch(t){return this._brokerLogger.logError(`Failed to fetch maintenance status: ${(0,v.getLoggerMessage)(t)}`),{isMaintenance:!0,message:r.t(null,{replace:{brokerName:this._brokerMetainfo.title}},i(8793))}}},this.config=Object.assign({},t.configFlags),this._brokerMetainfo=this._patchMetainfo(t),this._brokerPlan=l||null,this._brokerConnection=e,this._host=s,this._tradingStat=n,this._getTradingSettingsStorage=a,this._brokerLogger=(0,h.getLogger)("Trading."+this._brokerMetainfo.id+".Connection"),s.setBrokerConnectionAdapter(this),this._initializeConnectProtection(),this._positionsCache=e.positions?new u((()=>e.positions?e.positions():Promise.resolve([]))):null,this._tradesCache=e.trades?new _((()=>e.trades?e.trades():Promise.resolve([])),(()=>this.config)):null,this._ordersCache=new u((()=>e.orders()));const d=t=>{1===t?(null!==this._positionsCache&&this._positionsCache.start(),this._ordersCache.start(),this._tradesCache&&this._tradesCache.start()):(null!==this._positionsCache&&this._positionsCache.stop(),this._ordersCache.stop(),this._tradesCache&&this._tradesCache.stop())};this.connectionStatusUpdate.subscribe(null,d),d(this.connectionStatus()),this._originalDOMSubscriptionMethods={subscribeDOM:e.subscribeDOM,unsubscribeDOM:e.unsubscribeDOM},this._patchBrokerSubscribeUnsubscribeDOMMethods(),this.connectionStatusUpdate.subscribe(null,(t=>{1===t&&this._patchBrokerSubscribeUnsubscribeDOMMethods()})),t.configFlags.supportPositions||(this._fakePositionUpdateDelegate=new(c())),this._brokerRealtimeAdapter=o}tryRestoreSession(){if(this._brokerConnection.tryRestoreSession)return this._brokerConnection.tryRestoreSession()}get orderUpdate(){return this._ordersCache.updateDelegate}get positionUpdate(){return null===this._fakePositionUpdateDelegate?(0,d.ensure)(this._positionsCache).updateDelegate:this._fakePositionUpdateDelegate}get tradeUpdate(){return(0,d.ensure)(this._tradesCache).updateDelegate}get orderPartialUpdate(){return this._ordersCache.partialUpdateDelegate}get positionPartialUpdate(){return null===this._fakePositionUpdateDelegate?(0,d.ensure)(this._positionsCache).partialUpdateDelegate:this._fakePositionUpdateDelegate}get tradePartialUpdate(){return(0,d.ensure)(this._tradesCache).partialUpdateDelegate}onOrderUpdate(t){this._ordersCache.update(t)}onOrderPartialUpdate(t,e){this._ordersCache.partialUpdate(t,e)}onPositionUpdate(t,e){if((0,d.assert)(!!this.config.supportPositions,"Broker doesn`t support positions"),0===t.qty){const e=this._lastFireResult[t.id];e&&delete e.PL}(0,
d.ensure)(this._positionsCache).update(t,e)}onPositionPartialUpdate(t,e){(0,d.assert)(!!this.config.supportPositions,"Broker doesn`t support positions"),(0,d.ensure)(this._positionsCache).partialUpdate(t,e)}onTradeUpdate(t,e){if((0,d.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),0===t.qty){const e=this._lastFireResult[t.symbol];e&&delete e.TradePL}(0,d.ensure)(this._tradesCache).update(t,e)}onTradePartialUpdate(t,e){(0,d.ensure)(this._tradesCache).partialUpdate(t,e)}onCurrentAccountChanged(){null!==this._positionsCache&&this._positionsCache.fullUpdate(),this._ordersCache.fullUpdate(),this._tradesCache&&this._tradesCache.fullUpdate();const t=this.currentAccount();this.currentAccountUpdate.fire(t)}patchConfig(t){(0,y.migrateConfigFlags)(t),Object.assign(this.config,t),Object.assign(this._brokerMetainfo.configFlags,t),this._brokerMetainfo=this._patchMetainfo(this._brokerMetainfo)}async getOrderDialogOptions(t){if(void 0!==this._brokerConnection.getOrderDialogOptions)try{return await this._brokerConnection.getOrderDialogOptions(t)}catch(t){return void this._brokerLogger.logError(`Failed to fetch options for the order dialog: ${(0,v.getLoggerMessage)(t)}`)}}getPositionDialogOptions(){return void 0!==this._brokerConnection.getPositionDialogOptions?this._brokerConnection.getPositionDialogOptions():void 0}getValidationRules(t){return void 0!==this._brokerConnection.getValidationRules?this._brokerConnection.getValidationRules(t):void 0}chartContextMenuActions(t,e){return this._brokerConnection.chartContextMenuActions(t,e)}buttonDropdownActions(){return this._host.buttonDropdownActions()}connectionStatus(){return this._brokerConnection.connectionStatus()}isConnected(){return 1===this._brokerConnection.connectionStatus()}signIn(t,e,i,r){return this._brokerLogger.logNormal(`Try to login with username: ${t}`),this._loggedInManually=!0,this._brokerConnection.signIn(t,e,i,r)}loggedInManually(){return this._loggedInManually}disconnect(t=!1){try{return this._brokerConnection.disconnect(t)}catch(t){$.logWarn("Failed to disconnect")}}currentAccount(){return this._brokerConnection.currentAccount?this._brokerConnection.currentAccount():""}currentAccountType(){return this._brokerConnection.currentAccountType?this._brokerConnection.currentAccountType():void 0}metainfo(){return this._brokerMetainfo}brokerPlan(){return this._brokerPlan}bro(){return this._brokerConnection}fireSubscription(t,e,i,r){if(void 0===this._lastFireResult[e]&&(this._lastFireResult[e]={Realtime:null,PL:null,Equity:null,DOM:null,TradePL:null,PipValue:null,MarginAvailable:null,CryptoBalance:null}),(0,d.ensure)(this._lastFireResult[e])[t]={data:i,time:Date.now()},void 0===this._subscriptions[e])return;const s=(0,d.ensure)(this._subscriptions[e]);(0,d.ensure)(s[t]).forEach((t=>t(e,i,r)))}positions(t){return this.config.supportPositions?(this._makeSureBrokerIsConnected(),this._positions().then((e=>e.filter((e=>void 0===t||e.symbol===t))))):Promise.resolve([])}disconnectWarningMessage(){
return this._brokerConnection.disconnectWarningMessage?this._brokerConnection.disconnectWarningMessage():null}connectWarningMessage(){return this._brokerConnection.connectWarningMessage?this._brokerConnection.connectWarningMessage():null}trades(t){return this._makeSureBrokerIsConnected(),(0,d.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),this._trades().then((e=>e.filter((e=>void 0===t||e.symbol===t))))}positionById(t){return this._brokerConnection.positionById?this._brokerConnection.positionById(t):this.positions().then((e=>e.find((e=>e.id===t))))}tradeById(t){return(0,d.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),this.trades().then((e=>e.find((e=>e.id===t))))}orders(t){return this._makeSureBrokerIsConnected(),this._orders().then((e=>e.filter((e=>void 0===t||e.symbol===t))))}ordersHistory(){return this._makeSureBrokerIsConnected(),this.config.supportOrdersHistory&&this._brokerConnection.ordersHistory?this._brokerConnection.ordersHistory():Promise.resolve([])}async executions(t){return this.config.supportExecutions?(this._makeSureBrokerIsConnected(),this._brokerConnection.executions(t)):[]}async allExecutions(){return void 0===this._brokerConnection.allExecutions?[]:this._brokerConnection.allExecutions()}orderById(t){return this._makeSureBrokerIsConnected(),this._brokerConnection.orders().then((e=>e.find((e=>e.id===t))))}accountManagerInfo(){return this._brokerConnection.accountManagerInfo()}isTradable(t){return this._makeSureBrokerIsConnected(),this._brokerConnection.isTradable(t).then((e=>("object"!=typeof e&&(e={tradable:e}),e.tradable||void 0!==e.reason||(e.reason=(0,v.makeNonTradableSymbolText)((0,f.htmlEscape)(t),this._brokerMetainfo.title)),e)))}formatter(t,e=!0){return this._makeSureBrokerIsConnected(),this._formattersCache[t]||(this._formattersCache[t]=this._brokerConnection.formatter&&this._brokerConnection.formatter(t,e)||this._host.defaultFormatter(t,e)),(0,p.makeTimeLimited)(this._formattersCache[t],1e4,"formatter not received")}spreadFormatter(t){return this._makeSureBrokerIsConnected(),this._spreadFormattersCache[t]||(this._spreadFormattersCache[t]=this._brokerConnection.spreadFormatter&&this._brokerConnection.spreadFormatter(t)||this._host.defaultFormatter(t,!1)),(0,p.makeTimeLimited)(this._spreadFormattersCache[t],1e4,"spreadFormatter not received")}quantityFormatter(t){return this._makeSureBrokerIsConnected(),this._quantityFormattersCache[t]||(this._quantityFormattersCache[t]=this._brokerConnection.quantityFormatter&&this._brokerConnection.quantityFormatter(t)||this._host.quantityFormatter()),(0,p.makeTimeLimited)(this._quantityFormattersCache[t],1e4,"quantityFormatter not received")}async createInitialPreOrder(t){return this._createInitialPreOrder(t)}async createPlaceOrderContext(t,e=!0){const[i,r,s,o]=await Promise.all([this.symbolInfo(t.symbol),this.formatter(t.symbol),this.quotesSnapshot(t.symbol),this.getOrderDialogOptions(t.symbol)]),{configFlags:n}=this.metainfo(),a=(0,Q.extractTakeProfitValidationRules)(this,t.symbol),l=(0,
Q.extractStopLossValidationRules)(this,t.symbol),c=new F({orderData:t,instrumentInfo:i,quotes:s,configFlags:n,formatter:r,isValidationEnabled:e,orderDialogOptions:o,tpValidationRules:a,slValidationRules:l,callbacks:{createInitialPreOrder:t=>this._createInitialPreOrder(t),placeOrder:(t,e)=>this._placeOrder(t,e),previewOrder:t=>this._previewOrder(t)}});return await c.onReady(),c}async createEditOrderContext(t){const e=new W({orderData:t,callbacks:{modifyOrder:this._modifyOrder.bind(this),metainfo:this.metainfo.bind(this),symbolInfo:this.symbolInfo.bind(this),orderById:this.orderById.bind(this)}});return await e.onReady(),e}placeOrder(t,e){return this._placeOrder(t,e)}previewOrder(t){return this._previewOrder(t)}modifyOrder(t,e){return this._modifyOrder(t,e)}cancelOrder(t){return H(t),this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.cancelOrder(t),!0,r.t(null,void 0,i(915926)))}cancelOrders(t,e,s){return this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.cancelOrders(t,e,s),!0,r.t(null,void 0,i(305140)))}async closePosition(t,e){let i;H(t),this._makeSureBrokerIsConnected(),(0,d.assert)(void 0===e||!!this.config.supportPartialClosePosition,"Broker doesn`t support partial position closing");const r=new Promise((async(r,s)=>{try{const s=await this._positionCopyById(t);i=t=>{void 0!==s&&t.id===s.id&&t.symbol===s.symbol&&t.qty!==s.qty&&(this.positionUpdate.unsubscribe(this,i),r(!0))},this.positionUpdate.subscribe(this,i),await this._closePosition(t,e)}catch(t){s(t)}}));return(0,p.makeTimeLimited)(r,3e4,"Position closing timeout").catch((t=>(this._brokerLogger.logError(`${j}: ${(0,v.getLoggerMessage)(t)}`),this.positionUpdate.unsubscribe(this,i),!1)))}async closeTrade(t,e){var s;H(t),this._makeSureBrokerIsConnected(),(0,d.assert)(!!this.config.supportTrades,"Broker doesn`t support trades"),(0,d.assert)(void 0===e||null!==(s=this.config.supportPartialCloseTrade)&&void 0!==s&&s,"Broker doesn`t support partial position closing");const o=(0,d.ensureDefined)(await this.tradeById(t));if(0===o.qty)return this._host.showNotification(r.t(null,void 0,i(791401)),r.t(null,void 0,i(715842)),0),!1;if(void 0===e||e<=Math.abs(o.qty)){if(this._brokerConnection.closeTrade){const i=C(null!=e?e:Math.abs(o.qty),o);return this.processErrors(this._brokerConnection.closeTrade(t,e),!0,j,(()=>(0,d.ensureNotNull)(this._tradingStat).trackOrderPlaced(i)))}throw new Error("Method closeTrade is not implemented")}return this._host.showNotification(r.t(null,void 0,i(791401)),r.t(null,void 0,i(365389)),0),!1}reversePosition(t){if(H(t),this._makeSureBrokerIsConnected(),this.config.supportMultiposition&&!this.config.supportNativeReversePosition)throw new Error("Cannot reverse position on multiposition account");let e;const i=new Promise((async(i,r)=>{try{const r=await this._positionCopyById(t);e=t=>{void 0!==r&&t.symbol===r.symbol&&t.side!==r.side&&(this.positionUpdate.unsubscribe(this,e),i(!0))},this.positionUpdate.subscribe(this,e),await this._reversePosition(t)}catch(t){r(t)}}));return(0,
p.makeTimeLimited)(i,3e4,"Position reversing timeout").catch((t=>(this._brokerLogger.logError(`${z}: ${(0,v.getLoggerMessage)(t)}`),this.positionUpdate.unsubscribe(this,e),!1)))}editPositionBrackets(t,e,s){if(this._makeSureBrokerIsConnected(),this._brokerConnection.editPositionBrackets)return this.processErrors(this._brokerConnection.editPositionBrackets(t,e,s),!0,r.t(null,void 0,i(140766)));throw new Error("Method editPositionBrackets is not implemented")}editTradeBrackets(t,e){if(this._makeSureBrokerIsConnected(),(0,d.assert)(!!this.config.supportTradeBrackets,"Broker doesn`t support brackets on trades"),this._brokerConnection.editTradeBrackets)return this.processErrors(this._brokerConnection.editTradeBrackets(t,e),!0,r.t(null,void 0,i(140766)));throw new Error("Method editTradeBrackets is not implemented")}async subscribeRealtime(t,e){this._makeSureBrokerIsConnected();const i={symbol:t,listener:e,provider:0};this._realtimeSubscriptionState.push(i);const r=await this.symbolInfo(t),s=this._realtimeSubscriptionState.findIndex((i=>i.symbol===t&&i.listener===e));if(-1!==s)return void 0!==r.hasQuotes&&!1===r.hasQuotes?(this._realtimeSubscriptionState[s].provider=1,(0,d.ensure)(this._brokerRealtimeAdapter).subscribeRealtime(t,e)):(this._realtimeSubscriptionState[s].provider=2,this._addSubscription("Realtime",t,e))}async quotesSnapshot(t){let e,i;const r=(t,s)=>{i=s,(s.ask||s.bid)&&(this.unsubscribeRealtime(t,r),null==e||e(s))},s=new Promise((i=>{e=i,this.subscribeRealtime(t,r)}));try{return await(0,p.makeTimeLimited)(s,1e4,"quotesSnapshot not received")}catch(e){if(this.unsubscribeRealtime(t,r),void 0!==i)return i;throw e}}subscribeDOM(t,e){return this._makeSureBrokerIsConnected(),this._addSubscription("DOM",t,e)}subscribePipValue(t,e){return this._makeSureBrokerIsConnected(),this._addSubscription("PipValue",t,e)}subscribePL(t,e){this._makeSureBrokerIsConnected(),this._addSubscription("PL",t,e)}subscribeTradePL(t,e){return this._makeSureBrokerIsConnected(),this._addSubscription("TradePL",t,e)}subscribeCryptoBalance(t,e){return this._makeSureBrokerIsConnected(),this._addSubscription("CryptoBalance",t,e)}subscribeEquity(t){return this._makeSureBrokerIsConnected(),this._addSubscription("Equity","Equity",t)}subscribeMarginAvailable(t){return this._makeSureBrokerIsConnected(),this._addSubscription("MarginAvailable","MarginAvailable",t)}unsubscribeRealtime(t,e){const i=this._realtimeSubscriptionState.findIndex((i=>i.symbol===t&&i.listener===e));-1!==i&&(1===this._realtimeSubscriptionState[i].provider?(0,d.ensure)(this._brokerRealtimeAdapter).unsubscribeRealtime(t,e):this._removeSubscription("Realtime",t,e),this._realtimeSubscriptionState.splice(i,1))}unsubscribeDOM(t,e){this._removeSubscription("DOM",t,e)}unsubscribePipValue(t,e){this._removeSubscription("PipValue",t,e)}unsubscribePL(t,e){this._removeSubscription("PL",t,e)}unsubscribeTradePL(t,e){this._removeSubscription("TradePL",t,e)}unsubscribeCryptoBalance(t,e){this._removeSubscription("CryptoBalance",t,e)}unsubscribeEquity(t){this._removeSubscription("Equity","Equity",t)}
unsubscribeMarginAvailable(t){this._removeSubscription("MarginAvailable","MarginAvailable",t)}async accountMetainfo(){const t=await this.accountsMetainfo(),e=this.currentAccount(),i=t.find((t=>t.id===e));if(void 0===i)throw new Error("accountMetainfo not received");return i}accountsMetainfo(){return(0,p.makeTimeLimited)(this._brokerConnection.accountsMetainfo(),1e4,"accountsMetainfo not received")}setCurrentAccount(t){if(void 0===this._brokerConnection.setCurrentAccount)throw new Error(`${this._brokerMetainfo.title} doesn't support sub-accounts`);this._brokerConnection.setCurrentAccount(t)}symbolInfo(t){return(0,p.makeTimeLimited)(this._brokerConnection.symbolInfo(t),1e4,"symbolInfo not received")}async getPositionCurrency(t){try{const e=await this._brokerConnection.symbolInfo(t);if(this._brokerMetainfo.configFlags.positionPLInInstrumentCurrency&&void 0!==e.currency)return e.currency;const i=await this.accountMetainfo();return(0,S.getCurrency)(i,!0)}catch(t){return void $.logError(t)}}sessionId(){return this._sessionId}bugReportInfo(){function t(t){return JSON.parse(JSON.stringify(t))}function e(t){if("object"!=typeof t)return t;if((0,a.isArray)(t))return t.map(e);const i={};for(const e in t)"object"!=typeof t[e]&&(i[e]=t[e]);return i}return Promise.all([this.orders(),this.positions(),this.config.supportTrades?this.trades():Promise.resolve([])]).then((i=>({activeBroker:this.metainfo().title,orders:e(t(i[0])),positions:e(t(i[1])),trades:e(t(i[2])),silentOrdersPlacement:this._host.silentOrdersPlacement().value(),floatingPanel:(0,d.ensureNotNull)(this._host.sellBuyButtonsVisibility()).value(),account:this.currentAccount(),accountType:this.currentAccountType(),lastUpdates:this._lastFireResult,time:Date.now(),brokerSpecific:this._brokerConnection.bugReportInfo?this._brokerConnection.bugReportInfo():null,sessionId:this._sessionId})))}processErrors(t,e,s,l){if(!(0,a.isPromise)(t))throw new Error("Broker incorrectly implements API, should return Promise");return t.then((t=>l&&l(t))).then((t=>"boolean"!=typeof t||t)).catch((t=>{if((0,o.isAbortError)((0,v.getErrorCauses)(t)[0]))return Promise.resolve(!1);let a="";return"string"==typeof t?a=t:"object"==typeof t&&"string"==typeof t.message&&(a=(0,f.removeTags)(t.message)),e&&n.enabled("trading_notifications")?(0!==a.length&&("."!==a.slice(-1)&&(a+="."),a+=" "),a+=r.t(null,void 0,i(352303)),this._host.showNotification(s||"",a,0)):$.logWarn(t),Promise.resolve(!1)})).then((t=>(this.tradingOperationFinished.fire(t),t)))}setDurations(t){this._brokerMetainfo.durations=t.slice()}setSymbolSearchId(t){this._brokerMetainfo.backendBrokerName=t}getRealtimeDataCheckParams(){return this._brokerConnection.getRealtimeDataCheckParams?this._brokerConnection.getRealtimeDataCheckParams():{}}getVerifyLiveAccountParams(){if(void 0===this._brokerConnection.getVerifyLiveAccountParams)throw new Error(`Method getVerifyLiveAccountParams for broker ${this._brokerMetainfo.id} is not implemented`);return this._brokerConnection.getVerifyLiveAccountParams()}unhideSymbolSearchGroups(){
return this._brokerConnection.unhideSymbolSearchGroups?this._brokerConnection.unhideSymbolSearchGroups():[]}destroy(){void 0!==this._brokerConnection.destroy&&this._brokerConnection.destroy()}currentBroker(){return this._brokerMetainfo.id}async _createInitialPreOrder(t){var e,i,r;if(void 0===t.duration){const{allowedDurations:s}=await this.symbolInfo(t.symbol),{durations:o}=this.metainfo(),n=(0,S.getOrderDuration)({orderDuration:void 0,orderType:t.type,savedDuration:null!==(r=null===(i=null===(e=this._getTradingSettingsStorage)||void 0===e?void 0:e.call(this))||void 0===i?void 0:i.duration(t.symbol,t.type))&&void 0!==r?r:null,orderDurations:o,symbolDurations:s});null!==n&&(t.duration=n)}if(void 0===t.customFields){const e=await this._getSavedCustomFields(t.symbol,t.type);void 0!==e&&(t.customFields=e)}return t}async _getSavedCustomFields(t,e){var i,r;const s=await this.getOrderDialogOptions(t),o=null!==(r=null===(i=this._getTradingSettingsStorage)||void 0===i?void 0:i.call(this))&&void 0!==r?r:void 0;if(void 0===o||void 0===(null==s?void 0:s.customFields)||0===s.customFields.length)return;const n=s.customFields.map((t=>t.id)),a=o.customFields(t,e,n),l=(0,S.adjustSavedCustomFieldsValues)(a,s);return 0!==Object.keys(l).length?l:void 0}_placeOrder(t,e){return this._makeSureBrokerIsConnected(),this.processErrors(this._brokerConnection.placeOrder(t,e),!0,r.t(null,void 0,i(842180)),(e=>{(0,d.ensureNotNull)(this._tradingStat).trackOrderPlaced({...t,id:e.orderId}),this._host.trackEvent("","SilentMode",this._host.silentOrdersPlacement().value()?"On":"Off")}))}async _modifyOrder(t,e){this._makeSureBrokerIsConnected();const s=new Set((await this._orders()).map((({id:t})=>t)));s.delete(t.id);return await this.processErrors(this._brokerConnection.modifyOrder(t,e),!0,r.t(null,void 0,i(54746)),(()=>(0,d.ensureNotNull)(this._tradingStat).trackOrderModified(t)))&&this._waitForOrderModification(t,s)}_previewOrder(t){if(!this._brokerConnection.previewOrder)throw new Error("Order preview is not supported");return this._brokerConnection.previewOrder(t)}_initializeConnectProtection(){let t=null;this.connectionStatusUpdate.subscribe(null,(e=>{if(t&&(clearTimeout(t),t=null),2===e){const e=(0,S.isOAuthAuthType)(this.config.authorizationType)?3e5:6e4;t=setTimeout((()=>{this._host.selectBroker(),this._host.showNotification(r.t(null,void 0,i(170891)),r.t(null,void 0,i(247956)))}),e)}}))}_fakeSubscribeDOM(t){this._fakeDOMSubscriptions[t]=(t,e)=>{const i=e.ask||e.trade,r=e.bid||e.trade,s={snapshot:!0,asks:i?[{price:i,volume:e.ask_size||1/0}]:[],bids:r?[{price:r,volume:e.bid_size||1/0}]:[]};this._host.domUpdate(t,s)},this.subscribeRealtime(t,this._fakeDOMSubscriptions[t])}_fakeUnsubscribeDOM(t){this.unsubscribeRealtime(t,this._fakeDOMSubscriptions[t])}_isMaintenance(){return isFeatureEnabled((0,S.makeMaintananceFeatureToggleName)(this._brokerMetainfo.id))}_isBrokerSideMaintenance(){return isFeatureEnabled((0,S.makeBrokerSideMaintananceFeatureToggleName)(this._brokerMetainfo.id))}async _positionCopyById(t){const e=await this.positionById(t)
;return void 0!==e?(0,s.default)(e):void 0}_patchBrokerSubscribeUnsubscribeDOMMethods(){const t=!this._brokerMetainfo.configFlags.supportLevel2Data;this._brokerConnection.subscribeDOM=t?t=>{this._fakeSubscribeDOM(t)}:this._originalDOMSubscriptionMethods.subscribeDOM,this._brokerConnection.unsubscribeDOM=t?t=>{this._fakeUnsubscribeDOM(t)}:this._originalDOMSubscriptionMethods.unsubscribeDOM}_patchMetainfo(t){const e=(0,k.deepCopy)(t);return e.configFlags.supportNativeReversePosition=!this.config.supportMultiposition||this.config.supportNativeReversePosition,e.configFlags.supportClosePosition=!0,e.configFlags.supportPLUpdate=!0,e}_addSubscription(t,e,i){this._pendingSubscriptions.push({brokerMethodName:t,symbol:e,listener:i});const r=this._lastFireResult[e];if(void 0!==r&&void 0!==r[t]&&null!==r[t]&&i(e,r[t].data),!this._removePendingSubscription({brokerMethodName:t,symbol:e,listener:i}))return;void 0===this._subscriptions[e]&&(this._subscriptions[e]={Realtime:[],PL:[],Equity:[],DOM:[],TradePL:[],PipValue:[],MarginAvailable:[],CryptoBalance:[]});const s=(0,d.ensure)(this._subscriptions[e]),o=s[t].length>0;if(s[t].push(i),!o&&(s[t].length>0||"CryptoBalance"===t)){const i="subscribe"+t;this._brokerConnection[i]&&this._brokerConnection[i](e)}}_removePendingSubscription(t){const e=this._pendingSubscriptions.findIndex((e=>e.symbol===t.symbol&&e.brokerMethodName===t.brokerMethodName&&e.listener===t.listener));return-1!==e&&(this._pendingSubscriptions.splice(e,1),!0)}_removeSubscription(t,e,i){if(this._removePendingSubscription({brokerMethodName:t,symbol:e,listener:i}))return;if(void 0===this._subscriptions[e])return;const r=(0,d.ensure)(this._subscriptions[e]),s=r[t].indexOf(i);if(s>-1&&r[t].splice(s,1),0===r[t].length){const i="unsubscribe"+t;this._brokerConnection[i]&&this._brokerConnection[i](e)}}_positions(){return this._positionsCache?this._positionsCache.getObjects():Promise.resolve([])}_trades(){return this._tradesCache?this._tradesCache.getObjects():Promise.resolve([])}_orders(){return this._ordersCache.getObjects()}_makeSureBrokerIsConnected(){(0,d.assert)(1===this.connectionStatus(),"Broker is not connected")}_placeReversePositionOrder(t){const e=C(2*t.qty,t);return this._placeOrder(e)}async _closePosition(t,e){const s=(0,d.ensureDefined)(await this.positionById(t));if(!(0,S.checkIsExistingPosition)(s)){const t=r.t(null,void 0,i(715842));throw this._host.showNotification(j,t,0),new Error(t)}if(void 0===e||e<=Math.abs(s.qty)){const i=C(null!=e?e:Math.abs(s.qty),s);return this.config.supportClosePosition&&this._brokerConnection.closePosition?void await this.processErrors(this._brokerConnection.closePosition(t,e),!0,j,(()=>(0,d.ensureNotNull)(this._tradingStat).trackOrderPlaced(i))):void await this.processErrors(this._brokerConnection.placeOrder(i),!0,j,(()=>(0,d.ensureNotNull)(this._tradingStat).trackOrderPlaced(i)))}{const t=r.t(null,void 0,i(365389));throw this._host.showNotification(j,t,0),new Error(t)}}async _reversePosition(t){const e=(0,d.ensureDefined)(await this.positionById(t));if(0===e.qty){
const t=r.t(null,void 0,i(726500));throw this._host.showNotification(z,t,0),new Error(t)}this.config.supportNativeReversePosition&&this._brokerConnection.reversePosition?await this.processErrors(this._brokerConnection.reversePosition(t),!0,z):await this.processErrors(this._placeReversePositionOrder(e),!0,z,(()=>(0,d.ensureNotNull)(this._tradingStat).trackOrderPlaced()))}async _waitForOrderModification(t,e){return new Promise((async i=>{const r=()=>{i(!0),o(),clearTimeout(n)},s=e=>{K(e,t)&&r()},o=()=>this.orderUpdate.unsubscribe(this,s),n=setTimeout((()=>{i(!1),this._brokerLogger.logError("Failed to modify order: timeout waiting for new order"),o()}),3e4);this.orderUpdate.subscribe(this,s);for(const i of await this._orders())if(!e.has(i.id)&&K(t,i))return void r()}))}}var Z=i(960521),J=i(870122),X=i.n(J),Y=i(588517),tt=i.n(Y),et=i(673317),it=i(424030),rt=i(803966),st=i(382563),ot=i(815628),nt=i(153055),at=i(156115),lt=i(252546),ct=i(120283),dt=i(314996),ut=i(66786);class ht{constructor(t,e,i,r){this._lastPL=0,this._isActive=!1,this._realtimeUpdate=(t,e)=>{this._realtimeData=e,this._updatePL()},this._symbol=t.symbol,this._adapter=i,this._onPlUpdate=e,this._side=t.side,this._qty=t.qty,this._avgPrice=t.avgPrice,this._instrumentInfo=r,this.positionUpdate(t)}positionUpdate(t){this._avgPrice=t.avgPrice,this._qty=t.qty,this._side=t.side,this._updatePL()}lastPL(){return this._lastPL}start(){this._isActive||(this._adapter.subscribeRealtime(this._symbol,this._realtimeUpdate),this._isActive=!0)}stop(){this._isActive&&(this._adapter.unsubscribeRealtime(this._symbol,this._realtimeUpdate),this._isActive=!1)}_updatePL(){var t;if(!this._realtimeData||void 0===this._realtimeData.bid||void 0===this._realtimeData.ask)return;const e=Number(new Z.Big(1===this._side?this._realtimeData.bid:this._realtimeData.ask).minus(Math.abs(this._avgPrice)).mul(1===this._side?1:-1).mul(this._qty).mul(null!==(t=this._instrumentInfo.lotSize)&&void 0!==t?t:1).div(this._instrumentInfo.pipSize).mul(this._instrumentInfo.pipValue));this._lastPL=e,this._onPlUpdate(e)}}new Set(["type","typespecs","pricescale","minmov","fractional"]);function pt(t,e){return(0,st.getQuoteSessionInstance)("full").snapshot(t)}function _t(t){return"error"===t.status}class gt{constructor(t,e,i,r){var s;this._setDefaultDropdownActionsBound=this._setDefaultDropdownActions.bind(this),this.serverLogger=()=>this._serverLogger,this.createMapperAsync=(t,e)=>({tvToBroker:async t=>t,brokerToTv:async t=>t}),this.createMapperSync=(t,e)=>{let i=null;{const t=Promise.resolve();i={ready:()=>t,tvToBroker:t=>t,brokerToTv:t=>t}}return i},this._trading=t,this._metainfo=e,this._serverLogger=null!==i?this._makeServerLoggerWithFilledInfo(i):null,this._setDefaultDropdownActionsBound=this._setDefaultDropdownActions.bind(this),this._defaultDropdownActions=!0,this._credentialsStorage=r,this._setDefaultDropdownActions(),null!==this._trading&&(null===(s=this.sellBuyButtonsVisibility())||void 0===s||s.subscribe(this._setDefaultDropdownActionsBound),(0,
d.ensureNotNull)(this.orderPanelVisibility()).subscribe(this._setDefaultDropdownActionsBound),(0,d.ensureNotNull)(this.domPanelVisibility()).subscribe(this._setDefaultDropdownActionsBound))}createPLEmitter(t,e,i){return new ht(t,e,this._adapter,i)}getLogger(){return(0,h.getLogger)("Trading."+this._metainfo.id)}translate(t){return t}setBrokerConnectionAdapter(t){this._adapter=t}patchConfig(t){this._adapter.patchConfig(t)}showOrderDialog(t,e){return(0,d.ensureNotNull)(this._trading).orderViewController().showOrderView({order:t,focus:e})}showPositionBracketsDialog(t,e,i){return(0,d.ensureNotNull)(this._trading).orderViewController().showPositionView(t,e,i)}showCancelOrderDialog(t,e){return ct.ConfirmOrderCancelDialog.get().open(t).then((t=>{t&&this._adapter.processErrors(e(),!0,r.t(null,void 0,i(915926)))}))}showCancelMultipleOrdersDialog(t,e,s,o){return ct.ConfirmOrderCancelDialog.get().multiple(t,e,s).then((t=>{t&&this._adapter.processErrors(o(),!0,r.t(null,void 0,i(305140)))}))}showCancelBracketsDialog(t,e){return dt.ConfirmBracketsCancelDialog.get().open(t).then((t=>{t&&this._adapter.processErrors(e(),!0,r.t(null,void 0,i(951099)))}))}showCancelMultipleBracketsDialog(t,e){return dt.ConfirmBracketsCancelDialog.get().multiple(t).then((t=>{t&&this._adapter.processErrors(e(),!0,r.t(null,void 0,i(951099)))}))}showReversePositionDialog(t,e){return(0,ut.reversePositionDialog)(t,(0,d.ensureNotNull)(this._trading).showErrorNotification,e)}showMessageDialog(t,e,i=!1){i?(0,nt.showWarning)({title:t,html:e}):(0,nt.showWarning)({title:t,text:e})}showConfirmDialog(t,e,i,r,s){return(0,at.showConfirmDialog)({title:t,content:e,mainButtonText:i,cancelButtonText:r,showDisableConfirmationsCheckbox:s})}showSimpleConfirmDialog(t,e,i,r,s){return(0,lt.showSimpleConfirmDialog)({title:t,text:Array.isArray(e)?e.join(" "):e,mainButtonText:i,mainButtonIntent:"primary",cancelButtonText:r,showDisableConfirmationsCheckbox:s})}showSimpleConfirmDialogAndRespectAbort(t,e,i,r,s,o){return(0,lt.showSimpleConfirmDialog)({title:t,text:Array.isArray(e)?e.join(" "):e,abortSignal:i,mainButtonText:r,mainButtonIntent:"primary",cancelButtonText:s,showDisableConfirmationsCheckbox:o})}setDurations(t){this._adapter.setDurations(t)}setSymbolSearchId(t){this._adapter.setSymbolSearchId(t)}activateBottomWidget(){return null!==this._trading?this._trading.toggleTradingWidget():Promise.reject("Activate bottom widget failed: trading is not defined")}trackEvent(t,e,i){null!==this._trading&&this._trading.trackEvent(t,e,i)}defaultFormatter(t,e){return(0,st.getQuoteSessionInstance)("simple").formatter(t,e)}numericFormatter(t){return Promise.resolve(new it.NumericFormatter(t))}quantityFormatter(t){return Promise.resolve(new rt.QuantityFormatter(t))}selectBroker(){null!==this._trading&&this._trading.selectBroker(null)}showTradingProperties(){null!==this._trading&&this._trading.showTradingProperties()}async getSymbolTypespecs(t){var e;const i=await pt(t);return"values"in i?_t(i)||void 0===i.values.typespecs?[]:i.values.typespecs:null!==(e=i.typespecs)&&void 0!==e?e:[]}
async getSymbolType(t){var e;const i=await pt(t);return"values"in i?_t(i)?"undefined":i.values.type:null!==(e=i.type)&&void 0!==e?e:"undefined"}async getSymbolMinTick(t){const e=await pt(t);return"values"in e?_t(e)||void 0===e.values.minmov||void 0===e.values.pricescale?1:(0,Z.Big)(e.values.minmov).div(e.values.pricescale).toNumber():(0,Z.Big)(e.minmov).div(e.pricescale).toNumber()}silentOrdersPlacement(){return(0,d.ensureNotNull)(this._trading).noConfirmEnabled}sellBuyButtonsVisibility(){return null!==this._trading&&n.enabled("buy_sell_buttons")?this._trading.showSellBuyButtons:null}domPanelVisibility(){return null!==this._trading?this._trading.domPanelVisibility():null}orderPanelVisibility(){return null!==this._trading?this._trading.orderPanelVisibility():null}showPricesWithZeroVolume(){return(0,d.ensureNotNull)(this._trading).showPricesWith().zeroVolume}showNotification(t,e,i=0){null!==this._trading&&(0===i?this._trading.showErrorNotification(t,e):this._trading.showSuccessNotification(t,e))}connectionStatusUpdate(t,e){this._adapter.connectionStatusUpdate.fire(t,e),1===t&&this._setDefaultDropdownActions()}orderUpdate(t){this._adapter.onOrderUpdate(t)}positionUpdate(t,e){this._adapter.onPositionUpdate(t,e)}tradeUpdate(t,e){this._adapter.onTradeUpdate(t,e)}orderPartialUpdate(t,e){this._adapter.onOrderPartialUpdate(t,e)}positionPartialUpdate(t,e){this._adapter.onPositionPartialUpdate(t,e)}tradePartialUpdate(t,e){this._adapter.onTradePartialUpdate(t,e)}executionUpdate(t){this._adapter.executionUpdate.fire(t)}currentAccountUpdate(){this._adapter.onCurrentAccountChanged()}realtimeUpdate(t,e){this._adapter.fireSubscription("Realtime",t,e)}domUpdate(t,e){this._adapter.fireSubscription("DOM",t,e)}pipValueUpdate(t,e){this._adapter.fireSubscription("PipValue",t,e)}plUpdate(t,e){this._adapter.fireSubscription("PL",t,e)}tradePLUpdate(t,e){this._adapter.fireSubscription("TradePL",t,e)}equityUpdate(t){this._adapter.fireSubscription("Equity","Equity",t)}marginAvailableUpdate(t){this._adapter.fireSubscription("MarginAvailable","MarginAvailable",t)}cryptoBalanceUpdate(t,e){this._adapter.fireSubscription("CryptoBalance",t,e)}setButtonDropdownActions(t){var e;null!==this._trading&&this._defaultDropdownActions&&(this._defaultDropdownActions=!1,null===(e=this.sellBuyButtonsVisibility())||void 0===e||e.unsubscribe(this._setDefaultDropdownActionsBound),(0,d.ensureNotNull)(this.orderPanelVisibility()).unsubscribe(this._setDefaultDropdownActionsBound),(0,d.ensureNotNull)(this.domPanelVisibility()).unsubscribe(this._setDefaultDropdownActionsBound)),this._buttonDropdownActions=t}buttonDropdownActions(){return this._buttonDropdownActions}defaultContextMenuActions(...t){return null!==this._trading?this._trading.defaultContextMenuActions(...t):Promise.resolve([])}defaultDropdownMenuActions(t){return null!==this._trading?this._trading.defaultDropdownMenuActions(t):[]}get factory(){return{createDelegate:()=>new(c()),createWatchedValue:t=>new(tt())(t),createPriceFormatter:(t,e,i,r,s)=>new ot.PriceFormatter(t,e,i,r,s)}}get settings(){return{
save:(t,e)=>X().setJSON(`${this._metainfo.id}.${t}`,e),load:(t,e)=>X().getJSON(`${this._metainfo.id}.${t}`,e),clear:(t,e)=>X().remove(`${this._metainfo.id}.${t}`,e)}}get credentialsStorage(){return this._credentialsStorage}convertTimezone(t,e,i){const r=et.get_timezone(e),s=et.get_timezone(i),o=et.cal_to_utc(r,t);return et.utc_to_cal(s,o)}language(){return window.language}getUserSpecificHash(){return window.user.private_channel||""}activateFXCMCFD(){X().setValue("fxcm_cfd",!0)}async isFractional(t){var e;const i=await pt(t);return"values"in i?!_t(i)&&void 0!==i.values.fractional&&i.values.fractional:null!==(e=i.fractional)&&void 0!==e&&e}_makeServerLoggerWithFilledInfo(t){return{log:e=>t.log({...this._makeServerLoggerEventAdditionalInfo(),...e}),debounceLog:(e,i,r)=>t.debounceLog({...this._makeServerLoggerEventAdditionalInfo(),...e},i,r)}}_makeServerLoggerEventAdditionalInfo(){return{accountType:this._adapter.currentAccountType(),brokerId:this._adapter.metainfo().id,sessionId:this._adapter.sessionId(),tvUsername:window.user.username,ref:location.href,online:navigator.onLine}}_setDefaultDropdownActions(){null!==this._trading&&this._defaultDropdownActions&&(this._buttonDropdownActions=this.defaultDropdownMenuActions())}}var mt=i(340794);const bt=(0,h.getLogger)("Trading.EncryptedWebStorage");class yt{constructor({prefix:t,storageName:e,storage:i,cryptographer:r}){this._transientStorage={},this._handleStorageStateChange=t=>{const{key:e,storageArea:i}=t;i===this._persistentStorage&&this._storageName===e&&this._decryptStorage()},this._storageName=e,this._prefix=null==t?void 0:t.toLowerCase(),this._persistentStorage=i,this._cryptographer=r,this._decryptStorage=(0,mt.sequentialize)(this._decryptStorage),window.addEventListener("storage",this._handleStorageStateChange)}async setItem(t,e){const i=this._addPrefix(t);this._transientStorage[i]=JSON.stringify(e);try{await this._encryptStorageAndSave()}catch(t){bt.logError(`Unable to save value using key ${i}: ${(0,v.getLoggerMessage)(t)}`)}}getItem(t,e=null){const i=this._transientStorage[this._addPrefix(t)];if(void 0===i)return e;if("string"!=typeof i)return i;try{return JSON.parse(i)}catch(t){return i}}async removeItem(t){delete this._transientStorage[this._addPrefix(t)],await this._encryptStorageAndSave()}destroy(){window.removeEventListener("storage",this._handleStorageStateChange)}static async create(t,e,i,r){const s=new yt({prefix:t,storageName:e,storage:i,cryptographer:r});return await s._decryptStorage(),s}_addPrefix(t){return void 0!==this._prefix?`${this._prefix}.${t}`:t}async _decryptStorage(){const t=this._persistentStorage.getItem(this._storageName);if(null===t)return void(this._transientStorage={});const e=await this._cryptographer.decrypt(t);if(null===e)return this._persistentStorage.removeItem(this._storageName),void(this._transientStorage={});try{this._transientStorage=JSON.parse(e)}catch(t){this._transientStorage={}}}async _encryptStorageAndSave(){const t=await this._cryptographer.encrypt(JSON.stringify(this._transientStorage))
;this._persistentStorage.setItem(this._storageName,t)}}const vt="credentials-storage";class ft{constructor(t,e,i){this._rememberCredentials=t,this._encryptedLocalStorage=e,this._encryptedSessionStorage=i}async save(t,e){this._currentEncryptedStorage().setItem(t,e)}load(t,e){return this._currentEncryptedStorage().getItem(t,e)}async clear(t){this._currentEncryptedStorage().removeItem(t)}destroy(){this._encryptedLocalStorage.destroy(),this._encryptedSessionStorage.destroy()}static async create(t,e,i){const r=await yt.create(t,vt,localStorage,i),s=await yt.create(t,vt,sessionStorage,i);return new ft(e,r,s)}_currentEncryptedStorage(){return this._rememberCredentials.value()?this._encryptedLocalStorage:this._encryptedSessionStorage}}var kt=i(34694);const Pt={isSuspended:!1,supportDemoLiveSwitcher:!0,supportModifyOrderPrice:!0,supportEditAmount:!0,supportModifyBrackets:!0,supportMarketBrackets:!0,supportMarketOrders:!0,supportStopOrders:!0,supportLimitOrders:!0,supportLeverageButton:!0,supportStopLimitOrders:!1,supportPositions:!0,supportDOM:!0,supportModifyTrailingStop:!0,supportAddBracketsToExistingOrder:!0,supportVerifyLiveAccount:!0,supportReversePosition:!0,showNotificationsLog:!0,supportPLUpdate:!0,supportTwoFactorAuthorization:!1,supportDisplayBrokerNameInSymbolSearch:!0,supportCurrencyInOrderPreview:!0,supportRiskControls:!0};class St{constructor(t){this._settingsKey=`trading.${t}.rememberCredentials`}value(){return X().getBool(this._settingsKey,!0)}setValue(t){X().setValue(this._settingsKey,t)}}const Ct=[];function wt(t,e){var i;t.configFlags=(i=t.configFlags,Object.assign({},Pt,i)),Ct.push({metainfo:t,createBrokerFunction:e})}function Bt(t){const{launchCountriesByFeatureToggle:e,metainfo:i,createBrokerFunction:r}=t;(function(t){var e;return!1;for(const i of Object.keys(t))if(isFeatureEnabled(i)&&(null===(e=t[i])||void 0===e?void 0:e.includes(window.countryCode)))return!0;return!1})(e)&&wt(i,r)}function Tt(){return Ct.map((t=>t.metainfo))}let Ot;async function Et(t,e,i,r,s){const o=Ct.filter((t=>t.metainfo.id===e))[0];let n;if(null===r){const i=await ft.create(e,new St(e),Ot),r=s=>{(null==s?void 0:s.metainfo().id)!==e&&(null==t||t.onBrokerChange.unsubscribe(null,r),i.destroy())};null==t||t.onBrokerChange.subscribe(null,r),n=i}else n=r;const a=new gt(t,o.metainfo,i,n);try{const e=await o.createBrokerFunction(a,null==t?void 0:t.brokerTelemetry),i=new kt.BrokerRealtimeAdapter(o.metainfo.id);return new G({brokerMetainfo:o.metainfo,brokerConnection:e,host:a,brokerRealtimeAdapter:i,tradingStat:t&&t.tradingStat(),tradingSettingsStorageGetter:t&&t.getBrokerTradingSettingsStorage,brokerPlan:s})}catch(t){return Promise.reject(`${e} broker creation error: ${(0,v.getLoggerMessage)(t)}`)}}Ot={encrypt:async t=>t,decrypt:async t=>t}},768819:(t,e,i)=>{"use strict";i.d(e,{DialogVisibility:()=>o});var r=i(947488),s=i(218286);class o{constructor(){this._value$=new r.BehaviorSubject({isVisible:!1}),this.value$=this._value$.asObservable().pipe((0,
s.distinctUntilChanged)(((t,e)=>t.isVisible===e.isVisible&&t.isFullScreen===e.isFullScreen)))}getValue(){return this._value$.getValue()}setValue(t){this._value$.next(t)}}},948776:(t,e,i)=>{"use strict";i.d(e,{DisabledConfirmations:()=>u});var r=i(870122),s=i.n(r),o=i(855385),n=i.n(o),a=i(322625);const l=/[0-9]+([\.,][0-9]+)*([\.,][0-9]+)?|\.[0-9]+/gm,c=/[A-Z]+/gm,d=a.settingsKeys.DISABLED_CONFIRMATIONS;class u{add(t){const e=this._getAll(),i=this._makeMessageHash(t);e.add(i),s().setJSON(d,Array.from(e))}has(t){const e=this._getAll(),i=this._makeMessageHash(t);return e.has(i)}clear(){s().remove(d)}_getAll(){return new Set(s().getJSON(d))}_makeMessageHash(t){const e=t.replace(l,"").replace(c,"");return i=n()(e),btoa(String.fromCharCode.apply(null,new Uint8Array(i)));var i}}},998018:(t,e,i)=>{"use strict";function r(t){return"string"==typeof t?t:Array.isArray(t)?t.join(""):void 0}i.d(e,{makeConfirmation:()=>r})},156115:(t,e,i)=>{"use strict";i.d(e,{showConfirmDialog:()=>n});var r=i(509806),s=i(998018),o=i(948776);async function n(t){const{title:e,content:n,mainButtonText:a,cancelButtonText:l,showDisableConfirmationsCheckbox:c,onOpen:d,onClose:u}=t,h=new o.DisabledConfirmations,p=(0,s.makeConfirmation)(n);if(c&&void 0!==p&&h.has(p))return!0;const{ConfirmDialogRenderer:_}=await Promise.all([i.e(580),i.e(8194),i.e(2191),i.e(6639),i.e(4215),i.e(3610),i.e(3717),i.e(1282),i.e(1309),i.e(3566)]).then(i.bind(i,537954)),g=new _(h),m={title:e,message:n,closeButton:null!=l?l:r.t(null,void 0,i(606255)),confirmButton:null!=a?a:r.t(null,void 0,i(879831)),showDisableConfirmationsCheckbox:c,onOpen:d,onClose:u};return(await g.open(m)).status}},252546:(t,e,i)=>{"use strict";i.d(e,{showSimpleConfirmDialog:()=>o});var r=i(148442),s=i(948776);async function o(t){const{showDisableConfirmationsCheckbox:e,text:o,onConfirm:n,onClose:a,onCancel:l,abortSignal:c}=t,d=new s.DisabledConfirmations;if(e&&d.has(o))return Promise.resolve(!0);if(null==c?void 0:c.aborted)return Promise.resolve(!1);const[{showSimpleDialog:u},{SimpleConfirmDialog:h}]=await Promise.all([Promise.all([i.e(580),i.e(8194),i.e(2191),i.e(6639),i.e(4215),i.e(3610),i.e(3717),i.e(1282),i.e(1309),i.e(3566)]).then(i.bind(i,480994)),Promise.all([i.e(580),i.e(8194),i.e(2191),i.e(6639),i.e(4215),i.e(3610),i.e(3717),i.e(1282),i.e(1309),i.e(3566)]).then(i.bind(i,210795))]);return new Promise(((e,i)=>{if(null==c?void 0:c.aborted)return void i((0,r.createAbortError)());const s=u({...t,disabledConfirmations:d,onConfirm:t=>{e(!0),void 0!==n&&n(),t.dialogClose()},onClose:()=>{e(!1),void 0!==a&&a()},onCancel:t=>{e(!1),void 0!==l&&l(t),t.dialogClose()}},h);null==c||c.addEventListener("abort",(()=>{s(),i((0,r.createAbortError)())}),{once:!0})}))}},314996:(t,e,i)=>{"use strict";i.d(e,{ConfirmBracketsCancelDialog:()=>o});var r=i(509806),s=i(252546);const o={get(){return this},open:t=>(0,s.showSimpleConfirmDialog)({title:r.t(null,void 0,i(232668)),text:r.t(null,void 0,i(289302)).replace("{orderId}",""!==t?t+" ":""),mainButtonIntent:"primary"}),multiple:t=>(0,s.showSimpleConfirmDialog)({
title:r.t(null,void 0,i(232668)),text:r.t(null,void 0,i(915610)).replace("{orderId}",""!==t?t+" ":""),mainButtonIntent:"primary"})}},120283:(t,e,i)=>{"use strict";i.d(e,{ConfirmOrderCancelDialog:()=>o});i(336379);var r=i(509806),s=i(252546);const o={get(){return this},open:t=>(0,s.showSimpleConfirmDialog)({title:r.t(null,void 0,i(709498)),text:r.t(null,void 0,i(438540)).replace("{orderId}",t),mainButtonIntent:"primary"}),multiple(t,e,o){let n=t;if(void 0!==e){n=`${n} ${1===e?r.t(null,void 0,i(864351)):r.t(null,void 0,i(807889))}`}return(0,s.showSimpleConfirmDialog)({title:r.t(null,void 0,i(709498)),text:r.t(null,void 0,i(109886)).replace("{qty}",String(o)).replace("{side}",n),mainButtonIntent:"primary"})}}},66786:(t,e,i)=>{"use strict";i.d(e,{reversePositionDialog:()=>o});var r=i(509806),s=i(252546);async function o(t,e,o,n){if(!await(0,s.showSimpleConfirmDialog)({title:r.t(null,void 0,i(172361)).replace("{positionId}",t),text:r.t(null,void 0,i(492698)).replace("{positionId}",t)+(n?" "+r.t(null,void 0,i(893827)):""),mainButtonText:r.t(null,void 0,i(920848)),mainButtonIntent:"primary",cancelButtonText:r.t(null,void 0,i(620036)),showBackdrop:!0}))return!1;try{return await o()}catch(t){return e(r.t(null,void 0,i(945593)),function(t){let e="";null!==t&&"object"==typeof t&&t.message?e=t.message:"string"==typeof t&&(e=t);return e}(t)),!1}}},529719:(t,e,i)=>{"use strict";i.d(e,{alignQuotesToMinTick:()=>O,calculatePipValue:()=>f,calculateTradeValue:()=>k,calculateTradeValueByBigPointValue:()=>P,calculateUsedMargin:()=>S,calculatedMarginRatio:()=>C,checkPriceByOrderType:()=>E,comparator:()=>b,convertToBaseMonetaryUnit:()=>A,createCustomFieldModels:()=>D,displayedLeverage:()=>v,formatInfoValue:()=>w,formatRiskReward:()=>T,formatValue:()=>N,makeSubjectFromWatchedValue:()=>m,prepareCalculatorEventText:()=>L,prepareTradableSolution:()=>I,shouldShowTotal:()=>y});var r=i(509806),s=i(688401),o=i(947488),n=i(960521),a=i(466052),l=i.n(a),c=i(588517),d=i.n(c),u=i(372605),h=i(793361),p=i(357407),_=i(600297),g=i(807107);function m(t){const e=new o.BehaviorSubject(t.value()),i=t=>{e.next(t)};return t.subscribe(i),{subject:e,unsubscribe:()=>t.unsubscribe(i)}}function b(t,e){return(0,u.deepEquals)(t,e)[0]}function y(t){return void 0!==t&&Boolean(t.showTotal)}function v(t,e){if(void 0!==t)return t;if(void 0!==e){const t=Math.round(1/e);return String(t)+":1"}return null}function f(t,e,i){return null!==t?(void 0!==i?t*i:t)*e:0}function k(t,e,i,r,s){return P(t,e,i/r,s)}function P(t,e,i,r){return t*e*i*(r||1)}function S(t,e){return void 0!==e?t*e:0}function C(t,e){const i=0!==e?100*t/e:0;return i>100?100:i}function w(t){if("number"==typeof t){const e=(0,h.splitThousands)((t||0).toFixed(2)," ");return Number.isInteger(t)||t>=1?e:function(t){if(Number.isInteger(t))return t+"";return t<1?function(t){const e=(t+"").split(".")[1]||"";let i=e.length;for(let t=0;t<e.length;t++)if("0"!==e[t]){i=t+1;break}return t.toFixed(i)}(t):t.toFixed(2)}(t)}return(0,h.splitThousands)(t," ")}const B=new p.VolumeFormatter(2);function T(t,e){
return null!==t&&null!==e&&t/e>0?B.format(t/e):""}function O(t,e,i){const r=Object.assign({},t);return["trade","ask","bid"].forEach((t=>{const s=r[t];if(void 0!==s){const o=(0,g.getMinTick)({minTick:e,price:s,variableMinTickData:i});r[t]=function(t,e){return e>1?t:(0,n.Big)(t).div(e).round(0,1).mul(e).toNumber()}(s,o)}})),r}function E(t,e,i){return 4===t?null===e||null===i:3===t?null===i:null===e}function L(t,e){switch(e){case _.ButtonType.IncDec:return t<0?"-":"+";case _.ButtonType.PlusValue:return String(t);case _.ButtonType.Clear:return"Clear";default:return"Default"}}function D(t,e,i,r,s){const o=[];return void 0!==r&&Array.isArray(r.customFields)&&r.customFields.forEach((r=>{if("TextWithCheckBox"===r.inputType){const t=new(d())(r.value.text),i=new(d())(!0),s=new(d()),n=r.validator,a=t=>{const e=void 0===n?{valid:!0}:n(t);i.setValue(e.valid),s.setValue(e.valid?void 0:e.errorMessage)};void 0!==n&&t.subscribe(a),o.push({id:r.id,type:r.inputType,inputType:r.customInfo.asterix?"password":"text",placeholder:r.placeHolder||"",title:r.title||"",checkboxTitle:r.customInfo.checkboxTitle,text:t,checked:new(d())(r.value.checked),status:e,onControlFocused:new(l()),isValid:i,errorMessage:s,destroy:()=>{t.unsubscribe(a)}})}if("Checkbox"===r.inputType){let i;const n=null==s?void 0:s[r.id];try{i=JSON.parse(n)}catch(t){i=n}o.push({id:r.id,type:r.inputType,title:r.title,help:r.help,checked:new(d())(null!=i?i:r.value),status:e,onControlFocused:new(l()),disabled:t&&!r.supportModify,saveToSettings:r.saveToSettings,isValid:new(d())(!0),errorMessage:new(d()),destroy:()=>{}})}if("ComboBox"===r.inputType&&Array.isArray(r.items)){let e=r.items[0];if(s&&r.id in s){const t=s[r.id],i=r.items.find((e=>e.value===t));void 0!==i&&(e=i)}else r.forceUserEnterInitialValue&&!t&&(e=void 0);o.push({id:r.id,type:r.inputType,title:r.title,items:r.preventModify&&t&&e?[e]:r.items,selectedItem:new(d())(null==e?void 0:e.value),onControlFocused:new(l()),saveToSettings:r.saveToSettings,isRequired:Boolean(r.forceUserEnterInitialValue),alwaysShowAttachedErrors:i,isValid:new(d())(!0),errorMessage:new(d()),destroy:()=>{}})}})),o}async function I(t,e){if(void 0===t.solutions)return;if("changeSymbol"in t.solutions){const e=t.solutions.changeSymbol;return{title:r.t(null,void 0,i(562030)),apply:()=>s.linking.symbol.setValue(e)}}if("changeAccount"in t.solutions){const s=t.solutions.changeAccount,o=(await e.accountsMetainfo()).filter((t=>t.id===s))[0].name;return{title:r.t(null,void 0,i(134542)).replace("{accountName}",o),apply:()=>e.setCurrentAccount(s)}}const o=t.solutions.openUrl.url;return{title:t.solutions.openUrl.text,apply:()=>window.open(o,"_blank")}}function A(t,e){return void 0===e?t:(0,n.Big)(t).div(e).toNumber()}function N(t,e){if(null===t)return null;const i=e.format(t);if(e.parse){const t=e.parse(i);if(t.res)return t.value}return parseFloat(i)}},864348:(t,e,i)=>{"use strict";var r,s;function o(t){return(null==t?void 0:t.type)===s.PlaceOrder}i.d(e,{PlaceOrEditContextStatus:()=>r,PlaceOrEditContextType:()=>s,isContextPlaceOrderContext:()=>o}),function(t){
t[t.Undefined=0]="Undefined",t[t.Loading=1]="Loading",t[t.Error=2]="Error"}(r||(r={})),function(t){t[t.PlaceOrder=0]="PlaceOrder",t[t.EditOrder=1]="EditOrder",t[t.EditPosition=2]="EditPosition",t[t.EditTrade=3]="EditTrade"}(s||(s={}))},690839:(t,e,i)=>{"use strict";i.d(e,{OrdersService:()=>g,cropOrderData:()=>_,isBracketOrderRawData:()=>h});var r=i(650151),s=i(466052),o=i.n(s),n=i(372605),a=i(6835),l=i(481853),c=i(481330),d=i(397728);const u=(0,a.getLogger)("Trading.OrderService");function h(t){return"parentId"in t&&void 0!==t.parentId&&"parentType"in t&&void 0!==t.parentType}function p(t){return 1===t.type?(0,r.ensureDefined)(t.limitPrice):(0,r.ensureDefined)(t.stopPrice)}function _(t){return{id:t.id,parentId:t.parentId,parentType:t.parentType,symbol:t.symbol,type:t.type,side:t.side,avgPrice:t.avgPrice,limitPrice:t.limitPrice,stopPrice:t.stopPrice,price:t.price,stopLoss:t.stopLoss,trailingStopPips:t.trailingStopPips,stopType:t.stopType,takeProfit:t.takeProfit,status:t.status,qty:t.qty}}class g extends l.BrokerService{constructor(){super(...arguments),this._existingOrdersIds=new Set,this._activeOrders=new Map,this._activeOrderUpdate=new(o()),this._activeOrdersRemoved=new(o()),this._ordersRejected=new(o())}destroy(){this.stopService()}async getCurrency(){const t=(0,r.ensureNotNull)(this.activeBroker()),e=await t.accountMetainfo();return(0,c.getCurrency)(e,!0)||"USD"}orders(){return(0,r.ensureNotNull)(this.activeBroker()).orders()}find(t){return this._activeOrders.get(t)||null}activeOrders(){return Array.from(this._activeOrders.values())}activeOrdersUpdated(){return this._activeOrderUpdate}activeOrdersRemoved(){return this._activeOrdersRemoved}orderRejected(){return this._ordersRejected}stopService(){this._clearOrders();(0,r.ensureNotNull)(this.activeBroker()).orderUpdate.unsubscribeAll(this)}startService(){this._clearOrders(),this._requestOrders()}_clearOrders(){const t=Array.from(this._activeOrders.keys());this._activeOrders.clear(),this._existingOrdersIds.clear(),t.length>0&&u.logNormal(`All orders removed, id's: ${t}`),this._activeOrdersRemoved.fire(t)}async _requestOrders(){const t=this.activeBroker();if(!t)return;const e=await t.orders();for(const t of e)this._addActiveOrder(t);t.orderUpdate.unsubscribeAll(this),t.orderUpdate.subscribe(this,this._addActiveOrder)}_addActiveOrder(t){this._logOrderUpdate(t);const e=t.id,i=this._activeOrders.has(e),r=5===t.status,s=6!==t.status&&3!==t.status,o=2===t.type;if(i){if(s||o)return this._activeOrders.delete(e),void this._activeOrdersRemoved.fire([e])}else{if(o||s&&!r)return;if(r)return void this._ordersRejected.fire(p(t))}const n=this._getOrderData(t);this._activeOrders.set(e,n),this._activeOrderUpdate.fire(n)}_logOrderUpdate(t){const e=t.id;let i="update";this._existingOrdersIds.has(e)||(i="add",this._existingOrdersIds.add(e)),function(t,e){e(JSON.stringify(_(t)))}(t,(t=>{u.logNormal(`Order ${i}: ${t}`)}))}_getOrderData(t){const e=p(t);(0,n.isNumber)(e)||u.logError("order price is not defined");const i=(0,
r.ensureNotNull)(this.activeBroker()).metainfo().configFlags,s=Boolean(i.supportOrderBrackets&&i.supportModifyBrackets&&i.supportAddBracketsToExistingOrder);return(0,n.merge)((0,n.clone)(t),{price:e,considerFilledQty:!0,supportModify:(0,c.isModifyOrderSupported)(t,i),supportMove:(0,c.isMoveOrderSupported)(t,i),supportCancel:!0,supportBrackets:s,supportModifyOrderPrice:Boolean(i.supportModifyOrderPrice),supportTrailingStop:s&&(0,d.checkTrailingStopAvailability)(i)})}}},583705:(t,e,i)=>{"use strict";i.d(e,{PositionsService:()=>p,PositionsUpdateType:()=>u,cropPositionData:()=>h});var r=i(650151),s=i(466052),o=i.n(s),n=i(372605),a=i(6835),l=i(481853),c=i(397728);const d=(0,a.getLogger)("Trading.PositionService");var u;function h(t){const e=t;return{id:e.id,symbol:e.symbol,side:e.side,avgPrice:e.avgPrice,pl:e.pl,price:e.price,qtyBySide:e.qtyBySide,stopType:e.stopType,takeProfit:e.takeProfit,stopLoss:e.stopLoss,trailingStopPips:e.trailingStopPips}}!function(t){t[t.Full=0]="Full",t[t.Partial=1]="Partial"}(u||(u={}));class p extends l.BrokerService{constructor(){super(...arguments),this._existingPositionIds=new Set,this._positions=new Map,this._positionUpdate=new(o()),this._positionsRemoved=new(o()),this._displayMode=1,this._updatePositionPLHandler=this._updatePositionPL.bind(this)}destroy(){this.stopService()}positions(){return Array.from(this._positions.values())}find(t){return this._positions.get(t)||null}async realIdFromBroker(t){const e=(0,r.ensureNotNull)(this.activeBroker());if(1===this._displayMode){const i=await e.positionById(t);if(void 0!==i)return i.id}else{const i=await e.tradeById(t);if(void 0!==i)return i.id}return null}positionUpdate(){return this._positionUpdate}positionsRemoved(){return this._positionsRemoved}isDisplayModeTrades(){return 0===this._displayMode}async getCurrency(t){return await(0,r.ensureNotNull)(this.activeBroker()).getPositionCurrency(t)||""}stopService(){this._clearPositions();const t=(0,r.ensureNotNull)(this.activeBroker());this.isDisplayModeTrades()?t.tradeUpdate.unsubscribeAll(this):t.positionUpdate.unsubscribeAll(this)}startService(){this._clearPositions(),this._displayMode=function(t){if(null===t)return 1;const e=t.metainfo().configFlags;return e.supportTrades?e.supportPositionBrackets?1:e.supportCloseTrade?0:1:1}(this.activeBroker()),this._requestPositions()}_clearPositions(){const t=(0,r.ensureNotNull)(this.activeBroker()),e=Array.from(this._positions.keys());for(const i of e)this.isDisplayModeTrades()?t.unsubscribeTradePL(i,this._updatePositionPLHandler):t.unsubscribePL(i,this._updatePositionPLHandler);this._positions.clear(),this._existingPositionIds.clear(),e.length>0&&d.logNormal(`All positions removed, id's: ${e}`),this._positionsRemoved.fire(e)}async _requestPositions(){const t=this.activeBroker();if(!t)return;const e=this.isDisplayModeTrades(),i=await(e?t.trades():t.positions());for(const t of i)this._addPosition(t);e?t.tradeUpdate.subscribe(this,this._addPosition):t.positionUpdate.subscribe(this,this._addPosition)}_addPosition(t){const e=t.id,i=this._positions.has(e),s=(0,
r.ensureNotNull)(this.activeBroker()),o=this.isDisplayModeTrades();if(!t.qty)return i&&(o?s.unsubscribeTradePL(e,this._updatePositionPLHandler):s.unsubscribePL(e,this._updatePositionPLHandler),this._positions.delete(e),this._positionsRemoved.fire([e])),void this._logPositionUpdate(t,!0);const n=this._getPositionData(t),a=this._updateType(n);this._logPositionUpdate(n,a===u.Full),this._positions.set(e,n),this._firePositionUpdate(n,a),i||(o?s.subscribeTradePL(e,this._updatePositionPLHandler):s.subscribePL(e,this._updatePositionPLHandler))}_updatePositionPL(t,e){const i=(0,r.ensureDefined)(this._positions.get(t));i.pl=(0,n.isNumber)(e)?e:null,i.profitState=(0,c.profitStateByPL)(e),this._firePositionUpdate(i,u.Partial)}_getPositionData(t){var e,i;const s=(0,r.ensureNotNull)(this.activeBroker()).metainfo().configFlags,o=this._positions.get(t.id),n=this.isDisplayModeTrades(),a=Boolean(n?s.supportTradeBrackets:s.supportPositionBrackets);let l,d="neutral",u=!1,h=null;if(n){const e=t;l=e.price,u=Boolean(e.canBeClosed)}else{const r=t;l=r.avgPrice,h=null!==(i=null!==(e=r.pl)&&void 0!==e?e:null==o?void 0:o.pl)&&void 0!==i?i:null,null!==h&&(d=(0,c.profitStateByPL)(h))}return{...t,pl:h,plBasedOnLast:s.calculatePLUsingLast||!1,price:Math.abs((0,r.ensureDefined)(l)),qtyBySide:Math.abs(t.qty)*(1===t.side?1:-1),profitState:d,supportClose:Boolean(n?s.supportCloseTrade&&u:s.supportClosePosition),supportReverse:Boolean(!n&&s.supportReversePosition),supportBrackets:a,supportOnlyPairBrackets:Boolean(s.supportOnlyPairPositionBrackets),supportTrailingStop:a&&(0,c.checkTrailingStopAvailability)(s)}}_firePositionUpdate(t,e){this._positionUpdate.fire({data:t,type:e})}_updateType(t){const e=this._positions.get(t.id);if(void 0===e)return u.Full;for(const i of Object.keys(e)){const r=i;if("pl"!==r&&"unrealizedPl"!==r&&e[r]!==t[r])return u.Full}return u.Partial}_logPositionUpdate(t,e){if(!e)return;const i=t.id;let r="update";this._existingPositionIds.has(i)||(r="add",this._existingPositionIds.add(i)),function(t,e){e(JSON.stringify(h(t)))}(t,(t=>{d.logNormal(`Position  ${r}: ${t}`)}))}}},397728:(t,e,i)=>{"use strict";i.d(e,{checkTrailingStopAvailability:()=>r,profitStateByPL:()=>s});function r(t){return Boolean(t.supportTrailingStop&&t.supportAddBracketsToExistingOrder&&t.supportModifyTrailingStop&&false)}function s(t){const e=null===t?0:Math.round(100*t)/100;return e>0?"positive":e<0?"negative":"neutral"}},709641:(t,e,i)=>{"use strict";i.r(e),i.d(e,{Trading:()=>Pi,showSellBuyButtonsDefault:()=>ki});var r=i(650151),s=i(509806),o=i(870122),n=i(376202),a=i(69111),l=i(6835),c=i(588517),d=i.n(c);const u=i.p+"alarm_clock.ba219c712b5dce956b08.mp3",h=(0,l.getLogger)("Lib.Sound",{color:"#dea433"}),p="notification/notification",_=[{title:s.t(null,void 0,i(792586)),path:"alert/alarm_clock",soundForAlerts:!0,filePath:u}];const g={};function m(){return _.filter((t=>!!t.soundForAlerts))}function b(t){if((0,a.isOnMobileAppPage)("any"))return;if(!t)return;if(!/iPhone|iPad|iPod|Android|BlackBerry|BB10|Silk|Mobi/i.test(window.navigator.userAgent))return
;if(Array.isArray(t)||(t=[t]),0===(t=t.filter((t=>{const e=y(t);return!(!e||!e.el.load||e._mobilePreloadActive)&&(e._mobilePreloadActive=!0,!0)}))).length)return void h.logNormal("enableForMobile no sounds passed");const e=()=>{const r=[];Array.isArray(t)&&t.forEach((t=>{const e=y(t);e.el.load();const i=e.play().catch((t=>{if("AbortError"!==t.name)throw h.logError(`enableForMobile for "${e.el.src}" preload error: - ${t.message}`),t}));e.el.pause(),r.push(i)})),Promise.all(r).then((()=>{h.logNormal("enableForMobile sounds initialized")})),i.forEach((t=>{document.removeEventListener(t,e,!0)}))},i=["click","touchend","keydown"];i.forEach((t=>{document.addEventListener(t,e,!0)}))}const y=t=>{if(t in g)return g[t];h.logNormal(`requested sound  ${t} not cached, building a new audio element`);const e=_.find((e=>e.path===t));if(void 0===e)throw new Error(`Cannot find sound "${t}"`);const i=new Audio(e.filePath),r={el:i,playing:new(d())(!1),play:(e=0)=>r.playing.value()?(h.logNormal("sound already playing"),Promise.reject("already playing")):(r.playing.setValue(!0),new Promise(((i,s)=>{let o=e>0;const n=()=>{const e=function(t){try{h.logNormal(`"${t.el.src}" triggering html5 play method, readyState - ${t.el.readyState}; muted - ${t.el.muted}; volume - ${t.el.volume}; currentTime - ${t.el.currentTime}`);let e=t.el.play();return e||(e=Promise.resolve()),e}catch(e){return h.logError(`play method for "${t.el.src}" catch error - ${e.message}`),Promise.reject(e)}}(r);e.catch((e=>{h.logNormal(`stop counting sound "${t}"; as playing due to an error: ${e.message}`),r.stop(),s(e)}))};r._onEnded=()=>{o?n():(r.stop(),i())},r.el.addEventListener("ended",r._onEnded),o&&setTimeout((()=>{h.logNormal(`"${t}" repeat timeout - ${e}s off`),o=!1}),1e3*e),n()}))),stop:()=>{r.el.pause(),r.playing.setValue(!1),r._onEnded&&r.el.removeEventListener("ended",r._onEnded)}};g[t]=r;return["canplaythrough","error"].forEach((e=>{i.addEventListener(e,(()=>{h.logNormal(`for sound "${t}", event - ${e} is fired`)}),!1)})),h.logNormal(`canPlayType - ${i.canPlayType("audio/mp3")}`),g[t]};b(_.filter((t=>!!t.common)).map((t=>t.path)));var v=i(947488),f=i(323002),k=i(997345),P=i(586639),S=i(275734),C=i(757604),w=i(958261),B=i(114501),T=i(839874),O=i(196573),E=i(423869),L=i(656846),D=i(481330),I=i(391664),A=i(807107),N=i(637401),M=i(350299),V=i(340794),x=i(156963),R=i(330012),F=i(144273),q=i(466052),U=i.n(q),W=i(642469);var Q=i(148442),$=i(768819),j=i(447485),z=i(322625),H=i(34694),K=i(511990);const G=(0,l.getLogger)("Trading.RealtimeProvider");class Z{constructor(t){this._results={},this._getter=t}get(t){return this._results[t]||(this._results[t]=this._getter(t)),this._results[t]}}class J{constructor(t){this._stopped=!1,this._subscribed=!1,this._provider=null,this._formatters=null;const{symbol:e,callback:i,providersCache:r,formattersCache:s,subscriptionType:o,actualSymbolGetter:n}=t;this._symbol=e,this._subscriptionType=o,this._callback=i,this._providersCache=r,this._formattersCache=s,this._getActualSymbol=n,"Realtime"===this._subscriptionType?this._handler=(t,e)=>{
this._stopped||i(t,e,this._formatters)}:this._handler=(t,e)=>{this._stopped||i(t,e)},this._start().catch((t=>{}))}symbol(){return this._symbol}type(){return this._subscriptionType}callback(){return this._callback}destroy(){this._ensureNotStopped(),this._subscribed&&void 0!==this._actualSymbol&&("Realtime"===this._subscriptionType?(0,r.ensureNotNull)(this._provider).unsubscribeRealtime(this._actualSymbol,this._handler):(0,r.ensureNotNull)(this._provider).unsubscribeDOM(this._actualSymbol,this._handler)),this._stopped=!0}async _start(){const{symbol:t}=await this._getActualSymbol(this._symbol);this._ensureNotStopped(),this._provider=await this._providersCache.get(t),this._ensureNotStopped(),this._formatters=await this._formattersCache.get(t),(0,r.ensure)(this._formatters),this._ensureNotStopped(),this._actualSymbol=t,this._subscribed=!0,"Realtime"===this._subscriptionType?this._provider.subscribeRealtime(t,this._handler):this._provider.subscribeDOM(t,this._handler)}_ensureNotStopped(){(0,r.assert)(!this._stopped,"Should not be stopped")}}class X{constructor(t,e,i,r){this.onStatusChanged=new(U()),this._subscriptions=[],this._currentBroker=null,this._activeBrokerGetter=t,this._actualSymbolGetter=r,e.subscribe(this,this._connectionStatusChanged),i.subscribe(this,this._connectionStatusChanged),this._tvProvider=new H.BrokerRealtimeAdapter("RealtimeProvider"),this._connectionStatusChanged()}isTradable(t){return this._tradableCache.get(t)}subscribeRealtime(t,e){this._subscriptions.some((i=>i.symbol()===t&&i.callback()===e&&"Realtime"===i.type()))||this._subscriptions.push(new J({symbol:t,callback:e,providersCache:this._providersCache,formattersCache:this._formattersCache,subscriptionType:"Realtime",actualSymbolGetter:this._actualSymbolGetter}))}unsubscribeRealtime(t,e){const i=this._subscriptions.findIndex((i=>i.symbol()===t&&i.callback()===e&&"Realtime"===i.type()));if(-1===i)return;this._subscriptions[i].destroy(),this._subscriptions.splice(i,1)}subscribeDOM(t,e){this._subscriptions.some((i=>i.symbol()===t&&i.callback()===e&&"DOM"===i.type()))||this._subscriptions.push(new J({symbol:t,callback:e,providersCache:this._providersCache,formattersCache:this._formattersCache,subscriptionType:"DOM",actualSymbolGetter:this._actualSymbolGetter}))}unsubscribeDOM(t,e){const i=this._subscriptions.findIndex((i=>i.symbol()===t&&i.callback()===e&&"DOM"===i.type()));if(-1===i)return void G.logWarn("Subscription not found");this._subscriptions[i].destroy(),this._subscriptions.splice(i,1)}formatter(t){return this._formattersCache.get(t).then((t=>t.formatter))}spreadFormatter(t){return this._formattersCache.get(t).then((t=>t.spreadFormatter))}quantityFormatter(t){return this._formattersCache.get(t).then((t=>t.quantityFormatter))}symbolInfo(t){if(!t){const t={minTick:NaN,qty:{min:NaN,max:NaN,step:NaN},pipValue:NaN,pipSize:NaN,description:"no symbol"};return Promise.resolve(t)}
return this._providersCache.get(t).then((e=>e!==this._tvProvider?e.symbolInfo(t).then((e=>e||this._tvProvider.symbolInfo(t))).catch((e=>this._tvProvider.symbolInfo(t))):this._tvProvider.symbolInfo(t)))}quotesSnapshot(t){return this._providersCache.get(t).then((e=>e.quotesSnapshot(t)))}activeBroker(){return null!==this._currentBroker&&this._currentBroker!==this._tvProvider?this._currentBroker:null}_isTradable(t){if(null===this._currentBroker||this._currentBroker===this._tvProvider)return Promise.resolve({tradable:!1});try{return(0,K.makeTimeLimited)(this._currentBroker.isTradable(t),6e4,"isTradable Promise Timeout").catch((()=>Promise.resolve({tradable:!1})))}catch(t){return Promise.resolve({tradable:!1})}}_haveRealtime(t){return this._tradableCache.get(t)||Promise.resolve(null===this._currentBroker)}_connectionStatusChanged(){const t=this._activeBrokerGetter(),e=this._currentBroker,i=t&&1===t.connectionStatus()?t:null;if(this._createCaches(),e!==i){const t=this._subscriptions.map((t=>({symbol:t.symbol(),callback:t.callback(),type:t.type()})));this._unsubscribeAll(),this._currentBroker=i,this._subscribeAll(t),this.onStatusChanged.fire()}}_createCaches(){this._providersCache=new Z((t=>this._provider(t))),this._tradableCache=new Z((t=>this._isTradable(t))),this._formattersCache=new Z((t=>this._providersCache.get(t).then((e=>Promise.all([e.formatter(t,!1),e.spreadFormatter(t),e.quantityFormatter(t)]))).then((([t,e,i])=>({formatter:t,spreadFormatter:e,quantityFormatter:i})))))}_provider(t){return this._haveRealtime(t).then((t=>t.tradable&&this._currentBroker&&1===this._currentBroker.connectionStatus()?this._currentBroker:this._tvProvider))}_unsubscribeAll(){this._subscriptions.forEach((t=>{t.destroy()})),this._subscriptions=[]}_subscribeAll(t){t.forEach((t=>{this._subscriptions.push(new J({symbol:t.symbol,callback:t.callback,providersCache:this._providersCache,formattersCache:this._formattersCache,subscriptionType:t.type,actualSymbolGetter:this._actualSymbolGetter}))}))}}var Y=i(481853);class tt extends Y.BrokerService{constructor(t){super(t),this._userId=(window.user.id||"").toString(),window.loginStateChange&&window.loginStateChange.subscribe(this,this._onLoginStateChange)}trackOrderPlaced(t){this._trackOrderEvent("Placed",t)}trackOrderModified(t){this._trackOrderEvent("Modified",t)}startService(){(0,r.ensure)(this.activeBroker()).orderUpdate.subscribe(this,this._orderUpdate),this._trackTradingBrokerConnnected()}stopService(){(0,r.ensure)(this.activeBroker()).orderUpdate.unsubscribe(this,this._orderUpdate)}_orderUpdate(t,e){e||(5===t.status?this._trackOrderEvent("Rejected",t):2===t.status?this._trackOrderEvent("Executed",t):1===t.status&&this._trackOrderEvent("Canceled",t))}async _trackOrderEvent(t,e){var i;const r=this.trading().linking().value(),s=this.activeBroker();if(void 0===e||null===s)return;const o=await s.symbolInfo(e.symbol),n=e.qty*(o.lotSize||1),a="Placed"===t&&void 0!==r.continuous&&r.symbol===e.symbol?"continuous":o.type,l={amount:n,orderId:e.id,instrumentType:a,eventName:"Order "+t,userId:this._userId,
symbol:e.symbol,currency:null!==(i=o.currency)&&void 0!==i?i:null};this._trackTradingOrder(l)}_trackTradingOrder(t){const e=this.activeBroker();if(!e)throw new Error("no active broker")}_trackTradingBrokerConnnected(){const t=this.activeBroker();null!==t&&t.metainfo().id;if(!t)throw new Error("no active broker")}_onLoginStateChange(){this._userId=(window.user.id||"").toString()}}var et=i(863697),it=i(106056),rt=i(32133);function st(t="default"){switch(t){case"danger":return et.ToastIntent.Danger;case"attention":return et.ToastIntent.Warning;case"success":return et.ToastIntent.Success;default:return et.ToastIntent.Default}}class ot{constructor(t){this._chartWidgetCollection=t}showTradingProperties(){this._chartWidgetCollection.activeChartWidget.value().showGeneralChartProperties(W.TabNames.trading)}async closeAllNotifications(){const t=await this._chartWidgetCollection.getToasts();null!==t&&t.reset()}async showNotification(t,e,i,r){const s=await this._chartWidgetCollection.getToasts();if(null===s)return;let o="";"string"==typeof e&&(o=e),s.showSimpleToast({text:o,time:r,title:t,intent:st(i),priority:it.ToastPriority.Low})}showMaintenance(t){0}showBrokerSideMaintenance(t){0}trackEvent(t,e,i){!async function(t,e,i){(0,rt.trackEvent)(t,e,i)}(t,e,i)}showReplayConfirmationDialog(){return Promise.resolve()}reconnectChartApi(t){0}setBroker(t){const e=(null==t?void 0:t.metainfo().backendBrokerName)||(null==t?void 0:t.metainfo().id.toLowerCase())||"";this._chartWidgetCollection.setBroker(e)}}var nt=i(282729),at=(i(336379),i(156115));async function lt(t){const{showErrorNotification:e,handler:r,message:o,onOpen:n,onClose:a}=t;if(!await(0,at.showConfirmDialog)({title:s.t(null,void 0,i(424356)),content:o,mainButtonText:s.t(null,void 0,i(424356)),cancelButtonText:s.t(null,void 0,i(620036)),onOpen:n,onClose:a}))return!1;try{return await r()}catch(t){return e(s.t(null,void 0,i(791401)),function(t){let e="";null!==t&&"object"==typeof t&&t.message?e=t.message:"string"==typeof t&&(e=t);return e}(t)),!1}}var ct=i(66786),dt=i(120283),ut=i(314996);i(651049),i(702054),i(529719),i(627687),i(816105);async function ht(t,e,r){const o=await async function(t){const{PartiallyClosingDialogRenderer:e}=await i.e(3168).then(i.bind(i,531570)),r=new e;return new Promise((e=>{r.open({...t,dialogActionHandler:e})}))}(t);if(!o.status)return!1;try{return await e(o.qty)}catch(t){return r(s.t(null,void 0,i(791401)),function(t){let e="";null!==t&&"object"==typeof t&&t.message?e=t.message:"string"==typeof t&&(e=t);return e}(t)),!1}}var pt=i(252546);const _t={async show(t){const e=s.t(null,{replace:{symbol:t}},i(97929)),r=s.t(null,{replace:{symbol:t}},i(469497));return(0,pt.showSimpleConfirmDialog)({title:r,text:e})}},gt={async show(t){const e=s.t(null,{replace:{symbol:t}},i(965603)),r=s.t(null,{replace:{symbol:t}},i(447600));return(0,pt.showSimpleConfirmDialog)({title:r,text:e})}};var mt=i(50959),bt=i(793361);function yt(t){const{symbol:e,side:r,qty:o,price:n,id:a,closePositionCancelsOrders:l}=t,c=(0,bt.splitThousands)(o," "),d=(0,bt.splitThousands)(n," ")
;return mt.createElement(mt.Fragment,null,mt.createElement("div",null,void 0!==a?s.t(null,void 0,i(170392)).replace("{id}",a):s.t(null,void 0,i(381617))),mt.createElement("div",null,mt.createElement("b",null,e)),mt.createElement("div",null,mt.createElement("b",null,`${r} ${c} @ ${d}`)),mt.createElement("div",null,l&&` ${s.t(null,void 0,i(218329))}`))}var vt=i(484095);const ft=(0,l.getLogger)("Trading.BrokerCommandsUI"),kt={symbol:1,qty:1,side:1,type:1,seenPrice:1};class Pt{constructor({activeBroker:t,guiAccessor:e,noConfirmEnabled:i,orderViewController:r,showErrorNotification:s,trackEvent:o,tradingLinking:n}){this._closePositionDialogVisibility=new $.DialogVisibility,this._isClosePositionDialogLoading=!1,this._isCloseTradeDialogLoading=!1,this._onClosePositionDialogOpen=t=>{this._closePositionDialogVisibility.setValue({isVisible:!0,isFullScreen:t})},this._onClosePositionDialogClose=()=>{this._closePositionDialogVisibility.setValue({isVisible:!1})},this._tradingLinking=n,this._activeBroker=t,this._guiAccessor=e,this._orderViewController=r,this._showErrorNotification=s,this._noConfirmEnabled=i,this._trackEvent=o,this.closePositionDialogVisibility=this._closePositionDialogVisibility.value$}async placeOrder(t,e,i){const r=e&&this._noConfirmEnabled.value(),s=this._guiAccessor&&r?this._guiAccessor.showReplayConfirmationDialog():Promise.resolve(!1);try{await s}catch(t){Promise.resolve(!1)}const o=await this._activeBroker.isTradable(t.symbol);if(r&&o.tradable&&function(t){for(const e in kt)if(!(e in t))return!1;return!0}(t)){false;const e=await this._activeBroker.createInitialPreOrder(t);return this._activeBroker.placeOrder(e)}{const e=this._activeBroker.metainfo();if(e.customUI&&void 0!==e.customUI.showOrderDialog)return e.customUI.showOrderDialog(t)}return this._orderViewController().then((e=>this._activeBroker?e.showOrderView({order:t,focus:void 0,forceOrderDialog:i}):Promise.reject("Broker connection adapter is null")))}async modifyOrder(t,e,i,r){return e&&this._noConfirmEnabled.value()&&t.parentType,this._modifyOrder(t,e,i,r)}async closePosition(t){var e,i;if(this._makeSureBrokerIsConnected(),this._isClosePositionDialogLoading)return!1;let r,s;this._isClosePositionDialogLoading=!0;try{if(r=await this._activeBroker.positionById(t),void 0===r)return!1;const{tradable:e}=await this._activeBroker.isTradable(r.symbol);if(await this._assertPositionExistsAndNotClosed(r.id),!e)return this._closePositionForNonTradableSymbol(r);if(this._noConfirmEnabled.value())return this._activeBroker.closePosition(t);s=await this._obtainPositionClosingData(r)}finally{this._isClosePositionDialogLoading=!1}if(void 0===s)return!1;const{supportPartialClosePosition:o,...n}=s,a=this._activeBroker.metainfo();if(void 0!==(null===(e=a.customUI)||void 0===e?void 0:e.showClosePositionDialog))return null===(i=a.customUI)||void 0===i?void 0:i.showClosePositionDialog(r);if(o){const e=e=>(e!==(null==r?void 0:r.qty)?this._trackEvent("","Close Position Dialog","partial"):this._trackEvent("","Close Position Dialog","full"),this._activeBroker.closePosition(t,e))
;return ht({...n,positionOrTrade:r,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose},e,this._showErrorNotification)}{const e=()=>this._activeBroker.closePosition(t);return lt({showErrorNotification:this._showErrorNotification,handler:e,message:s.message,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose})}}async closeTrade(t){if(this._makeSureBrokerIsConnected(),(0,r.assert)(!!this._activeBroker.config.supportTrades,"Broker doesn`t support trades"),this._noConfirmEnabled.value())return this._activeBroker.closeTrade(t);{if(this._isCloseTradeDialogLoading)return!1;const e=await this._obtainTradeClosingData(t);if(void 0===e)return!1;const{supportPartialCloseTrade:i,trade:r,...s}=e;if(i){const e=async e=>(e!==r.qty?this._trackEvent("","Close Trade Dialog","partial"):this._trackEvent("","Close Trade Dialog","full"),this._activeBroker.closeTrade(t,e));return ht({...s,positionOrTrade:r,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose},e,this._showErrorNotification)}return lt({showErrorNotification:this._showErrorNotification,handler:()=>this._activeBroker.closeTrade(t),message:e.message,onOpen:this._onClosePositionDialogOpen,onClose:this._onClosePositionDialogClose})}}editPositionBrackets(t,e,i,s){return this._makeSureBrokerIsConnected(),(0,r.assert)(!!this._activeBroker.config.supportPositionBrackets,"Broker doesn`t support brackets on positions"),s&&this._noConfirmEnabled.value()?this._activeBroker.editPositionBrackets(t,null!=e?e:{}):this._activeBroker.positionById(t).then((t=>this._activeBroker?this._showPositionDialog((0,r.ensureDefined)(t),e,i):Promise.reject("Broker connection adapter is null")))}editTradeBrackets(t,e,i,s){return s&&this._noConfirmEnabled.value()?this._activeBroker.editTradeBrackets(t,null!=e?e:{}):this._activeBroker.tradeById(t).then((t=>this._activeBroker?this._showTradeDialog((0,r.ensureDefined)(t),e,i):Promise.reject("Broker connection adapter is null")))}reversePosition(t){return this._makeSureBrokerIsConnected(),this._activeBroker.metainfo().configFlags.supportMultiposition&&!this._activeBroker.config.supportNativeReversePosition?Promise.reject("Cannot reverse position on multiposition acount"):this._noConfirmEnabled.value()?this._activeBroker.reversePosition(t):this._activeBroker.positionById(t).then((e=>{if(!this._activeBroker)return Promise.reject("Broker connection adapter is null");const i=this._activeBroker.reversePosition.bind(this._activeBroker,t);return(0,ct.reversePositionDialog)(t,this._showErrorNotification,i,this._activeBroker.config.closePositionCancelsOrders)}))}async cancelOrder(t){var e,i;this._makeSureBrokerIsConnected();const r=await this._activeBroker.orderById(t);if(void 0===r)return Promise.reject("Failed to find order");const{tradable:s}=await this._activeBroker.isTradable(r.symbol);if(await this._assertOrderExistsAndNotCanceled(r.id),!s)return this._cancelOrderForNonTradableSymbol(r.symbol,r.id);if(this._noConfirmEnabled.value())return this._activeBroker.cancelOrder(t);{
const s=this._activeBroker.cancelOrder.bind(this._activeBroker,t),o=this._activeBroker.metainfo();if(void 0!==(null===(e=o.customUI)||void 0===e?void 0:e.showCancelOrderDialog))return null===(i=o.customUI)||void 0===i?void 0:i.showCancelOrderDialog(r);if(r.parentId){const t=(await this._activeBroker.orders()).filter((t=>t.refNumber===r.refNumber));return o.configFlags.supportCancellingBothBracketsOnly&&t.length>1?this._showCancelMultipleBracketsDialog(r.parentId,s):this._showCancelBracketsDialog(r.id,s)}return this._showCancelOrderDialog(r.id,s)}}cancelOrders(t,e){return this._makeSureBrokerIsConnected(),this._activeBroker.orders().then((i=>{if(!this._activeBroker)return Promise.reject("Broker connection adapter is null");const r=i.filter((i=>i.symbol===t&&(!e||i.side===e)&&function(t){return 4===t.status||3===t.status||6===t.status}(i)));if(!r.length)return Promise.resolve(!1);if(1===r.length)return this.cancelOrder(r[0].id);const s=r.map((t=>t.id));if(this._noConfirmEnabled.value())return this._activeBroker.cancelOrders(t,e,s);{const i=this._activeBroker.cancelOrders.bind(this._activeBroker);return this._showCancelMultipleOrdersDialog(t,e,s,i)}}))}async _modifyOrder(t,e,r,o){const n=this._activeBroker.metainfo();if(!n.configFlags.supportModifyTrailingStop){const e=(await this._activeBroker.orders()).find((e=>e.id===t.id));void 0!==e&&void 0!==e.trailingStopPips?t.hasTrailingStopBracket=!0:t.hasTrailingStopBracket=!1}if(this._makeSureBrokerIsConnected(),t.flags&&t.flags.trailingStop)return ft.logError("Attempt to modify trailing stop loss order"+t.id),this._showErrorNotification(s.t(null,void 0,i(292559)),s.t(null,void 0,i(507214))),Promise.resolve(!1);await this._setSymbol(t.symbol);const a=await this._activeBroker.symbolInfo(t.symbol);t.limitPrice=void 0!==a.limitPriceStep&&void 0!==t.limitPrice?(0,N.roundToStepByPriceTypeAndSide)(t.limitPrice,a.limitPriceStep,1,t.side):t.limitPrice,t.stopPrice=void 0!==a.stopPriceStep&&void 0!==t.stopPrice?(0,N.roundToStepByPriceTypeAndSide)(t.stopPrice,a.stopPriceStep,2,t.side):t.stopPrice;const l=t.limitPrice,c=t.stopPrice,d=t.stopType,u=e&&this._noConfirmEnabled.value();let h=r||(1===t.type?1:2);if(t.parentId&&!x.enabled("always_pass_called_order_to_modify")){let e,i=this._activeBroker.orderById.bind(this._activeBroker);2===t.parentType&&(i=this._activeBroker.positionById.bind(this._activeBroker)),3===t.parentType&&(i=this._activeBroker.tradeById.bind(this._activeBroker));try{e=await i(t.parentId)}catch(t){e=void 0}if(e){h=r||(1===t.type?3:4);const i={takeProfit:l};if(d===nt.StopType.TrailingStop?i.trailingStopPips=t.trailingStopPips:i.stopLoss=c,u&&(i.takeProfit=i.takeProfit||e.takeProfit,i.stopLoss=i.stopLoss||e.stopLoss,i.trailingStopPips=i.trailingStopPips||e.trailingStopPips),3===t.parentType)return u?this._activeBroker.editTradeBrackets(e.id,i):this._showTradeDialog(e,i,h);if(2===t.parentType&&t.qty===Math.abs(e.qty))return u?this._activeBroker.editPositionBrackets(e.id,i):this._showPositionDialog(e,i,h);const s=e;(0,D.isOrderActive)(s.status)&&(t=Object.assign({},s),
l&&(t.takeProfit=l),c&&(d===nt.StopType.TrailingStop?t.trailingStopPips=i.trailingStopPips||t.trailingStopPips:t.stopLoss=c))}}return u?this._activeBroker.modifyOrder(t):n.customUI&&void 0!==n.customUI.showOrderDialog?n.customUI.showOrderDialog(t,h):this._orderViewController().then((e=>this._activeBroker?e.showOrderView({order:t,focus:h,forceOrderDialog:o}):Promise.reject("Broker connection adapter is null")))}async _setSymbol(t){this._tradingLinking.value().symbol!==t&&await this._tradingLinking.setSymbol(t)}_makeSureBrokerIsConnected(){(0,r.assert)(1===this._activeBroker.connectionStatus(),"Broker is not connected")}async _showPositionDialog(t,e={},r){await this._setSymbol(t.symbol);const o=await this._activeBroker.isTradable(t.symbol);if(!o.tradable){const e=void 0!==o.reason?o.reason:(0,N.makeNonTradableSymbolText)(t.symbol,this._activeBroker.metainfo().title);return this._showErrorNotification(s.t(null,void 0,i(326704)),e),Promise.resolve(!1)}{const i=this._activeBroker.metainfo();if(i.customUI&&void 0!==i.customUI.showPositionDialog)return i.customUI.showPositionDialog(t,{stopLoss:e.stopLoss||t.stopLoss,takeProfit:e.takeProfit||t.takeProfit},r)}return this._orderViewController().then((i=>this._activeBroker?i.showPositionView(t,{stopLoss:e.stopLoss,takeProfit:e.takeProfit,trailingStopPips:e.trailingStopPips},r||t.limitPrice&&3||t.stopPrice&&4):Promise.reject("Broker connection adapter is null")))}async _showTradeDialog(t,e={},i){await this._setSymbol(t.symbol);{const r=this._activeBroker.metainfo();if(r.customUI&&void 0!==r.customUI.showPositionDialog)return r.customUI.showPositionDialog(t,{stopLoss:e.stopLoss||t.stopLoss,takeProfit:e.takeProfit||t.takeProfit},i)}return this._orderViewController().then((r=>this._activeBroker?r.showTradeView(t,{stopLoss:e.stopLoss,takeProfit:e.takeProfit,trailingStopPips:e.trailingStopPips},i||t.limitPrice&&3||t.stopPrice&&4):Promise.reject("Broker connection adapter is null")))}_isMaintenance(){return isFeatureEnabled((0,D.makeMaintananceFeatureToggleName)(this._activeBroker.metainfo().id))}_isBrokerSideMaintenance(){return isFeatureEnabled((0,D.makeBrokerSideMaintananceFeatureToggleName)(this._activeBroker.metainfo().id))}_showCancelOrderDialog(t,e){return dt.ConfirmOrderCancelDialog.get().open(t).then((i=>i?e(t):Promise.resolve(!1)))}_showCancelMultipleOrdersDialog(t,e,i,r){const s=i.length;return dt.ConfirmOrderCancelDialog.get().multiple(t,e,s).then((s=>s?r(t,e,i):Promise.resolve(!1)))}async _showCancelBracketsDialog(t,e){return ut.ConfirmBracketsCancelDialog.get().open(t).then((i=>i?e(t):Promise.resolve(!1)))}_showCancelMultipleBracketsDialog(t,e){return ut.ConfirmBracketsCancelDialog.get().multiple(t).then((i=>i?e(t):Promise.resolve(!1)))}async _obtainPositionClosingData(t){try{const{supportLots:e,qtyStep:r,uiQtyStep:o,minQty:n,qtyFormatter:a,priceFormatter:l}=await this._obtainPositionOrTradeClosingCommonData(t),c=this._activeBroker.metainfo().configFlags.supportPartialClosePosition,d=yt({symbol:t.symbol,
side:1===t.side?s.t(null,void 0,i(273064)):s.t(null,void 0,i(777851)),qty:a.format(t.qty),price:l.format(t.avgPrice),closePositionCancelsOrders:this._activeBroker.config.closePositionCancelsOrders});return{position:t,supportLots:e,qtyStep:r,uiQtyStep:o,minQty:n,supportPartialClosePosition:c,qtyFormatter:a,message:d}}catch(t){return}}async _obtainTradeClosingData(t){try{this._isCloseTradeDialogLoading=!0;const e=(0,r.ensureDefined)(await this._activeBroker.tradeById(t)),{supportLots:o,qtyStep:n,uiQtyStep:a,minQty:l,qtyFormatter:c,priceFormatter:d}=await this._obtainPositionOrTradeClosingCommonData(e),u=this._activeBroker.metainfo().configFlags.supportPartialCloseTrade,h=yt({symbol:e.symbol,side:1===e.side?s.t(null,void 0,i(273064)):s.t(null,void 0,i(777851)),qty:c.format(e.qty),price:d.format(e.price),id:t,closePositionCancelsOrders:this._activeBroker.config.closePositionCancelsOrders});return this._isCloseTradeDialogLoading=!1,{trade:e,supportLots:o,qtyStep:n,uiQtyStep:a,minQty:l,supportPartialCloseTrade:u,qtyFormatter:c,message:h}}catch(t){return void(this._isCloseTradeDialogLoading=!1)}}async _obtainPositionOrTradeClosingCommonData(t){const e=await this._activeBroker.symbolInfo(t.symbol);return{supportLots:void 0!==e.lotSize,qtyStep:e.qty.step,uiQtyStep:e.qty.uiStep,minQty:e.qty.min,qtyFormatter:await this._activeBroker.quantityFormatter(t.symbol),priceFormatter:await this._activeBroker.formatter(t.symbol,!1)}}async _closePositionForNonTradableSymbol(t){const{supportClosePositionForNonTradableSymbol:e,supportClosePosition:r}=this._activeBroker.metainfo().configFlags;if(!e||!r){const e=s.t(null,{replace:{symbol:t.symbol}},i(946305));return this._showErrorNotification(e,s.t(null,void 0,i(348434))),!1}return!!await _t.show(t.symbol)&&this._activeBroker.closePosition(t.id)}async _cancelOrderForNonTradableSymbol(t,e){if(!this._activeBroker.metainfo().configFlags.supportCancelOrderForNonTradableSymbol){const e=s.t(null,{replace:{symbol:t}},i(993545));return this._showErrorNotification(e,s.t(null,void 0,i(30665))),!1}return!!await gt.show(t)&&this._activeBroker.cancelOrder(e)}async _assertPositionExistsAndNotClosed(t){const e=await this._activeBroker.positionById(t);if(!(0,D.checkIsExistingPosition)(e))throw new vt.UserFriendlyError({userFriendlyMessage:s.t(null,{replace:{positionId:t}},i(969233)),detailedErrorMessage:`Position ${t} doesn't exist or has already been closed`})}async _assertOrderExistsAndNotCanceled(t){const e=await this._activeBroker.orderById(t);if(void 0===e||1===e.status)throw new vt.UserFriendlyError({userFriendlyMessage:s.t(null,{replace:{orderId:t}},i(579287)),detailedErrorMessage:`Order ${t} doesn't exist or has already been canceled`})}}class St{constructor(t,e,i,r,s){this._domPanel=null,this._resizerBridge=t,this._trading=i,this._qtySuggester=r,this._tradingLinking=s,this._getDOMPanel=(0,V.sequentialize)(this._getDOMPanel),this._close=()=>{this.unmount(),e()}}mount(){return this._getDOMPanel().then((t=>{t.setVisibility(!0)}))}unmount(){this._getDOMPanel().then((t=>{t.setVisibility(!1)}))}
async _getDOMPanel(){if(null!==this._domPanel)return this._domPanel;const{DOMPanel:t}=await Promise.all([i.e(2980),i.e(4131),i.e(580),i.e(8194),i.e(2191),i.e(7845),i.e(5518),i.e(2639),i.e(4474),i.e(7194),i.e(5295),i.e(1889),i.e(7677),i.e(9934),i.e(6577),i.e(7125),i.e(993),i.e(9791),i.e(9789),i.e(4627)]).then(i.bind(i,552513)),e=this._domPanel=new t(this._trading,this._resizerBridge,this._qtySuggester,this._tradingLinking);return e.setCloseHandler(this._close),e}}class Ct{mount(){return Promise.resolve()}unmount(){}}var wt=i(758094),Bt=i(483830);const Tt=x.enabled("show_order_panel_on_start");class Ot{constructor(t){this.isOpened=new(d())(!1),this.isOpeningAvailable=new(d())(!1),this.activePage=new(d())(Tt?wt.TradingPage.OrderPanel:wt.TradingPage.DOMPanel),this.isLoading=new(d())(!1),this._pages={},this._panelWidth=wt.minPanelWidth,this.setPage=t=>{this.isOpened.value()&&this.activePage.value()!==t&&this._pages[this.activePage.value()]&&this._pages[this.activePage.value()].unmount(),this.activePage.setValue(t),o.setValue(z.settingsKeys.TRADING_PANEL_ACTIVE_PAGE,t)},this.openPage=t=>{this.setPage(t),this.open()},this.open=()=>{this.isOpeningAvailable.value()&&this._pages[this.activePage.value()]&&(this._togglePanel(!0),this.isOpened.setValue(!0),this._pages[this.activePage.value()].mount())},this.close=()=>{this.isOpened.setValue(!1),this._pages[this.activePage.value()]&&this._pages[this.activePage.value()].unmount(),this._togglePanel(!1)},this._onLayoutResizeHandleMousedown=t=>{if(t.defaultPrevented||!t.cancelable)return;t.preventDefault();const e=Math.max(this._resizerBridge.width.value(),0);let i;i="touches"in t?t.touches[0].clientX:t.clientX;const r=t=>{let r;t.preventDefault(),r="touches"in t?t.touches[0].clientX:t.clientX;let s=e-(r-i);s<wt.minPanelWidth?s=wt.minPanelWidth:s>wt.maxPanelWidth&&(s=wt.maxPanelWidth),this._requestWidth(s)},s=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("touchmove",r),document.removeEventListener("mouseup",s),document.removeEventListener("touchend",s),o.setValue(z.settingsKeys.PANEL_WIDTH,this._panelWidth)};document.addEventListener("mousemove",r),document.addEventListener("touchmove",r,{passive:!1}),document.addEventListener("mouseup",s),document.addEventListener("touchend",s,{passive:!1})},this._resizerBridge=t,this._rootContainer=this._resizerBridge.container.value(),this.container=document.createElement("div"),this.container.classList.add(Bt["trading-panel-content"],"trading-panel-content"),this._rootContainer.appendChild(this.container),this._addSpinner(),this._addResizeHandler(),this._subscribeVisibility(),this.isLoading.subscribe(this._setLoading.bind(this)),this._rootContainer.style.overflow=this.isOpened.value()?"":"hidden"}addPage(t,e){this._pages[t]=e}isPageOpened(t){return this.isOpened.value()&&this.activePage.value()===t}_setLoading(t){t?this._rootContainer.appendChild(this._spinnerContainer):this._rootContainer.contains(this._spinnerContainer)&&this._rootContainer.removeChild(this._spinnerContainer)}_addSpinner(){
this._spinnerContainer=document.createElement("div"),this._spinnerContainer.classList.add(Bt["trading-panel-spinner"]),i.e(7102).then(i.bind(i,974063)).then((t=>{t.render(this._spinnerContainer)}))}_addResizeHandler(){this._handle=document.createElement("div"),this._handle.classList.add(Bt["trading-panel-handle"]),this._rootContainer.appendChild(this._handle),this._handle.addEventListener("mousedown",this._onLayoutResizeHandleMousedown,{passive:!1}),this._handle.addEventListener("touchstart",this._onLayoutResizeHandleMousedown,{passive:!1}),this._panelWidth=o.getInt(z.settingsKeys.PANEL_WIDTH)||wt.minPanelWidth}_togglePanel(t){this._resizerBridge.negotiateWidth(t?this._panelWidth:0),this._resizerBridge.negotiateHeight(t?wt.panelHeight:0),this._rootContainer.style.overflow=t?"":"hidden",o.setValue(z.settingsKeys.TRADING_PANEL_OPENED,t)}_updateOpeningAvailability(){const t="visible"!==document.visibilityState||this._resizerBridge.visible.value();this.isOpeningAvailable.setValue(Boolean(t&&this._resizerBridge.availHeight.value()>=wt.panelHeight&&this._resizerBridge.availWidth.value()>=this._panelWidth))}_subscribeVisibility(){this._updateOpeningAvailability(),this._resizerBridge.visible.subscribe((()=>{this._updateOpeningAvailability()})),this._resizerBridge.availHeight.subscribe((()=>{this._updateOpeningAvailability()})),this._resizerBridge.availWidth.subscribe((()=>{this._updateOpeningAvailability()}))}_requestWidth(t){this._canResizeWidth(t)&&this._resizerBridge.width.value()!==t&&(this._resizerBridge.negotiateWidth([{min:wt.minPanelWidth,max:t}]),this._panelWidth=t)}_canResizeWidth(t){return t+46<=this._resizerBridge.availWidth.value()}}var Et=i(12481),Lt=i(508334);const Dt=["qty","stopPrice","limitPrice","status","filledQty","stopType"];function It(t,e,i){if(void 0===t||void 0===e)return!1;const r=i.indexOf(".");if(-1!==r){const s=i.substring(0,r);return It(t[s],e[s],i.substring(r+1))}return t[i]===e[i]}function At(t,e){return t.enabled.value()&&(e.soundPath=t.path.value()),e}function Nt(t){return 6===t||3===t}class Mt extends Y.BrokerService{constructor(t){super(t),this._orders=[],this._playSound=(0,Et.default)(this._playSoundImpl,50),b(m().map((t=>t.path)))}startService(){const t=(0,r.ensure)(this.activeBroker());t.orders().then((t=>this._orders=(0,Lt.deepCopy)(t))),t.orderUpdate.subscribe(this,this._orderUpdate)}stopService(){(0,r.ensure)(this.activeBroker()).orderUpdate.unsubscribe(this,this._orderUpdate)}_showNotification(t,e,i){x.enabled("trading_notifications")&&("error"===i?this.trading().showErrorNotification(t,e):this.trading().showSuccessNotification(t,e))}_formatter(t){return(0,r.ensureNotNull)(this.activeBroker()).formatter(t,!0)}_checkOrderModified(t,e){const i=this.activeBroker(),r=i&&i.metainfo().customNotificationFields||[],s=Dt.concat(r);let o=!1;return s.forEach((i=>{o||It(t,e,i)||(o=!0)})),o}_generateNotificationsInfo(t,e){const r=[],o=t.statusMessage?": "+t.statusMessage:"",n=(1===t.side?s.t(null,void 0,i(32241)):s.t(null,void 0,i(185631))).toUpperCase()
;const a=this.trading().orderExecutedSoundParams;return e?(this._checkOrderModified(t,e)&&(1===t.status?r.push({text:s.t(null,void 0,i(767207)),notificationType:1}):5===t.status?r.push({text:s.t(null,void 0,i(442060))+o,type:"error",notificationType:2}):2===t.status?r.push(At(a,{side:n,text:s.t(null,void 0,i(499577)),notificationType:6})):e.filledQty!==t.filledQty?r.push(At(a,{side:n,text:s.t(null,void 0,i(23750)),notificationType:4})):Nt(t.status)&&r.push({text:s.t(null,void 0,i(164105)),notificationType:5})),Object.assign(e,t)):Nt(t.status)?(this._orders.push(t),r.push({text:s.t(null,void 0,i(595536)),notificationType:0}),this.trading().trackEvent("","Order placed symbol",t.symbol)):1===t.status?r.push({text:s.t(null,void 0,i(767207)),notificationType:1}):5===t.status?(this._orders.push(t),r.push({text:s.t(null,void 0,i(442060))+o,type:"error",notificationType:2})):2===t.status&&(this._orders.push(t),r.push({text:s.t(null,void 0,i(595536)),notificationType:0},At(a,{side:n,text:s.t(null,void 0,i(499577)),emptyOrderType:!0,notificationType:6})),this.trading().trackEvent("","Order placed symbol",t.symbol)),r}_orderUpdate(t,e){const r=(0,Lt.deepCopy)(t),o=this._orders.find((t=>t.id===r.id));if(e)return void(void 0===o&&this._orders.push(r));if(o&&(0,N.isFinalOrderStatus)(o.status))return;const n=this._generateNotificationsInfo(r,o);0!==n.length&&this._formatter(r.symbol).then((t=>{const e=(0,N.sideToText)(r.side,!0),o=r.qty,a=void 0!==r.filledQty&&r.filledQty>0?r.filledQty:void 0;let l="",c="";switch(r.type){case 2:l=r.avgPrice?" ("+(0,N.orderTypeToText)({orderType:r.type})+")":"",c=r.avgPrice?t.format(r.avgPrice):(0,N.orderTypeToText)({orderType:r.type});break;case 4:l=" "+s.t(null,void 0,i(916322)).format({price:t.format(r.stopPrice)}),c=t.format(r.avgPrice||r.limitPrice);break;default:l=" ("+(0,N.orderTypeToText)({orderType:r.type})+")",c=t.format(r.avgPrice||r.limitPrice||r.stopPrice)}const d=void 0!==r.message?`${r.message.text.charAt(0).toUpperCase()}${r.message.text.substring(1)}`:"";n.forEach((({text:t,type:n,side:u,emptyOrderType:h,soundPath:p,notificationType:_})=>{const g=4===_&&void 0!==a?a:o,m=(0,bt.splitThousands)(Math.abs(g),"")+" "+(r.brokerSymbol||r.symbol)+" "+s.t(null,void 0,i(492903))+" "+c,b=`${s.t(null,void 0,i(922541))} ${r.id} ${t}`,y=`${u||e} ${m} ${h?"":l}\n${d}`;void 0!==p&&this._playSound(p),this._showNotification(b,y,n)}))}))}_playSoundImpl(t){if(this._playingSound){if(this._playingSound===t)return;!function(t){if((0,a.isOnMobileAppPage)("any"))return;let e=[];t?e.push(y(t)):e=Object.values(g),e.forEach((t=>{t.stop()}))}(this._playingSound)}this._playingSound=t,function(t=p,e){(0,a.isOnMobileAppPage)("any")?Promise.resolve():(h.logNormal(`Sound play attempt for "${t}" duration-${e}s;`),y(t).play(e))}(t),function(t,e){(0,a.isOnMobileAppPage)("any")||y(t).playing.subscribe((t=>{t||e()}),{once:!0})}(t,(()=>{delete this._playingSound}))}}var Vt=i(739343);const xt=(0,l.getLogger)("Chart.PointsetManager");let Rt=0;class Ft{constructor(t,e,i,r,s){this._currentPointsetId=null,
this._onUpdate=new(U()),this._requestPoints=[],this._gateway=t,this._pointsetSuffix=e,this._isGatewayConnected=this._gateway.isConnected().spawn(),this._isGatewayConnected.subscribe(this._updateByGatewayConnection.bind(this)),this._addPoints(i,r,s)}onUpdate(){return this._onUpdate}destroy(){this._isGatewayConnected.value()&&null!==this._currentPointsetId&&this._gateway.removePointset(this._currentPointsetId),this._requestPoints=[],this._currentPointsetId=null,this._isGatewayConnected.destroy()}_updateByGatewayConnection(t){t||(this._currentPointsetId=null,this._requestPoints=[])}_addPoints(t,e,i){var s,o;this._isGatewayConnected.value()&&((0,r.assert)(t.length>0,"Can't possible create point set for empty array of time points"),this._requestPoints=t.map((t=>[t.time_t,t.offset])),this._currentPointsetId=(s=this._pointsetSuffix,o=++Rt,`pointset_${s}_${o}`),this._gateway.createPointset(this._currentPointsetId,"turnaround",e,(0,Vt.getServerInterval)(i),this._requestPoints,this._onMessage.bind(this)))}_onMessage(t){switch(t.method){case"pointset_error":xt.logNormal(`Pointset error with id ${t.params[0]} turnaround ${t.params[1]}`);break;case"data_update":{const e=[];for(const i of t.params.plots)e.push({time_t:this._requestPoints[i.index][0],index:i.value[0],barTime:i.value[1]});this._onUpdate.fire(e);break}}}}var qt=i(648067);function Ut(t){const e=t.mainSeries().data().first();return null===e?null:e.value[0]}async function Wt(t,e,r){const[s,o,n]=await Promise.all([Promise.all([i.e(1033),i.e(1969),i.e(2650)]).then(i.bind(i,289705)),Promise.all([i.e(1033),i.e(1969),i.e(2650)]).then(i.bind(i,564209)),Promise.all([i.e(1033),i.e(1969),i.e(2650)]).then(i.bind(i,856628))]);t.addCustomSource("executions",((t,i)=>{const a=i.mainSeries(),l=a.dataEvents(),c=(0,qt.createPrimitivePropertyFromGetterAndSubscription)(i.isInReplay.bind(i),i.onInReplayStateChanged()),d=(0,qt.createPrimitivePropertyFromGetterAndSubscription)((()=>a.isConvertedToOtherCurrency()||a.isConvertedToOtherUnit()),a.symbolResolved()),u={arrowVisibility:(0,qt.combineProperty)(((t,e,i)=>i&&!e),c,d,i.properties().childs().tradingProperties.childs().showExecutions),labelVisibility:i.properties().childs().tradingProperties.childs().showExecutionsLabels},h=function(t,e,i){return r=>{const s=i.seriesSource().symbolInstanceId(),o=i.interval();return null===s?null:new Ft(t,e,r,s,o)}}(i.chartApi(),"executions",a),p=(0,qt.createWVFromGetterAndSubscription)(Ut.bind(null,i),l.barReceived()),_=new s.ExecutionsService(e,l,function(t){return()=>{const e=t.symbolInfo();return null!==e?e.pro_name||e.full_name:t.proSymbol()}}(a)),g=new o.ExecutionsPointsManager(_,h,p);return new n.ExecutionsSource(t,i,u,r,g)}))}var Qt=i(583705),$t=i(690839),jt=i(150335),zt=i(409432),Ht=i(815628),Kt=i(372605)
;const Gt=s.t(null,void 0,i(505010)),Zt=s.t(null,void 0,i(703396)),Jt=s.t(null,void 0,i(538386)),Xt=s.t(null,void 0,i(893966)),Yt=s.t(null,void 0,i(799559)),te=s.t(null,void 0,i(435312)),ee=s.t(null,void 0,i(422540)),ie=s.t(null,void 0,i(400241)),re=s.t(null,void 0,i(766596)),se=x.enabled("broker_button");class oe{constructor({dataEvents:t,getSymbolName:e,isNonTradableInstrument:i,qtySuggester:r,tradingCommands:s,settings:o,isInReplay:n}){this.ask=new(d())(null),this.askTooltip=new(d())(Yt),this.bid=new(d())(null),this.bidTooltip=new(d())(te),this.spread=new(d())(null),this.spreadTooltip=new(d())(ee),this.qty=new(d())(null),this.qtyTooltip=new(d())(""),this.brokerIconVisible=new(d())(!1),this.brokerIconLoading=new(d())(!1),this.brokerIconUrl=new(d())(null),this.isQtyVisible=new(d())(!1),this.hasAskBidAdditionalPrecision=new(d())(!1),this.canTrade=new(d())(!0),this._globalVisibility=null,this._isSymbolTradableResult=new zt.WatchedObject(null),this._formatter=null,this._spreadFormatter=null,this._symbol=null,this._abortController=new AbortController,this.setQty=t=>{this.qty.setValue(String(t))},this._createTradedSymbol=()=>{var t;const e=this._getSymbolName();null===(t=this._symbolChangeSubscription)||void 0===t||t.unsubscribe(),this._clearTradedSymbol(),e.length>0&&this._initTradedSymbol(e)},this._onSuggestedQtyChange=t=>{this._lastSuggestedQty=t,this.setQty(t)},this._updateIsSymbolTradable=async t=>{if(null===this._symbol)return void this._isSymbolTradableResult.setValue(null);const e=await this._realtimeProvider.isTradable(this._symbol);(null==t?void 0:t.aborted)||this._isSymbolTradableResult.setValue((0,Kt.clone)(e))},this._updateIsSymbolTradable=(0,Q.respectLatest)(this._updateIsSymbolTradable),this._isInstantMode=o.noConfirmEnabled.spawn(),this._dataEvents=t,this._getSymbolName=e,this._qtySuggester=r,this._realtimeProvider=s.realtimeProvider,this._onNeedSelectBroker=s.onNeedSelectBroker,this._toggleTradingWidget=s.toggleTradingWidget,this._toggleTradingPanelPopup=s.toggleTradingPanelPopup,this._brokerCommandsUI=s.brokerCommandsUI,this._makeActualTradingSymbolObservable=s.makeActualSymbolObservable,this._updateRealtimeDataHandler=this._updateRealtimeData.bind(this),this._isBrokerConnected=(0,qt.createWVFromGetterAndSubscription)((()=>null!==this._realtimeProvider.activeBroker()),this._realtimeProvider.onStatusChanged),this._isBrokerConnected.subscribe(this._updateQtyTooltip.bind(this),{callWithLast:!0}),this._isBrokerConnected.subscribe(this._updateBrokerIcon.bind(this)),this._isBrokerConnected.subscribe(this._resubscribeQtySuggester.bind(this)),this._isBrokerConnected.subscribe(this._createTradedSymbol),this._isBrokerConnecting=(0,qt.createWVFromGetterAndSubscription)((()=>2===s.brokerConnectionStatus()),s.onBrokerConnectionStatusChange),this._isBrokerConnecting.subscribe(this._updateBrokerIcon.bind(this)),this.visible=new(d())(!1),this.visible.subscribe(this._toggleState.bind(this),{callWithLast:!0}),this._showSellBuyButtons=o.showSellBuyButtons.spawn(),this._isInReplay=n.spawn(),
this._isNonTradableInstrument=i.spawn(),this._showSellBuyButtons.subscribe(this._updateVisibility.bind(this)),this._isInReplay.subscribe(this._updateVisibility.bind(this)),this._isNonTradableInstrument.subscribe(this._updateVisibility.bind(this)),this._updateVisibility(),this._themeName=o.themeName.spawn(),this._themeName.subscribe(this._updateBrokerIcon.bind(this),{callWithLast:!0}),this._tradePossibilityComputedWV=(0,F.combine)((()=>({})),this._isBrokerConnected,this._isSymbolTradableResult,this.ask,this.bid),this._tradePossibilityComputedWV.subscribe(this._updateTradePossibilityAndTooltip.bind(this),{callWithLast:!0}),this._isQtyVisibleComputedWV=(0,F.combine)((()=>({})),this.canTrade,this._isInstantMode),this._isQtyVisibleComputedWV.subscribe(this._updateIsQtyVisible.bind(this),{callWithLast:!0})}destroy(){var t;this._abortController.abort(),this._stop(),this._isBrokerConnected.destroy(),this._showSellBuyButtons.destroy(),this._isInReplay.destroy(),this._isNonTradableInstrument.destroy(),null===(t=this._globalVisibility)||void 0===t||t.destroy(),this._isInstantMode.destroy(),this._tradePossibilityComputedWV.destroy(),this._isQtyVisibleComputedWV.destroy(),this._themeName.destroy()}setGlobalVisibility(t){(0,r.assert)(null===this._globalVisibility,"GlobalVisibility can be set only once"),this._globalVisibility=t.spawn(),this._globalVisibility.subscribe(this._updateVisibility.bind(this),{callWithLast:!0})}async tryToPlaceSellOrder(){await this._tryToPlaceOrder(parseFloat((0,r.ensureNotNull)(this.bid.value())),-1)}async tryToPlaceBuyOrder(){await this._tryToPlaceOrder(parseFloat((0,r.ensureNotNull)(this.ask.value())),1)}async getQtyInfo(){return null!==this._symbol&&this.canTrade.value()?(await this._realtimeProvider.symbolInfo(this._symbol)).qty:null}applyQty(){if(null===this._symbol||!this.canTrade.value())return;const t=this.qty.value(),e=null!==t?Number(t):null;null!==e&&this._qtySuggester.setQty(this._symbol,e),void 0!==this._lastSuggestedQty&&e!==this._lastSuggestedQty&&this.qty.setValue(String(this._lastSuggestedQty))}canShowMobileTrading(){var t;return!(null===(t=window.TradingView.bottomWidgetBar)||void 0===t?void 0:t.isVisible().value())}_updateVisibility(){const t=(null===this._globalVisibility||this._globalVisibility.value())&&this._showSellBuyButtons.value()&&!this._isInReplay.value()&&!this._isNonTradableInstrument.value();this.visible.setValue(t)}async _tryToPlaceOrder(t,e){var i,s;if(null===this._realtimeProvider.activeBroker())return this.canShowMobileTrading()?this._toggleTradingPanelPopup():await this._toggleTradingWidget(),void this._onNeedSelectBroker.fire();const o=Number(this.qty.value())||1,n=this._isMarketOrderSupported()?2:1,a=1===e?null===(i=this._currentQuotes)||void 0===i?void 0:i.ask:null===(s=this._currentQuotes)||void 0===s?void 0:s.bid,l={symbol:(0,r.ensureNotNull)(this._symbol),qty:o,side:e,type:n,seenPrice:null!=a?a:null,currentQuotes:this._currentQuotes};1===n&&(l.limitPrice=t),await(0,r.ensureNotNull)(this._brokerCommandsUI()).placeOrder(l,!0)}_toggleState(t){
t?this._start():this._stop()}_start(){this._dataEvents.symbolResolved().subscribe(this,this._createTradedSymbol),this._dataEvents.symbolError().subscribe(this,this._createTradedSymbol),this._createTradedSymbol()}_stop(){var t;null===(t=this._symbolChangeSubscription)||void 0===t||t.unsubscribe(),this._clearTradedSymbol(),this._symbol=null,this._dataEvents.symbolResolved().unsubscribeAll(this),this._dataEvents.symbolError().unsubscribeAll(this)}_initTradedSymbol(t){this._symbol=t,this._updateIsSymbolTradable(this._abortController.signal),this._realtimeProvider.subscribeRealtime(this._symbol,this._updateRealtimeDataHandler),this._resubscribeQtySuggester()}_clearTradedSymbol(){var t;this._currentQuotes=void 0,this.ask.setValue(null),this.bid.setValue(null),this.spread.setValue(null),this.qty.setValue(null),null!==this._symbol&&(this._realtimeProvider.unsubscribeRealtime(this._symbol,this._updateRealtimeDataHandler),null===(t=this._qtySuggesterSubscription)||void 0===t||t.unsubscribe(),this._symbol=null,this._updateIsSymbolTradable(this._abortController.signal))}async _resubscribeQtySuggester(){var t;const e=this._symbol;if(null===e)return;null===(t=this._qtySuggesterSubscription)||void 0===t||t.unsubscribe();const i=this._suggestedQtyPromise=this._qtySuggester.getQty(e),r=await i;i===this._suggestedQtyPromise&&e===this._symbol&&(this._lastSuggestedQty=r,this.setQty(r),this._qtySuggesterSubscription=this._qtySuggester.suggestedQtyChanged(e).subscribe(this._onSuggestedQtyChange))}_isMarketOrderSupported(){const t=this._realtimeProvider.activeBroker();return null===t||Boolean(t.metainfo().configFlags.supportMarketOrders)}_updateTradePossibilityAndTooltip(){this._updateCanTrade(),this._updateSellBuyTooltip()}_updateCanTrade(){const t=this._isSymbolTradableResult.value(),e=this._isBrokerConnected.value()&&null!==t&&t.tradable;this.canTrade.setValue(e)}_updateSellBuyTooltip(){var t,e;const i=this._getNonTradedTooltip();this.askTooltip.setValue(null!==(t=null!=i?i:this._getAskTooltip())&&void 0!==t?t:Yt),this.bidTooltip.setValue(null!==(e=null!=i?i:this._getBidTooltip())&&void 0!==e?e:te)}_getNonTradedTooltip(){const t=this._isSymbolTradableResult.value();if(null!==t&&!t.tradable)return void 0!==t.solutions?"":void 0!==t.shortReason&&""!==t.shortReason?t.shortReason:this._isBrokerConnected.value()?Zt:Gt}_getAskTooltip(){return null===this.ask.value()?Xt:void 0}_getBidTooltip(){return null===this.bid.value()?Jt:void 0}_updateRealtimeData(t,e,i){this._formatter=i.formatter,this._spreadFormatter=i.spreadFormatter;const r=e.ask,s=e.bid,o=(0,jt.isNumber)(r),n=(0,jt.isNumber)(s),a=o?this._formatter.format(r):null,l=n?this._formatter.format(s):null;this.ask.setValue(a),this.bid.setValue(l),o&&n&&(this._currentQuotes={ask:r,bid:s});const c=e.spread||(0,jt.isNumber)(r)&&(0,jt.isNumber)(s)&&r-s||0,d=(0,jt.isNumber)(e.spread)?this._spreadFormatter:this._formatter;this.spread.setValue(d.format(c));let u=!1;(0,Ht.isFormatterHasForexAdditionalPrecision)(this._formatter)&&(u=this._formatter.hasForexAdditionalPrecision()),
this.hasAskBidAdditionalPrecision.setValue(u)}_updateIsQtyVisible(){const t=this._isInstantMode.value()&&this.canTrade.value();this.isQtyVisible.setValue(t)}_updateQtyTooltip(){this.qtyTooltip.setValue(this._getQtyTooltip())}_getQtyTooltip(){const t=this._realtimeProvider.activeBroker();return null!==t&&t.metainfo().configFlags.showQuantityInsteadOfAmount?re:ie}_updateBrokerIcon(){if(!se)return;let t;const e=this._realtimeProvider.activeBroker();if(null!==e){const i=e.metainfo();t="dark"===this._themeName.value()&&i.logoMiniBlackUrl?i.logoMiniBlackUrl:i.logoMiniUrl}this.brokerIconVisible.setValue(this._isBrokerConnected.value()),this.brokerIconLoading.setValue(this._isBrokerConnecting.value()),this.brokerIconUrl.setValue(t||null)}}var ne=i(973602),ae=i(159255),le=i(343370),ce=i(72304),de=i(462892),ue=i(851237),he=i(673543);class pe extends ue.LoaderBaseRenderer{_renderLoading(t){super._renderLoading(t),this._loadingEl.innerHTML=`\n\t\t\t<span class="${he.loaderCircle}"></span>\n\t\t`,this._loadingEl.classList.add(he.loader)}}var _e=i(521744),ge=i(382280);var me=i(190787),be=i(199056),ye=i(707488),ve=i(844012),fe=i(829883);const ke=parseInt(ve["css-value-padding"]);function Pe(t,e,i,s){let o=t.querySelector(`.${s}`);if(!i)return null!==o&&o.remove(),void(0,me.updateTextNode)(t,e);null===o&&(o=document.createElement("span"),o.classList.add(s),t.appendChild(o)),(0,me.updateTextNode)((0,r.ensureNotNull)(o),e.slice(-1)),(0,me.updateTextNode)(t,e.slice(0,-1))}class Se{constructor({model:t,highButtonsMode:e,trackEvent:i,toggleMinimizeBottomWidgetBar:r}){this.element=document.createElement("div"),this._buttonsWrapperEl=document.createElement("div"),this._informerWrapperEl=null,this._sellButtonEl=document.createElement("div"),this._sellButtonTextEl=document.createElement("span"),this._buyButtonEl=document.createElement("div"),this._buyButtonTextEl=document.createElement("span"),this._spreadQtyWrapper=document.createElement("div"),this._spreadEl=document.createElement("div"),this._qtyEl=document.createElement("div"),this._qtyTextEl=document.createElement("span"),this._brokerButtonEl=document.createElement("div"),this._brokerIconWrapEl=document.createElement("div"),this._isCalcOpened=!1,this._calcContainer=document.createElement("div"),this._sellLoader=new de.LoaderPointsRenderer(this._sellButtonEl,{className:be.loader}),this._buyLoader=new de.LoaderPointsRenderer(this._buyButtonEl,{className:be.loader}),this._brokerLoader=new pe(this._brokerButtonEl,{className:be.circleLoader}),this._windowResizeHandlerThrottle=(0,le.default)(this._windowResizeHandler.bind(this),100),this._isHiddenByViewport=!1,this._mode=2,this._height=new(d())(0),this._resizeObserver=null,this._cachedBreakPoints={},this._parentWidth=0,this._getCurrentQty=()=>{const t=this._qty.value();return null!==t?Number(t):null},this._model=t,this._toggleMinimizeBottomWidgetBar=r,this._ask=this._model.ask.spawn(),this._ask.subscribe(this._updateBuyButton.bind(this)),this._bid=this._model.bid.spawn(),this._bid.subscribe(this._updateSellButton.bind(this)),
this._spread=this._model.spread.spawn(),this._spread.subscribe(this._updateSpread.bind(this)),this._qty=this._model.qty.spawn(),this._qty.subscribe(this._updateQty.bind(this)),this._brokerIconVisible=this._model.brokerIconVisible.spawn(),this._brokerIconVisible.subscribe(this._updateBrokerIconImage.bind(this)),this._brokerIconLoading=this._model.brokerIconLoading.spawn(),this._brokerIconLoading.subscribe(this._updateBrokerIconImage.bind(this)),this._brokerIconUrl=this._model.brokerIconUrl.spawn(),this._brokerIconUrl.subscribe(this._updateBrokerIconImage.bind(this),{callWithLast:!0}),this._trackEvent=i,this._render(),this._askTooltip=this._model.askTooltip.spawn(),this._askTooltip.subscribe(this._updateButtonTooltip.bind(this,this._buyButtonEl),{callWithLast:!0}),this._bidTooltip=this._model.bidTooltip.spawn(),this._bidTooltip.subscribe(this._updateButtonTooltip.bind(this,this._sellButtonEl),{callWithLast:!0}),this._spreadTooltip=this._model.spreadTooltip.spawn(),this._spreadTooltip.subscribe(this._updateButtonTooltip.bind(this,this._spreadEl),{callWithLast:!0}),this._qtyTooltip=this._model.qtyTooltip.spawn(),this._qtyTooltip.subscribe(this._updateButtonTooltip.bind(this,this._qtyEl),{callWithLast:!0}),this._canTrade=this._model.canTrade.spawn(),this._canTrade.subscribe(this._updateBgButtonsMode.bind(this),{callWithLast:!0}),this._isVisible=this._model.visible.spawn(),this._isVisible.subscribe(this._updateVisibility.bind(this),{callWithLast:!0}),this._isQtyVisible=this._model.isQtyVisible.spawn(),this._isQtyVisible.subscribe(this._updateQtyVisibility.bind(this),{callWithLast:!0}),this._isLastDigitSup=this._model.hasAskBidAdditionalPrecision.spawn(),this._isLastDigitSup.subscribe(this._updateLastDigitSup.bind(this)),this._highButtonsMode=e.spawn(),this._highButtonsMode.subscribe(this._updateHighButtonsMode.bind(this),{callWithLast:!0}),this._sellButtonHandler=this._onSellButton.bind(this),this._buyButtonHandler=this._onBuyButton.bind(this),this._qtyHandler=this._toggleCalcVisibility.bind(this),this._brokerButtonHandler=this._onBrokerButton.bind(this),this._sellButtonEl.addEventListener("click",this._sellButtonHandler),this._buyButtonEl.addEventListener("click",this._buyButtonHandler),this._qtyEl.addEventListener("click",this._qtyHandler),this._brokerButtonEl.addEventListener("click",this._brokerButtonHandler),window.addEventListener("resize",this._windowResizeHandlerThrottle),this._windowResizeHandler()}destroy(){var t;this._ask.destroy(),this._askTooltip.destroy(),this._bid.destroy(),this._bidTooltip.destroy(),this._spread.destroy(),this._spreadTooltip.destroy(),this._qty.destroy(),this._qtyTooltip.destroy(),this._isVisible.destroy(),this._isQtyVisible.destroy(),this._isLastDigitSup.destroy(),this._highButtonsMode.destroy(),this._canTrade.destroy(),this._brokerIconUrl.destroy(),this._sellButtonEl.removeEventListener("click",this._sellButtonHandler),this._buyButtonEl.removeEventListener("click",this._buyButtonHandler),this._qtyEl.removeEventListener("click",this._qtyHandler),
this._brokerButtonEl.removeEventListener("click",this._brokerButtonHandler),null===(t=this._resizeObserver)||void 0===t||t.disconnect(),this._resizeObserver=null,this.element.remove(),delete this.element,window.removeEventListener("resize",this._windowResizeHandlerThrottle)}updateModeByWidth(t){var e;const i=this._cachedBreakPoints[0],r=this._cachedBreakPoints[1];this._mode=void 0!==i&&t<i?0:void 0!==r&&t<r?1:2,this._parentWidth=t;const s=1===this._mode;this._buttonsWrapperEl.classList.toggle(be.column,s),null===(e=this._informerWrapperEl)||void 0===e||e.classList.toggle(be.column,s),this._updateVisibility()}height(){return this._height}renderTo(t,e){void 0!==e?t.insertBefore(this.element,e):t.appendChild(this.element),null===this._resizeObserver&&(this._resizeObserver=new ae.default(this._updateBreakPointsAndSize.bind(this))),this._resizeObserver.unobserve(this.element),this._resizeObserver.observe(this.element)}isHiddenByViewport(){return this._isHiddenByViewport}_render(){const t=this._bid.value()||"...";this._sellButtonTextEl.appendChild(document.createTextNode(t)),this._sellButtonTextEl.classList.add(be.buttonText),this._sellButtonEl.append(this._sellButtonTextEl),this._sellButtonEl.classList.add("apply-common-tooltip",be.button,be.sellButton);const e=this._spread.value()||"";this._spreadEl.appendChild(document.createTextNode(String(e))),this._spreadEl.classList.add("apply-common-tooltip",be.spread);const i=this._qty.value()||"";this._qtyTextEl.appendChild(document.createTextNode(i)),this._qtyEl.append(this._qtyTextEl),this._qtyEl.setAttribute("data-name","qtyEl"),this._qtyEl.classList.add("apply-common-tooltip",be.button,be.qty),this._spreadQtyWrapper.classList.add(be.spreadQtyWrapper),this._spreadQtyWrapper.appendChild(this._spreadEl),this._spreadQtyWrapper.appendChild(this._qtyEl);const r=this._ask.value()||"...";this._buyButtonTextEl.appendChild(document.createTextNode(String(r))),this._buyButtonTextEl.classList.add(be.buttonText),this._buyButtonEl.append(this._buyButtonTextEl),this._buyButtonEl.classList.add("apply-common-tooltip",be.button,be.buyButton),this._brokerButtonEl.appendChild(this._brokerIconWrapEl),this._brokerIconWrapEl.classList.add(be.brokerButtonIconWrap),this._brokerButtonEl.classList.add(be.brokerButton),this._buttonsWrapperEl.appendChild(this._sellButtonEl),this._buttonsWrapperEl.appendChild(this._spreadQtyWrapper),this._buttonsWrapperEl.appendChild(this._buyButtonEl),this._buttonsWrapperEl.appendChild(this._brokerButtonEl),this._buttonsWrapperEl.classList.add(be.buttonsWrapper),this._buttonsWrapperEl.classList.toggle(be.touchMode,_e.trackingModeIsAvailable),this._buttonsWrapperEl.classList.toggle(be.notAvailableOnMobile,false),this.element.appendChild(this._buttonsWrapperEl),this._initTradingInformer(),this.element.classList.add(be.container)}_initTradingInformer(){0}_updateBreakPointsAndSize(t){const e=t[0],i=2*ke;2===this._mode&&(this._cachedBreakPoints[1]=Math.round(e.contentRect.width)+i),1===this._mode&&(this._cachedBreakPoints[0]=Math.round(e.contentRect.width)+i),
this.updateModeByWidth(this._parentWidth);const r=e.contentRect.height>0?Math.round(e.contentRect.height)+i:0;this._height.setValue(r)}_updateBrokerIconImage(){const t=this._brokerIconLoading.value(),e=!this._brokerIconVisible.value()&&!t;if(this._brokerButtonEl.classList.toggle(ye.blockHidden,e),e)return;if(this._toggleLoaderVisibility(this._brokerButtonEl,this._brokerLoader,t),t)return void(this._brokerIconWrapEl.innerHTML="");const i=this._brokerIconUrl.value(),r=null===i;this._brokerIconWrapEl.innerHTML=r?fe:`<image src="${i}" alt="Account Manager" />`,this._brokerButtonEl.classList.toggle(be.brokerButtonDefault,r)}async _onSellButton(){if(null===this._bid.value())return;const t=this._highButtonsMode.value();this._trackEvent("Sell/Buy Buttons","Sell",t?"Instant":"Not Instant"),t&&this._canTrade.value()&&this._toggleLoaderVisibility(this._sellButtonEl,this._sellLoader,!0),await this._model.tryToPlaceSellOrder(),t&&this._canTrade.value()&&setTimeout((()=>this._toggleLoaderVisibility(this._sellButtonEl,this._sellLoader,!1)),300)}async _onBuyButton(){if(null===this._ask.value())return;const t=this._highButtonsMode.value();this._trackEvent("Sell/Buy Buttons","Buy",t?"Instant":"Not Instant"),t&&this._canTrade.value()&&this._toggleLoaderVisibility(this._buyButtonEl,this._buyLoader,!0),await this._model.tryToPlaceBuyOrder(),t&&this._canTrade.value()&&setTimeout((()=>this._toggleLoaderVisibility(this._buyButtonEl,this._buyLoader,!1)),300)}_onBrokerButton(){this._model.canShowMobileTrading()?async function(){(await(0,ge.waitTradingService)()).tradingPanelPopup.show()}():this._toggleMinimizeBottomWidgetBar()}_toggleLoaderVisibility(t,e,i){t.classList.toggle(be.loading,i),e.toggleVisibility(i)}_updateBuyButton(t){const e=null!==t&&this._isLastDigitSup.value();Pe(this._buyButtonTextEl,`${t||"..."}`,e,be.lastCharSup)}_updateSellButton(t){const e=null!==t&&this._isLastDigitSup.value();Pe(this._sellButtonTextEl,`${t||"..."}`,e,be.lastCharSup)}_updateSpread(t){const e=`${t||""}`;(0,me.updateTextNode)(this._spreadEl,e),this._updateVisibilityForSpreadQtyWrapper()}_updateQty(t){let e=`${t||""}`;!this._isCalcOpened&&e.length>0&&(e=(0,R.abbreviatedNumber)(Number(e))),(0,me.updateTextNode)(this._qtyTextEl,e)}_updateHighButtonsMode(t){this._buttonsWrapperEl.classList.toggle(be.highButtons,t)}_updateBgButtonsMode(t){var e;this._buttonsWrapperEl.classList.toggle(be.withoutBg,!t),null===(e=this._informerWrapperEl)||void 0===e||e.classList.toggle(ye.blockHidden,!t)}_updateVisibilityForSpreadQtyWrapper(){const t=!this._isQtyVisible.value()&&null===this._spread.value();this._spreadQtyWrapper.classList.toggle(ye.blockHidden,t)}_updateQtyVisibility(t){this._qtyEl.classList.toggle(ye.blockHidden,!t),this._spreadQtyWrapper.classList.toggle(be.withoutQty,!t),this._updateVisibilityForSpreadQtyWrapper()}_updateVisibility(){var t;const e=this._isVisible.value()&&0!==this._mode&&!this._isHiddenByViewport;this._buttonsWrapperEl.classList.toggle(ye.blockHidden,!e),
null===(t=this._informerWrapperEl)||void 0===t||t.classList.toggle(ye.blockHidden,!e||!this._canTrade.value())}_updateLastDigitSup(){this._updateBuyButton(this._ask.value()),this._updateSellButton(this._bid.value())}_updateButtonTooltip(t,e){if(""===e)return(0,ce.setTooltipData)(t,"text",e),void t.removeAttribute("title");t.setAttribute("title",e)}_toggleCalcVisibility(){this._isCalcOpened=!this._isCalcOpened,this._renderCalc()}_closeCalc(){this._isCalcOpened=!1,this._updateQty(this._qty.value()),this._model.applyQty(),this._renderCalc()}_renderCalc(){Promise.all([i.e(580),i.e(8194),i.e(7845),i.e(4474),i.e(9872),i.e(7125),i.e(3809)]).then(i.bind(i,713191)).then((async t=>{const e=await this._model.getQtyInfo();null!==e&&t.render(this._isCalcOpened,this._calcContainer,{...e,withInput:!0,valueGetter:this._getCurrentQty,position:this._getCalcPosition(),targetEl:this._qtyEl,onClose:this._closeCalc.bind(this),onValueChange:this._model.setQty,trackEventTarget:"Sell/Buy Buttons",trackEvent:this._trackEvent})}))}_getCalcPosition(){const t=this._qtyEl.getBoundingClientRect();return{x:t.left,y:t.bottom+2}}_windowResizeHandler(){false!==this._isHiddenByViewport&&(this._isHiddenByViewport=false,this._updateVisibility())}}const Ce=s.t(null,void 0,i(73953));class we{constructor(t,e,i,r,s,o,n){this._showSellBuyButtons=o.showSellBuyButtons,this._isEconomySymbol=i,this._isInReplay=n,this._trackEvent=s.trackEvent,this._model=new oe({dataEvents:t,getSymbolName:e,isNonTradableInstrument:i,qtySuggester:r,tradingCommands:s,settings:o,isInReplay:n}),this._renderer=new Se({model:this._model,highButtonsMode:o.noConfirmEnabled,trackEvent:s.trackEvent,toggleMinimizeBottomWidgetBar:s.toggleMinimizeBottomWidgetBar})}destroy(){this._model.destroy(),this._renderer.destroy()}renderTo(t,e){this._renderer.renderTo(t,e)}setGlobalVisibility(t){this._model.setGlobalVisibility(t)}visibility(){return this._model.visible}updateWidgetModeBySize(t){this._renderer.updateModeByWidth(t.width)}contextMenuActions(){if(this._renderer.isHiddenByViewport())return[];return[new ne.Action({actionId:"Trading.SellBuyButtonsToggleVisibility",checkable:!0,checked:this._showSellBuyButtons.value(),label:Ce,disabled:this._isInReplay.value()||this._isEconomySymbol.value(),onExecute:()=>{const t=!this._showSellBuyButtons.value();this._showSellBuyButtons.setValue(t),this._trackEvent("SellBuyButtonsWidget context menu","Show Sell/Buy Button",t?"Check":"Uncheck")}})]}height(){return this._renderer.height()}}var Be=i(500962),Te=i(19406),Oe=i(533408),Ee=i(640712);const Le=mt.forwardRef(((t,e)=>mt.createElement("div",{ref:e,className:Ee.popupWrapper},t.children)));var De=i(753327);const Ie=(()=>{let t,e,r,s=null,o=null;return async(n,a,l,c)=>{const u=null==n?void 0:n.currentAccount();if(null===s||o!==n||t!==u||r!==c){null==e||e.remove()
;const{AccountManager:h}=await Promise.all([i.e(2666),i.e(3842),i.e(6),i.e(5993),i.e(5649),i.e(8056),i.e(3502),i.e(4015),i.e(9842),i.e(7080),i.e(6884),i.e(3889),i.e(8992),i.e(1033),i.e(7677),i.e(7114),i.e(832),i.e(9255),i.e(8210),i.e(6216),i.e(9835),i.e(9937),i.e(8413),i.e(9781),i.e(1071),i.e(8354)]).then(i.bind(i,825012)),p={container:a,visible:new(d())(!0)};s=a,o=n,t=u,r=c,e=await h.create({broker:n,bridge:p,mode:0,overlapManager:l,summaryFieldsVisibilityManager:c})}else a.appendChild(s)}})(),Ae=new(d())(null);function Ne(t){const{broker:e,summaryFieldsVisibilityManager:i}=t,r=(0,mt.useRef)(null),s=(0,mt.useContext)(De.SlotContext);return(0,mt.useEffect)((()=>{Ae.setValue(s)}),[s]),(0,mt.useEffect)((()=>{null!==r.current&&Ie(e,r.current,Ae.readonly(),i)}),[]),mt.createElement(Le,{ref:r})}var Me=i(665276),Ve=i(407999),xe=i(241347),Re=i(744633);function Fe(t){return mt.createElement("span",{className:Re.separator})}var qe=i(783806),Ue=i(112235),We=i(517516);const Qe=s.t(null,void 0,i(890801));class $e extends Te.DialogRenderer{constructor(t){super(),this._title=Qe,this._isSubscribed=!1,this._showSeparator=!0,this._handleClose=()=>{Be.unmountComponentAtNode(this._container),this._setVisibility(!1)},this._trading=t}visible(){return this._visibility.spawn().readonly()}show(){this._isSubscribed||(this._isSubscribed=!0,this._onStatusChange(this._trading.connectStatus()),this._trading.onConnectionStatusChange.subscribe(this,this._onStatusChange)),this._setVisibility(!0),this._renderComponent()}hide(){this._handleClose()}_onStatusChange(t,e){var i,r;null===(i=this._trading.activeBroker())||void 0===i||i.currentAccountUpdate.unsubscribe(this,this._renderAccountManager),this._connectStatus!==t&&(this._connectStatus=t,this._additionalHeaderElement=void 0,window.navigator.onLine?2!==t&&(null==e?void 0:e.disconnectType)!==L.DisconnectType.Offline&&3!==t&&4!==t?1===t&&(null===(r=this._trading.activeBroker())||void 0===r||r.currentAccountUpdate.subscribe(this,this._renderAccountManager),this._renderAccountManager()):this._renderSpinner():this._renderOfflineScreen())}_renderComponent(){Be.render(mt.createElement(Oe.AdaptivePopupDialog,{dataName:"trading-dialog",isOpened:this.visible().value(),onClose:this._handleClose,showSeparator:this._showSeparator,fullScreen:!0,draggable:!1,title:this._title,render:()=>this._content,additionalHeaderElement:this._additionalHeaderElement,additionalElementPos:"after"}),this._container)}_renderSpinner(){this._showSeparator=!0,this._title=Qe,this._changeDialogContent(mt.createElement(Me.Spinner,null))}_renderOfflineScreen(){this._title=Qe,this._changeDialogContent(mt.createElement(Ue.OfflineScreen,null))}async _renderBrokerSelectScreen(){0}async _renderAccountManager(){const t=(0,r.ensureNotNull)(this._trading.activeBroker()).accountManagerInfo().summary,e=new xe.SummaryFieldsVisibilityManager(t,this._trading.getBrokerTradingSettingsStorage),s=await(0,Ve.makeAccountManagerHeaderDropdownsProps)(this._trading,e);if(this._showSeparator=!1,this._title=Qe,void 0!==s){
const{AccountManagerHeaderDropdowns:t}=await Promise.all([i.e(2666),i.e(3842),i.e(6),i.e(5993),i.e(5649),i.e(8056),i.e(3502),i.e(4015),i.e(9842),i.e(7080),i.e(6884),i.e(3889),i.e(8992),i.e(1033),i.e(7677),i.e(7114),i.e(832),i.e(9255),i.e(8210),i.e(6216),i.e(9835),i.e(9937),i.e(8413),i.e(9781),i.e(1071),i.e(8354)]).then(i.bind(i,605899));s.accountDropdownProps.mode=0,this._title=mt.createElement(t,{...s});{const t={...s.commonDropdownProps,iconSize:"big"};this._additionalHeaderElement=mt.createElement("span",{className:We.moreButton},mt.createElement(qe.TerminalDropdown,{...t}),mt.createElement(Fe,null))}}this._content=mt.createElement(Ne,{broker:this._trading.activeBroker(),summaryFieldsVisibilityManager:e}),this._renderComponent()}_changeDialogContent(t){this._content=mt.createElement(Le,null,t),this._renderComponent()}}var je,ze=i(948776),He=i(601227);async function Ke(t,e){localStorage.setItem(t,e)}!function(t){t.get=async function(){return He.CheckMobile.any()||await async function(){const t=o.getValue(z.settingsKeys.ACTIVE_BROKER);if(o.remove(z.settingsKeys.ACTIVE_BROKER,{forceFlush:!0}),void 0===t)return;await Ke(z.settingsKeys.ACTIVE_BROKER,t)}(),async function(t){return localStorage.getItem(t);const e=localStorage.getItem(t);if(null===e)return null;const i=await userSpecificDecrypt(e);null===i&&localStorage.removeItem(t);return i}(z.settingsKeys.ACTIVE_BROKER)},t.set=async function(t){await Ke(z.settingsKeys.ACTIVE_BROKER,t)},t.clear=function(){o.remove(z.settingsKeys.ACTIVE_BROKER,{forceFlush:!0}),localStorage.removeItem(z.settingsKeys.ACTIVE_BROKER)}}(je||(je={}));var Ge=i(960521),Ze=i.n(Ge),Je=i(173587),Xe=i(233064),Ye=i(218286),ti=i(169977),ei=i(312694),ii=i(749401),ri=i(265728),si=i(482165),oi=i(44681),ni=i(99708);class ai{constructor(t){this._rawAndFilteredQtyMap=new Map,this._qtyInfo=new Map;const{symbolInfoGetter:e,onResetNeeded:i,qtySettingsStorageGetter:r}=t;this._getQtySettingsStorage=r,this._getSymbolInfo=e,i.subscribe(this,this._reset)}async getQty(t){return(0,ii.firstValueFrom)(this._getRawAndFilteredQty(t).filteredQty$)}setQty(t,e){this._getRawAndFilteredQty(t).rawQty$.next(e)}suggestedQtyChanged(t){return this._getRawAndFilteredQty(t).filteredQty$.pipe((0,Je.skip)(1))}_getRawAndFilteredQty(t){var e;return null!==(e=this._rawAndFilteredQtyMap.get(t))&&void 0!==e?e:this._makeRawAndFilteredQty(t)}_makeRawAndFilteredQty(t){const e=new ri.ReplaySubject(1),i=this._getInitialQty(t).pipe((0,Xe.switchMap)((t=>e.pipe((0,C.startWith)(t)))),(0,Ye.distinctUntilChanged)(),(0,ti.filter)((e=>this._isQtyCorrect(t,e))),(0,si.tap)((e=>{var i;return null===(i=this._getQtySettingsStorage())||void 0===i?void 0:i.setSymbolQty(t,e)})),(0,ei.share)({connector:()=>new ri.ReplaySubject(1),resetOnRefCountZero:!1})),r={rawQty$:e,filteredQty$:i};return this._rawAndFilteredQtyMap.set(t,r),r}_isQtyCorrect(t,e){const i=(0,r.ensureDefined)(this._qtyInfo.get(t));return!(0,ni.checkQtyError)(i,e,!0).res}_getInitialQty(t){return(0,T.from)(this._getSymbolInfo(t)).pipe((0,k.map)((({qty:e})=>{var i;this._qtyInfo.set(t,e)
;const r=null===(i=this._getQtySettingsStorage())||void 0===i?void 0:i.symbolQty(t),s=e.default||e.min;return void 0!==r&&r>0?(o=(0,oi.clamp)(r,e.min,e.max),n=e.min,a=e.step,Ze()(o).minus(n).div(a).round(0,1).mul(a).plus(n).toNumber()):s;var o,n,a})))}_reset(){this._rawAndFilteredQtyMap.forEach((({rawQty$:t})=>t.complete())),this._rawAndFilteredQtyMap.clear(),this._qtyInfo.clear()}}var li=i(316230);class ci{constructor(){this._context=null,this._onContextChanged=new(U()),this._contextChange=()=>{this._onContextChanged.fire(this.context())}}context(){var t,e;return null!==(e=null===(t=this._context)||void 0===t?void 0:t.externalContext())&&void 0!==e?e:null}setContext(t){var e;this._isEqualContexts(t)||(this._clearSubscription(),this._context=t,null===(e=this._context)||void 0===e||e.onStatusChange().subscribe(this,this._contextChange),this._contextChange())}onContextChanged(){return this._onContextChanged}clear(){this.setContext(null)}_clearSubscription(){var t;null===(t=this._context)||void 0===t||t.onStatusChange().unsubscribeAll(this)}_isEqualContexts(t){var e;return null===this._context||null===t?this._context===t:(null===(e=this.context())||void 0===e?void 0:e.type)===(null==t?void 0:t.externalContext().type)&&(this._context.status()===t.status()&&(0,li.default)(this._context.errors(),t.errors())&&(0,li.default)(this._context.data(),t.data()))}}var di=i(688401);class ui{constructor(t){this._onSymbolChange=t=>{this._processSymbol(null,null!=t?t:di.linking.symbol.value())},this._processSymbol=async(t,e)=>{if(void 0===this._continuousFrontContractExtractor)return void this._value.next({symbol:e});const i=this._continuousFrontContractExtractor.makeValueObservable(e).subscribe((t=>this._value.next(t)));null==t||t.addEventListener("abort",(()=>i.unsubscribe()),{once:!0})},this._getContinuousFrontContractExtractor=t;const e=di.linking.proSymbol.value();this._value=new v.BehaviorSubject({symbol:e});void 0!==(this._continuousFrontContractExtractor=t())&&this._onSymbolChange(e),this._processSymbol=(0,Q.respectLatest)(this._processSymbol),di.linking.proSymbol.subscribe(this._onSymbolChange)}reset(){this._continuousFrontContractExtractor=this._getContinuousFrontContractExtractor(),this._onSymbolChange(di.linking.proSymbol.value())}value(){return this._value.getValue()}async setSymbol(t){const e=(0,ii.firstValueFrom)(this._value.pipe((0,ti.filter)((e=>e.continuous===t||void 0===e.continuous&&e.symbol===t))));di.linking.symbol.setValue(t),await e}valueObservable(){return this._value.asObservable()}}class hi{constructor(t){this._transientStorage={},this._persistentStorageKey=`trading.${t}`;const e=o.getJSON(this._persistentStorageKey,{});delete e.orderTicketQuantity,this._transientStorage=e}setTakeProfitPips(t,e,i){this._setPips("takeProfit",t,e,i)}takeProfitPips(t){return this._getSectionValue("takeProfit",t)}setStopLossPips(t,e,i){this._setPips("stopLoss",t,e,i)}stopLossPips(t){return this._getSectionValue("stopLoss",t)}setDuration(t,e,i){const r=this.duration(t,e)
;null!==i&&void 0!==r&&r.type===i.type&&r.datetime===i.datetime||null===i&&void 0===r||(this._setDuration(t,e,i),this._syncStorage())}duration(t,e){var i;return this._migrateDuration(t,e),null===(i=this._getSectionValue("duration",t))||void 0===i?void 0:i[e]}setSymbolQty(t,e){this._getOrCreateSection("qty")[t]=e,this._syncStorage()}symbolQty(t){return this._getSectionValue("qty",t)}setCustomFields(t,e,i){var r,s,o;const n=this._getOrCreateSection("customFields");null!==(r=n[t])&&void 0!==r||(n[t]={}),null!==(s=(o=n[t])[e])&&void 0!==s||(o[e]={});const a=n[t][e];for(const[t,e]of Object.entries(i))"string"==typeof e&&""!==e||"boolean"==typeof e?a[t]=e:delete a[t];0===Object.keys(a).length&&delete n[t][e],0===Object.keys(n[t]).length&&delete n[t],this._syncStorage()}customFields(t,e,i){this._migrateCustomFields(t,e,i);const r={},s=this._transientStorage.customFields;if(void 0===s||void 0===s[t])return r;const o=s[t][e];return void 0===o||i.forEach((t=>{const e=o[t];""!==e&&void 0!==e&&(r[t]=e)})),r}orderType(t){return this._getSectionValue("orderType",t)}setOrderType(t,e){this._getOrCreateSection("orderType")[t]=e,this._syncStorage()}setTableColumnsOrder(t,e){this._getOrCreateSection("tableColumnsOrder")[t]=e,this._syncStorage()}tableColumnsOrder(t){return this._getSectionValue("tableColumnsOrder",t)}summaryFieldsVisibilityInfo(){const t=new Map,e=this._transientStorage.summaryFields;if(void 0===e)return t;for(const[i,r]of Object.entries(e))t.set(i,{id:i,visible:r});return t}setSummaryFieldsVisibilityInfo(t){t.forEach((({id:t,visible:e})=>{this._getOrCreateSection("summaryFields")[t]=e})),this._syncStorage()}_getOrCreateSection(t){return t in this._transientStorage||(this._transientStorage[t]={}),this._transientStorage[t]}_getSectionValue(t,e){const i=this._transientStorage[t];return void 0!==i?i[e]:void 0}_removeValue(t,e){const i=this._transientStorage[t];void 0!==i&&(delete i[e],0===Object.keys(i).length&&delete this._transientStorage[t])}_setPips(t,e,i,r){const s=this._getSectionValue(t,e);if(!(void 0!==s&&s===i||void 0===s&&i===r)){if(void 0!==s&&i===r)this._removeValue(t,e);else{this._getOrCreateSection(t)[e]=i}this._syncStorage()}}_setDuration(t,e,i){var r;const s=this._getOrCreateSection("duration");if(null===i){if(void 0===s[t])return;return delete s[t][e],void(0===Object.keys(s[t]).length&&delete s[t])}null!==(r=s[t])&&void 0!==r||(s[t]={}),s[t][e]=i}_migrateCustomFields(t,e,i){const r={},s=this._transientStorage.customFields;void 0===s||"object"==typeof s&&void 0!==s[t]||(i.forEach((e=>{const i=s[`${t}.${e}`];""!==i&&void 0!==i&&(r[e]=i,this._removeValue("customFields",`${t}.${e}`))})),this.setCustomFields(t,e,r))}_migrateDuration(t,e){const i=this._getSectionValue("duration",t);if("string"!=typeof i)return;const r={type:i},s=this._getSectionValue("durationDatetime",t);"number"==typeof s&&(r.datetime=s,this._removeValue("durationDatetime",t)),this._removeValue("duration",t),this._setDuration(t,e,r),this._syncStorage()}_syncStorage(){o.setJSON(this._persistentStorageKey,this._transientStorage)}}
var pi=i(951983),_i=i(472382),gi=i(198083);const mi=(0,l.getLogger)("Trading.Core"),bi={1:"Connected",2:"Connecting",3:"Disconnected",4:"Error"},yi="alert/alarm_clock";function vi(t){return m().some((e=>t===e.path))}const fi=x.enabled("buy_sell_buttons"),ki=!0;window.TRADING_SERVER_LOGGER_URL;class Pi{constructor(t,e){this.accountType=new(d()),this.onBrokerChange=new(U()),this.onBrokerLoading=new(U()),this.onConnectionStatusChange=new(U()),this.onNewNotification=new(U()),this.onNeedSelectBroker=new(U()),this.onNotificationsChanged=new(U()),this.showTradedSources=new(d())(!0),this.showSellBuyButtons=new(d()),this.noConfirmEnabled=new(d()),this.showOnlyRejectionNotifications=new(d()),this.showPricesWithZeroVolume=new(d()),this.showSpread=new(d()),this.orderExecutedSoundParams=function(){const t=vi(yi)?yi:m()[0].path;return{enabled:new(d())(!1),path:new(d())(t)}}(),this._activeBroker=null,this._orderViewController=null,this._orderControllerPromise=null,this._brokerCommandsUI=null,this._showPricesWithZeroVolume=new(d()),this._showSpread=new(d()),this._closePositionDialogVisibility=new $.DialogVisibility,this._orderDialogVisibility=new $.DialogVisibility,this._loginDialogVisibility=new $.DialogVisibility,this._tradingPanelPopupVisibility=new $.DialogVisibility,this._tradingSettingsStorage=null,this._offlineListener=this._offlineHandler.bind(this),this._onlineListener=this._onlineHandler.bind(this),this._notifications=[],this._account=null,this._domPanelVisibility=new(d())(!1),this._orderPanelVisibility=new(d())(!1),this._pipValueType$=new v.BehaviorSubject(L.PipValueType.None),this._switchingBroker=!1,this._isReconnectNeeded=!1,this._accountVerificationPromise=null,this._chartWidgetCollection=null,this._tradedItemsChartCollectionFacadePromise=null,this._tradeNowBrokerId=null,this.getBrokerTradingSettingsStorage=()=>this._tradingSettingsStorage,this.trackEvent=(t,e,i)=>{const r=t?`[${t}] ${e}`:e;if(this._gui()){const t=this._activeBroker?this._activeBroker.metainfo().id+" Trading":"Trading No Broker",e=this._activeBroker?this._activeBroker.currentAccountType():void 0;this._gui().trackEvent(t,r,i||e)}},this.setDOMPanelVisibility=t=>{t?this.tradingPanel.openPage(wt.TradingPage.DOMPanel):this.tradingPanel.close()},this.setOrderPanelVisibility=async t=>{const{openPanel:e,closePanel:i}=await this._getOrderViewController();t?await e():await i()},this.getTradeNowBrokerId=()=>this._tradeNowBrokerId,this.clearTradeNowBrokerId=()=>{this._tradeNowBrokerId=null},this._handleVisibilityChange=()=>{null!==this._activeBroker&&this._activeBroker.metainfo().configFlags.usesWSConnection&&"visible"!==document.visibilityState&&(this._isReconnectNeeded=!0,this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!1,disconnectInfo:{disconnectType:L.DisconnectType.BrokenConnection}}).then((()=>{if(this._isReconnectNeeded)return this._tryReconnectLastBroker()})))},this._tryReconnectLastBroker=async()=>{if(this._isReconnectNeeded){
if("hidden"===document.visibilityState)return window.addEventListener("visibilitychange",this._tryReconnectLastBroker,{once:!0});this._isReconnectNeeded=!1,await this._selectLastBroker()}},this._onCurrentAccountUpdate=()=>{const t=(0,r.ensureNotNull)(this._activeBroker).currentAccount();this._account!==t&&(this._tradedContextLinking.clear(),this._account=t,this.onNotificationsChanged.fire(this.getNotifications()))},this._onFullScreenDialogOpen=()=>{this._guiAccessor.closeAllNotifications()},this._setPipValueType=async()=>{const{symbol:t}=this._linking.value(),{type:e}=await this._realtimeProvider.symbolInfo(t),i="forex"===e?L.PipValueType.Pips:L.PipValueType.Ticks;this._pipValueType$.next(i)},this._trackNonTradableSymbol=async()=>{var t;if(1===(null===(t=this._activeBroker)||void 0===t?void 0:t.connectionStatus())){const{symbol:t}=this._linking.value();if(void 0===t)return;const e=await this._activeBroker.isTradable(t);e&&!e.tradable&&this.trackEvent("Symbol is not tradable",t)}},this._onBrokerChanged=t=>{if(null===t)return void(this._tradingSettingsStorage=null);const e=t.metainfo();this._tradingSettingsStorage=new hi(e.id)},this._tradeNow=async()=>{if(void 0!==window.TradingView.bottomWidgetBar&&null!==this._tradeNowBrokerId)try{await window.TradingView.bottomWidgetBar.toggleWidget("paper_trading",!0)}catch(t){this._tradingWizard.drawAttention()}},this._updateTradingPanelVisibility=t=>{const{isOpeningAvailable:e=this.tradingPanel.isOpeningAvailable.value(),isOpened:i=this.tradingPanel.isOpened.value(),activePage:r=this.tradingPanel.activePage.value()}=t;e&&i?r===wt.TradingPage.OrderPanel?this.setOrderPanelVisibility(!0):this.setDOMPanelVisibility(!0):r===wt.TradingPage.OrderPanel?this.setOrderPanelVisibility(!1):this.setDOMPanelVisibility(!1)},this._linking=new ui((()=>this._continuousFrontContractExtractor)),this._setPipValueType=(0,V.sequentialize)(this._setPipValueType),this._selectBrokerInternal=(0,V.sequentialize)(this._selectBrokerInternal),this._showSellBuyButtonsKey=this._makeShowSellBuyButtonsKey(),this._resizerBridge=t,this._realtimeProvider=new X((()=>this.activeBroker()),this.onBrokerChange,this.onConnectionStatusChange,(t=>this.getActualSymbol(t))),this._positionService=new Qt.PositionsService(this),this._ordersService=new $t.OrdersService(this),this._tradingStat=new tt(this),this._serverLogger=null,this._tradedContextLinking=new ci,this.onBrokerChange.subscribe(this,this._onBrokerChanged),this.tradingPanelPopup=new $e(this),this.tradingPanelPopup.visible().subscribe((t=>{t?(this._tradingPanelPopupVisibility.setValue({isVisible:t,isFullScreen:!0}),this._onFullScreenDialogOpen()):this._tradingPanelPopupVisibility.setValue({isVisible:t})})),this.tradingPanel=new Ot(t);this._qtySuggester=new ai({onResetNeeded:this.onConnectionStatusChange,symbolInfoGetter:t=>this._realtimeProvider.symbolInfo(t),qtySettingsStorageGetter:()=>this._tradingSettingsStorage});const i=new St(t,(()=>this.tradingPanel.close()),this,this._qtySuggester,this._linking);this.tradingPanel.addPage(wt.TradingPage.DOMPanel,i)
;const s=new Ct;this.tradingPanel.addPage(wt.TradingPage.OrderPanel,s);{const t=o.getValue(z.settingsKeys.TRADING_PANEL_ACTIVE_PAGE),e=o.getBool(z.settingsKeys.TRADING_PANEL_OPENED,x.enabled("show_order_panel_on_start"));this._updateTradingPanelVisibility({isOpened:e,activePage:t}),this.tradingPanel.isOpeningAvailable.subscribe((async t=>{this._updateTradingPanelVisibility({isOpeningAvailable:t})}))}(0,F.combine)((()=>({})),this.tradingPanel.activePage,this.tradingPanel.isOpened).subscribe((()=>{this._domPanelVisibility.setValue(this.tradingPanel.isPageOpened(wt.TradingPage.DOMPanel)),this._orderPanelVisibility.setValue(this.tradingPanel.isPageOpened(wt.TradingPage.OrderPanel))})),this.closePositionDialogVisibility=this._closePositionDialogVisibility.value$,this.orderDialogVisibility=this._orderDialogVisibility.value$,this.loginDialogVisibility=this._loginDialogVisibility.value$,this.possibleFullScreenDialogsVisibility=(0,f.merge)(this.closePositionDialogVisibility.pipe((0,k.map)((t=>({...t,name:"close-position-dialog"})))),this.orderDialogVisibility.pipe((0,k.map)((t=>({...t,name:"order-dialog"})))),this.loginDialogVisibility.pipe((0,k.map)((t=>({...t,name:"login-dialog"})))),this._tradingPanelPopupVisibility.value$.pipe((0,k.map)((t=>({...t,name:"trading-panel-popup"})))))}setChartWidgetCollection(t){(0,r.assert)(null===this._chartWidgetCollection,"ChartWidgetCollection can be set only once"),this._chartWidgetCollection=t,this._guiAccessor=new ot(t),new Mt(this),this._loadState(),o.onSync.subscribe(this,this._loadState);const e=()=>{this._save()};this.showSellBuyButtons.subscribe(e),this.noConfirmEnabled.subscribe(e),this.showOnlyRejectionNotifications.subscribe(e),this._showPricesWithZeroVolume.subscribe(e),this._showSpread.subscribe(e),this.orderExecutedSoundParams.enabled.subscribe(e),this.orderExecutedSoundParams.path.subscribe(e),window.addEventListener("offline",this._offlineListener),window.addEventListener("online",this._onlineListener),this.bindShortcuts(),this._tradedItemsChartCollectionFacadePromise=this._createTradedItemsChartCollectionFacade(t),this._registerCustomSources(t),this._registerCustomWidgets(t)}showPricesWith(){return{zeroVolume:this._showPricesWithZeroVolume,spread:this._showSpread}}domPanelVisibility(){return this._domPanelVisibility}orderPanelVisibility(){return this._orderPanelVisibility}realtimeProvider(){return this._realtimeProvider}toggleTradingPanelPopup(){this.tradingPanelPopup.visible().value()?this.tradingPanelPopup.hide():this.tradingPanelPopup.show()}toggleTradingWidget(){return window.TradingView.bottomWidgetBar?window.TradingView.bottomWidgetBar.activateTradingTab():Promise.resolve()}toggleMinimizeBottomWidgetBar(){if(window.TradingView.bottomWidgetBar)return window.TradingView.bottomWidgetBar.toggleMinimize()}tradingWizard(){return this._tradingWizard}showTradingProperties(){this._gui()&&this._gui().showTradingProperties()}linking(){return this._linking}brokersList(){return j.brokersList()}brokersPlans(){return this._getBrokerPlans()}activeBroker(){return this._activeBroker}
brokerCommandsUI(){return this._brokerCommandsUI}async selectBroker(t,e){await this._selectBrokerInternal({brokerId:t,isUserAction:!0,keepSessionAlive:e})}async pickDefaultBroker(){if(this._activeBroker)return;let t=null;const e=this.brokersList().filter((t=>!t.configFlags.isSuspended));if(1===e.length)t=e[0].id;else{const i=await je.get();i&&e.some((t=>t.id===i))&&(t=i)}t&&this._selectBrokerInternal({brokerId:t,isUserAction:!1})}async makeNewOrderContextMenuAction(t,e,r){const o=await this._qtySuggester.getQty(t);return{name:"trade-new-order",action:()=>{const{symbol:i}=this._linking.value();i!==t&&this._linking.setSymbol(t),this.trackEvent(e,"New Order"),this._checkAndOpenOrderDialog({symbol:t,qty:o,limitPrice:r,stopPrice:r})},text:(0,M.appendEllipsis)(s.t(null,void 0,i(967498))),statName:"NewOrder"}}async defaultContextMenuActions(t,{onlyMainActions:e=!1,gaOrigin:r="Chart Context Menu",hideNotExecutableAction:o=!1}={}){const{symbol:n}=await this.getActualSymbol(t.symbol),a=await this._qtySuggester.getQty(t.symbol),l=t.value||void 0,{bid:c,ask:d}=await this.realtimeProvider().quotesSnapshot(n),u=[];if(null!==t.value&&void 0!==d&&void 0!==c&&(t.value>=d||t.value<=c)){const e=(c+d)/2;u.push(...await this._makeSubActions(n,t,a,e,r,o))}return u.push(await this.makeNewOrderContextMenuAction(n,r,l)),!e&&x.enabled("property_pages")&&(u.push({separator:!0}),u.push({name:"trade-properties",action:()=>{this.trackEvent(r,"Trading Properties"),this.showTradingProperties()},text:(0,M.appendEllipsis)(s.t(null,void 0,i(873503))),icon:pi,statName:"Properties"})),u}defaultDropdownMenuActions(t){const e="Bottom Panel Dropdown",r=[],o=this.activeBroker(),n=t||{tradingProperties:!0,restoreConfirmations:o&&o.metainfo().configFlags.supportConfirmations};return x.enabled("property_pages")||(n.tradingProperties=!1),n.tradingProperties&&r.push({action:()=>{this.showTradingProperties(),this.trackEvent(e,"Trading Properties")},text:(0,M.appendEllipsis)(s.t(null,void 0,i(873503))),icon:pi}),n.restoreConfirmations&&r.push({action:()=>{this._showRestoreConfirmations(),this.trackEvent(e,"Restore confirmations")},text:(0,M.appendEllipsis)(s.t(null,void 0,i(102653)))}),r}chartContextMenuActions(t,e){return(this._activeBroker&&1===this._activeBroker.connectionStatus()?this._activeBroker.chartContextMenuActions(t,e):this.defaultContextMenuActions(t,e)).then((t=>(0,D.convertActionDescriptionsToActions)(t)))}connectStatus(){return this._activeBroker?this._activeBroker.connectionStatus():3}bindShortcuts(){if(this._hotkeys)return;this._hotkeys=n.createGroup({desc:"Trading"});const t=async t=>{const{symbol:e}=this._linking.value(),i={qty:await this._qtySuggester.getQty(e),side:t,symbol:e,type:2,seenPrice:null};this.trackEvent("Shortcut",-1===t?"Sell":"Buy"),this._checkAndPlaceOrder(i)};this._hotkeys.add({desc:"Buy",hotkey:n.Modifiers.Shift+66,handler:()=>t(1)}),this._hotkeys.add({desc:"Sell",hotkey:n.Modifiers.Shift+83,handler:()=>t(-1)});const e=x.enabled("order_panel"),i=x.enabled("dom_widget");e&&this._hotkeys.add({desc:"Open/close Order Panel",
hotkey:n.Modifiers.Shift+84,handler:()=>{if(!this.tradingPanel.isOpeningAvailable.value())return;const t=this.tradingPanel.isOpened.value()&&this.tradingPanel.activePage.value()===wt.TradingPage.OrderPanel;this.setOrderPanelVisibility(!t)}}),i&&this._hotkeys.add({desc:"Open/close DOM",hotkey:n.Modifiers.Shift+68,handler:()=>{if(!this.tradingPanel.isOpeningAvailable.value())return;const t=this.tradingPanel.isOpened.value()&&this.tradingPanel.activePage.value()===wt.TradingPage.DOMPanel;this.setDOMPanelVisibility(!t)}})}formatter(t){return this.realtimeProvider().formatter(t)}showSuccessNotification(t,e,i=1e4){this.showOnlyRejectionNotifications.value()||this._showNotification(t,e,"success",i),x.enabled("show_trading_notifications_history")&&this._addNotificationRow(t,e,"success",i),this._log(t,e)}showErrorNotification(t,e,i=25e3){this._showNotification(t,e,"danger",i),x.enabled("show_trading_notifications_history")&&this._addNotificationRow(t,e,"danger",i),this._log(t,e)}getNotifications(){return this._notifications.filter((t=>t.account===this._account&&t.broker===(this._activeBroker?this._activeBroker.metainfo().id:null)))}orderViewController(){return(0,r.ensureNotNull)(this._orderViewController)}tradingStat(){return this._tradingStat}async verifyBrokerLiveAccount(){return this._verifyLiveAccount(),null!==this._accountVerificationPromise?this._accountVerificationPromise:Promise.reject("Account verification is not needed")}pipValueType(){return this._pipValueType$.asObservable()}tradedItemsChartCollectionFacade(){return(0,r.ensureNotNull)(this._tradedItemsChartCollectionFacadePromise)}async checkRealtimeDataPermissions(){const t=(0,r.ensureNotNull)(this._activeBroker);await checkRealtimeDataSubscription(t.metainfo().id,t.getRealtimeDataCheckParams())&&this._guiAccessor.reconnectChartApi(!0)}async removeRealtimeDataPermissions(){await removeRealtimeDataSubscription((0,r.ensureNotNull)(this._activeBroker).metainfo().id)&&this._guiAccessor.reconnectChartApi(!0)}makeActualSymbolObservable(t){var e,i;return null!==(i=null===(e=this._continuousFrontContractExtractor)||void 0===e?void 0:e.makeValueObservable(t))&&void 0!==i?i:(0,P.of)({symbol:t})}async getActualSymbol(t){return void 0===this._continuousFrontContractExtractor?{symbol:t}:this._continuousFrontContractExtractor.makeValue(t)}async _getOrderViewController(){return null!==this._orderViewController?this._orderViewController:(await this._createOrderController(),this._getOrderViewController())}async _selectBrokerInternal(t){var e,r;const{brokerId:o,isUserAction:n,keepSessionAlive:a=!1,disconnectInfo:l}=t;if(this._switchingBroker)return void mi.logWarn(`Broker is already selected, but a new broker id: ${o} was received.`);if(o!==(this._activeBroker?this._activeBroker.metainfo().id:null)){if(null===(e=this._linkingSubscription)||void 0===e||e.unsubscribe(),this._destroyContinuousFrontContractTrading(),this._activeBroker){const t=this._activeBroker&&this._activeBroker.disconnectWarningMessage(),e=()=>this._showReviewDialogIfNeeded(3,{
disconnectType:L.DisconnectType.LogOut});if(null!==t&&window.is_authenticated){if(!await(0,pt.showSimpleConfirmDialog)({title:s.t(null,void 0,i(349391)),text:t,mainButtonText:s.t(null,void 0,i(162058)),mainButtonIntent:"danger",cancelButtonText:s.t(null,void 0,i(620036)),onConfirm:()=>{e(),this._logOut(n,a,l)},onCancel:()=>{e()}}))return}else e(),this._logOut(n,a,l)}if(null!=o){let t;this._tradeNowBrokerId=null,this._switchingBroker=!0;try{const e=await j.createBrokerConnection(this,o,this._serverLogger,null,t),{isMaintenance:i,message:r}=await e.maintenanceStatus();if(i){if(!await this._showBrokerSideMaintenanceWarning(e.metainfo().id,r))return this._switchingBroker=!1,void e.disconnect(!0)}0,await this._initBroker(e,a)}catch(t){this._switchingBroker=!1,mi.logError((0,N.getLoggerMessage)(t))}}else n&&setTimeout((()=>{je.clear()})),this.onBrokerChange.fire(null),null===(r=this._closePositionDialogVisibilitySubscription)||void 0===r||r.unsubscribe(),this._brokerCommandsUI=null}else mi.logWarn(`${o} is already selected.`)}_destroyContinuousFrontContractTrading(){}async _initContinuousFrontContractTrading(){}_makeBrokerDependantWarningMessageObservable(t){let e,i=async(e,i)=>{const{tradable:r}=await(0,Q.respectAbort)(e,t.isTradable(i));return r};i=(0,Q.respectLatest)(i);try{e=t.currentAccount()}catch(t){}const r=(0,S.fromEventPattern)((e=>t.currentAccountUpdate.subscribe(null,e)),(e=>t.currentAccountUpdate.unsubscribe(null,e))).pipe((0,C.startWith)(e)),s=(0,S.fromEventPattern)((e=>t.connectionStatusUpdate.subscribe(null,e)),(e=>t.connectionStatusUpdate.unsubscribe(null,e))).pipe((0,C.startWith)(t.connectionStatus()));return(0,w.combineLatest)({value:this._linking.valueObservable(),currentAccountUpdate:r,connectionStatusUpdate:s}).pipe((0,B.mergeMap)((({value:t})=>(0,w.combineLatest)({isTradable:(0,T.from)(i(null,t.symbol)).pipe((0,C.startWith)(!1),(0,O.catchError)((()=>E.EMPTY))),value:(0,P.of)(t)}))),(0,k.map)((t=>t.isTradable?t.value.warning:void 0)))}async _initBroker(t,e){this._activeBroker=t,this._activeBroker.connectionStatusUpdate.subscribe(this,this._connectionListener),this._activeBroker.currentAccountUpdate.subscribe(this,this._onCurrentAccountUpdate),this._realtimeProvider.onStatusChanged.subscribe(null,this._setPipValueType),this._realtimeProvider.onStatusChanged.subscribe(null,this._trackNonTradableSymbol),await this._initContinuousFrontContractTrading(),this._linkingSubscription=this._linking.valueObservable().subscribe((()=>{this._setPipValueType(),this._trackNonTradableSymbol()})),this._brokerCommandsUI=new Pt({activeBroker:this._activeBroker,guiAccessor:this._guiAccessor,noConfirmEnabled:this.noConfirmEnabled,orderViewController:this._getOrderViewController.bind(this),showErrorNotification:this.showErrorNotification.bind(this),trackEvent:this.trackEvent,tradingLinking:this._linking}),this._closePositionDialogVisibilitySubscription=this._brokerCommandsUI.closePositionDialogVisibility.subscribe(this._makeDialogVisibilityHandler(this._closePositionDialogVisibility)),this._activeBroker.tryRestoreSession(),
await je.set(this._activeBroker.metainfo().id),this.onBrokerChange.fire(this._activeBroker),this._getOrderViewController(),this._updateConnectionStatus(this.connectStatus()),this._switchingBroker=!1}async _showBrokerSideMaintenanceWarning(t,e){return(0,pt.showSimpleConfirmDialog)({title:s.t(null,{replace:{brokerId:t}},i(103718)),text:null!=e?e:s.t(null,void 0,i(536263)),cancelButtonText:s.t(null,void 0,i(620036)),mainButtonIntent:"primary",mainButtonText:s.t(null,void 0,i(891268)),showBackdrop:!0})}_makeDialogVisibilityHandler(t){return e=>{t.setValue(e),e.isFullScreen&&this._onFullScreenDialogOpen()}}_gui(){return this._guiAccessor}_addNotificationRow(t,e,i,r){const s={id:this._notifications.length,account:this._account,broker:this._activeBroker?this._activeBroker.metainfo().id:null,time:new Date,title:t,text:e,type:i};this._notifications.push(s),this.onNewNotification.fire(s)}_offlineHandler(){this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!1,disconnectInfo:{disconnectType:L.DisconnectType.Offline}}),mi.logNormal("The connection to the Internet was interrupted")}async _onlineHandler(){await this._selectLastBroker()&&mi.logNormal("The connection to the Internet was restored")}_showNotification(t,e,i,r){this._gui()&&this._gui().showNotification(t,e,i,r)}_showReviewDialogIfNeeded(t,e){if(null===this._activeBroker)return;this._activeBroker}_connectionListener(t,e){const i=this.connectStatus();this._showReviewDialogIfNeeded(t,e);const r=this._isReconnectNeeded=(null==e?void 0:e.disconnectType)===L.DisconnectType.BrokenConnection;3!==t||(null==e?void 0:e.disconnectType)!==L.DisconnectType.LogOut&&!this._isReconnectNeeded||this._selectBrokerInternal({brokerId:null,isUserAction:!1,keepSessionAlive:!1,disconnectInfo:e}).then((()=>{if(this._isReconnectNeeded)return this._tryReconnectLastBroker()})),(null==e?void 0:e.disconnectType)===L.DisconnectType.CancelAuthorization&&this.trackEvent("Signin","OAuth popup closed","By user"),(null==e?void 0:e.disconnectType)===L.DisconnectType.TimeOutForAuthorization&&this.trackEvent("Signin","OAuth popup closed","By timeout"),this._updateConnectionStatus(i,!r,e)}async _selectLastBroker(){const t=await je.get();return null!==t&&(await this._selectBrokerInternal({brokerId:t,isUserAction:!1}),!0)}_updateOrderPanelSpinnerState(){const t=this._orderViewController,e=2===this.connectStatus(),i=null!==t&&t.stateChanging.value();this.tradingPanel.isLoading.setValue(e||i)}async _toggleBottomWidgetBarIfNeeded(){0}async _updateConnectionStatus(t,e=!0,i){var r;this._updateOrderPanelSpinnerState(),this.onConnectionStatusChange.fire(t,i),this._log("Connection status",bi[t]);this._activeBroker;if(e){const t=null===(r=this._activeBroker)||void 0===r?void 0:r.metainfo().id;void 0!==t?await je.set(t):je.clear()}null!==this._activeBroker?1===t?(this._account=this._activeBroker.currentAccount(),this._guiAccessor.setBroker(this._activeBroker)):this._tradedContextLinking.clear():(this._accountVerificationPromise=null,this._guiAccessor.setBroker(null),
this._tradedContextLinking.clear())}async _checkOrRemoveRealtimeDataIfNeeded(t){if(!t.configFlags.supportRealtimeDataCheck)return;const{realtimeDataPermissionsToggleConfig:e}=t;if(void 0===e)return void this.checkRealtimeDataPermissions();const r=`${z.settingsKeys.REALTIME_DATA_ACCEPTED}.${t.id}`;switch(o.getValue(r)){case"true":return void this.checkRealtimeDataPermissions();case"false":return void this.removeRealtimeDataPermissions();default:const t=await showSimpleConfirmDialogWithSolutionLink({title:s.t(null,void 0,i(75715)),text:e.enableRealtimeDataPermissionsToggleText,mainButtonText:s.t(null,void 0,i(83453)),cancelButtonText:s.t(null,void 0,i(546472)),showCloseButton:!1,closeOnOutsideClick:!1,mainButtonIntent:"primary",closeOnEscapePress:!1,solutionId:e.solutionId});t?await this.checkRealtimeDataPermissions():await this.removeRealtimeDataPermissions(),o.setValue(r,t)}}_verifyLiveAccount(){if(null!==this._accountVerificationPromise)return;const t=(0,r.ensureNotNull)(this._activeBroker);t.metainfo().configFlags.supportVerifyLiveAccount&&(t.currentAccountType(),L.AccountType.Live)}_save(){const t=o.getJSON(z.settingsKeys.PROPERTIES,{});o.setJSON(z.settingsKeys.PROPERTIES,{...t,[this._showSellBuyButtonsKey]:+!!this.showSellBuyButtons.value(),noConfirmEnabled:+!!this.noConfirmEnabled.value(),qweqrq:+!!this.showOnlyRejectionNotifications.value(),showPricesWithZeroVolume:+!!this._showPricesWithZeroVolume.value(),showSpread:+!!this._showSpread.value(),orderExecutedSoundParams:JSON.stringify({enabled:+!!this.orderExecutedSoundParams.enabled.value(),name:this.orderExecutedSoundParams.path.value()})})}_loadState(){const t=o.getJSON(z.settingsKeys.PROPERTIES,{}),e=t[this._showSellBuyButtonsKey];if(this.showSellBuyButtons.setValue(void 0!==e?!!e:ki),this.noConfirmEnabled.setValue(!!t.noConfirmEnabled),this.showOnlyRejectionNotifications.setValue(!!t.qweqrq),this._showPricesWithZeroVolume.setValue(!t.hasOwnProperty("showPricesWithZeroVolume")||t.showPricesWithZeroVolume),this._showSpread.setValue(!t.hasOwnProperty("showSpread")||t.showSpread),t.hasOwnProperty("orderExecutedSoundParams")){const e=JSON.parse(t.orderExecutedSoundParams);this.orderExecutedSoundParams.enabled.setValue(!!e.enabled),this.orderExecutedSoundParams.path.setValue(vi(e.name)?e.name:this.orderExecutedSoundParams.path.value())}}_makeShowSellBuyButtonsKey(){return"showSellBuyButtons"}_log(t,e){mi.logNormal(`${this._activeBroker?this._activeBroker.metainfo().id+" Trading: ":""}${t} - ${e}`)}_makeSureCanTrade(){const t=this.activeBroker(),e=this.brokerCommandsUI();return t&&e?1===t.connectionStatus()||(this.toggleTradingWidget(),!1):(this.toggleTradingWidget().then((()=>this.onNeedSelectBroker.fire())),!1)}_checkAndPlaceOrder(t,e=!0){this._makeSureCanTrade()&&(0,r.ensureNotNull)(this.brokerCommandsUI()).placeOrder(t,e)}_checkAndOpenOrderDialog(t){this._makeSureCanTrade()&&(0,r.ensureNotNull)(this.brokerCommandsUI()).placeOrder(t)}_makeSubAction({symbol:t,side:e,orderType:r,orderPrices:o,currentQuotes:n,qty:a,gaOrigin:l}){
const c=1===e?gi:_i,d=1===e?"Buy":"Sell",u=1===r?"Limit":3===r?"Stop":"StopLimit",h=function(t){return"altPrice"in t&&"formattedAltPrice"in t}(o),p=t.split(":")[1],_=d+u,g={BuyLimit:s.t(null,void 0,i(302122)).format({symbol:p,qty:(0,R.abbreviatedNumber)(a),value:o.formattedPrice}),SellStop:s.t(null,void 0,i(627392)).format({symbol:p,qty:(0,R.abbreviatedNumber)(a),value:o.formattedPrice}),SellLimit:s.t(null,void 0,i(476678)).format({symbol:p,qty:(0,R.abbreviatedNumber)(a),value:o.formattedPrice}),BuyStop:s.t(null,void 0,i(255481)).format({symbol:p,qty:(0,R.abbreviatedNumber)(a),value:o.formattedPrice})};return h&&(g.SellStopLimit=s.t(null,void 0,i(194240)).format({symbol:p,qty:(0,R.abbreviatedNumber)(a),value:o.formattedPrice,altValue:o.formattedAltPrice}),g.BuyStopLimit=s.t(null,void 0,i(353343)).format({symbol:p,qty:(0,R.abbreviatedNumber)(a),value:o.formattedPrice,altValue:o.formattedAltPrice})),{name:`trade-${d}-${u}`.toLowerCase(),action:()=>{this.trackEvent(l,`${d} ${u}`);const i=1===r?"limitPrice":"stopPrice",s=1===e?null==n?void 0:n.ask:null==n?void 0:n.bid,c={qty:a,side:e,symbol:t,type:r,seenPrice:null!=s?s:null,currentQuotes:n};null!==o.price&&(c[i]=o.price),4===r&&h&&(c.limitPrice=o.altPrice),this._checkAndPlaceOrder(c)},icon:c,text:g[_],statName:_}}_createOrderController(){return null===this._orderControllerPromise&&(this._orderControllerPromise=Promise.all([i.e(7677),i.e(660)]).then(i.bind(i,935291)).then((({OrderViewController:t})=>new t({resizerBridge:this._resizerBridge,onNeedSelectBroker:this.onNeedSelectBroker,realtimeProvider:this.realtimeProvider(),pipValueType$:this.pipValueType(),trackEvent:this.trackEvent,toggleTradingWidget:this.toggleTradingWidget.bind(this),toggleTradingPanelPopup:this.toggleTradingPanelPopup.bind(this),showErrorNotification:this.showErrorNotification.bind(this),getTradingSettingsStorage:()=>this._tradingSettingsStorage},{container:this.tradingPanel.container,isOpened:this.tradingPanel.isOpened,isOpeningAvailable:this.tradingPanel.isOpeningAvailable,activePage:this.tradingPanel.activePage,close:this.tradingPanel.close.bind(this.tradingPanel),openPage:this.tradingPanel.openPage.bind(this.tradingPanel)},this._qtySuggester,this._linking))).then((t=>{this._orderControllerPromise=null,this._orderViewController=t,this._orderViewController.stateChanging.subscribe((()=>this._updateOrderPanelSpinnerState())),this._orderViewController.dialogVisibility.subscribe(this._makeDialogVisibilityHandler(this._orderDialogVisibility))}))),this._orderControllerPromise}async _registerCustomSources(t){!async function(t,e){const r=await Promise.all([i.e(1033),i.e(1969),i.e(2650)]).then(i.bind(i,13042));t.addCustomSource("bidask",((i,s)=>new r.BidAsk(i,s,e.realtimeProvider(),(()=>{t.activeChartWidget.value().showGeneralChartProperties(W.TabNames.symbol)}))))}(t,this),Wt(t,this,this.showTradedSources);new((await Promise.all([i.e(1033),i.e(1969),i.e(1652)]).then(i.bind(i,16951))).TradedSourcesManager)(this._ordersService,this._positionService,t,{activeTradedLinking:this._tradedContextLinking,
showTradedSources:this.showTradedSources,realtimeProvider:this._realtimeProvider,qtySuggester:this._qtySuggester,brokerCommandsUI:this.brokerCommandsUI.bind(this),trackEvent:this.trackEvent,pipValueType$:this.pipValueType(),makeActualSymbolObservable:this.makeActualSymbolObservable.bind(this)})}_registerCustomWidgets(t){fi&&function(t,e,i){t.addCustomWidgetToLegend(((t,r)=>{const s=t.mainSeries(),o=(0,qt.createWVFromGetterAndSubscription)(t.isInReplay.bind(t),t.onInReplayStateChanged()),n=(0,qt.createWVFromGetterAndSubscriptions)((()=>{var t;return"economic"===(null===(t=s.symbolInfo())||void 0===t?void 0:t.type)}),[s.dataEvents().symbolResolved(),s.dataEvents().symbolError()]);return new we(s.dataEvents(),function(t){return()=>{const e=t.symbolInfo();return null!==e?e.pro_name||e.full_name||e.name||"":t.proSymbol()}}(s),n,i,{onNeedSelectBroker:e.onNeedSelectBroker,realtimeProvider:e.realtimeProvider(),onBrokerConnectionStatusChange:e.onConnectionStatusChange,brokerConnectionStatus:e.connectStatus.bind(e),trackEvent:e.trackEvent,toggleTradingWidget:e.toggleTradingWidget.bind(e),toggleTradingPanelPopup:e.toggleTradingPanelPopup.bind(e),brokerCommandsUI:e.brokerCommandsUI.bind(e),toggleMinimizeBottomWidgetBar:()=>e.toggleMinimizeBottomWidgetBar(),makeActualSymbolObservable:e.makeActualSymbolObservable.bind(e)},{showSellBuyButtons:e.showSellBuyButtons,noConfirmEnabled:e.noConfirmEnabled,themeName:r},o)}),{block:0,position:0})}(t,this,this._qtySuggester)}async _makeSubActions(t,e,i,r,s,o=!1){const n=[];if(null===e.value)return n;const a=this.activeBroker();let l,c,d,u,h,p,_,g,m,b,y,v,f,k=null===a,P=null===a,S=!o&&null===a,C=!o&&null!==a,w=!o&&null===a;null!==a&&1===a.connectionStatus()&&(f=await a.isTradable(t));const[B,T,O]=await Promise.all([this._realtimeProvider.symbolInfo(t),this._realtimeProvider.formatter(t),this._realtimeProvider.quotesSnapshot(t)]),E=B.variableMinTick?(0,A.makeVariableMinTickData)(B.minTick,B.variableMinTick):void 0,L=t=>(0,A.getMinTick)({minTick:B.minTick,price:t,variableMinTickData:E});if(null!==a&&f&&f.tradable){const t=a.metainfo().configFlags,i=(0,I.alignToStep)(e.value,L(e.value));l=i,d=i,u=i,c=i,h=u+L(u),p=c-L(c),k=Boolean(t.supportLimitOrders),P=Boolean(t.supportStopOrders),S=Boolean(t.supportStopOrdersInBothDirectionsInUI),C=Boolean(t.supportStopLimitOrdersInBothDirections),w=Boolean(t.supportStopLimitOrders),void 0!==B.limitPriceStep&&(l=(0,N.roundToStepByPriceTypeAndSide)(e.value,B.limitPriceStep,1,1),d=(0,N.roundToStepByPriceTypeAndSide)(e.value,B.limitPriceStep,1,-1),h=(0,N.roundToStepByPriceTypeAndSide)(e.value+L(e.value),B.limitPriceStep,1,1),p=(0,N.roundToStepByPriceTypeAndSide)(e.value-L(e.value),B.limitPriceStep,1,-1)),void 0!==B.stopPriceStep&&(u=(0,N.roundToStepByPriceTypeAndSide)(e.value,B.stopPriceStep,2,1),c=(0,N.roundToStepByPriceTypeAndSide)(e.value,B.stopPriceStep,2,-1)),_=T.format(l),g=T.format(c),m=T.format(d),b=T.format(u),y=T.format(h),v=T.format(p)}else l=d=u=c=e.value,_=g=m=b=e.formattedValue,h=u+L(u),p=c-L(c),y=T.format(h),v=T.format(p);let D
;if(void 0!==O.ask&&void 0!==O.bid&&(D={ask:O.ask,bid:O.bid}),e.value<=r){if(k){const e={price:l,formattedPrice:_};n.push(this._makeSubAction({symbol:t,side:1,orderType:1,orderPrices:e,qty:i,gaOrigin:s,currentQuotes:D}))}if(S){const e={price:u,formattedPrice:b};n.push(this._makeSubAction({symbol:t,side:1,orderType:3,orderPrices:e,qty:i,gaOrigin:s,currentQuotes:D}))}if(P||S){const e={price:c,formattedPrice:g};n.push(this._makeSubAction({symbol:t,side:-1,orderType:3,orderPrices:e,qty:i,gaOrigin:s,currentQuotes:D}))}if(w){const e={symbol:t,side:-1,orderType:4,orderPrices:{price:c,formattedPrice:g,altPrice:p,formattedAltPrice:v},qty:i,gaOrigin:s,currentQuotes:D};n.push(this._makeSubAction(e)),C&&n.push(this._makeSubAction({...e,side:1}))}}else{if(k){const e={price:d,formattedPrice:m};n.push(this._makeSubAction({symbol:t,side:-1,orderType:1,orderPrices:e,qty:i,gaOrigin:s,currentQuotes:D}))}if(S){const e={price:c,formattedPrice:g};n.push(this._makeSubAction({symbol:t,side:-1,orderType:3,orderPrices:e,qty:i,gaOrigin:s,currentQuotes:D}))}if(P||S){const e={price:u,formattedPrice:b};n.push(this._makeSubAction({symbol:t,side:1,orderType:3,orderPrices:e,qty:i,gaOrigin:s,currentQuotes:D}))}if(w){const e={symbol:t,side:1,orderType:4,orderPrices:{price:u,formattedPrice:b,altPrice:h,formattedAltPrice:y},qty:i,gaOrigin:s,currentQuotes:D};n.push(this._makeSubAction(e)),C&&n.push(this._makeSubAction({...e,side:-1}))}}return n}_initPaidBrokersByUserRegion(){this._brokersListPromise=fetch("/api/v1/brokers/trading_panel",{method:"GET"}).then((t=>t.json())).catch((t=>{mi.logWarn("Failed to fetch brokers info: "+t)}))}async _getBrokerPlans(){let t=[];try{if(t=await this._brokersListPromise,!Array.isArray(t))throw new Error("Request result is not valid")}catch(t){mi.logError(`Failed to fetch broker list by user region: ${t.message}`)}return t}async _checkCQGCredentials(t){}async _showRestoreConfirmations(){const t=await(0,pt.showSimpleConfirmDialog)({title:s.t(null,void 0,i(102653)),text:s.t(null,void 0,i(526227)),mainButtonIntent:"primary"});null!==this._activeBroker&&t&&(new ze.DisabledConfirmations).clear()}_logOut(t,e,i){const s=(0,r.ensureNotNull)(this._activeBroker);s.connectionStatusUpdate.unsubscribe(this,this._connectionListener),s.currentAccountUpdate.unsubscribe(this,this._onCurrentAccountUpdate),this._realtimeProvider.onStatusChanged.unsubscribe(null,this._setPipValueType),this._realtimeProvider.onStatusChanged.unsubscribe(null,this._trackNonTradableSymbol),s.disconnect(e||!t),s.destroy(),this._activeBroker=null,this._updateConnectionStatus(3,t,i)}async _createTradedItemsChartCollectionFacade(t){return new((await Promise.all([i.e(1033),i.e(1969),i.e(2650)]).then(i.bind(i,132193))).TradedItemsChartCollectionFacade)(t)}_tradeNowInit(){const t=new URL(decodeURIComponent(window.location.href)),e=t.searchParams.get("trade-now");t.searchParams.delete("trade-now"),window.history.replaceState(null,document.title,t.toString()),null===e||isMobileTradingAvailable()||(this._tradeNowBrokerId=e,je.clear())}}},99708:(t,e,i)=>{"use strict"
;i.d(e,{checkQtyError:()=>l,qtyErrors:()=>n});var r=i(509806),s=i(960521),o=i.n(s);const n={min:r.t(null,void 0,i(430999)),max:r.t(null,void 0,i(734266)),step:r.t(null,void 0,i(136443)),balance:r.t(null,void 0,i(409232))},a=(r.t(null,void 0,i(611835)),r.t(null,void 0,i(706035)));function l(t,e,i=!1){if(null===e)return{res:!0,msg:a};const r=t.step,s=t.min,l=t.max;if(e<s)return{res:!0,msg:n.min.format({min:s.toString()})};if(e>l)return{res:!0,msg:n.max.format({max:l.toString()})};const c=new(o())(e).minus(s).mod(r);return i&&!c.eq(0)?{res:!0,msg:n.step.format({step:r.toString()})}:{res:!1}}},346849:(t,e,i)=>{"use strict";i.d(e,{checkBracketError:()=>h,makeBracketPercentPriceRuleChecker:()=>d});var r=i(509806),s=i(960521),o=i.n(s),n=i(656846),a=i(481330),l=i(637401);const c={orderStopLoss:{long:r.t(null,void 0,i(995717)),short:r.t(null,void 0,i(685017))},orderTakeProfit:{long:r.t(null,void 0,i(429871)),short:r.t(null,void 0,i(37475))},positionStopLoss:{long:t=>r.t(null,{replace:{value:t}},i(216502)),short:t=>r.t(null,{replace:{value:t}},i(874337))},positionTakeProfit:{long:t=>r.t(null,{replace:{value:t}},i(829997)),short:t=>r.t(null,{replace:{value:t}},i(751300))}};function d(t,e){let s,a,c;const d=(t,e,i,r)=>{const s=new(o())(e),n=s.mul(t).div(100);return s.minus(n.mul(i).mul(r)).toNumber()};return(o,u,h,p,_,g,m,b)=>{const y=-1===h?-1:1,v=p===n.BracketType.TakeProfit?-1:1,f=d(t,u,y,v),k=d(e,u,y,v),P=(0,l.roundToStepByPriceTypeAndSide)(f,g,_,h),S=(0,l.roundToStepByPriceTypeAndSide)(k,g,_,h);let C=Math.min(P,S),w=Math.max(P,S);m&&(void 0!==s&&void 0!==a&&c?(C=s,w=a):void 0===s&&void 0===a&&(C=Math.min(C,o),w=Math.max(w,o),s=C,a=w,c=b));if(!(o>=C&&o<=w))return{res:!0,msg:r.t(null,void 0,i(783100)).replace("{min}",C.toString()).replace("{max}",w.toString())};return(y*v==-1?P>=u&&S>=u:P<=u&&S<=u)?{res:!1}:{res:!0,msg:r.t(null,void 0,i(298353))}}}function u(t){const{side:e,price:i,priceType:r,priceStep:s,parentPrice:o,bracketType:n,isStatusEditing:a,isEnabled:l,bracketPercentPriceRuleCheckers:c}=t;for(const t of c){const c=t(i,o,e,n,r,s,a,l);if(c.res)return c}return{res:!1}}function h(t){const{quotes:e,side:s,price:o,pips:l,priceType:d,priceStep:h,parentPrice:p,parentType:_,bracketType:g,isStatusEditing:m,isEnabled:b,bracketPercentPriceRuleCheckers:y,priceFormatter:v,isRoundToPriceStep:f}=t;if(null===o||null===l)return{res:!0,msg:r.t(null,void 0,i(900205))};let k={res:!1};return k=2===_?function(t){const{quotes:e,side:s,price:o,priceType:l,priceStep:d,parentPrice:h,bracketType:p,isStatusEditing:_,isEnabled:g,bracketPercentPriceRuleCheckers:m}=t;let b={res:!1};m.length>0&&(b=u({side:s,price:o,priceType:l,priceStep:d,parentPrice:h,bracketType:p,isStatusEditing:_,isEnabled:g,bracketPercentPriceRuleCheckers:m}));const y=(p===n.BracketType.TakeProfit?-1:1)*s,v=-1===s?(0,a.getAsk)(e):(0,a.getBid)(e);if(v&&Math.sign(o-v)===y){const t=p===n.BracketType.TakeProfit?c.positionTakeProfit:c.positionStopLoss,e=-1===s?r.t(null,void 0,i(26338)):r.t(null,void 0,i(5595));b={res:!0,msg:-1===s?t.short(e):t.long(e)}}return b}({quotes:e,side:s,
price:o,priceType:d,priceStep:h,parentPrice:p,bracketType:g,isStatusEditing:m,isEnabled:b,bracketPercentPriceRuleCheckers:y}):function(t){const{side:e,pips:i,price:r,priceType:s,priceStep:o,parentPrice:a,bracketType:l,isStatusEditing:d,isEnabled:h,bracketPercentPriceRuleCheckers:p}=t;let _={res:!1};if(p.length>0&&(_=u({side:e,price:r,priceType:s,priceStep:o,parentPrice:a,bracketType:l,isStatusEditing:d,isEnabled:h,bracketPercentPriceRuleCheckers:p})),i<=0||r<=0){const t=l===n.BracketType.TakeProfit?c.orderTakeProfit:c.orderStopLoss;_={res:!0,msg:1===e?t.long:t.short}}return _}({side:s,pips:l,price:o,priceType:d,priceStep:h,parentPrice:p,bracketType:g,isStatusEditing:m,isEnabled:b,bracketPercentPriceRuleCheckers:y}),!k.res&&f&&(k=function(t,e,s){return(0,a.isMintickMultiple)(t,e)?{res:!1}:{res:!0,msg:r.t(null,void 0,i(753596)).format({minTick:s.format(e)})}}(o,h,v)),k}},957877:(t,e,i)=>{"use strict";i.d(e,{validatePrice:()=>c});var r=i(509806),s=i(960521),o=i.n(s),n=i(481330);const a=r.t(null,void 0,i(134986));function l(t,e){return o()(t).minus(e).abs().gt(o()(t).div(2))}function c(t){const{price:e,askOrBid:s,orderType:c,side:d,isStopPrice:u,isForex:h,formatter:p,supportStopOrdersInBothDirections:_,supportStopLimitOrdersInBothDirections:g,step:m,roundedToStep:b}=t;if((!h||b)&&!1===(0,n.isMintickMultiple)(e,m))return{res:!0,severity:"error",msg:r.t(null,void 0,i(130927)).format({minTick:p.format(m)})};const y=e<0||o()(s).mul(100).lt(e)||function(t){const{price:e,askOrBid:i,orderType:r,side:s,isStopPrice:o,supportStopOrdersInBothDirections:n,supportStopLimitOrdersInBothDirections:a}=t;return 1===r?1===s?e>i&&l(i,e):e<i&&l(i,e):!!(3===r&&!n||4===r&&o&&!a)&&(1===s?e<i:e>i)}({price:e,askOrBid:s,orderType:c,side:d,isStopPrice:u,supportStopOrdersInBothDirections:_,supportStopLimitOrdersInBothDirections:g});return y?{res:!0,severity:"error",msg:a}:{res:!1}}},232192:(t,e,i)=>{"use strict";i.d(e,{extractLimitValidationRules:()=>_,extractStopLossValidationRules:()=>h,extractStopValidationRules:()=>p,extractTakeProfitValidationRules:()=>u,isLimitPercentValidationRule:()=>l,isStopLimitPercentValidationRule:()=>a,isStopPercentValidationRule:()=>c});const r=["tpPercent"],s=["slPercent"],o=["stopPercent"],n=["limitPercent"];function a(t){return l(t)||c(t)}function l(t){return n.includes(t.id)}function c(t){return o.includes(t.id)}function d(t,e,i){var r;return null===(r=t.getValidationRules(e))||void 0===r?void 0:r.filter((t=>i.includes(t.id)))}function u(t,e){return d(t,e,r)}function h(t,e){return d(t,e,s)}function p(t,e){return d(t,e,o)}function _(t,e){return d(t,e,n)}},330012:(t,e,i)=>{"use strict";i.d(e,{abbreviatedNumber:()=>o});var r=i(424030);const s=["","K","M","G","T","Y"];function o(t){if(t<1)return r.NumericFormatter.formatNoE(t);let e=0,i=+t;if(isFinite(i))for(;i>=1e3&&i%100==0;)e++,i/=1e3;return i+(e<s.length?s[e]:"e"+3*e)}},660538:(t,e,i)=>{"use strict";i.d(e,{mediaQueryAddEventListener:()=>r,mediaQueryRemoveEventListener:()=>s});const r=(t,e)=>{
(null==t?void 0:t.addEventListener)?t.addEventListener("change",e):t.addListener(e)},s=(t,e)=>{(null==t?void 0:t.removeEventListener)?t.removeEventListener("change",e):t.removeListener(e)}},340794:(t,e,i)=>{"use strict";function r(t){let e=Promise.resolve();return function(...i){const r=e.then((()=>t.apply(this,i)));return e=r.catch((()=>{})),r}}i.d(e,{sequentialize:()=>r})},198083:t=>{t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M19.9792 16.6205C19.7396 16.8955 19.3241 16.9285 19.044 16.6948L14.3924 12.8117L14.072 12.5442L13.7516 12.8117L9.10009 16.6947C8.82008 16.9285 8.40456 16.8955 8.16495 16.6205C7.92467 16.3447 7.94981 15.9272 8.22144 15.6822L14.0721 10.4057L19.9227 15.6822C20.1943 15.9272 20.2195 16.3447 19.9792 16.6205ZM18.4032 17.4624C19.1009 18.0448 20.1362 17.9626 20.7332 17.2774C21.3318 16.5902 21.2692 15.55 20.5924 14.9396L14.407 9.36109L14.0721 9.05908L13.7373 9.36109L7.55171 14.9396C6.87492 15.55 6.81229 16.5902 7.41096 17.2774C8.00796 17.9626 9.04326 18.0448 9.74094 17.4624L14.072 13.8468L18.4032 17.4624Z"/></svg>'},472382:t=>{t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 28 28" width="28" height="28" fill="none"><path fill="currentColor" fill-rule="evenodd" clip-rule="evenodd" d="M19.9792 12.2892C19.7396 12.0142 19.3241 11.9812 19.044 12.2149L14.3924 16.098L14.072 16.3655L13.7516 16.098L9.10009 12.2149C8.82008 11.9812 8.40456 12.0142 8.16495 12.2892C7.92467 12.565 7.94981 12.9825 8.22144 13.2275L14.0721 18.504L19.9227 13.2275C20.1943 12.9825 20.2195 12.565 19.9792 12.2892ZM18.4032 11.4472C19.1009 10.8648 20.1362 10.9471 20.7332 11.6323C21.3318 12.3195 21.2692 13.3597 20.5924 13.9701L14.407 19.5486L14.0721 19.8506L13.7373 19.5486L7.55171 13.9701C6.87492 13.3597 6.81229 12.3195 7.41096 11.6323C8.00796 10.9471 9.04326 10.8648 9.74094 11.4473L14.072 15.0628L18.4032 11.4472Z"/></svg>'},507720:t=>{t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 17" width="17" height="17" fill="currentColor"><path d="m.58 1.42.82-.82 15 15-.82.82z"/><path d="m.58 15.58 15-15 .82.82-15 15z"/></svg>'},816105:t=>{
t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" width="72" height="72" fill="none"><g clip-path="url(#clip0)"><path fill="#363A45" fill-rule="evenodd" clip-rule="evenodd" d="M62.1259 28.2153C61.4066 28.8157 61.0001 29.7273 61.0858 30.6604C61.6716 37.0347 59.7763 44.3291 55.3181 50.8221C46.9016 63.0797 32.5383 67.839 23.2366 61.4522C13.935 55.0654 13.2174 39.9512 21.6339 27.6935C26.4984 20.6088 33.3496 16.029 40.0619 14.6585C40.9752 14.472 41.731 13.8291 42.1024 12.9741C42.485 12.0934 42.9606 11.2346 43.5313 10.4123C47.906 4.1093 56.2129 2.33004 62.0853 6.4382C67.9578 10.5464 69.172 18.9863 64.7974 25.2892C64.0194 26.4103 63.1169 27.3882 62.1259 28.2153Z"/><rect width="47.2" height="34" fill="#1E222D" stroke="#B2B5BE" stroke-width="2" rx="3.8" x="12.4004" y="16"/><path stroke="#B2B5BE" stroke-linecap="round" stroke-width="2" d="M3.59961 54H67.1996"/><path fill="#B2B5BE" fill-rule="evenodd" clip-rule="evenodd" d="M29.1178 31.1324L30.8107 32.8253L32.225 31.4111L30.5321 29.7182L32.225 28.0253L30.8107 26.6111L29.1178 28.304L27.425 26.6111L26.0107 28.0253L27.7036 29.7182L26.0107 31.4111L27.425 32.8253L29.1178 31.1324Z"/><path fill="#B2B5BE" fill-rule="evenodd" clip-rule="evenodd" d="M43.5182 31.1324L45.2111 32.8253L46.6253 31.4111L44.9325 29.7182L46.6253 28.0253L45.2111 26.6111L43.5182 28.304L41.8253 26.6111L40.4111 28.0253L42.104 29.7182L40.4111 31.4111L41.8253 32.8253L43.5182 31.1324Z"/><path stroke="#B2B5BE" stroke-width="2" d="M30.5996 38.7H40.7996"/></g></svg>'},627687:t=>{t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 72 72" width="72" height="72" fill="none"><g clip-path="url(#clip0)"><path fill="#F0F3FA" fill-rule="evenodd" clip-rule="evenodd" d="M62.1259 28.2153C61.4066 28.8157 61.0001 29.7273 61.0858 30.6604C61.6716 37.0347 59.7763 44.3291 55.3181 50.8221C46.9016 63.0797 32.5383 67.839 23.2366 61.4522C13.935 55.0654 13.2174 39.9512 21.6339 27.6935C26.4984 20.6088 33.3496 16.029 40.0619 14.6585C40.9752 14.472 41.731 13.8291 42.1024 12.9741C42.485 12.0934 42.9606 11.2346 43.5313 10.4123C47.906 4.1093 56.2129 2.33004 62.0853 6.4382C67.9578 10.5464 69.172 18.9863 64.7974 25.2892C64.0194 26.4103 63.1169 27.3882 62.1259 28.2153Z"/><rect width="47.2" height="34" fill="#fff" stroke="#1E222D" stroke-width="2" rx="3.8" x="12.4004" y="16"/><path stroke="#1E222D" stroke-linecap="round" stroke-width="2" d="M3.59961 54H67.1996"/><path fill="#000" fill-rule="evenodd" clip-rule="evenodd" d="M29.1178 31.1324L30.8107 32.8253L32.225 31.4111L30.5321 29.7182L32.225 28.0253L30.8107 26.6111L29.1178 28.304L27.425 26.6111L26.0107 28.0253L27.7036 29.7182L26.0107 31.4111L27.425 32.8253L29.1178 31.1324Z"/><path fill="#000" fill-rule="evenodd" clip-rule="evenodd" d="M43.5182 31.1324L45.2111 32.8253L46.6253 31.4111L44.9325 29.7182L46.6253 28.0253L45.2111 26.6111L43.5182 28.304L41.8253 26.6111L40.4111 28.0253L42.104 29.7182L40.4111 31.4111L41.8253 32.8253L43.5182 31.1324Z"/><path stroke="#000" stroke-width="2" d="M30.5996 38.7H40.7996"/></g></svg>'},829883:t=>{
t.exports='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 16" width="20" height="16"><path fill="currentColor" fill-rule="evenodd" d="M7.5 2.5C7.5 1.67 8.17 1 9 1h2c.83 0 1.5.67 1.5 1.5v.15h-5V2.5zm6 0v.15H17a2.5 2.5 0 0 1 2.5 2.5v8.35A2.5 2.5 0 0 1 17 16H3a2.5 2.5 0 0 1-2.5-2.5V5.15A2.5 2.5 0 0 1 3 2.65h3.5V2.5A2.5 2.5 0 0 1 9 0h2a2.5 2.5 0 0 1 2.5 2.5zm-12 2.65c0-.83.67-1.5 1.5-1.5h14c.83 0 1.5.67 1.5 1.5v8.35c0 .83-.67 1.5-1.5 1.5H3a1.5 1.5 0 0 1-1.5-1.5V5.15zM9.25 6.5a1.75 1.75 0 1 0 0 3.5h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75h-1c0 .97.78 1.75 1.75 1.75h.25v1h1v-1h.25a1.75 1.75 0 1 0 0-3.5h-1.5a.75.75 0 0 1 0-1.5h1.5c.41 0 .75.34.75.75h1c0-.97-.78-1.75-1.75-1.75h-.25v-1h-1v1h-.25z"/></svg>'}}]);