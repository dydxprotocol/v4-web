"use strict";(self.webpackChunktradingview=self.webpackChunktradingview||[]).push([[3541],{72249:(t,e,s)=>{s.d(e,{splitThousands:()=>i});var r=s(93751);function i(t,e="&nbsp;"){let s=t+"";-1!==s.indexOf("e")&&(s=function(t){return(0,r.fixComputationError)(t).toFixed(10).replace(/\.?0+$/,"")}(Number(t)));const i=s.split(".");return i[0].replace(/\B(?=(\d{3})+(?!\d))/g,e)+(i[1]?"."+i[1]:"")}},44963:(t,e,s)=>{var r;s.d(e,{StopType:()=>r}),function(t){t[t.StopLoss=0]="StopLoss",t[t.TrailingStop=1]="TrailingStop"}(r||(r={}))},44777:(t,e,s)=>{s.d(e,{DisconnectError:()=>n,extractDisconnectionInfoAndConnectionStatus:()=>a});var r=s(24818),i=s(50317),o=s(50420);class n extends o.UserFriendlyError{constructor({disconnectInfo:t,...e}){super(e),this.name="DisconnectError",this.disconnectInfo=t}}function a(t){const e=function(t){const e={message:(0,i.getErrorMessage)(t)};t instanceof n&&(e.disconnectType=t.disconnectInfo.disconnectType);return e}(t);let s=4;return void 0!==e.disconnectType&&[r.DisconnectType.CancelAuthorization,r.DisconnectType.TimeOutForAuthorization].includes(e.disconnectType)&&(s=3),{disconnectionInfo:e,connectionStatus:s}}},80214:(t,e,s)=>{s.r(e),s.d(e,{Broker:()=>it});var r=s(25177),i=s(88537),o=s(60521),n=s.n(o);function a(t){const e=new URLSearchParams;for(const[s,r]of Object.entries(t))void 0!==r&&e.set(s,String(r));return e.toString()}var u,c=s(44963),l=s(24818);!function(t){t.GetLeverage="getLeverage",t.SetLeverage="setLeverage",t.PreviewLeverage="previewLeverage"}(u||(u={}));const d=[{label:(0,r.t)("Symbol"),formatter:"symbol",showLabelOnMobile:!1,property:"brokerSymbol",notHideable:!0},{label:(0,r.t)("Side"),property:"side",formatter:"side"},{label:(0,r.t)("Type"),property:"type",formatter:"type"},{label:(0,r.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:(0,r.t)("Size in lots")},{label:(0,r.t)("Filled Qty"),alignment:"right",property:"filledQty",formatter:"formatQuantity",help:(0,r.t)("Filled Size in lots")},{label:(0,r.t)("Limit Price"),alignment:"right",property:"limitPrice",formatter:"formatPrice"},{label:(0,r.t)("Stop Price"),alignment:"right",property:"stopPrice",formatter:"formatPrice"},{label:(0,r.t)("Take Profit"),alignment:"right",property:"takeProfit",formatter:"formatPrice"},{label:(0,r.t)("Stop Loss"),alignment:"right",property:"stopLoss",formatter:"formatPrice"},{label:(0,r.t)("Trailing Stop"),alignment:"right",property:"trailingStopPrice",formatter:"formatPrice"},{label:(0,r.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"formatPrice",supportedStatusFilters:[0,6,2]},{label:(0,r.t)("Status"),property:"status",formatter:"status",supportedStatusFilters:[0]},{label:(0,r.t)("Update Time"),property:"updateTime",formatter:"localDate"},{label:(0,r.t)("Order id"),property:"id",isCapitalize:!1},{label:(0,r.t)("Expiry"),property:"expiry"},{label:(0,r.t)("Expiry Time"),alignment:"right",property:"expiryTime",formatter:"localDateOrDateTime"}],h=[{label:(0,r.t)("Symbol"),formatter:"symbol",showLabelOnMobile:!1,property:"brokerSymbol",notHideable:!0},{
label:(0,r.t)("Side"),property:"side",formatter:"side"},{label:(0,r.t)("Type"),property:"type",formatter:"type"},{label:(0,r.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:(0,r.t)("Size in lots")},{label:(0,r.t)("Filled Qty"),alignment:"right",property:"filledQty",formatter:"formatQuantity",help:(0,r.t)("Filled Size in lots")},{label:(0,r.t)("Limit Price"),alignment:"right",property:"limitPrice",formatter:"formatPrice"},{label:(0,r.t)("Stop Price"),alignment:"right",property:"stopPrice",formatter:"formatPrice"},{label:(0,r.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"formatPrice"},{label:(0,r.t)("Status"),property:"status",formatter:"status"},{label:(0,r.t)("Update Time"),property:"updateTime",formatter:"localDate"},{label:(0,r.t)("Order id"),property:"id",isCapitalize:!1}],p=((0,r.t)("Balance"),(0,r.t)("Equity",{context:"trading"}),(0,r.t)("Total Profit"),[{label:(0,r.t)("Symbol"),formatter:"symbol",showLabelOnMobile:!1,property:"brokerSymbol",notHideable:!0},{label:(0,r.t)("Side"),property:"side",formatter:"positionSide"},{label:(0,r.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:(0,r.t)("Size in lots")},{label:(0,r.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"avgPriceFormatter"},{label:(0,r.t)("Take Profit"),alignment:"right",property:"takeProfit",formatter:"formatPriceForexSup"},{label:(0,r.t)("Stop Loss"),alignment:"right",property:"stopLoss",formatter:"formatPriceForexSup"},{label:(0,r.t)("Trailing Stop"),alignment:"right",property:"trailingStopPrice",formatter:"formatPriceForexSup"},{label:(0,r.t)("Profit"),alignment:"right",property:"unrealizedPl",formatter:"profitInInstrumentCurrency",isCapitalize:!1},{label:(0,r.t)("Position id"),property:"id",isCapitalize:!1}]),_=[{label:(0,r.t)("Symbol"),property:"symbol"},{label:(0,r.t)("Currency name"),property:"longName",notSortable:!0},{label:(0,r.t)("Total"),alignment:"right",property:"total",formatter:"variablePrecision"},{label:(0,r.t)("Available"),alignment:"right",property:"available",formatter:"variablePrecision"},{label:(0,r.t)("Reserved"),alignment:"right",property:"reserved",formatter:"variablePrecision"},{label:(0,r.t)("BTC value"),alignment:"right",property:"btcValue",formatter:"variablePrecision"},{label:(0,r.t)("Value"),property:"value",alignment:"right",formatter:"cryptoValueInCurrencyFormatter"}];var g=s(50317),m=s(50420);const y=(0,r.t)("Failed to fetch");var f;function b(t){const e={Accept:"application/json","Content-Type":"application/x-www-form-urlencoded",Referer:"https://www.tradingview.com/chart/OlHDdzUm/"};return t&&(e.Authorization="Bearer "+t),e}async function v({url:t,accessToken:e,method:s=f.Get,body:r,logger:i,includeCredentials:o}){const n=r?function(t){const e=[];for(const s in t)t.hasOwnProperty(s)&&null!=t[s]&&e.push({key:s,pair:encodeURIComponent(s)+"="+encodeURIComponent(t[s])});return e.sort((t,e)=>t.key>e.key?1:t.key<e.key?-1:0).map(t=>t.pair).join("&")}(r):r,a={method:f[s],headers:b(e)};n&&s!==f.Get&&(a.body=n),
o&&(a.credentials="include");try{const e=await fetch(t,a);if(!e.ok)throw new Error(e.statusText);return e}catch(t){throw t.message=(0,g.getErrorMessage)(t),i&&i.logError(t.message),t}}async function P(t){const e=await async function(t){const e=await v(t),s=await e.json();if(!function(t){return!(!t||t.hasOwnProperty("s")&&"error"===t.s)}(s)){const e=s.errmsg?s.errmsg:y;throw t.logger&&t.logger.logError(e),new Error(e)}return s}(t);return"d"in e?e.d:e}function T(t){return{valid:!0,data:t}}async function S({url:t,method:e,headers:s,includeCredentials:r,body:i,extractResponseData:o=T,extractErrorMessage:n}){const a={method:f[e],headers:s};r&&(a.credentials="include");try{null!==i&&(a.body=JSON.stringify(i));const e=await fetch(t,a);if(!e.ok){if(void 0!==n){const{logMessage:t,userFriendlyMessage:s}=await n(e);throw new m.UserFriendlyError({detailedErrorMessage:t,userFriendlyMessage:s})}throw new Error(e.statusText)}const s=o(await e.json());if(!1===s.valid)throw new Error(s.errormsg);return s.data}catch(t){throw new m.UserFriendlyError({detailedErrorMessage:t.message,userFriendlyMessage:t.userFriendlyMessage})}}!function(t){t[t.Get=1]="Get",t[t.Post=2]="Post",t[t.Put=3]="Put",t[t.Delete=4]="Delete"}(f||(f={}));var C=s(16345),k=s(97496),w=s.n(k);const F=(0,s(51951).getLogger)("Trading.Requester");class A{constructor({url:t,method:e,headers:s,body:r,requestInterval:i,dataCallback:o,extractResponseData:n,extractErrorMessage:a,includeCredentials:u}){this.statusChanged=new(w()),this._currentPulseIndex=0,this._body=null,this._requestInterval=null,this._requestTimeOut=null,this._errorsCount=0,this._status=0,this._snapshot=!0,this._url=t,this._includeCredentials=u,this._headers=s,this._method=e||f.Get,this._body=r||null,this._requestInterval=i,this._dataCallback=o,this.statusChanged=new(w()),this._extractResponseData=n,this._extractErrorMessage=a}start(){return this._status=1,this._errorsCount=0,this._currentPulseIndex++,this._request()}stop(){this._status=0,this._clearResetRequestTimeout()}pause(){this.stop()}unpause(){this.start()}status(){return this._status}changeUrl(t){(0,i.assert)(1!==this._status,"Cannot change URL: requester is running"),this._url=t}changeHeaders(t){(0,i.assert)(1!==this._status,"Cannot change headers: requester is running"),this._headers=t}async _request(){const t=this._currentPulseIndex;(0,i.assert)(1===this._status,"Unable to request: requester is inactive");try{const e=this._url,s=await S({url:this._url,method:this._method,headers:this._headers,body:this._body,includeCredentials:this._includeCredentials,extractResponseData:this._extractResponseData,extractErrorMessage:this._extractErrorMessage});this._errorsCount=0,e===this._url&&1===this._status&&t===this._currentPulseIndex&&(await this._dataCallback(s,this._snapshot),this._snapshot=!1)}catch(e){F.logError(`${(0,g.getLoggerMessage)(e)}: ${this._url}`),this._errorsCount++,t===this._currentPulseIndex&&this._failOnErrorsCount((0,g.getErrorMessage)(e))}finally{
null!==this._requestInterval&&1===this._status&&t===this._currentPulseIndex&&await this._makeNextRequest()}}_clearResetRequestTimeout(){null!==this._requestTimeOut&&(clearTimeout(this._requestTimeOut),this._requestTimeOut=null)}_failOnErrorsCount(t){this._errorsCount>20&&(this._clearResetRequestTimeout(),this._status=2,this.statusChanged.fire({requesterStatus:this._status,errorMessage:t}))}async _makeNextRequest(){const t=this._currentPulseIndex;this._requestTimeOut=null,this._requestTimeOut=setTimeout(async()=>{t===this._currentPulseIndex&&await this._request()},this._requestInterval)}}class O{constructor(t){this.statusChanged=new(w()),this._data=[],this._status=0,this._onNewData=async(t,e)=>{if(1!==this._status)return;const s=(0,g.findArraysDifferences)(this._data,t,this._idField,this._keys,this._useDeepEquals);(s.added.length>0||s.modified.length>0||s.removed.length>0)&&(this._data=t,await this._dataCallback(s,e))};const{idField:e,keys:s,useDeepEquals:r,dataCallback:i,...o}=t;this._dataCallback=i,this._requester=new A({dataCallback:this._onNewData,...o}),this._idField=e,this._keys=s,this._useDeepEquals=r}start(){return this._status=1,this._requester.statusChanged.subscribe(this,this._onStatusChanged),this._requester.start()}stop(){this._status=0,this._requester.statusChanged.unsubscribe(this,this._onStatusChanged),this._requester.stop(),delete this._requester}pause(){this._status=0,this._requester.stop()}unpause(){this._status=1,this._requester.start()}changeHeaders(t){this._requester.changeHeaders(t)}_onStatusChanged(t){this._status=t.requesterStatus,this.statusChanged.fire({requesterStatus:t.requesterStatus,errorMessage:t.errorMessage})}}var D=s(24584),x=s(44777);const E={limit:1,market:2,stop:3,stoplimit:4},q={1:"limit",2:"market",3:"stop",4:"stoplimit"},B={placing:4,inactive:3,working:6,rejected:5,filled:2,cancelled:1},I=["qty","status","filledQty","avgPrice","limitPrice","stopPrice","parentId","duration","customFields","message"],R=["instrument","qty","side","avgPrice","unrealizedPl","realizedPl","stopLoss","trailingStopPips","takeProfit","message"],U=["available","total","btcValue"],M={checked:!1,text:""},L={positions:1e3,quotes:500,orders:500,accountManager:500,balances:1e3},z={locale:window.locale},V=(0,r.t)("This market is not tradable with this brokerage account. Switch to another account and try again"),H=(0,r.t)("You can't trade this market with this brokerage account. Please switch over to a different market and have another try.");function $(t){return t.s&&"ok"!==t.s?{valid:!1,errormsg:t.errmsg}:{valid:!0,data:t.d}}function Q(t){return E[t=t||"market"]}function j(t){return q[t=t||2]}function N(t){return"sell"===t?-1:1}function G(t){return-1===t?"sell":"buy"}function W(t){return void 0!==t.accountManager&&Array.isArray(t.accountManager)&&t.accountManager.length>0}function K(t){return t.amData&&Array.isArray(t.amData)&&t.amData.length>0?t.amData:function(t){const e=(0,g.formatNumber)(t.balance),s=(0,g.formatNumber)(t.unrealizedPl);return[[[e,void 0!==t.equity?(0,g.formatNumber)(t.equity):(0,
g.formatNumber)(t.balance+t.unrealizedPl),s]]]}(t)}function J(t){return t.map(t=>({price:t[0],volume:t[1]}))}function Y(t){return Object.assign({id:t.symbol},t)}function X(t){return t.map(t=>{const e=!t.mutable;return delete t.mutable,{...t,inputType:"ComboBox",preventModify:e}})}function Z(t,e){return e.filter(e=>!(e in t))}function tt(t){return![2,1].includes(t.status)}function et(t,e){return{login:t,password:e,locale:window.locale}}const st=(0,r.t)("Accounts configuration is invalid"),rt=(0,r.t)("Broker configuration is invalid");class it{constructor(t,e,s,r=null,o){var a,u;if(this._accounts=[],this._accountManagerTablesData=[],this._accountManagerTablesDelegates=[],this._fetchedBrokerSymbols=new Set,this._cryptoBalances=[],this._oAuthAuthorizationProvider=null,this._requesters={},this._depthSubscriptions={},this._customFormatters=[],this._permittedSymbolSearchGroups=[],this._accessTokenExpirationTimeout=null,this._loginTasks=null,this._orderColumns=d,this._orderHistoryColumns=h,this._positionColumns=p,this._makeInstrumentOrderDialogCustomFieldsMemoized=(0,D.memoize)(this._makeInstrumentOrderDialogCustomFields,t=>t.concat(this.currentAccount())),this._makeAccountOrderDialogCustomFieldsMemoized=(0,D.memoize)(this._makeAccountOrderDialogCustomFields,()=>this.currentAccount()),this._profitlossEmitters=new Map,this._reconnectOnFailCount=1,this._onQuotesUpdate=t=>{for(const e of t)if("ok"===e.s){const t=e.n,s=this._mapToTV(t);if(null!==s){const r=e.v;r.lp=r.lp||0,r.ch=r.ch||0,r.chp=r.chp||0;const o=this._instruments.get(t);if(void 0===o)throw new Error(`Instrument ${t} not found`);if(("forex"===o.type||"cfd"===o.type)&&void 0!==o.pipSize){const t=(0,i.ensureDefined)(o.minPriceStep);r.spread=n()(r.ask).minus(r.bid).div(t).toNumber()}r.buyPipValue&&r.sellPipValue&&this._pipValueSubscriptions.has(t)&&(this._host.pipValueUpdate(s,{buyPipValue:r.buyPipValue,sellPipValue:r.sellPipValue}),o.pipValue=r.buyPipValue),this._currentQuotes.set(s,{ask:r.ask,bid:r.bid});const a={...r,isHalted:r.halted,isHardToBorrow:r.hardToBorrow,isNotShortable:r.notShortable};this._host.realtimeUpdate(s,a)}else this._logger.logError("Cannot map symbol")}},this._onAccountStateUpdate=t=>{this._setAccountSummaryRowData(t);const e=K(t);this._setAccountManagerTableData(e)},this._onCryptoBalancesUpdate=t=>{const e=(0,g.findArraysDifferences)(this._cryptoBalances,t,"symbol",U);[...e.added,...e.modified].forEach(t=>{const e=this._cryptoBalanceIndexBySymbol(t.symbol);-1!==e?this._cryptoBalances[e]=t:this._cryptoBalances.push(t);const s=Y(t);this._cryptoBalanceTableChangeDelegate.fire(s),this._host.cryptoBalanceUpdate(t.symbol,t)}),e.removed.forEach(t=>{const e=this._cryptoBalanceIndexBySymbol(t.symbol);if(-1!==e){const s=0,r=0,i=0,o=Object.assign({},t,{total:s,available:r,btcValue:i});this._cryptoBalances[e]=o;const n=Y(o);this._cryptoBalanceTableChangeDelegate.fire(n)}})},this._onOrdersUpdate=t=>{const e=this._createTvOrders(t.added),s=this._createTvOrders(t.modified),r=[];this._restOrders.push(...t.added)
;for(const e of t.modified)this._restOrders[this._restOrderIndexById(e.id)]=e;this._tvOrders.push(...e),r.push(...e);for(const t of s)this._tvOrders[this._tvOrderIndexById(t.id)]=t,r.push(t);for(const t of r){if(1===t.parentType){const e=this._tvOrderById(t.parentId);e&&(this._updateParentBrackets(e,t),this._host.orderUpdate(e))}else if(2===t.parentType){const e=this._tvPositionById(t.parentId);e&&e.qty>0&&(this._updateParentBrackets(e,t),this._host.positionPartialUpdate(e.id,{stopLoss:e.stopLoss,trailingStopPips:e.trailingStopPips,takeProfit:e.takeProfit}))}else if(!t.parentType){const e=this._getOrderBrackets(t.id);void 0!==e.stopLoss&&(t.stopLoss=e.stopLoss),void 0!==e.trailingStopPips&&(t.trailingStopPips=e.trailingStopPips),void 0!==e.takeProfit&&(t.takeProfit=e.takeProfit)}this._host.orderUpdate(t)}},this._onPositionsUpdate=async t=>{const e=[],s=this._createTVPositions(t.added),r=this._createTVPositions(t.modified);for(const e of t.added)this._addOrModifyPosition(e,this._restPositions);for(const e of t.modified)this._restPositions[this._restPositionIndexById(e.id)]=e;for(const t of s)this._updatePriceFormatterCacheForSymbol(t.symbol),this._updatePositionBrackets(t),this._host.positionUpdate(t),this._updatePositionPL(t),e.push((0,i.ensureDefined)(t.brokerSymbol,"Add position: Broker symbol")),this._addOrModifyPosition(t,this._tvPositions);for(const t of r){const s=this._tvPositionById(t.id);if(void 0===s)return;this._updatePositionBrackets(t),this._updatePositionPL(t),this._host.positionUpdate(t),s.side===t.side&&s.qty===t.qty||e.push((0,i.ensureDefined)(t.brokerSymbol,"Update position: Broker symbol")),this._addOrModifyPosition(t,this._tvPositions)}t.removed.forEach(t=>{const s=this._tvPositionById(t.id);if(void 0===s)return;const r=this._restPositionById(t.id);s.qty=0,r.qty=0,e.push((0,i.ensureDefined)(s.brokerSymbol,"Remove position: Broker symbol"));const o=this._makePLEmitterKey(s),n=this._profitlossEmitters.get(o);void 0!==n&&(n.stop(),this._profitlossEmitters.delete(o)),this._host.positionUpdate(s)}),this._ensuredConfigFlags().supportExecutions&&await this._requestExecutionsBySymbols(e)},this._host=t,this._fastRenewOauthToken=o,this._restUrl=u="/"===(u=e)[u.length-1]?u:u+"/",this._metainfo=s,this._realtimeSubscriptions=new Set,this._pipValueSubscriptions=new Set,this._quotesSubscriptions=new Map,this._currentQuotes=new Map,this._priceFormatterCache=new Map,this._instruments=new Map,this._initData(),this._tokenStorageKey=String("rest-token"),this._permittedSymbolSearchGroups=[(0,i.ensureDefined)(s.id)],this._lastAccountIdKey=String("rest-last-account-id-"+s.id),this._logger=t.getLogger(),this._status=this._host.factory.createWatchedValue(3),this._account=t.factory.createWatchedValue({id:"",name:"",currencySign:"",config:{},instruments:[],type:l.AccountType.Demo}),(null===(a=this._metainfo.configFlags)||void 0===a?void 0:a.supportUnhideSymbolSearchGroups)||this._createMapper(),r){const t=Date.now()+432e6;this._saveAccessToken({access_token:r,expiration:t}).then(()=>this._setAccessTokenExpirationTimeout(t))
}this._setAccountBinded=this._setAccount.bind(this),this._createButtonDropdownOptions(),this._customFormatters.push({name:"avgPriceFormatter",formatText:t=>{const e=this._priceFormatterCache.get(t.row.symbol);return e?e.format(t.value):String(t.value)}},{name:"cryptoValueInCurrencyFormatter",formatText:t=>`${t.row.value} ${t.row.valueCurrency}`}),this._cryptoBalanceTableChangeDelegate=this._host.factory.createDelegate()}tryRestoreSession(){this._tryRestorePreviousSession()}chartContextMenuActions(t,e){return this._host.defaultContextMenuActions(t,e)}async accountsMetainfo(){return this._accounts}setCurrentAccount(t){const e=this._accounts.find(e=>e.id===t);void 0!==e&&this._account.setValue(e)}accountManagerInfo(){const t=this._accountSummaryRowData.titles.map((t,e)=>({text:t,wValue:this._accountSummaryRowData.values[e].readonly(),formatter:this._accountSummaryRowData.formatters[e],isDefault:!0})),e=[],s=this._ensuredConfigFlags().supportOrderBrackets||this._ensuredConfigFlags().supportPositionBrackets,o=this._ensuredConfigFlags().supportBalances;if(W(this._brokerConfig))if(o){const t=0!==this._cryptoBalances.length?Object.keys(this._cryptoBalances[0]):_.map(t=>t.property),s=_.filter(e=>t.includes(e.property)),r=Object.assign({},{id:"cryptoBalances",name:"Balances",getData:()=>Promise.resolve(this._cryptoBalances.map(t=>Y(t))),changeDelegate:this._cryptoBalanceTableChangeDelegate,columns:s});e.push(r)}else{const t=(0,i.ensure)(this._brokerConfig.accountManager,"Account manager info: Account manager").map((t,e)=>({id:t.id,title:void 0!==t.title&&t.title.length>0?t.title:(0,r.t)("Account Info"),getData:()=>Promise.resolve(this._accountManagerTablesData[e]),changeDelegate:this._accountManagerTablesDelegates[e],columns:t.columns.map(t=>({label:t.title,help:t.tooltip,property:t.id,formatter:t.formatter,notSortable:!t.sortable,tooltip:t.tooltip,isCapitalize:t.isCapitalize}))}));e.push(...t)}const n=(0,i.ensureDefined)(this._metainfo),a=this._brokerConfig.durations&&this._brokerConfig.durations.some(t=>Boolean(t.hasDatePicker||t.hasTimePicker)),u=t=>s||"stopLoss"!==t.property&&"takeProfit"!==t.property,c=t=>this._ensuredConfigFlags().supportTrailingStop||"trailingStopPrice"!==t.property,l=void 0!==n.customPositionColumnTitles&&n.customPositionColumnTitles.length>0?this._positionColumns.map(t=>{const e=(0,i.ensureDefined)(n.customPositionColumnTitles,"Account manager info: Custom position column titles").find(e=>e.hasOwnProperty(t.property));return t.label=void 0!==e?e[(0,i.ensureDefined)(t.property,"Account manager info: Custom position column title property")]:t.label,t}):this._positionColumns,d={accountTitle:(0,i.ensure)(this._metainfo.title),orderColumns:this._orderColumns.filter(u).filter(t=>this._brokerConfig.durations||"expiry"!==t.property).filter(t=>a||"expiryTime"!==t.property).filter(t=>this._ensuredConfigFlags().supportPartialOrderExecution||"filledQty"!==t.property).filter(c),pages:[{id:"summary",title:(0,r.t)("Account Summary"),tables:e}],
positionColumns:l.filter(u).filter(t=>this._ensuredConfigFlags().supportMultiposition||"id"!==t.property).filter(c),summary:t,customFormatters:this._customFormatters};return this._ensuredConfigFlags().supportOrdersHistory&&(d.historyColumns=this._orderHistoryColumns.filter(u)),d}currentAccount(){return this._account.value().id}currentAccountType(){return 0!==this._accounts.length?this._accounts.some(t=>t.type===l.AccountType.Live)?l.AccountType.Live:l.AccountType.Demo:void 0}async executions(t){const e=this._mapFromTV(t);return null!==e&&!1===this._fetchedBrokerSymbols.has(e)&&await this._requestExecutions(e),this._tvExecutions.filter(e=>e.symbol===t)}orders(){return Promise.resolve(this._tvOrders)}async ordersHistory(){const t=await this._getOrdersHistoryByAccountId(this._account.value().id);return this._createTvOrders(t)}positions(){return Promise.resolve(this._tvPositions)}async cancelOrder(t){return P({url:this._getOrderIdRestUrl(t),accessToken:this._getAccessToken(),method:f.Delete,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async modifyOrder(t,e){if(2===t.parentType)return this._modifyPositionBracketsByOrder(t);if(1===t.parentType){const s=this._tvOrderById((0,i.ensure)(t.parentId,"Modify order: Parent id"));return this._updateParentBrackets(s,t),2!==s.status?this.modifyOrder(s,e):this._modifySingleOrder(t,e)}return this._modifySingleOrder(t,e)}async placeOrder(t,e){var s;const r=this._ensuredConfigFlags().supportDigitalSignature;let i=null;if(t.customFields){if(r){i=((null===(s=t.customFields)||void 0===s?void 0:s.digitalSignature)||this._getDigitalSignatureState()).text,await this._setDigitalSignatureState(t.customFields.digitalSignature)}}else{const e=this._makeOrderDialogCustomFields(t.symbol).find(t=>"forceUserEnterInitialValue"in t&&t.forceUserEnterInitialValue);if(void 0!==e)throw new Error("To place order you need to select a {fieldTitle} in the order ticket.".replace("{fieldTitle}",e.title))}const o=Object.assign({},t.customFields);return delete o.digitalSignature,this._placeOrder(t,i,o,e)}async cancelOrders(t,e,s){return(()=>Promise.all(s.map(t=>this.cancelOrder(t))).then(()=>{}))()}editPositionBrackets(t,e){return P({url:this._getPositionIdRestUrl(t),accessToken:this._getAccessToken(),method:f.Put,body:e,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}reversePosition(t,e){const s=this._tvPositionById(t);if(void 0===s)throw new Error(`Failed to reverse position: Position ${t} not found`);const r=1===s.side?"sell":"buy",i=Object.assign({side:r},e);return P({url:this._getPositionIdRestUrl(t),accessToken:this._getAccessToken(),method:f.Put,body:i,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}closePosition(t,e){return P({url:this._getPositionIdRestUrl(t),accessToken:this._getAccessToken(),method:f.Delete,body:{amount:e},includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async isTradable(t){var e;const s=this._mapFromTV(t);if(null!==s){const t=this._instruments.has(s),e={tradable:t};if(!t){
const t=this._getAccountWithTradableSymbol(s);null!==t&&(e.solutions={changeAccount:t.id},e.shortReason=V,e.reason=V)}return e}if(void 0!==this._metainfo.symbolPrefix){const s=t.split(":")[1],r=`${null!==(e=this._account.value().prefix)&&void 0!==e?e:this._metainfo.symbolPrefix}:${s}`,i=this._mapFromTV(r);if(null!==i){if(void 0!==this._instruments.get(i))return{tradable:!1,reason:H,shortReason:H,solutions:{changeSymbol:r}}}}return{tradable:!1}}subscribeRealtime(t){const e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.add(e),this._subscribeQuotes(e)):this._logger.logError("Symbol not found")}unsubscribeRealtime(t){const e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.delete(e),this._unsubscribeQuotes(e)):this._logger.logError("Symbol not found")}subscribePipValue(t){const e=this._mapFromTV(t);if(null!==e){if(!this._instrumentInfo(e).hasQuotes)return;this._pipValueSubscriptions.add(e),this._subscribeQuotes(e)}else this._logger.logError("Symbol not found")}unsubscribePipValue(t){const e=this._mapFromTV(t);null!==e?this._pipValueSubscriptions.has(e)&&(this._pipValueSubscriptions.delete(e),this._unsubscribeQuotes(e)):this._logger.logError("Symbol not found")}subscribeDOME(t){const e=this._mapFromTV(t);if(null!==e){const s=this._onDepthUpdate.bind(this,t),r=new A({url:this._getDepthUrl(e),headers:this._getHeaders(),dataCallback:s,requestInterval:this._getPullingInterval("quotes"),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader,extractResponseData:$});r.start(),this._depthSubscriptions[t]={callback:s,requester:r}}else this._logger.logError("Symbol not found")}unsubscribeDOME(t){try{this._depthSubscriptions[t].requester.stop(),delete this._depthSubscriptions[t]}catch(t){this._logger.logError((0,g.getLoggerMessage)(t))}}async signIn(t,e,s,o){this._setStatus(2),await this._host.credentialsStorage.clear(this._tokenStorageKey);try{let s;if(this._isSimplePasswordAuthorizationType()&&(s=async()=>{const s=await this._authorize(t,e);await this._saveAccessToken(s),await this._setAccessTokenExpirationTimeout(s.expiration)}),this._isTwoFactorAuthorizationType()){if(void 0===(null==o?void 0:o.verificationCode)){const s=await this._authorizeRequestTwoFactorCode(t,e);if(!("twoFactorMessage"in s))throw new Error((0,r.t)("Two Factor Authorization is not configured properly"));return void this._setStatus(4,{message:s.twoFactorMessage,disconnectType:l.DisconnectType.TwoFactorRequired})}s=async()=>{const s=await this._authorizeWithTwoFactorCode(t,e,(0,i.ensureDefined)(o.verificationCode,"Signin: Verification code"));await this._saveAccessToken(s),await this._setAccessTokenExpirationTimeout(s.expiration)}}await this._setAndStartLoginTasks(s),this._createButtonDropdownOptions(),this._reconnectOnFailCount=1,this._setStatus(1),this._updatePLEmitters()}catch(t){this._logger.logError("Failed to connect to broker: "+(0,g.getLoggerMessage)(t));const{disconnectionInfo:e,connectionStatus:s}=(0,x.extractDisconnectionInfoAndConnectionStatus)(t);this._setStatus(s,e),await this._disconnect()}}async symbolInfo(t){
const e=this._mapFromTV(t);if(null!==e)return this._instrumentInfo(e);throw new Error("Symbol not found")}connectionStatus(){return this._status.value()}async disconnect(t=!1){await this._disconnect(t),null!==this._loginTasks&&await this._loginTasks.terminate(),this._setStatus(3,{message:void 0,disconnectType:l.DisconnectType.LogOut})}supportFloatingPanel(){return!0}getRealtimeDataCheckParams(){return{token:this._getAccessToken()}}getVerifyLiveAccountParams(){return{token:this._getAccessToken()}}unhideSymbolSearchGroups(){return this._permittedSymbolSearchGroups}async formatter(t){return this._getPriceFormatterForSymbol(t)}async spreadFormatter(t){const e=this._mapFromTV(t);if(null!==e){const s=this._instruments.get(e);return void 0===s||"forex"!==s.type&&"cfd"!==s.type?this._host.defaultFormatter(t,!1):this._host.numericFormatter(1)}throw new Error("Symbol not found")}quantityFormatter(t){const e=this._mapFromTV(t);if(null!==e){const t=this._instruments.get(e);if(void 0!==t&&"crypto"===t.type)return this._host.quantityFormatter()}return this._host.quantityFormatter()}async previewOrder(t){const e=this._orderFromTV(t);return function(t){return"id"in t}(t)&&(e.id=t.id),void 0!==t.customFields&&Object.assign(e,t.customFields),P({url:this._getOrderPreviewRestUrl(),accessToken:this._getAccessToken(),method:f.Post,body:e,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async getOrderDialogOptions(t){return{customFields:this._makeOrderDialogCustomFields(t)}}getValidationRules(t){var e,s,r;const i=this._mapFromTV(t);if(null!==i)return null===(r=null===(s=null===(e=this._instruments.get(i))||void 0===e?void 0:e.ui)||void 0===s?void 0:s.validationRules)||void 0===r?void 0:r.map(t=>({...t,severity:"error"}))}async leverageInfo(t){const e=this._getLeverageUrl(u.GetLeverage);return this._makeLeverageRequest(t,f.Post,e)}async setLeverage(t){const e=this._getLeverageUrl(u.SetLeverage);return this._makeLeverageRequest(t,f.Post,e)}async previewLeverage(t){return P({url:this._getLeverageUrl(u.PreviewLeverage),accessToken:this._getAccessToken(),method:f.Post,body:this._leverageParamsFromTV(t),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _updateMapper(t,e){return this._mapper=this._host.createMapperSync(t,e),this._mapper.ready()}async _updateAccount(t){void 0!==t.prefix&&t.prefix!==this._currentAccountPrefix&&(this._currentAccountPrefix=t.prefix,await this._updateMapper(this._metainfo.id,this._makeSymbolMapperOptions(t.prefix))),this._saveAccountId(t),this._account.setValue(t);const e=t.durations?t.durations:this._originalBrokerConfig.durations;this._brokerConfig=Object.assign({},this._originalBrokerConfig,t.ui,{durations:e}),this._metainfo.configFlags=Object.assign(this._metainfo.configFlags,t.config),this._ensuredConfigFlags().supportStopOrdersInBothDirections&&(this._ensuredConfigFlags().supportStopOrdersInBothDirectionsInUI=!0),this._host.patchConfig(this._ensuredConfigFlags()),this._makeAccountSummaryRowData(),this._setCustomFields(t)
;for(const e of t.instruments)"forex"!==e.type&&"cfd"!==e.type||void 0===e.pipSize||(e.minPriceStep=n()(10).pow(-(0,g.numOfDecimalPlaces)(e.pipSize)).toNumber()),this._instruments.set(e.name,e);await this._initRequesters();const s=await this._getAccountState();for(let t=0;t<(0,i.ensure)(this._brokerConfig.accountManager,"Update account: Account manager").length;t++){const t=this._host.factory.createDelegate();this._accountManagerTablesDelegates.push(t),this._accountManagerTablesData.push([{}])}this._setAccountManagerTableData(K(s)),this._setAccountSummaryRowData(s),this._brokerConfig.durations&&this._host.setDurations(function(t){const e=[];for(const s of t){const t={name:s.title,value:s.id,hasDatePicker:s.hasDatePicker,hasTimePicker:s.hasTimePicker};void 0!==s.supportedOrderTypes&&(t.supportedOrderTypes=s.supportedOrderTypes.map(t=>Q(t))),"default"in s&&(t.default=s.default),e.push(t)}return e}(this._brokerConfig.durations)),this._changeQuotesRequesterUrl()}async _getAccounts(){const t=await P({url:this._getAccountsUrl(),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader}),e=this._metainfo.defaultAccountType||l.AccountType.Demo;if(!Array.isArray(t))throw new m.UserFriendlyError({detailedErrorMessage:st+": Response is not an array",userFriendlyMessage:st});if(0===t.length)throw new m.UserFriendlyError({detailedErrorMessage:st+": Response is empty",userFriendlyMessage:st});for(const s of t){const t=Z(s,["id","name","type","config"]);if(0!==t.length)throw new m.UserFriendlyError({detailedErrorMessage:st+": Required fields are missing: "+t.join(", "),userFriendlyMessage:st});s.currency=s.currency||"",s.currencySign=s.currencySign||"",s.type=s.type||e}return t}async _setAccount(t){const e=1===this.connectionStatus();this._cleanup(),e&&this._setStatus(2),await this._updateAccount(t),e&&(this._setStatus(1),this._updatePLEmitters())}_updatePLEmitters(){var t;(null===(t=this._metainfo.configFlags)||void 0===t?void 0:t.supportPLUpdate)?this._stopPLEmitters():this._startPLEmitters()}_setAndStartLoginTasks(t){const e=[];return void 0!==t&&e.push(t),e.push(()=>this._getBrokerConfig().then(t=>{this._originalBrokerConfig=t}),...this._initializeAccountTasks()),this._loginTasks=new g.TasksWithTermination(e),this._loginTasks.execute()}_startPLEmitters(){this._profitlossEmitters.forEach(t=>{t.start()})}_createOAuthAuthorizationProvider(t){let e;const s=this._ensuredConfigFlags(),r={fastRenewOauthToken:this._fastRenewOauthToken,brokerId:(0,i.ensureDefined)(this._metainfo.id),environmentType:t,logger:this._logger,passLocalesLangInOAuth:s.passLocalesLangInOAuth};return this._isOAuthImplicitFlowAuthType()?e=new OAuth2ImplicitFlowWithRenewTokenAuthorizationProvider(r):(r.passRedirectUrl=!0,e=new OAuth2CodeFlowAuthorizationProvider({providerConfig:r,credentialsStorage:this._host.credentialsStorage,includeCredentials:s.supportCredentialsHeader})),e}_instrumentInfo(t){const e=this._instruments.get(t);if(!e)throw new Error(`Symbol ${t} not found in instruments`);const s={qty:{
min:e.minQty||1,max:e.maxQty||1e9,step:e.qtyStep||1},units:e.units,pipValue:e.pipValue||1,pipSize:e.pipSize||.01,minTick:e.minTick||.01,description:e.description,brokerSymbol:t,hasQuotes:!e.hasOwnProperty("hasQuotes")||Boolean(e.hasQuotes)};return e.hasOwnProperty("lotSize")&&(s.lotSize=e.lotSize),e.hasOwnProperty("stopPriceStep")&&(s.stopPriceStep=e.stopPriceStep),e.hasOwnProperty("limitPriceStep")&&(s.limitPriceStep=e.limitPriceStep),"type"in e&&(s.type=e.type),"marginRate"in e&&(s.marginRate=e.marginRate),"baseCurrency"in e&&(s.baseCurrency=e.baseCurrency),"quoteCurrency"in e&&(s.quoteCurrency=e.quoteCurrency),s}_subscribeQuotes(t){const e=this._quotesSubscriptions.get(t),s=void 0===e?1:e+1;this._quotesSubscriptions.set(t,s),1===s&&this._changeQuotesRequesterUrl()}_unsubscribeQuotes(t){const e=this._quotesSubscriptions.get(t);if(void 0!==e)return 1===e?(this._quotesSubscriptions.delete(t),void this._changeQuotesRequesterUrl()):void this._quotesSubscriptions.set(t,e-1)}async _disconnect(t=!1){this._isOAuthAuthorizationType()&&this._cleanAndDestroyOauthAuthorizationProvider(),this._cleanup(),this._cleanAccessTokenExpirationTimeout(),!1===t&&(await this._host.credentialsStorage.clear(this._tokenStorageKey),this._ensuredConfigFlags().supportLogout&&await this._logout()),this._account.unsubscribe(this._setAccountBinded)}_getAccessToken(){return this._accessToken}_initializeAccountTasks(){const t=[];return t.push(()=>this._getAccounts().then(t=>{this._accounts=t})),t.push(()=>Promise.all(this._accounts.map(t=>this._getInstrumentsByAccountId(t.id).then(e=>{t.instruments=e})))),this._ensuredConfigFlags().supportUnhideSymbolSearchGroups?t.push(async()=>{this._permittedSymbolSearchGroups=await this._getPermittedSymbolSearchGroups();const t=this._getLastOrDefaultAccount();this._currentAccountPrefix=t.prefix,await this._updateMapper(this._metainfo.id,this._makeSymbolMapperOptions(t.prefix))}):t.push(()=>this._mapper.ready()),t.push(()=>{const t=this._getLastOrDefaultAccount();return this._setCustomFields(t),this._setAccountBinded(t).then(()=>this._account.subscribe(this._setAccountBinded))}),t}_makeSymbolMapperOptions(t){return{unhideSymbolSearchGroups:this.unhideSymbolSearchGroups(),exchange:t}}_setCustomFields(t){var e,s,r,i,o,n;const a=null!==(s=null===(e=t.ui)||void 0===e?void 0:e.orderCustomFields)&&void 0!==s?s:this._originalBrokerConfig.orderCustomFields;t.config.supportOrderCustomFields&&void 0!==a&&(this._orderColumns=this._mergeCustomFieldColumns(d,a));const u=null!==(i=null===(r=t.ui)||void 0===r?void 0:r.orderHistoryCustomFields)&&void 0!==i?i:this._originalBrokerConfig.orderHistoryCustomFields;t.config.supportOrderHistoryCustomFields&&void 0!==u&&(this._orderHistoryColumns=this._mergeCustomFieldColumns(h,u));const c=null!==(n=null===(o=t.ui)||void 0===o?void 0:o.positionCustomFields)&&void 0!==n?n:this._originalBrokerConfig.positionCustomFields;t.config.supportPositionCustomFields&&void 0!==c&&(this._positionColumns=this._mergeCustomFieldColumns(p,c))}_changeQuotesRequesterUrl(){const t=this._getQuotesUrl()
;void 0!==this._requesters.quotes&&this._requesters.quotes.stop(),null!==t&&(void 0===this._requesters.quotes?(this._requesters.quotes=new A({url:t,headers:this._getHeaders(),dataCallback:this._onQuotesUpdate,requestInterval:this._getPullingInterval("quotes"),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader,extractResponseData:$}),this._requesters.quotes.statusChanged.subscribe(this,this._onRequesterStatusUpdate)):this._requesters.quotes.changeUrl(t),this._requesters.quotes.start())}_stopRequester(t){void 0!==t&&t.stop()}async _requestExecutions(t){this._fetchedBrokerSymbols.add(t);const e=await S({url:this._getExecutionsUrl(t),method:f.Get,headers:this._getHeaders(),body:null,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader,extractResponseData:$}),s=(0,g.findArraysDifferences)(this._restExecutions,e,"id",["id"]);for(const t of s.added){this._restExecutions.push(t);const e=this._executionToTv(t);this._tvExecutions.push(e),this._host.executionUpdate(e)}}_createMapper(){this._mapper=this._host.createMapperSync(this._metainfo.id,{unhideSymbolSearchGroups:this.unhideSymbolSearchGroups()})}async _requestExecutionsBySymbols(t){await Promise.all(t.map(t=>this._requestExecutions(t)))}_setAccountSummaryRowData(t){var e;const s=t.hasOwnProperty("equity")&&void 0!==t.equity?t.equity:t.balance+t.unrealizedPl;if(this._ensuredConfigFlags().supportCustomAccountSummaryRow){const e=(0,i.ensureDefined)(t.accountSummaryRowData,"Set Account Summary Row Data: Account summary row data");for(let t=0;t<e.length;t++)this._accountSummaryRowData.values[t].setValue(e[t])}else this._accountSummaryRowData.values[0].setValue(t.balance),this._accountSummaryRowData.values[1].setValue(s),(null===(e=this._metainfo.configFlags)||void 0===e?void 0:e.supportPLUpdate)?this._accountSummaryRowData.values[2].setValue(t.unrealizedPl):this._updateAccountPL();isFinite(s)&&this._host.equityUpdate(s)}_setAccountManagerTableData(t){if(0!==this._accountManagerTablesData.length)for(let e=0;e<t.length;e++){const s=t[e],r=this._accountManagerTablesData[e],o=(0,i.ensure)(this._brokerConfig.accountManager,"Set Account Manager Table Data: Account manager tables")[e].columns;r.length=s.length;for(let t=0;t<s.length;t++){const n=s[t],a={id:t};for(let t=0;t<n.length;t++){a[(0,i.ensure)(o[t].id)]=n[t]}r[t]=a,this._accountManagerTablesDelegates[e].fire(a)}}}async _createRequesters(){const t=this._ensuredConfigFlags(),e=t.supportCredentialsHeader;if(this._requesters={orders:new O({url:this._getOrdersRestUrl(),headers:this._getHeaders(),dataCallback:this._onOrdersUpdate,includeCredentials:e,requestInterval:this._getPullingInterval("orders"),idField:"id",keys:I,extractResponseData:$,useDeepEquals:!0}),accountState:new A({url:this._getAccountStateRestUrl(),method:f.Get,headers:this._getHeaders(),dataCallback:this._onAccountStateUpdate,includeCredentials:e,requestInterval:this._getPullingInterval("accountManager"),extractResponseData:$})},t.supportPositions){const t=new O({url:this._getPositionsRestUrl(),method:f.Get,
headers:this._getHeaders(),dataCallback:this._onPositionsUpdate,requestInterval:this._getPullingInterval("positions"),idField:"id",keys:R,includeCredentials:e,extractResponseData:$});t.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.positions=t}if(t.supportBalances){const t=new A({url:this._getBalancesRestUrl(),headers:this._getHeaders(),dataCallback:this._onCryptoBalancesUpdate,includeCredentials:e,requestInterval:this._getPullingInterval("balances"),extractResponseData:$});t.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.balances=t}(0,i.ensure)(this._requesters.orders).statusChanged.subscribe(this,this._onRequesterStatusUpdate)}async _startRequesters(){const t=[];Object.keys(this._requesters).forEach(e=>t.push((0,i.ensure)(this._requesters[e]).start())),await Promise.all(t),this._logger.logInfo("Requesters started")}_stopAndDeleteRequesters(){Object.keys(this._requesters).forEach(t=>{const e=this._requesters[t];void 0!==e&&this._stopRequester(e)}),this._requesters={}}_changeRequestersHeaders(){Object.keys(this._requesters).forEach(t=>{const e=(0,i.ensure)(this._requesters[t]);e.pause(),e.changeHeaders(this._getHeaders()),e.unpause()})}_cleanup(){this._stopAndDeleteRequesters(),this._cleanAndStopPLEmitters(),this._initData()}_cleanAndStopPLEmitters(){this._stopPLEmitters(),this._profitlossEmitters.clear()}_stopPLEmitters(){this._profitlossEmitters.forEach(t=>{t.stop()})}_setStatus(t,e){this._status.value()!==t&&(this._status.setValue(t),this._host.connectionStatusUpdate(t,e))}async _onRequesterStatusUpdate(t){2===t.requesterStatus&&(this._reconnectOnFailCount<=3?(this._logger.logError(`Requester error: ${t.errorMessage}. Reconnecting count: ${this._reconnectOnFailCount++} of 3.`),this._setStatus(4,{message:t.errorMessage}),await this._disconnect(!0),this._tryReconnect()):(this._logger.logError(`Requester error: ${t.errorMessage}. Maximum reconnect count reached. Disconnecting.`),this._setStatus(3,{message:t.errorMessage,disconnectType:l.DisconnectType.FailedRestoring}),await this._disconnect(!1)))}_cryptoBalanceIndexBySymbol(t){return this._cryptoBalances.findIndex(e=>e.symbol===t)}async _tryConnect(){const t=this._getStoredAuthResult();t&&(this._accessToken=t.access_token,this._setStatus(2),await this._setAndStartLoginTasks(),this._setAccessTokenExpirationTimeout(t.expiration),this._createButtonDropdownOptions(),this._setStatus(1),this._updatePLEmitters())}async _tryReconnect(){try{await this._tryConnect()}catch(t){this._logger.logError((0,g.getLoggerMessage)(t)),this._setStatus(3,{message:(0,g.getErrorMessage)(t),disconnectType:l.DisconnectType.FailedRestoring}),await this._disconnect()}}async _tryRestorePreviousSession(){try{await this._tryConnect()}catch(t){const e=(0,g.getErrorMessage)(t);this._logger.logNormal("Cannot restore session: "+e),this._setStatus(3,{message:void 0,disconnectType:l.DisconnectType.FailedRestoring}),await this._disconnect()}}_mergeCustomFieldColumns(t,e){const s=t.slice(),r=t.map(t=>t.property);for(const t of e){if(t.id in r){
this._logger.logWarn(`Failed to add custom column. Column with id ${t.id} already exists.`);continue}const{id:e,title:o,tooltip:n,alignment:a}=t,u={label:o,property:e,help:n,notSortable:!0};void 0!==a&&((0,i.assert)(["left","right"].includes(a),"Cell alignment must be left or right"),u.alignment=a),s.splice(-1,0,u)}return s}_authorizeRequestTwoFactorCode(t,e){return P({url:this._getAuthorizeUrl(),method:f.Post,body:{...et(t,e),twoFactorRequired:!0},includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}_authorizeWithTwoFactorCode(t,e,s){return P({url:this._getAuthorizeUrl(),method:f.Post,body:{...et(t,e),twoFactorCode:s},includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _authorize(t,e){return P({url:this._getAuthorizeUrl(),method:f.Post,body:{...et(t,e)},includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _getInstrumentsByAccountId(t){return P({url:this._getInstrumentsUrlByAccountId(t),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _getOrdersHistoryByAccountId(t){return P({url:this._getOrdersHistoryUrlByAccountId(t),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _getPermittedSymbolSearchGroups(){const t=await P({url:this._getPermissionsUrl(),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader});return t.hasOwnProperty("groups")?t.groups:[(0,i.ensureDefined)(this._metainfo.id)]}async _getBrokerConfig(){const t=await P({url:this._getBrokerConfigUrl(),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader});if(null===t)throw new m.UserFriendlyError({detailedErrorMessage:rt+": Response is null",userFriendlyMessage:rt});return W(t)||(t.accountManager=[{id:"accountSummary",title:"",columns:[{id:"balance",title:(0,r.t)("Balance"),tooltip:"",sortable:!1},{id:"equity",title:(0,r.t)("Equity"),tooltip:"",sortable:!1},{id:"profit",title:(0,r.t)("Profit"),tooltip:"",sortable:!1}]}]),t}async _getAccountState(){return P({url:this._getAccountStateUrl(),accessToken:this._getAccessToken(),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _placeOrder(t,e,s,r){const i=this._orderFromTV(t);i.confirmId=r,null!==e&&(i.digitalSignature=e);const o=Object.assign(s,i);return P({url:this._getOrdersRestUrl()+"&requestId="+(0,C.randomHashN)(10),accessToken:this._getAccessToken(),method:f.Post,body:o,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _modifyOrder(t,e,s,r){const i={id:t.id,qty:t.qty};void 0===t.parentId&&(t.stopLoss&&(i.stopLoss=t.stopLoss),t.trailingStopPips&&(i.trailingStopPips=t.trailingStopPips),t.takeProfit&&(i.takeProfit=t.takeProfit)),void 0!==t.duration&&(i.durationType=t.duration.type,void 0!==t.duration.datetime&&(i.durationDateTime=Math.trunc(t.duration.datetime/1e3)));const o=this._currentQuotes.get(t.symbol);void 0!==o&&(i.currentAsk=o.ask,
i.currentBid=o.bid),i.limitPrice=(t.type,t.limitPrice),i.stopPrice=(t.type,t.stopPrice),null!==e&&(i.digitalSignature=e);const n=Object.assign(s,i);n.confirmId=r,await P({url:this._getOrderIdRestUrl(t.id),accessToken:this._getAccessToken(),method:f.Put,body:n,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}async _modifySingleOrder(t,e){const s=this._ensuredConfigFlags().supportDigitalSignature,r=t.customFields&&t.customFields.digitalSignature?t.customFields.digitalSignature:this._getDigitalSignatureState(),i=s?r.text:null;null!==i&&await this._setDigitalSignatureState(r);const o=Object.assign({},t.customFields);return delete o.digitalSignature,this._modifyOrder(t,i,o,e)}async _modifyPositionBracketsByOrder(t){if(void 0===this._tvPositionById(t.parentId))return;const e={...this._getPositionBrackets(t.parentId)};return 3===t.type&&(t.stopType===c.StopType.TrailingStop?(delete e.stopLoss,e.trailingStopPips=t.trailingStopPips):(delete e.trailingStopPips,e.stopLoss=t.stopPrice)),1===t.type&&(e.takeProfit=t.limitPrice),this.editPositionBrackets((0,i.ensure)(t.brokerSymbol,"Edit position brackets: Broker symbol"),e)}_createTvOrders(t){return t.map(t=>this._orderToTV(t))}_createTVPositions(t){return t.map(t=>this._positionToTV(t))}_updatePositionPL(t){var e;if(null===(e=this._metainfo.configFlags)||void 0===e?void 0:e.supportPLUpdate){const e=this._tvPositionById(t.id);(null==e?void 0:e.unrealizedPl)!==t.unrealizedPl&&(this._host.plUpdate(t.id,t.unrealizedPl),this._host.positionPartialUpdate(t.id,{unrealizedPl:t.unrealizedPl}))}else{const e=this._makePLEmitterKey(t),s=this._profitlossEmitters.get(e);if(void 0!==s)s.positionUpdate(t),t.unrealizedPl=null==s?void 0:s.lastPL();else{const s=e=>{this._host.plUpdate(t.id,e),this._host.positionPartialUpdate(t.id,{unrealizedPl:e})},r=t.symbol,i=this._mapper.tvToBroker(r);try{if(null===i)throw new Error(`Symbol ${r} not found in mapping`);const o=this._instrumentInfo(i),n=this._host.createPLEmitter(t,s,o);this._profitlossEmitters.set(e,n),1===this.connectionStatus()&&n.start()}catch(t){this._logger.logError((0,g.getLoggerMessage)(t))}}}}_updateAccountPL(){let t=0;this._profitlossEmitters.forEach(e=>{t+=e.lastPL()}),this._accountSummaryRowData.values[2].setValue(t)}_updatePositionBrackets(t){this._findPositionBracketOrders(t.id).forEach(e=>this._updateParentBrackets(t,e))}_addOrModifyPosition(t,e){const s=e.findIndex(e=>e.id===t.id);-1!==s?e[s]=t:e.push(t)}_makePLEmitterKey(t){return this._ensuredConfigFlags().supportMultiposition?t.id:t.symbol}_restPositionIndexById(t){return this._restPositions.findIndex(e=>e.id===t)}_restPositionById(t){const e=this._restPositions.find(e=>e.id===t);if(!e)throw new Error("Cannot find REST position: "+t);return e}_restOrderIndexById(t){return this._restOrders.findIndex(e=>e.id===t)}_tvPositionById(t){return this._tvPositions.find(e=>e.id===t)}_tvOrderIndexById(t){return this._tvOrders.findIndex(e=>e.id===t)}_tvOrderById(t){const e=this._tvOrders.find(e=>e.id===t);if(!e)throw new Error("Cannot find TV order");return e}
_getBaseRestUrl(){const t=this._account.value().id;return(0,i.assert)(!!t,"Unable to get base url - account is not properly initialized"),this._getBaseRestUrlByAccountId(t)}_getBaseRestUrlByAccountId(t){return`${this._restUrl}accounts/${encodeURIComponent(t)}`}_getAccountStateRestUrl(){return`${this._getBaseRestUrl()}/state?${a(z)}`}_getExecutionsUrl(t){const e={...z,instrument:t};return`${this._getBaseRestUrl()}/executions?${a(e)}`}_getPullingInterval(t){let e=L[t];if(this._brokerConfig.hasOwnProperty("pullingInterval")&&void 0!==this._brokerConfig.pullingInterval){const s=this._brokerConfig.pullingInterval[t];void 0!==s&&(e=s)}return e}_getAuthorizeUrl(){return this._restUrl+"authorize"}_getBrokerConfigUrl(){return`${this._restUrl}config?${a(z)}`}_getAccountsUrl(){return`${this._restUrl}accounts?${a(z)}`}_getAccountStateUrl(){return`${this._getBaseRestUrl()}/state?${a(z)}`}_getLeverageUrl(t){return`${this._getBaseRestUrl()}/${t}?${a(z)}`}_getQuotesUrl(){const t=Array.from(this._quotesSubscriptions.keys()).filter(t=>this._instruments.has(t));if(0===t.length)return null;const e={...z,symbols:t.join(","),accountId:this._account.value().id};return`${this._restUrl}quotes?${a(e)}`}_getDepthUrl(t){const e={...z,symbol:t,accountId:this._account.value().id};return`${this._restUrl}depth?${a(e)}`}_getInstrumentsUrlByAccountId(t){return`${this._getBaseRestUrlByAccountId(t)}/instruments?${a(z)}`}_getLogoutUrl(){return this._restUrl+"logout"}_getOrdersHistoryUrlByAccountId(t){const e={...z,maxCount:200};return`${this._getBaseRestUrlByAccountId(t)}/ordersHistory?${a(e)}`}_getPermissionsUrl(){return this._restUrl+"permissions"}_getOrdersRestUrl(){return`${this._getBaseRestUrl()}/orders?${a(z)}`}_getOrderIdRestUrl(t){return`${this._getBaseRestUrl()}/orders/${t}?${a(z)}`}_getPositionsRestUrl(){return`${this._getBaseRestUrl()}/positions?${a(z)}`}_getPositionIdRestUrl(t){return`${this._getBaseRestUrl()}/positions/${t}?${a(z)}`}_getBalancesRestUrl(){return`${this._getBaseRestUrl()}/balances?${a(z)}`}_getOrderPreviewRestUrl(){return`${this._getBaseRestUrl()}/previewOrder?${a(z)}`}async _logout(){try{await P({url:this._getLogoutUrl(),accessToken:this._getAccessToken(),method:f.Post,includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}catch(t){this._logger.logError("Failed to logout request: "+(0,g.getLoggerMessage)(t))}}_getHeaders(){return b(this._getAccessToken())}_orderToTV(t){const e=this._mapToTV(t.instrument);null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument);const s={id:t.id,type:Q(t.type),side:N(t.side),symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),filledQty:t.filledQty,status:(r=t.status,B[r]),avgPrice:t.avgPrice,limitPrice:t.limitPrice,stopPrice:t.stopPrice};var r;if(t.parentId&&(s.parentId=t.parentId,s.parentType=this._getOrderParentType(t.parentType),t.isTrailingStop&&(s.stopType=c.StopType.TrailingStop,s.trailingStopPips=t.trailingStopPips)),t.duration){s.duration={type:t.duration.type};const e=this._getOrderDuration(t.duration);if((0,
i.assert)(void 0!==e,"Order duration is not in durations list. Please check the broker or account duration configuration"),s.expiry=void 0!==e?e.title:t.duration.type,t.duration.hasOwnProperty("datetime")&&void 0!==t.duration.datetime){const r=1e3*t.duration.datetime;s.duration.datetime=r,s.expiryTime={dateOrDateTime:r,hasTime:(0,i.ensureDefined)(e).hasTimePicker}}}return void 0!==t.message&&((0,g.isOrderOrPositionMessageType)(t.message.type)?s.message=t.message:this._logger.logError(`Order message type '${t.message.type}' is not supported`)),void 0!==t.lastModified&&(s.updateTime=1e3*t.lastModified),void 0!==t.customFields&&(s.customFields=this._customFieldsToTv(t.customFields)),this._mergeCustomFields(t,s),s}_getOrderParentType(t){return"position"===t?2:1}_customFieldsToTv(t){const e={};for(const s of t)e[s.id]=s.value;return e}_mergeCustomFields(t,e){if(void 0!==t.customFields)for(const s of t.customFields)e[s.id]=s.value}_getOrderDuration(t){return(0,i.ensureDefined)(this._brokerConfig.durations,"Broker config: Durations").find(e=>e.id===(0,i.ensureDefined)(t).type)}_orderFromTV(t){var e,s;const r=this._mapFromTV(t.symbol);if(null!==r){const o={instrument:r,qty:t.qty,side:G(t.side),type:j(t.type),limitPrice:t.limitPrice,stopPrice:t.stopPrice};t.stopLoss&&(o.stopLoss=t.stopLoss),t.trailingStopPips&&(o.trailingStopPips=t.trailingStopPips),t.takeProfit&&(o.takeProfit=t.takeProfit),t.duration&&(o.durationType=t.duration.type,t.duration.datetime&&(o.durationDateTime=Math.trunc(t.duration.datetime/1e3)));const n=this._currentQuotes.get(t.symbol);return void 0===n&&null===t.seenPrice||(o.currentAsk=(0,i.ensure)(null!==(e=null==n?void 0:n.ask)&&void 0!==e?e:t.seenPrice,"OrderFromTv: Current ask"),o.currentBid=(0,i.ensure)(null!==(s=null==n?void 0:n.bid)&&void 0!==s?s:t.seenPrice,"OrderFromTv: Current bid")),o}throw new Error("Cannot map symbol: "+t.symbol)}_leverageParamsFromTV(t){const e=this._mapFromTV(t.symbol);if(null===e)throw new Error("Cannot map symbol: "+t.symbol);const s={instrument:e,side:G(t.side),orderType:j(t.orderType)};return"leverage"in t&&(s.leverage=t.leverage),void 0!==t.customFields&&Object.assign(s,t.customFields),s}_getBrackets(t){const e={};for(const s of t)3===s.type&&(s.stopType===c.StopType.TrailingStop?e.trailingStopPips=s.trailingStopPips:e.stopLoss=s.stopPrice),1===s.type&&(e.takeProfit=s.limitPrice);return e}_getOrderBrackets(t){const e=this._tvOrders.filter(e=>1===e.parentType&&e.parentId===t&&1!==e.status&&2!==e.status);return this._getBrackets(e)}_findPositionBracketOrders(t){return this._tvOrders.filter(e=>2===e.parentType&&e.parentId===t&&6===e.status)}_getPositionBrackets(t){const e=this._findPositionBracketOrders(t);return this._getBrackets(e)}_executionToTv(t){const e=this._mapToTV(t.instrument);return null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument),{id:t.id,symbol:e||"",brokerSymbol:t.instrument,price:t.price,qty:t.qty,side:N(t.side),time:1e3*t.time,orderId:t.orderId,isClose:t.isClose,positionId:t.positionId,commission:t.commission}}_positionToTV(t){
const e=this._mapToTV(t.instrument);null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument);const s={id:t.id,symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),side:"buy"===t.side?1:-1,avgPrice:t.avgPrice,realizedPl:t.realizedPl,currency:this._account.value().currency};return void 0!==t.message&&((0,g.isOrderOrPositionMessageType)(t.message.type)?s.message=t.message:this._logger.logError(`Position message type '${t.message.type}' is not supported`)),this._ensuredConfigFlags().supportPLUpdate&&(s.unrealizedPl=t.unrealizedPl),this._tvOrders.filter(t=>2===t.parentType&&t.parentId===s.id).forEach(t=>this._updateParentBrackets(s,t)),this._mergeCustomFields(t,s),s}_mapToTV(t){return this._mapper.brokerToTv(t)}_mapFromTV(t){return this._mapper.tvToBroker(t)}_initData(){this._accountManagerTablesDelegates=[],this._accountManagerTablesData=[],this._restExecutions=[],this._tvExecutions=[],this._restOrders=[],this._tvOrders=[],this._restPositions=[],this._tvPositions=[],this._instruments.clear(),this._priceFormatterCache.clear(),this._currentQuotes.clear(),this._cryptoBalances=[],this._accountSummaryRowData={titles:[],values:[],formatters:[]}}_createButtonDropdownOptions(){const t=this._host.defaultDropdownMenuActions({tradingProperties:!0});this._host.setButtonDropdownActions(t)}async _initRequesters(){this._accounts.length>0&&(await this._createRequesters(),await this._startRequesters())}_getStoredAuthResult(){return this._host.credentialsStorage.load(this._tokenStorageKey)}async _setAccessTokenExpirationTimeout(t){if(null===t)return;let e,s=this._checkAccessTokenExpiration.bind(this);e=1e3*(0,i.ensureDefined)(t,"Access token expiration")-Date.now().valueOf(),e<0?await this._checkAccessTokenExpiration():(s=this._checkAccessTokenExpiration.bind(this),e+=1e4,this._accessTokenExpirationTimeout=setTimeout(s,e))}async _saveAccessToken(t){await this._host.credentialsStorage.save(this._tokenStorageKey,t),this._accessToken=t.access_token}async _checkAccessTokenExpiration(){const t=this._getStoredAuthResult();if(t&&1e3*(0,i.ensureNotNull)(t.expiration,"Stored authorization result expiration")<=Date.now().valueOf()){const t=(0,r.t)("Access token has expired");this._logger.logError(t),this._setStatus(4,{message:t,disconnectType:l.DisconnectType.LogOut}),await this._disconnect()}}_onDepthUpdate(t,e){const s={snapshot:!0,asks:J(e.asks),bids:J(e.bids)};this._host.domeUpdate(t,s)}_getAccountWithTradableSymbol(t){let e=null;for(const s of this._accounts)if(-1!==s.instruments.findIndex(e=>t===e.name)){e=s;break}return e}async _createPriceFormatter(t){try{if(await this._host.isFractional(t))return await this._host.defaultFormatter(t,!0);const e=this._mapFromTV(t);if(null===e)throw new Error("Symbol not found");const s=this._instruments.get(e);if(void 0===s)throw new Error("Instrument not found");const r=Math.pow(10,(0,g.numOfDecimalPlaces)(s.minTick)),i=n()(s.minTick).mul(r).toNumber();return this._host.factory.createPriceFormatter(r,i,!1)}catch(e){
return this._logger.logWarn(`Failed to create price formatter for symbol ${t}.`),this._host.factory.createPriceFormatter()}}async _getPriceFormatterForSymbol(t){let e=this._priceFormatterCache.get(t);return e||(e=await this._createPriceFormatter(t),this._priceFormatterCache.set(t,e)),e}async _updatePriceFormatterCacheForSymbol(t){if(!this._priceFormatterCache.has(t)){this._priceFormatterCache.set(t,null);const e=await this._createPriceFormatter(t);this._priceFormatterCache.set(t,e),this._tvPositions.filter(e=>e.symbol===t&&e.qty>0).forEach(t=>this._host.positionUpdate(t))}}_getAccountById(t){return this._accounts.find(e=>e.id===t)}_saveAccountId(t){this._host.settings.save(this._lastAccountIdKey,JSON.stringify(t.id))}_getLastOrDefaultAccount(){var t;const e=this._host.settings.load(this._lastAccountIdKey,void 0);return void 0===e?this._accounts[0]:null!==(t=this._getAccountById(JSON.parse(e)))&&void 0!==t?t:this._accounts[0]}_isTwoFactorAuthorizationType(){return"password"===this._ensuredConfigFlags().authorizationType&&Boolean(this._ensuredConfigFlags().supportTwoFactorAuthorization)}_isSimplePasswordAuthorizationType(){return"password"===this._ensuredConfigFlags().authorizationType&&!this._ensuredConfigFlags().supportTwoFactorAuthorization}_isOAuthAuthorizationType(){return this._isOAuthCodeFlowAuthType()||this._isOAuthImplicitFlowAuthType()}_isOAuthImplicitFlowAuthType(){return"oauth2-implicit-flow"===this._ensuredConfigFlags().authorizationType}_isOAuthCodeFlowAuthType(){return"oauth2-code-flow"===this._ensuredConfigFlags().authorizationType}_makeDigitalSignatureCustomField(){return{inputType:"TextWithCheckBox",id:"digitalSignature",title:(0,r.t)("Digital Signature"),placeHolder:(0,r.t)("Enter your personal digital signature"),value:this._getDigitalSignatureState(),customInfo:{checkboxTitle:(0,r.t)("Save"),asterix:!0}}}async _setDigitalSignatureState(t){const e=t.checked?t:M;await this._host.credentialsStorage.save("digital-signature-state",e)}_getDigitalSignatureState(){const t=this._host.credentialsStorage.load("digital-signature-state");return null!==t?t:M}_makeAccountSummaryRowData(){let t=[],e=[];const s=[];if(this._ensuredConfigFlags().supportCustomAccountSummaryRow&&void 0!==this._brokerConfig.accountSummaryRow)for(const r of this._brokerConfig.accountSummaryRow)t.push(r.title),e.push(this._host.factory.createWatchedValue()),s.push("default");else t=[(0,r.t)("Account Balance"),(0,r.t)("Equity",{context:"trading"}),(0,r.t)("Profit")],e=[this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue()],s.fill("fixed",0,2);this._accountSummaryRowData.titles=t,this._accountSummaryRowData.values=e,this._accountSummaryRowData.formatters=s}_cleanAccessTokenExpirationTimeout(){null!==this._accessTokenExpirationTimeout&&(clearTimeout(this._accessTokenExpirationTimeout),this._accessTokenExpirationTimeout=null)}_cleanAndDestroyOauthAuthorizationProvider(){
null!==this._oAuthAuthorizationProvider&&(this._oAuthAuthorizationProvider.renewTokenDelegate().unsubscribe(this,this._onRenewAccessTokenHandler),this._oAuthAuthorizationProvider.destroy(),this._oAuthAuthorizationProvider=null)}async _onRenewAccessTokenHandler(t){if(null===t)return this._setStatus(3),void await this._disconnect();await this._saveAccessToken(t),this._changeRequestersHeaders()}_ensuredConfigFlags(){return(0,i.ensureDefined)(this._metainfo.configFlags,"Config flags")}_makeAccountOrderDialogCustomFields(t){var e,s;return(null===(s=null===(e=t.ui)||void 0===e?void 0:e.orderDialogCustomFields)||void 0===s?void 0:s.comboBox)?X(t.ui.orderDialogCustomFields.comboBox):[]}_makeInstrumentOrderDialogCustomFields(t){var e,s,r;const i=this._mapFromTV(t);if(null===i)return[];const o=null===(r=null===(s=null===(e=this._instruments.get(i))||void 0===e?void 0:e.ui)||void 0===s?void 0:s.orderDialogCustomFields)||void 0===r?void 0:r.comboBox;return void 0!==o?X(o):[]}_makeOrderDialogCustomFields(t){const e=this._makeInstrumentOrderDialogCustomFieldsMemoized(t),s=this._makeAccountOrderDialogCustomFieldsMemoized(this._account.value()),r=[...e.length>0?e:s];return this._ensuredConfigFlags().supportDigitalSignature&&r.push(this._makeDigitalSignatureCustomField()),r}_makeLeverageRequest(t,e,s){return P({url:s,accessToken:this._getAccessToken(),method:e,body:this._leverageParamsFromTV(t),includeCredentials:this._ensuredConfigFlags().supportCredentialsHeader})}_updateParentBrackets(t,e){const s=tt(e);if(!s){if(void 0!==this._tvOrders.find(s=>s.parentId===t.id&&s.id!==e.id&&s.type===e.type&&tt(s)))return}const r=s?e.limitPrice:void 0,i=s?e.trailingStopPips:void 0,o=s?e.stopPrice:void 0;3===e.type&&(e.stopType===c.StopType.TrailingStop?(delete t.stopLoss,t.trailingStopPips=i,t.trailingStopPrice=o):(delete t.trailingStopPips,t.stopLoss=o)),1===e.type&&(t.takeProfit=r)}}},50420:(t,e,s)=>{function r(t){return t instanceof Error&&"UserFriendlyError"===t.name}s.d(e,{isUserFriendlyError:()=>r,UserFriendlyError:()=>i});class i extends Error{constructor({detailedErrorMessage:t,userFriendlyMessage:e,originalError:s}){super(e),this.name="UserFriendlyError",this.detailedErrorMessage=t,this.originalError=s}}},50317:(t,e,s)=>{s.d(e,{orderStatusToText:()=>f,sideToText:()=>v,orderTypeToText:()=>P,findArraysDifferences:()=>T,formatNumber:()=>S,isOrderOrPositionMessageType:()=>C,roundToStepByPriceTypeAndSide:()=>k,TasksWithTermination:()=>F,numOfDecimalPlaces:()=>O,roundDownToPowerOf10:()=>D,isFinalOrderStatus:()=>x,positionSideToText:()=>E,makeNonTradableSymbolText:()=>q,getErrorMessage:()=>B,getLoggerMessage:()=>I});var r=s(25177),i=s(60521),o=s(24818),n=s(72249),a=s(2683),u=s(51951),c=s(96796),l=s(50420),d=s(44777);const h={2:{},1:{}},p={},_={},g={};let m=!1;const y=(0,u.getLogger)("Trading.Utils");function f(t){return b(),g[t]}function b(){m||(m=!0,h[2][2]=(0,r.t)("Mkt",{context:"Market order"}),h[2][1]=(0,r.t)("Lmt",{context:"Limit order"}),h[2][3]=(0,r.t)("Stp",{context:"order"}),h[2][4]=(0,r.t)("Stp lmt",{context:"Stop limit order"}),
h[1][2]=(0,r.t)("Market"),h[1][1]=(0,r.t)("Limit"),h[1][3]=(0,r.t)("Stop",{context:"order"}),h[1][4]=(0,r.t)("StopLimit"),p[1]=(0,r.t)("Buy",{context:"trading"}),p[-1]=(0,r.t)("Sell",{context:"trading"}),_[1]=(0,r.t)("Long",{context:"trading"}),_[-1]=(0,r.t)("Short",{context:"trading"}),g[2]=(0,r.t)("filled"),g[1]=(0,r.t)("cancelled"),g[6]=(0,r.t)("working"),g[3]=(0,r.t)("inactive"),g[4]=(0,r.t)("placing"),g[5]=(0,r.t)("rejected"))}function v(t,e){b();const s=p[t];return e?s.toUpperCase():s}function P(t,e,s){b();const r=s?2:1;return e?h[r][t].toUpperCase():h[r][t]}function T(t,e,s,r,i){const o={added:[],modified:[],removed:[]},n=t.slice(0);return e.forEach(e=>{const u=t.findIndex(t=>t[s]===e[s]);if(-1===u)return void o.added.push(e);n[u]=null;const c=t[u];for(const t of r){let s=!0;if(null===c[t]||"object"!=typeof c[t]?s=c[t]===e[t]:i&&(s=(0,a.deepEquals)(c[t],e[t])[0]),!s)return void o.modified.push(e)}}),n.forEach(t=>{t&&o.removed.push(t)}),o}function S(t){return Math.abs(t||0)<.001?"0.00":(0,n.splitThousands)((t||0).toFixed(2))}function C(t){return-1!==Object.keys(o.OrderOrPositionMessageType).map(t=>o.OrderOrPositionMessageType[t]).indexOf(t)}function k(t,e,s,r){const o=(0,i.Big)(t).div(e);return 1===s&&1===r||2===s&&-1===r?o.round(0,0).mul(e).toNumber():1===s&&-1===r||2===s&&1===r?o.round(0,3).mul(e).toNumber():0}const w=(0,r.t)("Failed to login");class F{constructor(t){this._isFinished=!1,this._isTerminated=!1,this._tasks=t}execute(){return this._isTerminated=!1,this._isExecuted()&&!this._isFinished?this.terminate().then(()=>this._execution=this._execute()):this._execution=this._execute()}async terminate(){if(this._isExecuted()&&!this._isFinished){this._isTerminated=!0;try{await this._execution}catch(t){return void y.logWarn(t)}}}_isExecuted(){return!!this._execution}async _execute(){for(const t of this._tasks){if(this._isTerminated)throw new Error("Login tasks are terminated");try{await t()}catch(t){this._isFinished=!0;const e={detailedErrorMessage:`${w}${A(I(t))}`,userFriendlyMessage:`${w}${A(B(t))}`};throw t instanceof d.DisconnectError?new d.DisconnectError({...e,disconnectInfo:t.disconnectInfo}):new l.UserFriendlyError(e)}}this._isFinished=!0}}function A(t){return void 0===t||""===t?"":": "+t}function O(t){return(new i.Big(t).toFixed().split(".")[1]||"").length}function D(t){return(0,i.Big)(10).pow(Math.floor(Math.log10(t))).toNumber()}function x(t){return-1!==[2,1,5].indexOf(t)}function E(t){return b(),_[t]}function q(t,e){return(0,r.t)("You can't trade the symbol {symbol} at TradingView via {broker}.").replace("{symbol}",t).replace("{broker}",e)}function B(t){if(void 0===t)return(0,r.t)("Unknown error");let e;return e=t instanceof Error?t.message:"object"==typeof t?JSON.stringify(t):t.toString(),(0,c.removeTags)(e)}function I(t){return t instanceof l.UserFriendlyError?(0,c.removeTags)(t.detailedErrorMessage):B(t)}},69731:(t,e,s)=>{s.r(e),s.d(e,{defaultConfigFlags:()=>r,applyDefaultsToConfigFlags:()=>i});const r={isSuspended:!1,supportDemoLiveSwitcher:!0,supportModifyOrderPrice:!0,supportEditAmount:!0,
supportModifyBrackets:!0,supportMarketBrackets:!0,supportMarketOrders:!0,supportStopOrders:!0,supportLimitOrders:!0,supportStopLimitOrders:!1,supportPositions:!0,supportDOM:!0,supportModifyTrailingStop:!0,supportAddBracketsToExistingOrder:!0,supportVerifyLiveAccount:!0,supportReversePosition:!0,showNotificationsLog:!0,supportPLUpdate:!0,supportTwoFactorAuthorization:!1,supportDisplayBrokerNameInSymbolSearch:!0,supportCurrencyInOrderPreview:!0,supportRiskControls:!0};function i(t){return Object.assign({},r,t)}}}]);